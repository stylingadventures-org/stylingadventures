"""Auth directive used in this API (mapped to Cognito user pools in AppSync)."""
directive @aws_auth(cognito_groups: [String]) on FIELD_DEFINITION | OBJECT

scalar AWSDateTime
scalar AWSEmail
scalar AWSURL
scalar AWSJSON

# -----------------------------------------------------------------------------
# Closet / Users
# -----------------------------------------------------------------------------

enum ClosetStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  PUBLISHED
}

# Who can see the item once it’s approved/published
enum ClosetAudience {
  PUBLIC
  BESTIE
  EXCLUSIVE
}

# Sort options for fan-facing feed
enum ClosetFeedSort {
  NEWEST
  MOST_LOVED
}

type ClosetItem {
  id: ID!
  userId: ID!
  ownerSub: String!
  status: ClosetStatus!
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!

  # Media
  mediaKey: String
  rawMediaKey: String

  # Basic metadata
  title: String!
  reason: String
  audience: ClosetAudience

  # Story-style metadata used for fan-facing "Lala's Closet" view
  storyTitle: String
  storySeason: String
  storyVibes: [String!]

  # Aggregate favorites (nullable for back-compat)
  favoriteCount: Int

  # Per-viewer flag (nullable so existing resolvers are safe)
  viewerHasFaved: Boolean
}

"""RBAC: roles & tiers (existing enum-backed user model)."""
enum Role {
  FAN
  BESTIE
  CREATOR
  COLLAB
  ADMIN
}

enum Tier {
  FREE
  PRIME
}

type User {
  id: ID!
  email: AWSEmail
  role: Role!
  tier: Tier
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

input SetUserRoleInput {
  userId: ID!
  email: AWSEmail
  role: Role!
  tier: Tier
}

type UserProfile {
  id: ID!
  email: String
  role: String!
  tier: String!
  createdAt: AWSDateTime
  updatedAt: AWSDateTime
}

type AdminUsersPage {
  items: [User!]!
  nextToken: String
}

# Paged admin view of closet items
type AdminClosetItemsPage {
  items: [ClosetItem!]!
  nextToken: String
}

# -----------------------------------------------------------------------------
# Bestie Tier
# -----------------------------------------------------------------------------

type BestieStatus {
  active: Boolean!
  since: AWSDateTime
  until: AWSDateTime
  source: String
}

type EarlyAccessGate {
  allowed: Boolean!
  reason: String
}

# -----------------------------------------------------------------------------
# Fans/Game — Types & Inputs
# -----------------------------------------------------------------------------

type GameProfile {
  userId: ID!
  displayName: String
  avatarUrl: AWSURL
  bio: String
  level: Int!
  xp: Int!
  coins: Int!
  badges: [String!]!
  lastEventAt: AWSDateTime
  streakCount: Int
  lastLoginAt: AWSDateTime
}

type LeaderboardEntry {
  userId: ID!
  displayName: String
  xp: Int
  coins: Int
  rank: Int
}

type Poll {
  pollId: ID!
  question: String!
  options: [String!]!
  totals: [Int!]!
  createdBy: String!
  createdAt: AWSDateTime!
}

input GameEventInput {
  type: String!
  metadata: AWSJSON
}

input AwardInput {
  userId: ID!
  coins: Int!
  xp: Int
  reason: String
}

input CreatePollInput {
  question: String!
  options: [String!]!
}

input UpdateProfileInput {
  displayName: String
  avatarUrl: AWSURL
  bio: String
}

input UpdateClosetItemStoryInput {
  id: ID!
  storyTitle: String
  storySeason: String
  storyVibes: [String!]
}

input AdminCreateClosetItemInput {
  title: String!

  """
  MUST be the exact S3 object key where the file was uploaded,
  including prefix (for example: "closet/<uuid>.jpg" or "users/<sub>/<uuid>.jpg").
  """
  rawMediaKey: String!

  season: String
  vibes: String
}

# -----------------------------------------------------------------------------
# Root: Queries
# -----------------------------------------------------------------------------

type Query {
  hello: String!

  """Signed-in creator's items."""
  myCloset: [ClosetItem!]!

  """Items awaiting moderation."""
  adminListPending: [ClosetItem!]!
    @aws_auth(cognito_groups: ["ADMIN", "COLLAB", "PRIME"])

  """
  Admin library of closet items, with optional status filter.
  If status is omitted, returns all items (scan-based for now).
  """
  adminListClosetItems(
    status: ClosetStatus
    limit: Int
    nextToken: String
  ): AdminClosetItemsPage
    @aws_auth(cognito_groups: ["ADMIN", "COLLAB", "PRIME"])

  """
  Lala's Closet — fan-facing feed.

  Resolver enforces: status = PUBLISHED (gsi2pk = "STATUS#PUBLISHED")
  and audience = PUBLIC.
  """
  closetFeed(sort: ClosetFeedSort = NEWEST): [ClosetItem!]!

  """Small snippet for dashboards (Bestie + fan home)."""
  topClosetLooks(limit: Int): [ClosetItem!]!

  me: UserProfile

  adminListUsers(search: String, limit: Int, nextToken: String): AdminUsersPage
    @aws_auth(cognito_groups: ["ADMIN"])

  meBestieStatus: BestieStatus!
  isEpisodeEarlyAccess(id: ID!): EarlyAccessGate!

  getMyProfile: GameProfile!
  topXP(limit: Int = 10, season: String = "GLOBAL"): [LeaderboardEntry!]!
  topCoins(limit: Int = 10, season: String = "GLOBAL"): [LeaderboardEntry!]!
  getPoll(pollId: ID!): Poll
}

# -----------------------------------------------------------------------------
# Root: Mutations
# -----------------------------------------------------------------------------

type Mutation {
  # Closet basics
  createClosetItem(title: String, mediaKey: String): ClosetItem!
  requestClosetApproval(id: ID!): String!
  updateClosetMediaKey(id: ID!, mediaKey: String!): ClosetItem!

  # Fan / favorite interaction
  toggleFavoriteClosetItem(id: ID!, on: Boolean): ClosetItem!

  # Admin create / moderation / audience
  adminCreateClosetItem(input: AdminCreateClosetItemInput!): ClosetItem!
    @aws_auth(cognito_groups: ["ADMIN", "COLLAB"])

  adminApproveItem(id: ID!): ClosetItem!
    @aws_auth(cognito_groups: ["ADMIN", "COLLAB"])

  adminRejectItem(id: ID!, reason: String): ClosetItem!
    @aws_auth(cognito_groups: ["ADMIN", "COLLAB"])

  adminSetClosetAudience(id: ID!, audience: ClosetAudience!): ClosetItem!
    @aws_auth(cognito_groups: ["ADMIN", "COLLAB"])

  # Bestie-side story metadata for closet items
  updateClosetItemStory(input: UpdateClosetItemStoryInput!): ClosetItem!

  # Roles / tiers
  setUserRole(input: SetUserRoleInput!): UserProfile!

  # Bestie billing / status
  startBestieCheckout(successUrl: AWSURL, cancelUrl: AWSURL): AWSURL!
  claimBestieTrial: BestieStatus!

  adminSetBestie(userSub: ID!, active: Boolean!): BestieStatus!
    @aws_auth(cognito_groups: ["ADMIN"])

  adminRevokeBestie(userSub: ID!): BestieStatus!
    @aws_auth(cognito_groups: ["ADMIN"])

  adminSetBestieByEmail(email: AWSEmail!, active: Boolean!): BestieStatus!
    @aws_auth(cognito_groups: ["ADMIN"])

  adminRevokeBestieByEmail(email: AWSEmail!): BestieStatus!
    @aws_auth(cognito_groups: ["ADMIN"])

  # Game / engagement
  logGameEvent(input: GameEventInput!): GameProfile!
  createPoll(input: CreatePollInput!): Poll
  votePoll(pollId: ID!, optionIndex: Int!): Poll

  awardCoins(input: AwardInput!): GameProfile!
    @aws_auth(cognito_groups: ["ADMIN"])

  grantBadge(userId: ID!, badge: String!): GameProfile!
    @aws_auth(cognito_groups: ["ADMIN"])

  setDisplayName(displayName: String!): GameProfile!
  updateProfile(input: UpdateProfileInput!): GameProfile!
}

schema {
  query: Query
  mutation: Mutation
}

