"""Auth directive used in this API (mapped to Cognito user pools in AppSync)."""
directive @aws_auth(cognito_groups: [String]) on FIELD_DEFINITION | OBJECT

# If your AppSync configuration doesn’t auto-provide these, keep these scalar lines.
scalar AWSDateTime
scalar AWSEmail
scalar AWSURL
scalar AWSJSON

# ─────────────────────────────────────────────────────────────────────────────
# Base: Closet / Users
# ─────────────────────────────────────────────────────────────────────────────
enum ClosetStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  PUBLISHED
}

# Who can see the item once it’s approved
enum ClosetAudience {
  PUBLIC
  BESTIE
  EXCLUSIVE
}

# Sort options for the public closet feed (matches frontend)
enum ClosetFeedSort {
  NEWEST
  MOST_LOVED
}

type ClosetItem {
  id: ID!
  userId: ID!
  ownerSub: String!
  status: ClosetStatus!
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!

  # Media
  mediaKey: String      # final, background-removed image key
  rawMediaKey: String   # original upload key (used for background-removal lookup)

  # Basic metadata
  title: String!
  reason: String
  audience: ClosetAudience

  # Story-style metadata used for fan-facing “Lala’s Closet” view
  storyTitle: String
  storySeason: String
  storyVibes: [String!]

  # New, nullable so Lambdas don’t have to populate it yet
  favoriteCount: Int
}

"""RBAC: roles & tiers (existing enum-backed user model)."""
enum Role { FAN BESTIE CREATOR COLLAB ADMIN }
enum Tier { FREE PRIME }

type User {
  id: ID!
  email: AWSEmail
  role: Role!
  tier: Tier
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

input SetUserRoleInput {
  userId: ID!
  email: AWSEmail
  role: Role!
  tier: Tier
}

"""Phase-1 lightweight profile returned by Query.me (string-based)."""
type UserProfile {
  id: ID!
  email: String
  role: String!
  tier: String!
  createdAt: AWSDateTime
  updatedAt: AWSDateTime
}

"""Paged list of users for admin UI."""
type AdminUsersPage {
  items: [User!]!
  nextToken: String
}

# ─────────────────────────────────────────────────────────────────────────────
# Bestie Tier
# ─────────────────────────────────────────────────────────────────────────────
type BestieStatus {
  active: Boolean!
  since: AWSDateTime
  until: AWSDateTime
  source: String
}

type EarlyAccessGate {
  allowed: Boolean!
  reason: String
}

# ─────────────────────────────────────────────────────────────────────────────
# Fans/Game — Types & Inputs
# ─────────────────────────────────────────────────────────────────────────────
type GameProfile {
  userId: ID!
  displayName: String
  avatarUrl: AWSURL
  bio: String
  level: Int!
  xp: Int!
  coins: Int!
  badges: [String!]!
  lastEventAt: AWSDateTime
  streakCount: Int
  lastLoginAt: AWSDateTime
}

type LeaderboardEntry {
  userId: ID!
  displayName: String
  xp: Int
  coins: Int
  rank: Int
}

type Poll {
  pollId: ID!
  question: String!
  options: [String!]!
  totals: [Int!]!
  createdBy: String!
  createdAt: AWSDateTime!
}

input GameEventInput {
  type: String!      # e.g., "LEVEL_CLEAR", "DAILY_LOGIN", "SHARE", "STYLE_IT"
  metadata: AWSJSON
}

input AwardInput {
  userId: ID!
  coins: Int!
  xp: Int
  reason: String
}

input CreatePollInput {
  question: String!
  options: [String!]!
}

# NEW: profile patch input
input UpdateProfileInput {
  displayName: String
  avatarUrl: AWSURL
  bio: String
}

# NEW: update story metadata for a closet item
input UpdateClosetItemStoryInput {
  id: ID!
  storyTitle: String
  storySeason: String
  storyVibes: [String!]
}

# NEW: admin create with rawMediaKey for background-removal pipeline
input AdminCreateClosetItemInput {
  title: String!
  rawMediaKey: String!   # from signedUpload(file)
  season: String
  vibes: String
}

# ─────────────────────────────────────────────────────────────────────────────
# Root: Queries
# ─────────────────────────────────────────────────────────────────────────────
type Query {
  hello: String!

  """Signed-in creator’s items."""
  myCloset: [ClosetItem!]!

  """Items awaiting moderation."""
  adminListPending: [ClosetItem!]!
    @aws_auth(cognito_groups: ["ADMIN", "COLLAB", "PRIME"])

  # Lala's Closet — public/community feed
  # Resolver enforces: status APPROVED/PUBLISHED + audience PUBLIC
  # NOTE: now returns a simple list instead of ClosetFeedPage
  closetFeed(sort: ClosetFeedSort = NEWEST): [ClosetItem!]!

  # Roles / user directory
  # Relaxed: nullable so we don’t blow up if resolver returns null
  me: UserProfile
  adminListUsers(search: String, limit: Int, nextToken: String): AdminUsersPage
    @aws_auth(cognito_groups: ["ADMIN"])

  # Bestie Tier
  meBestieStatus: BestieStatus!
  isEpisodeEarlyAccess(id: ID!): EarlyAccessGate!

  # Fans/Game
  getMyProfile: GameProfile!
  topXP(limit: Int = 10, season: String = "GLOBAL"): [LeaderboardEntry!]!
  topCoins(limit: Int = 10, season: String = "GLOBAL"): [LeaderboardEntry!]!
  getPoll(pollId: ID!): Poll
}

# ─────────────────────────────────────────────────────────────────────────────
# Root: Mutations
# ─────────────────────────────────────────────────────────────────────────────
type Mutation {
  """Creates a new item in DRAFT."""
  createClosetItem(title: String, mediaKey: String): ClosetItem!

  """Marks item PENDING and starts approval workflow."""
  requestClosetApproval(id: ID!): String!

  """Admin/creator fix-up: update the media key on an item."""
  updateClosetMediaKey(id: ID!, mediaKey: String!): ClosetItem!

  # NEW: admin create that wires raw upload into bg-removal pipeline
  adminCreateClosetItem(input: AdminCreateClosetItemInput!): ClosetItem!
    @aws_auth(cognito_groups: ["ADMIN", "COLLAB"])

  # Moderation actions
  adminApproveItem(id: ID!): ClosetItem!
    @aws_auth(cognito_groups: ["ADMIN", "COLLAB"])
  adminRejectItem(id: ID!, reason: String): ClosetItem!
    @aws_auth(cognito_groups: ["ADMIN", "COLLAB"])

  # Visibility for Lala’s Closet
  adminSetClosetAudience(id: ID!, audience: ClosetAudience!): ClosetItem!
    @aws_auth(cognito_groups: ["ADMIN", "COLLAB"])

  # Bestie-side story metadata for closet items
  updateClosetItemStory(input: UpdateClosetItemStoryInput!): ClosetItem!

  # Roles
  setUserRole(input: SetUserRoleInput!): UserProfile!

  # Bestie Tier
  startBestieCheckout(successUrl: AWSURL, cancelUrl: AWSURL): AWSURL!
  claimBestieTrial: BestieStatus!
  adminSetBestie(userSub: ID!, active: Boolean!): BestieStatus!
    @aws_auth(cognito_groups: ["ADMIN"])
  adminRevokeBestie(userSub: ID!): BestieStatus!
    @aws_auth(cognito_groups: ["ADMIN"])
  adminSetBestieByEmail(email: AWSEmail!, active: Boolean!): BestieStatus!
    @aws_auth(cognito_groups: ["ADMIN"])
  adminRevokeBestieByEmail(email: AWSEmail!): BestieStatus!
    @aws_auth(cognito_groups: ["ADMIN"])

  # Fans/Game
  logGameEvent(input: GameEventInput!): GameProfile!
  createPoll(input: CreatePollInput!): Poll
  votePoll(pollId: ID!, optionIndex: Int!): Poll

  # Admin-only game actions
  awardCoins(input: AwardInput!): GameProfile!
    @aws_auth(cognito_groups: ["ADMIN"])
  grantBadge(userId: ID!, badge: String!): GameProfile!
    @aws_auth(cognito_groups: ["ADMIN"])

  # Profile edit
  setDisplayName(displayName: String!): GameProfile!

  # NEW: profile patch
  updateProfile(input: UpdateProfileInput!): GameProfile!
}

schema {
  query: Query
  mutation: Mutation
}
