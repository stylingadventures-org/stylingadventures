"""Auth directive used in this API (mapped to Cognito user pools in AppSync)"""
directive @aws_auth(cognito_groups: [String]) on FIELD_DEFINITION | OBJECT

""" -------- App base enums & types -------- """
enum ClosetStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  PUBLISHED
}

type ClosetItem {
  id: ID!
  ownerSub: String!
  status: ClosetStatus!
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
  mediaKey: String
  title: String
  reason: String          # optional: why REJECTED
}

"""RBAC: roles & tiers (existing enum-backed user model)"""
enum Role { FAN BESTIE CREATOR COLLAB ADMIN }
enum Tier { FREE PRIME }

type User {
  id: ID!
  email: AWSEmail
  role: Role!
  tier: Tier
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

input SetUserRoleInput {
  userId: ID!
  email: AWSEmail
  role: Role!
  tier: Tier
}

"""Phase-1 lightweight profile returned by Query.me (string-based)"""
type UserProfile {
  id: ID!
  email: String
  role: String!
  tier: String!
  createdAt: AWSDateTime
  updatedAt: AWSDateTime
}

"""Paged list of users for admin UI"""
type AdminUsersPage {
  items: [User!]!
  nextToken: String
}

""" -------- Bestie Tier types -------- """
type BestieStatus {
  active: Boolean!
  since: AWSDateTime
  until: AWSDateTime
  source: String
}

type EarlyAccessGate {
  allowed: Boolean!
  reason: String
}

""" -------- Queries -------- """
type Query {
  hello: String!

  """
  Returns the signed-in creatorâ€™s items. Never null; empty list if none.
  Implemented by lambda/graphql/closet.ts -> myCloset
  """
  myCloset: [ClosetItem!]!

  """
  Items awaiting moderation. Requires elevated groups.
  Implemented by lambda/graphql/closet.ts -> adminListPending
  """
  adminListPending: [ClosetItem!]!
    @aws_auth(cognito_groups: ["ADMIN", "COLLAB", "PRIME"])

  # Roles / user directory
  # NOTE: now returns UserProfile (string role/tier) to match the NONE DS resolver.
  me: UserProfile!

  # Existing admin users listing remains enum-backed
  adminListUsers(search: String, limit: Int, nextToken: String): AdminUsersPage
    @aws_auth(cognito_groups: ["ADMIN"])

  # Bestie Tier
  meBestieStatus: BestieStatus!
  isEpisodeEarlyAccess(id: ID!): EarlyAccessGate!
}

""" -------- Mutations -------- """
type Mutation {
  """
  Creates a new item in DRAFT.
  Implemented by lambda/graphql/closet.ts -> createClosetItem
  """
  createClosetItem(title: String, mediaKey: String): ClosetItem! @aws_auth

  """
  Marks item PENDING and starts the approval Step Function.
  Returns a string (execution request marker).
  Implemented by lambda/graphql/closet.ts -> requestClosetApproval
  """
  requestClosetApproval(id: ID!): String!

  # Roles
  # Return shape is now UserProfile to align with front-end expectations.
  setUserRole(input: SetUserRoleInput!): UserProfile!

  # Moderation actions
  adminApproveItem(id: ID!): ClosetItem!
    @aws_auth(cognito_groups: ["ADMIN", "COLLAB"])
  adminRejectItem(id: ID!, reason: String): ClosetItem!
    @aws_auth(cognito_groups: ["ADMIN", "COLLAB"])

  """
  Admin/creator fix-up: update the media key on an item.
  Implemented by lambda/graphql/closet.ts -> updateClosetMediaKey
  """
  updateClosetMediaKey(id: ID!, mediaKey: String!): ClosetItem!

  """ -------- Bestie Tier -------- """
  claimBestieTrial: BestieStatus!

  """
  Admin toggles by Cognito sub (existing)
  """
  adminSetBestie(userSub: ID!, active: Boolean!): BestieStatus!
    @aws_auth(cognito_groups: ["ADMIN"])
  adminRevokeBestie(userSub: ID!): BestieStatus!
    @aws_auth(cognito_groups: ["ADMIN"])

  """
  Admin convenience: the same toggles by email (new)
  """
  adminSetBestieByEmail(email: AWSEmail!, active: Boolean!): BestieStatus!
    @aws_auth(cognito_groups: ["ADMIN"])
  adminRevokeBestieByEmail(email: AWSEmail!): BestieStatus!
    @aws_auth(cognito_groups: ["ADMIN"])
}

schema {
  query: Query
  mutation: Mutation
}
