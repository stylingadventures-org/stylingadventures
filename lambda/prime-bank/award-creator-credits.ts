import { APIGatewayProxyEventV2, APIGatewayProxyResultV2 } from \"aws-lambda\";\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\nimport { DynamoDBDocumentClient, GetCommand, UpdateCommand } from \"@aws-sdk/lib-dynamodb\";\n\nconst dynamoClient = new DynamoDBClient({});\nconst docClient = DynamoDBDocumentClient.from(dynamoClient);\n\ninterface CollaborativeEarningsRequest {\n  collabId: string;\n  totalAmount: number;\n}\n\nexport const handler = async (\n  event: APIGatewayProxyEventV2\n): Promise<APIGatewayProxyResultV2> => {\n  try {\n    console.log(\"[collaborative-earnings] Event:\", JSON.stringify(event));\n\n    const claims = event.requestContext.authorizer?.claims;\n    const userId = claims?.sub;\n\n    if (!userId) {\n      return {\n        statusCode: 401,\n        body: JSON.stringify({ ok: false, error: \"Not authenticated\" }),\n      };\n    }\n\n    const body = JSON.parse(event.body || \"{}\") as CollaborativeEarningsRequest;\n\n    if (!body.collabId || !body.totalAmount || body.totalAmount <= 0) {\n      return {\n        statusCode: 400,\n        body: JSON.stringify({\n          ok: false,\n          error: \"Missing collabId or invalid totalAmount\",\n        }),\n      };\n    }\n\n    const collab = await docClient.send(\n      new GetCommand({\n        TableName: \"COLLABORATIONS\",\n        Key: { collabId: body.collabId },\n      })\n    );\n\n    if (!collab.Item) {\n      return {\n        statusCode: 404,\n        body: JSON.stringify({ ok: false, error: \"Collaboration not found\" }),\n      };\n    }\n\n    const collaboration = collab.Item as any;\n    const split = collaboration.addendum?.earningsSplit || {\n      prime_pct: 50,\n      creator_pct: 50,\n    };\n\n    const primeShare = (body.totalAmount * split.prime_pct) / 100;\n    const creatorShare = (body.totalAmount * split.creator_pct) / 100;\n\n    const inviterId = collaboration.inviterId;\n    const inviteeId = collaboration.inviteeId;\n\n    const timestamp = Date.now();\n    const txnId = `txn_${timestamp}_${body.collabId}`;\n\n    await Promise.all([\n      docClient.send(\n        new UpdateCommand({\n          TableName: \"PRIME_ACCOUNTS\",\n          Key: { userId: inviterId },\n          UpdateExpression:\n            \"SET total_coins = if_not_exists(total_coins, :zero) + :amount, updated_at = :now\",\n          ExpressionAttributeValues: {\n            \":amount\": primeShare,\n            \":zero\": 0,\n            \":now\": timestamp,\n          },\n        })\n      ),\n      docClient.send(\n        new UpdateCommand({\n          TableName: \"PRIME_ACCOUNTS\",\n          Key: { userId: inviteeId },\n          UpdateExpression:\n            \"SET total_coins = if_not_exists(total_coins, :zero) + :amount, updated_at = :now\",\n          ExpressionAttributeValues: {\n            \":amount\": creatorShare,\n            \":zero\": 0,\n            \":now\": timestamp,\n          },\n        })\n      ),\n    ]);\n\n    return {\n      statusCode: 200,\n      body: JSON.stringify({\n        ok: true,\n        transactionId: txnId,\n        split: {\n          inviter: { userId: inviterId, amount: primeShare },\n          invitee: { userId: inviteeId, amount: creatorShare },\n        },\n      }),\n    };\n  } catch (error) {\n    console.error(\"[collaborative-earnings] Error:\", error);\n    return {\n      statusCode: 500,\n      body: JSON.stringify({\n        ok: false,\n        error: \"Failed to distribute collaborative earnings\",\n      }),\n    };\n  }\n};
