{
  "version": 3,
  "sources": ["../../lambda/creator/live.ts"],
  "sourcesContent": ["import {\r\n  DynamoDBClient,\r\n  PutItemCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport { marshall } from \"@aws-sdk/util-dynamodb\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\nconst LIVESTREAM_CHANNEL_ARN = process.env.LIVESTREAM_CHANNEL_ARN!;\r\nconst LIVESTREAM_PLAYBACK_URL = process.env.LIVESTREAM_PLAYBACK_URL!;\r\n\r\ntype UserTier = \"FREE\" | \"BESTIE\" | \"CREATOR\" | \"COLLAB\" | \"ADMIN\" | \"PRIME\";\r\n\r\nfunction getUserTier(identity: any): UserTier {\r\n  const claims = identity?.claims || {};\r\n\r\n  const tierClaim =\r\n    (claims[\"custom:tier\"] as string | undefined) ||\r\n    (claims[\"tier\"] as string | undefined);\r\n\r\n  const rawGroups = claims[\"cognito:groups\"];\r\n  const groups = Array.isArray(rawGroups)\r\n    ? rawGroups\r\n    : String(rawGroups || \"\")\r\n        .split(\",\")\r\n        .map((g) => g.trim())\r\n        .filter(Boolean);\r\n\r\n  if (groups.includes(\"ADMIN\")) return \"ADMIN\";\r\n  if (groups.includes(\"COLLAB\")) return \"COLLAB\";\r\n  if (groups.includes(\"PRIME\")) return \"PRIME\";\r\n  if (groups.includes(\"CREATOR\")) return \"CREATOR\";\r\n  if (groups.includes(\"BESTIE\")) return \"BESTIE\";\r\n\r\n  if (\r\n    tierClaim &&\r\n    [\"FREE\", \"BESTIE\", \"CREATOR\", \"COLLAB\", \"ADMIN\", \"PRIME\"].includes(\r\n      tierClaim,\r\n    )\r\n  ) {\r\n    return tierClaim as UserTier;\r\n  }\r\n\r\n  return \"FREE\";\r\n}\r\n\r\nfunction requireCreator(identity: any): UserTier {\r\n  const tier = getUserTier(identity);\r\n  if (![\"CREATOR\", \"COLLAB\", \"ADMIN\", \"PRIME\"].includes(tier)) {\r\n    throw new Error(\"Creator tier required\");\r\n  }\r\n  return tier;\r\n}\r\n\r\nfunction requireSub(identity: any): string {\r\n  if (!identity?.sub) throw new Error(\"Not authenticated\");\r\n  return String(identity.sub);\r\n}\r\n\r\nexport const handler = async (event: any) => {\r\n  console.log(\"CreatorLivestreamFn event\", JSON.stringify(event));\r\n  const fieldName = event.info?.fieldName as string | undefined;\r\n  const identity = event.identity;\r\n\r\n  // Enforce Creator tier for all operations\r\n  requireCreator(identity);\r\n  const sub = requireSub(identity);\r\n\r\n  switch (fieldName) {\r\n    case \"getCreatorLivestreamInfo\": {\r\n      return {\r\n        channelArn: LIVESTREAM_CHANNEL_ARN,\r\n        playbackUrl: LIVESTREAM_PLAYBACK_URL,\r\n      };\r\n    }\r\n\r\n    case \"pinLivestreamHighlight\": {\r\n      const { highlightId, title } = event.arguments || {};\r\n      const now = new Date().toISOString();\r\n\r\n      await ddb.send(\r\n        new PutItemCommand({\r\n          TableName: TABLE_NAME,\r\n          Item: marshall(\r\n            {\r\n              pk: `USER#${sub}`,\r\n              sk: `LIVE_HIGHLIGHT#${highlightId || now}`,\r\n              type: \"LIVE_HIGHLIGHT\",\r\n              title: title || \"Livestream highlight\",\r\n              createdAt: now,\r\n            },\r\n            { removeUndefinedValues: true },\r\n          ),\r\n        }),\r\n      );\r\n\r\n      return { ok: true };\r\n    }\r\n\r\n    default:\r\n      throw new Error(`Unsupported field in CreatorLivestreamFn: ${fieldName}`);\r\n  }\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAAA,IAAAI,EAGO,oCACPC,EAAyB,kCAEnBC,EAAM,IAAI,iBAAe,CAAC,CAAC,EAC3BC,EAAa,QAAQ,IAAI,WACzBC,EAAyB,QAAQ,IAAI,uBACrCC,EAA0B,QAAQ,IAAI,wBAI5C,SAASC,EAAYC,EAAyB,CAC5C,IAAMC,EAASD,GAAU,QAAU,CAAC,EAE9BE,EACHD,EAAO,aAAa,GACpBA,EAAO,KAEJE,EAAYF,EAAO,gBAAgB,EACnCG,EAAS,MAAM,QAAQD,CAAS,EAClCA,EACA,OAAOA,GAAa,EAAE,EACnB,MAAM,GAAG,EACT,IAAKE,GAAMA,EAAE,KAAK,CAAC,EACnB,OAAO,OAAO,EAErB,OAAID,EAAO,SAAS,OAAO,EAAU,QACjCA,EAAO,SAAS,QAAQ,EAAU,SAClCA,EAAO,SAAS,OAAO,EAAU,QACjCA,EAAO,SAAS,SAAS,EAAU,UACnCA,EAAO,SAAS,QAAQ,EAAU,SAGpCF,GACA,CAAC,OAAQ,SAAU,UAAW,SAAU,QAAS,OAAO,EAAE,SACxDA,CACF,EAEOA,EAGF,MACT,CAEA,SAASI,EAAeN,EAAyB,CAC/C,IAAMO,EAAOR,EAAYC,CAAQ,EACjC,GAAI,CAAC,CAAC,UAAW,SAAU,QAAS,OAAO,EAAE,SAASO,CAAI,EACxD,MAAM,IAAI,MAAM,uBAAuB,EAEzC,OAAOA,CACT,CAEA,SAASC,EAAWR,EAAuB,CACzC,GAAI,CAACA,GAAU,IAAK,MAAM,IAAI,MAAM,mBAAmB,EACvD,OAAO,OAAOA,EAAS,GAAG,CAC5B,CAEO,IAAMT,EAAU,MAAOkB,GAAe,CAC3C,QAAQ,IAAI,4BAA6B,KAAK,UAAUA,CAAK,CAAC,EAC9D,IAAMC,EAAYD,EAAM,MAAM,UACxBT,EAAWS,EAAM,SAGvBH,EAAeN,CAAQ,EACvB,IAAMW,EAAMH,EAAWR,CAAQ,EAE/B,OAAQU,EAAW,CACjB,IAAK,2BACH,MAAO,CACL,WAAYb,EACZ,YAAaC,CACf,EAGF,IAAK,yBAA0B,CAC7B,GAAM,CAAE,YAAAc,EAAa,MAAAC,CAAM,EAAIJ,EAAM,WAAa,CAAC,EAC7CK,EAAM,IAAI,KAAK,EAAE,YAAY,EAEnC,aAAMnB,EAAI,KACR,IAAI,iBAAe,CACjB,UAAWC,EACX,QAAM,YACJ,CACE,GAAI,QAAQe,CAAG,GACf,GAAI,kBAAkBC,GAAeE,CAAG,GACxC,KAAM,iBACN,MAAOD,GAAS,uBAChB,UAAWC,CACb,EACA,CAAE,sBAAuB,EAAK,CAChC,CACF,CAAC,CACH,EAEO,CAAE,GAAI,EAAK,CACpB,CAEA,QACE,MAAM,IAAI,MAAM,6CAA6CJ,CAAS,EAAE,CAC5E,CACF",
  "names": ["live_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_util_dynamodb", "ddb", "TABLE_NAME", "LIVESTREAM_CHANNEL_ARN", "LIVESTREAM_PLAYBACK_URL", "getUserTier", "identity", "claims", "tierClaim", "rawGroups", "groups", "g", "requireCreator", "tier", "requireSub", "event", "fieldName", "sub", "highlightId", "title", "now"]
}
