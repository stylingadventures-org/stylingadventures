{
  "version": 3,
  "sources": ["../../lambda/prime-bank/enforce-earning-caps.ts"],
  "sourcesContent": ["// lambda/prime-bank/enforce-earning-caps.ts\r\nimport {\r\n  DynamoDBClient,\r\n  UpdateItemCommand,\r\n  GetItemCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport { Handler } from \"aws-lambda\";\r\n\r\nconst ACCOUNT_TABLE_NAME = process.env.PRIME_BANK_ACCOUNT_TABLE_NAME!;\r\nconst ddb = new DynamoDBClient({});\r\n\r\ninterface EnforceEarningCapsEvent {\r\n  userId: string;\r\n  amountToAward: number; // requested amount\r\n  role: \"Fan\" | \"Bestie\" | \"Creator\" | \"Admin\" | string;\r\n}\r\n\r\nexport const handler: Handler<EnforceEarningCapsEvent, any> = async (event) => {\r\n  console.log(\"EnforceEarningCaps event:\", JSON.stringify(event));\r\n\r\n  const { userId, amountToAward, role } = event;\r\n\r\n  // 1) Fetch current account\r\n  const resp = await ddb.send(\r\n    new GetItemCommand({\r\n      TableName: ACCOUNT_TABLE_NAME,\r\n      Key: { userId: { S: userId } },\r\n    })\r\n  );\r\n\r\n  // TODO: pull these from config, not hard-coded.\r\n  const dailyCap = role === \"Bestie\" ? 100 : 50;\r\n  const weeklyCap = role === \"Bestie\" ? 500 : 250;\r\n\r\n  // Very naive logic for now:\r\n  // - Just check if requested amount is under the caps.\r\n  // - In the future you'll read dailyCoinTotal / weeklyCoinTotal and reset them based on lastDailyReset / lastWeeklyReset.\r\n  const allowed = amountToAward <= dailyCap && amountToAward <= weeklyCap;\r\n\r\n  if (!allowed) {\r\n    return {\r\n      ok: false,\r\n      reason: \"CAP_EXCEEDED\",\r\n      suggestedMaxAward: Math.min(dailyCap, weeklyCap),\r\n    };\r\n  }\r\n\r\n  // 2) (Placeholder) update daily/weekly totals\r\n  await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: ACCOUNT_TABLE_NAME,\r\n      Key: { userId: { S: userId } },\r\n      UpdateExpression:\r\n        \"ADD dailyCoinTotal :delta, weeklyCoinTotal :delta SET lastDailyReset = :today, lastWeeklyReset = :today\",\r\n      ExpressionAttributeValues: {\r\n        \":delta\": { N: String(amountToAward) },\r\n        \":today\": { S: new Date().toISOString().slice(0, 10) },\r\n      },\r\n    })\r\n  );\r\n\r\n  return {\r\n    ok: true,\r\n    userId,\r\n    amountToAward,\r\n  };\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GACA,IAAAI,EAIO,oCAGDC,EAAqB,QAAQ,IAAI,8BACjCC,EAAM,IAAI,iBAAe,CAAC,CAAC,EAQpBJ,EAAiD,MAAOK,GAAU,CAC7E,QAAQ,IAAI,4BAA6B,KAAK,UAAUA,CAAK,CAAC,EAE9D,GAAM,CAAE,OAAAC,EAAQ,cAAAC,EAAe,KAAAC,CAAK,EAAIH,EAGlCI,EAAO,MAAML,EAAI,KACrB,IAAI,iBAAe,CACjB,UAAWD,EACX,IAAK,CAAE,OAAQ,CAAE,EAAGG,CAAO,CAAE,CAC/B,CAAC,CACH,EAGMI,EAAWF,IAAS,SAAW,IAAM,GACrCG,EAAYH,IAAS,SAAW,IAAM,IAO5C,OAFgBD,GAAiBG,GAAYH,GAAiBI,GAW9D,MAAMP,EAAI,KACR,IAAI,oBAAkB,CACpB,UAAWD,EACX,IAAK,CAAE,OAAQ,CAAE,EAAGG,CAAO,CAAE,EAC7B,iBACE,0GACF,0BAA2B,CACzB,SAAU,CAAE,EAAG,OAAOC,CAAa,CAAE,EACrC,SAAU,CAAE,EAAG,IAAI,KAAK,EAAE,YAAY,EAAE,MAAM,EAAG,EAAE,CAAE,CACvD,CACF,CAAC,CACH,EAEO,CACL,GAAI,GACJ,OAAAD,EACA,cAAAC,CACF,GAzBS,CACL,GAAI,GACJ,OAAQ,eACR,kBAAmB,KAAK,IAAIG,EAAUC,CAAS,CACjD,CAsBJ",
  "names": ["enforce_earning_caps_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "ACCOUNT_TABLE_NAME", "ddb", "event", "userId", "amountToAward", "role", "resp", "dailyCap", "weeklyCap"]
}
