{
  "version": 3,
  "sources": ["../../lambda/closet/apply-background-change.ts"],
  "sourcesContent": ["// lambda/closet/apply-background-change.ts\r\nimport { DynamoDBClient, UpdateItemCommand } from \"@aws-sdk/client-dynamodb\";\r\nimport { marshall } from \"@aws-sdk/util-dynamodb\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\n\r\n// These env vars come from the Step Function / stack.\r\nconst TABLE_NAME = process.env.TABLE_NAME || \"\";\r\nconst PK_NAME = process.env.PK_NAME || \"pk\";\r\nconst SK_NAME = process.env.SK_NAME || \"sk\";\r\n\r\n/**\r\n * Apply the result of background processing to the ClosetItem row.\r\n *\r\n * Expected event shape (flexible \u2013 we try multiple property names):\r\n * {\r\n *   itemId: \"closet item id\",\r\n *   ownerId: \"user sub\",\r\n *   mediaKey: \"closet/xxx-cutout.png\"        // preferred\r\n *   // or:\r\n *   processedKey: \"closet/xxx-cutout.png\"\r\n *   newBackgroundKey: \"closet/xxx-cutout.png\"\r\n *   backgroundStatus: \"COMPLETED\" | \"FAILED\" // optional\r\n * }\r\n */\r\nexport const handler = async (event: any) => {\r\n  console.log(\"ApplyBackgroundChange event:\", JSON.stringify(event));\r\n\r\n  const itemId =\r\n    event?.itemId ||\r\n    event?.closetItemId ||\r\n    event?.detail?.itemId ||\r\n    event?.detail?.closetItemId ||\r\n    event?.id;\r\n\r\n  const ownerId =\r\n    event?.ownerId ||\r\n    event?.userId ||\r\n    event?.sub ||\r\n    event?.detail?.ownerId ||\r\n    event?.detail?.userId;\r\n\r\n  const mediaKey =\r\n    event?.mediaKey ||\r\n    event?.detail?.mediaKey ||\r\n    event?.processedKey ||\r\n    event?.detail?.processedKey ||\r\n    event?.backgroundKey ||\r\n    event?.detail?.backgroundKey ||\r\n    event?.newBackgroundKey ||\r\n    event?.detail?.newBackgroundKey;\r\n\r\n  // optional explicit status from the workflow\r\n  const incomingStatus =\r\n    event?.backgroundStatus || event?.detail?.backgroundStatus || null;\r\n\r\n  if (!TABLE_NAME) {\r\n    console.warn(\"TABLE_NAME not set; skipping DynamoDB update\");\r\n    return {\r\n      ...event,\r\n      applied: true,\r\n      skippedDdb: true,\r\n    };\r\n  }\r\n\r\n  if (!itemId || !ownerId) {\r\n    console.warn(\"Missing itemId/ownerId; returning passthrough\");\r\n    return {\r\n      ...event,\r\n      applied: false,\r\n      reason: \"Missing itemId/ownerId\",\r\n    };\r\n  }\r\n\r\n  try {\r\n    const updateExprParts = [\"#updatedAt = :now\"];\r\n    const names: Record<string, string> = { \"#updatedAt\": \"updatedAt\" };\r\n    const values: Record<string, any> = {\r\n      \":now\": new Date().toISOString(),\r\n    };\r\n\r\n    if (mediaKey) {\r\n      // This is the field your GraphQL API exposes and that the\r\n      // front-end reads.\r\n      updateExprParts.push(\"#mediaKey = :mk\");\r\n      names[\"#mediaKey\"] = \"mediaKey\";\r\n      values[\":mk\"] = mediaKey;\r\n\r\n      // If you previously had a \"pendingBackgroundKey\", clear it.\r\n      updateExprParts.push(\"#pendingBackgroundKey = :null\");\r\n      names[\"#pendingBackgroundKey\"] = \"pendingBackgroundKey\";\r\n      values[\":null\"] = null;\r\n    }\r\n\r\n    // Track background processing status on the item\r\n    const finalStatus = incomingStatus || (mediaKey ? \"COMPLETED\" : null);\r\n    if (finalStatus) {\r\n      updateExprParts.push(\"#backgroundStatus = :bs\");\r\n      names[\"#backgroundStatus\"] = \"backgroundStatus\";\r\n      values[\":bs\"] = finalStatus;\r\n    }\r\n\r\n    const cmd = new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: marshall({\r\n        [PK_NAME]: `USER#${ownerId}`,\r\n        [SK_NAME]: `CLOSET#${itemId}`,\r\n      }),\r\n      UpdateExpression: \"SET \" + updateExprParts.join(\", \"),\r\n      ExpressionAttributeNames: names,\r\n      ExpressionAttributeValues: marshall(values, {\r\n        removeUndefinedValues: true,\r\n      }),\r\n    });\r\n\r\n    console.log(\r\n      \"ApplyBackgroundChange: UpdateItem\",\r\n      JSON.stringify({\r\n        TableName: cmd.input.TableName,\r\n        Key: cmd.input.Key,\r\n        UpdateExpression: cmd.input.UpdateExpression,\r\n        ExpressionAttributeNames: cmd.input.ExpressionAttributeNames,\r\n      })\r\n    );\r\n\r\n    await ddb.send(cmd);\r\n  } catch (err) {\r\n    console.error(\"ApplyBackgroundChange: DDB update failed\", err);\r\n    return {\r\n      ...event,\r\n      applied: false,\r\n      error: String((err as Error)?.message || err),\r\n    };\r\n  }\r\n\r\n  return {\r\n    ...event,\r\n    applied: true,\r\n  };\r\n};\r\n\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GACA,IAAAI,EAAkD,oCAClDC,EAAyB,kCAEnBC,EAAM,IAAI,iBAAe,CAAC,CAAC,EAG3BC,EAAa,QAAQ,IAAI,YAAc,GACvCC,EAAU,QAAQ,IAAI,SAAW,KACjCC,EAAU,QAAQ,IAAI,SAAW,KAgB1BP,EAAU,MAAOQ,GAAe,CAC3C,QAAQ,IAAI,+BAAgC,KAAK,UAAUA,CAAK,CAAC,EAEjE,IAAMC,EACJD,GAAO,QACPA,GAAO,cACPA,GAAO,QAAQ,QACfA,GAAO,QAAQ,cACfA,GAAO,GAEHE,EACJF,GAAO,SACPA,GAAO,QACPA,GAAO,KACPA,GAAO,QAAQ,SACfA,GAAO,QAAQ,OAEXG,EACJH,GAAO,UACPA,GAAO,QAAQ,UACfA,GAAO,cACPA,GAAO,QAAQ,cACfA,GAAO,eACPA,GAAO,QAAQ,eACfA,GAAO,kBACPA,GAAO,QAAQ,iBAGXI,EACJJ,GAAO,kBAAoBA,GAAO,QAAQ,kBAAoB,KAEhE,GAAI,CAACH,EACH,eAAQ,KAAK,8CAA8C,EACpD,CACL,GAAGG,EACH,QAAS,GACT,WAAY,EACd,EAGF,GAAI,CAACC,GAAU,CAACC,EACd,eAAQ,KAAK,+CAA+C,EACrD,CACL,GAAGF,EACH,QAAS,GACT,OAAQ,wBACV,EAGF,GAAI,CACF,IAAMK,EAAkB,CAAC,mBAAmB,EACtCC,EAAgC,CAAE,aAAc,WAAY,EAC5DC,EAA8B,CAClC,OAAQ,IAAI,KAAK,EAAE,YAAY,CACjC,EAEIJ,IAGFE,EAAgB,KAAK,iBAAiB,EACtCC,EAAM,WAAW,EAAI,WACrBC,EAAO,KAAK,EAAIJ,EAGhBE,EAAgB,KAAK,+BAA+B,EACpDC,EAAM,uBAAuB,EAAI,uBACjCC,EAAO,OAAO,EAAI,MAIpB,IAAMC,EAAcJ,IAAmBD,EAAW,YAAc,MAC5DK,IACFH,EAAgB,KAAK,yBAAyB,EAC9CC,EAAM,mBAAmB,EAAI,mBAC7BC,EAAO,KAAK,EAAIC,GAGlB,IAAMC,EAAM,IAAI,oBAAkB,CAChC,UAAWZ,EACX,OAAK,YAAS,CACZ,CAACC,CAAO,EAAG,QAAQI,CAAO,GAC1B,CAACH,CAAO,EAAG,UAAUE,CAAM,EAC7B,CAAC,EACD,iBAAkB,OAASI,EAAgB,KAAK,IAAI,EACpD,yBAA0BC,EAC1B,6BAA2B,YAASC,EAAQ,CAC1C,sBAAuB,EACzB,CAAC,CACH,CAAC,EAED,QAAQ,IACN,oCACA,KAAK,UAAU,CACb,UAAWE,EAAI,MAAM,UACrB,IAAKA,EAAI,MAAM,IACf,iBAAkBA,EAAI,MAAM,iBAC5B,yBAA0BA,EAAI,MAAM,wBACtC,CAAC,CACH,EAEA,MAAMb,EAAI,KAAKa,CAAG,CACpB,OAASC,EAAK,CACZ,eAAQ,MAAM,2CAA4CA,CAAG,EACtD,CACL,GAAGV,EACH,QAAS,GACT,MAAO,OAAQU,GAAe,SAAWA,CAAG,CAC9C,CACF,CAEA,MAAO,CACL,GAAGV,EACH,QAAS,EACX,CACF",
  "names": ["apply_background_change_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_util_dynamodb", "ddb", "TABLE_NAME", "PK_NAME", "SK_NAME", "event", "itemId", "ownerId", "mediaKey", "incomingStatus", "updateExprParts", "names", "values", "finalStatus", "cmd", "err"]
}
