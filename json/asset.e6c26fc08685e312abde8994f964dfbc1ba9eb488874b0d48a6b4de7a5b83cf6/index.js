"use strict";var h=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var P=(e,t)=>{for(var n in t)h(e,n,{get:t[n],enumerable:!0})},T=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of N(t))!E.call(e,i)&&i!==n&&h(e,i,{get:()=>t[i],enumerable:!(r=k(t,i))||r.enumerable});return e};var R=e=>T(h({},"__esModule",{value:!0}),e);var H={};P(H,{handler:()=>x});module.exports=R(H);var s=require("@aws-sdk/client-dynamodb"),u=require("@aws-sdk/util-dynamodb"),p=require("crypto"),c=new s.DynamoDBClient({}),d=process.env.TABLE_NAME;function y(e){if(!e?.sub)throw new Error("Not authenticated")}function b(e){let n=(e?.claims||{})["cognito:groups"],r=Array.isArray(n)?n:String(n||"").split(",").map(i=>i.trim()).filter(Boolean);return r.includes("ADMIN")||r.includes("PRIME")}function w(){return new Date().toISOString()}function f(e){return`USER#${e}`}function I(e){return"SHOPPING#CART"}function S(){return"SHOPPING#ITEM"}function A(e){return`ITEM#${e}`}var l=e=>(0,u.marshall)(e,{removeUndefinedValues:!0});async function L(e){return((await c.send(new s.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk",ExpressionAttributeValues:l({":pk":S()})}))).Items??[]).map(i=>(0,u.unmarshall)(i)).filter(i=>{let a=i.brand.toLowerCase().includes(e.brandName.toLowerCase()),o=i.name.toLowerCase().includes(e.itemName.toLowerCase()),m=!e.category||i.category===e.category;return a&&o&&m}).map(i=>({item:i,confidence:.85,matchType:"EXACT",source:"SHOPPING_DB"}))}async function M(e){return[]}async function U(e){return[]}async function C(e){y(e);let t=e.sub,n=await c.send(new s.GetItemCommand({TableName:d,Key:l({pk:f(t),sk:I(t)})}));return n.Item?(0,u.unmarshall)(n.Item):{id:(0,p.randomUUID)(),userId:t,items:[],total:0,affiliateCredit:0}}async function O(e,t){y(t);let n=t.sub,r=w(),i=await c.send(new s.GetItemCommand({TableName:d,Key:l({pk:S(),sk:A(e.itemId)})}));if(!i.Item)throw new Error("Item not found");let a=(0,u.unmarshall)(i.Item),o={id:(0,p.randomUUID)(),userId:n,items:[],total:0,affiliateCredit:0},m=await c.send(new s.GetItemCommand({TableName:d,Key:l({pk:f(n),sk:I(n)})}));if(m.Item&&(o=(0,u.unmarshall)(m.Item)),!o.items.find(g=>g.id===a.id)){o.items.push(a),o.total+=a.price;let g=a.affiliateLinks[0]?.commissionRate??.05;o.affiliateCredit+=a.price*g}return await c.send(new s.PutItemCommand({TableName:d,Item:l({pk:f(n),sk:I(n),entityType:"SHOPPING_CART",updatedAt:r,...o})})),o}async function D(e,t){y(t);let n=t.sub,r=w(),i=await C(t);if(!i)throw new Error("Cart not found");let a=i.items.find(m=>m.id===e.itemId);if(!a)throw new Error("Item not in cart");i.items=i.items.filter(m=>m.id!==e.itemId),i.total-=a.price;let o=a.affiliateLinks[0]?.commissionRate??.05;return i.affiliateCredit-=a.price*o,await c.send(new s.PutItemCommand({TableName:d,Item:l({pk:f(n),sk:I(n),entityType:"SHOPPING_CART",updatedAt:r,...i})})),i}async function F(e,t){if(!b(t))throw new Error("ADMIN required");let n=(0,p.randomUUID)(),r={id:n,brand:e.brand,name:e.name,category:e.category,sku:e.sku,imageUrl:e.imageUrl,price:e.price,affiliateLinks:[],likeCount:0};return await c.send(new s.PutItemCommand({TableName:d,Item:l({pk:S(),sk:A(n),entityType:"SHOPPABLE_ITEM",gsi1pk:`SHOPPING#CATEGORY#${e.category}`,gsi1sk:e.brand,...r})})),r}async function G(e,t){if(!b(t))throw new Error("ADMIN required");return{id:(0,p.randomUUID)(),retailer:e.retailer,url:e.url,commissionRate:e.commissionRate,isActive:!0}}var x=async e=>{console.log("ShoppingResolverFn event",JSON.stringify(e));let t=e.info?.fieldName;try{switch(t){case"findExactItem":return await L(e.arguments);case"sceneShoppableItems":return await M(e.arguments);case"videoShoppableItems":return await U(e.arguments);case"myShoppingCart":return await C(e.identity);case"addToCart":return await O(e.arguments,e.identity);case"removeFromCart":return await D(e.arguments,e.identity);case"adminCreateShoppableItem":return await F(e.arguments,e.identity);case"adminAddAffiliateLink":return await G(e.arguments,e.identity);default:throw new Error(`Unknown field: ${t}`)}}catch(n){throw console.error("ShoppingResolverFn error",n),n}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
