"use strict";var m=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var g=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var b=(t,e)=>{for(var s in e)m(t,s,{get:e[s],enumerable:!0})},h=(t,e,s,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of g(e))!A.call(t,n)&&n!==s&&m(t,n,{get:()=>e[n],enumerable:!(i=N(e,n))||i.enumerable});return t};var w=t=>h(m({},"__esModule",{value:!0}),t);var k={};b(k,{handler:()=>C});module.exports=w(k);var D=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb"),r=require("@aws-sdk/client-eventbridge"),p=a.DynamoDBDocumentClient.from(new D.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),K=new r.EventBridgeClient({}),l=process.env.TABLE_NAME,c=process.env.PK_NAME||"pk",E=process.env.SK_NAME||"sk";async function S(t,e){try{await K.send(new r.PutEventsCommand({Entries:[{Source:"stylingadventures.closet",DetailType:t,Detail:JSON.stringify(e)}]}))}catch(s){console.warn("[publish] EventBridge put failed:",s)}}function P(t){return t?.name==="ConditionalCheckFailedException"}var C=async t=>{console.log("[publish] incoming event:",JSON.stringify(t));let e=t?.approvalId||t?.item?.id||t?.itemId||t?.closetItemId||t?.admin?.approvalId;if(!e)return console.warn("[publish] missing approvalId; no-op publish"),{ok:!1,status:"NO_ID"};let s=`ITEM#${e}`,i="META",n=new Date().toISOString(),o=t?.segmentation?.outputKey||t?.processedImageKey||t?.item?.s3Key||null,u=(await p.send(new a.GetCommand({TableName:l,Key:{[c]:s,[E]:i},ConsistentRead:!0})))?.Item;if(!u)return console.warn("[publish] meta not found",{approvalId:e}),{ok:!1,status:"NOT_FOUND",approvalId:e};let d=u.status;if(d==="PUBLISHED")return{ok:!0,approvalId:e,status:"PUBLISHED",idempotent:!0,mediaKey:u.mediaKey??o};if(d!=="APPROVED")return{ok:!1,approvalId:e,status:"NOT_APPROVED",currentStatus:d};try{await p.send(new a.UpdateCommand({TableName:l,Key:{[c]:s,[E]:i},ConditionExpression:"#status = :approved",UpdateExpression:"SET #status = :published, updatedAt = :t, publishedAt = :t, mediaKey = :m",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":approved":"APPROVED",":published":"PUBLISHED",":t":n,":m":o}}))}catch(y){if(P(y)){let f=await p.send(new a.GetCommand({TableName:l,Key:{[c]:s,[E]:i},ConsistentRead:!0})),I=f?.Item?.status??"UNKNOWN";return I==="PUBLISHED"?{ok:!0,approvalId:e,status:"PUBLISHED",idempotent:!0,mediaKey:f?.Item?.mediaKey??o}:{ok:!1,approvalId:e,status:"RACE_LOST",currentStatus:I}}throw y}return await S("ClosetItemPublished",{approvalId:e,publishedAt:n,mediaKey:o}),{ok:!0,approvalId:e,status:"PUBLISHED",mediaKey:o}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
