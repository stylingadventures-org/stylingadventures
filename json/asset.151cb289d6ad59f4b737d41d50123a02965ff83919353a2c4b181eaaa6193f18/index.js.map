{
  "version": 3,
  "sources": ["../../lambda/prime/coins-ledger.ts"],
  "sourcesContent": ["// lambda/prime/coins-ledger.ts\r\n\r\n/**\r\n * Coins Ledger Lambda (Prime Studios)\r\n *\r\n * Purpose:\r\n *  - Track gig rewards, XP gains, and episode engagement payouts.\r\n *  - Designed to be called by internal workflows (Step Functions) or\r\n *    admin/studio tools \u2013 *not* directly by fans.\r\n *\r\n * Current behavior:\r\n *  - Validates the incoming event shape.\r\n *  - Emits a normalized ledger entry.\r\n *  - Does NOT persist anything yet (no DB writes).\r\n *\r\n * Future evolution:\r\n *  - Use TABLE_NAME / PK_NAME / SK_NAME env vars with DynamoDB single-table design.\r\n *  - Materialize running balances per user and/or per episode.\r\n */\r\n\r\nexport type CoinsEventType =\r\n  | \"GIG_REWARD\"\r\n  | \"EPISODE_ENGAGEMENT\"\r\n  | \"XP_ADJUSTMENT\";\r\n\r\nexport interface CoinsLedgerEvent {\r\n  userId: string;\r\n  episodeId?: string;\r\n\r\n  source: CoinsEventType;\r\n\r\n  // Deltas can be positive or negative.\r\n  coinsDelta?: number;\r\n  xpDelta?: number;\r\n\r\n  reason?: string;\r\n  metadata?: Record<string, unknown>;\r\n}\r\n\r\nexport interface CoinsLedgerEntry {\r\n  entryId: string;\r\n\r\n  userId: string;\r\n  episodeId?: string;\r\n\r\n  source: CoinsEventType;\r\n  coinsDelta: number;\r\n  xpDelta: number;\r\n\r\n  reason?: string;\r\n  metadata?: Record<string, unknown>;\r\n\r\n  createdAt: string;\r\n\r\n  // Mocked running totals for now \u2014 real implementation would\r\n  // look these up from DynamoDB and apply deltas.\r\n  newCoinsBalance?: number;\r\n  newXpTotal?: number;\r\n}\r\n\r\nfunction ensureNumber(val: unknown, fallback: number): number {\r\n  const n = typeof val === \"number\" ? val : Number(val);\r\n  return Number.isFinite(n) ? n : fallback;\r\n}\r\n\r\nexport const handler = async (\r\n  event: CoinsLedgerEvent,\r\n): Promise<CoinsLedgerEntry> => {\r\n  console.log(\"CoinsLedger incoming event:\", JSON.stringify(event, null, 2));\r\n\r\n  if (!event || !event.userId) {\r\n    throw new Error(\"Missing required field: userId\");\r\n  }\r\n\r\n  if (!event.source) {\r\n    throw new Error(\"Missing required field: source\");\r\n  }\r\n\r\n  const now = new Date().toISOString();\r\n  const entryId = `ledger-${Math.random().toString(36).slice(2, 10)}`;\r\n\r\n  const coinsDelta = ensureNumber(event.coinsDelta ?? 0, 0);\r\n  const xpDelta = ensureNumber(event.xpDelta ?? 0, 0);\r\n\r\n  const entry: CoinsLedgerEntry = {\r\n    entryId,\r\n    userId: event.userId,\r\n    episodeId: event.episodeId,\r\n    source: event.source,\r\n    coinsDelta,\r\n    xpDelta,\r\n    reason: event.reason,\r\n    metadata: event.metadata,\r\n    createdAt: now,\r\n\r\n    // These are intentionally mocked. Once you wire DynamoDB,\r\n    // you can:\r\n    //  - read the current balance\r\n    //  - apply deltas\r\n    //  - store & return the new balances.\r\n    newCoinsBalance: coinsDelta, // placeholder\r\n    newXpTotal: xpDelta, // placeholder\r\n  };\r\n\r\n  console.log(\"CoinsLedger normalized entry:\", JSON.stringify(entry, null, 2));\r\n\r\n  // \uD83D\uDD1C Future:\r\n  //   - If TABLE_NAME is set, persist entry in DynamoDB.\r\n  //   - You can key by pk = `USER#${userId}`, sk = `LEDGER#${timestamp}` etc.\r\n  //\r\n  // const tableName = process.env.TABLE_NAME;\r\n  // if (tableName) { ... }\r\n\r\n  return entry;\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GA4DA,SAASI,EAAaC,EAAcC,EAA0B,CAC5D,IAAMC,EAAI,OAAOF,GAAQ,SAAWA,EAAM,OAAOA,CAAG,EACpD,OAAO,OAAO,SAASE,CAAC,EAAIA,EAAID,CAClC,CAEO,IAAMJ,EAAU,MACrBM,GAC8B,CAG9B,GAFA,QAAQ,IAAI,8BAA+B,KAAK,UAAUA,EAAO,KAAM,CAAC,CAAC,EAErE,CAACA,GAAS,CAACA,EAAM,OACnB,MAAM,IAAI,MAAM,gCAAgC,EAGlD,GAAI,CAACA,EAAM,OACT,MAAM,IAAI,MAAM,gCAAgC,EAGlD,IAAMC,EAAM,IAAI,KAAK,EAAE,YAAY,EAC7BC,EAAU,UAAU,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,MAAM,EAAG,EAAE,CAAC,GAE3DC,EAAaP,EAAaI,EAAM,YAAc,EAAG,CAAC,EAClDI,EAAUR,EAAaI,EAAM,SAAW,EAAG,CAAC,EAE5CK,EAA0B,CAC9B,QAAAH,EACA,OAAQF,EAAM,OACd,UAAWA,EAAM,UACjB,OAAQA,EAAM,OACd,WAAAG,EACA,QAAAC,EACA,OAAQJ,EAAM,OACd,SAAUA,EAAM,SAChB,UAAWC,EAOX,gBAAiBE,EACjB,WAAYC,CACd,EAEA,eAAQ,IAAI,gCAAiC,KAAK,UAAUC,EAAO,KAAM,CAAC,CAAC,EASpEA,CACT",
  "names": ["coins_ledger_exports", "__export", "handler", "__toCommonJS", "ensureNumber", "val", "fallback", "n", "event", "now", "entryId", "coinsDelta", "xpDelta", "entry"]
}
