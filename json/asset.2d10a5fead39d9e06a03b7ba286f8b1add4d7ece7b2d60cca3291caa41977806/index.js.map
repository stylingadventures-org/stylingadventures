{
  "version": 3,
  "sources": ["../../lambda/closet/dlq-processor.ts"],
  "sourcesContent": ["import { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport { DynamoDBDocumentClient, PutCommand, UpdateCommand } from \"@aws-sdk/lib-dynamodb\";\r\nimport { EventBridgeClient, PutEventsCommand } from \"@aws-sdk/client-eventbridge\";\r\nimport { SNSClient, PublishCommand } from \"@aws-sdk/client-sns\";\r\n\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}), {\r\n  marshallOptions: { removeUndefinedValues: true },\r\n});\r\nconst eb = new EventBridgeClient({});\r\nconst sns = new SNSClient({});\r\n\r\nconst APP_TABLE = process.env.TABLE_NAME!;\r\nconst AUDIT_TABLE = process.env.AUDIT_TABLE_NAME!;\r\nconst PK_NAME = process.env.PK_NAME || \"pk\";\r\nconst SK_NAME = process.env.SK_NAME || \"sk\";\r\nconst NOTIFY_TOPIC_ARN = process.env.NOTIFY_TOPIC_ARN;\r\n\r\nfunction safeJsonParse(x: any) {\r\n  if (typeof x !== \"string\") return x;\r\n  try {\r\n    return JSON.parse(x);\r\n  } catch {\r\n    return x;\r\n  }\r\n}\r\n\r\nasync function emit(detailType: string, detail: any) {\r\n  try {\r\n    await eb.send(\r\n      new PutEventsCommand({\r\n        Entries: [\r\n          {\r\n            Source: \"stylingadventures.closet\",\r\n            DetailType: detailType,\r\n            Detail: JSON.stringify(detail),\r\n          },\r\n        ],\r\n      }),\r\n    );\r\n  } catch (e) {\r\n    console.warn(\"[dlq] EventBridge put failed:\", e);\r\n  }\r\n}\r\n\r\nasync function notify(subject: string, message: string, detail: any) {\r\n  if (!NOTIFY_TOPIC_ARN) return;\r\n  try {\r\n    await sns.send(\r\n      new PublishCommand({\r\n        TopicArn: NOTIFY_TOPIC_ARN,\r\n        Subject: subject,\r\n        Message: `${message}\\n\\n${JSON.stringify(detail, null, 2)}`,\r\n      }),\r\n    );\r\n  } catch (e) {\r\n    console.warn(\"[dlq] SNS publish failed:\", e);\r\n  }\r\n}\r\n\r\nasync function audit(action: string, approvalId: string, detail: any) {\r\n  const ts = new Date();\r\n  try {\r\n    await ddb.send(\r\n      new PutCommand({\r\n        TableName: AUDIT_TABLE,\r\n        Item: {\r\n          pk: `APPROVAL#${approvalId}`,\r\n          sk: `TS#${ts.toISOString()}`,\r\n          action,\r\n          approvalId,\r\n          at: ts.toISOString(),\r\n          detail,\r\n        },\r\n      }),\r\n    );\r\n  } catch (e) {\r\n    console.warn(\"[dlq] audit write failed:\", e);\r\n  }\r\n}\r\n\r\nfunction extractApprovalIdFromStepFnDetail(detail: any): string {\r\n  // StepFn execution status change events often store input as a STRING in detail.input\r\n  const inputObj = safeJsonParse(detail?.input);\r\n\r\n  const approvalId =\r\n    inputObj?.approvalId ||\r\n    inputObj?.item?.id ||\r\n    inputObj?.itemId ||\r\n    inputObj?.id ||\r\n    detail?.approvalId ||\r\n    detail?.item?.id;\r\n\r\n  return approvalId ? String(approvalId) : \"UNKNOWN\";\r\n}\r\n\r\nexport const handler = async (event: any) => {\r\n  const records = event.Records ?? [];\r\n  console.log(\"[dlq] records:\", records.length);\r\n\r\n  for (const r of records) {\r\n    const bodyRaw = r?.body;\r\n    const body = safeJsonParse(bodyRaw);\r\n\r\n    // If this was delivered via EventBridge -> SQS, the payload is the full event\r\n    const detail = body?.detail ?? body;\r\n    const status = detail?.status;\r\n    const executionArn = detail?.executionArn;\r\n\r\n    const approvalId = extractApprovalIdFromStepFnDetail(detail);\r\n\r\n    await audit(\"STEPFN_DLQ\", approvalId, { status, executionArn, detail });\r\n\r\n    await emit(\"ClosetApprovalDeadLetter\", {\r\n      approvalId,\r\n      status,\r\n      executionArn,\r\n    });\r\n\r\n    await notify(\r\n      \"Closet approval dead-letter\",\r\n      `Step Functions execution entered DLQ state: ${status ?? \"UNKNOWN\"}`,\r\n      { approvalId, status, executionArn },\r\n    );\r\n\r\n    // Best-effort: mark item as ERROR if we have an id\r\n    if (approvalId !== \"UNKNOWN\") {\r\n      try {\r\n        const pk = `ITEM#${approvalId}`;\r\n        const sk = \"META\";\r\n        await ddb.send(\r\n          new UpdateCommand({\r\n            TableName: APP_TABLE,\r\n            Key: { [PK_NAME]: pk, [SK_NAME]: sk },\r\n            UpdateExpression: \"SET lastError = :e, updatedAt = :t\",\r\n            ExpressionAttributeValues: {\r\n              \":e\": `StepFn execution ${status ?? \"UNKNOWN\"} (${executionArn ?? \"no-arn\"})`,\r\n              \":t\": new Date().toISOString(),\r\n            },\r\n          }),\r\n        );\r\n      } catch (e) {\r\n        console.warn(\"[dlq] failed to mark item error\", e);\r\n      }\r\n    } else {\r\n      console.warn(\"[dlq] could not determine approvalId\", {\r\n        status,\r\n        executionArn,\r\n      });\r\n    }\r\n  }\r\n\r\n  return { ok: true };\r\n};\r\n"],
  "mappings": "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",
  "names": ["dlq_processor_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "import_client_eventbridge", "import_client_sns", "ddb", "eb", "sns", "APP_TABLE", "AUDIT_TABLE", "PK_NAME", "SK_NAME", "NOTIFY_TOPIC_ARN", "safeJsonParse", "x", "emit", "detailType", "detail", "notify", "subject", "message", "e", "audit", "action", "approvalId", "ts", "extractApprovalIdFromStepFnDetail", "inputObj", "event", "records", "r", "bodyRaw", "body", "status", "executionArn", "pk", "sk"]
}
