name: Deploy

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment to deploy"
        required: true
        type: choice
        options: [ dev, stg, prd ]

permissions:
  contents: read
  id-token: write   # required for AWS OIDC
  actions: read

concurrency:
  group: deploy-${{ github.event.inputs.env }}
  cancel-in-progress: false

jobs:
  preflight:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Lint
        run: npm run lint --if-present

      - name: Test
        run: npm test

      - name: CDK Synth
        run: npm run cdk:synth --if-present

  deploy:
    needs: preflight
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # This is the approval gate:
    # - dev/stg can be non-protected environments
    # - prd should require reviewers
    environment: ${{ github.event.inputs.env }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      # Configure AWS via OIDC. Youâ€™ll set ROLE_ARN per environment as a secret.
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Build frontend
        run: npm -w site run build

      - name: CDK Deploy
        env:
          STAGE: ${{ github.event.inputs.env }}
        run: |
          npx cdk deploy --all --require-approval never --outputs-file cdk-outputs.json

      - name: Deploy frontend to S3 and invalidate CloudFront
        run: |
          # Extract bucket name and distribution ID from CDK outputs
          BUCKET=$(node -e "const outputs = require('./cdk-outputs.json'); const key = Object.keys(outputs).find(k => outputs[k].WebBucketName); console.log(outputs[key].WebBucketName)")
          DIST=$(node -e "const outputs = require('./cdk-outputs.json'); const key = Object.keys(outputs).find(k => outputs[k].CloudFrontDistributionId); console.log(outputs[key].CloudFrontDistributionId)")

          echo "Deploying to bucket: $BUCKET"
          echo "CloudFront distribution: $DIST"

          # Sync frontend to S3 with delete flag to remove old files
          aws s3 sync site/dist s3://$BUCKET \
            --delete \
            --cache-control "public, max-age=0, must-revalidate" \
            --region ${{ vars.AWS_REGION }}

          # Create CloudFront invalidation to purge all edges
          aws cloudfront create-invalidation \
            --distribution-id $DIST \
            --paths "/*" \
            --region ${{ vars.AWS_REGION }}
