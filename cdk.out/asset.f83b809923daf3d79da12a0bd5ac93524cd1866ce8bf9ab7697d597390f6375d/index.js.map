{
  "version": 3,
  "sources": ["../../lambda/roles/index.ts"],
  "sourcesContent": ["// lambda/roles/index.ts\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  GetCommand,\r\n  PutCommand,\r\n  ScanCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\nimport type {\r\n  AppSyncResolverEvent,\r\n  AppSyncIdentityCognito,\r\n} from \"aws-lambda\";\r\n\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}));\r\n\r\ntype Role = \"FAN\" | \"BESTIE\" | \"CREATOR\" | \"COLLAB\" | \"ADMIN\";\r\ntype Tier = \"FREE\" | \"PRIME\";\r\n\r\ninterface User {\r\n  id: string;\r\n  email?: string | null;\r\n  role: Role;\r\n  tier?: Tier | null;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n}\r\n\r\nconst nowIso = () => new Date().toISOString();\r\n\r\nexport const handler = async (event: AppSyncResolverEvent<any>) => {\r\n  const field = event.info.fieldName;\r\n\r\n  // Cognito identity from AppSync\r\n  const ident = event.identity as AppSyncIdentityCognito | undefined;\r\n  const sub = ident?.sub;\r\n  const email = (ident as any)?.claims?.email as string | undefined;\r\n  const groups = (ident as any)?.claims?.[\"cognito:groups\"];\r\n  const isAdmin = Array.isArray(groups)\r\n    ? groups.includes(\"ADMIN\")\r\n    : `${groups || \"\"}`.includes(\"ADMIN\");\r\n\r\n  /* ============================= me ============================= */\r\n  if (field === \"me\") {\r\n    if (!sub) throw new Error(\"Unauthenticated\");\r\n\r\n    // Try to fetch the user\r\n    const got = await ddb.send(\r\n      new GetCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: { id: sub },\r\n      })\r\n    );\r\n    if (got.Item) return got.Item as User;\r\n\r\n    // Create a default FAN user if not found (idempotent)\r\n    const now = nowIso();\r\n    const item: User = {\r\n      id: sub,\r\n      email: (email ?? null)?.toLowerCase?.() ?? null,\r\n      role: \"FAN\",\r\n      tier: \"FREE\",\r\n      createdAt: now,\r\n      updatedAt: now,\r\n    };\r\n\r\n    try {\r\n      await ddb.send(\r\n        new PutCommand({\r\n          TableName: TABLE_NAME,\r\n          Item: item,\r\n          ConditionExpression: \"attribute_not_exists(#id)\",\r\n          ExpressionAttributeNames: { \"#id\": \"id\" },\r\n        })\r\n      );\r\n    } catch {\r\n      // If it already exists (race), ignore\r\n      await ddb.send(\r\n        new GetCommand({\r\n          TableName: TABLE_NAME,\r\n          Key: { id: sub },\r\n        })\r\n      );\r\n    }\r\n\r\n    return item;\r\n  }\r\n\r\n  /* ========================= setUserRole ======================== */\r\n  if (field === \"setUserRole\") {\r\n    if (!sub) throw new Error(\"Unauthenticated\");\r\n\r\n    const input = event.arguments?.input as {\r\n      userId: string;\r\n      email?: string | null;\r\n      role: Role;\r\n      tier?: Tier | null;\r\n    };\r\n\r\n    if (!input?.userId || !input?.role) {\r\n      throw new Error(\"userId and role are required\");\r\n    }\r\n\r\n    const targetUserId = input.userId;\r\n\r\n    // Only ADMIN can modify others; anyone can modify self\r\n    if (!isAdmin && targetUserId !== sub) {\r\n      throw new Error(\"Not authorized to modify other users\");\r\n    }\r\n\r\n    const existing = await ddb.send(\r\n      new GetCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: { id: targetUserId },\r\n      })\r\n    );\r\n\r\n    const now = nowIso();\r\n    const item: User = existing.Item\r\n      ? {\r\n          ...(existing.Item as User),\r\n          email:\r\n            (input.email ??\r\n              (existing.Item as User).email ??\r\n              null)?.toLowerCase?.() ?? null,\r\n          role: input.role,\r\n          tier: (input.tier ?? (existing.Item as User).tier) ?? null,\r\n          updatedAt: now,\r\n        }\r\n      : {\r\n          id: targetUserId,\r\n          email: (input.email ?? null)?.toLowerCase?.() ?? null,\r\n          role: input.role,\r\n          tier: input.tier ?? \"FREE\",\r\n          createdAt: now,\r\n          updatedAt: now,\r\n        };\r\n\r\n    await ddb.send(new PutCommand({ TableName: TABLE_NAME, Item: item }));\r\n    return item;\r\n  }\r\n\r\n  /* ======================== adminListUsers ====================== */\r\n  // Simple admin listing with optional email substring search + pagination\r\n  if (field === \"adminListUsers\") {\r\n    if (!isAdmin) throw new Error(\"Not authorized\");\r\n\r\n    const args = (event.arguments || {}) as {\r\n      search?: string | null;\r\n      limit?: number | null;\r\n      nextToken?: string | null;\r\n    };\r\n\r\n    const limit = Math.min(Math.max(args.limit ?? 25, 1), 100);\r\n    const startKey = args.nextToken\r\n      ? JSON.parse(Buffer.from(args.nextToken, \"base64\").toString(\"utf8\"))\r\n      : undefined;\r\n\r\n    const params: any = {\r\n      TableName: TABLE_NAME,\r\n      Limit: limit,\r\n      ExclusiveStartKey: startKey,\r\n    };\r\n\r\n    const q = (args.search || \"\").trim().toLowerCase();\r\n    if (q) {\r\n      params.FilterExpression = \"contains(#email, :q)\";\r\n      params.ExpressionAttributeNames = { \"#email\": \"email\" };\r\n      params.ExpressionAttributeValues = { \":q\": q };\r\n    }\r\n\r\n    const out = await ddb.send(new ScanCommand(params));\r\n\r\n    const items = (out.Items || []).map((u: any) => ({\r\n      id: u.id,\r\n      email: u.email ?? null,\r\n      role: u.role,\r\n      tier: u.tier ?? null,\r\n      createdAt: u.createdAt,\r\n      updatedAt: u.updatedAt,\r\n    }));\r\n\r\n    return {\r\n      items,\r\n      nextToken: out.LastEvaluatedKey\r\n        ? Buffer.from(JSON.stringify(out.LastEvaluatedKey)).toString(\"base64\")\r\n        : null,\r\n    };\r\n  }\r\n\r\n  /* =========================== default ========================== */\r\n  throw new Error(`Unhandled field: ${field}`);\r\n};\r\n"],
  "mappings": "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",
  "names": ["roles_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "TABLE_NAME", "ddb", "nowIso", "event", "field", "ident", "sub", "email", "groups", "isAdmin", "got", "now", "item", "input", "targetUserId", "existing", "args", "limit", "startKey", "params", "q", "out", "u"]
}
