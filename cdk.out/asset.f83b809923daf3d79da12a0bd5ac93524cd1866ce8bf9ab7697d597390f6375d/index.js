"use strict";var f=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var h=Object.prototype.hasOwnProperty;var b=(n,t)=>{for(var s in t)f(n,s,{get:t[s],enumerable:!0})},T=(n,t,s,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let d of N(t))!h.call(n,d)&&d!==s&&f(n,d,{get:()=>t[d],enumerable:!(i=I(t,d))||i.enumerable});return n};var x=n=>T(f({},"__esModule",{value:!0}),n);var S={};b(S,{handler:()=>C});module.exports=x(S);var g=require("@aws-sdk/client-dynamodb"),r=require("@aws-sdk/lib-dynamodb"),u=process.env.TABLE_NAME,c=r.DynamoDBDocumentClient.from(new g.DynamoDBClient({})),E=()=>new Date().toISOString(),C=async n=>{let t=n.info.fieldName,s=n.identity,i=s?.sub,d=s?.claims?.email,w=s?.claims?.["cognito:groups"],y=Array.isArray(w)?w.includes("ADMIN"):`${w||""}`.includes("ADMIN");if(t==="me"){if(!i)throw new Error("Unauthenticated");let e=await c.send(new r.GetCommand({TableName:u,Key:{id:i}}));if(e.Item)return e.Item;let o=E(),a={id:i,email:(d??null)?.toLowerCase?.()??null,role:"FAN",tier:"FREE",createdAt:o,updatedAt:o};try{await c.send(new r.PutCommand({TableName:u,Item:a,ConditionExpression:"attribute_not_exists(#id)",ExpressionAttributeNames:{"#id":"id"}}))}catch{await c.send(new r.GetCommand({TableName:u,Key:{id:i}}))}return a}if(t==="setUserRole"){if(!i)throw new Error("Unauthenticated");let e=n.arguments?.input;if(!e?.userId||!e?.role)throw new Error("userId and role are required");let o=e.userId;if(!y&&o!==i)throw new Error("Not authorized to modify other users");let a=await c.send(new r.GetCommand({TableName:u,Key:{id:o}})),l=E(),p=a.Item?{...a.Item,email:(e.email??a.Item.email??null)?.toLowerCase?.()??null,role:e.role,tier:e.tier??a.Item.tier??null,updatedAt:l}:{id:o,email:(e.email??null)?.toLowerCase?.()??null,role:e.role,tier:e.tier??"FREE",createdAt:l,updatedAt:l};return await c.send(new r.PutCommand({TableName:u,Item:p})),p}if(t==="adminListUsers"){if(!y)throw new Error("Not authorized");let e=n.arguments||{},o=Math.min(Math.max(e.limit??25,1),100),a=e.nextToken?JSON.parse(Buffer.from(e.nextToken,"base64").toString("utf8")):void 0,l={TableName:u,Limit:o,ExclusiveStartKey:a},p=(e.search||"").trim().toLowerCase();p&&(l.FilterExpression="contains(#email, :q)",l.ExpressionAttributeNames={"#email":"email"},l.ExpressionAttributeValues={":q":p});let A=await c.send(new r.ScanCommand(l));return{items:(A.Items||[]).map(m=>({id:m.id,email:m.email??null,role:m.role,tier:m.tier??null,createdAt:m.createdAt,updatedAt:m.updatedAt})),nextToken:A.LastEvaluatedKey?Buffer.from(JSON.stringify(A.LastEvaluatedKey)).toString("base64"):null}}throw new Error(`Unhandled field: ${t}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
