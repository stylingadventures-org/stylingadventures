{
  "version": 3,
  "sources": ["../../lambda/creator/ai.ts"],
  "sourcesContent": ["// lambda/creator/ai.ts\r\nimport {\r\n  BedrockRuntimeClient,\r\n  InvokeModelCommand,\r\n} from \"@aws-sdk/client-bedrock-runtime\";\r\n\r\nconst STORY_SCHEDULER_ARN = process.env.STORY_SCHEDULER_ARN || \"\";\r\nconst BEDROCK_MODEL_ID =\r\n  process.env.BEDROCK_MODEL_ID ||\r\n  \"anthropic.claude-3-5-sonnet-20240620-v1:0\";\r\nconst BEDROCK_REGION = process.env.BEDROCK_REGION || process.env.AWS_REGION;\r\n\r\n// ---------- tier helpers --------------------------------------------\r\n\r\ntype UserTier = \"FREE\" | \"BESTIE\" | \"CREATOR\" | \"COLLAB\" | \"ADMIN\" | \"PRIME\";\r\n\r\nfunction getUserTier(identity: any): UserTier {\r\n  const claims = identity?.claims || {};\r\n  const tierClaim =\r\n    (claims[\"custom:tier\"] as string | undefined) ||\r\n    (claims[\"tier\"] as string | undefined);\r\n\r\n  const rawGroups = claims[\"cognito:groups\"];\r\n  const groups = Array.isArray(rawGroups)\r\n    ? rawGroups\r\n    : String(rawGroups || \"\")\r\n        .split(\",\")\r\n        .map((g) => g.trim())\r\n        .filter(Boolean);\r\n\r\n  if (groups.includes(\"ADMIN\")) return \"ADMIN\";\r\n  if (groups.includes(\"COLLAB\")) return \"COLLAB\";\r\n  if (groups.includes(\"PRIME\")) return \"PRIME\";\r\n  if (groups.includes(\"CREATOR\")) return \"CREATOR\";\r\n  if (groups.includes(\"BESTIE\")) return \"BESTIE\";\r\n\r\n  if (\r\n    tierClaim &&\r\n    [\"FREE\", \"BESTIE\", \"CREATOR\", \"COLLAB\", \"ADMIN\", \"PRIME\"].includes(\r\n      tierClaim,\r\n    )\r\n  ) {\r\n    return tierClaim as UserTier;\r\n  }\r\n\r\n  return \"FREE\";\r\n}\r\n\r\nfunction requireCreator(identity: any): UserTier {\r\n  const tier = getUserTier(identity);\r\n  if (![\"CREATOR\", \"COLLAB\", \"ADMIN\", \"PRIME\"].includes(tier)) {\r\n    throw new Error(\"Creator tier required\");\r\n  }\r\n  return tier;\r\n}\r\n\r\n// ---------- Bedrock client ------------------------------------------\r\n\r\nconst bedrock =\r\n  BEDROCK_REGION && BEDROCK_MODEL_ID\r\n    ? new BedrockRuntimeClient({ region: BEDROCK_REGION })\r\n    : null;\r\n\r\ntype CreatorAiKind = \"CAPTION\" | \"HASHTAGS\" | \"OTHER\";\r\n\r\nasync function callClaudeSuggestions(\r\n  text: string,\r\n  kind: CreatorAiKind,\r\n): Promise<string[]> {\r\n  if (!bedrock) {\r\n    throw new Error(\"Bedrock not configured\");\r\n  }\r\n\r\n  const userInstruction =\r\n    kind === \"CAPTION\"\r\n      ? `You are helping a fashion content creator write short social captions.\r\nReturn a JSON array of 2-4 caption strings only. Each caption should be under 120 characters and feel natural on TikTok/IG. Base them on this context:\\n\\n\"${text}\"`\r\n      : kind === \"HASHTAGS\"\r\n        ? `You are helping a fashion creator pick hashtags.\r\nReturn a JSON array of 2-3 strings. Each string should be a space-separated list of 4-7 hashtags. Base them on this context:\\n\\n\"${text}\"`\r\n        : `You are helping a fashion content creator with planning and hooks.\r\nReturn a JSON array of 2-4 short suggestion strings. Each suggestion should be under 160 characters. Base them on this context:\\n\\n\"${text}\"`;\r\n\r\n  const body = {\r\n    anthropic_version: \"bedrock-2023-05-31\",\r\n    max_tokens: 256,\r\n    temperature: 0.7,\r\n    messages: [\r\n      {\r\n        role: \"user\",\r\n        content: [{ type: \"text\", text: userInstruction }],\r\n      },\r\n    ],\r\n  };\r\n\r\n  const res = await bedrock.send(\r\n    new InvokeModelCommand({\r\n      modelId: BEDROCK_MODEL_ID,\r\n      contentType: \"application/json\",\r\n      accept: \"application/json\",\r\n      body: Buffer.from(JSON.stringify(body)),\r\n    }),\r\n  );\r\n\r\n  const payload = JSON.parse(\r\n    new TextDecoder(\"utf-8\").decode(res.body),\r\n  ) as any;\r\n\r\n  const textContent: string =\r\n    payload?.output?.messages?.[0]?.content?.[0]?.text ??\r\n    payload?.content?.[0]?.text ??\r\n    \"\";\r\n\r\n  // Expecting a JSON array \u2013 but be defensive.\r\n  try {\r\n    const parsed = JSON.parse(textContent);\r\n    if (Array.isArray(parsed)) {\r\n      return parsed.map((s) => String(s));\r\n    }\r\n  } catch {\r\n    // if model didn't follow instructions, fall back to splitting lines\r\n  }\r\n\r\n  return textContent\r\n    .split(/\\r?\\n/)\r\n    .map((l) => l.trim())\r\n    .filter(Boolean);\r\n}\r\n\r\n// ---------- handler --------------------------------------------------\r\n\r\nexport const handler = async (event: any) => {\r\n  console.log(\"CreatorAiFn event\", JSON.stringify(event));\r\n  const fieldName = event.info?.fieldName as string | undefined;\r\n  const identity = event.identity;\r\n\r\n  requireCreator(identity);\r\n\r\n  switch (fieldName) {\r\n    case \"creatorAiSuggest\": {\r\n      const { text = \"\", kind = \"OTHER\" } = event.arguments || {};\r\n      const k: CreatorAiKind =\r\n        kind === \"CAPTION\" || kind === \"HASHTAGS\" ? kind : \"OTHER\";\r\n\r\n      // Try Bedrock first\r\n      try {\r\n        const suggestions = await callClaudeSuggestions(text, k);\r\n        if (suggestions.length) {\r\n          return { suggestions };\r\n        }\r\n      } catch (err) {\r\n        console.error(\"[CreatorAiFn] Bedrock error\", err);\r\n        // fall through to stubs\r\n      }\r\n\r\n      // Fallback suggestions if Bedrock is unavailable or misconfigured\r\n      if (k === \"CAPTION\") {\r\n        return {\r\n          suggestions: [\r\n            `\u2728 ${text || \"New look\"} \u2014 styled by you.`,\r\n            `Outfit check: ${text || \"today's fit\"} \u2728`,\r\n          ],\r\n        };\r\n      }\r\n      if (k === \"HASHTAGS\") {\r\n        return {\r\n          suggestions: [\"#stylelala #outfitideas #creatorstudio\"],\r\n        };\r\n      }\r\n      return {\r\n        suggestions: [\r\n          \"Try a short, punchy hook plus 3 strong hashtags.\",\r\n        ],\r\n      };\r\n    }\r\n\r\n    default:\r\n      throw new Error(`Unsupported field in CreatorAiFn: ${fieldName}`);\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["ai_exports", "__export", "handler", "__toCommonJS", "import_client_bedrock_runtime", "STORY_SCHEDULER_ARN", "BEDROCK_MODEL_ID", "BEDROCK_REGION", "getUserTier", "identity", "claims", "tierClaim", "rawGroups", "groups", "g", "requireCreator", "tier", "bedrock", "callClaudeSuggestions", "text", "kind", "body", "res", "payload", "textContent", "parsed", "s", "l", "event", "fieldName", "k", "suggestions", "err"]
}
