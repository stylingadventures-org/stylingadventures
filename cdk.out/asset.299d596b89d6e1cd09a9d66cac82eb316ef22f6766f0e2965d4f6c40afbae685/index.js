"use strict";var I=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var J=Object.prototype.hasOwnProperty;var W=(e,n)=>{for(var o in n)I(e,o,{get:n[o],enumerable:!0})},j=(e,n,o,s)=>{if(n&&typeof n=="object"||typeof n=="function")for(let a of H(n))!J.call(e,a)&&a!==o&&I(e,a,{get:()=>n[a],enumerable:!(s=$(n,a))||s.enumerable});return e};var q=e=>j(I({},"__esModule",{value:!0}),e);var se={};W(se,{adminApproveItem:()=>R,adminCreateClosetItem:()=>M,adminListBestieClosetItems:()=>D,adminListClosetItems:()=>k,adminListPending:()=>h,adminPublishClosetItem:()=>V,adminRejectItem:()=>K,adminSetClosetAudience:()=>_,adminUpdateClosetItem:()=>U,closetFeed:()=>x,handler:()=>ne,toggleFavoriteClosetItem:()=>F,topClosetLooks:()=>O});module.exports=q(se);var c=require("@aws-sdk/client-dynamodb"),w=require("@aws-sdk/client-sfn"),g=new c.DynamoDBClient({}),T=new w.SFNClient({}),{TABLE_NAME:m="",ADMIN_GROUP_NAME:z="admin",CREATOR_GROUP_NAME:Q="creator"}=process.env,P=process.env.FAN_APPROVAL_SM_ARN||process.env.APPROVAL_SM_ARN||"";if(!m)throw new Error("Missing env: TABLE_NAME");var X=z.toLowerCase(),Y=Q.toLowerCase(),S=()=>new Date().toISOString(),t=e=>({S:e}),Z=new Set(["PENDING","APPROVED","PUBLISHED","REJECTED"]);function N(e){let n=String(e??"").trim().toUpperCase();return Z.has(n)?n:n==="DRAFT"?"PENDING":n==="ARCHIVED"?"REJECTED":(console.warn("[Closet] Invalid status from DDB; defaulting to PENDING:",e),"PENDING")}function ee(e){let n=e?.claims||{},o=n["cognito:groups"]||n["custom:groups"]||e?.groups||[];return Array.isArray(o)?o.map(s=>String(s)):typeof o=="string"?o.split(",").map(s=>s.trim()).filter(Boolean):[]}function f(e){let n=e.identity,o=n?.claims||{},s=n?.sub||o.sub;if(!s)throw new Error("Unauthorized");let a=ee(n),u=a.map(i=>i.toLowerCase()),r=u.includes(X),d=u.includes(Y);return{sub:s,isAdmin:r,isCreator:d,groups:a}}function y(e,n){let o=e.id?.S??"",s=e.ownerSub?.S??"",a=e.status?.S??"PENDING",u=N(a),r=e.createdAt?.S||S(),d=e.updatedAt?.S||r,i=e.favoriteCount?.N,p=typeof i=="string"?Number(i):0,l=e.pinned,A=typeof l?.BOOL=="boolean"?l.BOOL:void 0;return{id:o,userId:s,ownerSub:s,status:u,createdAt:r,updatedAt:d,mediaKey:e.mediaKey?.S??"",rawMediaKey:e.rawMediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??"",season:e.season?.S??null,vibes:e.vibes?.S??null,audience:e.audience?.S??null,category:e.category?.S??null,subcategory:e.subcategory?.S??null,pinned:A,favoriteCount:p,viewerHasFaved:!1,...n}}function te(){return globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`}function C(e){return e?Buffer.from(JSON.stringify(e),"utf8").toString("base64"):null}function L(e){if(e)try{return JSON.parse(Buffer.from(String(e),"base64").toString("utf8"))}catch{return}}var h=async e=>{let{isAdmin:n}=f(e);if(!n)throw new Error("Forbidden");let{limit:o=100,nextToken:s}=e.arguments||{},a=L(s),u=await g.send(new c.QueryCommand({TableName:m,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned",ExpressionAttributeNames:{"#s":"status"},Limit:o,ExclusiveStartKey:a}));return{items:(u.Items||[]).map(d=>y({...d,status:d.status})),nextToken:C(u.LastEvaluatedKey)}},k=async e=>{let{isAdmin:n}=f(e);if(!n)throw new Error("Forbidden");let{status:o,limit:s=50,nextToken:a}=e.arguments||{},u=L(a);if(o){let i=N(o),p=await g.send(new c.QueryCommand({TableName:m,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t(`STATUS#${i}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned",ExpressionAttributeNames:{"#s":"status"},Limit:s,ExclusiveStartKey:u}));return{items:(p.Items||[]).map(A=>y({...A,status:A.status})),nextToken:C(p.LastEvaluatedKey)}}let r=await g.send(new c.ScanCommand({TableName:m,FilterExpression:"begins_with(pk, :p)",ExpressionAttributeValues:{":p":t("ITEM#")},ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned",ExpressionAttributeNames:{"#s":"status"},Limit:s,ExclusiveStartKey:u})),d=(r.Items||[]).map(i=>y({...i,status:i.status}));return d.sort((i,p)=>new Date(p.createdAt||0).getTime()-new Date(i.createdAt||0).getTime()),{items:d,nextToken:C(r.LastEvaluatedKey)}},D=async e=>{let n=await k(e),o=new Set(["BESTIE","EXCLUSIVE"]),s=n.items.filter(a=>{let u=(a.audience||"").toUpperCase();return o.has(u)});return{...n,items:s}},x=async e=>{let{sub:n}=f(e),s=(e.arguments?.sort??"NEWEST")==="MOST_LOVED"?"MOST_LOVED":"NEWEST",a=await g.send(new c.QueryCommand({TableName:m,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:{":pk":t(`FAV#${n}`),":sk":t("CLOSET#")}})),u=new Set((a.Items||[]).map(i=>{let p=i.sk?.S??"";return p.startsWith("CLOSET#")?p.substring(7):i.closetId?.S??""})),r=await g.send(new c.ScanCommand({TableName:m,FilterExpression:"begins_with(pk, :p)",ExpressionAttributeValues:{":p":t("ITEM#")},ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, audience, favoriteCount, category, subcategory, season, vibes, pinned",ExpressionAttributeNames:{"#s":"status"}})),d=[];for(let i of r.Items||[]){let p=N(i.status?.S);if(p!=="APPROVED"&&p!=="PUBLISHED")continue;let l=i.createdAt?.S||"";if(!l.trim())continue;let A=y({...i,status:i.status,createdAt:{S:l},updatedAt:i.updatedAt??{S:l}},{viewerHasFaved:u.has(i.id?.S??"")});d.push(A)}return d.sort((i,p)=>{let l=new Date(i.createdAt||0).getTime(),A=new Date(p.createdAt||0).getTime();if(s==="MOST_LOVED"){let E=i.favoriteCount??0,b=p.favoriteCount??0;return b!==E?b-E:A-l}return A-l}),{items:d,nextToken:null}},O=async e=>(await x({...e,arguments:{...e.arguments||{},sort:"NEWEST"}})).items,M=async e=>{let{sub:n,isAdmin:o}=f(e);if(!o)throw new Error("Forbidden");let s=e.arguments?.input||{};if(!s.title?.trim())throw new Error("title is required");let a=s.rawMediaKey||s.mediaKey;if(!a)throw new Error("rawMediaKey is required");let u=te(),r=S();if(await g.send(new c.PutItemCommand({TableName:m,Item:{pk:t(`ITEM#${u}`),sk:t("META"),id:t(u),ownerSub:t(n),gsi2pk:t("STATUS#PENDING"),gsi2sk:t(r),status:t("PENDING"),createdAt:t(r),updatedAt:t(r),title:t(s.title.trim()),rawMediaKey:t(a),favoriteCount:{N:"0"},...s.season?{season:t(s.season)}:{},...s.vibes?{vibes:t(s.vibes)}:{},...s.category?{category:t(s.category)}:{},...s.subcategory?{subcategory:t(s.subcategory)}:{},...s.audience?{audience:t(s.audience)}:{},...s.description?{description:t(s.description)}:{},...s.story?{story:t(s.story)}:{}}})),P)try{await T.send(new w.StartExecutionCommand({stateMachineArn:P,input:JSON.stringify({item:{id:u,ownerSub:n,userrelubed:n,s3Key:a}})}))}catch(d){console.error("Failed to start FAN approval Step Function",d)}else console.warn("FAN_APPROVAL_SM_ARN is not set; adminCreateClosetItem will not trigger the fan approval workflow.");return{id:u,userId:n,ownerSub:n,status:"PENDING",createdAt:r,updatedAt:r,title:s.title.trim(),mediaKey:"",rawMediaKey:a,reason:"",season:s.season??null,vibes:s.vibes??null,audience:s.audience??null,category:s.category??null,subcategory:s.subcategory??null,favoriteCount:0,viewerHasFaved:!1}},R=async e=>{let{isAdmin:n}=f(e);if(!n)throw new Error("Forbidden");let o=e.arguments?.closetItemId;if(!o)throw new Error("closetItemId required");let s=S(),u=(await g.send(new c.UpdateItemCommand({TableName:m,Key:{pk:t(`ITEM#${o}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken, taskToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("APPROVED"),":u":t(s),":g2pk":t("STATUS#APPROVED"),":g2sk":t(s)},ReturnValues:"ALL_OLD"}))).Attributes,r=u.taskToken?.S??u.approvalToken?.S;if(r)try{await T.send(new w.SendTaskSuccessCommand({taskToken:r,output:JSON.stringify({decision:"APPROVE"})}))}catch(d){console.warn("SendTaskSuccess failed (token may be stale)",d)}return y({...u,status:t("APPROVED")})},K=async e=>{let{isAdmin:n}=f(e);if(!n)throw new Error("Forbidden");let o=e.arguments?.closetItemId,s=e.arguments?.reason||"";if(!o)throw new Error("closetItemId required");let a=S(),r=(await g.send(new c.UpdateItemCommand({TableName:m,Key:{pk:t(`ITEM#${o}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken, taskToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("REJECTED"),":u":t(a),":g2pk":t("STATUS#REJECTED"),":g2sk":t(a),":r":t(s)},ReturnValues:"ALL_OLD"}))).Attributes,d=r.taskToken?.S??r.approvalToken?.S;if(d)try{await T.send(new w.SendTaskFailureCommand({taskToken:d,error:"Rejected",cause:s||"Rejected by admin"}))}catch(i){console.warn("SendTaskFailure failed (token may be stale)",i)}return y({...r,status:t("REJECTED"),reason:t(s)})},V=async e=>{let{isAdmin:n}=f(e);if(!n)throw new Error("Forbidden");let o=e.arguments?.closetItemId;if(!o)throw new Error("closetItemId required");let s=S(),a=await g.send(new c.UpdateItemCommand({TableName:m,Key:{pk:t(`ITEM#${o}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("PUBLISHED"),":u":t(s),":g2pk":t("STATUS#PUBLISHED"),":g2sk":t(s)},ReturnValues:"ALL_NEW"}));if(!a.Attributes)throw new Error("Closet item not found");return y(a.Attributes)},U=async e=>{let{isAdmin:n}=f(e);if(!n)throw new Error("Forbidden");let o=e.arguments||{},s=o.input||{},a=o.closetItemId??s.id??o.id;if(!a)throw new Error("closetItemId or input.id required");if(!(await g.send(new c.GetItemCommand({TableName:m,Key:{pk:t(`ITEM#${a}`),sk:t("META")}}))).Item)throw new Error("Closet item not found");let r={...s};["title","category","subcategory","audience","pinned","season","vibes"].forEach(E=>{o[E]!==void 0&&r[E]===void 0&&(r[E]=o[E])});let d=S(),i=["#updatedAt = :u"],p={"#updatedAt":"updatedAt"},l={":u":t(d)};if(r.title!==void 0&&(i.push("#title = :title"),p["#title"]="title",l[":title"]=r.title===null?{NULL:!0}:t(r.title)),r.category!==void 0&&(i.push("#category = :category"),p["#category"]="category",l[":category"]=r.category===null?{NULL:!0}:t(r.category)),r.subcategory!==void 0&&(i.push("#subcategory = :subcategory"),p["#subcategory"]="subcategory",l[":subcategory"]=r.subcategory===null?{NULL:!0}:t(r.subcategory)),r.audience!==void 0&&(i.push("audience = :audience"),l[":audience"]=r.audience===null?{NULL:!0}:t(r.audience)),r.season!==void 0&&(i.push("season = :season"),l[":season"]=r.season===null?{NULL:!0}:t(r.season)),r.vibes!==void 0&&(i.push("vibes = :vibes"),l[":vibes"]=r.vibes===null?{NULL:!0}:t(r.vibes)),r.pinned!==void 0&&(i.push("pinned = :pinned"),l[":pinned"]=r.pinned===null?{NULL:!0}:{BOOL:!!r.pinned}),i.length===1)throw new Error("No fields provided to update");let A=await g.send(new c.UpdateItemCommand({TableName:m,Key:{pk:t(`ITEM#${a}`),sk:t("META")},UpdateExpression:`SET ${i.join(", ")}`,ExpressionAttributeNames:p,ExpressionAttributeValues:l,ReturnValues:"ALL_NEW"}));if(!A.Attributes)throw new Error("Closet item not found");return y(A.Attributes)},_=async e=>{let{isAdmin:n}=f(e);if(!n)throw new Error("Forbidden");let o=e.arguments?.closetItemId,s=e.arguments?.audience;if(!o)throw new Error("closetItemId required");if(!s)throw new Error("audience required");let a=S(),u=await g.send(new c.UpdateItemCommand({TableName:m,Key:{pk:t(`ITEM#${o}`),sk:t("META")},UpdateExpression:"SET audience = :aud, updatedAt = :u",ExpressionAttributeValues:{":aud":t(s),":u":t(a)},ReturnValues:"ALL_NEW"}));if(!u.Attributes)throw new Error("Closet item not found");return y(u.Attributes)},F=async e=>{let{sub:n}=f(e),o=e.arguments?.id,s=e.arguments?.favoriteOn,a=e.arguments?.on,u=typeof s=="boolean"?s:a;if(!o)throw new Error("id required");let d=(await g.send(new c.GetItemCommand({TableName:m,Key:{pk:t(`ITEM#${o}`),sk:t("META")}}))).Item;if(!d)throw new Error("Closet item not found");let i={pk:t(`FAV#${n}`),sk:t(`CLOSET#${o}`)},l=!!(await g.send(new c.GetItemCommand({TableName:m,Key:i}))).Item,A=typeof u=="boolean"?u:!l,E=S(),b=0;A&&!l?(b=1,await g.send(new c.PutItemCommand({TableName:m,Item:{...i,userSub:t(n),closetId:t(o),createdAt:t(E)}}))):!A&&l&&(b=-1,await g.send(new c.DeleteItemCommand({TableName:m,Key:i}))),b!==0&&await g.send(new c.UpdateItemCommand({TableName:m,Key:{pk:t(`ITEM#${o}`),sk:t("META")},UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) + :delta, updatedAt = :u",ExpressionAttributeValues:{":zero":{N:"0"},":delta":{N:String(b)},":u":t(E)}}));let v=d.favoriteCount?.N,B=typeof v=="string"?Number(v):0,G=Math.max(0,B+b);return y(d,{favoriteCount:G,viewerHasFaved:A})},ne=async e=>{let n=e.info.fieldName;if(n==="adminListPending")return h(e);if(n==="adminListClosetItems")return k(e);if(n==="adminListBestieClosetItems")return D(e);if(n==="adminCreateClosetItem")return M(e);if(n==="adminApproveItem")return R(e);if(n==="adminRejectItem")return K(e);if(n==="adminPublishClosetItem")return V(e);if(n==="adminSetClosetAudience")return _(e);if(n==="adminUpdateClosetItem")return U(e);if(n==="closetFeed")return x(e);if(n==="topClosetLooks")return O(e);if(n==="toggleFavoriteClosetItem"||n==="likeClosetItem")return F(e);throw new Error(`No resolver implemented for field ${n}`)};0&&(module.exports={adminApproveItem,adminCreateClosetItem,adminListBestieClosetItems,adminListClosetItems,adminListPending,adminPublishClosetItem,adminRejectItem,adminSetClosetAudience,adminUpdateClosetItem,closetFeed,handler,toggleFavoriteClosetItem,topClosetLooks});
//# sourceMappingURL=index.js.map
