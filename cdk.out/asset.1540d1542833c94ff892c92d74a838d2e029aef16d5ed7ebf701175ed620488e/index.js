"use strict";var v=Object.create;var l=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var T=Object.getPrototypeOf,R=Object.prototype.hasOwnProperty;var N=(e,t)=>{for(var n in t)l(e,n,{get:t[n],enumerable:!0})},A=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of B(t))!R.call(e,i)&&i!==n&&l(e,i,{get:()=>t[i],enumerable:!(s=C(t,i))||s.enumerable});return e};var k=(e,t,n)=>(n=e!=null?v(T(e)):{},A(t||!e||!e.__esModule?l(n,"default",{value:e,enumerable:!0}):n,e)),L=e=>A(l({},"__esModule",{value:!0}),e);var O={};N(O,{handler:()=>M});module.exports=L(O);var E=require("@aws-sdk/client-cognito-identity-provider"),D=require("@aws-sdk/client-dynamodb"),o=require("@aws-sdk/lib-dynamodb"),h=k(require("stripe")),{USER_POOL_ID:U="",TABLE_NAME:w=""}=process.env;if(!w)throw new Error("Missing env TABLE_NAME");if(!U)throw new Error("Missing env USER_POOL_ID");var _=process.env.STRIPE_SECRET_KEY||"",g=process.env.STRIPE_PRICE_ID||"",y=(process.env.BASE_SUCCESS_URL||"http://localhost:5173").replace(/\/$/,""),P=new E.CognitoIdentityProviderClient({}),f=o.DynamoDBDocumentClient.from(new D.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),p=e=>`USER#${e}`,S="BESTIE";async function m(e){let n=(await f.send(new o.GetCommand({TableName:w,Key:{pk:p(e),sk:S}}))).Item??{};return{active:!!n.active,since:n.since??null,until:n.until??null,source:n.source??null}}async function u(e,t){let n=new Date().toISOString();return await f.send(new o.UpdateCommand({TableName:w,Key:{pk:p(e),sk:S},UpdateExpression:"SET #doc = if_not_exists(#doc, :empty), #updatedAt = :now",ExpressionAttributeNames:{"#doc":"doc","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":empty":{},":now":n}})),await f.send(new o.UpdateCommand({TableName:w,Key:{pk:p(e),sk:S},UpdateExpression:"SET #active = :a, #since = if_not_exists(#since, :since), #until = :u, #source = :s, #updatedAt = :now",ExpressionAttributeNames:{"#active":"active","#since":"since","#until":"until","#source":"source","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":a":t.active,":since":t.since??n,":u":t.until??null,":s":t.source??null,":now":n}})),m(e)}async function I(e){let n=(await P.send(new E.ListUsersCommand({UserPoolId:U,Filter:`email = "${e}"`,Limit:1}))).Users?.[0];return n?.Attributes?n.Attributes.find(i=>i.Name==="sub")?.Value??null:null}function d(e){let t=e?.groups;return Array.isArray(t)&&t.includes("ADMIN")}var M=async e=>{let t=e.identity,n=e.info?.fieldName;if(n==="startBestieCheckout"){let s=e.identity;if(!s?.sub)throw new Error("Unauthorized");if(!_||!g)throw new Error("Stripe not configured");let i=new h.default(_),r=e.arguments?.successPath??"/bestie/thanks",a=`${y}${r}`,c=`${y}/bestie?cancelled=1`,b=await i.checkout.sessions.create({mode:"subscription",line_items:[{price:g,quantity:1}],success_url:`${a}?session_id={CHECKOUT_SESSION_ID}`,cancel_url:c,client_reference_id:s.sub,customer_email:s?.claims?.email,metadata:{sub:s.sub,email:s?.claims?.email??""},allow_promotion_codes:!0});if(!b.url)throw new Error("No checkout URL from Stripe");return{url:b.url}}if(n==="meBestieStatus"){if(!t?.sub)throw new Error("Unauthorized");return m(t.sub)}if(n==="isEpisodeEarlyAccess"){let s=Date.now(),i=t?.sub;if(!i)return{allowed:!1,reason:"not_signed_in"};let r=await m(i),a=r.until?Date.parse(r.until):0,c=r.active&&a>s;return{allowed:c,reason:c?null:"not_bestie"}}if(n==="claimBestieTrial"){if(!t?.sub)throw new Error("Unauthorized");let s=await m(t.sub);if(s.active&&s.until&&Date.parse(s.until)>Date.now()||s.source==="TRIAL")return s;let i=10080*60*1e3,r=new Date(Date.now()+i).toISOString();return u(t.sub,{active:!0,until:r,source:"TRIAL"})}if(n==="adminSetBestie"){if(!d(t))throw new Error("Forbidden");let{userSub:s,active:i}=e.arguments,r=i?new Date(Date.now()+365*24*60*60*1e3).toISOString():null;return u(s,{active:!!i,until:r,source:"ADMIN"})}if(n==="adminRevokeBestie"){if(!d(t))throw new Error("Forbidden");let{userSub:s}=e.arguments;return u(s,{active:!1,until:null,source:"ADMIN"})}if(n==="adminSetBestieByEmail"){if(!d(t))throw new Error("Forbidden");let{email:s,active:i}=e.arguments,r=await I(s);if(!r)throw new Error("User not found");let a=i?new Date(Date.now()+365*24*60*60*1e3).toISOString():null;return u(r,{active:!!i,until:a,source:"ADMIN_EMAIL"})}if(n==="adminRevokeBestieByEmail"){if(!d(t))throw new Error("Forbidden");let{email:s}=e.arguments,i=await I(s);if(!i)throw new Error("User not found");return u(i,{active:!1,until:null,source:"ADMIN_EMAIL"})}throw new Error(`Unknown field ${n}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
