"use strict";var f=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var C=Object.prototype.hasOwnProperty;var h=(t,n)=>{for(var l in n)f(t,l,{get:n[l],enumerable:!0})},K=(t,n,l,r)=>{if(n&&typeof n=="object"||typeof n=="function")for(let e of x(n))!C.call(t,e)&&e!==l&&f(t,e,{get:()=>n[e],enumerable:!(r=k(n,e))||r.enumerable});return t};var D=t=>K(f({},"__esModule",{value:!0}),t);var U={};h(U,{handler:()=>P});module.exports=D(U);var S=require("crypto"),T=require("@aws-sdk/client-dynamodb"),i=require("@aws-sdk/lib-dynamodb"),w=require("@aws-sdk/client-sfn"),d=process.env.TABLE_NAME,N=process.env.APPROVAL_SM_ARN||"",u=i.DynamoDBDocumentClient.from(new T.DynamoDBClient({})),R=new w.SFNClient({}),p=()=>new Date().toISOString(),c=t=>{let n=t?.claims?.["cognito:groups"];return Array.isArray(n)?n.includes("ADMIN"):`${n||""}`.includes("ADMIN")},g=t=>{if(!t)throw new Error("Unauthenticated")},m=t=>({pk:`ITEM#${t}`,sk:"META"}),b=t=>({id:t.id,ownerSub:t.ownerSub,title:t.title??null,status:t.status,mediaKey:t.mediaKey??null,createdAt:t.createdAt,updatedAt:t.updatedAt}),P=async t=>{let n=t.info.fieldName,l=t.identity,r=l?.sub;if(n==="myCloset")return g(r),((await u.send(new i.QueryCommand({TableName:d,IndexName:"gsi1",KeyConditionExpression:"gsi1pk = :p",ExpressionAttributeValues:{":p":`OWNER#${r}`},ScanIndexForward:!1,Limit:50}))).Items||[]).filter(s=>s.sk==="META").map(b);if(n==="createClosetItem"){g(r);let{title:e,mediaKey:s}=t.arguments||{},o=(0,S.randomUUID)(),a=p(),E={id:o,ownerSub:r,title:(e??"").trim()||null,mediaKey:(s??"").trim()||null,status:"DRAFT",createdAt:a,updatedAt:a};return await u.send(new i.PutCommand({TableName:d,Item:{...E,...m(o),gsi1pk:`OWNER#${r}`,gsi1sk:a,gsi2pk:"STATUS#DRAFT",gsi2sk:a},ConditionExpression:"attribute_not_exists(pk)"})),E}if(n==="updateClosetItem"){g(r);let{id:e,title:s,mediaKey:o}=t.arguments,a=await u.send(new i.GetCommand({TableName:d,Key:m(e)}));if(!a.Item)throw new Error("Not found");if(a.Item.ownerSub!==r)throw new Error("Forbidden");let E=p(),A=["updatedAt = :u"],y={":u":E};typeof s<"u"&&(A.push("#t = :t"),y[":t"]=s??null),typeof o<"u"&&(A.push("mediaKey = :m"),y[":m"]=o??null);let I=await u.send(new i.UpdateCommand({TableName:d,Key:m(e),UpdateExpression:`SET ${A.join(", ")}`,ExpressionAttributeValues:y,ExpressionAttributeNames:{"#t":"title"},ReturnValues:"ALL_NEW"}));return b(I.Attributes)}if(n==="updateClosetMediaKey"){g(r);let{id:e,key:s}=t.arguments,o=await u.send(new i.GetCommand({TableName:d,Key:m(e)}));if(!o.Item)throw new Error("Not found");if(o.Item.ownerSub!==r)throw new Error("Forbidden");let a=p();return await u.send(new i.UpdateCommand({TableName:d,Key:m(e),UpdateExpression:"SET mediaKey = :k, updatedAt = :u",ExpressionAttributeValues:{":k":s,":u":a}})),!0}if(n==="deleteClosetItem"){g(r);let{id:e}=t.arguments,s=await u.send(new i.GetCommand({TableName:d,Key:m(e)}));if(!s.Item)throw new Error("Not found");if(s.Item.ownerSub!==r&&!c(l))throw new Error("Forbidden");return await u.send(new i.DeleteCommand({TableName:d,Key:m(e)})),!0}if(n==="requestClosetApproval"){g(r);let{id:e}=t.arguments,s=await u.send(new i.GetCommand({TableName:d,Key:m(e)}));if(!s.Item)throw new Error("Not found");if(s.Item.ownerSub!==r)throw new Error("Forbidden");let o=p();return await u.send(new i.UpdateCommand({TableName:d,Key:m(e),UpdateExpression:"SET #s = :p, gsi2pk = :g, gsi2sk = :ts, updatedAt = :ts",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":p":"PENDING",":g":"STATUS#PENDING",":ts":o}})),N&&await R.send(new w.StartExecutionCommand({stateMachineArn:N,input:JSON.stringify({itemId:e,ownerSub:r})})),!0}if(n==="adminListPending"){if(!c(l))throw new Error("Not authorized");let e=t.arguments||{},s=Math.min(Math.max(e.limit??25,1),100),o=e.nextToken?JSON.parse(Buffer.from(e.nextToken,"base64").toString("utf8")):void 0,a=await u.send(new i.QueryCommand({TableName:d,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":"STATUS#PENDING"},ScanIndexForward:!1,Limit:s,ExclusiveStartKey:o}));return{items:(a.Items||[]).map(b),nextToken:a.LastEvaluatedKey?Buffer.from(JSON.stringify(a.LastEvaluatedKey)).toString("base64"):null}}if(n==="adminApproveItem"){if(!c(l))throw new Error("Not authorized");let{id:e}=t.arguments,s=p();return await u.send(new i.UpdateCommand({TableName:d,Key:m(e),UpdateExpression:"SET #s = :a, gsi2pk = :g, gsi2sk = :ts, updatedAt = :ts REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":a":"APPROVED",":g":"STATUS#APPROVED",":ts":s}})),!0}if(n==="adminRejectItem"){if(!c(l))throw new Error("Not authorized");let{id:e,reason:s}=t.arguments,o=p();return await u.send(new i.UpdateCommand({TableName:d,Key:m(e),UpdateExpression:"SET #s = :r, gsi2pk = :g, gsi2sk = :ts, updatedAt = :ts, reason = :why REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":r":"REJECTED",":g":"STATUS#REJECTED",":ts":o,":why":s??"Rejected by admin"}})),!0}throw new Error(`Unhandled field: ${n}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
