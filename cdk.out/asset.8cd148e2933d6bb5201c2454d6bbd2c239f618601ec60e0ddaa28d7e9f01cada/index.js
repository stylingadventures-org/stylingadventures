"use strict";var N=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var v=(t,e)=>{for(var s in e)N(t,s,{get:e[s],enumerable:!0})},P=(t,e,s,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of O(e))!B.call(t,i)&&i!==s&&N(t,i,{get:()=>e[i],enumerable:!(n=M(e,i))||n.enumerable});return t};var h=t=>P(N({},"__esModule",{value:!0}),t);var J={};v(J,{handler:()=>j});module.exports=h(J);var U=require("@aws-sdk/client-dynamodb"),r=require("@aws-sdk/lib-dynamodb"),T=require("@aws-sdk/client-lambda");var u=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!u)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var l=r.DynamoDBDocumentClient.from(new U.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),S=process.env.AWARD_PRIME_COINS_FN_NAME||"",F=new T.LambdaClient({});function $(t){let e=t?.groups;return Array.isArray(e)?e.includes("ADMIN")||e.includes("PRIME"):!1}function V(t,e){if(!e?.sub)throw new Error("Unauthenticated");if(!$(e)&&e.sub!==t)throw new Error("Forbidden")}function z(t){let e=t?.claims||{},s=e.tier??e["custom:tier"];if(s&&["FREE","BESTIE","CREATOR","COLLAB","ADMIN","PRIME"].includes(s))return s;let i=e["cognito:groups"],o=Array.isArray(i)?i:String(i||"").split(",").map(a=>a.trim()).filter(Boolean);return o.includes("ADMIN")?"ADMIN":o.includes("PRIME")?"PRIME":o.includes("CREATOR")?"CREATOR":o.includes("COLLAB")?"COLLAB":o.includes("BESTIE")?"BESTIE":"FREE"}function X(t){if(t==null)return null;if(typeof t=="string")try{return JSON.parse(t)}catch{return{raw:t}}return typeof t=="object"?t:{value:t}}function Y(t){let e=1,s=100,n=t|0;for(;n>=s;)n-=s,e++,s+=50;return e}function x(t,e=12){return Math.max(0,t|0).toString().padStart(e,"0")}function G(t,e){if(!t||!e)return!1;let s=new Date(t),n=new Date(e);return s.getUTCFullYear()===n.getUTCFullYear()&&s.getUTCMonth()===n.getUTCMonth()&&s.getUTCDate()===n.getUTCDate()}function W(t,e){let s=new Date(t),n=new Date(e),i=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()-1));return s.getUTCFullYear()===i.getUTCFullYear()&&s.getUTCMonth()===i.getUTCMonth()&&s.getUTCDate()===i.getUTCDate()}async function K(t,e,s,n){if(!S)return;let i={action:"awardCoins",userId:t,amount:e,source:s,description:n};try{await F.send(new T.InvokeCommand({FunctionName:S,InvocationType:"Event",Payload:Buffer.from(JSON.stringify(i))}))}catch(o){console.error("Failed to invoke Prime Bank awardCoins",o)}}var j=async t=>{let{fieldName:e}=t.info,s=t.identity;if(e==="logGameEvent"){if(!s?.sub)throw new Error("Unauthenticated");let n=s.sub,i=new Date().toISOString(),o=t.arguments?.input??{},a=o.type||"UNKNOWN",g=X(o.metadata),c=z(s);if(c==="FREE")return{success:!0,xp:0,coins:0,newXP:0,newCoins:0,lastEventAt:i};if(a==="DAILY_LOGIN"){let I=await l.send(new r.GetCommand({TableName:u,Key:{pk:`USER#${n}`,sk:"PROFILE"},ProjectionExpression:"lastLoginAt, streakCount, xp, coins, badges, displayName, lastEventAt"})),f=I.Item?.lastLoginAt,w=typeof f=="string"?f:typeof f=="number"?new Date(f).toISOString():void 0,E=Number(I.Item?.streakCount??0),y=1,d=0;w&&G(w,i)?(y=0,d=0):w&&W(w,i)?E+=1:E=1,y=E>0?10+Math.min(5,E):0,d=E>0?1:0,d>0&&c!=="FREE"&&await K(n,d,"dailyLogin",`Daily login streak=${E}`);let b=await l.send(new r.UpdateCommand({TableName:u,Key:{pk:`USER#${n}`,sk:"PROFILE"},UpdateExpression:`
            SET xp = if_not_exists(xp,:z) + :xi,
                coins = if_not_exists(coins,:z) + :ci,
                lastEventAt = :now,
                lastLoginAt = :now,
                streakCount = :st
          `.replace(/\s+/g," "),ExpressionAttributeValues:{":z":0,":xi":y,":ci":d,":now":i,":st":E},ReturnValues:"ALL_NEW"})),R=Number(b.Attributes?.xp??0),D=Number(b.Attributes?.coins??0),_=b.Attributes?.lastEventAt??i;return await l.send(new r.PutCommand({TableName:u,Item:{pk:`USER#${n}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${x(R)}#${n}`,xp:R,coins:D,streakCount:E,updatedAt:i,type:"LEADER"}})),{success:!0,xp:R,coins:D,newXP:y,newCoins:d,lastEventAt:_}}let p=a==="LEVEL_CLEAR"?50:a==="SHARE"?5:a==="STYLE_IT"?Math.max(1,Math.round((g?.score??5)/5)):1,A=a==="LEVEL_CLEAR"?5:0,m=await l.send(new r.UpdateCommand({TableName:u,Key:{pk:`USER#${n}`,sk:"PROFILE"},UpdateExpression:`
          SET xp = if_not_exists(xp,:z) + :xi,
              coins = if_not_exists(coins,:z) + :ci,
              lastEventAt = :now
        `.replace(/\s+/g," "),ExpressionAttributeValues:{":z":0,":xi":p,":ci":A,":now":i},ReturnValues:"ALL_NEW"})),L=Number(m.Attributes?.xp??0),C=Number(m.Attributes?.coins??0),k=m.Attributes?.lastEventAt??i;return await l.send(new r.PutCommand({TableName:u,Item:{pk:`USER#${n}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${x(L)}#${n}`,xp:L,coins:C,updatedAt:i,type:"LEADER"}})),await l.send(new r.PutCommand({TableName:u,Item:{pk:`USER#${n}`,sk:`EVENT#${Date.now()}`,type:"EVENT",evType:a,metadata:g,at:i},ConditionExpression:"attribute_not_exists(pk)"})).catch(()=>{}),{success:!0,xp:L,coins:C,newXP:p,newCoins:A,lastEventAt:k}}if(e==="awardCoins"){let{userId:n,coins:i,xp:o}=t.arguments.input;V(n,s);let a=Math.max(0,i|0),g=Math.max(0,(o??0)|0),c=await l.send(new r.UpdateCommand({TableName:u,Key:{pk:`USER#${n}`,sk:"PROFILE"},UpdateExpression:"SET coins = if_not_exists(coins,:z) + :c, xp = if_not_exists(xp,:z) + :x",ExpressionAttributeValues:{":z":0,":c":a,":x":g},ReturnValues:"ALL_NEW"})),p=Number(c.Attributes?.xp??0),A=Number(c.Attributes?.coins??0),m=c.Attributes?.lastEventAt??null;return await l.send(new r.PutCommand({TableName:u,Item:{pk:`USER#${n}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${x(p)}#${n}`,xp:p,coins:A,updatedAt:new Date().toISOString(),type:"LEADER"}})),{userId:n,displayName:c.Attributes?.displayName||null,level:Y(p),xp:p,coins:A,badges:Array.isArray(c.Attributes?.badges)?c.Attributes.badges:[],lastEventAt:m}}throw new Error(`Unknown field ${e}`)};0&&(module.exports={handler});
