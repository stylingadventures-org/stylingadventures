"use strict";var p=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var f=(e,t)=>{for(var n in t)p(e,n,{get:t[n],enumerable:!0})},I=(e,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of S(t))!w.call(e,s)&&s!==n&&p(e,s,{get:()=>t[s],enumerable:!(i=E(t,s))||i.enumerable});return e};var b=e=>I(p({},"__esModule",{value:!0}),e);var P={};f(P,{handler:()=>k});module.exports=b(P);var r=require("@aws-sdk/client-dynamodb"),A=require("@aws-sdk/util-dynamodb"),o=new r.DynamoDBClient({}),u=process.env.APP_TABLE;function d(e){let t=(0,A.unmarshall)(e);return{id:String(t.id),userId:String(t.userId??t.ownerSub??""),ownerSub:String(t.ownerSub??t.userId??""),status:t.status??"PENDING",createdAt:String(t.createdAt),updatedAt:String(t.updatedAt??t.createdAt),mediaKey:t.mediaKey??null,title:t.title??null,reason:t.reason??null,audience:t.audience??"PUBLIC"}}async function m(e){let t=await o.send(new r.ScanCommand({TableName:u,FilterExpression:"#id = :id",ExpressionAttributeNames:{"#id":"id"},ExpressionAttributeValues:{":id":{S:e}},Limit:1}));return!t.Items||t.Items.length===0?null:t.Items[0]}function l(e){if(e.pk?.S&&e.sk?.S)return{pk:e.pk.S,sk:e.sk.S};throw new Error("Could not infer pk/sk for closet item")}async function C(){return((await o.send(new r.ScanCommand({TableName:u,FilterExpression:"#status = :pending OR #status = :approved",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":pending":{S:"PENDING"},":approved":{S:"APPROVED"}}}))).Items||[]).map(d)}async function g(e){let t=await m(e.id);if(!t)throw new Error(`Closet item not found for id=${e.id}`);let{pk:n,sk:i}=l(t),s=new Date().toISOString(),a=await o.send(new r.UpdateItemCommand({TableName:u,Key:{pk:{S:n},sk:{S:i}},UpdateExpression:"SET #status = :approved, #updatedAt = :now REMOVE #reason",ExpressionAttributeNames:{"#status":"status","#updatedAt":"updatedAt","#reason":"reason"},ExpressionAttributeValues:{":approved":{S:"APPROVED"},":now":{S:s}},ReturnValues:"ALL_NEW"}));if(!a.Attributes)throw new Error("adminApproveItem: update returned no attributes");return d(a.Attributes)}async function y(e){let t=await m(e.id);if(!t)throw new Error(`Closet item not found for id=${e.id}`);let{pk:n,sk:i}=l(t),s=new Date().toISOString(),a=!!e.reason&&e.reason.trim().length>0,c=await o.send(new r.UpdateItemCommand({TableName:u,Key:{pk:{S:n},sk:{S:i}},UpdateExpression:a?"SET #status = :rejected, #updatedAt = :now, #reason = :reason":"SET #status = :rejected, #updatedAt = :now REMOVE #reason",ExpressionAttributeNames:{"#status":"status","#updatedAt":"updatedAt","#reason":"reason"},ExpressionAttributeValues:{":rejected":{S:"REJECTED"},":now":{S:s},...a?{":reason":{S:e.reason}}:{}},ReturnValues:"ALL_NEW"}));if(!c.Attributes)throw new Error("adminRejectItem: update returned no attributes");return d(c.Attributes)}async function N(e){let t=await m(e.id);if(!t)throw new Error(`Closet item not found for id=${e.id}`);let{pk:n,sk:i}=l(t),s=new Date().toISOString(),a=await o.send(new r.UpdateItemCommand({TableName:u,Key:{pk:{S:n},sk:{S:i}},UpdateExpression:"SET #audience = :aud, #updatedAt = :now",ExpressionAttributeNames:{"#audience":"audience","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":aud":{S:e.audience},":now":{S:s}},ReturnValues:"ALL_NEW"}));if(!a.Attributes)throw new Error("adminSetClosetAudience: update returned no attributes");return d(a.Attributes)}var k=async e=>{let{fieldName:t,parentTypeName:n}=e.info;if(n==="Query"&&t==="adminListPending")return C();if(n==="Mutation"){if(t==="adminApproveItem")return g(e.arguments);if(t==="adminRejectItem")return y(e.arguments);if(t==="adminSetClosetAudience")return N(e.arguments)}throw new Error(`Unknown field ${n}.${t} in ClosetAdminFn`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
