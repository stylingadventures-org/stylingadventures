"use strict";var d=Object.defineProperty;var l=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var C=(n,e)=>{for(var o in e)d(n,o,{get:e[o],enumerable:!0})},w=(n,e,o,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of p(e))!A.call(n,r)&&r!==o&&d(n,r,{get:()=>e[r],enumerable:!(t=l(e,r))||t.enumerable});return n};var g=n=>w(d({},"__esModule",{value:!0}),n);var O={};C(O,{handler:()=>I});module.exports=g(O);var f=require("@aws-sdk/client-dynamodb"),i=require("@aws-sdk/lib-dynamodb"),s=require("@aws-sdk/client-lambda"),m=i.DynamoDBDocumentClient.from(new f.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),c=process.env.TABLE_NAME,a=process.env.AWARD_PRIME_COINS_FN_NAME||"",E=new s.LambdaClient({});function N(n){if(!n?.sub)throw new Error("Unauthenticated")}function u(n){return N(n),n.sub}async function y(n){if(!a)throw new Error("Prime Bank not configured");let e=await E.send(new s.InvokeCommand({FunctionName:a,InvocationType:"RequestResponse",Payload:Buffer.from(JSON.stringify(n))})),o=e.Payload?Buffer.from(e.Payload).toString("utf-8"):"";if(!o)throw new Error("Prime Bank: empty response from awardPrimeCoins");let t=JSON.parse(o);if(t.error)throw new Error(t.error);return t}var I=async n=>{let{fieldName:e}=n.info,o=n.identity;if(e==="getGameEconomyConfig")return(await m.send(new i.GetCommand({TableName:c,Key:{pk:"CONFIG#GAME_ECONOMY",sk:"CONFIG#GAME_ECONOMY"}}))).Item||{id:"default-game-economy-config",dailyLoginCoins:1};if(e==="updateGameEconomyConfig"){let t=n.arguments?.input??{};return await m.send(new i.PutCommand({TableName:c,Item:{pk:"CONFIG#GAME_ECONOMY",sk:"CONFIG#GAME_ECONOMY",...t,updatedAt:new Date().toISOString()}})),t}if(e==="getPrimeBankAccount"){let t=u(o);if(!a)return{userId:t,role:"FAN",primeCoins:0,creatorCredits:0,bankMeterProgress:0,dailyCoinTotal:0,weeklyCoinTotal:0,lastDailyReset:null,lastWeeklyReset:null};let r=await y({action:"getAccount",userId:t});return r.account??r}if(e==="dailyLogin"){let t=u(o);return a?await y({action:"dailyLogin",userId:t}):{ok:!1,reason:"Prime Bank not configured"}}throw new Error(`Unknown field ${e}`)};0&&(module.exports={handler});
