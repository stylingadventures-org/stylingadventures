{
  "version": 3,
  "sources": ["../../lambda/game/profile.ts"],
  "sourcesContent": ["// lambda/game/profile.ts  (only the DynamoDB read/write parts shown)\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport { DynamoDBDocumentClient, GetCommand, PutCommand, UpdateCommand } from \"@aws-sdk/lib-dynamodb\";\r\n\r\nconst TABLE = process.env.TABLE_NAME!;\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}), {\r\n  marshallOptions: { removeUndefinedValues: true },\r\n});\r\n\r\nexport const handler = async (event: any) => {\r\n  const sub = event.identity?.sub;\r\n  const pk = `USER#${sub}`;\r\n  const sk = `PROFILE`;\r\n\r\n  // read profile\r\n  const got = await ddb.send(new GetCommand({ TableName: TABLE, Key: { pk, sk } }));\r\n  const prof = got.Item || { pk, sk, xp: 0, coins: 0, level: 1, badges: [] };\r\n\r\n  if (event.info.fieldName === \"getMyProfile\") {\r\n    return toProfile(prof);\r\n  }\r\n\r\n  if (event.info.fieldName === \"grantBadge\") {\r\n    const { userId, badge } = event.arguments;\r\n    const up = await ddb.send(new UpdateCommand({\r\n      TableName: TABLE,\r\n      Key: { pk: `USER#${userId}`, sk: \"PROFILE\" },\r\n      UpdateExpression: \"ADD badges :b\",\r\n      ExpressionAttributeValues: { \":b\": ddb.createSet ? ddb.createSet([badge]) : [badge] },\r\n      ReturnValues: \"ALL_NEW\",\r\n    }));\r\n    return toProfile(up.Attributes || prof);\r\n  }\r\n\r\n  // logGameEvent etc\u2026 follow the same pattern using DocumentClient numbers\r\n  // \u2026\r\n};\r\n\r\nfunction toProfile(i: any) {\r\n  return {\r\n    userId: String(i.pk || \"\").replace(\"USER#\", \"\"),\r\n    level: i.level ?? 1,\r\n    xp: i.xp ?? 0,\r\n    coins: i.coins ?? 0,\r\n    badges: Array.isArray(i.badges) ? i.badges : [],\r\n    lastEventAt: i.lastEventAt || null,\r\n  };\r\n}\r\n\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GACA,IAAAI,EAA+B,oCAC/BC,EAA8E,iCAExEC,EAAQ,QAAQ,IAAI,WACpBC,EAAM,yBAAuB,KAAK,IAAI,iBAAe,CAAC,CAAC,EAAG,CAC9D,gBAAiB,CAAE,sBAAuB,EAAK,CACjD,CAAC,EAEYL,EAAU,MAAOM,GAAe,CAE3C,IAAMC,EAAK,QADCD,EAAM,UAAU,GACN,GAChBE,EAAK,UAILC,GADM,MAAMJ,EAAI,KAAK,IAAI,aAAW,CAAE,UAAWD,EAAO,IAAK,CAAE,GAAAG,EAAI,GAAAC,CAAG,CAAE,CAAC,CAAC,GAC/D,MAAQ,CAAE,GAAAD,EAAI,GAAAC,EAAI,GAAI,EAAG,MAAO,EAAG,MAAO,EAAG,OAAQ,CAAC,CAAE,EAEzE,GAAIF,EAAM,KAAK,YAAc,eAC3B,OAAOI,EAAUD,CAAI,EAGvB,GAAIH,EAAM,KAAK,YAAc,aAAc,CACzC,GAAM,CAAE,OAAAK,EAAQ,MAAAC,CAAM,EAAIN,EAAM,UAC1BO,EAAK,MAAMR,EAAI,KAAK,IAAI,gBAAc,CAC1C,UAAWD,EACX,IAAK,CAAE,GAAI,QAAQO,CAAM,GAAI,GAAI,SAAU,EAC3C,iBAAkB,gBAClB,0BAA2B,CAAE,KAAMN,EAAI,UAAYA,EAAI,UAAU,CAACO,CAAK,CAAC,EAAI,CAACA,CAAK,CAAE,EACpF,aAAc,SAChB,CAAC,CAAC,EACF,OAAOF,EAAUG,EAAG,YAAcJ,CAAI,CACxC,CAIF,EAEA,SAASC,EAAUI,EAAQ,CACzB,MAAO,CACL,OAAQ,OAAOA,EAAE,IAAM,EAAE,EAAE,QAAQ,QAAS,EAAE,EAC9C,MAAOA,EAAE,OAAS,EAClB,GAAIA,EAAE,IAAM,EACZ,MAAOA,EAAE,OAAS,EAClB,OAAQ,MAAM,QAAQA,EAAE,MAAM,EAAIA,EAAE,OAAS,CAAC,EAC9C,YAAaA,EAAE,aAAe,IAChC,CACF",
  "names": ["profile_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "TABLE", "ddb", "event", "pk", "sk", "prof", "toProfile", "userId", "badge", "up", "i"]
}
