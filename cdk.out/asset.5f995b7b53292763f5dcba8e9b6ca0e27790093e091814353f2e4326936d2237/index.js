"use strict";var{S3Client:A,PutObjectCommand:h,GetObjectCommand:N}=require("@aws-sdk/client-s3"),{getSignedUrl:p}=require("@aws-sdk/s3-request-presigner"),u=new A({}),l=process.env.UPLOADS_BUCKET_NAME;if(!l)throw new Error("Missing env: UPLOADS_BUCKET_NAME");exports.handler=async o=>{console.log("[upload-api] event:",JSON.stringify(o));let{httpMethod:s,path:y}=o,a=y||"",g=a.endsWith("/presign"),S=a.endsWith("/get");if(s==="POST"&&g){let t;try{t=JSON.parse(o.body||"{}")}catch(f){return console.error("[upload-api] invalid JSON body for /presign",f),e(400,{error:"Invalid JSON body"})}let{key:r,kind:i,contentType:c}=t;if(!r)return e(400,{error:"Missing key"});let n=`${i==="closet"?"closet/":""}${String(r).replace(/^\/+/,"")}`,O=new h({Bucket:l,Key:n,ContentType:c||"application/octet-stream",ACL:"private"}),C=await p(u,O,{expiresIn:300});return console.log("[upload-api] presign ->",{fullKey:n}),e(200,{url:C,key:n})}if(s==="POST"&&S){let t;try{t=JSON.parse(o.body||"{}")}catch(n){return console.error("[upload-api] invalid JSON body for /get",n),e(400,{error:"Invalid JSON body"})}let{key:r}=t;if(!r)return e(400,{error:"Missing key"});let i=String(r).replace(/^\/+/,""),c=new N({Bucket:l,Key:i}),d=await p(u,c,{expiresIn:600});return console.log("[upload-api] getSignedGetUrl ->",{cleanKey:i}),e(200,{url:d})}return e(404,{error:"Not found"})};function e(o,s){return{statusCode:o,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":"true","Access-Control-Allow-Headers":"Content-Type,Authorization","Access-Control-Allow-Methods":"OPTIONS,POST"},body:JSON.stringify(s)}}
//# sourceMappingURL=index.js.map
