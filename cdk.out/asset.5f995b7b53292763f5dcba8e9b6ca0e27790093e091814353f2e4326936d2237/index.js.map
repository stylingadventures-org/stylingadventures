{
  "version": 3,
  "sources": ["../../lambda/upload-api/index.js"],
  "sourcesContent": ["// lambda/upload-api/index.js\r\n\r\n// Use AWS SDK v3 (matches CDK's --external:@aws-sdk/* bundling)\r\nconst { S3Client, PutObjectCommand, GetObjectCommand } = require(\"@aws-sdk/client-s3\");\r\nconst { getSignedUrl } = require(\"@aws-sdk/s3-request-presigner\");\r\n\r\nconst s3 = new S3Client({});\r\n\r\n// Bucket name is passed in from the CDK stack as an env var\r\nconst UPLOADS_BUCKET = process.env.UPLOADS_BUCKET_NAME;\r\n\r\nif (!UPLOADS_BUCKET) {\r\n  throw new Error(\"Missing env: UPLOADS_BUCKET_NAME\");\r\n}\r\n\r\nexports.handler = async (event) => {\r\n  console.log(\"[upload-api] event:\", JSON.stringify(event));\r\n\r\n  const { httpMethod, path } = event;\r\n\r\n  // Normalize path (in case of stage prefixes, etc.)\r\n  const fullPath = path || \"\";\r\n  const isPresignRoute = fullPath.endsWith(\"/presign\");\r\n  const isGetRoute = fullPath.endsWith(\"/get\");\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  // POST /.../presign  \u2192 presigned PUT for uploads\r\n  // body: { key, kind?, contentType? }\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (httpMethod === \"POST\" && isPresignRoute) {\r\n    let body;\r\n    try {\r\n      body = JSON.parse(event.body || \"{}\");\r\n    } catch (e) {\r\n      console.error(\"[upload-api] invalid JSON body for /presign\", e);\r\n      return json(400, { error: \"Invalid JSON body\" });\r\n    }\r\n\r\n    const { key, kind, contentType } = body;\r\n\r\n    if (!key) {\r\n      return json(400, { error: \"Missing key\" });\r\n    }\r\n\r\n    // If kind === \"closet\", store under \"closet/\" prefix. Otherwise keep as-is.\r\n    const prefix = kind === \"closet\" ? \"closet/\" : \"\";\r\n    const fullKey = `${prefix}${String(key).replace(/^\\/+/, \"\")}`;\r\n\r\n    const putCommand = new PutObjectCommand({\r\n      Bucket: UPLOADS_BUCKET,\r\n      Key: fullKey,\r\n      ContentType: contentType || \"application/octet-stream\",\r\n      ACL: \"private\",\r\n    });\r\n\r\n    // Signed PUT URL (5 minutes)\r\n    const url = await getSignedUrl(s3, putCommand, { expiresIn: 60 * 5 });\r\n\r\n    console.log(\"[upload-api] presign ->\", { fullKey });\r\n\r\n    return json(200, { url, key: fullKey });\r\n  }\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  // POST /.../get  \u2192 presigned GET for viewing\r\n  // body: { key }\r\n  // (You may not actually be using this anymore, but it\u2019s safe to keep.)\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (httpMethod === \"POST\" && isGetRoute) {\r\n    let body;\r\n    try {\r\n      body = JSON.parse(event.body || \"{}\");\r\n    } catch (e) {\r\n      console.error(\"[upload-api] invalid JSON body for /get\", e);\r\n      return json(400, { error: \"Invalid JSON body\" });\r\n    }\r\n\r\n    const { key } = body;\r\n\r\n    if (!key) {\r\n      return json(400, { error: \"Missing key\" });\r\n    }\r\n\r\n    const cleanKey = String(key).replace(/^\\/+/, \"\");\r\n\r\n    const getCommand = new GetObjectCommand({\r\n      Bucket: UPLOADS_BUCKET,\r\n      Key: cleanKey,\r\n    });\r\n\r\n    // Signed GET URL (10 minutes)\r\n    const url = await getSignedUrl(s3, getCommand, { expiresIn: 60 * 10 });\r\n\r\n    console.log(\"[upload-api] getSignedGetUrl ->\", { cleanKey });\r\n\r\n    return json(200, { url });\r\n  }\r\n\r\n  // Fallback 404\r\n  return json(404, { error: \"Not found\" });\r\n};\r\n\r\nfunction json(statusCode, body) {\r\n  return {\r\n    statusCode,\r\n    headers: {\r\n      \"Access-Control-Allow-Origin\": \"*\",\r\n      \"Access-Control-Allow-Credentials\": \"true\",\r\n      \"Access-Control-Allow-Headers\": \"Content-Type,Authorization\",\r\n      \"Access-Control-Allow-Methods\": \"OPTIONS,POST\",\r\n    },\r\n    body: JSON.stringify(body),\r\n  };\r\n}\r\n"],
  "mappings": "aAGA,GAAM,CAAE,SAAAA,EAAU,iBAAAC,EAAkB,iBAAAC,CAAiB,EAAI,QAAQ,oBAAoB,EAC/E,CAAE,aAAAC,CAAa,EAAI,QAAQ,+BAA+B,EAE1DC,EAAK,IAAIJ,EAAS,CAAC,CAAC,EAGpBK,EAAiB,QAAQ,IAAI,oBAEnC,GAAI,CAACA,EACH,MAAM,IAAI,MAAM,kCAAkC,EAGpD,QAAQ,QAAU,MAAOC,GAAU,CACjC,QAAQ,IAAI,sBAAuB,KAAK,UAAUA,CAAK,CAAC,EAExD,GAAM,CAAE,WAAAC,EAAY,KAAAC,CAAK,EAAIF,EAGvBG,EAAWD,GAAQ,GACnBE,EAAiBD,EAAS,SAAS,UAAU,EAC7CE,EAAaF,EAAS,SAAS,MAAM,EAM3C,GAAIF,IAAe,QAAUG,EAAgB,CAC3C,IAAIE,EACJ,GAAI,CACFA,EAAO,KAAK,MAAMN,EAAM,MAAQ,IAAI,CACtC,OAASO,EAAG,CACV,eAAQ,MAAM,8CAA+CA,CAAC,EACvDC,EAAK,IAAK,CAAE,MAAO,mBAAoB,CAAC,CACjD,CAEA,GAAM,CAAE,IAAAC,EAAK,KAAAC,EAAM,YAAAC,CAAY,EAAIL,EAEnC,GAAI,CAACG,EACH,OAAOD,EAAK,IAAK,CAAE,MAAO,aAAc,CAAC,EAK3C,IAAMI,EAAU,GADDF,IAAS,SAAW,UAAY,EACtB,GAAG,OAAOD,CAAG,EAAE,QAAQ,OAAQ,EAAE,CAAC,GAErDI,EAAa,IAAIlB,EAAiB,CACtC,OAAQI,EACR,IAAKa,EACL,YAAaD,GAAe,2BAC5B,IAAK,SACP,CAAC,EAGKG,EAAM,MAAMjB,EAAaC,EAAIe,EAAY,CAAE,UAAW,GAAO,CAAC,EAEpE,eAAQ,IAAI,0BAA2B,CAAE,QAAAD,CAAQ,CAAC,EAE3CJ,EAAK,IAAK,CAAE,IAAAM,EAAK,IAAKF,CAAQ,CAAC,CACxC,CAOA,GAAIX,IAAe,QAAUI,EAAY,CACvC,IAAIC,EACJ,GAAI,CACFA,EAAO,KAAK,MAAMN,EAAM,MAAQ,IAAI,CACtC,OAASO,EAAG,CACV,eAAQ,MAAM,0CAA2CA,CAAC,EACnDC,EAAK,IAAK,CAAE,MAAO,mBAAoB,CAAC,CACjD,CAEA,GAAM,CAAE,IAAAC,CAAI,EAAIH,EAEhB,GAAI,CAACG,EACH,OAAOD,EAAK,IAAK,CAAE,MAAO,aAAc,CAAC,EAG3C,IAAMO,EAAW,OAAON,CAAG,EAAE,QAAQ,OAAQ,EAAE,EAEzCO,EAAa,IAAIpB,EAAiB,CACtC,OAAQG,EACR,IAAKgB,CACP,CAAC,EAGKD,EAAM,MAAMjB,EAAaC,EAAIkB,EAAY,CAAE,UAAW,GAAQ,CAAC,EAErE,eAAQ,IAAI,kCAAmC,CAAE,SAAAD,CAAS,CAAC,EAEpDP,EAAK,IAAK,CAAE,IAAAM,CAAI,CAAC,CAC1B,CAGA,OAAON,EAAK,IAAK,CAAE,MAAO,WAAY,CAAC,CACzC,EAEA,SAASA,EAAKS,EAAYX,EAAM,CAC9B,MAAO,CACL,WAAAW,EACA,QAAS,CACP,8BAA+B,IAC/B,mCAAoC,OACpC,+BAAgC,6BAChC,+BAAgC,cAClC,EACA,KAAM,KAAK,UAAUX,CAAI,CAC3B,CACF",
  "names": ["S3Client", "PutObjectCommand", "GetObjectCommand", "getSignedUrl", "s3", "UPLOADS_BUCKET", "event", "httpMethod", "path", "fullPath", "isPresignRoute", "isGetRoute", "body", "e", "json", "key", "kind", "contentType", "fullKey", "putCommand", "url", "cleanKey", "getCommand", "statusCode"]
}
