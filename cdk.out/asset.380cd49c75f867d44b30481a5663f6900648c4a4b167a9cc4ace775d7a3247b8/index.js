"use strict";var R=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var _=Object.prototype.hasOwnProperty;var F=(e,t)=>{for(var o in t)R(e,o,{get:t[o],enumerable:!0})},O=(e,t,o,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of V(t))!_.call(e,n)&&n!==o&&R(e,n,{get:()=>t[n],enumerable:!(s=P(t,n))||s.enumerable});return e};var D=e=>O(R({},"__esModule",{value:!0}),e);var ie={};F(ie,{handler:()=>oe});module.exports=D(ie);var a=require("@aws-sdk/client-dynamodb"),N=require("@aws-sdk/client-sfn"),i=require("@aws-sdk/util-dynamodb"),x=require("crypto"),d=process.env.TABLE_NAME,U=process.env.APPROVAL_SM_ARN,M=process.env.STATUS_GSI??"gsi1",c=new a.DynamoDBClient({}),W=new N.SFNClient({});function E(){return new Date().toISOString()}function I(e){return`USER#${e}`}function y(e){return`CLOSET#${e}`}function h(e){return`CLOSET#${e}`}function L(e){return`CLOSET#STATUS#${e}`}function H(e){if(typeof e=="string")return e.startsWith("CLOSET#")?e.slice(7)||void 0:e}function C(e){let t=(0,i.unmarshall)(e),o=t.id??H(t.sk)??(0,x.randomUUID)(),s=typeof t.pk=="string"&&t.pk.startsWith("USER#")?t.pk.slice(5):void 0,n=t.userId??t.ownerSub??s??"UNKNOWN",r=t.ownerSub??t.userId??s??"UNKNOWN",u=t.createdAt??t.updatedAt??new Date(0).toISOString(),m=t.updatedAt??u,l=t.status??"DRAFT";return{id:o,userId:n,ownerSub:r,status:l,createdAt:u,updatedAt:m,mediaKey:t.mediaKey,rawMediaKey:t.rawMediaKey,title:t.title,reason:t.reason,audience:t.audience,category:t.category,subcategory:t.subcategory,storyTitle:t.storyTitle,storySeason:t.storySeason,storyVibes:t.storyVibes,pinned:t.pinned,favoriteCount:t.favoriteCount,likeCount:t.likeCount,commentCount:t.commentCount,wishlistCount:t.wishlistCount,viewerHasFaved:t.viewerHasFaved,viewerHasLiked:t.viewerHasLiked,viewerHasWishlisted:t.viewerHasWishlisted}}function g(e){if(!e?.sub)throw new Error("Not authenticated");return e.sub}function v(e){let o=(e?.claims||{})["cognito:groups"],s=Array.isArray(o)?o:String(o||"").split(",").map(n=>n.trim()).filter(Boolean);return s.includes("ADMIN")||s.includes("COLLAB")}async function B(e){let t=g(e);return((await c.send(new a.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,i.marshall)({":pk":I(t),":sk":"CLOSET#"})}))).Items??[]).map(C).filter(s=>s.id&&s.id!=="undefined")}async function z(e,t){let o=g(t),s=(0,x.randomUUID)(),n=E(),r=e.input,u={id:s,userId:o,ownerSub:o,status:"DRAFT",createdAt:n,updatedAt:n,mediaKey:r.mediaKey??void 0,rawMediaKey:r.rawMediaKey??void 0,title:r.title??void 0,category:r.category??null,subcategory:r.subcategory??null,audience:r.audience??"PRIVATE"};return await c.send(new a.PutItemCommand({TableName:d,Item:(0,i.marshall)({pk:I(o),sk:y(s),gsi1pk:L(u.status),gsi1sk:n,rawMediaKey:u.rawMediaKey,...u})})),u}async function $(e,t){let o=g(t),s=E(),n=await c.send(new a.UpdateItemCommand({TableName:d,Key:(0,i.marshall)({pk:I(o),sk:y(e.closetItemId)}),UpdateExpression:"SET mediaKey = :mediaKey, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,i.marshall)({":mediaKey":e.mediaKey,":updatedAt":s,":gsi1pk":L("DRAFT"),":gsi1sk":s}),ReturnValues:"ALL_NEW"}));if(!n.Attributes)throw new Error("Item not found");return C(n.Attributes)}async function q(e,t){let o=g(t),s=E(),n=await c.send(new a.UpdateItemCommand({TableName:d,Key:(0,i.marshall)({pk:I(o),sk:y(e.closetItemId)}),ConditionExpression:"status = :draft",UpdateExpression:"SET status = :pending, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,i.marshall)({":draft":"DRAFT",":pending":"PENDING",":updatedAt":s,":gsi1pk":L("PENDING"),":gsi1sk":s}),ReturnValues:"ALL_NEW"}));if(!n.Attributes)throw new Error("Item not found or not in DRAFT status");let r=C(n.Attributes);return await W.send(new N.StartExecutionCommand({stateMachineArn:U,input:JSON.stringify({itemId:r.id,userId:r.userId,ownerSub:r.ownerSub})})),r}async function G(e,t){let o=g(t),{closetItemId:s,story:n}=e,r=E(),u=await c.send(new a.UpdateItemCommand({TableName:d,Key:(0,i.marshall)({pk:I(o),sk:y(s)}),UpdateExpression:"SET storyTitle = :storyTitle, updatedAt = :updatedAt",ExpressionAttributeValues:(0,i.marshall)({":storyTitle":n,":updatedAt":r}),ReturnValues:"ALL_NEW"}));if(!u.Attributes)throw new Error("Item not found");return C(u.Attributes)}async function S(e){let o=((await c.send(new a.ScanCommand({TableName:d,FilterExpression:"sk = :sk",ExpressionAttributeValues:(0,i.marshall)({":sk":y(e)})}))).Items??[])[0];if(!o)throw new Error("Closet item not found");let s=C(o),n=s.userId;if(!n)throw new Error("Closet item missing owner");return{base:s,ownerId:n}}async function J(e,t){let o=g(t),{closetItemId:s}=e,n=E(),{ownerId:r}=await S(s),u={pk:h(s),sk:`LIKE#${o}`,entityType:"LIKE",itemOwnerSub:r,likerSub:o,createdAt:n};try{await c.send(new a.PutItemCommand({TableName:d,Item:(0,i.marshall)(u),ConditionExpression:"attribute_not_exists(sk)"}))}catch(w){if(w?.name!=="ConditionalCheckFailedException")throw w}let m=await c.send(new a.UpdateItemCommand({TableName:d,Key:(0,i.marshall)({pk:I(r),sk:y(s)}),UpdateExpression:"SET likeCount = if_not_exists(likeCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,i.marshall)({":zero":0,":one":1,":now":n}),ReturnValues:"ALL_NEW"}));if(!m.Attributes)throw new Error("Closet item not found");let l=C(m.Attributes);return l.viewerHasLiked=!0,l}async function Q(e,t){let o=g(t),{closetItemId:s,text:n}=e,r=E(),u=(0,x.randomUUID)(),{ownerId:m}=await S(s),l={pk:h(s),sk:`COMMENT#${u}`,entityType:"COMMENT",closetItemId:s,itemOwnerSub:m,authorSub:o,text:n,createdAt:r};return await c.send(new a.PutItemCommand({TableName:d,Item:(0,i.marshall)(l)})),await c.send(new a.UpdateItemCommand({TableName:d,Key:(0,i.marshall)({pk:I(m),sk:y(s)}),UpdateExpression:"SET commentCount = if_not_exists(commentCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,i.marshall)({":zero":0,":one":1,":now":r})})),{id:u,closetItemId:s,authorSub:o,text:n,createdAt:r}}async function X(e,t){let o=g(t),s=v(t),n=e.closetItemId,r=!!e.pinned;if(!n)throw new Error("closetItemId is required");let{base:u}=await S(n);if(!s&&u.userId!==o)throw new Error("Not authorized to pin this closet item.");let m=E(),l=await c.send(new a.UpdateItemCommand({TableName:d,Key:(0,i.marshall)({pk:I(u.userId),sk:y(u.id)}),UpdateExpression:"SET pinned = :pinned, updatedAt = :now",ExpressionAttributeValues:(0,i.marshall)({":pinned":r,":now":m}),ReturnValues:"ALL_NEW"}));if(!l.Attributes)throw new Error("Closet item not found after update");return C(l.Attributes)}async function K(e){let{closetItemId:t}=e;return((await c.send(new a.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,i.marshall)({":pk":h(t),":sk":"COMMENT#"})}))).Items??[]).map(n=>(0,i.unmarshall)(n)).map(n=>({id:n.sk.replace("COMMENT#",""),closetItemId:n.closetItemId,authorSub:n.authorSub,text:n.text,createdAt:n.createdAt}))}async function Y(e){let{closetItemId:t}=e;return((await c.send(new a.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,i.marshall)({":pk":h(t),":sk":"LIKE#"})}))).Items??[]).map(n=>(0,i.unmarshall)(n)).map(n=>({closetItemId:t,likerSub:n.likerSub,createdAt:n.createdAt}))}async function j(e){return K(e)}async function Z(e,t){let o=g(t),{closetItemId:s,on:n}=e,r=E(),{ownerId:u}=await S(s),m=I(o),l=`WISHLIST#${s}`;if(n===!1){await c.send(new a.DeleteItemCommand({TableName:d,Key:(0,i.marshall)({pk:m,sk:l})}));let p;try{let f=await c.send(new a.UpdateItemCommand({TableName:d,Key:(0,i.marshall)({pk:I(u),sk:y(s)}),UpdateExpression:"SET wishlistCount = if_not_exists(wishlistCount, :zero) - :one, updatedAt = :now",ConditionExpression:"wishlistCount >= :one",ExpressionAttributeValues:(0,i.marshall)({":zero":0,":one":1,":now":r}),ReturnValues:"ALL_NEW"}));f.Attributes&&(p=C(f.Attributes))}catch(f){if(f?.name!=="ConditionalCheckFailedException")throw f;let A=((await c.send(new a.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND sk = :sk",ExpressionAttributeValues:(0,i.marshall)({":pk":I(u),":sk":y(s)})}))).Items??[])[0];A&&(p=C(A))}if(!p)throw new Error("Closet item not found");return p.viewerHasWishlisted=!1,p}let w={pk:m,sk:l,entityType:"WISHLIST",closetItemId:s,ownerSub:u,viewerSub:o,createdAt:r};try{await c.send(new a.PutItemCommand({TableName:d,Item:(0,i.marshall)(w),ConditionExpression:"attribute_not_exists(sk)"}))}catch(p){if(p?.name!=="ConditionalCheckFailedException")throw p}let k=await c.send(new a.UpdateItemCommand({TableName:d,Key:(0,i.marshall)({pk:I(u),sk:y(s)}),UpdateExpression:"SET wishlistCount = if_not_exists(wishlistCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,i.marshall)({":zero":0,":one":1,":now":r}),ReturnValues:"ALL_NEW"}));if(!k.Attributes)throw new Error("Closet item not found");let b=C(k.Attributes);return b.viewerHasWishlisted=!0,b}async function ee(e){let t=g(e),s=((await c.send(new a.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,i.marshall)({":pk":I(t),":sk":"WISHLIST#"})}))).Items??[]).map(l=>(0,i.unmarshall)(l));if(!s.length)return[];let n=s.map(l=>({pk:I(l.ownerSub),sk:y(l.closetItemId)})),m=((await c.send(new a.BatchGetItemCommand({RequestItems:{[d]:{Keys:n.map(l=>(0,i.marshall)(l))}}}))).Responses?.[d]??[]).map(C);for(let l of m)l.viewerHasWishlisted=!0;return m}async function te(e){let t=e.source||{},o=e.identity||{},s=t.userId||t.id||o.sub;if(!s)throw new Error("Cannot resolve pinnedClosetItems: missing userId");return((await c.send(new a.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",FilterExpression:"#pinned = :true AND #status = :published",ExpressionAttributeNames:{"#pinned":"pinned","#status":"status"},ExpressionAttributeValues:(0,i.marshall)({":pk":I(s),":sk":"CLOSET#",":true":!0,":published":"PUBLISHED"})}))).Items??[]).map(C)}async function se(e){let t=e?.arguments||{},o=t.sort||"NEWEST",s=t.limit&&t.limit>0&&t.limit<=50?t.limit:24,n=["APPROVED","PUBLISHED"],r=[];for(let w of n){let b=((await c.send(new a.QueryCommand({TableName:d,IndexName:M,KeyConditionExpression:"gsi1pk = :pk",ExpressionAttributeValues:(0,i.marshall)({":pk":L(w)}),ScanIndexForward:!1,Limit:s*2}))).Items??[]).map(C);r.push(...b)}let u=r.filter(w=>{let k=w.status==="APPROVED"||w.status==="PUBLISHED",p=(w.audience??"PUBLIC")==="PUBLIC";return k&&p}),m=new Map;for(let w of u)m.has(w.id)||m.set(w.id,w);let l=Array.from(m.values());return l.sort((w,k)=>{let b=w.createdAt||"",p=k.createdAt||"";if(o==="MOST_LOVED"){let f=w.favoriteCount??0,T=k.favoriteCount??0;return T!==f?T-f:p.localeCompare(b)}return p.localeCompare(b)}),l.slice(0,s)}async function ne(e,t){let o=g(t),{id:s,favoriteOn:n}=e,r=E(),{ownerId:u}=await S(s),m=h(s),l=`FAVORITE#${o}`;if(n===!1){await c.send(new a.DeleteItemCommand({TableName:d,Key:(0,i.marshall)({pk:m,sk:l})}));let p;try{let f=await c.send(new a.UpdateItemCommand({TableName:d,Key:(0,i.marshall)({pk:I(u),sk:y(s)}),UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) - :one, updatedAt = :now",ConditionExpression:"favoriteCount >= :one",ExpressionAttributeValues:(0,i.marshall)({":zero":0,":one":1,":now":r}),ReturnValues:"ALL_NEW"}));f.Attributes&&(p=C(f.Attributes))}catch(f){if(f?.name!=="ConditionalCheckFailedException")throw f;let A=((await c.send(new a.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND sk = :sk",ExpressionAttributeValues:(0,i.marshall)({":pk":I(u),":sk":y(s)})}))).Items??[])[0];A&&(p=C(A))}if(!p)throw new Error("Closet item not found");return p.viewerHasFaved=!1,p}let w={pk:m,sk:l,entityType:"FAVORITE",closetItemId:s,ownerSub:u,viewerSub:o,createdAt:r};try{await c.send(new a.PutItemCommand({TableName:d,Item:(0,i.marshall)(w),ConditionExpression:"attribute_not_exists(sk)"}))}catch(p){if(p?.name!=="ConditionalCheckFailedException")throw p}let k=await c.send(new a.UpdateItemCommand({TableName:d,Key:(0,i.marshall)({pk:I(u),sk:y(s)}),UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,i.marshall)({":zero":0,":one":1,":now":r}),ReturnValues:"ALL_NEW"}));if(!k.Attributes)throw new Error("Closet item not found");let b=C(k.Attributes);return b.viewerHasFaved=!0,b}var oe=async e=>{console.log("ClosetResolverFn event",JSON.stringify(e));let t=e.info?.fieldName;try{switch(t){case"myCloset":return await B(e.identity);case"myWishlist":return await ee(e.identity);case"createClosetItem":return await z(e.arguments,e.identity);case"updateClosetMediaKey":return await $(e.arguments,e.identity);case"requestClosetApproval":return await q(e.arguments,e.identity);case"updateClosetItemStory":return await G(e.arguments,e.identity);case"likeClosetItem":return await J(e.arguments,e.identity);case"commentOnClosetItem":return await Q(e.arguments,e.identity);case"pinHighlight":return await X(e.arguments,e.identity);case"closetItemComments":return await K(e.arguments);case"adminClosetItemLikes":return await Y(e.arguments);case"adminClosetItemComments":return await j(e.arguments);case"toggleWishlistItem":return await Z(e.arguments,e.identity);case"pinnedClosetItems":return await te(e);case"closetFeed":return await se(e);case"toggleFavoriteClosetItem":return await ne(e.arguments,e.identity);default:throw new Error(`Unsupported field: ${t}`)}}catch(o){throw console.error("Error in ClosetResolverFn",o),o}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
