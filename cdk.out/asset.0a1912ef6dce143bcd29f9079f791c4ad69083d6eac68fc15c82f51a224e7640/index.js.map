{
  "version": 3,
  "sources": ["../../lambda/list/index.ts"],
  "sourcesContent": ["// lambda/list/index.ts\r\nimport type {\r\n  APIGatewayProxyEventV2,\r\n  APIGatewayProxyResultV2,\r\n} from \"aws-lambda\";\r\nimport { S3Client, ListObjectsV2Command } from \"@aws-sdk/client-s3\";\r\n\r\n/** S3 client (region from env; default us-east-1). */\r\nconst s3 = new S3Client({\r\n  region:\r\n    process.env.AWS_REGION || process.env.AWS_DEFAULT_REGION || \"us-east-1\",\r\n});\r\n\r\nconst BUCKET = process.env.BUCKET as string | undefined;\r\n\r\n/** Comma-separated allow-list, e.g.\r\n *  \"https://d1682i07dc1r3k.cloudfront.net,https://stylingadventures.com\"\r\n */\r\nconst ALLOWED_ORIGINS: string[] = String(process.env.ALLOWED_ORIGINS || \"\")\r\n  .split(\",\")\r\n  .map((s) => s.trim())\r\n  .filter(Boolean);\r\n\r\n/* ----------------------- helpers ----------------------- */\r\nfunction getMethod(e: APIGatewayProxyEventV2): string {\r\n  // Works for REST v1 + HTTP API v2\r\n  return e.requestContext?.http?.method || (e as any).httpMethod || \"GET\";\r\n}\r\n\r\nfunction pickAllowedOrigin(event: APIGatewayProxyEventV2): string | undefined {\r\n  const o =\r\n    (event.headers?.origin as string | undefined) ||\r\n    (event.headers?.Origin as string | undefined) ||\r\n    \"\";\r\n  return ALLOWED_ORIGINS.includes(o || \"\") ? o : undefined;\r\n}\r\n\r\nfunction baseCorsHeaders(origin?: string): Record<string, string> {\r\n  const h: Record<string, string> = {\r\n    // include lowercase 'authorization' because some browsers preflight with it\r\n    \"Access-Control-Allow-Headers\":\r\n      \"authorization,Authorization,Content-Type,X-Amz-Date,X-Api-Key,X-Amz-Security-Token\",\r\n    \"Access-Control-Allow-Methods\": \"GET,OPTIONS\",\r\n    \"Access-Control-Allow-Credentials\": \"true\",\r\n    \"Content-Type\": \"application/json\",\r\n    Vary: \"Origin\",\r\n  };\r\n  if (origin) h[\"Access-Control-Allow-Origin\"] = origin; // bracket syntax for hyphenated key\r\n  return h;\r\n}\r\n\r\nfunction sanitizePrefix(raw: string | undefined): string {\r\n  let s = String(raw || \"\").trim();\r\n  if (s.includes(\"..\")) s = \"\";\r\n  s = s.replace(/^\\/+/, \"\").replace(/[^A-Za-z0-9_\\-\\/.]/g, \"\");\r\n  return s;\r\n}\r\n\r\n/* ----------------------- handler ----------------------- */\r\nexport const handler = async (\r\n  event: APIGatewayProxyEventV2\r\n): Promise<APIGatewayProxyResultV2> => {\r\n  const origin = pickAllowedOrigin(event);\r\n\r\n  // CORS preflight\r\n  if (getMethod(event) === \"OPTIONS\") {\r\n    if ((event.headers?.origin || event.headers?.Origin) && !origin) {\r\n      return { statusCode: 403, headers: baseCorsHeaders(undefined), body: \"\" };\r\n    }\r\n    return { statusCode: 204, headers: baseCorsHeaders(origin), body: \"\" };\r\n  }\r\n\r\n  try {\r\n    if (!BUCKET) throw new Error(\"Missing BUCKET env var\");\r\n\r\n    const qs = event.queryStringParameters ?? {};\r\n    const prefix = sanitizePrefix(qs.prefix);\r\n    const token =\r\n      qs.token || qs.continuationToken || qs.nextToken || undefined;\r\n\r\n    const res = await s3.send(\r\n      new ListObjectsV2Command({\r\n        Bucket: BUCKET,\r\n        Prefix: prefix || undefined,\r\n        ContinuationToken: token || undefined,\r\n        MaxKeys: 1000,\r\n      })\r\n    );\r\n\r\n    const items =\r\n      (res.Contents || []).map((o) => ({\r\n        key: o.Key ?? \"\",\r\n        size: o.Size ?? 0,\r\n        lastModified: o.LastModified\r\n          ? new Date(o.LastModified as unknown as string).toISOString()\r\n          : null,\r\n      })) ?? [];\r\n\r\n    return {\r\n      statusCode: 200,\r\n      headers: baseCorsHeaders(origin),\r\n      body: JSON.stringify({\r\n        prefix,\r\n        items,\r\n        isTruncated: !!res.IsTruncated,\r\n        nextToken: res.IsTruncated ? res.NextContinuationToken ?? null : null,\r\n      }),\r\n    };\r\n  } catch (err: unknown) {\r\n    const message =\r\n      (err as { message?: string })?.message ?? String(err ?? \"Error\");\r\n    console.error(err);\r\n    return {\r\n      statusCode: 500,\r\n      headers: baseCorsHeaders(origin),\r\n      body: JSON.stringify({ error: message }),\r\n    };\r\n  }\r\n};\r\n\r\n\r\n\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAKA,IAAAI,EAA+C,8BAGzCC,EAAK,IAAI,WAAS,CACtB,OACE,QAAQ,IAAI,YAAc,QAAQ,IAAI,oBAAsB,WAChE,CAAC,EAEKC,EAAS,QAAQ,IAAI,OAKrBC,EAA4B,OAAO,QAAQ,IAAI,iBAAmB,EAAE,EACvE,MAAM,GAAG,EACT,IAAKC,GAAMA,EAAE,KAAK,CAAC,EACnB,OAAO,OAAO,EAGjB,SAASC,EAAU,EAAmC,CAEpD,OAAO,EAAE,gBAAgB,MAAM,QAAW,EAAU,YAAc,KACpE,CAEA,SAASC,EAAkBC,EAAmD,CAC5E,IAAMC,EACHD,EAAM,SAAS,QACfA,EAAM,SAAS,QAChB,GACF,OAAOJ,EAAgB,SAASK,GAAK,EAAE,EAAIA,EAAI,MACjD,CAEA,SAASC,EAAgBC,EAAyC,CAChE,IAAMC,EAA4B,CAEhC,+BACE,qFACF,+BAAgC,cAChC,mCAAoC,OACpC,eAAgB,mBAChB,KAAM,QACR,EACA,OAAID,IAAQC,EAAE,6BAA6B,EAAID,GACxCC,CACT,CAEA,SAASC,EAAeC,EAAiC,CACvD,IAAIT,EAAI,OAAOS,GAAO,EAAE,EAAE,KAAK,EAC/B,OAAIT,EAAE,SAAS,IAAI,IAAGA,EAAI,IAC1BA,EAAIA,EAAE,QAAQ,OAAQ,EAAE,EAAE,QAAQ,sBAAuB,EAAE,EACpDA,CACT,CAGO,IAAMN,EAAU,MACrBS,GACqC,CACrC,IAAMG,EAASJ,EAAkBC,CAAK,EAGtC,GAAIF,EAAUE,CAAK,IAAM,UACvB,OAAKA,EAAM,SAAS,QAAUA,EAAM,SAAS,SAAW,CAACG,EAChD,CAAE,WAAY,IAAK,QAASD,EAAgB,MAAS,EAAG,KAAM,EAAG,EAEnE,CAAE,WAAY,IAAK,QAASA,EAAgBC,CAAM,EAAG,KAAM,EAAG,EAGvE,GAAI,CACF,GAAI,CAACR,EAAQ,MAAM,IAAI,MAAM,wBAAwB,EAErD,IAAMY,EAAKP,EAAM,uBAAyB,CAAC,EACrCQ,EAASH,EAAeE,EAAG,MAAM,EACjCE,EACJF,EAAG,OAASA,EAAG,mBAAqBA,EAAG,WAAa,OAEhDG,EAAM,MAAMhB,EAAG,KACnB,IAAI,uBAAqB,CACvB,OAAQC,EACR,OAAQa,GAAU,OAClB,kBAAmBC,GAAS,OAC5B,QAAS,GACX,CAAC,CACH,EAEME,GACHD,EAAI,UAAY,CAAC,GAAG,IAAK,IAAO,CAC/B,IAAK,EAAE,KAAO,GACd,KAAM,EAAE,MAAQ,EAChB,aAAc,EAAE,aACZ,IAAI,KAAK,EAAE,YAAiC,EAAE,YAAY,EAC1D,IACN,EAAE,GAAK,CAAC,EAEV,MAAO,CACL,WAAY,IACZ,QAASR,EAAgBC,CAAM,EAC/B,KAAM,KAAK,UAAU,CACnB,OAAAK,EACA,MAAAG,EACA,YAAa,CAAC,CAACD,EAAI,YACnB,UAAWA,EAAI,YAAcA,EAAI,uBAAyB,KAAO,IACnE,CAAC,CACH,CACF,OAASE,EAAc,CACrB,IAAMC,EACHD,GAA8B,SAAW,OAAOA,GAAO,OAAO,EACjE,eAAQ,MAAMA,CAAG,EACV,CACL,WAAY,IACZ,QAASV,EAAgBC,CAAM,EAC/B,KAAM,KAAK,UAAU,CAAE,MAAOU,CAAQ,CAAC,CACzC,CACF,CACF",
  "names": ["list_exports", "__export", "handler", "__toCommonJS", "import_client_s3", "s3", "BUCKET", "ALLOWED_ORIGINS", "s", "getMethod", "pickAllowedOrigin", "event", "o", "baseCorsHeaders", "origin", "h", "sanitizePrefix", "raw", "qs", "prefix", "token", "res", "items", "err", "message"]
}
