"use strict";var I=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var T=(e,n)=>{for(var t in n)I(e,t,{get:n[t],enumerable:!0})},O=(e,n,t,c)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of _(n))!L.call(e,s)&&s!==t&&I(e,s,{get:()=>n[s],enumerable:!(c=P(n,s))||c.enumerable});return e};var U=e=>O(I({},"__esModule",{value:!0}),e);var B={};T(B,{handler:()=>K});module.exports=U(B);var S=require("@aws-sdk/client-dynamodb"),o=require("@aws-sdk/lib-dynamodb");var a=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!a)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var p=o.DynamoDBDocumentClient.from(new S.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}});function N(e){return`EPISODE#${e}`}var h="META";function E(e){return`USER#${e}`}var D="PROFILE";function b(e){return`EP_UNLOCK#${e}`}function k(e){return e?{id:e.id||e.episodeId||(e.pk||"").replace("EPISODE#",""),title:e.title||"",season:e.season??null,episodeNumber:e.episodeNumber??null,showId:e.showId??null,shortDescription:e.shortDescription??"",fullDescription:e.fullDescription??"",status:e.status||"DRAFT",publicAt:e.publicAt||new Date().toISOString(),durationSeconds:e.durationSeconds??null,unlockCoinCost:e.unlockCoinCost??null,chatEnabled:e.chatEnabled??!0,thumbnails:Array.isArray(e.thumbnails)?e.thumbnails:[],outfitsLinkedCount:e.outfitsLinkedCount??0}:null}async function y(e){let n=await p.send(new o.GetCommand({TableName:a,Key:{pk:N(e),sk:h}}));if(!n.Item)throw new Error("Episode not found");return n.Item}async function C(e){let t=(await p.send(new o.GetCommand({TableName:a,Key:{pk:E(e),sk:D}}))).Item||{};return{userId:t.userId||e,coins:Number(t.coins??0),xp:Number(t.xp??0),level:Number(t.level??1),lastEventAt:t.lastEventAt??null}}function x(e,n){let t=e.status||"DRAFT",c=e.publicAt||new Date().toISOString(),s=new Date(c),d=t==="PUBLISHED"&&s.getTime()<=n.getTime();return{episodeId:e.id||e.episodeId||(e.pk||"").replace("EPISODE#",""),status:t,publicAt:c,isPublic:d}}var K=async e=>{let{fieldName:n}=e.info,t=e.identity,c=new Date;if(n==="isEpisodeEarlyAccess"){let{episodeId:s}=e.arguments||{};if(!s)throw new Error("episodeId is required");let d=await y(String(s));return x(d,c)}if(n==="unlockEpisode"){if(!t?.sub)throw new Error("Unauthorized");let s=t.sub,{episodeId:d}=e.arguments||{};if(!d)throw new Error("episodeId is required");let u=String(d),m=await y(u),i=k(m),r=Number(i.unlockCoinCost??0),l=c.toISOString(),f=await p.send(new o.GetCommand({TableName:a,Key:{pk:E(s),sk:b(u)}}));if(f.Item){let w=await C(s);return{success:!0,unlockedAt:f.Item.unlockedAt||l,costCoins:Number(f.Item.costCoins??0),episode:i,remainingCoins:w.coins}}let A;if(r>0){let w=await p.send(new o.UpdateCommand({TableName:a,Key:{pk:E(s),sk:D},UpdateExpression:"SET coins = if_not_exists(coins, :z) - :c, lastEventAt = :now",ConditionExpression:"if_not_exists(coins, :z) >= :c",ExpressionAttributeValues:{":z":0,":c":r,":now":l},ReturnValues:"ALL_NEW"})).catch(g=>{throw String(g).includes("ConditionalCheckFailed")?new Error("Not enough coins to unlock this episode."):g});A=Number(w.Attributes?.coins??0)}else A=(await C(s)).coins;return await p.send(new o.PutCommand({TableName:a,Item:{pk:E(s),sk:b(u),type:"EPISODE_UNLOCK",episodeId:u,costCoins:r,unlockedAt:l,source:"COIN_UNLOCK"},ConditionExpression:"attribute_not_exists(pk)"})),{success:!0,unlockedAt:l,costCoins:r,episode:i,remainingCoins:A}}if(n==="myUnlockedEpisodes"){if(!t?.sub)throw new Error("Unauthorized");let s=t.sub,u=(await p.send(new o.QueryCommand({TableName:a,KeyConditionExpression:"pk = :p AND begins_with(sk, :pref)",ExpressionAttributeValues:{":p":E(s),":pref":"EP_UNLOCK#"}}))).Items||[];if(!u.length)return[];let m=new Map;return await Promise.all(u.map(async i=>{let r=String(i.episodeId||String(i.sk).replace("EP_UNLOCK#",""));if(!m.has(r))try{let l=await p.send(new o.GetCommand({TableName:a,Key:{pk:N(r),sk:h}}));l.Item&&m.set(r,k(l.Item))}catch{}})),u.map(i=>{let r=String(i.episodeId||String(i.sk).replace("EP_UNLOCK#",""));return{episodeId:r,unlockedAt:i.unlockedAt||new Date().toISOString(),costCoins:Number(i.costCoins??0),source:i.source||null,episode:m.get(r)||null}})}throw new Error(`Unknown field ${n}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
