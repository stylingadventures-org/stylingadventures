"use strict";var R=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var _=Object.prototype.hasOwnProperty;var D=(e,t)=>{for(var r in t)R(e,r,{get:t[r],enumerable:!0})},F=(e,t,r,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let c of T(t))!_.call(e,c)&&c!==r&&R(e,c,{get:()=>t[c],enumerable:!(i=L(t,c))||i.enumerable});return e};var M=e=>F(R({},"__esModule",{value:!0}),e);var v={};D(v,{handler:()=>O});module.exports=M(v);var C=require("@aws-sdk/client-dynamodb"),d=require("@aws-sdk/lib-dynamodb"),S=process.env.TABLE_NAME,l=(process.env.PK_NAME||"id").trim()||"id",u=(process.env.SK_NAME||"").trim(),U=d.DynamoDBDocumentClient.from(new C.DynamoDBClient({})),y=()=>new Date().toISOString();function B(e){return u?{[l]:`USER#${e}`,[u]:"PROFILE"}:{[l]:e}}function K(e,t){let r={id:e,email:t.email??null,role:t.role,tier:t.tier??null,createdAt:t.createdAt,updatedAt:t.updatedAt};return u?(r[l]=`USER#${e}`,r[u]="PROFILE"):r[l]=e,r}function E(e,t){return{id:e,email:t?.email??null,role:t?.role||"FAN",tier:t?.tier??null,createdAt:t?.createdAt??y(),updatedAt:t?.updatedAt??y()}}async function I(e){return(await U.send(new d.GetCommand({TableName:S,Key:B(e)}))).Item||null}async function k(e,t,r=!1){let i=new d.PutCommand({TableName:S,Item:K(e,t),...r?u?{ConditionExpression:"attribute_not_exists(#pk) AND attribute_not_exists(#sk)",ExpressionAttributeNames:{"#pk":l,"#sk":u}}:{ConditionExpression:"attribute_not_exists(#pk)",ExpressionAttributeNames:{"#pk":l}}:void 0});return U.send(i)}var O=async e=>{let t=e.info.fieldName,r=e.identity,i=r?.sub,c=r?.claims?.email,w=r?.claims?.["cognito:groups"],x=Array.isArray(w)?w.includes("ADMIN"):`${w||""}`.includes("ADMIN");if(t==="me"){if(!i)throw new Error("Unauthenticated");let n=await I(i);if(n)return E(i,n);let s=y(),o={id:i,email:c?.toLowerCase?.()??null,role:"FAN",tier:"FREE",createdAt:s,updatedAt:s};try{await k(i,o,!0)}catch{}let a=await I(i);return a?E(i,a):o}if(t==="setUserRole"){if(!i)throw new Error("Unauthenticated");let n=e.arguments?.input;if(!n?.userId||!n?.role)throw new Error("userId and role are required");let s=n.userId;if(!x&&s!==i)throw new Error("Not authorized to modify other users");let o=await I(s),a=y(),m=o?{...E(s,o),email:(n.email??o.email??null)?.toLowerCase?.()??null,role:n.role,tier:n.tier??o.tier??null,updatedAt:a}:{id:s,email:(n.email??null)?.toLowerCase?.()??null,role:n.role,tier:n.tier??"FREE",createdAt:a,updatedAt:a};return await k(s,m,!1),m}if(t==="adminListUsers"){if(!x)throw new Error("Not authorized");let n=e.arguments||{},s=Math.min(Math.max(n.limit??25,1),100),o=n.nextToken?JSON.parse(Buffer.from(n.nextToken,"base64").toString("utf8")):void 0,a=(n.search||"").trim().toLowerCase(),m={TableName:S,Limit:s,ExclusiveStartKey:o},f={},A={},g=[];u&&(f["#pk"]=l,f["#sk"]=u,A[":u"]="USER#",A[":p"]="PROFILE",g.push("begins_with(#pk, :u) AND #sk = :p")),a&&(f["#email"]="email",A[":q"]=a,g.push("contains(#email, :q)")),g.length&&(m.FilterExpression=g.join(" AND "),m.ExpressionAttributeNames=f,m.ExpressionAttributeValues=A);let N=await U.send(new d.ScanCommand(m));return{items:(N.Items||[]).map(p=>{let h=p?.id;if(!h&&u&&typeof p?.[l]=="string"){let b=String(p[l]).match(/^USER#(.+)$/);b&&(h=b[1])}return E(h||p?.id,p)}),nextToken:N.LastEvaluatedKey?Buffer.from(JSON.stringify(N.LastEvaluatedKey)).toString("base64"):null}}throw new Error(`Unhandled field: ${t}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
