{
  "version": 3,
  "sources": ["../../lambda/closet/publish.ts"],
  "sourcesContent": ["import { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  UpdateCommand,\r\n  GetCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\nimport { EventBridgeClient, PutEventsCommand } from \"@aws-sdk/client-eventbridge\";\r\n\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}), {\r\n  marshallOptions: { removeUndefinedValues: true },\r\n});\r\nconst eb = new EventBridgeClient({});\r\n\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\nconst PK_NAME = process.env.PK_NAME || \"pk\";\r\nconst SK_NAME = process.env.SK_NAME || \"sk\";\r\n\r\nfunction isConditionalCheckFailed(err: any) {\r\n  return err?.name === \"ConditionalCheckFailedException\";\r\n}\r\n\r\nasync function emit(detailType: string, detail: any) {\r\n  try {\r\n    await eb.send(\r\n      new PutEventsCommand({\r\n        Entries: [\r\n          {\r\n            Source: \"stylingadventures.closet\",\r\n            DetailType: detailType,\r\n            Detail: JSON.stringify(detail),\r\n          },\r\n        ],\r\n      }),\r\n    );\r\n  } catch (e) {\r\n    console.warn(\"[publish] EventBridge put failed:\", e);\r\n  }\r\n}\r\n\r\nfunction extractApprovalId(event: any): string | undefined {\r\n  // common shapes\r\n  const direct =\r\n    event?.approvalId ||\r\n    event?.itemId ||\r\n    event?.closetItemId ||\r\n    event?.admin?.approvalId ||\r\n    event?.admin?.Payload?.approvalId ||\r\n    event?.item?.id;\r\n\r\n  if (typeof direct === \"string\" && direct.length > 0) return direct;\r\n\r\n  // Sometimes someone accidentally passes DynamoDB AttributeValue shape\r\n  const ddbShape = event?.item?.id?.S;\r\n  if (typeof ddbShape === \"string\" && ddbShape.length > 0) return ddbShape;\r\n\r\n  // As a last resort, if pk exists: ITEM#<id>\r\n  const pk = event?.item?.pk || event?.pk;\r\n  if (typeof pk === \"string\" && pk.startsWith(\"ITEM#\")) {\r\n    return pk.slice(\"ITEM#\".length);\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\nexport const handler = async (event: any) => {\r\n  console.log(\"[publish] incoming event:\", JSON.stringify(event));\r\n\r\n  const approvalId = extractApprovalId(event);\r\n  if (!approvalId) {\r\n    console.warn(\"[publish] missing approvalId; no-op publish\");\r\n    return { ok: false, status: \"NO_ID\" };\r\n  }\r\n\r\n  const pk = `ITEM#${approvalId}`;\r\n  const sk = \"META\";\r\n  const now = new Date().toISOString();\r\n\r\n  const mediaKey =\r\n    event?.segmentation?.outputKey ||\r\n    event?.segmentation?.Payload?.outputKey ||\r\n    event?.processedImageKey ||\r\n    event?.item?.s3Key ||\r\n    null;\r\n\r\n  // Deterministic behavior:\r\n  // - if already published => return ALREADY_PUBLISHED\r\n  // - if not approved => return NOT_APPROVED\r\n  const current = await ddb.send(\r\n    new GetCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: { [PK_NAME]: pk, [SK_NAME]: sk },\r\n      ConsistentRead: true,\r\n    }),\r\n  );\r\n\r\n  const status = current.Item?.status as string | undefined;\r\n\r\n  if (status === \"PUBLISHED\") {\r\n    return { ok: true, approvalId, status: \"ALREADY_PUBLISHED\", mediaKey };\r\n  }\r\n  if (status !== \"APPROVED\") {\r\n    console.warn(\"[publish] not approved yet; skipping publish\", { approvalId, status });\r\n    return { ok: false, approvalId, status: \"NOT_APPROVED\", currentStatus: status ?? \"MISSING\" };\r\n  }\r\n\r\n  // Idempotent transition APPROVED -> PUBLISHED\r\n  try {\r\n    await ddb.send(\r\n      new UpdateCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: { [PK_NAME]: pk, [SK_NAME]: sk },\r\n        ConditionExpression: \"#status = :approved\",\r\n        UpdateExpression: `\r\n          SET #status = :published,\r\n              updatedAt = :t,\r\n              publishedAt = :t,\r\n              mediaKey = :m\r\n        `,\r\n        ExpressionAttributeNames: { \"#status\": \"status\" },\r\n        ExpressionAttributeValues: {\r\n          \":approved\": \"APPROVED\",\r\n          \":published\": \"PUBLISHED\",\r\n          \":t\": now,\r\n          \":m\": mediaKey,\r\n        },\r\n      }),\r\n    );\r\n  } catch (err: any) {\r\n    if (isConditionalCheckFailed(err)) {\r\n      // Someone else published first; treat as success\r\n      return { ok: true, approvalId, status: \"ALREADY_PUBLISHED\", mediaKey };\r\n    }\r\n    console.error(\"[publish] Update failed\", err);\r\n    throw err;\r\n  }\r\n\r\n  await emit(\"ClosetItemPublished\", {\r\n    approvalId,\r\n    publishedAt: now,\r\n    mediaKey,\r\n  });\r\n\r\n  return { ok: true, approvalId, status: \"PUBLISHED\", mediaKey };\r\n};\r\n"],
  "mappings": "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",
  "names": ["publish_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "import_client_eventbridge", "ddb", "eb", "TABLE_NAME", "PK_NAME", "SK_NAME", "isConditionalCheckFailed", "err", "emit", "detailType", "detail", "e", "extractApprovalId", "event", "direct", "ddbShape", "pk", "approvalId", "sk", "now", "mediaKey", "status"]
}
