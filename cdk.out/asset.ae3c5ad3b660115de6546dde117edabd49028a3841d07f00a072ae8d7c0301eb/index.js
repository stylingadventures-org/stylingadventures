"use strict";var d=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var g=(t,e)=>{for(var n in e)d(t,n,{get:e[n],enumerable:!0})},A=(t,e,n,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of h(e))!I.call(t,o)&&o!==n&&d(t,o,{get:()=>e[o],enumerable:!(s=f(e,o))||s.enumerable});return t};var b=t=>A(d({},"__esModule",{value:!0}),t);var N={};g(N,{handler:()=>w});module.exports=b(N);var y=require("@aws-sdk/client-dynamodb"),i=require("@aws-sdk/lib-dynamodb"),p=require("@aws-sdk/client-eventbridge"),l=i.DynamoDBDocumentClient.from(new y.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),D=new p.EventBridgeClient({}),c=process.env.TABLE_NAME,m=process.env.PK_NAME||"pk",E=process.env.SK_NAME||"sk";function S(t){return t?.name==="ConditionalCheckFailedException"}async function P(t,e){try{await D.send(new p.PutEventsCommand({Entries:[{Source:"stylingadventures.closet",DetailType:t,Detail:JSON.stringify(e)}]}))}catch(n){console.warn("[publish] EventBridge put failed:",n)}}function k(t){let e=t?.approvalId||t?.itemId||t?.closetItemId||t?.admin?.approvalId||t?.admin?.Payload?.approvalId||t?.item?.id;if(typeof e=="string"&&e.length>0)return e;let n=t?.item?.id?.S;if(typeof n=="string"&&n.length>0)return n;let s=t?.item?.pk||t?.pk;if(typeof s=="string"&&s.startsWith("ITEM#"))return s.slice(5)}var w=async t=>{console.log("[publish] incoming event:",JSON.stringify(t));let e=k(t);if(!e)return console.warn("[publish] missing approvalId; no-op publish"),{ok:!1,status:"NO_ID"};let n=`ITEM#${e}`,s="META",o=new Date().toISOString(),a=t?.segmentation?.outputKey||t?.segmentation?.Payload?.outputKey||t?.processedImageKey||t?.item?.s3Key||null,r=(await l.send(new i.GetCommand({TableName:c,Key:{[m]:n,[E]:s},ConsistentRead:!0}))).Item?.status;if(r==="PUBLISHED")return{ok:!0,approvalId:e,status:"ALREADY_PUBLISHED",mediaKey:a};if(r!=="APPROVED")return console.warn("[publish] not approved yet; skipping publish",{approvalId:e,status:r}),{ok:!1,approvalId:e,status:"NOT_APPROVED",currentStatus:r??"MISSING"};try{await l.send(new i.UpdateCommand({TableName:c,Key:{[m]:n,[E]:s},ConditionExpression:"#status = :approved",UpdateExpression:`
          SET #status = :published,
              updatedAt = :t,
              publishedAt = :t,
              mediaKey = :m
        `,ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":approved":"APPROVED",":published":"PUBLISHED",":t":o,":m":a}}))}catch(u){if(S(u))return{ok:!0,approvalId:e,status:"ALREADY_PUBLISHED",mediaKey:a};throw console.error("[publish] Update failed",u),u}return await P("ClosetItemPublished",{approvalId:e,publishedAt:o,mediaKey:a}),{ok:!0,approvalId:e,status:"PUBLISHED",mediaKey:a}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
