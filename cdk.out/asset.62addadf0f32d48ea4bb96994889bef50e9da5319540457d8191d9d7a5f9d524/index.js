"use strict";var c=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var g=Object.getOwnPropertyNames;var y=Object.prototype.hasOwnProperty;var N=(t,e)=>{for(var s in e)c(t,s,{get:e[s],enumerable:!0})},P=(t,e,s,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of g(e))!y.call(t,n)&&n!==s&&c(t,n,{get:()=>e[n],enumerable:!(r=I(e,n))||r.enumerable});return t};var k=t=>P(c({},"__esModule",{value:!0}),t);var v={};N(v,{handler:()=>B});module.exports=k(v);var o=require("@aws-sdk/client-dynamodb"),C=require("@aws-sdk/util-dynamodb"),u=new o.DynamoDBClient({}),d=process.env.TABLE_NAME;function p(t){let e=(0,C.unmarshall)(t);return{id:String(e.id),userId:String(e.userId??e.ownerSub??""),ownerSub:String(e.ownerSub??e.userId??""),status:e.status??"PENDING",createdAt:String(e.createdAt),updatedAt:String(e.updatedAt??e.createdAt),mediaKey:e.mediaKey??null,title:e.title??null,reason:e.reason??null,audience:e.audience??"PUBLIC",favoriteCount:Number(e.favoriteCount??0)}}async function f(t){let e=await u.send(new o.ScanCommand({TableName:d,FilterExpression:"#id = :id",ExpressionAttributeNames:{"#id":"id"},ExpressionAttributeValues:{":id":{S:t}},Limit:1}));return!e.Items||e.Items.length===0?null:e.Items[0]}function E(t){if(t.pk?.S&&t.sk?.S)return{pk:t.pk.S,sk:t.sk.S};throw new Error("Could not infer pk/sk for closet item")}async function S(t){return((await u.send(new o.QueryCommand({TableName:d,IndexName:"gsi1",KeyConditionExpression:"#pk = :pk",ExpressionAttributeNames:{"#pk":"gsi1pk","#status":"status"},ExpressionAttributeValues:{":pk":{S:"CLOSET"},":pending":{S:"PENDING"},":approved":{S:"APPROVED"},":published":{S:"PUBLISHED"}},FilterExpression:t.length===3?"#status = :pending OR #status = :approved OR #status = :published":t.length===2?"#status = :approved OR #status = :published":"#status = :approved",ScanIndexForward:!1}))).Items||[]).map(p)}function D(t){if(!t)return 0;try{let e=JSON.parse(Buffer.from(t,"base64").toString("utf8"));return Number(e.offset??0)||0}catch{return 0}}function T(t){return Buffer.from(JSON.stringify({offset:t}),"utf8").toString("base64")}async function O(){return S(["PENDING","APPROVED","PUBLISHED"])}async function L(t){let e=typeof t?.limit=="number"&&t.limit>0?t.limit:20,s=t?.sort??"NEWEST",r=D(t?.nextToken),n=await S(["APPROVED","PUBLISHED"]);s==="MOST_LOVED"?n=n.slice().sort((l,m)=>{let A=l.favoriteCount??0,w=m.favoriteCount??0;return w!==A?w-A:m.createdAt.localeCompare(l.createdAt)}):n=n.slice().sort((l,m)=>m.createdAt.localeCompare(l.createdAt));let i=n.slice(r,r+e),a=r+i.length,b=a<n.length?T(a):null;return{items:i,nextToken:b}}async function h(t){let e=typeof t?.limit=="number"&&t.limit>0?t.limit:3;return(await S(["APPROVED","PUBLISHED"])).slice().sort((r,n)=>{let i=r.favoriteCount??0,a=n.favoriteCount??0;return a!==i?a-i:n.createdAt.localeCompare(r.createdAt)}).slice(0,e)}async function x(t){let e=await f(t.id);if(!e)throw new Error(`Closet item not found for id=${t.id}`);let{pk:s,sk:r}=E(e),n=new Date().toISOString(),i=await u.send(new o.UpdateItemCommand({TableName:d,Key:{pk:{S:s},sk:{S:r}},UpdateExpression:"SET #status = :approved, #updatedAt = :now REMOVE #reason",ExpressionAttributeNames:{"#status":"status","#updatedAt":"updatedAt","#reason":"reason"},ExpressionAttributeValues:{":approved":{S:"APPROVED"},":now":{S:n}},ReturnValues:"ALL_NEW"}));if(!i.Attributes)throw new Error("adminApproveItem: update returned no attributes");return p(i.Attributes)}async function R(t){let e=await f(t.id);if(!e)throw new Error(`Closet item not found for id=${t.id}`);let{pk:s,sk:r}=E(e),n=new Date().toISOString(),i=!!t.reason&&t.reason.trim().length>0,a=await u.send(new o.UpdateItemCommand({TableName:d,Key:{pk:{S:s},sk:{S:r}},UpdateExpression:i?"SET #status = :rejected, #updatedAt = :now, #reason = :reason":"SET #status = :rejected, #updatedAt = :now REMOVE #reason",ExpressionAttributeNames:{"#status":"status","#updatedAt":"updatedAt","#reason":"reason"},ExpressionAttributeValues:{":rejected":{S:"REJECTED"},":now":{S:n},...i?{":reason":{S:t.reason}}:{}},ReturnValues:"ALL_NEW"}));if(!a.Attributes)throw new Error("adminRejectItem: update returned no attributes");return p(a.Attributes)}async function V(t){let e=await f(t.id);if(!e)throw new Error(`Closet item not found for id=${t.id}`);let{pk:s,sk:r}=E(e),n=new Date().toISOString(),i=await u.send(new o.UpdateItemCommand({TableName:d,Key:{pk:{S:s},sk:{S:r}},UpdateExpression:"SET #audience = :aud, #updatedAt = :now",ExpressionAttributeNames:{"#audience":"audience","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":aud":{S:t.audience},":now":{S:n}},ReturnValues:"ALL_NEW"}));if(!i.Attributes)throw new Error("adminSetClosetAudience: update returned no attributes");return p(i.Attributes)}var B=async t=>{let{fieldName:e,parentTypeName:s}=t.info;if(s==="Query"){if(e==="adminListPending")return O();if(e==="closetFeed")return L(t.arguments||{});if(e==="topClosetLooks")return h(t.arguments||{})}if(s==="Mutation"){if(e==="adminApproveItem")return x(t.arguments);if(e==="adminRejectItem")return R(t.arguments);if(e==="adminSetClosetAudience")return V(t.arguments)}throw new Error(`Unknown field ${s}.${e} in ClosetAdminFn`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
