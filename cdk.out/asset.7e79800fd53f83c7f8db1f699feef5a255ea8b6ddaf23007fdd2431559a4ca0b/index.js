"use strict";var f=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var I=(t,e)=>{for(var r in e)f(t,r,{get:e[r],enumerable:!0})},k=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of S(e))!E.call(t,s)&&s!==r&&f(t,s,{get:()=>e[s],enumerable:!(n=P(e,s))||n.enumerable});return t};var G=t=>k(f({},"__esModule",{value:!0}),t);var L={};I(L,{handler:()=>B});module.exports=G(L);var o=require("@aws-sdk/client-s3"),d=require("@aws-sdk/s3-request-presigner"),u=new o.S3Client({region:process.env.AWS_REGION||"us-east-1",forcePathStyle:!0}),i=process.env.BUCKET,m=String(process.env.ALLOWED_ORIGINS||"").split(",").map(t=>t.trim()).filter(Boolean),R=process.env.WEB_ORIGIN||"",T=["authorization","Authorization","Content-Type","X-Amz-Date","X-Api-Key","X-Amz-Security-Token"].join(",");function g(t){let e=t?.headers?.origin||t?.headers?.Origin||"";return m.length?m.includes(e)?e:void 0:R||void 0}function y(t){let e={"Content-Type":"application/json","Access-Control-Allow-Headers":T,"Access-Control-Allow-Methods":"GET,POST,DELETE,OPTIONS","Access-Control-Allow-Credentials":"true",Vary:"Origin, Access-Control-Request-Headers, Access-Control-Request-Method"};return t&&(e["Access-Control-Allow-Origin"]=t),e}function p(t,e,r={}){let n=g(t);return{statusCode:200,headers:{...y(n),...r},body:JSON.stringify(e)}}function b(t){let e=g(t);return{statusCode:204,headers:y(e),body:""}}function a(t,e,r){let n=g(t);return!!(t.headers?.origin||t.headers?.Origin)&&!n?{statusCode:403,headers:y(void 0),body:JSON.stringify({message:"CORS: origin not allowed"})}:{statusCode:e,headers:y(n),body:JSON.stringify({message:r})}}var x=t=>t.httpMethod??t.requestContext?.http?.method??"GET",N=t=>t.requestContext?.authorizer?.claims??t.requestContext?.authorizer?.jwt?.claims??{},K=t=>{let e=t.body??"";if(!e)return{};let r=t.isBase64Encoded&&typeof e=="string"?Buffer.from(e,"base64").toString():e;try{return typeof r=="string"?JSON.parse(r):r}catch{return{}}};function h(t,e){let r=String(e||"").replace(/\.\./g,"").replace(/^[/\\]+/,""),n=r.startsWith(`users/${t}/`),s=/^users\/[^/]+\//.test(r)&&!n;return n?r:`users/${t}/${s?r.replace(/^users\/[^/]+\//,""):r}`}var B=async t=>{let e=x(t);if(e==="OPTIONS")return!g(t)&&(t.headers?.origin||t.headers?.Origin)?{statusCode:403,headers:y(void 0),body:""}:b(t);try{let r=N(t)?.sub||"";if(!r)return a(t,401,"Not authorized");if(e==="POST"){let n=K(t),s=String(n.key||""),l=String(n.contentType||"application/octet-stream");if(!s)return a(t,400,"Missing 'key'");let c=h(r,s),A=new o.PutObjectCommand({Bucket:i,Key:c,ContentType:l}),O=new o.GetObjectCommand({Bucket:i,Key:c}),w=await(0,d.getSignedUrl)(u,A,{expiresIn:900}),C=await(0,d.getSignedUrl)(u,O,{expiresIn:300});return p(t,{bucket:i,key:c,method:"PUT",putUrl:w,getUrl:C})}if(e==="GET"){let n=String(t?.queryStringParameters?.key??t.pathParameters?.key??"");if(!n)return a(t,400,"Missing 'key'");let s=h(r,n),l=new o.GetObjectCommand({Bucket:i,Key:s}),c=await(0,d.getSignedUrl)(u,l,{expiresIn:300});return p(t,{bucket:i,key:s,getUrl:c})}if(e==="DELETE"){let n=String(t?.queryStringParameters?.key??t.pathParameters?.key??"");if(!n)return a(t,400,"Missing 'key'");let s=h(r,n);return await u.send(new o.DeleteObjectCommand({Bucket:i,Key:s})),p(t,{deleted:!0,key:s})}return a(t,405,"Method Not Allowed")}catch(r){return console.error(r),a(t,500,r?.message??String(r))}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
