{
  "version": 3,
  "sources": ["../../lambda/presign/index.ts"],
  "sourcesContent": ["import {\r\n  APIGatewayProxyEvent,\r\n  APIGatewayProxyEventV2,\r\n  APIGatewayProxyResult,\r\n} from \"aws-lambda\";\r\nimport {\r\n  S3Client,\r\n  PutObjectCommand,\r\n  DeleteObjectCommand,\r\n  GetObjectCommand,\r\n} from \"@aws-sdk/client-s3\";\r\nimport { getSignedUrl } from \"@aws-sdk/s3-request-presigner\";\r\n\r\n/* Use path-style to avoid some blockers on virtual-hosted S3 */\r\nconst s3 = new S3Client({\r\n  region: process.env.AWS_REGION || \"us-east-1\",\r\n  forcePathStyle: true,\r\n});\r\n\r\nconst BUCKET = process.env.BUCKET!;\r\n\r\n/* ---------------- CORS helpers ---------------- */\r\nconst ALLOWED_ORIGINS = String(process.env.ALLOWED_ORIGINS || \"\")\r\n  .split(\",\").map(s => s.trim()).filter(Boolean);\r\nconst FALLBACK_ORIGIN = process.env.WEB_ORIGIN || \"\";\r\nconst ALLOW_HEADERS = [\r\n  \"authorization\",\"Authorization\",\"Content-Type\",\"X-Amz-Date\",\"X-Api-Key\",\"X-Amz-Security-Token\",\r\n].join(\",\");\r\n\r\nfunction pickAllowedOrigin(event: any): string | undefined {\r\n  const o = event?.headers?.origin || event?.headers?.Origin || \"\";\r\n  if (ALLOWED_ORIGINS.length) return ALLOWED_ORIGINS.includes(o) ? o : undefined;\r\n  return FALLBACK_ORIGIN || undefined;\r\n}\r\nfunction baseCorsHeaders(origin?: string) {\r\n  const h: Record<string,string> = {\r\n    \"Content-Type\": \"application/json\",\r\n    \"Access-Control-Allow-Headers\": ALLOW_HEADERS,\r\n    \"Access-Control-Allow-Methods\": \"GET,POST,DELETE,OPTIONS\",\r\n    \"Access-Control-Allow-Credentials\": \"true\",\r\n    Vary: \"Origin, Access-Control-Request-Headers, Access-Control-Request-Method\",\r\n  };\r\n  if (origin) h[\"Access-Control-Allow-Origin\"] = origin;\r\n  return h;\r\n}\r\nfunction ok(event:any, body:unknown, extra:Record<string,string> = {}): APIGatewayProxyResult {\r\n  const origin = pickAllowedOrigin(event);\r\n  return { statusCode: 200, headers: { ...baseCorsHeaders(origin), ...extra }, body: JSON.stringify(body) };\r\n}\r\nfunction noContent(event:any): APIGatewayProxyResult {\r\n  const origin = pickAllowedOrigin(event);\r\n  return { statusCode: 204, headers: baseCorsHeaders(origin), body: \"\" };\r\n}\r\nfunction bad(event:any, status:number, msg:string): APIGatewayProxyResult {\r\n  const origin = pickAllowedOrigin(event);\r\n  const hasReqOrigin = !!(event.headers?.origin || event.headers?.Origin);\r\n  if (hasReqOrigin && !origin) {\r\n    return { statusCode: 403, headers: baseCorsHeaders(undefined), body: JSON.stringify({ message: \"CORS: origin not allowed\" }) };\r\n  }\r\n  return { statusCode: status, headers: baseCorsHeaders(origin), body: JSON.stringify({ message: msg }) };\r\n}\r\n/* ------------------------------------------------ */\r\n\r\ntype AnyEvent = APIGatewayProxyEvent | APIGatewayProxyEventV2 | any;\r\nconst methodOf = (e:AnyEvent) => (e as any).httpMethod ?? e.requestContext?.http?.method ?? \"GET\";\r\nconst claimsOf = (e:AnyEvent) =>\r\n  (e as any).requestContext?.authorizer?.claims ??\r\n  (e as any).requestContext?.authorizer?.jwt?.claims ?? {};\r\nconst parseJson = (e:AnyEvent) => {\r\n  const raw = (e as any).body ?? \"\";\r\n  if (!raw) return {};\r\n  const txt = (e as any).isBase64Encoded && typeof raw === \"string\" ? Buffer.from(raw, \"base64\").toString() : raw;\r\n  try { return typeof txt === \"string\" ? JSON.parse(txt) : txt; } catch { return {}; }\r\n};\r\n/** sanitize + enforce users/<sub>/ prefix */\r\nfunction scopeUserKey(sub:string, raw:string): string {\r\n  const safe = String(raw || \"\").replace(/\\.\\./g, \"\").replace(/^[/\\\\]+/, \"\");\r\n  const alreadyScoped = safe.startsWith(`users/${sub}/`);\r\n  const foreignUser = /^users\\/[^/]+\\//.test(safe) && !alreadyScoped;\r\n  return alreadyScoped ? safe : `users/${sub}/${foreignUser ? safe.replace(/^users\\/[^/]+\\//, \"\") : safe}`;\r\n}\r\n\r\nexport const handler = async (event: AnyEvent): Promise<APIGatewayProxyResult> => {\r\n  const method = methodOf(event);\r\n\r\n  // CORS preflight\r\n  if (method === \"OPTIONS\") {\r\n    const origin = pickAllowedOrigin(event);\r\n    if (!origin && (event.headers?.origin || event.headers?.Origin)) {\r\n      return { statusCode: 403, headers: baseCorsHeaders(undefined), body: \"\" };\r\n    }\r\n    return noContent(event);\r\n  }\r\n\r\n  try {\r\n    const sub = (claimsOf(event)?.sub as string) || \"\";\r\n    if (!sub) return bad(event, 401, \"Not authorized\");\r\n\r\n    if (method === \"POST\") {\r\n      // Create PUT + GET presigns for a new upload\r\n      const body = parseJson(event);\r\n      const rawKey: string = String(body.key || \"\");\r\n      const contentType: string = String(body.contentType || \"application/octet-stream\");\r\n      if (!rawKey) return bad(event, 400, \"Missing 'key'\");\r\n\r\n      const key = scopeUserKey(sub, rawKey);\r\n      const putCmd = new PutObjectCommand({ Bucket: BUCKET, Key: key, ContentType: contentType });\r\n      const getCmd = new GetObjectCommand({ Bucket: BUCKET, Key: key });\r\n\r\n      const putUrl = await getSignedUrl(s3, putCmd, { expiresIn: 900 });  // 15m\r\n      const getUrl = await getSignedUrl(s3, getCmd, { expiresIn: 300 });  // 5m\r\n\r\n      return ok(event, { bucket: BUCKET, key, method: \"PUT\", putUrl, getUrl });\r\n    }\r\n\r\n    if (method === \"GET\") {\r\n      // Mint a fresh GET presign for an existing key (for previews after refresh)\r\n      const rawKey = String(\r\n        event?.queryStringParameters?.key ?? (event as any).pathParameters?.key ?? \"\"\r\n      );\r\n      if (!rawKey) return bad(event, 400, \"Missing 'key'\");\r\n      const key = scopeUserKey(sub, rawKey);\r\n\r\n      const getCmd = new GetObjectCommand({ Bucket: BUCKET, Key: key });\r\n      const getUrl = await getSignedUrl(s3, getCmd, { expiresIn: 300 });   // 5m\r\n      return ok(event, { bucket: BUCKET, key, getUrl });\r\n    }\r\n\r\n    if (method === \"DELETE\") {\r\n      // Delete a user-scoped object\r\n      const rawKey = String(\r\n        event?.queryStringParameters?.key ?? (event as any).pathParameters?.key ?? \"\"\r\n      );\r\n      if (!rawKey) return bad(event, 400, \"Missing 'key'\");\r\n      const key = scopeUserKey(sub, rawKey);\r\n\r\n      await s3.send(new DeleteObjectCommand({ Bucket: BUCKET, Key: key }));\r\n      return ok(event, { deleted: true, key });\r\n    }\r\n\r\n    return bad(event, 405, \"Method Not Allowed\");\r\n  } catch (e:any) {\r\n    console.error(e);\r\n    return bad(event, 500, e?.message ?? String(e));\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["presign_exports", "__export", "handler", "__toCommonJS", "import_client_s3", "import_s3_request_presigner", "s3", "BUCKET", "ALLOWED_ORIGINS", "s", "FALLBACK_ORIGIN", "ALLOW_HEADERS", "pickAllowedOrigin", "event", "o", "baseCorsHeaders", "origin", "h", "ok", "body", "extra", "noContent", "bad", "status", "msg", "methodOf", "e", "claimsOf", "parseJson", "raw", "txt", "scopeUserKey", "sub", "safe", "alreadyScoped", "foreignUser", "method", "rawKey", "contentType", "key", "putCmd", "getCmd", "putUrl", "getUrl"]
}
