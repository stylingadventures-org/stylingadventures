"use strict";var T=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var E=(t,e)=>{for(var r in e)T(t,r,{get:e[r],enumerable:!0})},S=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of A(e))!R.call(t,a)&&a!==r&&T(t,a,{get:()=>e[a],enumerable:!(n=w(e,a))||n.enumerable});return t};var k=t=>S(T({},"__esModule",{value:!0}),t);var U={};E(U,{handler:()=>O});module.exports=k(U);var i=require("@aws-sdk/client-dynamodb"),o=require("@aws-sdk/util-dynamodb"),l=require("crypto"),u=new i.DynamoDBClient({}),d=process.env.TABLE_NAME;function N(t){if(!t?.sub)throw new Error("Not authenticated")}function c(t){N(t);let r=(t?.claims||{})["cognito:groups"],n=Array.isArray(r)?r:String(r||"").split(",").map(a=>a.trim()).filter(Boolean);if(!n.includes("PRIME")&&!n.includes("ADMIN"))throw new Error("PRIME or ADMIN tier required")}function g(t){let r=(t?.claims||{})["cognito:groups"],n=Array.isArray(r)?r:String(r||"").split(",").map(a=>a.trim()).filter(Boolean);return n.includes("ADMIN")||n.includes("PRIME")}function I(){return new Date().toISOString()}function h(){return"TEA#REPORT"}function b(t){return`REPORT#${t}`}function y(){return"TEA#RELATIONSHIP"}function f(t,e){return`REL#${[t,e].sort().join("#")}`}var m=t=>(0,o.marshall)(t,{removeUndefinedValues:!0});async function C(t){c(t);let r=((await u.send(new i.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk",ScanIndexForward:!1,Limit:1,ExpressionAttributeValues:m({":pk":h()})}))).Items??[])[0];return r?(0,o.unmarshall)(r):null}async function L(t,e){c(e);let r=Math.min(t.limit??10,50),n=await u.send(new i.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk",ExpressionAttributeValues:m({":pk":h()}),ScanIndexForward:!1,Limit:r,ExclusiveStartKey:t.nextToken?JSON.parse(Buffer.from(t.nextToken,"base64").toString()):void 0})),a=(n.Items??[]).map(p=>(0,o.unmarshall)(p)),s=null;return n.LastEvaluatedKey&&(s=Buffer.from(JSON.stringify(n.LastEvaluatedKey)).toString("base64")),{items:a,nextToken:s}}async function M(t,e){return c(e),((await u.send(new i.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk",ScanIndexForward:!1,ExpressionAttributeValues:m({":pk":h()})}))).Items??[]).map(s=>(0,o.unmarshall)(s)).flatMap(s=>s.teaItems??[]).filter(s=>s.characters?.includes(t.characterName))}async function P(t,e){c(e);let r=await u.send(new i.GetItemCommand({TableName:d,Key:m({pk:y(),sk:f(t.character1,t.character2)})}));return r.Item?(0,o.unmarshall)(r.Item):null}async function x(t,e){if(c(e),!g(e))throw new Error("ADMIN required");let r=(0,l.randomUUID)(),n=I(),a=[{id:(0,l.randomUUID)(),reportId:r,title:"Lala x Crew Studio Sessions",description:"Behind-the-scenes tension during latest recording",teaLevel:7,category:"BEHIND_THE_SCENES",characters:["Lala","CrewMember1"],timestamp:n}],s=[{id:(0,l.randomUUID)(),author:"Anonymous Fan",content:"The vibes this week were immaculate!",sentiment:"POSITIVE",reactionCount:234,timestamp:n}],p={id:r,reportId:r,generatedAt:n,period:t.period,headline:`${t.period} Tea Report: Drama Meter \u{1F375}`,summary:"Latest happenings in the Lala universe",teaItems:a,dramaMeter:6,relationshipUpdates:[],hotTakes:s,viewCount:0,shareCount:0};return await u.send(new i.PutItemCommand({TableName:d,Item:m({pk:h(),sk:b(r),entityType:"TEA_REPORT",gsi1pk:`TEA#PERIOD#${t.period}`,gsi1sk:n,...p})})),p}async function D(t,e){if(c(e),!g(e))throw new Error("ADMIN required");return{id:(0,l.randomUUID)(),author:t.authorCharacter,content:t.content,sentiment:"NEUTRAL",reactionCount:0,timestamp:I()}}async function H(t,e){if(c(e),!g(e))throw new Error("ADMIN required");let r=I(),n={character1:t.character1,character2:t.character2,status:t.status,confidence:.85,lastUpdated:r};return await u.send(new i.PutItemCommand({TableName:d,Item:m({pk:y(),sk:f(t.character1,t.character2),entityType:"RELATIONSHIP",...n})})),n}var O=async t=>{console.log("TeaReportResolverFn event",JSON.stringify(t));let e=t.info?.fieldName;try{switch(e){case"latestTeaReport":return await C(t.identity);case"teaReportHistory":return await L(t.arguments||{},t.identity);case"characterDrama":return await M(t.arguments,t.identity);case"relationshipStatus":return await P(t.arguments,t.identity);case"adminGenerateTeaReport":return await x(t.arguments,t.identity);case"adminAddHotTake":return await D(t.arguments,t.identity);case"adminUpdateRelationshipStatus":return await H(t.arguments,t.identity);default:throw new Error(`Unknown field: ${e}`)}}catch(r){throw console.error("TeaReportResolverFn error",r),r}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
