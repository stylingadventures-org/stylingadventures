"use strict";var E=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var R=(e,t)=>{for(var s in t)E(e,s,{get:t[s],enumerable:!0})},M=(e,t,s,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of D(t))!L.call(e,n)&&n!==s&&E(e,n,{get:()=>t[n],enumerable:!(r=V(t,n))||r.enumerable});return e};var _=e=>M(E({},"__esModule",{value:!0}),e);var G={};R(G,{handler:()=>q});module.exports=_(G);var o=require("@aws-sdk/client-dynamodb"),T=require("@aws-sdk/util-dynamodb"),b=require("@aws-sdk/client-sfn"),N=require("crypto"),p=new o.DynamoDBClient({}),U=new b.SFNClient({}),l=process.env.TABLE_NAME||process.env.APP_TABLE||void 0,k=process.env.APPROVAL_SM_ARN;if(!l)throw new Error("ClosetResolverFn: TABLE_NAME (or APP_TABLE) environment variable is required");function S(e){let t=e.identity?.sub||e.identity?.claims&&e.identity.claims.sub;if(!t)throw new Error("ClosetResolverFn: missing identity.sub");return String(t)}function c(e){let t=(0,T.unmarshall)(e),s=t.userId??t.ownerSub;return{id:String(t.id),userId:String(s),ownerSub:String(t.ownerSub),title:t.title??null,mediaKey:t.mediaKey??null,status:t.status??"PENDING",audience:t.audience??"PUBLIC",reason:t.reason??null,createdAt:String(t.createdAt),updatedAt:String(t.updatedAt??t.createdAt),storyTitle:t.storyTitle??null,storySeason:t.storySeason??null,storyVibes:Array.isArray(t.storyVibes)?t.storyVibes:null}}async function f(e){let t=await p.send(new o.ScanCommand({TableName:l,FilterExpression:"begins_with(#pk, :itemPrefix) AND #sk = :meta AND #id = :id",ExpressionAttributeNames:{"#pk":"pk","#sk":"sk","#id":"id"},ExpressionAttributeValues:{":itemPrefix":{S:"ITEM#"},":meta":{S:"META"},":id":{S:e}},Limit:1}));return!t.Items||t.Items.length===0?null:t.Items[0]}function g(e){if(e.pk?.S&&e.sk?.S)return{pk:e.pk.S,sk:e.sk.S};throw new Error("ClosetResolverFn: could not infer pk/sk")}async function K(e,t){let s=S(e),r=(0,N.randomUUID)(),n=new Date().toISOString(),i={pk:{S:`ITEM#${r}`},sk:{S:"META"},id:{S:r},userId:{S:s},ownerSub:{S:s},title:{S:t.title??"Untitled upload"},status:{S:"DRAFT"},audience:{S:"PUBLIC"},createdAt:{S:n},updatedAt:{S:n}};return await p.send(new o.PutItemCommand({TableName:l,Item:i,ConditionExpression:"attribute_not_exists(pk)"})),{id:r,userId:s,ownerSub:s,title:i.title.S,mediaKey:null,status:"DRAFT",audience:"PUBLIC",reason:null,createdAt:n,updatedAt:n,storyTitle:null,storySeason:null,storyVibes:null}}async function B(e,t){let s=S(e),r=await f(t.id);if(!r)throw new Error(`Closet item not found for id=${t.id}`);let{pk:n,sk:i}=g(r),a=new Date().toISOString(),u=await p.send(new o.UpdateItemCommand({TableName:l,Key:{pk:{S:n},sk:{S:i}},ConditionExpression:"#ownerSub = :owner",UpdateExpression:"SET #mediaKey = :mk, #updatedAt = :now",ExpressionAttributeNames:{"#mediaKey":"mediaKey","#updatedAt":"updatedAt","#ownerSub":"ownerSub"},ExpressionAttributeValues:{":mk":t.mediaKey?{S:t.mediaKey}:{NULL:!0},":now":{S:a},":owner":{S:s}},ReturnValues:"ALL_NEW"}));if(!u.Attributes)throw new Error("updateClosetMediaKey: update returned no attributes");return c(u.Attributes)}async function F(e,t){let s=S(e),r=await f(t.id);if(!r)throw new Error(`Closet item not found for id=${t.id}`);let{pk:n,sk:i}=g(r),a=new Date().toISOString(),u=await p.send(new o.UpdateItemCommand({TableName:l,Key:{pk:{S:n},sk:{S:i}},ConditionExpression:"#ownerSub = :owner",UpdateExpression:"SET #status = :pending, #updatedAt = :now",ExpressionAttributeNames:{"#status":"status","#updatedAt":"updatedAt","#ownerSub":"ownerSub"},ExpressionAttributeValues:{":pending":{S:"PENDING"},":now":{S:a},":owner":{S:s}},ReturnValues:"ALL_NEW"}));if(k&&await U.send(new b.StartExecutionCommand({stateMachineArn:k,input:JSON.stringify({itemId:t.id,ownerSub:s})})),!u.Attributes)throw new Error("requestClosetApproval: update returned no attributes");return c(u.Attributes)}async function v(e){let t=S(e),r=((await p.send(new o.ScanCommand({TableName:l,FilterExpression:"begins_with(#pk, :itemPrefix) AND #sk = :meta AND #ownerSub = :owner",ExpressionAttributeNames:{"#pk":"pk","#sk":"sk","#ownerSub":"ownerSub"},ExpressionAttributeValues:{":itemPrefix":{S:"ITEM#"},":meta":{S:"META"},":owner":{S:t}}}))).Items||[]).map(c);return r.sort((n,i)=>n.createdAt<i.createdAt?1:-1),r}async function O(e,t){let s=typeof t.limit=="number"&&t.limit>0?t.limit:50,n=((await p.send(new o.ScanCommand({TableName:l,FilterExpression:"begins_with(#pk, :itemPrefix) AND #sk = :meta AND (#status = :approved OR #status = :published) AND #audience = :public",ExpressionAttributeNames:{"#pk":"pk","#sk":"sk","#status":"status","#audience":"audience"},ExpressionAttributeValues:{":itemPrefix":{S:"ITEM#"},":meta":{S:"META"},":approved":{S:"APPROVED"},":published":{S:"PUBLISHED"},":public":{S:"PUBLIC"}}}))).Items||[]).map(c);return n.sort((i,a)=>i.createdAt<a.createdAt?1:-1),{items:n.slice(0,s),nextToken:null}}async function $(e,t){let s=S(e),{id:r,storyTitle:n,storySeason:i,storyVibes:a}=t.input||{};if(!r)throw new Error("updateClosetItemStory: id is required");let u=await f(r);if(!u)throw new Error(`Closet item not found for id=${r}`);let{pk:P,sk:x}=g(u),h=new Date().toISOString(),y={"#updatedAt":"updatedAt","#ownerSub":"ownerSub"},A={":now":{S:h},":owner":{S:s}},w=["#updatedAt = :now"],m=[];if(typeof n<"u"){y["#storyTitle"]="storyTitle";let d=n?n.trim():"";d?(A[":storyTitle"]={S:d},w.push("#storyTitle = :storyTitle")):m.push("#storyTitle")}if(typeof i<"u"){y["#storySeason"]="storySeason";let d=i?i.trim():"";d?(A[":storySeason"]={S:d},w.push("#storySeason = :storySeason")):m.push("#storySeason")}typeof a<"u"&&(y["#storyVibes"]="storyVibes",Array.isArray(a)&&a.length>0?(A[":storyVibes"]={L:a.map(d=>({S:String(d)}))},w.push("#storyVibes = :storyVibes")):m.push("#storyVibes"));let I="SET "+w.join(", ");m.length>0&&(I+=" REMOVE "+m.join(", "));let C=await p.send(new o.UpdateItemCommand({TableName:l,Key:{pk:{S:P},sk:{S:x}},ConditionExpression:"#ownerSub = :owner",ExpressionAttributeNames:y,ExpressionAttributeValues:A,UpdateExpression:I,ReturnValues:"ALL_NEW"}));if(!C.Attributes)throw new Error("updateClosetItemStory: update returned no attributes");return c(C.Attributes)}var q=async e=>{let{parentTypeName:t,fieldName:s}=e.info;if(t==="Query"){if(s==="myCloset")return v(e);if(s==="closetFeed")return O(e,e.arguments||{})}if(t==="Mutation"){if(s==="createClosetItem")return K(e,e.arguments);if(s==="requestClosetApproval")return F(e,e.arguments);if(s==="updateClosetMediaKey")return B(e,e.arguments);if(s==="updateClosetItemStory")return $(e,e.arguments)}throw new Error(`ClosetResolverFn: unknown field ${t}.${s}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
