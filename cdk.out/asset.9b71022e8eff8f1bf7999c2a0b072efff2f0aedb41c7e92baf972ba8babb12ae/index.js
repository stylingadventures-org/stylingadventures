"use strict";var S=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var l=(n,t)=>{for(var o in t)S(n,o,{get:t[o],enumerable:!0})},y=(n,t,o,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of x(t))!N.call(n,s)&&s!==o&&S(n,s,{get:()=>t[s],enumerable:!(e=A(t,s))||e.enumerable});return n};var g=n=>y(S({},"__esModule",{value:!0}),n);var w={};l(w,{handler:()=>L});module.exports=g(w);var i=require("@aws-sdk/client-dynamodb"),E=new i.DynamoDBClient({}),u=process.env.TABLE_NAME;function b(n,t){if(!t)throw new Error("Unauthenticated");if(!t.groups?.includes("ADMIN")&&t.sub!==n)throw new Error("Forbidden")}var L=async n=>{let{fieldName:t}=n.info,o=n.identity;if(t==="logGameEvent"){let e=o?.sub,s=new Date().toISOString(),r=n.arguments.input,p=r.type==="LEVEL_CLEAR"?50:r.type==="DAILY_LOGIN"?10:r.type==="SHARE"?5:1,m=r.type==="LEVEL_CLEAR"?5:r.type==="DAILY_LOGIN"?1:0;await E.send(new i.UpdateItemCommand({TableName:u,Key:{pk:{S:`USER#${e}`},sk:{S:"PROFILE"}},UpdateExpression:"SET xp = if_not_exists(xp, :z) + :xi, coins = if_not_exists(coins, :z) + :ci, lastEventAt = :now",ExpressionAttributeValues:{":z":{N:"0"},":xi":{N:String(p)},":ci":{N:String(m)},":now":{S:s}},ReturnValues:"ALL_NEW"}));let a=-1*p;await E.send(new i.PutItemCommand({TableName:u,Item:{pk:{S:`USER#${e}`},sk:{S:`EVENT#${Date.now()}`},gsi1pk:{S:"LEADERBOARD#GLOBAL"},gsi1sk:{S:`SCORE#${a.toString().padStart(10,"0")}#${e}`},type:{S:"EVENT"},evType:{S:r.type}},ConditionExpression:"attribute_not_exists(pk)"}));let c=(await E.send(new i.QueryCommand({TableName:u,KeyConditionExpression:"pk = :p AND sk = :s",ExpressionAttributeValues:{":p":{S:`USER#${e}`},":s":{S:"PROFILE"}},Limit:1}))).Items?.[0];return{userId:e,level:Math.floor(Number(c?.xp?.N??"0")/100)+1,xp:Number(c?.xp?.N??"0"),coins:Number(c?.coins?.N??"0"),badges:[],lastEventAt:c?.lastEventAt?.S}}if(t==="awardCoins"){let{userId:e,coins:s,xp:r}=n.arguments.input;b(e,o);let p=Math.max(0,s|0),m=Math.max(0,(r??0)|0),a=await E.send(new i.UpdateItemCommand({TableName:u,Key:{pk:{S:`USER#${e}`},sk:{S:"PROFILE"}},UpdateExpression:"SET coins = if_not_exists(coins,:z) + :c, xp = if_not_exists(xp,:z) + :x",ExpressionAttributeValues:{":z":{N:"0"},":c":{N:String(p)},":x":{N:String(m)}},ReturnValues:"ALL_NEW"})),d=Number(a.Attributes?.xp?.N??"0");return{userId:e,level:Math.floor(d/100)+1,xp:d,coins:Number(a.Attributes?.coins?.N??"0"),badges:[],lastEventAt:a.Attributes?.lastEventAt?.S}}throw new Error(`Unknown field ${t}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
