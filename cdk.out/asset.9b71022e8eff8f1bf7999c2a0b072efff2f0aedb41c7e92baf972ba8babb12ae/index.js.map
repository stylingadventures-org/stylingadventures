{
  "version": 3,
  "sources": ["../../lambda/game/gameplay.ts"],
  "sourcesContent": ["import { DynamoDBClient, PutItemCommand, UpdateItemCommand, QueryCommand } from \"@aws-sdk/client-dynamodb\";\r\nimport { AppSyncIdentityCognito } from \"aws-lambda\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\nconst TABLE = process.env.TABLE_NAME!;\r\n\r\ntype AppSyncEvent = {\r\n  arguments: any;\r\n  info: { fieldName: string };\r\n  identity?: AppSyncIdentityCognito & { groups?: string[] };\r\n};\r\n\r\nfunction assertSelfOrAdmin(targetUserId: string, identity?: AppSyncIdentityCognito & { groups?: string[] }) {\r\n  if (!identity) throw new Error(\"Unauthenticated\");\r\n  const isAdmin = identity.groups?.includes('ADMIN');\r\n  if (!isAdmin && identity.sub !== targetUserId) throw new Error(\"Forbidden\");\r\n}\r\n\r\nexport const handler = async (event: AppSyncEvent) => {\r\n  const { fieldName } = event.info;\r\n  const identity = event.identity as any;\r\n\r\n  if (fieldName === 'logGameEvent') {\r\n    const userId = identity?.sub!;\r\n    const now = new Date().toISOString();\r\n    const ev = event.arguments.input as { type: string; metadata?: any };\r\n\r\n    // basic anti-abuse: track last event time in profile and cap awards per minute\r\n    // (for real anti-abuse, add CloudWatch metrics + AppConfig limits)\r\n\r\n    // Update XP/coins by simple rules\r\n    const xpInc = ev.type === 'LEVEL_CLEAR' ? 50 :\r\n                  ev.type === 'DAILY_LOGIN' ? 10 :\r\n                  ev.type === 'SHARE' ? 5 : 1;\r\n    const coinInc = ev.type === 'LEVEL_CLEAR' ? 5 : ev.type === 'DAILY_LOGIN' ? 1 : 0;\r\n\r\n    await ddb.send(new UpdateItemCommand({\r\n      TableName: TABLE,\r\n      Key: { pk: { S: `USER#${userId}` }, sk: { S: 'PROFILE' } },\r\n      UpdateExpression: 'SET xp = if_not_exists(xp, :z) + :xi, coins = if_not_exists(coins, :z) + :ci, lastEventAt = :now',\r\n      ExpressionAttributeValues: { ':z': { N: '0' }, ':xi': { N: String(xpInc) }, ':ci': { N: String(coinInc) }, ':now': { S: now } },\r\n      ReturnValues: 'ALL_NEW'\r\n    }));\r\n\r\n    // maintain leaderboard entry with negative score for descending order\r\n    const scoreNeg = -1 * (xpInc); // we add a small event delta; full recompute happens in profile.ts\r\n    await ddb.send(new PutItemCommand({\r\n      TableName: TABLE,\r\n      Item: {\r\n        pk:     { S: `USER#${userId}` },\r\n        sk:     { S: `EVENT#${Date.now()}` },\r\n        gsi1pk: { S: `LEADERBOARD#GLOBAL` },\r\n        gsi1sk: { S: `SCORE#${scoreNeg.toString().padStart(10, '0')}#${userId}` },\r\n        type:   { S: 'EVENT' },\r\n        evType: { S: ev.type },\r\n      },\r\n      ConditionExpression: 'attribute_not_exists(pk)'\r\n    }));\r\n\r\n    // return updated profile\r\n    const profile = await ddb.send(new QueryCommand({\r\n      TableName: TABLE,\r\n      KeyConditionExpression: 'pk = :p AND sk = :s',\r\n      ExpressionAttributeValues: { ':p': { S: `USER#${userId}` }, ':s': { S: 'PROFILE' } },\r\n      Limit: 1\r\n    }));\r\n\r\n    const item = profile.Items?.[0];\r\n    return {\r\n      userId,\r\n      level: Math.floor(Number(item?.xp?.N ?? '0') / 100) + 1,\r\n      xp: Number(item?.xp?.N ?? '0'),\r\n      coins: Number(item?.coins?.N ?? '0'),\r\n      badges: [],\r\n      lastEventAt: item?.lastEventAt?.S\r\n    };\r\n  }\r\n\r\n  if (fieldName === 'awardCoins') {\r\n    const { userId, coins, xp } = event.arguments.input as { userId: string; coins: number; xp?: number };\r\n    assertSelfOrAdmin(userId, identity);\r\n\r\n    const incCoins = Math.max(0, coins|0);\r\n    const incXp    = Math.max(0, (xp ?? 0)|0);\r\n\r\n    const res = await ddb.send(new UpdateItemCommand({\r\n      TableName: TABLE,\r\n      Key: { pk: { S: `USER#${userId}` }, sk: { S: 'PROFILE' } },\r\n      UpdateExpression: 'SET coins = if_not_exists(coins,:z) + :c, xp = if_not_exists(xp,:z) + :x',\r\n      ExpressionAttributeValues: { ':z': { N: '0' }, ':c': { N: String(incCoins) }, ':x': { N: String(incXp) } },\r\n      ReturnValues: 'ALL_NEW'\r\n    }));\r\n    const xpVal = Number(res.Attributes?.xp?.N ?? '0');\r\n    return {\r\n      userId,\r\n      level: Math.floor(xpVal / 100) + 1,\r\n      xp: xpVal,\r\n      coins: Number(res.Attributes?.coins?.N ?? '0'),\r\n      badges: [],\r\n      lastEventAt: res.Attributes?.lastEventAt?.S\r\n    };\r\n  }\r\n\r\n  throw new Error(`Unknown field ${fieldName}`);\r\n};\r\n"],
  "mappings": "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",
  "names": ["gameplay_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "ddb", "TABLE", "assertSelfOrAdmin", "targetUserId", "identity", "event", "fieldName", "userId", "now", "ev", "xpInc", "coinInc", "scoreNeg", "item", "coins", "xp", "incCoins", "incXp", "res", "xpVal"]
}
