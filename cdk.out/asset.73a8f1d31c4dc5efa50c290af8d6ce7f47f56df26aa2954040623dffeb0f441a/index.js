"use strict";var m=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var B=(t,e)=>{for(var r in e)m(t,r,{get:e[r],enumerable:!0})},M=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of k(e))!x.call(t,s)&&s!==r&&m(t,s,{get:()=>e[s],enumerable:!(n=b(e,s))||n.enumerable});return t};var G=t=>M(m({},"__esModule",{value:!0}),t);var j={};B(j,{handler:()=>z});module.exports=G(j);var i=require("@aws-sdk/client-s3"),d=require("@aws-sdk/s3-request-presigner"),p=new i.S3Client({region:process.env.AWS_REGION||"us-east-1",forcePathStyle:!0}),u=process.env.BUCKET;if(!u)throw new Error("Missing env BUCKET");var A=(process.env.ALLOWED_ORIGINS||"").split(",").map(t=>t.trim().replace(/\/+$/,"")).filter(Boolean),L=["authorization","Authorization","Content-Type","X-Amz-Date","X-Api-Key","X-Amz-Security-Token"].join(",");function R(t){return String(t?.headers?.origin||t?.headers?.Origin||"").replace(/\/+$/,"")}function N(t){let e=R(t);return e&&A.includes(e)?e:A.length>0?A[0]:"*"}function C(t){return{"Content-Type":"application/json","Access-Control-Allow-Origin":N(t),"Access-Control-Allow-Headers":L,"Access-Control-Allow-Methods":"GET,POST,DELETE,OPTIONS","Access-Control-Allow-Credentials":"true","Access-Control-Expose-Headers":"ETag,Content-Type,Content-Length,Last-Modified,Accept-Ranges",Vary:"Origin, Access-Control-Request-Headers, Access-Control-Request-Method"}}function E(t,e,r={}){return{statusCode:200,headers:{...C(t),"Cache-Control":"no-store",...r},body:JSON.stringify(e)}}function U(t){return{statusCode:204,headers:C(t),body:""}}function y(t,e,r){return{statusCode:e,headers:C(t),body:JSON.stringify({message:r})}}var K=t=>t.httpMethod??t.requestContext?.http?.method??"GET",_=t=>t.requestContext?.authorizer?.claims??t.requestContext?.authorizer?.jwt?.claims??{},D=t=>{let e=t.body??"";if(!e)return{};let r=t.isBase64Encoded&&typeof e=="string"?Buffer.from(e,"base64").toString():e;try{return typeof r=="string"?JSON.parse(r):r}catch{return{}}};function h(t,e){let r=String(e||"").replace(/\.\./g,"").replace(/^[/\\]+/,""),n=r.startsWith(`users/${t}/`),s=/^users\/[^/]+\//.test(r)&&!n;return n?r:`users/${t}/${s?r.replace(/^users\/[^/]+\//,""):r}`}function q(t){let e=t?.["cognito:groups"];return Array.isArray(e)?e:typeof e=="string"?e.split(",").map(r=>r.trim()).filter(Boolean):[]}var z=async t=>{let e=K(t);if(e==="OPTIONS")return U(t);try{let r=_(t),n=r?.sub||"";if(!n)return y(t,401,"Not authorized");let s=q(r),P=Number(process.env.BASE_UPLOAD_LIMIT_MB||"50"),S=Number(process.env.BESTIE_UPLOAD_LIMIT_MB||"200"),f=s.includes("BESTIE")?S:P;if(e==="POST"){let o=D(t),a=String(o.key||""),g=String(o.contentType||"application/octet-stream");if(!a)return y(t,400,"Missing 'key'");let l=Number(o.contentLength||0);if(l>0&&l>f*1024*1024)return y(t,413,`Max upload ${f} MB for your tier`);let c=h(n,a),O=new i.PutObjectCommand({Bucket:u,Key:c,ContentType:g}),T=new i.GetObjectCommand({Bucket:u,Key:c}),w=await(0,d.getSignedUrl)(p,O,{expiresIn:900}),I=await(0,d.getSignedUrl)(p,T,{expiresIn:300});return E(t,{bucket:u,key:c,method:"PUT",url:w,headers:{"Content-Type":g},putUrl:w,getUrl:I,maxBytesAllowed:f*1024*1024})}if(e==="GET"){let o=String(t?.queryStringParameters?.key??t.pathParameters?.key??"");if(!o)return y(t,400,"Missing 'key'");let a=String(o||"").replace(/\.\./g,"").replace(/^[/\\]+/,""),g=a;/^users\/[^/]+\//.test(a)||(g=h(n,a));let l=new i.GetObjectCommand({Bucket:u,Key:g}),c=await(0,d.getSignedUrl)(p,l,{expiresIn:300});return E(t,{bucket:u,key:g,getUrl:c,url:c,publicUrl:c})}if(e==="DELETE"){let o=String(t?.queryStringParameters?.key??t.pathParameters?.key??"");if(!o)return y(t,400,"Missing 'key'");let a=h(n,o);return await p.send(new i.DeleteObjectCommand({Bucket:u,Key:a})),E(t,{deleted:!0,key:a})}return y(t,405,"Method Not Allowed")}catch(r){return console.error(r),y(t,500,r?.message??String(r))}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
