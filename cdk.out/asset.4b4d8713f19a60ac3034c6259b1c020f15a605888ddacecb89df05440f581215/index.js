"use strict";var y=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var M=(e,t)=>{for(var i in t)y(e,i,{get:t[i],enumerable:!0})},b=(e,t,i,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of w(t))!E.call(e,r)&&r!==i&&y(e,r,{get:()=>t[r],enumerable:!(n=f(t,r))||n.enumerable});return e};var z=e=>b(y({},"__esModule",{value:!0}),e);var U={};M(U,{handler:()=>v});module.exports=z(U);var a=require("@aws-sdk/client-dynamodb"),o=require("@aws-sdk/util-dynamodb"),u=require("crypto"),m=new a.DynamoDBClient({}),l=process.env.TABLE_NAME;function S(e){if(!e?.sub)throw new Error("Not authenticated")}function s(e){S(e);let i=(e?.claims||{})["cognito:groups"],n=Array.isArray(i)?i:String(i||"").split(",").map(r=>r.trim()).filter(Boolean);if(!n.includes("PRIME")&&!n.includes("ADMIN"))throw new Error("PRIME or ADMIN tier required")}function d(e){let i=(e?.claims||{})["cognito:groups"],n=Array.isArray(i)?i:String(i||"").split(",").map(r=>r.trim()).filter(Boolean);return n.includes("ADMIN")||n.includes("PRIME")}function I(){return new Date().toISOString()}function c(){return"MAGAZINE#ISSUE"}function h(e){return`ISSUE#${e}`}var g=e=>(0,o.marshall)(e,{removeUndefinedValues:!0});async function P(e){s(e);let i=((await m.send(new a.QueryCommand({TableName:l,KeyConditionExpression:"pk = :pk",FilterExpression:"#status = :published",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:g({":pk":c(),":published":"PUBLISHED"}),ScanIndexForward:!1,Limit:1}))).Items??[])[0];return i?(0,o.unmarshall)(i):null}async function C(e,t){s(t);let i=Math.min(e.limit??12,50),n=await m.send(new a.QueryCommand({TableName:l,KeyConditionExpression:"pk = :pk",FilterExpression:"#status = :published",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:g({":pk":c(),":published":"PUBLISHED"}),ScanIndexForward:!1,Limit:i,ExclusiveStartKey:e.nextToken?JSON.parse(Buffer.from(e.nextToken,"base64").toString()):void 0})),r=(n.Items??[]).map(p=>(0,o.unmarshall)(p)),A=null;return n.LastEvaluatedKey&&(A=Buffer.from(JSON.stringify(n.LastEvaluatedKey)).toString("base64")),{items:r,nextToken:A}}async function N(e,t){s(t);let i=await m.send(new a.GetItemCommand({TableName:l,Key:g({pk:c(),sk:h(e.issueNumber)})}));return i.Item?(0,o.unmarshall)(i.Item):null}async function k(e,t){return s(t),[]}async function x(e,t){if(s(t),!d(t))throw new Error("ADMIN required");let i=(0,u.randomUUID)(),n=I(),r={id:i,issueNumber:e.issueNumber,title:e.title,theme:e.theme,coverImageKey:e.coverImageKey,coverStory:"",publishedAt:n,articles:[],exclusiveContent:[],viewCount:0,likeCount:0,status:"DRAFT"};return await m.send(new a.PutItemCommand({TableName:l,Item:g({pk:c(),sk:h(e.issueNumber),entityType:"MAGAZINE",gsi1pk:"MAGAZINE#STATUS#DRAFT",gsi1sk:n,...r})})),r}async function F(e,t){if(s(t),!d(t))throw new Error("ADMIN required");return{id:(0,u.randomUUID)(),magazineId:e.magazineId,title:e.title,author:e.author,category:e.category,content:e.content,featuredImages:[],wordCount:e.content.split(" ").length,readTime:Math.ceil(e.content.split(" ").length/200),createdAt:I()}}async function D(e,t){if(s(t),!d(t))throw new Error("ADMIN required");return{id:(0,u.randomUUID)(),magazineId:e.magazineId,title:e.title,photographyCredit:e.photographyCredit,stylist:e.stylist}}async function T(e,t){if(s(t),!d(t))throw new Error("ADMIN required");return{id:e.magazineId,issueNumber:1,title:"Issue",theme:"Theme",coverImageKey:"",coverStory:"",publishedAt:I(),articles:[],exclusiveContent:[],viewCount:0,likeCount:0,status:"PUBLISHED"}}var v=async e=>{console.log("MagazineResolverFn event",JSON.stringify(e));let t=e.info?.fieldName;try{switch(t){case"currentPrimeMagazine":return await P(e.identity);case"primeMagazineArchive":return await C(e.arguments||{},e.identity);case"primeMagazine":return await N(e.arguments,e.identity);case"magazineArticles":return await k(e.arguments,e.identity);case"adminCreateMagazineIssue":return await x(e.arguments,e.identity);case"adminAddArticle":return await F(e.arguments,e.identity);case"adminCreateFashionEditorial":return await D(e.arguments,e.identity);case"adminPublishMagazine":return await T(e.arguments,e.identity);default:throw new Error(`Unknown field: ${t}`)}}catch(i){throw console.error("MagazineResolverFn error",i),i}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
