"use strict";var p=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var K=(e,a)=>{for(var n in a)p(e,n,{get:a[n],enumerable:!0})},k=(e,a,n,t)=>{if(a&&typeof a=="object"||typeof a=="function")for(let r of y(a))!E.call(e,r)&&r!==n&&p(e,r,{get:()=>a[r],enumerable:!(t=m(a,r))||t.enumerable});return e};var A=e=>k(p({},"__esModule",{value:!0}),e);var N={};K(N,{handler:()=>w});module.exports=A(N);var u=require("@aws-sdk/client-dynamodb"),l=require("@aws-sdk/util-dynamodb"),b=new u.DynamoDBClient({}),g=process.env.TABLE_NAME||"",I=process.env.PK_NAME||"pk",S=process.env.SK_NAME||"sk",w=async e=>{console.log("ApplyBackgroundChange event:",JSON.stringify(e));let a=e?.itemId||e?.closetItemId||e?.detail?.itemId||e?.detail?.closetItemId||e?.id,n=e?.ownerId||e?.userId||e?.sub||e?.detail?.ownerId||e?.detail?.userId,t=e?.mediaKey||e?.detail?.mediaKey||e?.processedKey||e?.detail?.processedKey||e?.backgroundKey||e?.detail?.backgroundKey||e?.newBackgroundKey||e?.detail?.newBackgroundKey,r=e?.backgroundStatus||e?.detail?.backgroundStatus||null;if(!g)return console.warn("TABLE_NAME not set; skipping DynamoDB update"),{...e,applied:!0,skippedDdb:!0};if(!a||!n)return console.warn("Missing itemId/ownerId; returning passthrough"),{...e,applied:!1,reason:"Missing itemId/ownerId"};try{let s=["#updatedAt = :now"],d={"#updatedAt":"updatedAt"},i={":now":new Date().toISOString()};t&&(s.push("#mediaKey = :mk"),d["#mediaKey"]="mediaKey",i[":mk"]=t,s.push("#pendingBackgroundKey = :null"),d["#pendingBackgroundKey"]="pendingBackgroundKey",i[":null"]=null);let c=r||(t?"COMPLETED":null);c&&(s.push("#backgroundStatus = :bs"),d["#backgroundStatus"]="backgroundStatus",i[":bs"]=c);let o=new u.UpdateItemCommand({TableName:g,Key:(0,l.marshall)({[I]:`USER#${n}`,[S]:`CLOSET#${a}`}),UpdateExpression:"SET "+s.join(", "),ExpressionAttributeNames:d,ExpressionAttributeValues:(0,l.marshall)(i,{removeUndefinedValues:!0})});console.log("ApplyBackgroundChange: UpdateItem",JSON.stringify({TableName:o.input.TableName,Key:o.input.Key,UpdateExpression:o.input.UpdateExpression,ExpressionAttributeNames:o.input.ExpressionAttributeNames})),await b.send(o)}catch(s){return console.error("ApplyBackgroundChange: DDB update failed",s),{...e,applied:!1,error:String(s?.message||s)}}return{...e,applied:!0}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
