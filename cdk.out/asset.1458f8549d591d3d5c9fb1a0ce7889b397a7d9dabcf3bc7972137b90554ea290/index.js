"use strict";var b=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var $=(e,s)=>{for(var r in s)b(e,r,{get:s[r],enumerable:!0})},_=(e,s,r,n)=>{if(s&&typeof s=="object"||typeof s=="function")for(let o of R(s))!U.call(e,o)&&o!==r&&b(e,o,{get:()=>s[o],enumerable:!(n=V(s,o))||n.enumerable});return e};var B=e=>_(b({},"__esModule",{value:!0}),e);var G={};$(G,{adminApproveItem:()=>P,adminCreateClosetItem:()=>M,adminListClosetItems:()=>x,adminListPending:()=>N,adminRejectItem:()=>D,adminSetClosetAudience:()=>O,closetFeed:()=>T,handler:()=>J,toggleFavoriteClosetItem:()=>h,topClosetLooks:()=>K});module.exports=B(G);var i=require("@aws-sdk/client-dynamodb"),f=require("@aws-sdk/client-sfn"),l=new i.DynamoDBClient({}),k=new f.SFNClient({}),{TABLE_NAME:c=""}=process.env;if(!c)throw new Error("Missing env: TABLE_NAME");var y=()=>new Date().toISOString(),t=e=>({S:e});function A(e){let s=e.identity?.claims||{},r=e.identity?.sub||s.sub,n=s["cognito:groups"],o=Array.isArray(n)?n:String(n||"").split(",").map(m=>m.trim()).filter(Boolean),a=o.includes("ADMIN")||o.includes("COLLAB");if(!r)throw new Error("Unauthorized");return{sub:r,isAdmin:a}}function E(e,s){let r=e.favoriteCount?.N,n=typeof r=="string"?Number(r):0;return{id:e.id.S,userId:e.ownerSub.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",rawMediaKey:e.rawMediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??"",season:e.season?.S??null,vibes:e.vibes?.S??null,audience:e.audience?.S??null,favoriteCount:n,viewerHasFaved:!1,...s}}function j(){return globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`}function v(e){return e?Buffer.from(JSON.stringify(e),"utf8").toString("base64"):null}function H(e){if(e)try{return JSON.parse(Buffer.from(String(e),"base64").toString("utf8"))}catch{return}}var N=async e=>{let{isAdmin:s}=A(e);if(!s)throw new Error("Forbidden");return((await l.send(new i.QueryCommand({TableName:c,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(n=>E({...n,status:n.status}))},x=async e=>{let{isAdmin:s}=A(e);if(!s)throw new Error("Forbidden");let{status:r,limit:n=50,nextToken:o}=e.arguments||{},a=H(o);if(r){let d=await l.send(new i.QueryCommand({TableName:c,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t(`STATUS#${r}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount",ExpressionAttributeNames:{"#s":"status"},Limit:n,ExclusiveStartKey:a}));return{items:(d.Items||[]).map(p=>E({...p,status:p.status})),nextToken:v(d.LastEvaluatedKey)}}let m=await l.send(new i.ScanCommand({TableName:c,FilterExpression:"begins_with(pk, :p)",ExpressionAttributeValues:{":p":t("ITEM#")},ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount",ExpressionAttributeNames:{"#s":"status"},Limit:n,ExclusiveStartKey:a})),u=(m.Items||[]).map(d=>E({...d,status:d.status}));return u.sort((d,g)=>new Date(g.createdAt||0).getTime()-new Date(d.createdAt||0).getTime()),{items:u,nextToken:v(m.LastEvaluatedKey)}},T=async e=>{let{sub:s}=A(e),{sort:r="NEWEST"}=e.arguments||{},[n,o]=await Promise.all([l.send(new i.QueryCommand({TableName:c,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t("STATUS#PUBLISHED")},ScanIndexForward:r==="NEWEST",ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, audience, favoriteCount",ExpressionAttributeNames:{"#s":"status"}})),l.send(new i.QueryCommand({TableName:c,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:{":pk":t(`FAV#${s}`),":sk":t("CLOSET#")}}))]),a=new Set((o.Items||[]).map(u=>{let d=u.sk?.S??"";return d.startsWith("CLOSET#")?d.substring(7):u.closetId?.S??""})),m=(n.Items||[]).map(u=>E({...u,status:u.status},{viewerHasFaved:a.has(u.id.S)}));return r==="MOST_LOVED"&&m.sort((u,d)=>{let g=u.favoriteCount??0,p=d.favoriteCount??0;return p!==g?p-g:new Date(d.createdAt||0).getTime()-new Date(u.createdAt||0).getTime()}),m},K=async e=>T({...e,arguments:{sort:"NEWEST"}}),M=async e=>{let{sub:s,isAdmin:r}=A(e);if(!r)throw new Error("Forbidden");let n=e.arguments?.input||{};if(!n.title?.trim())throw new Error("title is required");if(!n.rawMediaKey)throw new Error("rawMediaKey is required");let o=j(),a=y();return await l.send(new i.PutItemCommand({TableName:c,Item:{pk:t(`ITEM#${o}`),sk:t("META"),id:t(o),ownerSub:t(s),gsi2pk:t("STATUS#PENDING"),gsi2sk:t(a),status:t("PENDING"),createdAt:t(a),updatedAt:t(a),title:t(n.title.trim()),rawMediaKey:t(n.rawMediaKey),favoriteCount:{N:"0"},...n.season?{season:t(n.season)}:{},...n.vibes?{vibes:t(n.vibes)}:{}}})),{id:o,userId:s,ownerSub:s,status:"PENDING",createdAt:a,updatedAt:a,title:n.title.trim(),mediaKey:"",rawMediaKey:n.rawMediaKey,reason:"",season:n.season??null,vibes:n.vibes??null,audience:null,favoriteCount:0,viewerHasFaved:!1}},P=async e=>{let{isAdmin:s}=A(e);if(!s)throw new Error("Forbidden");let r=e.arguments?.id;if(!r)throw new Error("id required");let n=y(),a=(await l.send(new i.UpdateItemCommand({TableName:c,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("APPROVED"),":u":t(n),":g2pk":t("STATUS#APPROVED"),":g2sk":t(n)},ReturnValues:"ALL_OLD"}))).Attributes,m=a.approvalToken?.S;if(m)try{await k.send(new f.SendTaskSuccessCommand({taskToken:m,output:JSON.stringify({approved:!0})}))}catch{}return E({...a,status:t("APPROVED")})},D=async e=>{let{isAdmin:s}=A(e);if(!s)throw new Error("Forbidden");let r=e.arguments?.id,n=e.arguments?.reason||"";if(!r)throw new Error("id required");let o=y(),m=(await l.send(new i.UpdateItemCommand({TableName:c,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("REJECTED"),":u":t(o),":g2pk":t("STATUS#REJECTED"),":g2sk":t(o),":r":t(n)},ReturnValues:"ALL_OLD"}))).Attributes,u=m.approvalToken?.S;if(u)try{await k.send(new f.SendTaskFailureCommand({taskToken:u,error:"Rejected",cause:n||"Rejected by admin"}))}catch{}return E({...m,status:t("REJECTED"),reason:t(n)})},O=async()=>"NOT_IMPLEMENTED",h=async e=>{let{sub:s}=A(e),r=e.arguments?.id,n=e.arguments?.favoriteOn,o=e.arguments?.on,a=typeof n=="boolean"?n:o;if(!r)throw new Error("id required");let u=(await l.send(new i.GetItemCommand({TableName:c,Key:{pk:t(`ITEM#${r}`),sk:t("META")}}))).Item;if(!u)throw new Error("Closet item not found");let d={pk:t(`FAV#${s}`),sk:t(`CLOSET#${r}`)},p=!!(await l.send(new i.GetItemCommand({TableName:c,Key:d}))).Item,w=typeof a=="boolean"?a:!p,C=y(),S=0;w&&!p?(S=1,await l.send(new i.PutItemCommand({TableName:c,Item:{...d,userSub:t(s),closetId:t(r),createdAt:t(C)}}))):!w&&p&&(S=-1,await l.send(new i.DeleteItemCommand({TableName:c,Key:d}))),S!==0&&await l.send(new i.UpdateItemCommand({TableName:c,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) + :delta, updatedAt = :u",ExpressionAttributeValues:{":zero":{N:"0"},":delta":{N:String(S)},":u":t(C)}}));let I=u.favoriteCount?.N,L=typeof I=="string"?Number(I):0,F=Math.max(0,L+S);return E(u,{favoriteCount:F,viewerHasFaved:w})},J=async e=>{let s=e.info.fieldName;if(s==="adminListPending")return N(e);if(s==="adminListClosetItems")return x(e);if(s==="adminCreateClosetItem")return M(e);if(s==="adminApproveItem")return P(e);if(s==="adminRejectItem")return D(e);if(s==="adminSetClosetAudience")return O();if(s==="closetFeed")return T(e);if(s==="topClosetLooks")return K(e);if(s==="toggleFavoriteClosetItem")return h(e);throw new Error(`No resolver implemented for field ${s}`)};0&&(module.exports={adminApproveItem,adminCreateClosetItem,adminListClosetItems,adminListPending,adminRejectItem,adminSetClosetAudience,closetFeed,handler,toggleFavoriteClosetItem,topClosetLooks});
//# sourceMappingURL=index.js.map
