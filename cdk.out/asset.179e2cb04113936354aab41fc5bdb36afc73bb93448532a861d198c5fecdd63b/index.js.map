{
  "version": 3,
  "sources": ["../../lambda/thumb-head/index.ts"],
  "sourcesContent": ["// lambda/thumb-head/index.ts\r\nimport type { APIGatewayProxyEventV2, APIGatewayProxyResultV2 } from \"aws-lambda\";\r\nimport { S3Client, HeadObjectCommand } from \"@aws-sdk/client-s3\";\r\n\r\nconst s3 = new S3Client({});\r\n// Prefer WEB_BUCKET, fall back to BUCKET for back-compat with older CDK stacks\r\nconst BUCKET = (process.env.WEB_BUCKET || process.env.BUCKET || \"\").trim();\r\nconst THUMBS_PREFIX = \"thumbs/\";\r\n\r\nexport const handler = async (event: APIGatewayProxyEventV2): Promise<APIGatewayProxyResultV2> => {\r\n  try {\r\n    // CORS preflight\r\n    if ((event.requestContext?.http?.method || \"\").toUpperCase() === \"OPTIONS\") {\r\n      return {\r\n        statusCode: 204,\r\n        headers: corsHeaders(),\r\n        body: \"\",\r\n      };\r\n    }\r\n\r\n    if (!BUCKET) {\r\n      return json(500, { message: \"Missing WEB_BUCKET (or BUCKET) env var\" });\r\n    }\r\n\r\n    const qs = event.queryStringParameters || {};\r\n    const key = (qs.key || \"\").trim();\r\n\r\n    // Require a concrete thumbnail key like \"thumbs/.../file.jpg\"\r\n    if (!key || !key.startsWith(THUMBS_PREFIX)) {\r\n      return json(400, { message: \"Missing or invalid 'key' query parameter\" });\r\n    }\r\n\r\n    // HEAD the object\r\n    try {\r\n      const resp = await s3.send(new HeadObjectCommand({ Bucket: BUCKET, Key: key }));\r\n      return json(200, {\r\n        exists: true,\r\n        contentLength: resp.ContentLength ?? null,\r\n        contentType: resp.ContentType ?? null,\r\n      });\r\n    } catch (err: any) {\r\n      // Not found\r\n      if (err?.$metadata?.httpStatusCode === 404 || err?.name === \"NotFound\") {\r\n        return json(404, { exists: false });\r\n      }\r\n      // Any other S3 error\r\n      return json(502, { message: \"S3 head failed\", error: stringify(err) });\r\n    }\r\n  } catch (e: any) {\r\n    return json(500, { message: \"Unhandled error\", error: stringify(e) });\r\n  }\r\n};\r\n\r\nfunction json(statusCode: number, body: unknown): APIGatewayProxyResultV2 {\r\n  return {\r\n    statusCode,\r\n    headers: corsHeaders(),\r\n    body: JSON.stringify(body),\r\n  };\r\n}\r\n\r\n// Simple permissive CORS (never return HTML)\r\nfunction corsHeaders(): Record<string, string> {\r\n  return {\r\n    \"content-type\": \"application/json\",\r\n    \"access-control-allow-origin\": \"*\",\r\n    \"access-control-allow-methods\": \"GET,HEAD,OPTIONS\",\r\n    \"access-control-allow-headers\": \"authorization,content-type,x-amz-date,x-api-key,x-amz-security-token\",\r\n    \"cache-control\": \"private, max-age=2\",\r\n  };\r\n}\r\n\r\nfunction stringify(e: unknown): string {\r\n  if (typeof e === \"string\") return e;\r\n  if (e && typeof e === \"object\" && \"message\" in (e as any)) return String((e as any).message);\r\n  try {\r\n    return JSON.stringify(e);\r\n  } catch {\r\n    return \"Unknown error\";\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAEA,IAAAI,EAA4C,8BAEtCC,EAAK,IAAI,WAAS,CAAC,CAAC,EAEpBC,GAAU,QAAQ,IAAI,YAAc,QAAQ,IAAI,QAAU,IAAI,KAAK,EACnEC,EAAgB,UAETL,EAAU,MAAOM,GAAoE,CAChG,GAAI,CAEF,IAAKA,EAAM,gBAAgB,MAAM,QAAU,IAAI,YAAY,IAAM,UAC/D,MAAO,CACL,WAAY,IACZ,QAASC,EAAY,EACrB,KAAM,EACR,EAGF,GAAI,CAACH,EACH,OAAOI,EAAK,IAAK,CAAE,QAAS,wCAAyC,CAAC,EAIxE,IAAMC,IADKH,EAAM,uBAAyB,CAAC,GAC3B,KAAO,IAAI,KAAK,EAGhC,GAAI,CAACG,GAAO,CAACA,EAAI,WAAWJ,CAAa,EACvC,OAAOG,EAAK,IAAK,CAAE,QAAS,0CAA2C,CAAC,EAI1E,GAAI,CACF,IAAME,EAAO,MAAMP,EAAG,KAAK,IAAI,oBAAkB,CAAE,OAAQC,EAAQ,IAAKK,CAAI,CAAC,CAAC,EAC9E,OAAOD,EAAK,IAAK,CACf,OAAQ,GACR,cAAeE,EAAK,eAAiB,KACrC,YAAaA,EAAK,aAAe,IACnC,CAAC,CACH,OAASC,EAAU,CAEjB,OAAIA,GAAK,WAAW,iBAAmB,KAAOA,GAAK,OAAS,WACnDH,EAAK,IAAK,CAAE,OAAQ,EAAM,CAAC,EAG7BA,EAAK,IAAK,CAAE,QAAS,iBAAkB,MAAOI,EAAUD,CAAG,CAAE,CAAC,CACvE,CACF,OAASE,EAAQ,CACf,OAAOL,EAAK,IAAK,CAAE,QAAS,kBAAmB,MAAOI,EAAUC,CAAC,CAAE,CAAC,CACtE,CACF,EAEA,SAASL,EAAKM,EAAoBC,EAAwC,CACxE,MAAO,CACL,WAAAD,EACA,QAASP,EAAY,EACrB,KAAM,KAAK,UAAUQ,CAAI,CAC3B,CACF,CAGA,SAASR,GAAsC,CAC7C,MAAO,CACL,eAAgB,mBAChB,8BAA+B,IAC/B,+BAAgC,mBAChC,+BAAgC,uEAChC,gBAAiB,oBACnB,CACF,CAEA,SAASK,EAAU,EAAoB,CACrC,GAAI,OAAO,GAAM,SAAU,OAAO,EAClC,GAAI,GAAK,OAAO,GAAM,UAAY,YAAc,EAAW,OAAO,OAAQ,EAAU,OAAO,EAC3F,GAAI,CACF,OAAO,KAAK,UAAU,CAAC,CACzB,MAAQ,CACN,MAAO,eACT,CACF",
  "names": ["thumb_head_exports", "__export", "handler", "__toCommonJS", "import_client_s3", "s3", "BUCKET", "THUMBS_PREFIX", "event", "corsHeaders", "json", "key", "resp", "err", "stringify", "e", "statusCode", "body"]
}
