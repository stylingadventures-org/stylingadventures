{
  "version": 3,
  "sources": ["../../lambda/game/profile.ts"],
  "sourcesContent": ["import {\r\n  DynamoDBClient,\r\n  GetItemCommand,\r\n  PutItemCommand,\r\n  UpdateItemCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport { AppSyncIdentityCognito } from \"aws-lambda\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\nconst TABLE = process.env.TABLE_NAME!;\r\n\r\ntype AppSyncEvent = {\r\n  arguments: any;\r\n  info: { fieldName: string };\r\n  identity?: AppSyncIdentityCognito & { groups?: string[] };\r\n};\r\n\r\nfunction assertAuth(id?: AppSyncIdentityCognito) {\r\n  if (!id?.sub) throw new Error(\"Unauthenticated\");\r\n}\r\nfunction isAdmin(id?: AppSyncIdentityCognito) {\r\n  const g = (id as any)?.claims?.[\"cognito:groups\"];\r\n  return Array.isArray(g) ? g.includes(\"ADMIN\") : `${g || \"\"}`.includes(\"ADMIN\");\r\n}\r\nconst key = (sub: string) => ({ pk: { S: `USER#${sub}` }, sk: { S: \"PROFILE\" } });\r\n\r\nfunction toProfile(sub: string, item?: any) {\r\n  const xp = Number(item?.xp?.N ?? \"0\");\r\n  const coins = Number(item?.coins?.N ?? \"0\");\r\n  const badges =\r\n    item?.badges?.SS ? (item.badges.SS as string[]) : [];\r\n  const displayName = item?.displayName?.S || null;\r\n  return {\r\n    userId: sub,\r\n    displayName,\r\n    level: Math.floor(xp / 100) + 1,\r\n    xp,\r\n    coins,\r\n    badges,\r\n    lastEventAt: item?.lastEventAt?.S || null,\r\n  };\r\n}\r\n\r\nexport const handler = async (event: AppSyncEvent) => {\r\n  const { fieldName } = event.info;\r\n  const identity = event.identity as AppSyncIdentityCognito;\r\n  const sub = identity?.sub;\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 getMyProfile \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (fieldName === \"getMyProfile\") {\r\n    assertAuth(identity);\r\n\r\n    // read\r\n    const got = await ddb.send(new GetItemCommand({\r\n      TableName: TABLE,\r\n      Key: key(sub!),\r\n    }));\r\n\r\n    // create default if missing\r\n    if (!got.Item) {\r\n      const now = new Date().toISOString();\r\n      await ddb.send(new PutItemCommand({\r\n        TableName: TABLE,\r\n        Item: {\r\n          pk: { S: `USER#${sub}` },\r\n          sk: { S: \"PROFILE\" },\r\n          xp: { N: \"0\" },\r\n          coins: { N: \"0\" },\r\n          badges: { SS: [] },\r\n          createdAt: { S: now },\r\n          updatedAt: { S: now },\r\n        },\r\n        ConditionExpression: \"attribute_not_exists(pk)\",\r\n      }));\r\n      return toProfile(sub!, undefined);\r\n    }\r\n\r\n    return toProfile(sub!, got.Item);\r\n  }\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 setDisplayName \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (fieldName === \"setDisplayName\") {\r\n    assertAuth(identity);\r\n    const raw: string = (event.arguments?.displayName ?? \"\").toString();\r\n    const name = raw.trim();\r\n    if (!name) throw new Error(\"Display name required\");\r\n    if (name.length > 40) throw new Error(\"Display name too long\");\r\n\r\n    const now = new Date().toISOString();\r\n    const upd = await ddb.send(new UpdateItemCommand({\r\n      TableName: TABLE,\r\n      Key: key(sub!),\r\n      UpdateExpression: \"SET displayName = :n, updatedAt = :u\",\r\n      ExpressionAttributeValues: {\r\n        \":n\": { S: name },\r\n        \":u\": { S: now },\r\n      },\r\n      ReturnValues: \"ALL_NEW\",\r\n    }));\r\n\r\n    return toProfile(sub!, upd.Attributes);\r\n  }\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 grantBadge (ADMIN) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (fieldName === \"grantBadge\") {\r\n    const { userId, badge } = event.arguments as { userId: string; badge: string };\r\n    if (!isAdmin(identity)) throw new Error(\"Forbidden\");\r\n\r\n    const b = (badge || \"\").trim();\r\n    if (!b) throw new Error(\"Badge required\");\r\n\r\n    const now = new Date().toISOString();\r\n    const upd = await ddb.send(new UpdateItemCommand({\r\n      TableName: TABLE,\r\n      Key: key(userId),\r\n      UpdateExpression: \"ADD badges :b SET updatedAt = :u\",\r\n      ExpressionAttributeValues: {\r\n        \":b\": { SS: [b] },\r\n        \":u\": { S: now },\r\n      },\r\n      ReturnValues: \"ALL_NEW\",\r\n    }));\r\n\r\n    return toProfile(userId, upd.Attributes);\r\n  }\r\n\r\n  throw new Error(`Unknown field ${fieldName}`);\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAAA,IAAAI,EAKO,oCAGDC,EAAM,IAAI,iBAAe,CAAC,CAAC,EAC3BC,EAAQ,QAAQ,IAAI,WAQ1B,SAASC,EAAWC,EAA6B,CAC/C,GAAI,CAACA,GAAI,IAAK,MAAM,IAAI,MAAM,iBAAiB,CACjD,CACA,SAASC,EAAQD,EAA6B,CAC5C,IAAME,EAAKF,GAAY,SAAS,gBAAgB,EAChD,OAAO,MAAM,QAAQE,CAAC,EAAIA,EAAE,SAAS,OAAO,EAAI,GAAGA,GAAK,EAAE,GAAG,SAAS,OAAO,CAC/E,CACA,IAAMC,EAAOC,IAAiB,CAAE,GAAI,CAAE,EAAG,QAAQA,CAAG,EAAG,EAAG,GAAI,CAAE,EAAG,SAAU,CAAE,GAE/E,SAASC,EAAUD,EAAaE,EAAY,CAC1C,IAAMC,EAAK,OAAOD,GAAM,IAAI,GAAK,GAAG,EAC9BE,EAAQ,OAAOF,GAAM,OAAO,GAAK,GAAG,EACpCG,EACJH,GAAM,QAAQ,GAAMA,EAAK,OAAO,GAAkB,CAAC,EAC/CI,EAAcJ,GAAM,aAAa,GAAK,KAC5C,MAAO,CACL,OAAQF,EACR,YAAAM,EACA,MAAO,KAAK,MAAMH,EAAK,GAAG,EAAI,EAC9B,GAAAA,EACA,MAAAC,EACA,OAAAC,EACA,YAAaH,GAAM,aAAa,GAAK,IACvC,CACF,CAEO,IAAMZ,EAAU,MAAOiB,GAAwB,CACpD,GAAM,CAAE,UAAAC,CAAU,EAAID,EAAM,KACtBE,EAAWF,EAAM,SACjBP,EAAMS,GAAU,IAGtB,GAAID,IAAc,eAAgB,CAChCb,EAAWc,CAAQ,EAGnB,IAAMC,EAAM,MAAMjB,EAAI,KAAK,IAAI,iBAAe,CAC5C,UAAWC,EACX,IAAKK,EAAIC,CAAI,CACf,CAAC,CAAC,EAGF,GAAI,CAACU,EAAI,KAAM,CACb,IAAMC,EAAM,IAAI,KAAK,EAAE,YAAY,EACnC,aAAMlB,EAAI,KAAK,IAAI,iBAAe,CAChC,UAAWC,EACX,KAAM,CACJ,GAAI,CAAE,EAAG,QAAQM,CAAG,EAAG,EACvB,GAAI,CAAE,EAAG,SAAU,EACnB,GAAI,CAAE,EAAG,GAAI,EACb,MAAO,CAAE,EAAG,GAAI,EAChB,OAAQ,CAAE,GAAI,CAAC,CAAE,EACjB,UAAW,CAAE,EAAGW,CAAI,EACpB,UAAW,CAAE,EAAGA,CAAI,CACtB,EACA,oBAAqB,0BACvB,CAAC,CAAC,EACKV,EAAUD,EAAM,MAAS,CAClC,CAEA,OAAOC,EAAUD,EAAMU,EAAI,IAAI,CACjC,CAGA,GAAIF,IAAc,iBAAkB,CAClCb,EAAWc,CAAQ,EAEnB,IAAMG,GADeL,EAAM,WAAW,aAAe,IAAI,SAAS,EACjD,KAAK,EACtB,GAAI,CAACK,EAAM,MAAM,IAAI,MAAM,uBAAuB,EAClD,GAAIA,EAAK,OAAS,GAAI,MAAM,IAAI,MAAM,uBAAuB,EAE7D,IAAMD,EAAM,IAAI,KAAK,EAAE,YAAY,EAC7BE,EAAM,MAAMpB,EAAI,KAAK,IAAI,oBAAkB,CAC/C,UAAWC,EACX,IAAKK,EAAIC,CAAI,EACb,iBAAkB,uCAClB,0BAA2B,CACzB,KAAM,CAAE,EAAGY,CAAK,EAChB,KAAM,CAAE,EAAGD,CAAI,CACjB,EACA,aAAc,SAChB,CAAC,CAAC,EAEF,OAAOV,EAAUD,EAAMa,EAAI,UAAU,CACvC,CAGA,GAAIL,IAAc,aAAc,CAC9B,GAAM,CAAE,OAAAM,EAAQ,MAAAC,CAAM,EAAIR,EAAM,UAChC,GAAI,CAACV,EAAQY,CAAQ,EAAG,MAAM,IAAI,MAAM,WAAW,EAEnD,IAAMO,GAAKD,GAAS,IAAI,KAAK,EAC7B,GAAI,CAACC,EAAG,MAAM,IAAI,MAAM,gBAAgB,EAExC,IAAML,EAAM,IAAI,KAAK,EAAE,YAAY,EAC7BE,EAAM,MAAMpB,EAAI,KAAK,IAAI,oBAAkB,CAC/C,UAAWC,EACX,IAAKK,EAAIe,CAAM,EACf,iBAAkB,mCAClB,0BAA2B,CACzB,KAAM,CAAE,GAAI,CAACE,CAAC,CAAE,EAChB,KAAM,CAAE,EAAGL,CAAI,CACjB,EACA,aAAc,SAChB,CAAC,CAAC,EAEF,OAAOV,EAAUa,EAAQD,EAAI,UAAU,CACzC,CAEA,MAAM,IAAI,MAAM,iBAAiBL,CAAS,EAAE,CAC9C",
  "names": ["profile_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "ddb", "TABLE", "assertAuth", "id", "isAdmin", "g", "key", "sub", "toProfile", "item", "xp", "coins", "badges", "displayName", "event", "fieldName", "identity", "got", "now", "name", "upd", "userId", "badge", "b"]
}
