"use strict";var g=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var b=(n,t)=>{for(var s in t)g(n,s,{get:t[s],enumerable:!0})},E=(n,t,s,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of w(t))!A.call(n,e)&&e!==s&&g(n,e,{get:()=>t[e],enumerable:!(r=y(t,e))||r.enumerable});return n};var f=n=>E(g({},"__esModule",{value:!0}),n);var D={};b(D,{handler:()=>I});module.exports=f(D);var i=require("@aws-sdk/client-dynamodb"),d=new i.DynamoDBClient({}),u=process.env.TABLE_NAME;function l(n){if(!n?.sub)throw new Error("Unauthenticated")}function N(n){let t=n?.claims?.["cognito:groups"];return Array.isArray(t)?t.includes("ADMIN"):`${t||""}`.includes("ADMIN")}var S=n=>({pk:{S:`USER#${n}`},sk:{S:"PROFILE"}});function p(n,t){let s=Number(t?.xp?.N??"0"),r=Number(t?.coins?.N??"0"),e=t?.badges?.SS?t.badges.SS:[],o=t?.displayName?.S||null;return{userId:n,displayName:o,level:Math.floor(s/100)+1,xp:s,coins:r,badges:e,lastEventAt:t?.lastEventAt?.S||null}}var I=async n=>{let{fieldName:t}=n.info,s=n.identity,r=s?.sub;if(t==="getMyProfile"){l(s);let e=await d.send(new i.GetItemCommand({TableName:u,Key:S(r)}));if(!e.Item){let o=new Date().toISOString();return await d.send(new i.PutItemCommand({TableName:u,Item:{pk:{S:`USER#${r}`},sk:{S:"PROFILE"},xp:{N:"0"},coins:{N:"0"},badges:{SS:[]},createdAt:{S:o},updatedAt:{S:o}},ConditionExpression:"attribute_not_exists(pk)"})),p(r,void 0)}return p(r,e.Item)}if(t==="setDisplayName"){l(s);let o=(n.arguments?.displayName??"").toString().trim();if(!o)throw new Error("Display name required");if(o.length>40)throw new Error("Display name too long");let a=new Date().toISOString(),c=await d.send(new i.UpdateItemCommand({TableName:u,Key:S(r),UpdateExpression:"SET displayName = :n, updatedAt = :u",ExpressionAttributeValues:{":n":{S:o},":u":{S:a}},ReturnValues:"ALL_NEW"}));return p(r,c.Attributes)}if(t==="grantBadge"){let{userId:e,badge:o}=n.arguments;if(!N(s))throw new Error("Forbidden");let a=(o||"").trim();if(!a)throw new Error("Badge required");let c=new Date().toISOString(),m=await d.send(new i.UpdateItemCommand({TableName:u,Key:S(e),UpdateExpression:"ADD badges :b SET updatedAt = :u",ExpressionAttributeValues:{":b":{SS:[a]},":u":{S:c}},ReturnValues:"ALL_NEW"}));return p(e,m.Attributes)}throw new Error(`Unknown field ${t}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
