"use strict";var y=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var P=Object.prototype.hasOwnProperty;var S=(e,t)=>{for(var i in t)y(e,i,{get:t[i],enumerable:!0})},T=(e,t,i,c)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of E(t))!P.call(e,n)&&n!==i&&y(e,n,{get:()=>t[n],enumerable:!(c=A(t,n))||c.enumerable});return e};var b=e=>T(y({},"__esModule",{value:!0}),e);var R={};S(R,{handler:()=>B});module.exports=b(R);var a=require("@aws-sdk/client-s3"),p=require("@aws-sdk/s3-request-presigner"),l=new a.S3Client({region:process.env.AWS_REGION||"us-east-1",forcePathStyle:!0}),f=process.env.BUCKET,w=process.env.WEB_ORIGIN??"https://stylingadventures.com",I=process.env.THUMBS_CDN,d={"Content-Type":"application/json","Access-Control-Allow-Origin":w,"Access-Control-Allow-Headers":"Authorization,Content-Type,X-Amz-Date,X-Api-Key,X-Amz-Security-Token","Access-Control-Allow-Methods":"GET,POST,DELETE,OPTIONS","Access-Control-Allow-Credentials":"true",Vary:"Origin"};function g(e,t={}){return{statusCode:200,headers:{...d,...t},body:JSON.stringify(e)}}function o(e,t){return{statusCode:e,headers:d,body:JSON.stringify({message:t})}}function O(e){return e.httpMethod??e.requestContext?.http?.method??"GET"}function k(e){return e.resource??e.rawPath??e.path??"/"}function N(e){return e.requestContext?.authorizer?.claims??e.requestContext?.authorizer?.jwt?.claims??{}}function m(e){if(!e.body)return;let t=e.isBase64Encoded?Buffer.from(e.body,"base64").toString():e.body;try{return JSON.parse(t)}catch{return}}var B=async e=>{try{let t=O(e),i=k(e),n=N(e)?.sub;if(t==="OPTIONS")return{statusCode:204,headers:d,body:""};if(t==="POST"&&/\/presign$/.test(i)){let u=m(e);if(!u)return o(400,"Missing body");let{key:r,contentType:s}=u;if(!r||typeof r!="string")return o(400,'Invalid "key"');if(!s||typeof s!="string")return o(400,'Invalid "contentType"');if(r.includes(".."))return o(400,"Illegal key");n&&!r.startsWith("users/")&&(r=`users/${n}/${r}`);let h=new a.PutObjectCommand({Bucket:f,Key:r,ContentType:s}),C=await(0,p.getSignedUrl)(l,h,{expiresIn:900});return g({url:C,key:r,thumbsCdn:I})}if(t==="DELETE"&&/\/delete$/.test(i)){let u=m(e),r=e?.queryStringParameters?.key?decodeURIComponent(e.queryStringParameters.key):void 0,s=u?.key??r;return!s||typeof s!="string"?o(400,'Invalid "key"'):n&&!s.startsWith(`users/${n}/`)?o(403,"Forbidden"):(await l.send(new a.DeleteObjectCommand({Bucket:f,Key:s})),g({deleted:s}))}return o(404,"Not Found")}catch(t){return console.error("handler error",t),o(500,t?.message??"Server error")}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
