{
  "version": 3,
  "sources": ["../../lambda/closet/admin.ts"],
  "sourcesContent": ["// lambda/closet/admin.ts\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  QueryCommand,\r\n  UpdateCommand,\r\n  GetCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\nimport type { AppSyncResolverEvent, AppSyncIdentityCognito } from \"aws-lambda\";\r\n\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}));\r\n\r\nconst TABLE =\r\n  process.env.CLOSET_TABLE ||\r\n  process.env.TABLE_NAME ||\r\n  (() => {\r\n    throw new Error(\"Missing env CLOSET_TABLE/TABLE_NAME\");\r\n  })();\r\n\r\nconst STATUS_GSI = process.env.STATUS_GSI || \"gsi2\";\r\ntype ClosetStatus = \"PENDING\" | \"APPROVED\" | \"REJECTED\" | \"PUBLISHED\";\r\nconst now = () => new Date().toISOString();\r\n\r\nfunction isPrivileged(id?: AppSyncIdentityCognito) {\r\n  const groups = ((id as any)?.claims?.[\"cognito:groups\"] as string[] | undefined) ?? [];\r\n  return Array.isArray(groups) && (groups.includes(\"ADMIN\") || groups.includes(\"COLLAB\"));\r\n}\r\n\r\n// Keys are pk = ITEM#<id>, sk = META\r\nconst itemKey = (id: string) => ({ pk: `ITEM#${id}`, sk: \"META\" });\r\n\r\n// Derive stable 'id' and 'userId'\r\nfunction toClosetItem(raw: any) {\r\n  // id: prefer explicit id, else derive from pk/sk\r\n  let id = raw?.id || \"\";\r\n  if (!id && typeof raw?.pk === \"string\" && raw.pk.startsWith(\"ITEM#\")) {\r\n    id = raw.pk.slice(\"ITEM#\".length);\r\n  }\r\n  // userId: prefer userId, else ownerSub, else derive from gsi1pk OWNER#<sub>\r\n  let userId =\r\n    raw?.userId ||\r\n    raw?.ownerSub ||\r\n    (typeof raw?.gsi1pk === \"string\" && raw.gsi1pk.startsWith(\"OWNER#\")\r\n      ? raw.gsi1pk.slice(\"OWNER#\".length)\r\n      : \"\");\r\n\r\n  // Build safe object (never nulls)\r\n  return {\r\n    id: String(id || \"\"),\r\n    userId: String(userId || \"\"),\r\n    title: String(raw?.title || \"\"),\r\n    status: (raw?.status as ClosetStatus) || \"PENDING\",\r\n    mediaKey: String(raw?.mediaKey || \"\"),\r\n    createdAt: String(raw?.createdAt || raw?.gsi2sk || now()),\r\n    updatedAt: String(raw?.updatedAt || raw?.createdAt || now()),\r\n    reason: raw?.reason ? String(raw.reason) : \"\", // optional in schema? keep as empty string\r\n  };\r\n}\r\n\r\nexport const handler = async (event: AppSyncResolverEvent<any>) => {\r\n  const field = event.info.fieldName;\r\n  const ident = event.identity as AppSyncIdentityCognito | undefined;\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  // Admin: list pending items \u2014 MUST NEVER RETURN null\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (field === \"adminListPending\") {\r\n    try {\r\n      const out = await ddb.send(\r\n        new QueryCommand({\r\n          TableName: TABLE,\r\n          IndexName: STATUS_GSI,               // \"gsi2\"\r\n          KeyConditionExpression: \"#gpk = :pk\",\r\n          ExpressionAttributeNames: { \"#gpk\": \"gsi2pk\" }, // your index PK attribute name\r\n          ExpressionAttributeValues: { \":pk\": \"STATUS#PENDING\" },\r\n          ScanIndexForward: false,\r\n          Limit: 100,\r\n        })\r\n      );\r\n\r\n      const items = (out.Items ?? []).map(toClosetItem)\r\n        // ensure non-nullable invariants\r\n        .filter(i => i.id && i.userId && i.createdAt);\r\n\r\n      return items; // [] is fine; NEVER return null\r\n    } catch (err) {\r\n      console.error(\"adminListPending error:\", err);\r\n      return []; // protect [ClosetItem!]!\r\n    }\r\n  }\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  // Admin: approve item\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (field === \"adminApproveItem\") {\r\n    if (!isPrivileged(ident)) throw new Error(\"Not authorized\");\r\n    const id = String(event.arguments?.id || \"\");\r\n    if (!id) throw new Error(\"id is required\");\r\n\r\n    const cur = await ddb.send(new GetCommand({ TableName: TABLE, Key: itemKey(id) }));\r\n    if (!cur.Item) throw new Error(\"Item not found\");\r\n\r\n    const out = await ddb.send(\r\n      new UpdateCommand({\r\n        TableName: TABLE,\r\n        Key: itemKey(id),\r\n        UpdateExpression:\r\n          \"SET #st = :approved, #updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE #reason\",\r\n        ExpressionAttributeNames: {\r\n          \"#st\": \"status\",\r\n          \"#updatedAt\": \"updatedAt\",\r\n          \"#reason\": \"reason\",\r\n        },\r\n        ExpressionAttributeValues: {\r\n          \":approved\": \"APPROVED\",\r\n          \":u\": now(),\r\n          \":g2pk\": \"STATUS#APPROVED\",\r\n          \":g2sk\": now(),\r\n          \":pending\": \"PENDING\",\r\n        },\r\n        ConditionExpression: \"#st = :pending\",\r\n        ReturnValues: \"ALL_NEW\",\r\n      })\r\n    );\r\n\r\n    return toClosetItem({ id, ...(out.Attributes || {}) });\r\n  }\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  // Admin: reject item\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (field === \"adminRejectItem\") {\r\n    if (!isPrivileged(ident)) throw new Error(\"Not authorized\");\r\n    const id = String(event.arguments?.id || \"\");\r\n    const reason = (event.arguments?.reason as string | undefined) ?? \"\";\r\n    if (!id) throw new Error(\"id is required\");\r\n\r\n    const cur = await ddb.send(new GetCommand({ TableName: TABLE, Key: itemKey(id) }));\r\n    if (!cur.Item) throw new Error(\"Item not found\");\r\n\r\n    const out = await ddb.send(\r\n      new UpdateCommand({\r\n        TableName: TABLE,\r\n        Key: itemKey(id),\r\n        UpdateExpression:\r\n          \"SET #st = :rejected, #updatedAt = :u, #reason = :rsn, gsi2pk = :g2pk, gsi2sk = :g2sk\",\r\n        ExpressionAttributeNames: {\r\n          \"#st\": \"status\",\r\n          \"#updatedAt\": \"updatedAt\",\r\n          \"#reason\": \"reason\",\r\n        },\r\n        ExpressionAttributeValues: {\r\n          \":rejected\": \"REJECTED\",\r\n          \":u\": now(),\r\n          \":rsn\": reason,\r\n          \":g2pk\": \"STATUS#REJECTED\",\r\n          \":g2sk\": now(),\r\n          \":pending\": \"PENDING\",\r\n        },\r\n        ConditionExpression: \"#st = :pending\",\r\n        ReturnValues: \"ALL_NEW\",\r\n      })\r\n    );\r\n\r\n    return toClosetItem({ id, ...(out.Attributes || {}) });\r\n  }\r\n\r\n  throw new Error(`Unhandled field: ${field}`);\r\n};\r\n"],
  "mappings": "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",
  "names": ["admin_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "ddb", "TABLE", "STATUS_GSI", "now", "isPrivileged", "id", "groups", "itemKey", "toClosetItem", "raw", "userId", "event", "field", "ident", "i", "err", "out", "reason"]
}
