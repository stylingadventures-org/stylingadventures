"use strict";var E=Object.defineProperty;var l=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var y=Object.prototype.hasOwnProperty;var T=(e,t)=>{for(var r in t)E(e,r,{get:t[r],enumerable:!0})},I=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of S(t))!y.call(e,i)&&i!==r&&E(e,i,{get:()=>t[i],enumerable:!(n=l(t,i))||n.enumerable});return e};var f=e=>I(E({},"__esModule",{value:!0}),e);var C={};T(C,{handler:()=>k});module.exports=f(C);var m=require("@aws-sdk/client-dynamodb"),s=require("@aws-sdk/lib-dynamodb"),a=s.DynamoDBDocumentClient.from(new m.DynamoDBClient({})),p=process.env.CLOSET_TABLE||process.env.TABLE_NAME||(()=>{throw new Error("Missing env CLOSET_TABLE/TABLE_NAME")})(),N=process.env.STATUS_GSI||"gsi2",d=()=>new Date().toISOString();function c(e){let t=e?.claims?.["cognito:groups"]??[];return Array.isArray(t)&&(t.includes("ADMIN")||t.includes("COLLAB"))}var u=e=>({pk:`ITEM#${e}`,sk:"META"});function g(e){let t=e?.id||"";!t&&typeof e?.pk=="string"&&e.pk.startsWith("ITEM#")&&(t=e.pk.slice(5));let r=e?.userId||e?.ownerSub||(typeof e?.gsi1pk=="string"&&e.gsi1pk.startsWith("OWNER#")?e.gsi1pk.slice(6):"");return{id:String(t||""),userId:String(r||""),title:String(e?.title||""),status:e?.status||"PENDING",mediaKey:String(e?.mediaKey||""),createdAt:String(e?.createdAt||e?.gsi2sk||d()),updatedAt:String(e?.updatedAt||e?.createdAt||d()),reason:e?.reason?String(e.reason):""}}var k=async e=>{let t=e.info.fieldName,r=e.identity;if(t==="adminListPending")try{return((await a.send(new s.QueryCommand({TableName:p,IndexName:N,KeyConditionExpression:"#gpk = :pk",ExpressionAttributeNames:{"#gpk":"gsi2pk"},ExpressionAttributeValues:{":pk":"STATUS#PENDING"},ScanIndexForward:!1,Limit:100}))).Items??[]).map(g).filter(o=>o.id&&o.userId&&o.createdAt)}catch(n){return console.error("adminListPending error:",n),[]}if(t==="adminApproveItem"){if(!c(r))throw new Error("Not authorized");let n=String(e.arguments?.id||"");if(!n)throw new Error("id is required");if(!(await a.send(new s.GetCommand({TableName:p,Key:u(n)}))).Item)throw new Error("Item not found");let o=await a.send(new s.UpdateCommand({TableName:p,Key:u(n),UpdateExpression:"SET #st = :approved, #updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE #reason",ExpressionAttributeNames:{"#st":"status","#updatedAt":"updatedAt","#reason":"reason"},ExpressionAttributeValues:{":approved":"APPROVED",":u":d(),":g2pk":"STATUS#APPROVED",":g2sk":d(),":pending":"PENDING"},ConditionExpression:"#st = :pending",ReturnValues:"ALL_NEW"}));return g({id:n,...o.Attributes||{}})}if(t==="adminRejectItem"){if(!c(r))throw new Error("Not authorized");let n=String(e.arguments?.id||""),i=e.arguments?.reason??"";if(!n)throw new Error("id is required");if(!(await a.send(new s.GetCommand({TableName:p,Key:u(n)}))).Item)throw new Error("Item not found");let A=await a.send(new s.UpdateCommand({TableName:p,Key:u(n),UpdateExpression:"SET #st = :rejected, #updatedAt = :u, #reason = :rsn, gsi2pk = :g2pk, gsi2sk = :g2sk",ExpressionAttributeNames:{"#st":"status","#updatedAt":"updatedAt","#reason":"reason"},ExpressionAttributeValues:{":rejected":"REJECTED",":u":d(),":rsn":i,":g2pk":"STATUS#REJECTED",":g2sk":d(),":pending":"PENDING"},ConditionExpression:"#st = :pending",ReturnValues:"ALL_NEW"}));return g({id:n,...A.Attributes||{}})}throw new Error(`Unhandled field: ${t}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
