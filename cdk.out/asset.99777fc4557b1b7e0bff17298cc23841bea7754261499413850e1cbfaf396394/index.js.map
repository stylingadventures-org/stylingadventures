{
  "version": 3,
  "sources": ["../../lambda/prime/fail-episode.ts"],
  "sourcesContent": ["// lambda/prime/fail-episode.ts\r\n\r\n/**\r\n * Prime Studios - Fail Episode Handler\r\n *\r\n * This is used as the \"catch\" / failure branch in the Publishing\r\n * Step Functions workflow.\r\n *\r\n * Responsibilities:\r\n *  - Normalize any upstream error into a structured failure payload.\r\n *  - Optionally tag the episode as failed so the UI can surface it.\r\n *\r\n * Kept intentionally minimal: no external I/O, just shaping data for\r\n * Step Functions / API consumers.\r\n */\r\n\r\nexport interface EpisodeDocument {\r\n  episodeId?: string;\r\n  slug?: string;\r\n  title?: string;\r\n  status?: string;\r\n  version?: string;\r\n  [key: string]: any;\r\n}\r\n\r\nexport interface ValidationIssue {\r\n  code: string;\r\n  severity: \"INFO\" | \"WARNING\" | \"ERROR\";\r\n  message: string;\r\n  path?: string;\r\n}\r\n\r\nexport interface ValidationSummary {\r\n  ok: boolean;\r\n  issues?: ValidationIssue[];\r\n  [key: string]: any;\r\n}\r\n\r\n/**\r\n * Event shape is intentionally loose: we accept anything the\r\n * Step Functions catch / fail branch passes down.\r\n */\r\nexport interface FailEpisodeEvent {\r\n  episode?: EpisodeDocument;\r\n  validation?: ValidationSummary;\r\n  /**\r\n   * Optional reason from upstream (e.g. thrown Error message).\r\n   */\r\n  reason?: string;\r\n  /**\r\n   * Optional stage hint (e.g. \"validation\", \"layout\", \"publish_write\").\r\n   */\r\n  stage?: string;\r\n  /**\r\n   * Raw error object from Step Functions catch if you want to inspect it.\r\n   */\r\n  error?: any;\r\n}\r\n\r\nexport interface FailEpisodeResult {\r\n  ok: false;\r\n  failed: true;\r\n  stage?: string;\r\n  reason?: string;\r\n  errorMessage?: string;\r\n  episode?: EpisodeDocument;\r\n  validation?: ValidationSummary;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// Lambda handler\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nexport const handler = async (\r\n  event: FailEpisodeEvent,\r\n): Promise<FailEpisodeResult> => {\r\n  console.log(\"FailEpisode incoming event:\", JSON.stringify(event, null, 2));\r\n\r\n  const episode: EpisodeDocument | undefined = event.episode\r\n    ? {\r\n        ...event.episode,\r\n        status: event.episode.status ?? \"failed\",\r\n      }\r\n    : undefined;\r\n\r\n  let reason = event.reason;\r\n  let errorMessage: string | undefined;\r\n\r\n  if (!reason && event.error) {\r\n    // Common Step Functions error format: { Error, Cause }\r\n    if (typeof event.error === \"string\") {\r\n      reason = event.error;\r\n    } else if (typeof (event.error as any).Error === \"string\") {\r\n      reason = (event.error as any).Error;\r\n    }\r\n\r\n    if (typeof (event.error as any).Cause === \"string\") {\r\n      errorMessage = (event.error as any).Cause;\r\n    }\r\n  }\r\n\r\n  const result: FailEpisodeResult = {\r\n    ok: false,\r\n    failed: true,\r\n    stage: event.stage,\r\n    reason,\r\n    errorMessage,\r\n    episode,\r\n    validation: event.validation,\r\n  };\r\n\r\n  console.log(\"FailEpisode result:\", JSON.stringify(result, null, 2));\r\n\r\n  return result;\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAyEO,IAAME,EAAU,MACrBE,GAC+B,CAC/B,QAAQ,IAAI,8BAA+B,KAAK,UAAUA,EAAO,KAAM,CAAC,CAAC,EAEzE,IAAMC,EAAuCD,EAAM,QAC/C,CACE,GAAGA,EAAM,QACT,OAAQA,EAAM,QAAQ,QAAU,QAClC,EACA,OAEAE,EAASF,EAAM,OACfG,EAEA,CAACD,GAAUF,EAAM,QAEf,OAAOA,EAAM,OAAU,SACzBE,EAASF,EAAM,MACN,OAAQA,EAAM,MAAc,OAAU,WAC/CE,EAAUF,EAAM,MAAc,OAG5B,OAAQA,EAAM,MAAc,OAAU,WACxCG,EAAgBH,EAAM,MAAc,QAIxC,IAAMI,EAA4B,CAChC,GAAI,GACJ,OAAQ,GACR,MAAOJ,EAAM,MACb,OAAAE,EACA,aAAAC,EACA,QAAAF,EACA,WAAYD,EAAM,UACpB,EAEA,eAAQ,IAAI,sBAAuB,KAAK,UAAUI,EAAQ,KAAM,CAAC,CAAC,EAE3DA,CACT",
  "names": ["fail_episode_exports", "__export", "handler", "__toCommonJS", "event", "episode", "reason", "errorMessage", "result"]
}
