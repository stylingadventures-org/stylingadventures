{
  "version": 3,
  "sources": ["../../lambda/admin/analytics.ts"],
  "sourcesContent": ["// lambda/admin/analytics.ts\r\n//\r\n// Admin-facing analytics helpers for the dashboard.\r\n// This is a safe stub: it enforces admin auth and returns\r\n// placeholder aggregates until wired to real data sources.\r\n\r\ntype AppSyncIdentity = {\r\n  sub?: string;\r\n  username?: string;\r\n  claims?: { [key: string]: any };\r\n  groups?: string[] | null;\r\n};\r\n\r\ntype AppSyncEvent = {\r\n  identity?: AppSyncIdentity;\r\n  info: { fieldName: string };\r\n  arguments: any;\r\n};\r\n\r\nfunction isAdmin(identity?: AppSyncIdentity): boolean {\r\n  if (!identity) return false;\r\n\r\n  const claimsGroups =\r\n    identity.claims?.[\"cognito:groups\"] ??\r\n    identity.claims?.[\"custom:groups\"] ??\r\n    identity.groups;\r\n\r\n  const groups = Array.isArray(claimsGroups)\r\n    ? claimsGroups\r\n    : typeof claimsGroups === \"string\"\r\n    ? claimsGroups.split(\",\")\r\n    : [];\r\n\r\n  // IdentityStack created \"admin\" and \"creator\" groups.\r\n  // Analytics is admin-only.\r\n  return groups.includes(\"admin\") || groups.includes(\"ADMIN\");\r\n}\r\n\r\nexport const handler = async (event: AppSyncEvent) => {\r\n  const identity = event.identity;\r\n  const field = event.info.fieldName;\r\n\r\n  if (!identity?.sub) {\r\n    throw new Error(\"Unauthorized\");\r\n  }\r\n\r\n  if (!isAdmin(identity)) {\r\n    throw new Error(\"Forbidden\");\r\n  }\r\n\r\n  switch (field) {\r\n    /**\r\n     * Example: adminDashboardSummary\r\n     * High-level KPIs for the admin dashboard.\r\n     * Later we can back this with:\r\n     *  - AnalyticsStack (S3/Athena/QuickSight)\r\n     *  - DDB aggregates\r\n     */\r\n    case \"adminDashboardSummary\": {\r\n      const now = new Date().toISOString();\r\n\r\n      return {\r\n        generatedAt: now,\r\n        xpEventsLast7Days: 0,\r\n        coinsIssuedLast7Days: 0,\r\n        activeUsersLast7Days: 0,\r\n        activeCreatorsLast7Days: 0,\r\n        livestreamMinutesWatchedLast7Days: 0,\r\n      };\r\n    }\r\n\r\n    /**\r\n     * Example: adminCreatorAnalytics(creatorId)\r\n     * Per-creator engagement + revenue snapshot (stubbed).\r\n     */\r\n    case \"adminCreatorAnalytics\": {\r\n      const { creatorId } = event.arguments || {};\r\n      const now = new Date().toISOString();\r\n\r\n      return {\r\n        creatorId: creatorId ?? null,\r\n        generatedAt: now,\r\n        totalViewsLast30Days: 0,\r\n        totalCoinsEarnedLast30Days: 0,\r\n        totalBesties: 0,\r\n        avgWatchTimeSeconds: 0,\r\n      };\r\n    }\r\n\r\n    /**\r\n     * Example: adminEconomyReport\r\n     * XP / coins economy totals (stubbed).\r\n     */\r\n    case \"adminEconomyReport\": {\r\n      const now = new Date().toISOString();\r\n\r\n      return {\r\n        generatedAt: now,\r\n        totalCoinsIssuedAllTime: 0,\r\n        totalCoinsBurnedAllTime: 0,\r\n        totalXpEventsAllTime: 0,\r\n      };\r\n    }\r\n\r\n    default:\r\n      // For any future fields wired in AdminStack but not yet implemented.\r\n      return {\r\n        ok: true,\r\n        handled: false,\r\n        field,\r\n      };\r\n  }\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAmBA,SAASI,EAAQC,EAAqC,CAnBtD,IAAAC,EAAAC,EAoBE,GAAI,CAACF,EAAU,MAAO,GAEtB,IAAMG,IACJF,EAAAD,EAAS,SAAT,YAAAC,EAAkB,sBAClBC,EAAAF,EAAS,SAAT,YAAAE,EAAkB,mBAClBF,EAAS,OAELI,EAAS,MAAM,QAAQD,CAAY,EACrCA,EACA,OAAOA,GAAiB,SACxBA,EAAa,MAAM,GAAG,EACtB,CAAC,EAIL,OAAOC,EAAO,SAAS,OAAO,GAAKA,EAAO,SAAS,OAAO,CAC5D,CAEO,IAAMP,EAAU,MAAOQ,GAAwB,CACpD,IAAML,EAAWK,EAAM,SACjBC,EAAQD,EAAM,KAAK,UAEzB,GAAI,EAACL,GAAA,MAAAA,EAAU,KACb,MAAM,IAAI,MAAM,cAAc,EAGhC,GAAI,CAACD,EAAQC,CAAQ,EACnB,MAAM,IAAI,MAAM,WAAW,EAG7B,OAAQM,EAAO,CAQb,IAAK,wBAGH,MAAO,CACL,YAHU,IAAI,KAAK,EAAE,YAAY,EAIjC,kBAAmB,EACnB,qBAAsB,EACtB,qBAAsB,EACtB,wBAAyB,EACzB,kCAAmC,CACrC,EAOF,IAAK,wBAAyB,CAC5B,GAAM,CAAE,UAAAC,CAAU,EAAIF,EAAM,WAAa,CAAC,EACpCG,EAAM,IAAI,KAAK,EAAE,YAAY,EAEnC,MAAO,CACL,UAAWD,GAAa,KACxB,YAAaC,EACb,qBAAsB,EACtB,2BAA4B,EAC5B,aAAc,EACd,oBAAqB,CACvB,CACF,CAMA,IAAK,qBAGH,MAAO,CACL,YAHU,IAAI,KAAK,EAAE,YAAY,EAIjC,wBAAyB,EACzB,wBAAyB,EACzB,qBAAsB,CACxB,EAGF,QAEE,MAAO,CACL,GAAI,GACJ,QAAS,GACT,MAAAF,CACF,CACJ,CACF",
  "names": ["analytics_exports", "__export", "handler", "__toCommonJS", "isAdmin", "identity", "_a", "_b", "claimsGroups", "groups", "event", "field", "creatorId", "now"]
}
