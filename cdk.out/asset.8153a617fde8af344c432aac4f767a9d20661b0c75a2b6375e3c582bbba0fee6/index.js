"use strict";var d=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var D=(n,e)=>{for(var t in e)d(n,t,{get:e[t],enumerable:!0})},h=(n,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of U(e))!O.call(n,s)&&s!==t&&d(n,s,{get:()=>e[s],enumerable:!(i=T(e,s))||i.enumerable});return n};var M=n=>h(d({},"__esModule",{value:!0}),n);var C={};D(C,{handler:()=>P});module.exports=M(C);var c=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/client-cognito-identity-provider"),g=new c.DynamoDBClient({}),S=new a.CognitoIdentityProviderClient({}),N=process.env.TABLE_NAME,I=process.env.PK_NAME||"pk",A=process.env.SK_NAME||"sk",f=process.env.USER_POOL_ID,m=()=>Date.now();function B(n,e){return{[I]:{S:n},[A]:{S:e}}}async function E(n){let t=(await g.send(new c.GetItemCommand({TableName:N,Key:B(`USER#${n}`,"BESTIE#STATE")}))).Item||{};return{active:t.active?.BOOL??!1,since:t.since?.N?new Date(Number(t.since.N)).toISOString():null,until:t.until?.N?new Date(Number(t.until.N)).toISOString():null,source:t.source?.S||"ADMIN"}}async function w(n,e){let t={[I]:{S:`USER#${n}`},[A]:{S:"BESTIE#STATE"},active:{BOOL:!!e.active},since:{N:String(e.since??m())},source:{S:String(e.source||"ADMIN")}};if(e.until!=null){let i=typeof e.until=="string"?Date.parse(e.until):Number(e.until);Number.isNaN(i)||(t.until={N:String(i)})}return await g.send(new c.PutItemCommand({TableName:N,Item:t})),E(n)}function v(n){let e=n?.["cognito:groups"];return Array.isArray(e)?e:typeof e=="string"?e.split(",").map(t=>t.trim()).filter(Boolean):[]}var P=async n=>{let e=n.info?.fieldName,t=n.identity?.sub,i=v(n.identity?.claims||{}),s=i.includes("ADMIN");if(e==="meBestieStatus"){if(!t)throw new Error("Unauthenticated");return E(t)}if(e==="claimBestieTrial"){if(!t)throw new Error("Unauthenticated");let r=Math.max(1,Math.min(30,Number(n.arguments?.days??7))),u=await E(t);if(u.active)return u;let o=m()+r*24*60*60*1e3;return w(t,{active:!0,since:m(),until:o,source:"TRIAL"})}if(e==="isEpisodeEarlyAccess"){let r=String(n.arguments?.id||"");if(!r)throw new Error("Missing episode id");let o=(await g.send(new c.GetItemCommand({TableName:N,Key:B(`EPISODE#${r}`,"META")}))).Item||{},l=o.earlyAccess?.BOOL||!1,p=o.earlyAccessUntil?.N?Number(o.earlyAccessUntil.N):0,b=i.includes("BESTIE"),y=!l||b||p&&m()>p;return{id:r,gated:l&&!y,earlyAccess:l,gateOpen:y}}if(!s)throw new Error("Forbidden");if(e==="adminSetBestie"){let{userSub:r,active:u,until:o,source:l}=n.arguments||{};if(!r)throw new Error("userSub required");return u?await S.send(new a.AdminAddUserToGroupCommand({UserPoolId:f,Username:r,GroupName:"BESTIE"})):await S.send(new a.AdminRemoveUserFromGroupCommand({UserPoolId:f,Username:r,GroupName:"BESTIE"})),w(r,{active:!!u,since:m(),until:o??null,source:l||"ADMIN"})}if(e==="adminRevokeBestie"){let{userSub:r}=n.arguments||{};if(!r)throw new Error("userSub required");return await S.send(new a.AdminRemoveUserFromGroupCommand({UserPoolId:f,Username:r,GroupName:"BESTIE"})),w(r,{active:!1,since:m(),source:"ADMIN"})}throw new Error(`Unknown field ${e}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
