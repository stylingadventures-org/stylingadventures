{
  "version": 3,
  "sources": ["../../lambda/bestie/index.ts"],
  "sourcesContent": ["// lambda/bestie/index.ts\r\nimport {\r\n  DynamoDBClient,\r\n  GetItemCommand,\r\n  PutItemCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  CognitoIdentityProviderClient,\r\n  AdminAddUserToGroupCommand,\r\n  AdminRemoveUserFromGroupCommand,\r\n} from \"@aws-sdk/client-cognito-identity-provider\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\nconst idp = new CognitoIdentityProviderClient({});\r\n\r\nconst TBL = process.env.TABLE_NAME!;\r\nconst PK = process.env.PK_NAME || \"pk\";\r\nconst SK = process.env.SK_NAME || \"sk\";\r\nconst USER_POOL_ID = process.env.USER_POOL_ID!;\r\n\r\nconst nowMs = () => Date.now();\r\n\r\ntype Bestie = {\r\n  active: boolean;\r\n  since?: number;\r\n  until?: number | null;\r\n  source?: string;\r\n};\r\n\r\nfunction keyObj(pk: string, sk: string) {\r\n  return { [PK]: { S: pk }, [SK]: { S: sk } } as const;\r\n}\r\n\r\nasync function getBestie(sub: string) {\r\n  const res = await ddb.send(\r\n    new GetItemCommand({ TableName: TBL, Key: keyObj(`USER#${sub}`, \"BESTIE#STATE\") })\r\n  );\r\n  const i = res.Item || {};\r\n  return {\r\n    active: i[\"active\"]?.BOOL ?? false,\r\n    since: i[\"since\"]?.N ? new Date(Number(i[\"since\"].N)).toISOString() : null,\r\n    until: i[\"until\"]?.N ? new Date(Number(i[\"until\"].N)).toISOString() : null,\r\n    source: i[\"source\"]?.S || \"ADMIN\",\r\n  };\r\n}\r\n\r\nasync function putBestie(sub: string, s: Bestie) {\r\n  const item: any = {\r\n    [PK]: { S: `USER#${sub}` },\r\n    [SK]: { S: \"BESTIE#STATE\" },\r\n    active: { BOOL: !!s.active },\r\n    since: { N: String(s.since ?? nowMs()) },\r\n    source: { S: String(s.source || \"ADMIN\") },\r\n  };\r\n  if (s.until != null) {\r\n    const n = typeof s.until === \"string\" ? Date.parse(s.until) : Number(s.until);\r\n    if (!Number.isNaN(n)) item[\"until\"] = { N: String(n) };\r\n  }\r\n  await ddb.send(new PutItemCommand({ TableName: TBL, Item: item }));\r\n  return getBestie(sub);\r\n}\r\n\r\nfunction groupsFromClaims(claims: any): string[] {\r\n  const g = claims?.[\"cognito:groups\"];\r\n  if (Array.isArray(g)) return g;\r\n  if (typeof g === \"string\") return g.split(\",\").map((s) => s.trim()).filter(Boolean);\r\n  return [];\r\n}\r\n\r\nexport const handler = async (event: any) => {\r\n  const field = event.info?.fieldName as string;\r\n  const sub = event.identity?.sub as string | undefined;\r\n  const groups = groupsFromClaims(event.identity?.claims || {});\r\n  const isAdmin = groups.includes(\"ADMIN\");\r\n\r\n  if (field === \"meBestieStatus\") {\r\n    if (!sub) throw new Error(\"Unauthenticated\");\r\n    return getBestie(sub);\r\n  }\r\n\r\n  if (field === \"claimBestieTrial\") {\r\n    if (!sub) throw new Error(\"Unauthenticated\");\r\n    const days = Math.max(1, Math.min(30, Number(event.arguments?.days ?? 7)));\r\n    const existing = await getBestie(sub);\r\n    if (existing.active) return existing;\r\n    const until = nowMs() + days * 24 * 60 * 60 * 1000;\r\n    return putBestie(sub, { active: true, since: nowMs(), until, source: \"TRIAL\" });\r\n  }\r\n\r\n  if (field === \"isEpisodeEarlyAccess\") {\r\n    // Minimal gate: look up EPISODE#<id> META item, fields: earlyAccess (BOOL), earlyAccessUntil (N)\r\n    const id = String(event.arguments?.id || \"\");\r\n    if (!id) throw new Error(\"Missing episode id\");\r\n    const res = await ddb.send(\r\n      new GetItemCommand({ TableName: TBL, Key: keyObj(`EPISODE#${id}`, \"META\") })\r\n    );\r\n    const meta = res.Item || {};\r\n    const early = meta[\"earlyAccess\"]?.BOOL || false;\r\n    const until = meta[\"earlyAccessUntil\"]?.N ? Number(meta[\"earlyAccessUntil\"].N) : 0;\r\n    const hasBestie = groups.includes(\"BESTIE\");\r\n    const gateOpen = !early || hasBestie || (until && nowMs() > until);\r\n    return { id, gated: early && !gateOpen, earlyAccess: early, gateOpen };\r\n  }\r\n\r\n  // Admin only\r\n  if (!isAdmin) throw new Error(\"Forbidden\");\r\n\r\n  if (field === \"adminSetBestie\") {\r\n    const { userSub, active, until, source } = event.arguments || {};\r\n    if (!userSub) throw new Error(\"userSub required\");\r\n\r\n    if (active) {\r\n      await idp.send(\r\n        new AdminAddUserToGroupCommand({\r\n          UserPoolId: USER_POOL_ID,\r\n          Username: userSub,\r\n          GroupName: \"BESTIE\",\r\n        })\r\n      );\r\n    } else {\r\n      await idp.send(\r\n        new AdminRemoveUserFromGroupCommand({\r\n          UserPoolId: USER_POOL_ID,\r\n          Username: userSub,\r\n          GroupName: \"BESTIE\",\r\n        })\r\n      );\r\n    }\r\n\r\n    return putBestie(userSub, {\r\n      active: !!active,\r\n      since: nowMs(),\r\n      until: until ?? null,\r\n      source: source || \"ADMIN\",\r\n    });\r\n  }\r\n\r\n  if (field === \"adminRevokeBestie\") {\r\n    const { userSub } = event.arguments || {};\r\n    if (!userSub) throw new Error(\"userSub required\");\r\n    await idp.send(\r\n      new AdminRemoveUserFromGroupCommand({\r\n        UserPoolId: USER_POOL_ID,\r\n        Username: userSub,\r\n        GroupName: \"BESTIE\",\r\n      })\r\n    );\r\n    return putBestie(userSub, { active: false, since: nowMs(), source: \"ADMIN\" });\r\n  }\r\n\r\n  throw new Error(`Unknown field ${field}`);\r\n};\r\n"],
  "mappings": "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",
  "names": ["bestie_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_client_cognito_identity_provider", "ddb", "idp", "TBL", "PK", "SK", "USER_POOL_ID", "nowMs", "keyObj", "pk", "sk", "getBestie", "sub", "i", "putBestie", "s", "item", "n", "groupsFromClaims", "claims", "g", "event", "field", "groups", "isAdmin", "days", "existing", "until", "id", "meta", "early", "hasBestie", "gateOpen", "userSub", "active", "source"]
}
