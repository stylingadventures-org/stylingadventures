"use strict";var i=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var l=Object.getOwnPropertyNames;var g=Object.prototype.hasOwnProperty;var S=(n,t)=>{for(var e in t)i(n,e,{get:t[e],enumerable:!0})},y=(n,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of l(t))!g.call(n,o)&&o!==e&&i(n,o,{get:()=>t[o],enumerable:!(r=u(t,o))||r.enumerable});return n};var f=n=>y(i({},"__esModule",{value:!0}),n);var h={};S(h,{handler:()=>m});module.exports=f(h);var c=require("@aws-sdk/client-sfn"),p=new c.SFNClient({}),d=process.env.THUMB_SM_ARN||"",k=n=>/^users\//i.test(n)&&/\.(?:jpe?g|png|webp)$/i.test(n);function b(n){let t=[],e;try{e=JSON.parse(n)}catch{return console.warn("Skipping record; non-JSON body:",n.slice(0,256)),t}let r=Array.isArray(e?.Records)?e.Records:e?.s3?[e]:e?.detail?.bucket?.name&&e?.detail?.object?.key?[{s3:{bucket:{name:e.detail.bucket.name||e.detail.bucket},object:{key:e.detail.object.key}}}]:[];if(r.length===0)return console.warn("Skipping record; unrecognized body:",n.slice(0,512)),t;for(let o of r){let a=o?.s3?.bucket?.name,s=o?.s3?.object?.key;if(!(!a||!s)){if(s=decodeURIComponent(String(s).replace(/\+/g," ")),!k(s)){console.info("Ignored (filter)",{key:s});continue}t.push({bucket:a,key:s})}}return t}var m=async n=>{if(!d)throw new Error("Missing env THUMB_SM_ARN");console.info("SQS batch size:",n.Records.length);let t=[];for(let e of n.Records)t.push(...b(e.body??""));for(let e of t){let r=JSON.stringify(e);await p.send(new c.StartExecutionCommand({stateMachineArn:d,input:r})),console.info("Started execution",e)}return console.info("Dispatched",t.length,"execution(s)."),{ok:!0,count:t.length}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
