"use strict";var u=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var f=Object.prototype.hasOwnProperty;var A=(e,n)=>{for(var t in n)u(e,t,{get:n[t],enumerable:!0})},S=(e,n,t,i)=>{if(n&&typeof n=="object"||typeof n=="function")for(let o of b(n))!f.call(e,o)&&o!==t&&u(e,o,{get:()=>n[o],enumerable:!(i=E(n,o))||i.enumerable});return e};var M=e=>S(u({},"__esModule",{value:!0}),e);var N={};A(N,{handler:()=>K});module.exports=M(N);var s=require("@aws-sdk/client-dynamodb"),p=new s.DynamoDBClient({}),{TABLE_NAME:k="",RAW_MEDIA_GSI_NAME:w=""}=process.env;if(!k)throw new Error("Missing env: TABLE_NAME");if(!w)throw new Error("Missing env: RAW_MEDIA_GSI_NAME");var r=e=>({S:e});function I(e){try{return decodeURIComponent(e.replace(/\+/g," "))}catch{return e}}var K=async e=>{console.log("[bg-worker] incoming event:",JSON.stringify(e,null,2));for(let n of e.Records??[]){let t=n.s3.bucket.name,i=n.s3.object.key,o=I(i);console.log(`[bg-worker] processing object: s3://${t}/${o}`);let a=await p.send(new s.QueryCommand({TableName:k,IndexName:w,KeyConditionExpression:"rawMediaKey = :k",ExpressionAttributeValues:{":k":r(o)},Limit:1}));if(!a.Items||a.Items.length===0){console.log(`[bg-worker] no matching item for rawMediaKey=${o}, skipping`);continue}let c=a.Items[0],d=c.id?.S,m=c.pk?.S||(d?`ITEM#${d}`:void 0),g=c.sk?.S||"META";if(!m||!g){console.warn("[bg-worker] found item but missing pk/sk:",JSON.stringify(c));continue}let y=new Date().toISOString(),l=o;console.log(`[bg-worker] updating item id=${d} pk=${m} sk=${g} with mediaKey=${l}`),await p.send(new s.UpdateItemCommand({TableName:k,Key:{pk:r(m),sk:r(g)},UpdateExpression:"SET mediaKey = :m, updatedAt = :u",ExpressionAttributeValues:{":m":r(l),":u":r(y)}})),console.log(`[bg-worker] successfully updated item for rawMediaKey=${o}`)}return{ok:!0}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
