{
  "version": 3,
  "sources": ["../../lambda/closet/bg-worker.ts"],
  "sourcesContent": ["// lambda/closet/bg-worker.ts\r\nimport {\r\n  DynamoDBClient,\r\n  QueryCommand,\r\n  UpdateItemCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport { S3Event } from \"aws-lambda\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\n\r\nconst { TABLE_NAME = \"\", RAW_MEDIA_GSI_NAME = \"\" } = process.env;\r\n\r\nif (!TABLE_NAME) {\r\n  throw new Error(\"Missing env: TABLE_NAME\");\r\n}\r\nif (!RAW_MEDIA_GSI_NAME) {\r\n  throw new Error(\"Missing env: RAW_MEDIA_GSI_NAME\");\r\n}\r\n\r\nconst S = (v: string) => ({ S: v });\r\n\r\nfunction decodeKey(raw: string): string {\r\n  // S3 event keys are URL-encoded and spaces become '+'\r\n  try {\r\n    return decodeURIComponent(raw.replace(/\\+/g, \" \"));\r\n  } catch {\r\n    return raw;\r\n  }\r\n}\r\n\r\nexport const handler = async (event: S3Event) => {\r\n  console.log(\"[bg-worker] incoming event:\", JSON.stringify(event, null, 2));\r\n\r\n  for (const record of event.Records ?? []) {\r\n    const bucket = record.s3.bucket.name;\r\n    const rawKey = record.s3.object.key;\r\n    const key = decodeKey(rawKey);\r\n\r\n    console.log(`[bg-worker] processing object: s3://${bucket}/${key}`);\r\n\r\n    // 1) Look up the closet item by rawMediaKey via GSI\r\n    const q = await ddb.send(\r\n      new QueryCommand({\r\n        TableName: TABLE_NAME,\r\n        IndexName: RAW_MEDIA_GSI_NAME,\r\n        KeyConditionExpression: \"rawMediaKey = :k\",\r\n        ExpressionAttributeValues: {\r\n          \":k\": S(key),\r\n        },\r\n        Limit: 1,\r\n      }),\r\n    );\r\n\r\n    if (!q.Items || q.Items.length === 0) {\r\n      console.log(\r\n        `[bg-worker] no matching item for rawMediaKey=${key}, skipping`,\r\n      );\r\n      continue;\r\n    }\r\n\r\n    const item = q.Items[0];\r\n    const id = item.id?.S;\r\n    const pk = item.pk?.S || (id ? `ITEM#${id}` : undefined);\r\n    const sk = item.sk?.S || \"META\";\r\n\r\n    if (!pk || !sk) {\r\n      console.warn(\r\n        \"[bg-worker] found item but missing pk/sk:\",\r\n        JSON.stringify(item),\r\n      );\r\n      continue;\r\n    }\r\n\r\n    const now = new Date().toISOString();\r\n\r\n    // 2) FUTURE: call remove.bg or your external service here.\r\n    //    For now we simply mark mediaKey = rawMediaKey so the UI\r\n    //    can flip from \"processing bg\" \u2192 \"ready to review\".\r\n    const mediaKey = key;\r\n\r\n    console.log(\r\n      `[bg-worker] updating item id=${id} pk=${pk} sk=${sk} with mediaKey=${mediaKey}`,\r\n    );\r\n\r\n    await ddb.send(\r\n      new UpdateItemCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: { pk: S(pk), sk: S(sk) },\r\n        UpdateExpression: \"SET mediaKey = :m, updatedAt = :u\",\r\n        ExpressionAttributeValues: {\r\n          \":m\": S(mediaKey),\r\n          \":u\": S(now),\r\n        },\r\n      }),\r\n    );\r\n\r\n    console.log(\r\n      `[bg-worker] successfully updated item for rawMediaKey=${key}`,\r\n    );\r\n  }\r\n\r\n  return { ok: true };\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GACA,IAAAI,EAIO,oCAGDC,EAAM,IAAI,iBAAe,CAAC,CAAC,EAE3B,CAAE,WAAAC,EAAa,GAAI,mBAAAC,EAAqB,EAAG,EAAI,QAAQ,IAE7D,GAAI,CAACD,EACH,MAAM,IAAI,MAAM,yBAAyB,EAE3C,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,iCAAiC,EAGnD,IAAMC,EAAKC,IAAe,CAAE,EAAGA,CAAE,GAEjC,SAASC,EAAUC,EAAqB,CAEtC,GAAI,CACF,OAAO,mBAAmBA,EAAI,QAAQ,MAAO,GAAG,CAAC,CACnD,MAAQ,CACN,OAAOA,CACT,CACF,CAEO,IAAMT,EAAU,MAAOU,GAAmB,CAC/C,QAAQ,IAAI,8BAA+B,KAAK,UAAUA,EAAO,KAAM,CAAC,CAAC,EAEzE,QAAWC,KAAUD,EAAM,SAAW,CAAC,EAAG,CACxC,IAAME,EAASD,EAAO,GAAG,OAAO,KAC1BE,EAASF,EAAO,GAAG,OAAO,IAC1BG,EAAMN,EAAUK,CAAM,EAE5B,QAAQ,IAAI,uCAAuCD,CAAM,IAAIE,CAAG,EAAE,EAGlE,IAAMC,EAAI,MAAMZ,EAAI,KAClB,IAAI,eAAa,CACf,UAAWC,EACX,UAAWC,EACX,uBAAwB,mBACxB,0BAA2B,CACzB,KAAMC,EAAEQ,CAAG,CACb,EACA,MAAO,CACT,CAAC,CACH,EAEA,GAAI,CAACC,EAAE,OAASA,EAAE,MAAM,SAAW,EAAG,CACpC,QAAQ,IACN,gDAAgDD,CAAG,YACrD,EACA,QACF,CAEA,IAAME,EAAOD,EAAE,MAAM,CAAC,EAChBE,EAAKD,EAAK,IAAI,EACdE,EAAKF,EAAK,IAAI,IAAMC,EAAK,QAAQA,CAAE,GAAK,QACxCE,EAAKH,EAAK,IAAI,GAAK,OAEzB,GAAI,CAACE,GAAM,CAACC,EAAI,CACd,QAAQ,KACN,4CACA,KAAK,UAAUH,CAAI,CACrB,EACA,QACF,CAEA,IAAMI,EAAM,IAAI,KAAK,EAAE,YAAY,EAK7BC,EAAWP,EAEjB,QAAQ,IACN,gCAAgCG,CAAE,OAAOC,CAAE,OAAOC,CAAE,kBAAkBE,CAAQ,EAChF,EAEA,MAAMlB,EAAI,KACR,IAAI,oBAAkB,CACpB,UAAWC,EACX,IAAK,CAAE,GAAIE,EAAEY,CAAE,EAAG,GAAIZ,EAAEa,CAAE,CAAE,EAC5B,iBAAkB,oCAClB,0BAA2B,CACzB,KAAMb,EAAEe,CAAQ,EAChB,KAAMf,EAAEc,CAAG,CACb,CACF,CAAC,CACH,EAEA,QAAQ,IACN,yDAAyDN,CAAG,EAC9D,CACF,CAEA,MAAO,CAAE,GAAI,EAAK,CACpB",
  "names": ["bg_worker_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "ddb", "TABLE_NAME", "RAW_MEDIA_GSI_NAME", "S", "v", "decodeKey", "raw", "event", "record", "bucket", "rawKey", "key", "q", "item", "id", "pk", "sk", "now", "mediaKey"]
}
