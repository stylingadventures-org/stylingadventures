{
  "version": 3,
  "sources": ["../../lambda/thumb-head/index.ts"],
  "sourcesContent": ["import type {\r\n  APIGatewayProxyEventV2,\r\n  APIGatewayProxyResultV2,\r\n} from \"aws-lambda\";\r\nimport { S3Client, HeadObjectCommand } from \"@aws-sdk/client-s3\";\r\n\r\n/** S3 */\r\nconst s3 = new S3Client({\r\n  region: process.env.AWS_REGION || \"us-east-1\",\r\n});\r\nconst BUCKET = process.env.BUCKET || \"\";\r\n\r\n/** CORS allow-list */\r\nconst ALLOWED_ORIGINS: string[] = String(process.env.ALLOWED_ORIGINS || \"\")\r\n  .split(\",\")\r\n  .map((s) => s.trim())\r\n  .filter(Boolean);\r\n\r\n/** Optional single-origin fallback for back-compat */\r\nconst FALLBACK_ORIGIN = (process.env.WEB_ORIGIN || \"\").trim();\r\n\r\n/** pick an allowed origin for the response */\r\nfunction pickAllowedOrigin(event: APIGatewayProxyEventV2): string | undefined {\r\n  const req =\r\n    (event.headers?.origin as string) ||\r\n    (event.headers?.Origin as string) ||\r\n    \"\";\r\n  if (ALLOWED_ORIGINS.length > 0) {\r\n    return ALLOWED_ORIGINS.includes(req) ? req : undefined;\r\n  }\r\n  return FALLBACK_ORIGIN || undefined;\r\n}\r\n\r\n/** shared headers */\r\nfunction baseHeaders(origin?: string): Record<string, string> {\r\n  const h: Record<string, string> = {\r\n    \"Content-Type\": \"application/json\",\r\n    \"Access-Control-Allow-Headers\":\r\n      \"authorization,Authorization,Content-Type,X-Amz-Date,X-Api-Key,X-Amz-Security-Token\",\r\n    \"Access-Control-Allow-Methods\": \"GET,HEAD,OPTIONS\",\r\n    \"Access-Control-Allow-Credentials\": \"true\",\r\n    \"Cache-Control\": \"private, max-age=2\",\r\n    Vary: \"Origin\",\r\n  };\r\n  if (origin) h[\"Access-Control-Allow-Origin\"] = origin;\r\n  return h;\r\n}\r\n\r\n/** Convert a *source* key (users/..../file.ext) to its thumb key (thumbs/..../file.jpg) */\r\nfunction toThumbKey(srcKey: string): string {\r\n  const decoded = decodeURIComponent(String(srcKey));\r\n  const safe = decoded.replace(/^[/\\\\]+/, \"\").replace(/\\.\\./g, \"\");\r\n  if (safe.startsWith(\"thumbs/\")) return safe;\r\n  return `thumbs/${safe.replace(/\\.[^.]+$/, \".jpg\")}`;\r\n}\r\n\r\nexport const handler = async (\r\n  event: APIGatewayProxyEventV2\r\n): Promise<APIGatewayProxyResultV2> => {\r\n  const origin = pickAllowedOrigin(event);\r\n  const method =\r\n    event.requestContext?.http?.method || (event as any).httpMethod || \"GET\";\r\n\r\n  // --- CORS preflight ---\r\n  if (method === \"OPTIONS\") {\r\n    const hadReqOrigin = !!(\r\n      event.headers?.origin || event.headers?.Origin\r\n    );\r\n    if (hadReqOrigin && !origin) {\r\n      // preflight from non-allowed origin\r\n      return { statusCode: 403, headers: baseHeaders(undefined), body: \"\" };\r\n    }\r\n    return { statusCode: 204, headers: baseHeaders(origin), body: \"\" };\r\n  }\r\n\r\n  // Safety checks\r\n  if (!BUCKET) {\r\n    return {\r\n      statusCode: 500,\r\n      headers: baseHeaders(origin),\r\n      body: JSON.stringify({ message: \"Missing BUCKET env var\" }),\r\n    };\r\n  }\r\n\r\n  const rawKey = event.queryStringParameters?.key || \"\";\r\n  if (!rawKey) {\r\n    return {\r\n      statusCode: 400,\r\n      headers: baseHeaders(origin),\r\n      body: JSON.stringify({ message: \"Missing key\" }),\r\n    };\r\n  }\r\n\r\n  const thumbKey = toThumbKey(rawKey);\r\n\r\n  try {\r\n    await s3.send(new HeadObjectCommand({ Bucket: BUCKET, Key: thumbKey }));\r\n\r\n    // HEAD => just the status\r\n    if (method === \"HEAD\") {\r\n      return { statusCode: 204, headers: baseHeaders(origin), body: \"\" };\r\n    }\r\n\r\n    // GET => structured response for polling\r\n    return {\r\n      statusCode: 200,\r\n      headers: baseHeaders(origin),\r\n      body: JSON.stringify({ ready: true, key: thumbKey }),\r\n    };\r\n  } catch {\r\n    // Not found yet\r\n    if (method === \"HEAD\") {\r\n      return { statusCode: 404, headers: baseHeaders(origin), body: \"\" };\r\n    }\r\n    return {\r\n      statusCode: 200,\r\n      headers: baseHeaders(origin),\r\n      body: JSON.stringify({ ready: false, key: thumbKey }),\r\n    };\r\n  }\r\n};\r\n\r\n\r\n\r\n\r\n\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAIA,IAAAI,EAA4C,8BAGtCC,EAAK,IAAI,WAAS,CACtB,OAAQ,QAAQ,IAAI,YAAc,WACpC,CAAC,EACKC,EAAS,QAAQ,IAAI,QAAU,GAG/BC,EAA4B,OAAO,QAAQ,IAAI,iBAAmB,EAAE,EACvE,MAAM,GAAG,EACT,IAAKC,GAAMA,EAAE,KAAK,CAAC,EACnB,OAAO,OAAO,EAGXC,GAAmB,QAAQ,IAAI,YAAc,IAAI,KAAK,EAG5D,SAASC,EAAkBC,EAAmD,CAC5E,IAAMC,EACHD,EAAM,SAAS,QACfA,EAAM,SAAS,QAChB,GACF,OAAIJ,EAAgB,OAAS,EACpBA,EAAgB,SAASK,CAAG,EAAIA,EAAM,OAExCH,GAAmB,MAC5B,CAGA,SAASI,EAAYC,EAAyC,CAC5D,IAAMC,EAA4B,CAChC,eAAgB,mBAChB,+BACE,qFACF,+BAAgC,mBAChC,mCAAoC,OACpC,gBAAiB,qBACjB,KAAM,QACR,EACA,OAAID,IAAQC,EAAE,6BAA6B,EAAID,GACxCC,CACT,CAGA,SAASC,EAAWC,EAAwB,CAE1C,IAAMC,EADU,mBAAmB,OAAOD,CAAM,CAAC,EAC5B,QAAQ,UAAW,EAAE,EAAE,QAAQ,QAAS,EAAE,EAC/D,OAAIC,EAAK,WAAW,SAAS,EAAUA,EAChC,UAAUA,EAAK,QAAQ,WAAY,MAAM,CAAC,EACnD,CAEO,IAAMhB,EAAU,MACrBS,GACqC,CACrC,IAAMG,EAASJ,EAAkBC,CAAK,EAChCQ,EACJR,EAAM,gBAAgB,MAAM,QAAWA,EAAc,YAAc,MAGrE,GAAIQ,IAAW,UAIb,MAHqB,CAAC,EACpBR,EAAM,SAAS,QAAUA,EAAM,SAAS,SAEtB,CAACG,EAEZ,CAAE,WAAY,IAAK,QAASD,EAAY,MAAS,EAAG,KAAM,EAAG,EAE/D,CAAE,WAAY,IAAK,QAASA,EAAYC,CAAM,EAAG,KAAM,EAAG,EAInE,GAAI,CAACR,EACH,MAAO,CACL,WAAY,IACZ,QAASO,EAAYC,CAAM,EAC3B,KAAM,KAAK,UAAU,CAAE,QAAS,wBAAyB,CAAC,CAC5D,EAGF,IAAMM,EAAST,EAAM,uBAAuB,KAAO,GACnD,GAAI,CAACS,EACH,MAAO,CACL,WAAY,IACZ,QAASP,EAAYC,CAAM,EAC3B,KAAM,KAAK,UAAU,CAAE,QAAS,aAAc,CAAC,CACjD,EAGF,IAAMO,EAAWL,EAAWI,CAAM,EAElC,GAAI,CAIF,OAHA,MAAMf,EAAG,KAAK,IAAI,oBAAkB,CAAE,OAAQC,EAAQ,IAAKe,CAAS,CAAC,CAAC,EAGlEF,IAAW,OACN,CAAE,WAAY,IAAK,QAASN,EAAYC,CAAM,EAAG,KAAM,EAAG,EAI5D,CACL,WAAY,IACZ,QAASD,EAAYC,CAAM,EAC3B,KAAM,KAAK,UAAU,CAAE,MAAO,GAAM,IAAKO,CAAS,CAAC,CACrD,CACF,MAAQ,CAEN,OAAIF,IAAW,OACN,CAAE,WAAY,IAAK,QAASN,EAAYC,CAAM,EAAG,KAAM,EAAG,EAE5D,CACL,WAAY,IACZ,QAASD,EAAYC,CAAM,EAC3B,KAAM,KAAK,UAAU,CAAE,MAAO,GAAO,IAAKO,CAAS,CAAC,CACtD,CACF,CACF",
  "names": ["thumb_head_exports", "__export", "handler", "__toCommonJS", "import_client_s3", "s3", "BUCKET", "ALLOWED_ORIGINS", "s", "FALLBACK_ORIGIN", "pickAllowedOrigin", "event", "req", "baseHeaders", "origin", "h", "toThumbKey", "srcKey", "safe", "method", "rawKey", "thumbKey"]
}
