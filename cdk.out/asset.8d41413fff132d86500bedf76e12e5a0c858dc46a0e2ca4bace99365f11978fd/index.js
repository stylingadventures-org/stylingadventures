"use strict";var b=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var f=(t,e)=>{for(var r in e)b(t,r,{get:e[r],enumerable:!0})},L=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of x(e))!w.call(t,s)&&s!==r&&b(t,s,{get:()=>e[s],enumerable:!(n=N(e,s))||n.enumerable});return t};var I=t=>L(b({},"__esModule",{value:!0}),t);var D={};f(D,{handler:()=>k});module.exports=I(D);var g=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb");var l=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!l)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var m=a.DynamoDBDocumentClient.from(new g.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}});function S(t){let e=t?.groups;return Array.isArray(e)&&e.includes("ADMIN")}function R(t,e){if(!e?.sub)throw new Error("Unauthenticated");if(!S(e)&&e.sub!==t)throw new Error("Forbidden")}function _(t){if(t==null)return null;if(typeof t=="string")try{return JSON.parse(t)}catch{return{raw:t}}return typeof t=="object"?t:{value:t}}function E(t){let e=1,r=100,n=t;for(;n>=r;)n-=r,e++,r+=50;return e}function y(t,e=12){return Math.max(0,t|0).toString().padStart(e,"0")}var k=async t=>{let{fieldName:e}=t.info,r=t.identity;if(e==="getMyProfile"){if(!r?.sub)throw new Error("Unauthenticated");let n=r.sub,s=await m.send(new a.GetCommand({TableName:l,Key:{pk:`USER#${n}`,sk:"PROFILE"}})),o=Number(s.Item?.xp??0);return{userId:n,displayName:s.Item?.displayName||null,level:E(o),xp:o,coins:Number(s.Item?.coins??0),badges:Array.isArray(s.Item?.badges)?s.Item.badges:[],lastEventAt:s.Item?.lastEventAt??null}}if(e==="setDisplayName"){if(!r?.sub)throw new Error("Unauthenticated");let n=r.sub,o=(t.arguments?.displayName||"").trim().slice(0,40),i=await m.send(new a.UpdateCommand({TableName:l,Key:{pk:`USER#${n}`,sk:"PROFILE"},UpdateExpression:"SET displayName = :n, updatedAt = :u, xp = if_not_exists(xp,:z), coins = if_not_exists(coins,:z)",ExpressionAttributeValues:{":n":o,":u":new Date().toISOString(),":z":0},ReturnValues:"ALL_NEW"})),u=Number(i.Attributes?.xp??0);return{userId:n,displayName:i.Attributes?.displayName||null,level:E(u),xp:u,coins:Number(i.Attributes?.coins??0),badges:Array.isArray(i.Attributes?.badges)?i.Attributes.badges:[],lastEventAt:i.Attributes?.lastEventAt??null}}if(e==="logGameEvent"){if(!r?.sub)throw new Error("Unauthenticated");let n=r.sub,s=new Date().toISOString(),o=t.arguments?.input??{},i=o.type||"UNKNOWN",u=_(o.metadata),p=i==="LEVEL_CLEAR"?50:i==="DAILY_LOGIN"?10:i==="SHARE"?5:i==="STYLE_IT"?Math.max(1,Math.round((u?.score??5)/5)):1,d=i==="LEVEL_CLEAR"?5:i==="DAILY_LOGIN"?1:0,c=await m.send(new a.UpdateCommand({TableName:l,Key:{pk:`USER#${n}`,sk:"PROFILE"},UpdateExpression:`
        SET xp = if_not_exists(xp,:z) + :xi,
            coins = if_not_exists(coins,:z) + :ci,
            lastEventAt = :now
      `.replace(/\s+/g," "),ExpressionAttributeValues:{":z":0,":xi":p,":ci":d,":now":s},ReturnValues:"ALL_NEW"})),A=Number(c.Attributes?.xp??0);return await m.send(new a.PutCommand({TableName:l,Item:{pk:`USER#${n}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${y(A)}#${n}`,xp:A,coins:Number(c.Attributes?.coins??0),updatedAt:s,type:"LEADER"}})),await m.send(new a.PutCommand({TableName:l,Item:{pk:`USER#${n}`,sk:`EVENT#${Date.now()}`,type:"EVENT",evType:i,metadata:u,at:s},ConditionExpression:"attribute_not_exists(pk)"})).catch(()=>{}),{userId:n,displayName:c.Attributes?.displayName||null,level:E(A),xp:A,coins:Number(c.Attributes?.coins??0),badges:Array.isArray(c.Attributes?.badges)?c.Attributes.badges:[],lastEventAt:c.Attributes?.lastEventAt??s}}if(e==="awardCoins"){let{userId:n,coins:s,xp:o}=t.arguments.input;R(n,r);let i=Math.max(0,s|0),u=Math.max(0,(o??0)|0),p=await m.send(new a.UpdateCommand({TableName:l,Key:{pk:`USER#${n}`,sk:"PROFILE"},UpdateExpression:"SET coins = if_not_exists(coins,:z) + :c, xp = if_not_exists(xp,:z) + :x",ExpressionAttributeValues:{":z":0,":c":i,":x":u},ReturnValues:"ALL_NEW"})),d=Number(p.Attributes?.xp??0);return await m.send(new a.PutCommand({TableName:l,Item:{pk:`USER#${n}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${y(d)}#${n}`,xp:d,coins:Number(p.Attributes?.coins??0),updatedAt:new Date().toISOString(),type:"LEADER"}})),{userId:n,displayName:p.Attributes?.displayName||null,level:E(d),xp:d,coins:Number(p.Attributes?.coins??0),badges:Array.isArray(p.Attributes?.badges)?p.Attributes.badges:[],lastEventAt:p.Attributes?.lastEventAt??null}}if(e==="topXP"){let n=Math.max(1,Math.min(100,Number(t.arguments?.limit??10))),o=(await m.send(new a.QueryCommand({TableName:l,IndexName:"gsi1",KeyConditionExpression:"gsi1pk = :p",ExpressionAttributeValues:{":p":"LEADERBOARD#GLOBAL"},ScanIndexForward:!1,Limit:n}))).Items??[];return await Promise.all(o.map(async(u,p)=>{let d=u.pk.replace("USER#",""),c;try{c=(await m.send(new a.GetCommand({TableName:l,Key:{pk:`USER#${d}`,sk:"PROFILE"},ProjectionExpression:"displayName"}))).Item?.displayName}catch{}return{userId:d,displayName:c,xp:Number(u.xp??0),coins:Number(u.coins??0),rank:p+1}}))}throw new Error(`Unknown field ${e}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
