"use strict";var M=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var z=Object.prototype.hasOwnProperty;var q=(e,t)=>{for(var o in t)M(e,o,{get:t[o],enumerable:!0})},$=(e,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of G(t))!z.call(e,s)&&s!==o&&M(e,s,{get:()=>t[s],enumerable:!(n=v(t,s))||n.enumerable});return e};var J=e=>$(M({},"__esModule",{value:!0}),e);var ke={};q(ke,{handler:()=>fe});module.exports=J(ke);var u=require("@aws-sdk/client-dynamodb"),N=require("@aws-sdk/client-sfn"),P=require("@aws-sdk/client-eventbridge"),T=require("@aws-sdk/util-dynamodb"),R=require("crypto"),a=e=>(0,T.marshall)(e,{removeUndefinedValues:!0}),c=process.env.TABLE_NAME,V=process.env.APPROVAL_SM_ARN||"",he=process.env.FAN_APPROVAL_SM_ARN||V,Y=process.env.BESTIE_AUTOPUBLISH_SM_ARN||V,Q=process.env.BG_CHANGE_SM_ARN,X=process.env.STORY_PUBLISH_SM_ARN,j=process.env.STATUS_GSI??"gsi1",m=new u.DynamoDBClient({}),D=new N.SFNClient({}),Z=new P.EventBridgeClient({});function O(e){let t=e?.claims||{},o=t.tier??t["custom:tier"];if(o&&["FREE","BESTIE","CREATOR","COLLAB","ADMIN","PRIME"].includes(o))return o;let s=t["cognito:groups"],r=Array.isArray(s)?s:String(s||"").split(",").map(i=>i.trim()).filter(Boolean);return r.includes("ADMIN")?"ADMIN":r.includes("PRIME")?"PRIME":r.includes("CREATOR")?"CREATOR":r.includes("COLLAB")?"COLLAB":r.includes("BESTIE")?"BESTIE":"FREE"}function F(e){if(!e?.sub)throw new Error("Unauthenticated")}function ee(e){if(F(e),O(e)==="FREE")throw new Error("This is a Bestie feature. Upgrade to unlock your closet.")}function S(e){return ee(e),O(e)}function C(){return new Date().toISOString()}function w(e){return`USER#${e}`}function y(e){return`CLOSET#${e}`}function B(e){return`STORY#${e}`}function L(e){return`CLOSET#${e}`}function K(e){return`CLOSET#STATUS#${e}`}function te(e){if(typeof e=="string")return e.startsWith("CLOSET#")?e.slice(7)||void 0:e}async function h(e){try{await Z.send(new P.PutEventsCommand({Entries:[{Source:"stylingadventures.besties",DetailType:"BestieEngagement",Detail:JSON.stringify(e)}]}))}catch(t){console.error("Failed to put engagement event",t)}}function A(e){let t=(0,T.unmarshall)(e),o=t.id??te(t.sk)??(0,R.randomUUID)(),n=typeof t.pk=="string"&&t.pk.startsWith("USER#")?t.pk.slice(5):void 0,s=t.userId??t.ownerSub??n??"UNKNOWN",r=t.ownerSub??t.userId??n??"UNKNOWN",i=t.createdAt??t.updatedAt??new Date(0).toISOString(),d=t.updatedAt??i,I=t.status??"DRAFT";return{id:o,userId:s,ownerSub:r,status:I,createdAt:i,updatedAt:d,mediaKey:t.mediaKey,rawMediaKey:t.rawMediaKey,title:t.title,reason:t.reason,audience:t.audience,category:t.category,subcategory:t.subcategory,storyTitle:t.storyTitle,storySeason:t.storySeason,storyVibes:t.storyVibes,pinned:t.pinned,pendingBackgroundKey:t.pendingBackgroundKey,backgroundStatus:t.backgroundStatus??null,inCommunityFeed:t.inCommunityFeed,favoriteCount:t.favoriteCount,likeCount:t.likeCount,commentCount:t.commentCount,wishlistCount:t.wishlistCount,viewerHasFaved:t.viewerHasFaved,viewerHasLiked:t.viewerHasLiked,viewerHasWishlisted:t.viewerHasWishlisted}}function E(e){return F(e),e.sub}function U(e){let o=(e?.claims||{})["cognito:groups"],n=Array.isArray(o)?o:String(o||"").split(",").map(s=>s.trim()).filter(Boolean);return n.includes("ADMIN")||n.includes("COLLAB")}async function H(e){if(F(e),O(e)==="FREE")return{items:[],nextToken:null};let o=e.sub;return{items:((await m.send(new u.QueryCommand({TableName:c,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:a({":pk":w(o),":sk":"CLOSET#"})}))).Items??[]).map(A).filter(r=>r.id&&r.id!=="undefined"),nextToken:null}}async function ne(e,t){S(t);let n=(await H(t)).items,s=e.limit&&e.limit>0?Math.min(e.limit,n.length):n.length;return{items:n.slice(0,s),nextToken:null}}async function se(e,t){S(t);let o=E(t),n=(0,R.randomUUID)(),s=C(),r=e.input,i={id:n,userId:o,ownerSub:o,status:"DRAFT",createdAt:s,updatedAt:s,mediaKey:r.mediaKey??void 0,rawMediaKey:r.rawMediaKey??void 0,title:r.title??void 0,category:r.category??null,subcategory:r.subcategory??null,audience:r.audience??"PRIVATE",backgroundStatus:r.rawMediaKey?"PROCESSING":null};return await m.send(new u.PutItemCommand({TableName:c,Item:a({pk:w(o),sk:y(n),gsi1pk:K(i.status),gsi1sk:s,rawMediaKey:i.rawMediaKey,...i})})),i}async function oe(e,t){S(t);let o=E(t),n=C(),s=await m.send(new u.UpdateItemCommand({TableName:c,Key:a({pk:w(o),sk:y(e.closetItemId)}),UpdateExpression:"SET mediaKey = :mediaKey, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:a({":mediaKey":e.mediaKey,":updatedAt":n,":gsi1pk":K("DRAFT"),":gsi1sk":n}),ReturnValues:"ALL_NEW"}));if(!s.Attributes)throw new Error("Item not found");return A(s.Attributes)}async function re(e,t){S(t);let o=E(t),n=C(),s=await m.send(new u.UpdateItemCommand({TableName:c,Key:a({pk:w(o),sk:y(e.closetItemId)}),ConditionExpression:"status = :draft",UpdateExpression:"SET status = :pending, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:a({":draft":"DRAFT",":pending":"PENDING",":updatedAt":n,":gsi1pk":K("PENDING"),":gsi1sk":n}),ReturnValues:"ALL_NEW"}));if(!s.Attributes)throw new Error("Item not found or not in DRAFT status");let r=A(s.Attributes),i=r.rawMediaKey||r.mediaKey;if(!i)throw new Error("Cannot request approval: missing rawMediaKey/mediaKey");let d=Y||V;if(!d)throw new Error("Missing env: BESTIE_AUTOPUBLISH_SM_ARN (or APPROVAL_SM_ARN)");return await D.send(new N.StartExecutionCommand({stateMachineArn:d,input:JSON.stringify({item:{id:r.id,userId:r.userId,ownerSub:r.ownerSub,s3Key:i}})})),r}async function ie(e,t){S(t);let o=E(t),{closetItemId:n,story:s}=e,r=C(),i=await m.send(new u.UpdateItemCommand({TableName:c,Key:a({pk:w(o),sk:y(n)}),UpdateExpression:"SET storyTitle = :storyTitle, updatedAt = :updatedAt",ExpressionAttributeValues:a({":storyTitle":s,":updatedAt":r}),ReturnValues:"ALL_NEW"}));if(!i.Attributes)throw new Error("Item not found");return A(i.Attributes)}async function k(e){let o=((await m.send(new u.ScanCommand({TableName:c,FilterExpression:"sk = :sk",ExpressionAttributeValues:a({":sk":y(e)})}))).Items??[])[0];if(!o)throw new Error("Closet item not found");let n=A(o),s=n.userId;if(!s)throw new Error("Closet item missing owner");return{base:n,ownerId:s}}async function ae(e,t){let o=E(t),{closetItemId:n}=e,s=C(),{ownerId:r}=await k(n),i={pk:L(n),sk:`LIKE#${o}`,entityType:"LIKE",itemOwnerSub:r,likerSub:o,createdAt:s};try{await m.send(new u.PutItemCommand({TableName:c,Item:a(i),ConditionExpression:"attribute_not_exists(sk)"}))}catch(l){if(l?.name!=="ConditionalCheckFailedException")throw l}let d=await m.send(new u.UpdateItemCommand({TableName:c,Key:a({pk:w(r),sk:y(n)}),UpdateExpression:"SET likeCount = if_not_exists(likeCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:a({":zero":0,":one":1,":now":s}),ReturnValues:"ALL_NEW"}));if(!d.Attributes)throw new Error("Closet item not found");let I=A(d.Attributes);return I.viewerHasLiked=!0,await h({action:"LIKED",closetItemId:n,ownerSub:r,actorSub:o,delta:1}),I}async function ue(e,t){let o=E(t),{closetItemId:n,text:s}=e,r=C(),i=(0,R.randomUUID)(),{ownerId:d}=await k(n),I={pk:L(n),sk:`COMMENT#${i}`,entityType:"COMMENT",closetItemId:n,itemOwnerSub:d,authorSub:o,text:s,createdAt:r};return await m.send(new u.PutItemCommand({TableName:c,Item:a(I)})),await m.send(new u.UpdateItemCommand({TableName:c,Key:a({pk:w(d),sk:y(n)}),UpdateExpression:"SET commentCount = if_not_exists(commentCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:a({":zero":0,":one":1,":now":r})})),await h({action:"COMMENTED",closetItemId:n,ownerSub:d,actorSub:o,commentId:i,commentText:s}),{id:i,closetItemId:n,authorSub:o,text:s,createdAt:r}}async function de(e,t){S(t);let o=E(t),n=U(t),s=e.closetItemId,r=!!e.pinned;if(!s)throw new Error("closetItemId is required");let{base:i}=await k(s);if(!n&&i.userId!==o)throw new Error("Not authorized to pin this closet item.");let d=C(),I=await m.send(new u.UpdateItemCommand({TableName:c,Key:a({pk:w(i.userId),sk:y(i.id)}),UpdateExpression:"SET pinned = :pinned, updatedAt = :now",ExpressionAttributeValues:a({":pinned":r,":now":d}),ReturnValues:"ALL_NEW"}));if(!I.Attributes)throw new Error("Closet item not found after update");return A(I.Attributes)}async function W(e){let{closetItemId:t}=e;return((await m.send(new u.QueryCommand({TableName:c,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:a({":pk":L(t),":sk":"COMMENT#"})}))).Items??[]).map(s=>(0,T.unmarshall)(s)).map(s=>({id:s.sk.replace("COMMENT#",""),closetItemId:s.closetItemId,authorSub:s.authorSub,text:s.text,createdAt:s.createdAt}))}async function le(e){let{closetItemId:t}=e;return((await m.send(new u.QueryCommand({TableName:c,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:a({":pk":L(t),":sk":"LIKE#"})}))).Items??[]).map(s=>(0,T.unmarshall)(s)).map(s=>({closetItemId:t,likerSub:s.likerSub,createdAt:s.createdAt}))}async function ce(e){return W(e)}async function me(e,t){S(t);let o=E(t),{closetItemId:n,on:s}=e,r=C(),{ownerId:i}=await k(n),d=w(o),I=`WISHLIST#${n}`;if(s===!1){await m.send(new u.DeleteItemCommand({TableName:c,Key:a({pk:d,sk:I})}));let p;try{let g=await m.send(new u.UpdateItemCommand({TableName:c,Key:a({pk:w(i),sk:y(n)}),UpdateExpression:"SET wishlistCount = if_not_exists(wishlistCount, :zero) - :one, updatedAt = :now",ConditionExpression:"wishlistCount >= :one",ExpressionAttributeValues:a({":zero":0,":one":1,":now":r}),ReturnValues:"ALL_NEW"}));g.Attributes&&(p=A(g.Attributes))}catch(g){if(g?.name!=="ConditionalCheckFailedException")throw g;let x=((await m.send(new u.QueryCommand({TableName:c,KeyConditionExpression:"pk = :pk AND sk = :sk",ExpressionAttributeValues:a({":pk":w(i),":sk":y(n)})}))).Items??[])[0];x&&(p=A(x))}if(!p)throw new Error("Closet item not found");return p.viewerHasWishlisted=!1,await h({action:"WISHLIST_TOGGLED",closetItemId:n,ownerSub:i,actorSub:o,delta:-1}),p}let l={pk:d,sk:I,entityType:"WISHLIST",closetItemId:n,ownerSub:i,viewerSub:o,createdAt:r};try{await m.send(new u.PutItemCommand({TableName:c,Item:a(l),ConditionExpression:"attribute_not_exists(sk)"}))}catch(p){if(p?.name!=="ConditionalCheckFailedException")throw p}let b=await m.send(new u.UpdateItemCommand({TableName:c,Key:a({pk:w(i),sk:y(n)}),UpdateExpression:"SET wishlistCount = if_not_exists(wishlistCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:a({":zero":0,":one":1,":now":r}),ReturnValues:"ALL_NEW"}));if(!b.Attributes)throw new Error("Closet item not found");let f=A(b.Attributes);return f.viewerHasWishlisted=!0,await h({action:"WISHLIST_TOGGLED",closetItemId:n,ownerSub:i,actorSub:o,delta:1}),f}async function Ie(e){if(F(e),O(e)==="FREE")return{items:[],nextToken:null};let o=e.sub,s=((await m.send(new u.QueryCommand({TableName:c,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:a({":pk":w(o),":sk":"WISHLIST#"})}))).Items??[]).map(l=>(0,T.unmarshall)(l));if(!s.length)return{items:[],nextToken:null};let r=s.map(l=>({pk:w(l.ownerSub),sk:y(l.closetItemId)})),I=((await m.send(new u.BatchGetItemCommand({RequestItems:{[c]:{Keys:r.map(l=>a(l))}}}))).Responses?.[c]??[]).map(A);for(let l of I)l.viewerHasWishlisted=!0;return{items:I,nextToken:null}}async function we(e){let t=e.source||{},o=e.identity||{},n=t.userId||t.id||o?.sub;if(!n)throw new Error("Cannot resolve pinnedClosetItems: missing userId");return((await m.send(new u.QueryCommand({TableName:c,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",FilterExpression:"#pinned = :true AND #status = :published",ExpressionAttributeNames:{"#pinned":"pinned","#status":"status"},ExpressionAttributeValues:a({":pk":w(n),":sk":"CLOSET#",":true":!0,":published":"PUBLISHED"})}))).Items??[]).map(A)}async function pe(e){let t=e?.arguments||{},o=t.sort||"NEWEST",n=t.limit&&t.limit>0&&t.limit<=50?t.limit:24,s=["APPROVED","PUBLISHED"],r=[];for(let l of s){let b=await m.send(new u.QueryCommand({TableName:c,IndexName:j,KeyConditionExpression:"gsi1pk = :pk",ExpressionAttributeValues:a({":pk":K(l)}),ScanIndexForward:!1,Limit:n*2}));r.push(...(b.Items??[]).map(A))}let i=r.filter(l=>{let b=l.status==="APPROVED"||l.status==="PUBLISHED",f=l.audience??"PUBLIC";return b&&f==="PUBLIC"}),d=new Map;for(let l of i)d.has(l.id)||d.set(l.id,l);let I=Array.from(d.values());return I.sort((l,b)=>{let f=l.createdAt||"",p=b.createdAt||"";if(o==="MOST_LOVED"){let g=l.favoriteCount??0,_=b.favoriteCount??0;return _!==g?_-g:p.localeCompare(f)}return p.localeCompare(f)}),{items:I.slice(0,n),nextToken:null}}async function Ae(e,t){let o=E(t),{id:n,favoriteOn:s}=e,r=C(),{ownerId:i}=await k(n),d=L(n),I=`FAVORITE#${o}`;if(s===!1){await m.send(new u.DeleteItemCommand({TableName:c,Key:a({pk:d,sk:I})}));let p;try{let g=await m.send(new u.UpdateItemCommand({TableName:c,Key:a({pk:w(i),sk:y(n)}),UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) - :one, updatedAt = :now",ConditionExpression:"favoriteCount >= :one",ExpressionAttributeValues:a({":zero":0,":one":1,":now":r}),ReturnValues:"ALL_NEW"}));g.Attributes&&(p=A(g.Attributes))}catch(g){if(g?.name!=="ConditionalCheckFailedException")throw g;let x=((await m.send(new u.QueryCommand({TableName:c,KeyConditionExpression:"pk = :pk AND sk = :sk",ExpressionAttributeValues:a({":pk":w(i),":sk":y(n)})}))).Items??[])[0];x&&(p=A(x))}if(!p)throw new Error("Closet item not found");return p.viewerHasFaved=!1,p}let l={pk:d,sk:I,entityType:"FAVORITE",closetItemId:n,ownerSub:i,viewerSub:o,createdAt:r};try{await m.send(new u.PutItemCommand({TableName:c,Item:a(l),ConditionExpression:"attribute_not_exists(sk)"}))}catch(p){if(p?.name!=="ConditionalCheckFailedException")throw p}let b=await m.send(new u.UpdateItemCommand({TableName:c,Key:a({pk:w(i),sk:y(n)}),UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:a({":zero":0,":one":1,":now":r}),ReturnValues:"ALL_NEW"}));if(!b.Attributes)throw new Error("Closet item not found");let f=A(b.Attributes);return f.viewerHasFaved=!0,f}async function ye(e,t){S(t);let o=E(t),{closetItemId:n,requestedBackgroundKey:s,mode:r}=e,i=C(),{base:d}=await k(n);if(d.userId!==o&&!U(t))throw new Error("Not authorized to change background for this item");let I=await m.send(new u.UpdateItemCommand({TableName:c,Key:a({pk:w(d.userId),sk:y(d.id)}),UpdateExpression:"SET pendingBackgroundKey = :bg, updatedAt = :now",ExpressionAttributeValues:a({":bg":s??null,":now":i}),ReturnValues:"ALL_NEW"}));if(!I.Attributes)throw new Error("Closet item not found while setting background");let l=A(I.Attributes);return await D.send(new N.StartExecutionCommand({stateMachineArn:Q,input:JSON.stringify({closetItemId:l.id,userId:l.userId,ownerSub:l.ownerSub,requestedBackgroundKey:s??null,mode:r??"REPLACE"})})),l}async function Ce(e,t){S(t);let o=E(t),n=C(),s=(0,R.randomUUID)(),r=e.input||{},i={id:s,userId:o,ownerSub:o,title:r.title??void 0,createdAt:n,updatedAt:n,status:"DRAFT",closetItemIds:r.closetItemIds??[],scheduledAt:r.scheduledAt??null};return await m.send(new u.PutItemCommand({TableName:c,Item:a({pk:w(o),sk:B(s),entityType:"STORY",...i})})),i}async function Ee(e,t){S(t);let o=E(t),{storyId:n,scheduledAt:s}=e,r=C(),i=await m.send(new u.UpdateItemCommand({TableName:c,Key:a({pk:w(o),sk:B(n)}),UpdateExpression:"SET #status = :pending, updatedAt = :now, scheduledAt = :scheduledAt",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:a({":pending":"PENDING_PUBLISH",":now":r,":scheduledAt":s??null}),ReturnValues:"ALL_NEW"}));if(!i.Attributes)throw new Error("Story not found");let d=(0,T.unmarshall)(i.Attributes);return await D.send(new N.StartExecutionCommand({stateMachineArn:X,input:JSON.stringify({storyId:d.id,userId:d.userId,ownerSub:d.ownerSub,scheduledAt:d.scheduledAt??null})})),d}async function ge(e,t){S(t);let o=E(t),{closetItemId:n}=e,s=C(),{base:r}=await k(n);if(r.userId!==o&&!U(t))throw new Error("Not authorized to feature this item");let i=await m.send(new u.UpdateItemCommand({TableName:c,Key:a({pk:w(r.userId),sk:y(r.id)}),UpdateExpression:"SET inCommunityFeed = :true, updatedAt = :now",ExpressionAttributeValues:a({":true":!0,":now":s}),ReturnValues:"ALL_NEW"}));if(!i.Attributes)throw new Error("Closet item not found");let d=A(i.Attributes);return await h({action:"COMMUNITY_FEATURED",closetItemId:n,ownerSub:r.userId,actorSub:o}),d}async function Se(e,t){S(t);let o=E(t),{closetItemId:n}=e,s=C(),{base:r}=await k(n);if(r.userId!==o&&!U(t))throw new Error("Not authorized to unfeature this item");let i=await m.send(new u.UpdateItemCommand({TableName:c,Key:a({pk:w(r.userId),sk:y(r.id)}),UpdateExpression:"SET inCommunityFeed = :false, updatedAt = :now",ExpressionAttributeValues:a({":false":!1,":now":s}),ReturnValues:"ALL_NEW"}));if(!i.Attributes)throw new Error("Closet item not found");return A(i.Attributes)}async function be(e,t){S(t);let o=E(t),{closetItemId:n}=e,s=C(),{ownerId:r}=await k(n),i={pk:L(n),sk:`PINTEREST_SHARE#${(0,R.randomUUID)()}`,entityType:"PINTEREST_SHARE",closetItemId:n,itemOwnerSub:r,sharerSub:o,createdAt:s};return await m.send(new u.PutItemCommand({TableName:c,Item:a(i)})),await h({action:"PINTEREST_SHARE_REQUESTED",closetItemId:n,ownerSub:r,actorSub:o}),!0}var fe=async e=>{console.log("ClosetResolverFn event",JSON.stringify(e));let t=e.info?.fieldName;try{switch(t){case"myCloset":return await H(e.identity);case"bestieClosetItems":return await ne(e.arguments||{},e.identity);case"myWishlist":return await Ie(e.identity);case"createClosetItem":return await se(e.arguments,e.identity);case"updateClosetMediaKey":return await oe(e.arguments,e.identity);case"requestClosetApproval":return await re(e.arguments,e.identity);case"updateClosetItemStory":return await ie(e.arguments,e.identity);case"likeClosetItem":return await ae(e.arguments,e.identity);case"commentOnClosetItem":return await ue(e.arguments,e.identity);case"pinHighlight":return await de(e.arguments,e.identity);case"closetItemComments":return await W(e.arguments);case"adminClosetItemLikes":return await le(e.arguments);case"adminClosetItemComments":return await ce(e.arguments);case"toggleWishlistItem":return await me(e.arguments,e.identity);case"pinnedClosetItems":return await we(e);case"closetFeed":return await pe(e);case"toggleFavoriteClosetItem":return await Ae(e.arguments,e.identity);case"requestClosetBackgroundChange":return await ye(e.arguments,e.identity);case"createStory":return await Ce(e.arguments,e.identity);case"publishStory":return await Ee(e.arguments,e.identity);case"addClosetItemToCommunityFeed":return await ge(e.arguments,e.identity);case"removeClosetItemFromCommunityFeed":return await Se(e.arguments,e.identity);case"shareClosetItemToPinterest":return await be(e.arguments,e.identity);default:throw new Error(`Unsupported field: ${t}`)}}catch(o){throw console.error("Error in ClosetResolverFn",o),o}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
