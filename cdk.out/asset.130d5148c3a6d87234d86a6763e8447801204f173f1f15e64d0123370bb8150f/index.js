"use strict";var b=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var f=(t,e)=>{for(var a in e)b(t,a,{get:e[a],enumerable:!0})},I=(t,e,a,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of x(e))!w.call(t,s)&&s!==a&&b(t,s,{get:()=>e[s],enumerable:!(n=N(e,s))||n.enumerable});return t};var L=t=>I(b({},"__esModule",{value:!0}),t);var D={};f(D,{handler:()=>h});module.exports=L(D);var g=require("@aws-sdk/client-dynamodb"),r=require("@aws-sdk/lib-dynamodb"),d=process.env.TABLE_NAME,m=r.DynamoDBDocumentClient.from(new g.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}});function S(t){let e=t?.groups;return Array.isArray(e)&&e.includes("ADMIN")}function R(t,e){if(!e?.sub)throw new Error("Unauthenticated");if(!S(e)&&e.sub!==t)throw new Error("Forbidden")}function k(t){if(t==null)return null;if(typeof t=="string")try{return JSON.parse(t)}catch{return{raw:t}}return typeof t=="object"?t:{value:t}}function E(t){let e=1,a=100,n=t;for(;n>=a;)n-=a,e++,a+=50;return e}function y(t,e=12){return Math.max(0,t|0).toString().padStart(e,"0")}var h=async t=>{let{fieldName:e}=t.info,a=t.identity;if(e==="getMyProfile"){if(!a?.sub)throw new Error("Unauthenticated");let n=a.sub,s=await m.send(new r.GetCommand({TableName:d,Key:{pk:`USER#${n}`,sk:"PROFILE"}})),o=Number(s.Item?.xp??0);return{userId:n,displayName:s.Item?.displayName||null,level:E(o),xp:o,coins:Number(s.Item?.coins??0),badges:Array.isArray(s.Item?.badges)?s.Item.badges:[],lastEventAt:s.Item?.lastEventAt??null}}if(e==="setDisplayName"){if(!a?.sub)throw new Error("Unauthenticated");let n=a.sub,o=(t.arguments?.displayName||"").trim().slice(0,40),i=await m.send(new r.UpdateCommand({TableName:d,Key:{pk:`USER#${n}`,sk:"PROFILE"},UpdateExpression:"SET displayName = :n, updatedAt = :u, xp = if_not_exists(xp,:z), coins = if_not_exists(coins,:z)",ExpressionAttributeValues:{":n":o,":u":new Date().toISOString(),":z":0},ReturnValues:"ALL_NEW"})),u=Number(i.Attributes?.xp??0);return{userId:n,displayName:i.Attributes?.displayName||null,level:E(u),xp:u,coins:Number(i.Attributes?.coins??0),badges:Array.isArray(i.Attributes?.badges)?i.Attributes.badges:[],lastEventAt:i.Attributes?.lastEventAt??null}}if(e==="logGameEvent"){if(!a?.sub)throw new Error("Unauthenticated");let n=a.sub,s=new Date().toISOString(),o=t.arguments?.input??{},i=o.type||"UNKNOWN",u=k(o.metadata),p=i==="LEVEL_CLEAR"?50:i==="DAILY_LOGIN"?10:i==="SHARE"?5:i==="STYLE_IT"?Math.max(1,Math.round((u?.score??5)/5)):1,c=i==="LEVEL_CLEAR"?5:i==="DAILY_LOGIN"?1:0,l=await m.send(new r.UpdateCommand({TableName:d,Key:{pk:`USER#${n}`,sk:"PROFILE"},UpdateExpression:`
        SET xp = if_not_exists(xp,:z) + :xi,
            coins = if_not_exists(coins,:z) + :ci,
            lastEventAt = :now
      `.replace(/\s+/g," "),ExpressionAttributeValues:{":z":0,":xi":p,":ci":c,":now":s},ReturnValues:"ALL_NEW"})),A=Number(l.Attributes?.xp??0);return await m.send(new r.PutCommand({TableName:d,Item:{pk:`USER#${n}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${y(A)}#${n}`,xp:A,coins:Number(l.Attributes?.coins??0),updatedAt:s,type:"LEADER"}})),await m.send(new r.PutCommand({TableName:d,Item:{pk:`USER#${n}`,sk:`EVENT#${Date.now()}`,type:"EVENT",evType:i,metadata:u,at:s},ConditionExpression:"attribute_not_exists(pk)"})).catch(()=>{}),{userId:n,displayName:l.Attributes?.displayName||null,level:E(A),xp:A,coins:Number(l.Attributes?.coins??0),badges:Array.isArray(l.Attributes?.badges)?l.Attributes.badges:[],lastEventAt:l.Attributes?.lastEventAt??s}}if(e==="awardCoins"){let{userId:n,coins:s,xp:o}=t.arguments.input;R(n,a);let i=Math.max(0,s|0),u=Math.max(0,(o??0)|0),p=await m.send(new r.UpdateCommand({TableName:d,Key:{pk:`USER#${n}`,sk:"PROFILE"},UpdateExpression:"SET coins = if_not_exists(coins,:z) + :c, xp = if_not_exists(xp,:z) + :x",ExpressionAttributeValues:{":z":0,":c":i,":x":u},ReturnValues:"ALL_NEW"})),c=Number(p.Attributes?.xp??0);return await m.send(new r.PutCommand({TableName:d,Item:{pk:`USER#${n}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${y(c)}#${n}`,xp:c,coins:Number(p.Attributes?.coins??0),updatedAt:new Date().toISOString(),type:"LEADER"}})),{userId:n,displayName:p.Attributes?.displayName||null,level:E(c),xp:c,coins:Number(p.Attributes?.coins??0),badges:Array.isArray(p.Attributes?.badges)?p.Attributes.badges:[],lastEventAt:p.Attributes?.lastEventAt??null}}if(e==="topXP"){let n=Math.max(1,Math.min(100,Number(t.arguments?.limit??10))),o=(await m.send(new r.QueryCommand({TableName:d,IndexName:"gsi1",KeyConditionExpression:"gsi1pk = :p",ExpressionAttributeValues:{":p":"LEADERBOARD#GLOBAL"},ScanIndexForward:!1,Limit:n}))).Items??[];return await Promise.all(o.map(async(u,p)=>{let c=u.pk.replace("USER#",""),l;try{l=(await m.send(new r.GetCommand({TableName:d,Key:{pk:`USER#${c}`,sk:"PROFILE"},ProjectionExpression:"displayName"}))).Item?.displayName}catch{}return{userId:c,displayName:l,xp:Number(u.xp??0),coins:Number(u.coins??0),rank:p+1}}))}throw new Error(`Unknown field ${e}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
