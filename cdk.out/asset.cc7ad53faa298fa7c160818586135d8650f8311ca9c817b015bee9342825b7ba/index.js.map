{
  "version": 3,
  "sources": ["../../lambda/admin/settings.ts"],
  "sourcesContent": ["// lambda/admin/settings.ts\r\nimport { AppSyncResolverHandler } from \"aws-lambda\";\r\nimport {\r\n  DynamoDBClient,\r\n  GetItemCommand,\r\n  PutItemCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport { marshall, unmarshall } from \"@aws-sdk/util-dynamodb\";\r\n\r\nconst client = new DynamoDBClient({});\r\n\r\n// Use your main table, passed from CDK\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\nconst ADMIN_GROUP = process.env.ADMIN_GROUP_NAME || \"ADMIN\";\r\n\r\n// Single-table keys for the settings row\r\nconst PK = \"SETTINGS\";\r\nconst SK = \"GLOBAL\";\r\n\r\nconst DEFAULT_SETTINGS = {\r\n  animationsEnabled: true,\r\n  soundsEnabled: true,\r\n  autoBadgeGrant: true,\r\n  badgeRules: [] as any[],\r\n};\r\n\r\nfunction isAdmin(event: any): boolean {\r\n  const claims = event.identity?.claims || {};\r\n  const rawGroups =\r\n    claims[\"cognito:groups\"] ??\r\n    claims[\"custom:groups\"] ??\r\n    event.identity?.groups ??\r\n    [];\r\n\r\n  const groups = Array.isArray(rawGroups)\r\n    ? rawGroups\r\n    : typeof rawGroups === \"string\"\r\n    ? rawGroups.split(\",\")\r\n    : [];\r\n\r\n  return (\r\n    groups.includes(ADMIN_GROUP) || groups.includes(ADMIN_GROUP.toLowerCase())\r\n  );\r\n}\r\n\r\nexport const handler: AppSyncResolverHandler<any, any> = async (event) => {\r\n  if (!event.identity?.sub) {\r\n    throw new Error(\"Unauthorized\");\r\n  }\r\n  if (!isAdmin(event)) {\r\n    throw new Error(\"Forbidden: admin only\");\r\n  }\r\n  if (!TABLE_NAME) {\r\n    throw new Error(\"Missing TABLE_NAME\");\r\n  }\r\n\r\n  switch (event.info.fieldName) {\r\n    case \"getAdminSettings\": {\r\n      const res = await client.send(\r\n        new GetItemCommand({\r\n          TableName: TABLE_NAME,\r\n          Key: marshall({ pk: PK, sk: SK }),\r\n        })\r\n      );\r\n\r\n      if (!res.Item) {\r\n        // nothing saved yet \u2192 defaults\r\n        return DEFAULT_SETTINGS;\r\n      }\r\n\r\n      const item = unmarshall(res.Item) as any;\r\n\r\n      return {\r\n        animationsEnabled:\r\n          item.animationsEnabled ?? DEFAULT_SETTINGS.animationsEnabled,\r\n        soundsEnabled: item.soundsEnabled ?? DEFAULT_SETTINGS.soundsEnabled,\r\n        autoBadgeGrant:\r\n          item.autoBadgeGrant ?? DEFAULT_SETTINGS.autoBadgeGrant,\r\n        badgeRules: item.badgeRules ?? DEFAULT_SETTINGS.badgeRules,\r\n      };\r\n    }\r\n\r\n    case \"updateAdminSettings\": {\r\n      const input = event.arguments.input || {};\r\n\r\n      const existingRes = await client.send(\r\n        new GetItemCommand({\r\n          TableName: TABLE_NAME,\r\n          Key: marshall({ pk: PK, sk: SK }),\r\n        })\r\n      );\r\n      const existing = existingRes.Item ? unmarshall(existingRes.Item) : {};\r\n\r\n      const merged = {\r\n        ...DEFAULT_SETTINGS,\r\n        ...existing,\r\n        ...input,\r\n      };\r\n\r\n      await client.send(\r\n        new PutItemCommand({\r\n          TableName: TABLE_NAME,\r\n          Item: marshall({ pk: PK, sk: SK, ...merged }),\r\n        })\r\n      );\r\n\r\n      // return AdminSettings as schema expects\r\n      return {\r\n        animationsEnabled: merged.animationsEnabled,\r\n        soundsEnabled: merged.soundsEnabled,\r\n        autoBadgeGrant: merged.autoBadgeGrant,\r\n        badgeRules: merged.badgeRules ?? [],\r\n      };\r\n    }\r\n\r\n    default:\r\n      throw new Error(\"Unknown field: \" + event.info.fieldName);\r\n  }\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAEA,IAAAI,EAIO,oCACPC,EAAqC,kCAE/BC,EAAS,IAAI,iBAAe,CAAC,CAAC,EAG9BC,EAAa,QAAQ,IAAI,WACzBC,EAAc,QAAQ,IAAI,kBAAoB,QAG9CC,EAAK,WACLC,EAAK,SAELC,EAAmB,CACvB,kBAAmB,GACnB,cAAe,GACf,eAAgB,GAChB,WAAY,CAAC,CACf,EAEA,SAASC,EAAQC,EAAqB,CACpC,IAAMC,EAASD,EAAM,UAAU,QAAU,CAAC,EACpCE,EACJD,EAAO,gBAAgB,GACvBA,EAAO,eAAe,GACtBD,EAAM,UAAU,QAChB,CAAC,EAEGG,EAAS,MAAM,QAAQD,CAAS,EAClCA,EACA,OAAOA,GAAc,SACrBA,EAAU,MAAM,GAAG,EACnB,CAAC,EAEL,OACEC,EAAO,SAASR,CAAW,GAAKQ,EAAO,SAASR,EAAY,YAAY,CAAC,CAE7E,CAEO,IAAMN,EAA4C,MAAOW,GAAU,CACxE,GAAI,CAACA,EAAM,UAAU,IACnB,MAAM,IAAI,MAAM,cAAc,EAEhC,GAAI,CAACD,EAAQC,CAAK,EAChB,MAAM,IAAI,MAAM,uBAAuB,EAEzC,GAAI,CAACN,EACH,MAAM,IAAI,MAAM,oBAAoB,EAGtC,OAAQM,EAAM,KAAK,UAAW,CAC5B,IAAK,mBAAoB,CACvB,IAAMI,EAAM,MAAMX,EAAO,KACvB,IAAI,iBAAe,CACjB,UAAWC,EACX,OAAK,YAAS,CAAE,GAAIE,EAAI,GAAIC,CAAG,CAAC,CAClC,CAAC,CACH,EAEA,GAAI,CAACO,EAAI,KAEP,OAAON,EAGT,IAAMO,KAAO,cAAWD,EAAI,IAAI,EAEhC,MAAO,CACL,kBACEC,EAAK,mBAAqBP,EAAiB,kBAC7C,cAAeO,EAAK,eAAiBP,EAAiB,cACtD,eACEO,EAAK,gBAAkBP,EAAiB,eAC1C,WAAYO,EAAK,YAAcP,EAAiB,UAClD,CACF,CAEA,IAAK,sBAAuB,CAC1B,IAAMQ,EAAQN,EAAM,UAAU,OAAS,CAAC,EAElCO,EAAc,MAAMd,EAAO,KAC/B,IAAI,iBAAe,CACjB,UAAWC,EACX,OAAK,YAAS,CAAE,GAAIE,EAAI,GAAIC,CAAG,CAAC,CAClC,CAAC,CACH,EACMW,EAAWD,EAAY,QAAO,cAAWA,EAAY,IAAI,EAAI,CAAC,EAE9DE,EAAS,CACb,GAAGX,EACH,GAAGU,EACH,GAAGF,CACL,EAEA,aAAMb,EAAO,KACX,IAAI,iBAAe,CACjB,UAAWC,EACX,QAAM,YAAS,CAAE,GAAIE,EAAI,GAAIC,EAAI,GAAGY,CAAO,CAAC,CAC9C,CAAC,CACH,EAGO,CACL,kBAAmBA,EAAO,kBAC1B,cAAeA,EAAO,cACtB,eAAgBA,EAAO,eACvB,WAAYA,EAAO,YAAc,CAAC,CACpC,CACF,CAEA,QACE,MAAM,IAAI,MAAM,kBAAoBT,EAAM,KAAK,SAAS,CAC5D,CACF",
  "names": ["settings_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_util_dynamodb", "client", "TABLE_NAME", "ADMIN_GROUP", "PK", "SK", "DEFAULT_SETTINGS", "isAdmin", "event", "claims", "rawGroups", "groups", "res", "item", "input", "existingRes", "existing", "merged"]
}
