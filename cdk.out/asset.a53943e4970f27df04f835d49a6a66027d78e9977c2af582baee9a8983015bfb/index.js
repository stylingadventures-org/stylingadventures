"use strict";var d=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var h=(e,o)=>{for(var n in o)d(e,n,{get:o[n],enumerable:!0})},b=(e,o,n,t)=>{if(o&&typeof o=="object"||typeof o=="function")for(let r of R(o))!A.call(e,r)&&r!==n&&d(e,r,{get:()=>o[r],enumerable:!(t=f(o,r))||t.enumerable});return e};var w=e=>b(d({},"__esModule",{value:!0}),e);var _={};h(_,{handler:()=>I});module.exports=w(_);var E=require("@aws-sdk/client-dynamodb"),i=require("@aws-sdk/lib-dynamodb"),{TABLE_NAME:s="",ADMIN_GROUP_NAME:P="ADMIN"}=process.env;if(!s)throw new Error("Missing env TABLE_NAME");var D=P.toLowerCase(),m=i.DynamoDBDocumentClient.from(new E.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),c="GAME#ECONOMY",l="CONFIG";function T(e){if(!e)return[];let o=e.claims||{},n=o["cognito:groups"]||o["custom:groups"]||e.groups||[];return Array.isArray(n)?n.map(t=>String(t)):typeof n=="string"?n.split(",").map(t=>t.trim()).filter(Boolean):[]}function N(e){return T(e).map(n=>n.toLowerCase()).includes(D)}function p(e){return e?{id:"GAME_ECONOMY",version:Number(e.version??1),updatedAt:String(e.updatedAt??new Date(0).toISOString()),updatedBy:e.updatedBy??null,coinToUsdRatio:Number(e.coinToUsdRatio??1),dailyCoinCap:Number(e.dailyCoinCap??10),weeklyCoinCap:Number(e.weeklyCoinCap??60),monthlyBonusEventsLimit:Number(e.monthlyBonusEventsLimit??2),rules:Array.isArray(e.rules)?e.rules:[]}:null}var M=[{id:"watch-10min",category:"WATCH_TIME",label:"Watch stream \u2013 10 minutes",description:"Earn coins for every 10 minutes of active watch time.",coins:1,per:"PER_10_MIN",maxPerDay:4,meta:{minMinutes:10,maxCoinsPerDay:4}},{id:"chat-5min",category:"CHAT",label:"Meaningful chat message",description:"1 coin every 5 minutes of meaningful chat (5+ words, no spam).",coins:1,per:"PER_5_MIN",maxPerDay:5,meta:{cooldownMinutes:5,minWords:5,maxCoinsPerDay:5}},{id:"trivia-correct",category:"TRIVIA",label:"Correct trivia answer",description:"Earn 1 coin for each correct trivia answer.",coins:1,per:"PER_CORRECT_ANSWER",maxPerDay:5,meta:{maxCoinsPerDay:5}},{id:"trivia-challenge-complete",category:"TRIVIA",label:"Trivia challenge complete",description:"Bonus for getting at least 3 of 5 answers correct.",coins:3,per:"PER_CHALLENGE",maxPerDay:1,meta:{minCorrect:3,totalQuestions:5}},{id:"streak-3",category:"STREAK",label:"3-day watch streak",description:"Watch at least 10 minutes for 3 days in a row.",coins:3,per:"ONCE_PER_STREAK",maxPerDay:1,meta:{streakLength:3,minMinutesPerDay:10}},{id:"streak-7",category:"STREAK",label:"7-day watch streak",description:"Bonus for a full week streak.",coins:10,per:"ONCE_PER_STREAK",maxPerDay:1,meta:{streakLength:7,minMinutesPerDay:10}},{id:"streak-30",category:"STREAK",label:"30-day elite streak",description:"Big bonus for 30 days of consistent viewing.",coins:40,per:"ONCE_PER_STREAK",maxPerDay:1,meta:{streakLength:30,minMinutesPerDay:10}},{id:"share-show",category:"SOCIAL",label:"Share the show",description:"Share the show and tag the creator.",coins:5,per:"PER_SHARE",maxPerDay:1,meta:{requiresTag:!0}},{id:"post-clip",category:"SOCIAL",label:"Duet / stitch / post clip",description:"Earn coins once per week for posting a clip.",coins:20,per:"PER_WEEK",maxPerDay:1,meta:{maxPerWeek:1}},{id:"bring-friend",category:"SOCIAL",label:"Bring a friend",description:"Friend must watch at least 5 minutes for you to earn this reward.",coins:15,per:"PER_FRIEND",maxPerDay:1,meta:{friendMinMinutes:5}},{id:"double-coin-day",category:"EVENT",label:"Double Coin Day",description:"All other rewards are doubled while active.",coins:0,per:"MULTIPLIER",meta:{multiplier:2}},{id:"surprise-drop",category:"EVENT",label:"Surprise drop",description:"Random bonus during a stream.",coins:5,per:"AD_HOC",maxPerDay:1,meta:{minCoins:3,maxCoins:5}},{id:"big-event-bonus",category:"EVENT",label:"Big event bonus",description:"Large bonus for special event streams.",coins:20,per:"PER_EVENT",maxPerDay:1,meta:{maxPerMonth:2}},{id:"redeem-coffee-raffle",category:"REDEMPTION",label:"Coffee raffle entry",description:"Bestie Coffee: You + Me \u2013 1 entry.",coins:-50,per:"PER_ENTRY",meta:{weeklyLimit:1,mustFollow:!0}},{id:"redeem-bts-video",category:"REDEMPTION",label:"Behind-the-scenes video",description:"Unlock an exclusive BTS video.",coins:-100,per:"PER_REWARD",meta:{minEarnedCoins:30}},{id:"redeem-merch-discount",category:"REDEMPTION",label:"Merch discount",description:"Use coins for a merch discount.",coins:-200,per:"PER_REWARD",meta:{monthlyLimit:1}},{id:"redeem-audio-note",category:"REDEMPTION",label:"Personalized audio note",description:"Short personalized audio note reward.",coins:-150,per:"PER_REWARD",meta:{requiresStreakDays:7}},{id:"redeem-lasland-box",category:"REDEMPTION",label:"La\u2019s Land Box",description:"High-value physical box reward.",coins:-400,per:"PER_REWARD",meta:{minStreakDays:30,minStreamsWatched:10}},{id:"redeem-virtual-hangout",category:"REDEMPTION",label:"Virtual hangout",description:"Group or 1:1 virtual hangout.",coins:-500,per:"PER_REWARD",meta:{monthlyLimit:1}},{id:"redeem-250-raffle",category:"REDEMPTION",label:"$250 prize raffle entry",description:"Entry into a $250 prize raffle.",coins:-250,per:"PER_ENTRY",meta:{monthlyLimit:1}}],u={id:"GAME_ECONOMY",version:1,updatedAt:new Date().toISOString(),updatedBy:"system",coinToUsdRatio:1,dailyCoinCap:10,weeklyCoinCap:60,monthlyBonusEventsLimit:2,rules:M},I=async e=>{let{fieldName:o}=e.info;if(o==="getGameEconomyConfig"){let n=await m.send(new i.GetCommand({TableName:s,Key:{pk:c,sk:l}}));return n.Item?p(n.Item):(await m.send(new i.PutCommand({TableName:s,Item:{pk:c,sk:l,type:"GAME_ECONOMY",...u},ConditionExpression:"attribute_not_exists(pk)"})).catch(()=>{}),u)}if(o==="updateGameEconomyConfig"){let n=e.identity;if(!n?.sub)throw new Error("Unauthorized");if(!N(n))throw new Error("Forbidden");let t=e.arguments.input||{},r=new Date().toISOString(),g=n.username||n.sub||"admin",C=await m.send(new i.GetCommand({TableName:s,Key:{pk:c,sk:l}})),a=p(C.Item)??u,y={id:"GAME_ECONOMY",version:(a.version||1)+1,updatedAt:r,updatedBy:g,coinToUsdRatio:typeof t.coinToUsdRatio=="number"?t.coinToUsdRatio:a.coinToUsdRatio,dailyCoinCap:typeof t.dailyCoinCap=="number"?t.dailyCoinCap:a.dailyCoinCap,weeklyCoinCap:typeof t.weeklyCoinCap=="number"?t.weeklyCoinCap:a.weeklyCoinCap,monthlyBonusEventsLimit:typeof t.monthlyBonusEventsLimit=="number"?t.monthlyBonusEventsLimit:a.monthlyBonusEventsLimit,rules:Array.isArray(t.rules)?t.rules:a.rules};return await m.send(new i.PutCommand({TableName:s,Item:{pk:c,sk:l,type:"GAME_ECONOMY",...y}})),y}throw new Error(`Unknown field ${o}`)};0&&(module.exports={handler});
