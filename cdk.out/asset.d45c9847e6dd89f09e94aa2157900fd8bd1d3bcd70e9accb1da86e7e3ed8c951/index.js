"use strict";var S=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var M=(e,s)=>{for(var r in s)S(e,r,{get:s[r],enumerable:!0})},D=(e,s,r,n)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of P(s))!x.call(e,i)&&i!==r&&S(e,i,{get:()=>s[i],enumerable:!(n=N(s,i))||n.enumerable});return e};var L=e=>D(S({},"__esModule",{value:!0}),e);var K={};M(K,{adminApproveItem:()=>b,adminCreateClosetItem:()=>T,adminListPending:()=>I,adminRejectItem:()=>f,adminSetClosetAudience:()=>k,closetFeed:()=>y,handler:()=>R,topClosetLooks:()=>C});module.exports=L(K);var o=require("@aws-sdk/client-dynamodb"),p=require("@aws-sdk/client-sfn"),w=require("crypto"),m=new o.DynamoDBClient({}),g=new p.SFNClient({}),{TABLE_NAME:c="",APPROVAL_SM_ARN:U=""}=process.env;if(!c)throw new Error("Missing env: TABLE_NAME");var l=()=>new Date().toISOString(),t=e=>({S:e});function E(e){let s=e.identity?.claims||{},r=e.identity?.sub||s.sub,n=s["cognito:groups"],i=Array.isArray(n)?n:String(n||"").split(",").map(d=>d.trim()).filter(Boolean),a=i.includes("ADMIN")||i.includes("COLLAB");if(!r)throw new Error("Unauthorized");return{sub:r,isAdmin:a}}function A(e){return{id:e.id.S,userId:e.ownerSub.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",rawMediaKey:e.rawMediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??"",audience:e.audience?.S||"PUBLIC"}}var I=async e=>{let{isAdmin:s}=E(e);if(!s)throw new Error("Forbidden");return((await m.send(new o.QueryCommand({TableName:c,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, audience",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(n=>A({...n,status:n.status}))},y=async e=>{E(e);let{sort:s="NEWEST"}=e.arguments||{},n=((await m.send(new o.QueryCommand({TableName:c,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t("STATUS#APPROVED")},ScanIndexForward:s==="OLDEST",ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, audience",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(i=>A({...i,status:i.status}));return n},C=async e=>y({...e,arguments:{sort:"NEWEST"}}),T=async e=>{let{sub:s,isAdmin:r}=E(e);if(!r)throw new Error("Forbidden");let n=e.arguments?.input;if(!n?.title)throw new Error("title required");if(!n?.rawMediaKey)throw new Error("rawMediaKey required");let i=(0,w.randomUUID)(),a=l(),u={pk:t(`ITEM#${i}`),sk:t("META"),id:t(i),ownerSub:t(s),status:t("PENDING"),createdAt:t(a),updatedAt:t(a),title:t(n.title.trim()),mediaKey:t(""),rawMediaKey:t(n.rawMediaKey),audience:t("PUBLIC"),gsi2pk:t("STATUS#PENDING"),gsi2sk:t(a)};return n.season&&(u.season=t(n.season)),n.vibes&&(u.vibes=t(n.vibes)),await m.send(new o.PutItemCommand({TableName:c,Item:u})),A(u)},b=async e=>{let{isAdmin:s}=E(e);if(!s)throw new Error("Forbidden");let r=e.arguments?.id;if(!r)throw new Error("id required");let n=l(),a=(await m.send(new o.UpdateItemCommand({TableName:c,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("APPROVED"),":u":t(n),":g2pk":t("STATUS#APPROVED"),":g2sk":t(n)},ReturnValues:"ALL_OLD"}))).Attributes,d=a.approvalToken?.S;if(d)try{await g.send(new p.SendTaskSuccessCommand({taskToken:d,output:JSON.stringify({approved:!0})}))}catch{}return A({...a,status:t("APPROVED")})},f=async e=>{let{isAdmin:s}=E(e);if(!s)throw new Error("Forbidden");let r=e.arguments?.id,n=e.arguments?.reason||"";if(!r)throw new Error("id required");let i=l(),d=(await m.send(new o.UpdateItemCommand({TableName:c,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("REJECTED"),":u":t(i),":g2pk":t("STATUS#REJECTED"),":g2sk":t(i),":r":t(n)},ReturnValues:"ALL_OLD"}))).Attributes,u=d.approvalToken?.S;if(u)try{await g.send(new p.SendTaskFailureCommand({taskToken:u,error:"Rejected",cause:n||"Rejected by admin"}))}catch{}return A({...d,status:t("REJECTED"),reason:t(n)})},k=async e=>{let{isAdmin:s}=E(e);if(!s)throw new Error("Forbidden");let r=e.arguments?.id,n=e.arguments?.audience;if(!r)throw new Error("id required");if(!n)throw new Error("audience required");let i=l(),d=(await m.send(new o.UpdateItemCommand({TableName:c,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET audience = :aud, updatedAt = :u",ExpressionAttributeValues:{":aud":t(n),":u":t(i)},ReturnValues:"ALL_NEW"}))).Attributes;return A(d)},R=async e=>{let s=e.info.fieldName;if(s==="adminListPending")return I(e);if(s==="adminCreateClosetItem")return T(e);if(s==="adminApproveItem")return b(e);if(s==="adminRejectItem")return f(e);if(s==="adminSetClosetAudience")return k(e);if(s==="closetFeed")return y(e);if(s==="topClosetLooks")return C(e);throw new Error(`No resolver for field ${s}`)};0&&(module.exports={adminApproveItem,adminCreateClosetItem,adminListPending,adminRejectItem,adminSetClosetAudience,closetFeed,handler,topClosetLooks});
//# sourceMappingURL=index.js.map
