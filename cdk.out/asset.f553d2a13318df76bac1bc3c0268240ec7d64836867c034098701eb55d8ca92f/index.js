"use strict";var S=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var $=Object.prototype.hasOwnProperty;var B=(e,s)=>{for(var o in s)S(e,o,{get:s[o],enumerable:!0})},_=(e,s,o,n)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of F(s))!$.call(e,i)&&i!==o&&S(e,i,{get:()=>s[i],enumerable:!(n=R(s,i))||n.enumerable});return e};var j=e=>_(S({},"__esModule",{value:!0}),e);var G={};B(G,{adminApproveItem:()=>O,adminCreateClosetItem:()=>h,adminListClosetItems:()=>x,adminListPending:()=>k,adminRejectItem:()=>K,adminSetClosetAudience:()=>D,adminUpdateClosetItem:()=>M,closetFeed:()=>T,handler:()=>J,toggleFavoriteClosetItem:()=>P,topClosetLooks:()=>L});module.exports=j(G);var u=require("@aws-sdk/client-dynamodb"),A=require("@aws-sdk/client-sfn"),m=new u.DynamoDBClient({}),v=new A.SFNClient({}),{TABLE_NAME:p=""}=process.env;if(!p)throw new Error("Missing env: TABLE_NAME");var w=()=>new Date().toISOString(),t=e=>({S:e});function f(e){let s=e.identity?.claims||{},o=e.identity?.sub||s.sub,n=s["cognito:groups"],i=Array.isArray(n)?n:String(n||"").split(",").map(c=>c.trim()).filter(Boolean),r=i.includes("ADMIN")||i.includes("COLLAB");if(!o)throw new Error("Unauthorized");return{sub:o,isAdmin:r}}function E(e,s){let o=e.favoriteCount?.N,n=typeof o=="string"?Number(o):0,i=e.pinned,r=typeof i?.BOOL=="boolean"?i.BOOL:void 0;return{id:e.id.S,userId:e.ownerSub.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",rawMediaKey:e.rawMediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??"",season:e.season?.S??null,vibes:e.vibes?.S??null,audience:e.audience?.S??null,category:e.category?.S??null,subcategory:e.subcategory?.S??null,pinned:r,favoriteCount:n,viewerHasFaved:!1,...s}}function q(){return globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`}function N(e){return e?Buffer.from(JSON.stringify(e),"utf8").toString("base64"):null}function H(e){if(e)try{return JSON.parse(Buffer.from(String(e),"base64").toString("utf8"))}catch{return}}var k=async e=>{let{isAdmin:s}=f(e);if(!s)throw new Error("Forbidden");return((await m.send(new u.QueryCommand({TableName:p,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(n=>E({...n,status:n.status}))},x=async e=>{let{isAdmin:s}=f(e);if(!s)throw new Error("Forbidden");let{status:o,limit:n=50,nextToken:i}=e.arguments||{},r=H(i);if(o){let a=await m.send(new u.QueryCommand({TableName:p,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t(`STATUS#${o}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned",ExpressionAttributeNames:{"#s":"status"},Limit:n,ExclusiveStartKey:r}));return{items:(a.Items||[]).map(y=>E({...y,status:y.status})),nextToken:N(a.LastEvaluatedKey)}}let c=await m.send(new u.ScanCommand({TableName:p,FilterExpression:"begins_with(pk, :p)",ExpressionAttributeValues:{":p":t("ITEM#")},ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned",ExpressionAttributeNames:{"#s":"status"},Limit:n,ExclusiveStartKey:r})),d=(c.Items||[]).map(a=>E({...a,status:a.status}));return d.sort((a,l)=>new Date(l.createdAt||0).getTime()-new Date(a.createdAt||0).getTime()),{items:d,nextToken:N(c.LastEvaluatedKey)}},T=async e=>{let{sub:s}=f(e),n=(e.arguments?.sort??"NEWEST")==="MOST_LOVED"?"MOST_LOVED":"NEWEST",i=["APPROVED","PUBLISHED"],r=await m.send(new u.QueryCommand({TableName:p,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:{":pk":t(`FAV#${s}`),":sk":t("CLOSET#")}})),c=new Set((r.Items||[]).map(a=>{let l=a.sk?.S??"";return l.startsWith("CLOSET#")?l.substring(7):a.closetId?.S??""})),d=[];for(let a of i){let y=((await m.send(new u.QueryCommand({TableName:p,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t(`STATUS#${a}`)},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, audience, favoriteCount, category, subcategory, season, vibes, pinned",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(g=>E({...g,status:g.status},{viewerHasFaved:c.has(g.id.S)}));d.push(...y)}return d.sort((a,l)=>{let y=new Date(a.createdAt||0).getTime(),g=new Date(l.createdAt||0).getTime();if(n==="MOST_LOVED"){let I=a.favoriteCount??0,b=l.favoriteCount??0;return b!==I?b-I:g-y}return g-y}),d},L=async e=>T({...e,arguments:{sort:"NEWEST"}}),h=async e=>{let{sub:s,isAdmin:o}=f(e);if(!o)throw new Error("Forbidden");let n=e.arguments?.input||{};if(!n.title?.trim())throw new Error("title is required");let i=n.rawMediaKey||n.mediaKey;if(!i)throw new Error("rawMediaKey is required");let r=q(),c=w();return await m.send(new u.PutItemCommand({TableName:p,Item:{pk:t(`ITEM#${r}`),sk:t("META"),id:t(r),ownerSub:t(s),gsi2pk:t("STATUS#PENDING"),gsi2sk:t(c),status:t("PENDING"),createdAt:t(c),updatedAt:t(c),title:t(n.title.trim()),rawMediaKey:t(i),favoriteCount:{N:"0"},...n.season?{season:t(n.season)}:{},...n.vibes?{vibes:t(n.vibes)}:{},...n.category?{category:t(n.category)}:{},...n.subcategory?{subcategory:t(n.subcategory)}:{},...n.audience?{audience:t(n.audience)}:{},...n.description?{description:t(n.description)}:{},...n.story?{story:t(n.story)}:{}}})),{id:r,userId:s,ownerSub:s,status:"PENDING",createdAt:c,updatedAt:c,title:n.title.trim(),mediaKey:"",rawMediaKey:i,reason:"",season:n.season??null,vibes:n.vibes??null,audience:n.audience??null,category:n.category??null,subcategory:n.subcategory??null,favoriteCount:0,viewerHasFaved:!1}},O=async e=>{let{isAdmin:s}=f(e);if(!s)throw new Error("Forbidden");let o=e.arguments?.closetItemId;if(!o)throw new Error("closetItemId required");let n=w(),r=(await m.send(new u.UpdateItemCommand({TableName:p,Key:{pk:t(`ITEM#${o}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("APPROVED"),":u":t(n),":g2pk":t("STATUS#APPROVED"),":g2sk":t(n)},ReturnValues:"ALL_OLD"}))).Attributes,c=r.approvalToken?.S;if(c)try{await v.send(new A.SendTaskSuccessCommand({taskToken:c,output:JSON.stringify({approved:!0})}))}catch{}return E({...r,status:t("APPROVED")})},K=async e=>{let{isAdmin:s}=f(e);if(!s)throw new Error("Forbidden");let o=e.arguments?.closetItemId,n=e.arguments?.reason||"";if(!o)throw new Error("closetItemId required");let i=w(),c=(await m.send(new u.UpdateItemCommand({TableName:p,Key:{pk:t(`ITEM#${o}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("REJECTED"),":u":t(i),":g2pk":t("STATUS#REJECTED"),":g2sk":t(i),":r":t(n)},ReturnValues:"ALL_OLD"}))).Attributes,d=c.approvalToken?.S;if(d)try{await v.send(new A.SendTaskFailureCommand({taskToken:d,error:"Rejected",cause:n||"Rejected by admin"}))}catch{}return E({...c,status:t("REJECTED"),reason:t(n)})},M=async e=>{let{isAdmin:s}=f(e);if(!s)throw new Error("Forbidden");let o=e.arguments||{},n=o.input||{},i=o.closetItemId??n.id??o.id;if(!i)throw new Error("closetItemId or input.id required");let r={...n};["title","category","subcategory","audience","pinned","season","vibes"].forEach(g=>{o[g]!==void 0&&r[g]===void 0&&(r[g]=o[g])});let c=w(),d=["#updatedAt = :u"],a={"#updatedAt":"updatedAt"},l={":u":t(c)};if(r.title!==void 0&&(d.push("#title = :title"),a["#title"]="title",l[":title"]=r.title===null?{NULL:!0}:t(r.title)),r.category!==void 0&&(d.push("#category = :category"),a["#category"]="category",l[":category"]=r.category===null?{NULL:!0}:t(r.category)),r.subcategory!==void 0&&(d.push("#subcategory = :subcategory"),a["#subcategory"]="subcategory",l[":subcategory"]=r.subcategory===null?{NULL:!0}:t(r.subcategory)),r.audience!==void 0&&(d.push("audience = :audience"),l[":audience"]=r.audience===null?{NULL:!0}:t(r.audience)),r.season!==void 0&&(d.push("season = :season"),l[":season"]=r.season===null?{NULL:!0}:t(r.season)),r.vibes!==void 0&&(d.push("vibes = :vibes"),l[":vibes"]=r.vibes===null?{NULL:!0}:t(r.vibes)),r.pinned!==void 0&&(d.push("pinned = :pinned"),l[":pinned"]=r.pinned===null?{NULL:!0}:{BOOL:!!r.pinned}),d.length===1)throw new Error("No fields provided to update");await m.send(new u.UpdateItemCommand({TableName:p,Key:{pk:t(`ITEM#${i}`),sk:t("META")},UpdateExpression:`SET ${d.join(", ")}`,ExpressionAttributeNames:a,ExpressionAttributeValues:l,ReturnValues:"NONE"}));let y=await m.send(new u.GetItemCommand({TableName:p,Key:{pk:t(`ITEM#${i}`),sk:t("META")},ConsistentRead:!0}));if(!y.Item)throw new Error("Closet item not found");return E(y.Item)},D=async e=>{let{isAdmin:s}=f(e);if(!s)throw new Error("Forbidden");let o=e.arguments?.closetItemId,n=e.arguments?.audience;if(!o)throw new Error("closetItemId required");if(!n)throw new Error("audience required");let i=w(),r=await m.send(new u.UpdateItemCommand({TableName:p,Key:{pk:t(`ITEM#${o}`),sk:t("META")},UpdateExpression:"SET audience = :aud, updatedAt = :u",ExpressionAttributeValues:{":aud":t(n),":u":t(i)},ReturnValues:"ALL_NEW"}));if(!r.Attributes)throw new Error("Closet item not found");return E(r.Attributes)},P=async e=>{let{sub:s}=f(e),o=e.arguments?.id,n=e.arguments?.favoriteOn,i=e.arguments?.on,r=typeof n=="boolean"?n:i;if(!o)throw new Error("id required");let d=(await m.send(new u.GetItemCommand({TableName:p,Key:{pk:t(`ITEM#${o}`),sk:t("META")}}))).Item;if(!d)throw new Error("Closet item not found");let a={pk:t(`FAV#${s}`),sk:t(`CLOSET#${o}`)},y=!!(await m.send(new u.GetItemCommand({TableName:p,Key:a}))).Item,g=typeof r=="boolean"?r:!y,I=w(),b=0;g&&!y?(b=1,await m.send(new u.PutItemCommand({TableName:p,Item:{...a,userSub:t(s),closetId:t(o),createdAt:t(I)}}))):!g&&y&&(b=-1,await m.send(new u.DeleteItemCommand({TableName:p,Key:a}))),b!==0&&await m.send(new u.UpdateItemCommand({TableName:p,Key:{pk:t(`ITEM#${o}`),sk:t("META")},UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) + :delta, updatedAt = :u",ExpressionAttributeValues:{":zero":{N:"0"},":delta":{N:String(b)},":u":t(I)}}));let C=d.favoriteCount?.N,V=typeof C=="string"?Number(C):0,U=Math.max(0,V+b);return E(d,{favoriteCount:U,viewerHasFaved:g})},J=async e=>{let s=e.info.fieldName;if(s==="adminListPending")return k(e);if(s==="adminListClosetItems")return x(e);if(s==="adminCreateClosetItem")return h(e);if(s==="adminApproveItem")return O(e);if(s==="adminRejectItem")return K(e);if(s==="adminSetClosetAudience")return D(e);if(s==="adminUpdateClosetItem")return M(e);if(s==="closetFeed")return T(e);if(s==="topClosetLooks")return L(e);if(s==="toggleFavoriteClosetItem")return P(e);throw new Error(`No resolver implemented for field ${s}`)};0&&(module.exports={adminApproveItem,adminCreateClosetItem,adminListClosetItems,adminListPending,adminRejectItem,adminSetClosetAudience,adminUpdateClosetItem,closetFeed,handler,toggleFavoriteClosetItem,topClosetLooks});
//# sourceMappingURL=index.js.map
