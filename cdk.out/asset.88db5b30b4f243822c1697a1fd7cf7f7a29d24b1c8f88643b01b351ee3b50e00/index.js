"use strict";var y=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var _=Object.prototype.hasOwnProperty;var B=(t,o)=>{for(var r in o)y(t,r,{get:o[r],enumerable:!0})},$=(t,o,r,p)=>{if(o&&typeof o=="object"||typeof o=="function")for(let n of U(o))!_.call(t,n)&&n!==r&&y(t,n,{get:()=>o[n],enumerable:!(p=O(o,n))||p.enumerable});return t};var M=t=>$(y({},"__esModule",{value:!0}),t);var V={};B(V,{handler:()=>F});module.exports=M(V);var N=require("@aws-sdk/client-dynamodb"),l=require("@aws-sdk/lib-dynamodb");var A=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!A)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var{ADMIN_GROUP_NAME:v="ADMIN"}=process.env,g=l.DynamoDBDocumentClient.from(new N.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}});function K(t){if(!t)return[];let o=t.claims||{},r=o["cognito:groups"]||o["custom:groups"]||t.groups||[];return Array.isArray(r)?r.map(p=>String(p)):typeof r=="string"?r.split(",").map(p=>p.trim()).filter(Boolean):[]}function R(t){return K(t).map(r=>r.toUpperCase()).includes(v.toUpperCase())}function I(t){if(!t?.sub)throw new Error("Unauthorized");if(!R(t))throw new Error("Forbidden")}function D(t){return`EPISODE#${t}`}var b="META";function C(t,o,r){let p=(t||"DRAFT").toUpperCase(),n=new Date(o||Date.now()).toISOString();return{gsi1pk:"EPISODE",gsi1sk:`STATUS#${p}#${n}#${r}`}}function E(t){return t?{id:t.id||t.episodeId||(t.pk||"").replace("EPISODE#",""),title:t.title||"",season:t.season??null,episodeNumber:t.episodeNumber??null,showId:t.showId??null,shortDescription:t.shortDescription??"",fullDescription:t.fullDescription??"",status:t.status||"DRAFT",publicAt:t.publicAt||new Date().toISOString(),durationSeconds:t.durationSeconds??null,unlockCoinCost:t.unlockCoinCost??null,chatEnabled:t.chatEnabled??!0,thumbnails:Array.isArray(t.thumbnails)?t.thumbnails:[],outfitsLinkedCount:t.outfitsLinkedCount??0}:null}var F=async t=>{let{fieldName:o}=t.info,r=t.identity;if(o==="adminCreateEpisode"){I(r);let n=t.arguments?.input||{};if(!n.title||!n.publicAt)throw new Error("title and publicAt are required");let s=new Date().toISOString(),c=n.id||`ep-${Date.now()}`,d=String(c),u=n.status||"DRAFT",e=new Date(n.publicAt).toISOString(),a=C(u,e,d),i={pk:D(d),sk:b,id:d,title:n.title,season:n.season??null,episodeNumber:n.episodeNumber??null,showId:n.showId??null,shortDescription:n.shortDescription??"",fullDescription:n.fullDescription??"",status:u,publicAt:e,durationSeconds:n.durationSeconds??null,unlockCoinCost:typeof n.unlockCoinCost=="number"?n.unlockCoinCost:null,chatEnabled:typeof n.chatEnabled=="boolean"?n.chatEnabled:!0,thumbnails:Array.isArray(n.thumbnails)?n.thumbnails:[],outfitsLinkedCount:0,createdAt:s,updatedAt:s,type:"EPISODE",...a};return await g.send(new l.PutCommand({TableName:A,Item:i,ConditionExpression:"attribute_not_exists(pk)"})),E(i)}if(o==="adminUpdateEpisode"){let i=function(S,L,f){e[f]=S,a[`:${f.slice(1)}`]=L,u.push(`${f} = ${`:${f.slice(1)}`}`)};var p=i;I(r);let{episodeId:n,input:s}=t.arguments||{};if(!n)throw new Error("episodeId is required");let c=String(n),d=D(c),u=[],e={},a={};if(!s||typeof s!="object")throw new Error("input is required");if(s.title!=null&&i("title",s.title,"#title"),s.season!=null&&i("season",s.season,"#season"),s.episodeNumber!=null&&i("episodeNumber",s.episodeNumber,"#epnum"),s.showId!=null&&i("showId",s.showId,"#show"),s.shortDescription!=null&&i("shortDescription",s.shortDescription,"#short"),s.fullDescription!=null&&i("fullDescription",s.fullDescription,"#full"),s.status!=null&&i("status",s.status,"#status"),s.publicAt!=null&&i("publicAt",new Date(s.publicAt).toISOString(),"#pub"),s.durationSeconds!=null&&i("durationSeconds",s.durationSeconds,"#dur"),s.unlockCoinCost!=null&&i("unlockCoinCost",s.unlockCoinCost,"#cost"),s.chatEnabled!=null&&i("chatEnabled",s.chatEnabled,"#chat"),s.thumbnails!=null&&i("thumbnails",s.thumbnails,"#thumbs"),e["#updatedAt"]="updatedAt",a[":updatedAt"]=new Date().toISOString(),u.push("#updatedAt = :updatedAt"),u.length===0){let S=await g.send(new l.GetCommand({TableName:A,Key:{pk:d,sk:b}}));return E(S.Item)}let m=await g.send(new l.GetCommand({TableName:A,Key:{pk:d,sk:b}}));if(!m.Item)throw new Error("Episode not found");let h=m.Item.status||"DRAFT",w=m.Item.publicAt||new Date().toISOString(),x=s.status??h,T=s.publicAt?new Date(s.publicAt).toISOString():w,k=C(x,T,c);e["#gsi1pk"]="gsi1pk",e["#gsi1sk"]="gsi1sk",a[":gsi1pk"]=k.gsi1pk,a[":gsi1sk"]=k.gsi1sk,u.push("#gsi1pk = :gsi1pk"),u.push("#gsi1sk = :gsi1sk");let P=await g.send(new l.UpdateCommand({TableName:A,Key:{pk:d,sk:b},UpdateExpression:`SET ${u.join(", ")}`,ExpressionAttributeNames:e,ExpressionAttributeValues:a,ReturnValues:"ALL_NEW"}));return E(P.Attributes)}if(o==="adminListEpisodes"){I(r);let{status:n,showId:s,season:c,limit:d=20,nextToken:u}=t.arguments||{},e={TableName:A,IndexName:"gsi1",KeyConditionExpression:"gsi1pk = :p",ExpressionAttributeValues:{":p":"EPISODE"},ScanIndexForward:!1,Limit:Math.min(100,Math.max(1,d))},a={},i=[];if(n&&(a["#sk"]="gsi1sk",e.KeyConditionExpression="gsi1pk = :p AND begins_with(#sk, :skPrefix)",e.ExpressionAttributeNames=a,e.ExpressionAttributeValues[":skPrefix"]=`STATUS#${String(n).toUpperCase()}#`),u)try{e.ExclusiveStartKey=JSON.parse(u)}catch{}s&&(a["#showId"]="showId",e.ExpressionAttributeNames={...e.ExpressionAttributeNames||{},"#showId":"showId"},e.ExpressionAttributeValues[":showId"]=s,i.push("#showId = :showId")),typeof c=="number"&&(a["#season"]="season",e.ExpressionAttributeNames={...e.ExpressionAttributeNames||{},"#season":"season"},e.ExpressionAttributeValues[":season"]=c,i.push("#season = :season")),i.length&&(e.FilterExpression=i.join(" AND "));let m=await g.send(new l.QueryCommand(e)),h=(m.Items||[]).map(E),w=m.LastEvaluatedKey?JSON.stringify(m.LastEvaluatedKey):null;return{items:h,nextToken:w}}throw new Error(`Unknown field ${o}`)};0&&(module.exports={handler});
