{
  "version": 3,
  "sources": ["../../lambda/list/index.ts"],
  "sourcesContent": ["import { APIGatewayProxyResult } from 'aws-lambda';\r\nimport { S3Client, ListObjectsV2Command } from '@aws-sdk/client-s3';\r\n\r\n// Path-style so host stays s3.us-east-1.amazonaws.com and avoids per-bucket DNS lookups.\r\nconst s3 = new S3Client({\r\n  region: process.env.AWS_REGION || 'us-east-1',\r\n  forcePathStyle: true,\r\n});\r\n\r\nconst BUCKET = process.env.BUCKET!;\r\n\r\n/* ============================== CORS helpers ============================== */\r\n// Allow-list from env (comma-separated), e.g. \"https://d1682i07dc1r3k.cloudfront.net,https://stylingadventures.com\"\r\nconst ALLOWED_ORIGINS = String(process.env.ALLOWED_ORIGINS || '')\r\n  .split(',')\r\n  .map(s => s.trim())\r\n  .filter(Boolean);\r\n\r\n// Legacy single origin fallback\r\nconst FALLBACK_ORIGIN = process.env.WEB_ORIGIN || '';\r\n\r\n// Include lowercase 'authorization' because that's what the browser sends in\r\n// Access-Control-Request-Headers during preflight.\r\nconst ALLOW_HEADERS = [\r\n  'authorization',              // preflight requests usually send lowercase\r\n  'Authorization',              // allow Title-Case too (defensive)\r\n  'Content-Type',\r\n  'X-Amz-Date',\r\n  'X-Api-Key',\r\n  'X-Amz-Security-Token',\r\n].join(',');\r\n\r\nfunction pickAllowedOrigin(event: any): string | undefined {\r\n  const reqOrigin =\r\n    event?.headers?.origin ||\r\n    event?.headers?.Origin ||\r\n    '';\r\n  if (ALLOWED_ORIGINS.length) {\r\n    return ALLOWED_ORIGINS.includes(reqOrigin) ? reqOrigin : undefined;\r\n  }\r\n  return FALLBACK_ORIGIN || undefined; // back-compat\r\n}\r\n\r\n// For this Lambda (/list), only GET + OPTIONS are used.\r\nfunction baseCorsHeaders(origin?: string) {\r\n  const h: Record<string, string> = {\r\n    'Content-Type': 'application/json',\r\n    'Access-Control-Allow-Headers': ALLOW_HEADERS,\r\n    'Access-Control-Allow-Methods': 'GET,OPTIONS',\r\n    'Access-Control-Allow-Credentials': 'true',\r\n    Vary: 'Origin',\r\n  };\r\n  if (origin) h['Access-Control-Allow-Origin'] = origin;\r\n  return h;\r\n}\r\n\r\nfunction ok(event: any, body: unknown, extra: Record<string, string> = {}): APIGatewayProxyResult {\r\n  const origin = pickAllowedOrigin(event);\r\n  return { statusCode: 200, headers: { ...baseCorsHeaders(origin), ...extra }, body: JSON.stringify(body) };\r\n}\r\n\r\nfunction bad(event: any, status: number, msg: string): APIGatewayProxyResult {\r\n  const origin = pickAllowedOrigin(event);\r\n  const hasReqOrigin = !!(event.headers?.origin || event.headers?.Origin);\r\n  if (hasReqOrigin && !origin) {\r\n    // CORS request from a non-allowed origin\r\n    return { statusCode: 403, headers: baseCorsHeaders(undefined), body: JSON.stringify({ message: 'CORS: origin not allowed' }) };\r\n  }\r\n  return { statusCode: status, headers: baseCorsHeaders(origin), body: JSON.stringify({ message: msg }) };\r\n}\r\n/* ============================ end CORS helpers ============================ */\r\n\r\n/* -------------------- small utils -------------------- */\r\ntype AnyEvent = any;\r\nfunction getMethod(e: AnyEvent): string {\r\n  return e.httpMethod ?? e.requestContext?.http?.method ?? 'GET';\r\n}\r\nfunction getClaims(e: AnyEvent): Record<string, any> {\r\n  return e.requestContext?.authorizer?.claims ?? e.requestContext?.authorizer?.jwt?.claims ?? {};\r\n}\r\n\r\n/* --------------------------- handler --------------------------- */\r\nexport const handler = async (event: AnyEvent): Promise<APIGatewayProxyResult> => {\r\n  // CORS preflight\r\n  if (getMethod(event) === 'OPTIONS') {\r\n    const origin = pickAllowedOrigin(event);\r\n    if (!origin && (event.headers?.origin || event.headers?.Origin)) {\r\n      return { statusCode: 403, headers: baseCorsHeaders(undefined), body: '' };\r\n    }\r\n    return { statusCode: 204, headers: baseCorsHeaders(origin), body: '' };\r\n  }\r\n\r\n  try {\r\n    const claims = getClaims(event);\r\n    const sub = claims?.sub as string | undefined;\r\n\r\n    const queryPrefix = (event?.queryStringParameters?.prefix ?? '')\r\n      .replace(/\\.\\./g, '')\r\n      .replace(/^[/\\\\]+/, '');\r\n\r\n    const userPrefix = sub ? `users/${sub}/` : '';\r\n    const prefix = `${userPrefix}${queryPrefix}`;\r\n\r\n    // NEW: accept nextToken from the query and pass it as ContinuationToken\r\n    const next = event?.queryStringParameters?.nextToken || undefined;\r\n\r\n    const res = await s3.send(\r\n      new ListObjectsV2Command({\r\n        Bucket: BUCKET,\r\n        Prefix: prefix || undefined,\r\n        ContinuationToken: next,\r\n        MaxKeys: 1000,\r\n      })\r\n    );\r\n\r\n    const items = (res.Contents ?? []).map(o => ({\r\n      key: o.Key,\r\n      size: o.Size,\r\n      lastModified: o.LastModified?.toISOString?.() ?? null,\r\n    }));\r\n\r\n    return ok(event, {\r\n      prefix,\r\n      items,\r\n      isTruncated: !!res.IsTruncated,\r\n      nextToken: res.NextContinuationToken ?? null,\r\n    });\r\n  } catch (e: any) {\r\n    console.error(e);\r\n    return bad(event, 500, e?.message ?? String(e));\r\n  }\r\n};\r\n\r\n\r\n"],
  "mappings": "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",
  "names": ["list_exports", "__export", "handler", "__toCommonJS", "import_client_s3", "s3", "BUCKET", "ALLOWED_ORIGINS", "s", "FALLBACK_ORIGIN", "ALLOW_HEADERS", "pickAllowedOrigin", "event", "reqOrigin", "baseCorsHeaders", "origin", "h", "ok", "body", "extra", "bad", "status", "msg", "getMethod", "getClaims", "sub", "queryPrefix", "prefix", "next", "res", "items", "o", "e"]
}
