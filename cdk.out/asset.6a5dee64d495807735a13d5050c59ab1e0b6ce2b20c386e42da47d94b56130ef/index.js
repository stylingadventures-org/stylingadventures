"use strict";var S=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var k=(t,e)=>{for(var n in e)S(t,n,{get:e[n],enumerable:!0})},N=(t,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of C(e))!I.call(t,s)&&s!==n&&S(t,s,{get:()=>e[s],enumerable:!(i=f(e,s))||i.enumerable});return t};var g=t=>N(S({},"__esModule",{value:!0}),t);var h={};k(h,{handler:()=>M});module.exports=g(h);var r=require("@aws-sdk/client-dynamodb"),w=require("@aws-sdk/util-dynamodb"),p=require("@aws-sdk/client-sfn"),E=require("crypto"),u=new r.DynamoDBClient({}),P=new p.SFNClient({}),a=process.env.TABLE_NAME||process.env.APP_TABLE||void 0,A=process.env.APPROVAL_SM_ARN;if(!a)throw new Error("ClosetResolverFn: TABLE_NAME (or APP_TABLE) environment variable is required");function l(t){let e=t.identity?.sub||t.identity?.claims&&t.identity.claims.sub;if(!e)throw new Error("ClosetResolverFn: missing identity.sub");return String(e)}function m(t){let e=(0,w.unmarshall)(t);return{id:String(e.id),ownerSub:String(e.ownerSub),title:e.title??null,mediaKey:e.mediaKey??null,status:e.status??"PENDING",audience:e.audience??"PUBLIC",reason:e.reason??null,createdAt:String(e.createdAt),updatedAt:String(e.updatedAt??e.createdAt)}}async function b(t){let e=await u.send(new r.ScanCommand({TableName:a,FilterExpression:"begins_with(#pk, :itemPrefix) AND #sk = :meta AND #id = :id",ExpressionAttributeNames:{"#pk":"pk","#sk":"sk","#id":"id"},ExpressionAttributeValues:{":itemPrefix":{S:"ITEM#"},":meta":{S:"META"},":id":{S:t}},Limit:1}));return!e.Items||e.Items.length===0?null:e.Items[0]}function y(t){if(t.pk?.S&&t.sk?.S)return{pk:t.pk.S,sk:t.sk.S};throw new Error("ClosetResolverFn: could not infer pk/sk")}async function T(t,e){let n=l(t),i=(0,E.randomUUID)(),s=new Date().toISOString(),o={pk:{S:`ITEM#${i}`},sk:{S:"META"},id:{S:i},ownerSub:{S:n},title:{S:e.title??"Untitled upload"},status:{S:"DRAFT"},audience:{S:"PUBLIC"},createdAt:{S:s},updatedAt:{S:s}};return await u.send(new r.PutItemCommand({TableName:a,Item:o,ConditionExpression:"attribute_not_exists(pk)"})),{id:i,ownerSub:n,title:o.title.S,mediaKey:null,status:"DRAFT",audience:"PUBLIC",reason:null,createdAt:s,updatedAt:s}}async function x(t,e){let n=l(t),i=await b(e.id);if(!i)throw new Error(`Closet item not found for id=${e.id}`);let{pk:s,sk:o}=y(i),c=new Date().toISOString(),d=await u.send(new r.UpdateItemCommand({TableName:a,Key:{pk:{S:s},sk:{S:o}},ConditionExpression:"#ownerSub = :owner",UpdateExpression:"SET #mediaKey = :mk, #updatedAt = :now",ExpressionAttributeNames:{"#mediaKey":"mediaKey","#updatedAt":"updatedAt","#ownerSub":"ownerSub"},ExpressionAttributeValues:{":mk":e.mediaKey?{S:e.mediaKey}:{NULL:!0},":now":{S:c},":owner":{S:n}},ReturnValues:"ALL_NEW"}));if(!d.Attributes)throw new Error("updateClosetMediaKey: update returned no attributes");return m(d.Attributes)}async function D(t,e){let n=l(t),i=await b(e.id);if(!i)throw new Error(`Closet item not found for id=${e.id}`);let{pk:s,sk:o}=y(i),c=new Date().toISOString(),d=await u.send(new r.UpdateItemCommand({TableName:a,Key:{pk:{S:s},sk:{S:o}},ConditionExpression:"#ownerSub = :owner",UpdateExpression:"SET #status = :pending, #updatedAt = :now",ExpressionAttributeNames:{"#status":"status","#updatedAt":"updatedAt","#ownerSub":"ownerSub"},ExpressionAttributeValues:{":pending":{S:"PENDING"},":now":{S:c},":owner":{S:n}},ReturnValues:"ALL_NEW"}));if(A&&await P.send(new p.StartExecutionCommand({stateMachineArn:A,input:JSON.stringify({itemId:e.id,ownerSub:n})})),!d.Attributes)throw new Error("requestClosetApproval: update returned no attributes");return m(d.Attributes)}async function L(t){let e=l(t),i=((await u.send(new r.ScanCommand({TableName:a,FilterExpression:"begins_with(#pk, :itemPrefix) AND #sk = :meta AND #ownerSub = :owner",ExpressionAttributeNames:{"#pk":"pk","#sk":"sk","#ownerSub":"ownerSub"},ExpressionAttributeValues:{":itemPrefix":{S:"ITEM#"},":meta":{S:"META"},":owner":{S:e}}}))).Items||[]).map(m);return i.sort((s,o)=>s.createdAt<o.createdAt?1:-1),i}async function R(t){let n=((await u.send(new r.ScanCommand({TableName:a,FilterExpression:"begins_with(#pk, :itemPrefix) AND #sk = :meta AND (#status = :approved OR #status = :published) AND #audience = :public",ExpressionAttributeNames:{"#pk":"pk","#sk":"sk","#status":"status","#audience":"audience"},ExpressionAttributeValues:{":itemPrefix":{S:"ITEM#"},":meta":{S:"META"},":approved":{S:"APPROVED"},":published":{S:"PUBLISHED"},":public":{S:"PUBLIC"}}}))).Items||[]).map(m);return n.sort((i,s)=>i.createdAt<s.createdAt?1:-1),n}var M=async t=>{let{parentTypeName:e,fieldName:n}=t.info;if(e==="Query"){if(n==="myCloset")return L(t);if(n==="closetFeed")return R(t)}if(e==="Mutation"){if(n==="createClosetItem")return T(t,t.arguments);if(n==="requestClosetApproval")return D(t,t.arguments);if(n==="updateClosetMediaKey")return x(t,t.arguments)}throw new Error(`ClosetResolverFn: unknown field ${e}.${n}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
