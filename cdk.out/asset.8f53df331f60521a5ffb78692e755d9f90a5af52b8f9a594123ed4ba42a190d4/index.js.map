{
  "version": 3,
  "sources": ["../../lambda/graphql/index.ts"],
  "sourcesContent": ["import {\r\n  BatchGetItemCommand,\r\n  DeleteItemCommand,\r\n  DynamoDBClient,\r\n  PutItemCommand,\r\n  QueryCommand,\r\n  UpdateItemCommand,\r\n  ScanCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport { SFNClient, StartExecutionCommand } from \"@aws-sdk/client-sfn\";\r\nimport {\r\n  EventBridgeClient,\r\n  PutEventsCommand,\r\n} from \"@aws-sdk/client-eventbridge\";\r\nimport { marshall, unmarshall } from \"@aws-sdk/util-dynamodb\";\r\nimport { randomUUID } from \"crypto\";\r\nimport { AppSyncIdentityCognito } from \"aws-lambda\";\r\n\r\nconst ddbMarshal = (value: any) =>\r\n  marshall(value, { removeUndefinedValues: true });\r\n\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\nconst APPROVAL_SM_ARN = process.env.APPROVAL_SM_ARN!;\r\nconst BG_CHANGE_SM_ARN = process.env.BG_CHANGE_SM_ARN!;\r\nconst STORY_PUBLISH_SM_ARN = process.env.STORY_PUBLISH_SM_ARN!;\r\nconst STATUS_GSI = process.env.STATUS_GSI ?? \"gsi1\"; // status index name\r\n\r\nconst ddb = new DynamoDBClient({});\r\nconst sfn = new SFNClient({});\r\nconst eb = new EventBridgeClient({});\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// Tier helpers (keep in sync with gameplay/profile)\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\ntype UserTier = \"FREE\" | \"BESTIE\" | \"CREATOR\" | \"COLLAB\" | \"ADMIN\" | \"PRIME\";\r\n\r\n// AppSync sometimes sends groups: null \u2013 accept null|undefined.\r\ntype SAIdentity =\r\n  | (AppSyncIdentityCognito & { groups?: string[] | null })\r\n  | null\r\n  | undefined;\r\n\r\n// Prefer explicit token tier claim; fall back to groups if needed.\r\nfunction getUserTier(identity: SAIdentity): UserTier {\r\n  const claims = (identity as any)?.claims || {};\r\n\r\n  const claimTier =\r\n    (claims[\"tier\"] as string | undefined) ??\r\n    (claims[\"custom:tier\"] as string | undefined);\r\n\r\n  const validTiers: UserTier[] = [\r\n    \"FREE\",\r\n    \"BESTIE\",\r\n    \"CREATOR\",\r\n    \"COLLAB\",\r\n    \"ADMIN\",\r\n    \"PRIME\",\r\n  ];\r\n\r\n  if (claimTier && validTiers.includes(claimTier as UserTier)) {\r\n    return claimTier as UserTier;\r\n  }\r\n\r\n  const rawGroups = claims[\"cognito:groups\"];\r\n  const groups = Array.isArray(rawGroups)\r\n    ? rawGroups\r\n    : String(rawGroups || \"\")\r\n        .split(\",\")\r\n        .map((g) => g.trim())\r\n        .filter(Boolean);\r\n\r\n  if (groups.includes(\"ADMIN\")) return \"ADMIN\";\r\n  if (groups.includes(\"PRIME\")) return \"PRIME\";\r\n  if (groups.includes(\"CREATOR\")) return \"CREATOR\";\r\n  if (groups.includes(\"COLLAB\")) return \"COLLAB\";\r\n  if (groups.includes(\"BESTIE\")) return \"BESTIE\";\r\n\r\n  return \"FREE\";\r\n}\r\n\r\nfunction assertAuth(identity: SAIdentity) {\r\n  if (!identity?.sub) throw new Error(\"Unauthenticated\");\r\n}\r\n\r\nfunction assertBestieOrHigher(identity: SAIdentity) {\r\n  assertAuth(identity);\r\n  const tier = getUserTier(identity);\r\n  if (tier === \"FREE\") {\r\n    // FAN-only: not allowed to own closet\r\n    throw new Error(\"This is a Bestie feature. Upgrade to unlock your closet.\");\r\n  }\r\n}\r\n\r\n// Helper used by existing callers \u2013 returns the tier after asserting.\r\nfunction requireBestieTier(identity: SAIdentity): UserTier {\r\n  assertBestieOrHigher(identity);\r\n  return getUserTier(identity);\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// Types\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\ntype ClosetStatus =\r\n  | \"DRAFT\"\r\n  | \"PENDING\"\r\n  | \"APPROVED\"\r\n  | \"REJECTED\"\r\n  | \"PUBLISHED\"\r\n  | \"ARCHIVED\";\r\n\r\ntype ClosetAudience =\r\n  | \"PRIVATE\"\r\n  | \"FOLLOWERS\"\r\n  | \"PUBLIC\"\r\n  | \"BESTIE\"\r\n  | \"EXCLUSIVE\"\r\n  | \"ADMIN_ONLY\"\r\n  | \"HIDDEN\";\r\n\r\ninterface ClosetItem {\r\n  id: string;\r\n  userId: string;\r\n  ownerSub: string;\r\n  status: ClosetStatus;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n\r\n  // S3 keys\r\n  mediaKey?: string;\r\n  rawMediaKey?: string;\r\n\r\n  title?: string;\r\n  reason?: string;\r\n  audience?: ClosetAudience;\r\n\r\n  // Categorization fields\r\n  category?: string | null;\r\n  subcategory?: string | null;\r\n\r\n  // Story-style metadata (Bestie / fan-facing)\r\n  storyTitle?: string;\r\n  storySeason?: string;\r\n  storyVibes?: string[];\r\n\r\n  // Bestie / profile highlight\r\n  pinned?: boolean;\r\n\r\n  // Bestie: pending background change\r\n  pendingBackgroundKey?: string | null;\r\n\r\n  // Community feed flag (Lala\u2019s Closet front page)\r\n  inCommunityFeed?: boolean;\r\n\r\n  // Aggregates\r\n  favoriteCount?: number;\r\n  likeCount?: number;\r\n  commentCount?: number;\r\n  wishlistCount?: number;\r\n\r\n  // Per-viewer flags (set by resolvers)\r\n  viewerHasFaved?: boolean;\r\n  viewerHasLiked?: boolean;\r\n  viewerHasWishlisted?: boolean;\r\n}\r\n\r\ninterface ClosetItemComment {\r\n  id: string;\r\n  closetItemId: string;\r\n  authorSub: string;\r\n  text: string;\r\n  createdAt: string;\r\n}\r\n\r\ninterface ClosetItemLike {\r\n  closetItemId: string;\r\n  likerSub: string;\r\n  createdAt: string;\r\n}\r\n\r\ntype ClosetFeedSort = \"NEWEST\" | \"MOST_LOVED\";\r\n\r\ntype ClosetFeedArgs = {\r\n  limit?: number | null;\r\n  sort?: ClosetFeedSort | null;\r\n};\r\n\r\ntype ClosetConnection = {\r\n  items: ClosetItem[];\r\n  nextToken: string | null;\r\n};\r\n\r\ninterface Story {\r\n  id: string;\r\n  userId: string;\r\n  ownerSub: string;\r\n  title?: string;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n  status: \"DRAFT\" | \"PENDING_PUBLISH\" | \"PUBLISHED\" | \"ARCHIVED\";\r\n  closetItemIds?: string[];\r\n  scheduledAt?: string | null;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// Small helpers\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nfunction nowIso() {\r\n  return new Date().toISOString();\r\n}\r\n\r\nfunction pkForUser(userId: string) {\r\n  return `USER#${userId}`;\r\n}\r\n\r\nfunction skForClosetItem(id: string) {\r\n  return `CLOSET#${id}`;\r\n}\r\n\r\nfunction skForStory(id: string) {\r\n  return `STORY#${id}`;\r\n}\r\n\r\n// Root partition for item-level aggregates (likes, comments, favorites, etc.)\r\nfunction pkForClosetRoot(closetItemId: string) {\r\n  return `CLOSET#${closetItemId}`;\r\n}\r\n\r\nfunction gsi1ForStatus(status: ClosetStatus) {\r\n  return `CLOSET#STATUS#${status}`;\r\n}\r\n\r\nfunction extractIdFromSk(sk: unknown): string | undefined {\r\n  if (typeof sk !== \"string\") return undefined;\r\n  if (sk.startsWith(\"CLOSET#\")) {\r\n    const maybeId = sk.slice(\"CLOSET#\".length);\r\n    return maybeId || undefined;\r\n  }\r\n  return sk;\r\n}\r\n\r\n/**\r\n * Fire a BestieEngagement event to EventBridge.\r\n * Engagement Lambda consumes these.\r\n */\r\nasync function putEngagementEvent(detail: any) {\r\n  try {\r\n    await eb.send(\r\n      new PutEventsCommand({\r\n        Entries: [\r\n          {\r\n            Source: \"stylingadventures.besties\",\r\n            DetailType: \"BestieEngagement\",\r\n            Detail: JSON.stringify(detail),\r\n          },\r\n        ],\r\n      }),\r\n    );\r\n  } catch (err) {\r\n    console.error(\"Failed to put engagement event\", err);\r\n  }\r\n}\r\n\r\n/**\r\n * Map a raw DynamoDB item into our ClosetItem shape.\r\n * Defensive so we never return null for non-nullable GraphQL fields.\r\n */\r\nfunction mapClosetItem(raw: Record<string, any>): ClosetItem {\r\n  const item = unmarshall(raw) as any;\r\n\r\n  const id: string =\r\n    item.id ?? extractIdFromSk(item.sk) ?? randomUUID(); // last-ditch fallback (keeps GraphQL ID non-null)\r\n\r\n  // Fallbacks between userId and ownerSub so we always have an owner\r\n  const inferredUserFromPk =\r\n    typeof item.pk === \"string\" && item.pk.startsWith(\"USER#\")\r\n      ? item.pk.slice(\"USER#\".length)\r\n      : undefined;\r\n\r\n  const userId: string =\r\n    item.userId ?? item.ownerSub ?? inferredUserFromPk ?? \"UNKNOWN\";\r\n\r\n  const ownerSub: string =\r\n    item.ownerSub ?? item.userId ?? inferredUserFromPk ?? \"UNKNOWN\";\r\n\r\n  const createdAt: string =\r\n    item.createdAt ?? item.updatedAt ?? new Date(0).toISOString();\r\n  const updatedAt: string = item.updatedAt ?? createdAt;\r\n\r\n  const status: ClosetStatus = item.status ?? \"DRAFT\";\r\n\r\n  const closetItem: ClosetItem = {\r\n    id,\r\n    userId,\r\n    ownerSub,\r\n    status,\r\n    createdAt,\r\n    updatedAt,\r\n    mediaKey: item.mediaKey,\r\n    rawMediaKey: item.rawMediaKey,\r\n    title: item.title,\r\n    reason: item.reason,\r\n    audience: item.audience,\r\n    category: item.category,\r\n    subcategory: item.subcategory,\r\n    storyTitle: item.storyTitle,\r\n    storySeason: item.storySeason,\r\n    storyVibes: item.storyVibes,\r\n    pinned: item.pinned,\r\n    pendingBackgroundKey: item.pendingBackgroundKey,\r\n    inCommunityFeed: item.inCommunityFeed,\r\n    favoriteCount: item.favoriteCount,\r\n    likeCount: item.likeCount,\r\n    commentCount: item.commentCount,\r\n    wishlistCount: item.wishlistCount,\r\n    viewerHasFaved: item.viewerHasFaved,\r\n    viewerHasLiked: item.viewerHasLiked,\r\n    viewerHasWishlisted: item.viewerHasWishlisted,\r\n  };\r\n\r\n  return closetItem;\r\n}\r\n\r\n/**\r\n * Ensure the caller is authenticated and return sub/userId.\r\n */\r\nfunction requireUserSub(identity: SAIdentity): string {\r\n  assertAuth(identity);\r\n  return identity!.sub as string;\r\n}\r\n\r\n// helper: check if identity is admin/collab\r\nfunction isAdminIdentity(identity: SAIdentity): boolean {\r\n  const claims = (identity as any)?.claims || {};\r\n  const raw = claims[\"cognito:groups\"];\r\n  const groups = Array.isArray(raw)\r\n    ? raw\r\n    : String(raw || \"\")\r\n        .split(\",\")\r\n        .map((g) => g.trim())\r\n        .filter(Boolean);\r\n\r\n  return groups.includes(\"ADMIN\") || groups.includes(\"COLLAB\");\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 1) myCloset \u2013 return all items owned by the current user.\r\n//    Now returns a ClosetConnection and is Bestie+ only.\r\n//    FREE tier gets an empty closet.\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleMyCloset(identity: SAIdentity): Promise<ClosetConnection> {\r\n  assertAuth(identity);\r\n  const tier = getUserTier(identity);\r\n\r\n  if (tier === \"FREE\") {\r\n    // Fans don't have their own closet\r\n    return { items: [], nextToken: null };\r\n  }\r\n\r\n  const sub = identity!.sub as string;\r\n\r\n  const res = await ddb.send(\r\n    new QueryCommand({\r\n      TableName: TABLE_NAME,\r\n      KeyConditionExpression: \"pk = :pk AND begins_with(sk, :sk)\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":pk\": pkForUser(sub),\r\n        \":sk\": \"CLOSET#\",\r\n      }),\r\n    }),\r\n  );\r\n\r\n  const items = (res.Items ?? [])\r\n    .map(mapClosetItem)\r\n    .filter((ci) => ci.id && ci.id !== \"undefined\");\r\n\r\n  return {\r\n    items,\r\n    nextToken: null,\r\n  };\r\n}\r\n\r\n// Bestie closet paginated connection \u2013 for now, just wraps myCloset\r\n// Explicitly returns ClosetConnection & enforces Bestie+.\r\nasync function handleBestieClosetItems(\r\n  args: { limit?: number | null; nextToken?: string | null },\r\n  identity: SAIdentity,\r\n): Promise<ClosetConnection> {\r\n  // Bestie+ only\r\n  requireBestieTier(identity);\r\n\r\n  const myClosetConnection = await handleMyCloset(identity);\r\n  const allItems = myClosetConnection.items;\r\n\r\n  const limit =\r\n    args.limit && args.limit > 0\r\n      ? Math.min(args.limit, allItems.length)\r\n      : allItems.length;\r\n\r\n  const items = allItems.slice(0, limit);\r\n\r\n  // No real pagination yet, so always null\r\n  return {\r\n    items,\r\n    nextToken: null,\r\n  };\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 2) createClosetItem \u2013 create a new item in DRAFT (Bestie+).\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleCreateClosetItem(\r\n  args: {\r\n    input: {\r\n      title?: string;\r\n      description?: string | null; // kept for schema compatibility\r\n      story?: string | null; // legacy field\r\n      audience?: ClosetAudience;\r\n      mediaKey?: string;\r\n      rawMediaKey?: string;\r\n      category?: string | null;\r\n      subcategory?: string | null;\r\n    };\r\n  },\r\n  identity: SAIdentity,\r\n): Promise<ClosetItem> {\r\n  // Only Besties+ can own a closet\r\n  requireBestieTier(identity);\r\n  const sub = requireUserSub(identity);\r\n  const id = randomUUID();\r\n  const now = nowIso();\r\n\r\n  const input = args.input;\r\n\r\n  const item: ClosetItem = {\r\n    id,\r\n    userId: sub,\r\n    ownerSub: sub,\r\n    status: \"DRAFT\",\r\n    createdAt: now,\r\n    updatedAt: now,\r\n    mediaKey: input.mediaKey ?? undefined,\r\n    rawMediaKey: input.rawMediaKey ?? undefined,\r\n    title: input.title ?? undefined,\r\n    category: input.category ?? null,\r\n    subcategory: input.subcategory ?? null,\r\n    audience: input.audience ?? \"PRIVATE\",\r\n  };\r\n\r\n  await ddb.send(\r\n    new PutItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Item: ddbMarshal({\r\n        pk: pkForUser(sub),\r\n        sk: skForClosetItem(id),\r\n\r\n        // status GSI\r\n        gsi1pk: gsi1ForStatus(item.status),\r\n        gsi1sk: now,\r\n\r\n        // rawMediaKey GSI uses \"rawMediaKey\" as its partition key\r\n        // (index name is RAW_MEDIA_GSI_NAME = \"rawMediaKeyIndex\" on the table)\r\n        rawMediaKey: item.rawMediaKey,\r\n\r\n        ...item,\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return item;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 3) updateClosetMediaKey \u2013 update mediaKey on an item owned by the user.\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleUpdateClosetMediaKey(\r\n  args: { closetItemId: string; mediaKey: string },\r\n  identity: SAIdentity,\r\n): Promise<ClosetItem> {\r\n  requireBestieTier(identity);\r\n  const sub = requireUserSub(identity);\r\n  const now = nowIso();\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: ddbMarshal({\r\n        pk: pkForUser(sub),\r\n        sk: skForClosetItem(args.closetItemId),\r\n      }),\r\n      UpdateExpression:\r\n        \"SET mediaKey = :mediaKey, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":mediaKey\": args.mediaKey,\r\n        \":updatedAt\": now,\r\n        \":gsi1pk\": gsi1ForStatus(\"DRAFT\"),\r\n        \":gsi1sk\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Item not found\");\r\n  }\r\n\r\n  return mapClosetItem(res.Attributes);\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 4) requestClosetApproval \u2013 mark DRAFT\u2192PENDING and kick off Step Functions.\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleRequestClosetApproval(\r\n  args: { closetItemId: string },\r\n  identity: SAIdentity,\r\n): Promise<ClosetItem> {\r\n  requireBestieTier(identity);\r\n  const sub = requireUserSub(identity);\r\n  const now = nowIso();\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: ddbMarshal({\r\n        pk: pkForUser(sub),\r\n        sk: skForClosetItem(args.closetItemId),\r\n      }),\r\n      ConditionExpression: \"status = :draft\",\r\n      UpdateExpression:\r\n        \"SET status = :pending, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":draft\": \"DRAFT\",\r\n        \":pending\": \"PENDING\",\r\n        \":updatedAt\": now,\r\n        \":gsi1pk\": gsi1ForStatus(\"PENDING\"),\r\n        \":gsi1sk\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Item not found or not in DRAFT status\");\r\n  }\r\n\r\n  const item = mapClosetItem(res.Attributes);\r\n\r\n  // Fire-and-forget Step Functions execution\r\n  await sfn.send(\r\n    new StartExecutionCommand({\r\n      stateMachineArn: APPROVAL_SM_ARN,\r\n      input: JSON.stringify({\r\n        itemId: item.id,\r\n        userId: item.userId,\r\n        ownerSub: item.ownerSub,\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return item;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 5) updateClosetItemStory \u2013 Bestie-side metadata (legacy/simple version).\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleUpdateClosetItemStory(\r\n  args: { closetItemId: string; story: string },\r\n  identity: SAIdentity,\r\n): Promise<ClosetItem> {\r\n  requireBestieTier(identity);\r\n  const sub = requireUserSub(identity);\r\n  const { closetItemId, story } = args;\r\n\r\n  const now = nowIso();\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: ddbMarshal({\r\n        pk: pkForUser(sub),\r\n        sk: skForClosetItem(closetItemId),\r\n      }),\r\n      UpdateExpression:\r\n        \"SET storyTitle = :storyTitle, updatedAt = :updatedAt\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":storyTitle\": story,\r\n        \":updatedAt\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Item not found\");\r\n  }\r\n\r\n  return mapClosetItem(res.Attributes);\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// Helper: load closet item by id (scan by sk).\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function loadClosetItemById(\r\n  closetItemId: string,\r\n): Promise<{ base: ClosetItem; ownerId: string }> {\r\n  const scanRes = await ddb.send(\r\n    new ScanCommand({\r\n      TableName: TABLE_NAME,\r\n      FilterExpression: \"sk = :sk\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":sk\": skForClosetItem(closetItemId),\r\n      }),\r\n    }),\r\n  );\r\n\r\n  const raw = (scanRes.Items ?? [])[0];\r\n  if (!raw) {\r\n    throw new Error(\"Closet item not found\");\r\n  }\r\n\r\n  const base = mapClosetItem(raw);\r\n  const ownerId = base.userId;\r\n  if (!ownerId) {\r\n    throw new Error(\"Closet item missing owner\");\r\n  }\r\n\r\n  return { base, ownerId };\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 6) likeClosetItem \u2013 public like/heart interaction (legacy).\r\n//     Fans ARE allowed to like (no tier restriction here).\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleLikeClosetItem(\r\n  args: { closetItemId: string },\r\n  identity: SAIdentity,\r\n): Promise<ClosetItem> {\r\n  const viewerSub = requireUserSub(identity);\r\n  const { closetItemId } = args;\r\n  const now = nowIso();\r\n\r\n  const { ownerId } = await loadClosetItemById(closetItemId);\r\n\r\n  const likeItem = {\r\n    pk: pkForClosetRoot(closetItemId),\r\n    sk: `LIKE#${viewerSub}`,\r\n    entityType: \"LIKE\",\r\n    itemOwnerSub: ownerId,\r\n    likerSub: viewerSub,\r\n    createdAt: now,\r\n  };\r\n\r\n  try {\r\n    await ddb.send(\r\n      new PutItemCommand({\r\n        TableName: TABLE_NAME,\r\n        Item: ddbMarshal(likeItem),\r\n        // de-dupe per viewer\r\n        ConditionExpression: \"attribute_not_exists(sk)\",\r\n      }),\r\n    );\r\n  } catch (err: any) {\r\n    if (err?.name !== \"ConditionalCheckFailedException\") {\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: ddbMarshal({\r\n        pk: pkForUser(ownerId),\r\n        sk: skForClosetItem(closetItemId),\r\n      }),\r\n      UpdateExpression:\r\n        \"SET likeCount = if_not_exists(likeCount, :zero) + :one, updatedAt = :now\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":zero\": 0,\r\n        \":one\": 1,\r\n        \":now\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Closet item not found\");\r\n  }\r\n\r\n  const item = mapClosetItem(res.Attributes);\r\n  item.viewerHasLiked = true;\r\n\r\n  // Engagement: increment like analytics\r\n  await putEngagementEvent({\r\n    action: \"LIKED\",\r\n    closetItemId,\r\n    ownerSub: ownerId,\r\n    actorSub: viewerSub,\r\n    delta: 1,\r\n  });\r\n\r\n  return item;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 7) commentOnClosetItem \u2013 COMMENT child + bump commentCount\r\n//     Fans ARE allowed to comment.\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleCommentOnClosetItem(\r\n  args: { closetItemId: string; text: string },\r\n  identity: SAIdentity,\r\n): Promise<ClosetItemComment> {\r\n  const authorSub = requireUserSub(identity);\r\n  const { closetItemId, text } = args;\r\n  const now = nowIso();\r\n  const commentId = randomUUID();\r\n\r\n  const { ownerId } = await loadClosetItemById(closetItemId);\r\n\r\n  const commentItem = {\r\n    pk: pkForClosetRoot(closetItemId),\r\n    sk: `COMMENT#${commentId}`,\r\n    entityType: \"COMMENT\",\r\n    closetItemId,\r\n    itemOwnerSub: ownerId,\r\n    authorSub,\r\n    text,\r\n    createdAt: now,\r\n  };\r\n\r\n  await ddb.send(\r\n    new PutItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Item: ddbMarshal(commentItem),\r\n    }),\r\n  );\r\n\r\n  await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: ddbMarshal({\r\n        pk: pkForUser(ownerId),\r\n        sk: skForClosetItem(closetItemId),\r\n      }),\r\n      UpdateExpression:\r\n        \"SET commentCount = if_not_exists(commentCount, :zero) + :one, updatedAt = :now\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":zero\": 0,\r\n        \":one\": 1,\r\n        \":now\": now,\r\n      }),\r\n    }),\r\n  );\r\n\r\n  const comment: ClosetItemComment = {\r\n    id: commentId,\r\n    closetItemId,\r\n    authorSub,\r\n    text,\r\n    createdAt: now,\r\n  };\r\n\r\n  // Engagement: comment analytics\r\n  await putEngagementEvent({\r\n    action: \"COMMENTED\",\r\n    closetItemId,\r\n    ownerSub: ownerId,\r\n    actorSub: authorSub,\r\n    commentId,\r\n    commentText: text,\r\n  });\r\n\r\n  return comment;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 8) pinHighlight \u2013 owner (or admin) can pin/unpin a closet item.\r\n//     Bestie+ only (fans can't pin).\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handlePinHighlight(\r\n  args: { closetItemId: string; pinned: boolean },\r\n  identity: SAIdentity,\r\n): Promise<ClosetItem> {\r\n  // Bestie+ only\r\n  requireBestieTier(identity);\r\n\r\n  const callerSub = requireUserSub(identity);\r\n  const admin = isAdminIdentity(identity);\r\n\r\n  const closetItemId = args.closetItemId;\r\n  const pinned = !!args.pinned;\r\n\r\n  if (!closetItemId) {\r\n    throw new Error(\"closetItemId is required\");\r\n  }\r\n\r\n  const { base } = await loadClosetItemById(closetItemId);\r\n\r\n  if (!admin && base.userId !== callerSub) {\r\n    throw new Error(\"Not authorized to pin this closet item.\");\r\n  }\r\n\r\n  const now = nowIso();\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: ddbMarshal({\r\n        pk: pkForUser(base.userId),\r\n        sk: skForClosetItem(base.id),\r\n      }),\r\n      UpdateExpression: \"SET pinned = :pinned, updatedAt = :now\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":pinned\": pinned,\r\n        \":now\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Closet item not found after update\");\r\n  }\r\n\r\n  return mapClosetItem(res.Attributes);\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 9) closetItemComments \u2013 query all COMMENT# children\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleClosetItemComments(args: {\r\n  closetItemId: string;\r\n}): Promise<ClosetItemComment[]> {\r\n  const { closetItemId } = args;\r\n\r\n  const res = await ddb.send(\r\n    new QueryCommand({\r\n      TableName: TABLE_NAME,\r\n      KeyConditionExpression: \"pk = :pk AND begins_with(sk, :sk)\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":pk\": pkForClosetRoot(closetItemId),\r\n        \":sk\": \"COMMENT#\",\r\n      }),\r\n    }),\r\n  );\r\n\r\n  const items = (res.Items ?? []).map((raw) => unmarshall(raw) as any);\r\n\r\n  return items.map((item) => ({\r\n    id: (item.sk as string).replace(\"COMMENT#\", \"\"),\r\n    closetItemId: item.closetItemId,\r\n    authorSub: item.authorSub,\r\n    text: item.text,\r\n    createdAt: item.createdAt,\r\n  }));\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 10) adminClosetItemLikes \u2013 admin view of LIKE children\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleAdminClosetItemLikes(args: {\r\n  closetItemId: string;\r\n}): Promise<ClosetItemLike[]> {\r\n  const { closetItemId } = args;\r\n\r\n  const res = await ddb.send(\r\n    new QueryCommand({\r\n      TableName: TABLE_NAME,\r\n      KeyConditionExpression: \"pk = :pk AND begins_with(sk, :sk)\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":pk\": pkForClosetRoot(closetItemId),\r\n        \":sk\": \"LIKE#\",\r\n      }),\r\n    }),\r\n  );\r\n\r\n  const items = (res.Items ?? []).map((raw) => unmarshall(raw) as any);\r\n\r\n  return items.map((item) => ({\r\n    closetItemId,\r\n    likerSub: item.likerSub,\r\n    createdAt: item.createdAt,\r\n  }));\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 11) adminClosetItemComments \u2013 alias for closetItemComments\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleAdminClosetItemComments(args: {\r\n  closetItemId: string;\r\n}): Promise<ClosetItemComment[]> {\r\n  return handleClosetItemComments(args);\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 12) toggleWishlistItem \u2013 viewer's wishlist for a closet item.\r\n//     Bestie+ only. Fans cannot maintain a wishlist.\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleToggleWishlistItem(\r\n  args: { closetItemId: string; on?: boolean | null },\r\n  identity: SAIdentity,\r\n): Promise<ClosetItem> {\r\n  // Bestie+ only for wishlist\r\n  requireBestieTier(identity);\r\n\r\n  const viewerSub = requireUserSub(identity);\r\n  const { closetItemId, on } = args;\r\n  const now = nowIso();\r\n\r\n  const { ownerId } = await loadClosetItemById(closetItemId);\r\n\r\n  const wishlistPk = pkForUser(viewerSub);\r\n  const wishlistSk = `WISHLIST#${closetItemId}`;\r\n\r\n  // Turning OFF\r\n  if (on === false) {\r\n    await ddb.send(\r\n      new DeleteItemCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: ddbMarshal({\r\n          pk: wishlistPk,\r\n          sk: wishlistSk,\r\n        }),\r\n      }),\r\n    );\r\n\r\n    let updated: ClosetItem | undefined;\r\n\r\n    try {\r\n      const res = await ddb.send(\r\n        new UpdateItemCommand({\r\n          TableName: TABLE_NAME,\r\n          Key: ddbMarshal({\r\n            pk: pkForUser(ownerId),\r\n            sk: skForClosetItem(closetItemId),\r\n          }),\r\n          UpdateExpression:\r\n            \"SET wishlistCount = if_not_exists(wishlistCount, :zero) - :one, updatedAt = :now\",\r\n          ConditionExpression: \"wishlistCount >= :one\",\r\n          ExpressionAttributeValues: ddbMarshal({\r\n            \":zero\": 0,\r\n            \":one\": 1,\r\n            \":now\": now,\r\n          }),\r\n          ReturnValues: \"ALL_NEW\",\r\n        }),\r\n      );\r\n      if (res.Attributes) {\r\n        updated = mapClosetItem(res.Attributes);\r\n      }\r\n    } catch (err: any) {\r\n      if (err?.name !== \"ConditionalCheckFailedException\") {\r\n        throw err;\r\n      }\r\n      const fallbackRes = await ddb.send(\r\n        new QueryCommand({\r\n          TableName: TABLE_NAME,\r\n          KeyConditionExpression: \"pk = :pk AND sk = :sk\",\r\n          ExpressionAttributeValues: ddbMarshal({\r\n            \":pk\": pkForUser(ownerId),\r\n            \":sk\": skForClosetItem(closetItemId),\r\n          }),\r\n        }),\r\n      );\r\n      const itemRaw = (fallbackRes.Items ?? [])[0];\r\n      if (itemRaw) {\r\n        updated = mapClosetItem(itemRaw);\r\n      }\r\n    }\r\n\r\n    if (!updated) {\r\n      throw new Error(\"Closet item not found\");\r\n    }\r\n\r\n    updated.viewerHasWishlisted = false;\r\n\r\n    // Engagement: wishlist off\r\n    await putEngagementEvent({\r\n      action: \"WISHLIST_TOGGLED\",\r\n      closetItemId,\r\n      ownerSub: ownerId,\r\n      actorSub: viewerSub,\r\n      delta: -1,\r\n    });\r\n\r\n    return updated;\r\n  }\r\n\r\n  // Turning ON (or default toggle-on)\r\n  const wishlistItem = {\r\n    pk: wishlistPk,\r\n    sk: wishlistSk,\r\n    entityType: \"WISHLIST\",\r\n    closetItemId,\r\n    ownerSub: ownerId,\r\n    viewerSub,\r\n    createdAt: now,\r\n  };\r\n\r\n  try {\r\n    await ddb.send(\r\n      new PutItemCommand({\r\n        TableName: TABLE_NAME,\r\n        Item: ddbMarshal(wishlistItem),\r\n        // de-dupe per viewer+item\r\n        ConditionExpression: \"attribute_not_exists(sk)\",\r\n      }),\r\n    );\r\n  } catch (err: any) {\r\n    if (err?.name !== \"ConditionalCheckFailedException\") {\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: ddbMarshal({\r\n        pk: pkForUser(ownerId),\r\n        sk: skForClosetItem(closetItemId),\r\n      }),\r\n      UpdateExpression:\r\n        \"SET wishlistCount = if_not_exists(wishlistCount, :zero) + :one, updatedAt = :now\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":zero\": 0,\r\n        \":one\": 1,\r\n        \":now\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Closet item not found\");\r\n  }\r\n\r\n  const item = mapClosetItem(res.Attributes);\r\n  item.viewerHasWishlisted = true;\r\n\r\n  // Engagement: wishlist on\r\n  await putEngagementEvent({\r\n    action: \"WISHLIST_TOGGLED\",\r\n    closetItemId,\r\n    ownerSub: ownerId,\r\n    actorSub: viewerSub,\r\n    delta: 1,\r\n  });\r\n\r\n  return item;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 13) myWishlist \u2013 viewer's wishlist expanded to ClosetItem\r\n//     Now returns a ClosetConnection. FREE \u2192 empty list.\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleMyWishlist(identity: SAIdentity): Promise<ClosetConnection> {\r\n  assertAuth(identity);\r\n  const tier = getUserTier(identity);\r\n\r\n  if (tier === \"FREE\") {\r\n    // Fans don't have a persistent wishlist\r\n    return { items: [], nextToken: null };\r\n  }\r\n\r\n  const viewerSub = identity!.sub as string;\r\n\r\n  const res = await ddb.send(\r\n    new QueryCommand({\r\n      TableName: TABLE_NAME,\r\n      KeyConditionExpression: \"pk = :pk AND begins_with(sk, :sk)\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":pk\": pkForUser(viewerSub),\r\n        \":sk\": \"WISHLIST#\",\r\n      }),\r\n    }),\r\n  );\r\n\r\n  const entries = (res.Items ?? []).map((raw) => unmarshall(raw) as any);\r\n\r\n  if (!entries.length) {\r\n    return {\r\n      items: [],\r\n      nextToken: null,\r\n    };\r\n  }\r\n\r\n  const keys = entries.map((e) => ({\r\n    pk: pkForUser(e.ownerSub),\r\n    sk: skForClosetItem(e.closetItemId),\r\n  }));\r\n\r\n  const batchRes = await ddb.send(\r\n    new BatchGetItemCommand({\r\n      RequestItems: {\r\n        [TABLE_NAME]: {\r\n          Keys: keys.map((k) => ddbMarshal(k)),\r\n        },\r\n      },\r\n    }),\r\n  );\r\n\r\n  const itemsRaw = batchRes.Responses?.[TABLE_NAME] ?? [];\r\n  const closetItems = itemsRaw.map(mapClosetItem);\r\n\r\n  for (const ci of closetItems) {\r\n    ci.viewerHasWishlisted = true;\r\n  }\r\n\r\n  return {\r\n    items: closetItems,\r\n    nextToken: null,\r\n  };\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 14) pinnedClosetItems \u2013 child resolver for GameProfile.pinnedClosetItems\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handlePinnedClosetItems(event: any): Promise<ClosetItem[]> {\r\n  const source = event.source || {};\r\n  const identity: SAIdentity = event.identity || {};\r\n\r\n  const userId: string | undefined =\r\n    (source.userId as string | undefined) ||\r\n    (source.id as string | undefined) ||\r\n    (identity?.sub as string | undefined);\r\n\r\n  if (!userId) {\r\n    throw new Error(\"Cannot resolve pinnedClosetItems: missing userId\");\r\n  }\r\n\r\n  const res = await ddb.send(\r\n    new QueryCommand({\r\n      TableName: TABLE_NAME,\r\n      KeyConditionExpression: \"pk = :pk AND begins_with(sk, :sk)\",\r\n      FilterExpression: \"#pinned = :true AND #status = :published\",\r\n      ExpressionAttributeNames: {\r\n        \"#pinned\": \"pinned\",\r\n        \"#status\": \"status\",\r\n      },\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":pk\": pkForUser(userId),\r\n        \":sk\": \"CLOSET#\",\r\n        \":true\": true,\r\n        \":published\": \"PUBLISHED\",\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return (res.Items ?? []).map(mapClosetItem);\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 15) closetFeed \u2013 public community feed for Lala\u2019s Closet\r\n//     (Already returning ClosetConnection.)\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleClosetFeed(event: any): Promise<ClosetConnection> {\r\n  const args: ClosetFeedArgs = event?.arguments || {};\r\n  const sort: ClosetFeedSort = args.sort || \"NEWEST\";\r\n\r\n  const limit =\r\n    args.limit && args.limit > 0 && args.limit <= 50 ? args.limit : 24;\r\n\r\n  const statuses: ClosetStatus[] = [\"APPROVED\", \"PUBLISHED\"];\r\n  const collected: ClosetItem[] = [];\r\n\r\n  for (const status of statuses) {\r\n    const resp = await ddb.send(\r\n      new QueryCommand({\r\n        TableName: TABLE_NAME,\r\n        IndexName: STATUS_GSI,\r\n        KeyConditionExpression: \"gsi1pk = :pk\",\r\n        ExpressionAttributeValues: ddbMarshal({\r\n          \":pk\": gsi1ForStatus(status),\r\n        }),\r\n        ScanIndexForward: false, // newest first\r\n        Limit: limit * 2,\r\n      }),\r\n    );\r\n\r\n    const chunk = (resp.Items ?? []).map(mapClosetItem);\r\n    collected.push(...chunk);\r\n  }\r\n\r\n  // Only show fan-facing looks (PUBLIC audience).\r\n  const filtered = collected.filter((item) => {\r\n    const statusOk =\r\n      item.status === \"APPROVED\" || item.status === \"PUBLISHED\";\r\n\r\n    const audience =\r\n      (item.audience as ClosetAudience | undefined) ?? \"PUBLIC\";\r\n    const audienceOk = audience === \"PUBLIC\";\r\n\r\n    return statusOk && audienceOk;\r\n  });\r\n\r\n  // De-dupe by id in case an item appears twice\r\n  const byId = new Map<string, ClosetItem>();\r\n  for (const it of filtered) {\r\n    if (!byId.has(it.id)) {\r\n      byId.set(it.id, it);\r\n    }\r\n  }\r\n\r\n  const unique = Array.from(byId.values());\r\n\r\n  unique.sort((a, b) => {\r\n    const aCreated = a.createdAt || \"\";\r\n    const bCreated = b.createdAt || \"\";\r\n\r\n    if (sort === \"MOST_LOVED\") {\r\n      const af = a.favoriteCount ?? 0;\r\n      const bf = b.favoriteCount ?? 0;\r\n      if (bf !== af) return bf - af;\r\n      return bCreated.localeCompare(aCreated);\r\n    }\r\n\r\n    // NEWEST\r\n    return bCreated.localeCompare(aCreated);\r\n  });\r\n\r\n  const pageItems = unique.slice(0, limit);\r\n\r\n  // For now we don't paginate beyond this, so nextToken is always null.\r\n  return {\r\n    items: pageItems,\r\n    nextToken: null,\r\n  };\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 16) toggleFavoriteClosetItem \u2013 hearts in fan closet feed\r\n//     Fans ARE allowed to favorite feed items.\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleToggleFavoriteClosetItem(\r\n  args: { id: string; favoriteOn?: boolean | null },\r\n  identity: SAIdentity,\r\n): Promise<ClosetItem> {\r\n  const viewerSub = requireUserSub(identity);\r\n  const { id: closetItemId, favoriteOn } = args;\r\n  const now = nowIso();\r\n\r\n  const { ownerId } = await loadClosetItemById(closetItemId);\r\n\r\n  const pkRoot = pkForClosetRoot(closetItemId);\r\n  const skFavorite = `FAVORITE#${viewerSub}`;\r\n\r\n  // Turning OFF\r\n  if (favoriteOn === false) {\r\n    await ddb.send(\r\n      new DeleteItemCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: ddbMarshal({\r\n          pk: pkRoot,\r\n          sk: skFavorite,\r\n        }),\r\n      }),\r\n    );\r\n\r\n    let updated: ClosetItem | undefined;\r\n\r\n    try {\r\n      const res = await ddb.send(\r\n        new UpdateItemCommand({\r\n          TableName: TABLE_NAME,\r\n          Key: ddbMarshal({\r\n            pk: pkForUser(ownerId),\r\n            sk: skForClosetItem(closetItemId),\r\n          }),\r\n          UpdateExpression:\r\n            \"SET favoriteCount = if_not_exists(favoriteCount, :zero) - :one, updatedAt = :now\",\r\n          ConditionExpression: \"favoriteCount >= :one\",\r\n          ExpressionAttributeValues: ddbMarshal({\r\n            \":zero\": 0,\r\n            \":one\": 1,\r\n            \":now\": now,\r\n          }),\r\n          ReturnValues: \"ALL_NEW\",\r\n        }),\r\n      );\r\n      if (res.Attributes) {\r\n        updated = mapClosetItem(res.Attributes);\r\n      }\r\n    } catch (err: any) {\r\n      if (err?.name !== \"ConditionalCheckFailedException\") {\r\n        throw err;\r\n      }\r\n      const fallbackRes = await ddb.send(\r\n        new QueryCommand({\r\n          TableName: TABLE_NAME,\r\n          KeyConditionExpression: \"pk = :pk AND sk = :sk\",\r\n          ExpressionAttributeValues: ddbMarshal({\r\n            \":pk\": pkForUser(ownerId),\r\n            \":sk\": skForClosetItem(closetItemId),\r\n          }),\r\n        }),\r\n      );\r\n      const itemRaw = (fallbackRes.Items ?? [])[0];\r\n      if (itemRaw) {\r\n        updated = mapClosetItem(itemRaw);\r\n      }\r\n    }\r\n\r\n    if (!updated) {\r\n      throw new Error(\"Closet item not found\");\r\n    }\r\n\r\n    updated.viewerHasFaved = false;\r\n    return updated;\r\n  }\r\n\r\n  // Turning ON (or default toggle-on)\r\n  const favoriteItem = {\r\n    pk: pkRoot,\r\n    sk: skFavorite,\r\n    entityType: \"FAVORITE\",\r\n    closetItemId,\r\n    ownerSub: ownerId,\r\n    viewerSub,\r\n    createdAt: now,\r\n  };\r\n\r\n  try {\r\n    await ddb.send(\r\n      new PutItemCommand({\r\n        TableName: TABLE_NAME,\r\n        Item: ddbMarshal(favoriteItem),\r\n        // de-dupe per viewer\r\n        ConditionExpression: \"attribute_not_exists(sk)\",\r\n      }),\r\n    );\r\n  } catch (err: any) {\r\n    if (err?.name !== \"ConditionalCheckFailedException\") {\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: ddbMarshal({\r\n        pk: pkForUser(ownerId),\r\n        sk: skForClosetItem(closetItemId),\r\n      }),\r\n      UpdateExpression:\r\n        \"SET favoriteCount = if_not_exists(favoriteCount, :zero) + :one, updatedAt = :now\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":zero\": 0,\r\n        \":one\": 1,\r\n        \":now\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Closet item not found\");\r\n  }\r\n\r\n  const item = mapClosetItem(res.Attributes);\r\n  item.viewerHasFaved = true;\r\n  return item;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 17) requestClosetBackgroundChange \u2013 Besties-only, kicks BG SM\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleRequestClosetBackgroundChange(\r\n  args: {\r\n    closetItemId: string;\r\n    requestedBackgroundKey?: string | null;\r\n    mode?: string | null;\r\n  },\r\n  identity: SAIdentity,\r\n): Promise<ClosetItem> {\r\n  requireBestieTier(identity);\r\n  const callerSub = requireUserSub(identity);\r\n  const { closetItemId, requestedBackgroundKey, mode } = args;\r\n  const now = nowIso();\r\n\r\n  const { base } = await loadClosetItemById(closetItemId);\r\n\r\n  if (base.userId !== callerSub && !isAdminIdentity(identity)) {\r\n    throw new Error(\"Not authorized to change background for this item\");\r\n  }\r\n\r\n  // Persist pending background metadata on the closet item\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: ddbMarshal({\r\n        pk: pkForUser(base.userId),\r\n        sk: skForClosetItem(base.id),\r\n      }),\r\n      UpdateExpression:\r\n        \"SET pendingBackgroundKey = :bg, updatedAt = :now\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":bg\": requestedBackgroundKey ?? null,\r\n        \":now\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Closet item not found while setting background\");\r\n  }\r\n\r\n  const updated = mapClosetItem(res.Attributes);\r\n\r\n  await sfn.send(\r\n    new StartExecutionCommand({\r\n      stateMachineArn: BG_CHANGE_SM_ARN,\r\n      input: JSON.stringify({\r\n        closetItemId: updated.id,\r\n        userId: updated.userId,\r\n        ownerSub: updated.ownerSub,\r\n        requestedBackgroundKey: requestedBackgroundKey ?? null,\r\n        mode: mode ?? \"REPLACE\",\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return updated;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 18) createStory \u2013 Besties story creation (DRAFT)\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleCreateStory(\r\n  args: {\r\n    input: {\r\n      title?: string | null;\r\n      closetItemIds?: string[] | null;\r\n      scheduledAt?: string | null;\r\n    };\r\n  },\r\n  identity: SAIdentity,\r\n): Promise<Story> {\r\n  requireBestieTier(identity);\r\n  const sub = requireUserSub(identity);\r\n  const now = nowIso();\r\n  const storyId = randomUUID();\r\n\r\n  const input = args.input || {};\r\n  const story: Story = {\r\n    id: storyId,\r\n    userId: sub,\r\n    ownerSub: sub,\r\n    title: input.title ?? undefined,\r\n    createdAt: now,\r\n    updatedAt: now,\r\n    status: \"DRAFT\",\r\n    closetItemIds: input.closetItemIds ?? [],\r\n    scheduledAt: input.scheduledAt ?? null,\r\n  };\r\n\r\n  await ddb.send(\r\n    new PutItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Item: ddbMarshal({\r\n        pk: pkForUser(sub),\r\n        sk: skForStory(storyId),\r\n        entityType: \"STORY\",\r\n        ...story,\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return story;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 19) publishStory \u2013 Besties story publish (kicks Story SM)\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handlePublishStory(\r\n  args: {\r\n    storyId: string;\r\n    scheduledAt?: string | null;\r\n  },\r\n  identity: SAIdentity,\r\n): Promise<Story> {\r\n  requireBestieTier(identity);\r\n  const sub = requireUserSub(identity);\r\n  const { storyId, scheduledAt } = args;\r\n  const now = nowIso();\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: ddbMarshal({\r\n        pk: pkForUser(sub),\r\n        sk: skForStory(storyId),\r\n      }),\r\n      UpdateExpression:\r\n        \"SET #status = :pending, updatedAt = :now, scheduledAt = :scheduledAt\",\r\n      ExpressionAttributeNames: {\r\n        \"#status\": \"status\",\r\n      },\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":pending\": \"PENDING_PUBLISH\",\r\n        \":now\": now,\r\n        \":scheduledAt\": scheduledAt ?? null,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Story not found\");\r\n  }\r\n\r\n  const story = unmarshall(res.Attributes) as Story;\r\n\r\n  await sfn.send(\r\n    new StartExecutionCommand({\r\n      stateMachineArn: STORY_PUBLISH_SM_ARN,\r\n      input: JSON.stringify({\r\n        storyId: story.id,\r\n        userId: story.userId,\r\n        ownerSub: story.ownerSub,\r\n        scheduledAt: story.scheduledAt ?? null,\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return story;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 20) addClosetItemToCommunityFeed \u2013 Besties-only\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleAddClosetItemToCommunityFeed(\r\n  args: { closetItemId: string },\r\n  identity: SAIdentity,\r\n): Promise<ClosetItem> {\r\n  requireBestieTier(identity);\r\n  const callerSub = requireUserSub(identity);\r\n  const { closetItemId } = args;\r\n  const now = nowIso();\r\n\r\n  const { base } = await loadClosetItemById(closetItemId);\r\n\r\n  if (base.userId !== callerSub && !isAdminIdentity(identity)) {\r\n    throw new Error(\"Not authorized to feature this item\");\r\n  }\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: ddbMarshal({\r\n        pk: pkForUser(base.userId),\r\n        sk: skForClosetItem(base.id),\r\n      }),\r\n      UpdateExpression:\r\n        \"SET inCommunityFeed = :true, updatedAt = :now\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":true\": true,\r\n        \":now\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Closet item not found\");\r\n  }\r\n\r\n  const updated = mapClosetItem(res.Attributes);\r\n\r\n  // Engagement: create COMMUNITY_FEED record via Engagement Lambda\r\n  await putEngagementEvent({\r\n    action: \"COMMUNITY_FEATURED\",\r\n    closetItemId,\r\n    ownerSub: base.userId,\r\n    actorSub: callerSub,\r\n  });\r\n\r\n  return updated;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 21) removeClosetItemFromCommunityFeed \u2013 Besties-only\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleRemoveClosetItemFromCommunityFeed(\r\n  args: { closetItemId: string },\r\n  identity: SAIdentity,\r\n): Promise<ClosetItem> {\r\n  requireBestieTier(identity);\r\n  const callerSub = requireUserSub(identity);\r\n  const { closetItemId } = args;\r\n  const now = nowIso();\r\n\r\n  const { base } = await loadClosetItemById(closetItemId);\r\n\r\n  if (base.userId !== callerSub && !isAdminIdentity(identity)) {\r\n    throw new Error(\"Not authorized to unfeature this item\");\r\n  }\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: ddbMarshal({\r\n        pk: pkForUser(base.userId),\r\n        sk: skForClosetItem(base.id),\r\n      }),\r\n      UpdateExpression:\r\n        \"SET inCommunityFeed = :false, updatedAt = :now\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":false\": false,\r\n        \":now\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Closet item not found\");\r\n  }\r\n\r\n  return mapClosetItem(res.Attributes);\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// 22) shareClosetItemToPinterest \u2013 fire-and-forget event record\r\n//     Besties-only sharing of their looks.\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleShareClosetItemToPinterest(\r\n  args: { closetItemId: string },\r\n  identity: SAIdentity,\r\n): Promise<boolean> {\r\n  requireBestieTier(identity);\r\n  const sharerSub = requireUserSub(identity);\r\n  const { closetItemId } = args;\r\n  const now = nowIso();\r\n\r\n  const { ownerId } = await loadClosetItemById(closetItemId);\r\n\r\n  const shareItem = {\r\n    pk: pkForClosetRoot(closetItemId),\r\n    sk: `PINTEREST_SHARE#${randomUUID()}`,\r\n    entityType: \"PINTEREST_SHARE\",\r\n    closetItemId,\r\n    itemOwnerSub: ownerId,\r\n    sharerSub,\r\n    createdAt: now,\r\n  };\r\n\r\n  await ddb.send(\r\n    new PutItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Item: ddbMarshal(shareItem),\r\n    }),\r\n  );\r\n\r\n  // Engagement: let EngagementFn track Pinterest share analytics\r\n  await putEngagementEvent({\r\n    action: \"PINTEREST_SHARE_REQUESTED\",\r\n    closetItemId,\r\n    ownerSub: ownerId,\r\n    actorSub: sharerSub,\r\n  });\r\n\r\n  // Downstream worker (EventBridge/Streams) can do the actual API call\r\n  return true;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// AppSync Lambda resolver entrypoint\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nexport const handler = async (event: any) => {\r\n  console.log(\"ClosetResolverFn event\", JSON.stringify(event));\r\n\r\n  const fieldName = event.info?.fieldName as string | undefined;\r\n\r\n  try {\r\n    switch (fieldName) {\r\n      case \"myCloset\":\r\n        return await handleMyCloset(event.identity);\r\n\r\n      case \"bestieClosetItems\":\r\n        return await handleBestieClosetItems(\r\n          event.arguments || {},\r\n          event.identity,\r\n        );\r\n\r\n      case \"myWishlist\":\r\n        return await handleMyWishlist(event.identity);\r\n\r\n      case \"createClosetItem\":\r\n        return await handleCreateClosetItem(event.arguments, event.identity);\r\n\r\n      case \"updateClosetMediaKey\":\r\n        return await handleUpdateClosetMediaKey(\r\n          event.arguments,\r\n          event.identity,\r\n        );\r\n\r\n      case \"requestClosetApproval\":\r\n        return await handleRequestClosetApproval(\r\n          event.arguments,\r\n          event.identity,\r\n        );\r\n\r\n      case \"updateClosetItemStory\":\r\n        return await handleUpdateClosetItemStory(\r\n          event.arguments,\r\n          event.identity,\r\n        );\r\n\r\n      case \"likeClosetItem\":\r\n        return await handleLikeClosetItem(event.arguments, event.identity);\r\n\r\n      case \"commentOnClosetItem\":\r\n        return await handleCommentOnClosetItem(\r\n          event.arguments,\r\n          event.identity,\r\n        );\r\n\r\n      case \"pinHighlight\":\r\n        return await handlePinHighlight(event.arguments, event.identity);\r\n\r\n      case \"closetItemComments\":\r\n        return await handleClosetItemComments(event.arguments);\r\n\r\n      case \"adminClosetItemLikes\":\r\n        return await handleAdminClosetItemLikes(event.arguments);\r\n\r\n      case \"adminClosetItemComments\":\r\n        return await handleAdminClosetItemComments(event.arguments);\r\n\r\n      case \"toggleWishlistItem\":\r\n        return await handleToggleWishlistItem(\r\n          event.arguments,\r\n          event.identity,\r\n        );\r\n\r\n      case \"pinnedClosetItems\":\r\n        return await handlePinnedClosetItems(event);\r\n\r\n      case \"closetFeed\":\r\n        return await handleClosetFeed(event);\r\n\r\n      case \"toggleFavoriteClosetItem\":\r\n        return await handleToggleFavoriteClosetItem(\r\n          event.arguments,\r\n          event.identity,\r\n        );\r\n\r\n      // NEW Besties workflows\r\n      case \"requestClosetBackgroundChange\":\r\n        return await handleRequestClosetBackgroundChange(\r\n          event.arguments,\r\n          event.identity,\r\n        );\r\n\r\n      case \"createStory\":\r\n        return await handleCreateStory(event.arguments, event.identity);\r\n\r\n      case \"publishStory\":\r\n        return await handlePublishStory(event.arguments, event.identity);\r\n\r\n      case \"addClosetItemToCommunityFeed\":\r\n        return await handleAddClosetItemToCommunityFeed(\r\n          event.arguments,\r\n          event.identity,\r\n        );\r\n\r\n      case \"removeClosetItemFromCommunityFeed\":\r\n        return await handleRemoveClosetItemFromCommunityFeed(\r\n          event.arguments,\r\n          event.identity,\r\n        );\r\n\r\n      case \"shareClosetItemToPinterest\":\r\n        return await handleShareClosetItemToPinterest(\r\n          event.arguments,\r\n          event.identity,\r\n        );\r\n\r\n      default:\r\n        throw new Error(`Unsupported field: ${fieldName}`);\r\n    }\r\n  } catch (err) {\r\n    console.error(\"Error in ClosetResolverFn\", err);\r\n    throw err;\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["index_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_client_sfn", "import_client_eventbridge", "import_util_dynamodb", "import_crypto", "ddbMarshal", "value", "TABLE_NAME", "APPROVAL_SM_ARN", "BG_CHANGE_SM_ARN", "STORY_PUBLISH_SM_ARN", "STATUS_GSI", "ddb", "sfn", "eb", "getUserTier", "identity", "claims", "claimTier", "rawGroups", "groups", "g", "assertAuth", "assertBestieOrHigher", "requireBestieTier", "nowIso", "pkForUser", "userId", "skForClosetItem", "id", "skForStory", "pkForClosetRoot", "closetItemId", "gsi1ForStatus", "status", "extractIdFromSk", "sk", "putEngagementEvent", "detail", "err", "mapClosetItem", "raw", "item", "inferredUserFromPk", "ownerSub", "createdAt", "updatedAt", "requireUserSub", "isAdminIdentity", "handleMyCloset", "sub", "ci", "handleBestieClosetItems", "args", "allItems", "limit", "handleCreateClosetItem", "now", "input", "handleUpdateClosetMediaKey", "res", "handleRequestClosetApproval", "handleUpdateClosetItemStory", "story", "loadClosetItemById", "base", "ownerId", "handleLikeClosetItem", "viewerSub", "likeItem", "handleCommentOnClosetItem", "authorSub", "text", "commentId", "commentItem", "comment", "handlePinHighlight", "callerSub", "admin", "pinned", "handleClosetItemComments", "handleAdminClosetItemLikes", "handleAdminClosetItemComments", "handleToggleWishlistItem", "on", "wishlistPk", "wishlistSk", "updated", "itemRaw", "wishlistItem", "handleMyWishlist", "entries", "keys", "e", "closetItems", "k", "handlePinnedClosetItems", "event", "source", "handleClosetFeed", "sort", "statuses", "collected", "chunk", "filtered", "statusOk", "audienceOk", "byId", "it", "unique", "a", "b", "aCreated", "bCreated", "af", "bf", "handleToggleFavoriteClosetItem", "favoriteOn", "pkRoot", "skFavorite", "favoriteItem", "handleRequestClosetBackgroundChange", "requestedBackgroundKey", "mode", "handleCreateStory", "storyId", "handlePublishStory", "scheduledAt", "handleAddClosetItemToCommunityFeed", "handleRemoveClosetItemFromCommunityFeed", "handleShareClosetItemToPinterest", "sharerSub", "shareItem", "fieldName"]
}
