"use strict";var S=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var V=Object.prototype.hasOwnProperty;var _=(e,t)=>{for(var n in t)S(e,n,{get:t[n],enumerable:!0})},P=(e,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of R(t))!V.call(e,s)&&s!==n&&S(e,s,{get:()=>t[s],enumerable:!(i=K(t,s))||i.enumerable});return e};var M=e=>P(S({},"__esModule",{value:!0}),e);var Y={};_(Y,{handler:()=>X});module.exports=M(Y);var r=require("@aws-sdk/client-dynamodb"),f=require("@aws-sdk/client-sfn"),o=require("@aws-sdk/util-dynamodb"),T=require("crypto"),d=process.env.TABLE_NAME,D=process.env.APPROVAL_SM_ARN,te=process.env.STATUS_GSI??"gsi1",m=new r.DynamoDBClient({}),U=new f.SFNClient({});function b(){return new Date().toISOString()}function p(e){return`USER#${e}`}function w(e){return`CLOSET#${e}`}function h(e){return`CLOSET#${e}`}function N(e){return`CLOSET#STATUS#${e}`}function I(e){let t=(0,o.unmarshall)(e);return{id:t.id,userId:t.userId,ownerSub:t.ownerSub,status:t.status,createdAt:t.createdAt,updatedAt:t.updatedAt,mediaKey:t.mediaKey,rawMediaKey:t.rawMediaKey,title:t.title,reason:t.reason,audience:t.audience,storyTitle:t.storyTitle,storySeason:t.storySeason,storyVibes:t.storyVibes,pinned:t.pinned,favoriteCount:t.favoriteCount,likeCount:t.likeCount,commentCount:t.commentCount,wishlistCount:t.wishlistCount,viewerHasFaved:t.viewerHasFaved,viewerHasLiked:t.viewerHasLiked,viewerHasWishlisted:t.viewerHasWishlisted}}function C(e){if(!e?.sub)throw new Error("Not authenticated");return e.sub}async function H(e){let t=C(e);return((await m.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":p(t),":sk":"CLOSET#"})}))).Items??[]).map(I)}async function W(e,t){let n=C(t),i=(0,T.randomUUID)(),s=b(),a={id:i,userId:n,ownerSub:n,status:"DRAFT",createdAt:s,updatedAt:s,mediaKey:e.mediaKey,rawMediaKey:e.rawMediaKey,title:e.title};return await m.send(new r.PutItemCommand({TableName:d,Item:(0,o.marshall)({pk:p(n),sk:w(i),gsi1pk:N(a.status),gsi1sk:s,rawMediaKey:a.rawMediaKey,...a})})),a}async function F(e,t){let n=C(t),i=b(),s=await m.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(n),sk:w(e.id)}),UpdateExpression:"SET mediaKey = :mediaKey, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,o.marshall)({":mediaKey":e.mediaKey,":updatedAt":i,":gsi1pk":N("DRAFT"),":gsi1sk":i}),ReturnValues:"ALL_NEW"}));if(!s.Attributes)throw new Error("Item not found");return I(s.Attributes)}async function O(e,t){let n=C(t),i=b(),s=await m.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(n),sk:w(e.id)}),ConditionExpression:"status = :draft",UpdateExpression:"SET status = :pending, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,o.marshall)({":draft":"DRAFT",":pending":"PENDING",":updatedAt":i,":gsi1pk":N("PENDING"),":gsi1sk":i}),ReturnValues:"ALL_NEW"}));if(!s.Attributes)throw new Error("Item not found or not in DRAFT status");let a=I(s.Attributes);return await U.send(new f.StartExecutionCommand({stateMachineArn:D,input:JSON.stringify({itemId:a.id,userId:a.userId,ownerSub:a.ownerSub})})),a.id}async function z(e,t){let n=C(t),{id:i,storyTitle:s,storySeason:a,storyVibes:c}=e.input,l=b(),u=["updatedAt = :updatedAt"],y={":updatedAt":l};s!==void 0&&(u.push("storyTitle = :storyTitle"),y[":storyTitle"]=s),a!==void 0&&(u.push("storySeason = :storySeason"),y[":storySeason"]=a),c!==void 0&&(u.push("storyVibes = :storyVibes"),y[":storyVibes"]=c?.filter(E=>!!E));let g=await m.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(n),sk:w(i)}),UpdateExpression:"SET "+u.join(", "),ExpressionAttributeValues:(0,o.marshall)(y),ReturnValues:"ALL_NEW"}));if(!g.Attributes)throw new Error("Item not found");return I(g.Attributes)}async function v(e,t){let n=C(t),{ownerId:i,closetItemId:s}=e.input,a=b(),c={pk:h(s),sk:`LIKE#${n}`,entityType:"LIKE",itemOwnerSub:i,likerSub:n,createdAt:a};try{await m.send(new r.PutItemCommand({TableName:d,Item:(0,o.marshall)(c),ConditionExpression:"attribute_not_exists(pk)"}))}catch(y){if(y?.name!=="ConditionalCheckFailedException")throw y}let l=await m.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(i),sk:w(s)}),UpdateExpression:"SET likeCount = if_not_exists(likeCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":a}),ReturnValues:"ALL_NEW"}));if(!l.Attributes)throw new Error("Closet item not found");let u=I(l.Attributes);return u.viewerHasLiked=!0,u}async function B(e,t){let n=C(t),{ownerId:i,closetItemId:s,text:a}=e.input,c=b(),l=(0,T.randomUUID)(),u={pk:h(s),sk:`COMMENT#${l}`,entityType:"COMMENT",closetItemId:s,itemOwnerSub:i,authorSub:n,text:a,createdAt:c};return await m.send(new r.PutItemCommand({TableName:d,Item:(0,o.marshall)(u)})),await m.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(i),sk:w(s)}),UpdateExpression:"SET commentCount = if_not_exists(commentCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":c})})),{id:l,closetItemId:s,authorSub:n,text:a,createdAt:c}}async function $(e,t){let n=C(t),{ownerId:i,closetItemId:s,pinned:a}=e.input;if(n!==i)throw new Error("Not authorized to pin this closet item.");let c=b(),l=await m.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(i),sk:w(s)}),UpdateExpression:"SET pinned = :pinned, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":pinned":!!a,":now":c}),ReturnValues:"ALL_NEW"}));if(!l.Attributes)throw new Error("Closet item not found");return I(l.Attributes)}async function L(e){let{closetItemId:t}=e;return((await m.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":h(t),":sk":"COMMENT#"})}))).Items??[]).map(s=>(0,o.unmarshall)(s)).map(s=>({id:s.sk.replace("COMMENT#",""),closetItemId:s.closetItemId,authorSub:s.authorSub,text:s.text,createdAt:s.createdAt}))}async function G(e){let{closetItemId:t}=e;return((await m.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":h(t),":sk":"LIKE#"})}))).Items??[]).map(s=>(0,o.unmarshall)(s)).map(s=>({closetItemId:t,likerSub:s.likerSub,createdAt:s.createdAt}))}async function q(e){return L(e)}async function J(e,t){let n=C(t),{ownerId:i,closetItemId:s,on:a}=e.input,c=b(),l=p(n),u=`WISHLIST#${s}`;if(a===!1){await m.send(new r.DeleteItemCommand({TableName:d,Key:(0,o.marshall)({pk:l,sk:u})}));let k;try{let A=await m.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(i),sk:w(s)}),UpdateExpression:"SET wishlistCount = if_not_exists(wishlistCount, :zero) - :one, updatedAt = :now",ConditionExpression:"wishlistCount >= :one",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":c}),ReturnValues:"ALL_NEW"}));A.Attributes&&(k=I(A.Attributes))}catch(A){if(A?.name!=="ConditionalCheckFailedException")throw A;let x=((await m.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND sk = :sk",ExpressionAttributeValues:(0,o.marshall)({":pk":p(i),":sk":w(s)})}))).Items??[])[0];x&&(k=I(x))}if(!k)throw new Error("Closet item not found");return k.viewerHasWishlisted=!1,k}let y={pk:l,sk:u,entityType:"WISHLIST",closetItemId:s,ownerSub:i,viewerSub:n,createdAt:c};try{await m.send(new r.PutItemCommand({TableName:d,Item:(0,o.marshall)(y),ConditionExpression:"attribute_not_exists(pk)"}))}catch(k){if(k?.name!=="ConditionalCheckFailedException")throw k}let g=await m.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(i),sk:w(s)}),UpdateExpression:"SET wishlistCount = if_not_exists(wishlistCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":c}),ReturnValues:"ALL_NEW"}));if(!g.Attributes)throw new Error("Closet item not found");let E=I(g.Attributes);return E.viewerHasWishlisted=!0,E}async function j(e){let t=C(e),i=((await m.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":p(t),":sk":"WISHLIST#"})}))).Items??[]).map(u=>(0,o.unmarshall)(u));if(!i.length)return[];let s=i.map(u=>({pk:p(u.ownerSub),sk:w(u.closetItemId)})),l=((await m.send(new r.BatchGetItemCommand({RequestItems:{[d]:{Keys:s.map(u=>(0,o.marshall)(u))}}}))).Responses?.[d]??[]).map(I);for(let u of l)u.viewerHasWishlisted=!0;return l}async function Q(e){let t=e.source||{},n=e.identity||{},i=t.userId||t.id||n.sub;if(!i)throw new Error("Cannot resolve pinnedClosetItems: missing userId");return((await m.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",FilterExpression:"#pinned = :true AND #status = :published",ExpressionAttributeNames:{"#pinned":"pinned","#status":"status"},ExpressionAttributeValues:(0,o.marshall)({":pk":p(i),":sk":"CLOSET#",":true":!0,":published":"PUBLISHED"})}))).Items??[]).map(I)}var X=async e=>{console.log("ClosetResolverFn event",JSON.stringify(e));let t=e.info?.fieldName;try{switch(t){case"myCloset":return await H(e.identity);case"myWishlist":return await j(e.identity);case"createClosetItem":return await W(e.arguments,e.identity);case"updateClosetMediaKey":return await F(e.arguments,e.identity);case"requestClosetApproval":return await O(e.arguments,e.identity);case"updateClosetItemStory":return await z(e.arguments,e.identity);case"likeClosetItem":return await v(e.arguments,e.identity);case"commentOnClosetItem":return await B(e.arguments,e.identity);case"pinHighlight":return await $(e.arguments,e.identity);case"closetItemComments":return await L(e.arguments);case"adminClosetItemLikes":return await G(e.arguments);case"adminClosetItemComments":return await q(e.arguments);case"toggleWishlistItem":return await J(e.arguments,e.identity);case"pinnedClosetItems":return await Q(e);default:throw new Error(`Unsupported field: ${t}`)}}catch(n){throw console.error("Error in ClosetResolverFn",n),n}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
