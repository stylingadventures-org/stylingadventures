"use strict";var f=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var k=(e,t)=>{for(var r in t)f(e,r,{get:t[r],enumerable:!0})},M=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of x(t))!I.call(e,o)&&o!==r&&f(e,o,{get:()=>t[o],enumerable:!(n=b(t,o))||n.enumerable});return e};var B=e=>M(f({},"__esModule",{value:!0}),e);var z={};k(z,{handler:()=>_});module.exports=B(z);var i=require("@aws-sdk/client-s3"),p=require("@aws-sdk/s3-request-presigner"),d=new i.S3Client({region:process.env.AWS_REGION||"us-east-1",forcePathStyle:!0}),l=process.env.BUCKET,G=["authorization","Authorization","Content-Type","X-Amz-Date","X-Api-Key","X-Amz-Security-Token"].join(",");function L(e){return String(e?.headers?.origin||e?.headers?.Origin||"").replace(/\/+$/,"")}function P(e){return{"Content-Type":"application/json","Access-Control-Allow-Origin":L(e)||"*","Access-Control-Allow-Headers":G,"Access-Control-Allow-Methods":"GET,POST,DELETE,OPTIONS","Access-Control-Allow-Credentials":"true","Access-Control-Expose-Headers":"ETag,Content-Type,Content-Length,Last-Modified,Accept-Ranges",Vary:"Origin, Access-Control-Request-Headers, Access-Control-Request-Method"}}function A(e,t,r={}){return{statusCode:200,headers:{...P(e),"Cache-Control":"no-store",...r},body:JSON.stringify(t)}}function R(e){return{statusCode:204,headers:P(e),body:""}}function y(e,t,r){return console.error("[presign] error",t,r),{statusCode:t,headers:P(e),body:JSON.stringify({message:r})}}var U=e=>e.httpMethod??e.requestContext?.http?.method??"GET",K=e=>e.requestContext?.authorizer?.claims??e.requestContext?.authorizer?.jwt?.claims??{},N=e=>{let t=e.body??"";if(!t)return{};let r=e.isBase64Encoded&&typeof t=="string"?Buffer.from(t,"base64").toString():t;try{return typeof r=="string"?JSON.parse(r):r}catch{return{}}};function h(e,t){let r=String(t||"").replace(/\.\./g,"").replace(/^[/\\]+/,""),n=r.startsWith(`users/${e}/`),o=/^users\/[^/]+\//.test(r)&&!n;return n?r:`users/${e}/${o?r.replace(/^users\/[^/]+\//,""):r}`}function q(e){let t=e?.["cognito:groups"];return Array.isArray(t)?t:typeof t=="string"?t.split(",").map(r=>r.trim()).filter(Boolean):[]}var _=async e=>{let t=U(e);if(t==="OPTIONS")return R(e);try{let r=K(e),n=r?.sub||"";if(!n)return y(e,401,"Not authorized");let o=q(r),C=Number(process.env.BASE_UPLOAD_LIMIT_MB||"50"),E=Number(process.env.BESTIE_UPLOAD_LIMIT_MB||"200"),m=o.includes("BESTIE")?E:C;if(t==="POST"){let s=N(e);console.log("[presign] POST body",s);let a=String(s.key||""),u=String(s.contentType||"application/octet-stream");if(!a)return y(e,400,"Missing 'key'");let g=Number(s.contentLength||0);if(g>0&&g>m*1024*1024)return y(e,413,`Max upload ${m} MB for your tier`);let c=h(n,a),S=new i.PutObjectCommand({Bucket:l,Key:c,ContentType:u}),T=new i.GetObjectCommand({Bucket:l,Key:c}),w=await(0,p.getSignedUrl)(d,S,{expiresIn:900}),O=await(0,p.getSignedUrl)(d,T,{expiresIn:300});return A(e,{bucket:l,key:c,method:"PUT",url:w,headers:{"Content-Type":u},putUrl:w,getUrl:O,maxBytesAllowed:m*1024*1024})}if(t==="GET"){let s=String(e?.queryStringParameters?.key??e.pathParameters?.key??"");if(!s)return y(e,400,"Missing 'key'");let a=String(s||"").replace(/\.\./g,"").replace(/^[/\\]+/,""),u=a;/^users\/[^/]+\//.test(a)||(u=h(n,a));let g=new i.GetObjectCommand({Bucket:l,Key:u}),c=await(0,p.getSignedUrl)(d,g,{expiresIn:300});return A(e,{bucket:l,key:u,getUrl:c,url:c,publicUrl:c})}if(t==="DELETE"){let s=String(e?.queryStringParameters?.key??e.pathParameters?.key??"");if(!s)return y(e,400,"Missing 'key'");let a=h(n,s);return await d.send(new i.DeleteObjectCommand({Bucket:l,Key:a})),A(e,{deleted:!0,key:a})}return y(e,405,"Method Not Allowed")}catch(r){return console.error("[presign] unhandled error",r),y(e,500,r?.message??String(r))}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
