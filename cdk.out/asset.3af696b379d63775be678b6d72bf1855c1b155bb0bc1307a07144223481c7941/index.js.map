{
  "version": 3,
  "sources": ["../../lambda/closet/admin.ts"],
  "sourcesContent": ["// lambda/closet/admin.ts\r\n\r\nimport {\r\n  DynamoDBClient,\r\n  QueryCommand,\r\n  GetItemCommand,\r\n  UpdateItemCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport { unmarshall } from \"@aws-sdk/util-dynamodb\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\nconst TABLE_NAME = process.env.APP_TABLE!;\r\n\r\ntype ClosetStatus = \"DRAFT\" | \"PENDING\" | \"APPROVED\" | \"REJECTED\" | \"PUBLISHED\";\r\ntype ClosetAudience = \"PUBLIC\" | \"BESTIE\" | \"EXCLUSIVE\";\r\n\r\ntype ClosetItem = {\r\n  id: string;\r\n  userId: string;\r\n  ownerSub: string;\r\n  status: ClosetStatus;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n  mediaKey?: string | null;\r\n  title?: string | null;\r\n  reason?: string | null;\r\n  audience?: ClosetAudience | null;\r\n};\r\n\r\n/**\r\n * Helper: unmarshall & sanity-check required fields so we never return null\r\n * for a non-nullable GraphQL type.\r\n */\r\nfunction asClosetItem(attrs: Record<string, any> | undefined): ClosetItem {\r\n  if (!attrs) {\r\n    throw new Error(\"Closet item not found\");\r\n  }\r\n  const item = unmarshall(attrs) as ClosetItem;\r\n\r\n  if (\r\n    !item.id ||\r\n    !item.userId ||\r\n    !item.ownerSub ||\r\n    !item.status ||\r\n    !item.createdAt ||\r\n    !item.updatedAt\r\n  ) {\r\n    throw new Error(\"Closet item missing required fields\");\r\n  }\r\n\r\n  return item;\r\n}\r\n\r\n/**\r\n * List items that are pending moderation.\r\n * We query all CLOSET items and filter by status = PENDING.\r\n */\r\nasync function adminListPending(): Promise<ClosetItem[]> {\r\n  const resp = await ddb.send(\r\n    new QueryCommand({\r\n      TableName: TABLE_NAME,\r\n      KeyConditionExpression: \"pk = :pk\",\r\n      ExpressionAttributeValues: {\r\n        \":pk\": { S: \"CLOSET\" },\r\n        \":pending\": { S: \"PENDING\" },\r\n      },\r\n      FilterExpression: \"#st = :pending\",\r\n      ExpressionAttributeNames: {\r\n        \"#st\": \"status\",\r\n      },\r\n    }),\r\n  );\r\n\r\n  const items = (resp.Items || []).map((it) => asClosetItem(it));\r\n  return items;\r\n}\r\n\r\n/**\r\n * Approve an item: status -> APPROVED\r\n */\r\nasync function adminApproveItem(id: string): Promise<ClosetItem> {\r\n  const now = new Date().toISOString();\r\n\r\n  const resp = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: {\r\n        pk: { S: \"CLOSET\" },\r\n        sk: { S: id },\r\n      },\r\n      UpdateExpression: \"SET #st = :approved, updatedAt = :now REMOVE reason\",\r\n      ExpressionAttributeNames: {\r\n        \"#st\": \"status\",\r\n      },\r\n      ExpressionAttributeValues: {\r\n        \":approved\": { S: \"APPROVED\" },\r\n        \":now\": { S: now },\r\n      },\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  return asClosetItem(resp.Attributes);\r\n}\r\n\r\n/**\r\n * Reject an item: status -> REJECTED, reason set\r\n */\r\nasync function adminRejectItem(id: string, reason: string | null): Promise<ClosetItem> {\r\n  const now = new Date().toISOString();\r\n\r\n  const exprParts = [\"#st = :rejected\", \"updatedAt = :now\"];\r\n  const names: Record<string, string> = { \"#st\": \"status\" };\r\n  const values: Record<string, any> = {\r\n    \":rejected\": { S: \"REJECTED\" },\r\n    \":now\": { S: now },\r\n  };\r\n\r\n  if (reason && reason.trim()) {\r\n    exprParts.push(\"reason = :reason\");\r\n    values[\":reason\"] = { S: reason.trim() };\r\n  } else {\r\n    // if no reason provided, clear any existing reason\r\n    exprParts.push(\"reason = :emptyReason\");\r\n    values[\":emptyReason\"] = { S: \"\" };\r\n  }\r\n\r\n  const resp = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: {\r\n        pk: { S: \"CLOSET\" },\r\n        sk: { S: id },\r\n      },\r\n      UpdateExpression: \"SET \" + exprParts.join(\", \"),\r\n      ExpressionAttributeNames: names,\r\n      ExpressionAttributeValues: values,\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  return asClosetItem(resp.Attributes);\r\n}\r\n\r\n/**\r\n * Set audience: PUBLIC / BESTIE / EXCLUSIVE\r\n */\r\nasync function adminSetClosetAudience(\r\n  id: string,\r\n  audience: ClosetAudience,\r\n): Promise<ClosetItem> {\r\n  const now = new Date().toISOString();\r\n\r\n  const resp = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: {\r\n        pk: { S: \"CLOSET\" },\r\n        sk: { S: id },\r\n      },\r\n      UpdateExpression: \"SET audience = :aud, updatedAt = :now\",\r\n      ExpressionAttributeValues: {\r\n        \":aud\": { S: audience },\r\n        \":now\": { S: now },\r\n      },\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  return asClosetItem(resp.Attributes);\r\n}\r\n\r\n/**\r\n * Main AppSync handler\r\n */\r\nexport const handler = async (event: any) => {\r\n  const typeName = event.info?.parentTypeName;\r\n  const fieldName = event.info?.fieldName;\r\n\r\n  // Queries\r\n  if (typeName === \"Query\" && fieldName === \"adminListPending\") {\r\n    return await adminListPending();\r\n  }\r\n\r\n  // Mutations\r\n  if (typeName === \"Mutation\" && fieldName === \"adminApproveItem\") {\r\n    const { id } = event.arguments || {};\r\n    if (!id) throw new Error(\"id is required\");\r\n    return await adminApproveItem(id);\r\n  }\r\n\r\n  if (typeName === \"Mutation\" && fieldName === \"adminRejectItem\") {\r\n    const { id, reason } = event.arguments || {};\r\n    if (!id) throw new Error(\"id is required\");\r\n    return await adminRejectItem(id, reason ?? null);\r\n  }\r\n\r\n  if (typeName === \"Mutation\" && fieldName === \"adminSetClosetAudience\") {\r\n    const { id, audience } = event.arguments || {};\r\n    if (!id || !audience) throw new Error(\"id and audience are required\");\r\n    return await adminSetClosetAudience(id, audience);\r\n  }\r\n\r\n  // Fallback\r\n  throw new Error(`Unknown field ${typeName}.${fieldName}`);\r\n};\r\n"],
  "mappings": "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",
  "names": ["admin_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_util_dynamodb", "ddb", "TABLE_NAME", "asClosetItem", "attrs", "item", "adminListPending", "it", "adminApproveItem", "id", "now", "resp", "adminRejectItem", "reason", "exprParts", "names", "values", "adminSetClosetAudience", "audience", "event", "typeName", "fieldName"]
}
