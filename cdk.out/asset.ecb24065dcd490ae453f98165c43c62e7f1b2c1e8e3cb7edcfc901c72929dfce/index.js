"use strict";var I=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var b=Object.prototype.hasOwnProperty;var x=(e,t)=>{for(var n in t)I(e,n,{get:t[n],enumerable:!0})},C=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of D(t))!b.call(e,r)&&r!==n&&I(e,r,{get:()=>t[r],enumerable:!(s=$(t,r))||s.enumerable});return e};var T=e=>C(I({},"__esModule",{value:!0}),e);var H={};x(H,{handler:()=>v});module.exports=T(H);var h=require("@aws-sdk/client-appsync"),w=e=>new Promise(t=>setTimeout(t,e));function E(){return new Date().toISOString()}function c(...e){console.log(`[schema-ready] ${E()}`,...e)}function P(...e){console.warn(`[schema-ready] ${E()}`,...e)}function N(...e){console.error(`[schema-ready] ${E()}`,...e)}function R(e,t){if(typeof e=="string"&&e.trim().length>0)return e.trim();throw new Error(`Missing required "${t}" (got ${JSON.stringify(e)})`)}function y(e,t){let n=Number(e);return Number.isFinite(n)&&n>0?n:t}function L(e){let t=e.match(/type\s+Mutation\s*\{[\s\S]*?\}/m);return t?t[0]:null}function F(e,t){return new RegExp(`\\b${M(t)}\\b`).test(e)}function _(e,t){let n=L(e);return n?new RegExp(`\\b${M(t)}\\b`).test(n):!1}function M(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async function k(e,t){let n=await e.send(new h.GetSchemaCreationStatusCommand({apiId:t}));return{status:n.status??"UNKNOWN",details:n.details??""}}async function O(e,t){let s=(await e.send(new h.GetIntrospectionSchemaCommand({apiId:t,format:"SDL"}))).schema;return s?(typeof s=="string"?Buffer.from(s,"base64"):Buffer.from(s)).toString("utf8"):""}async function q(e,t,n,s){for(let r=1;r<=n;r++){let{status:u,details:l}=await k(e,t);if(c(`schema status attempt ${r}/${n}: ${u} (${l})`),u==="SUCCESS")return{status:u,details:l};if(u==="FAILED")throw new Error(`Schema status FAILED: ${l||"no details"}`);await w(s)}throw new Error("Timed out waiting for schema to reach SUCCESS")}async function U(e,t,n,s,r){let u=0,l=!1;for(let p=1;p<=s;p++){let i="";try{i=await O(e,t)}catch(o){P(`introspection attempt ${p}/${s} error:`,o?.message??o),await w(r);continue}u=i.length;let g=F(i,n),d=_(i,n);if(l=d,c(`introspection attempt ${p}/${s}: sdlLen=${i.length} fieldAnywhere=${g} fieldInMutation=${d}`),p===1){c("SDL prefix (first 2000 chars):",JSON.stringify(i.slice(0,2e3)));let o=i.match(/extend type Query \{[\s\S]*?\}/);o?c("Query block found:",JSON.stringify(o[0])):c("No 'extend type Query' block found");let f=i.match(/^type \w+/gm),a=i.match(/^extend type \w+/gm);c(`Type count: ${f?f.length:0}, Extend count: ${a?a.length:0}`)}if(g){let o=i.search(new RegExp(`\\b${M(n)}\\b`));if(o>=0){let f=Math.max(0,o-80),a=Math.min(i.length,o+120);c("field context snippet:",JSON.stringify(i.slice(f,a)))}return{ok:!0,fieldAnywhere:!0,fieldInMutation:d,sdlLen:i.length}}let S=Math.floor(Math.random()*Math.min(500,r));await w(r+S)}return{ok:!1,fieldAnywhere:!1,fieldInMutation:l,sdlLen:u}}async function v(e){let t=e?.ResourceProperties??{},n=process.env.APPSYNC_API_ID??process.env.API_ID??t.apiId??t.ApiId,s=process.env.EXPECTED_FIELD??t.expectedField??t.ExpectedField,r=process.env.AWS_REGION??process.env.REGION??t.region??t.Region,u=y(process.env.SCHEMA_STATUS_MAX_ATTEMPTS??t.schemaStatusMaxAttempts,30),l=y(process.env.SCHEMA_STATUS_DELAY_MS??t.schemaStatusDelayMs,2e3),p=y(process.env.INTROSPECTION_MAX_ATTEMPTS??t.introspectionMaxAttempts,40),i=y(process.env.INTROSPECTION_DELAY_MS??t.introspectionDelayMs,2500),g=e.PhysicalResourceId??`AppSyncSchemaReady:${String(n??"unknown")}`;if(e.RequestType==="Delete")return c("Delete request -> skipping checks"),{PhysicalResourceId:g,Data:{skipped:!0}};let d=R(n,"apiId"),S=R(r,"region"),o=String(s??"").trim();c("starting",{requestType:e.RequestType,apiId:d,expectedField:o||"(none)",region:S,maxSchemaAttempts:u,schemaDelayMs:l,maxIntrospectionAttempts:p,introspectionDelayMs:i});let f=new h.AppSyncClient({region:S}),a=await q(f,d,u,l);if(o){let m=await U(f,d,o,p,i);if(!m.ok){let A=`Schema SUCCESS but expectedField "${o}" not found via introspection after retries. details=${a.details||"no details"} (sdlLen=${m.sdlLen}, fieldInMutation=${m.fieldInMutation})`;throw N(A),new Error(A)}return c("READY",{status:a.status,details:a.details,expectedField:o,fieldInMutation:m.fieldInMutation,sdlLen:m.sdlLen}),{PhysicalResourceId:g,Data:{ok:!0,apiId:d,expectedField:o,schemaStatus:a.status,schemaDetails:a.details,fieldInMutation:m.fieldInMutation,sdlLen:m.sdlLen}}}return c("READY (no expectedField check)",{status:a.status,details:a.details}),{PhysicalResourceId:g,Data:{ok:!0,apiId:d,schemaStatus:a.status,schemaDetails:a.details,expectedField:""}}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
