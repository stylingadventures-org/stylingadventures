"use strict";var m=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var M=(e,t)=>{for(var r in t)m(e,r,{get:t[r],enumerable:!0})},B=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of k(t))!R.call(e,s)&&s!==r&&m(e,s,{get:()=>t[s],enumerable:!(n=G(t,s))||n.enumerable});return e};var L=e=>B(m({},"__esModule",{value:!0}),e);var z={};M(z,{handler:()=>D});module.exports=L(z);var a=require("@aws-sdk/client-s3"),p=require("@aws-sdk/s3-request-presigner"),f=new a.S3Client({region:process.env.AWS_REGION||process.env.AWS_DEFAULT_REGION||"us-east-1",forcePathStyle:!0}),y=process.env.BUCKET;if(!y)throw new Error("Missing BUCKET env var");var O=String(process.env.ALLOWED_ORIGINS||"").split(",").map(e=>e.trim()).filter(Boolean),V=["authorization","Authorization","Content-Type","X-Amz-Date","X-Api-Key","X-Amz-Security-Token"].join(",");function N(e){return e.requestContext?.http?.method||e.httpMethod||"GET"}function w(e){return e.headers?.origin||e.headers?.Origin||""}function E(e){let t=w(e)||"";if(t)return O.length===0||O.includes(t)?t:void 0}function g(e){let t={"Content-Type":"application/json","Access-Control-Allow-Headers":V,"Access-Control-Allow-Methods":"GET,POST,DELETE,OPTIONS","Access-Control-Allow-Credentials":"true","Access-Control-Expose-Headers":"ETag,Content-Type,Content-Length,Last-Modified,Accept-Ranges",Vary:"Origin, Access-Control-Request-Headers, Access-Control-Request-Method"};return e&&(t["Access-Control-Allow-Origin"]=e),t}function P(e,t,r={}){let n=E(e);return{statusCode:200,headers:{...g(n),"Cache-Control":"no-store",...r},body:JSON.stringify(t)}}function U(e){let t=E(e);return!!w(e)&&!t?{statusCode:403,headers:g(void 0),body:""}:{statusCode:204,headers:g(t),body:""}}function u(e,t,r){let n=E(e);return!!w(e)&&!n?{statusCode:403,headers:g(void 0),body:JSON.stringify({message:"CORS: origin not allowed"})}:{statusCode:t,headers:g(n),body:JSON.stringify({message:r})}}var q=e=>e.requestContext.authorizer?.claims??e.requestContext.authorizer?.jwt?.claims??{},K=e=>{let t=e.body??"";if(!t)return{};let r=e.isBase64Encoded&&typeof t=="string"?Buffer.from(t,"base64").toString():t;try{return typeof r=="string"?JSON.parse(r):r}catch{return{}}};function h(e,t){let r=String(t||"").replace(/\.\./g,"").replace(/^[/\\]+/,""),n=r.startsWith(`users/${e}/`),s=/^users\/[^/]+\//.test(r)&&!n;return n?r:`users/${e}/${s?r.replace(/^users\/[^/]+\//,""):r}`}function _(e){let t=e?.["cognito:groups"];return Array.isArray(t)?t:typeof t=="string"?t.split(",").map(r=>r.trim()).filter(Boolean):[]}var D=async e=>{let t=N(e);if(t==="OPTIONS")return U(e);try{let r=q(e),n=r?.sub||"";if(!n)return u(e,401,"Not authorized");let s=_(r),S=Number(process.env.BASE_UPLOAD_LIMIT_MB||"50"),I=Number(process.env.BESTIE_UPLOAD_LIMIT_MB||"200"),A=s.includes("BESTIE")?I:S;if(t==="POST"){let o=K(e),i=String(o.key||""),d=String(o.contentType||"application/octet-stream");if(!i)return u(e,400,"Missing 'key'");let l=Number(o.contentLength||0);if(l>0&&l>A*1024*1024)return u(e,413,`Max upload ${A} MB for your tier`);let c=h(n,i),x=new a.PutObjectCommand({Bucket:y,Key:c,ContentType:d}),T=new a.GetObjectCommand({Bucket:y,Key:c}),C=await(0,p.getSignedUrl)(f,x,{expiresIn:900}),b=await(0,p.getSignedUrl)(f,T,{expiresIn:300});return P(e,{bucket:y,key:c,method:"PUT",url:C,headers:{"Content-Type":d},putUrl:C,getUrl:b,maxBytesAllowed:A*1024*1024})}if(t==="GET"){let o=String(e.queryStringParameters?.key??e.pathParameters?.key??"");if(!o)return u(e,400,"Missing 'key'");let i=String(o||"").replace(/\.\./g,"").replace(/^[/\\]+/,""),d=i;/^users\/[^/]+\//.test(i)||(d=h(n,i));let l=new a.GetObjectCommand({Bucket:y,Key:d}),c=await(0,p.getSignedUrl)(f,l,{expiresIn:300});return P(e,{bucket:y,key:d,getUrl:c,url:c,publicUrl:c})}if(t==="DELETE"){let o=String(e.queryStringParameters?.key??e.pathParameters?.key??"");if(!o)return u(e,400,"Missing 'key'");let i=h(n,o);return await f.send(new a.DeleteObjectCommand({Bucket:y,Key:i})),P(e,{deleted:!0,key:i})}return u(e,405,"Method Not Allowed")}catch(r){return console.error(r),u(e,500,r?.message??String(r))}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
