{
  "version": 3,
  "sources": ["../../lambda/presign/index.ts"],
  "sourcesContent": ["// lambda/presign/index.ts\r\nimport {\r\n  APIGatewayProxyEventV2,\r\n  APIGatewayProxyResultV2,\r\n} from \"aws-lambda\";\r\nimport {\r\n  S3Client,\r\n  PutObjectCommand,\r\n  DeleteObjectCommand,\r\n  GetObjectCommand,\r\n} from \"@aws-sdk/client-s3\";\r\nimport { getSignedUrl } from \"@aws-sdk/s3-request-presigner\";\r\n\r\n/* ---------------- S3 client ---------------- */\r\n\r\nconst s3 = new S3Client({\r\n  region:\r\n    process.env.AWS_REGION || process.env.AWS_DEFAULT_REGION || \"us-east-1\",\r\n  // path-style is safer with some buckets / local emulators\r\n  forcePathStyle: true,\r\n});\r\n\r\nconst BUCKET = process.env.BUCKET as string | undefined;\r\nif (!BUCKET) throw new Error(\"Missing BUCKET env var\");\r\n\r\n/* ---------------- CORS helpers ---------------- */\r\n\r\n/** Comma-separated allow-list, e.g.\r\n *  \"http://localhost:5173,https://d1682i07dc1r3k.cloudfront.net\"\r\n */\r\nconst ALLOWED_ORIGINS: string[] = String(process.env.ALLOWED_ORIGINS || \"\")\r\n  .split(\",\")\r\n  .map((s) => s.trim())\r\n  .filter(Boolean);\r\n\r\nconst ALLOW_HEADERS = [\r\n  \"authorization\",\r\n  \"Authorization\",\r\n  \"Content-Type\",\r\n  \"X-Amz-Date\",\r\n  \"X-Api-Key\",\r\n  \"X-Amz-Security-Token\",\r\n].join(\",\");\r\n\r\nfunction getMethod(e: APIGatewayProxyEventV2): string {\r\n  // Works for HTTP API v2 and REST v1\r\n  return e.requestContext?.http?.method || (e as any).httpMethod || \"GET\";\r\n}\r\n\r\nfunction requestOrigin(event: APIGatewayProxyEventV2): string {\r\n  return (\r\n    (event.headers?.origin as string | undefined) ||\r\n    (event.headers?.Origin as string | undefined) ||\r\n    \"\"\r\n  );\r\n}\r\n\r\n/**\r\n * Pick the allowed origin for this request:\r\n *  - If ALLOWED_ORIGINS is non-empty, Origin must be in that list.\r\n *  - If ALLOWED_ORIGINS is empty, echo the Origin (or nothing if missing).\r\n *\r\n * We NEVER return a different origin than the one the browser sent.\r\n */\r\nfunction pickAllowedOrigin(\r\n  event: APIGatewayProxyEventV2,\r\n): string | undefined {\r\n  const origin = requestOrigin(event) || \"\";\r\n  if (!origin) {\r\n    // non-browser callers, nothing to echo\r\n    return undefined;\r\n  }\r\n\r\n  if (ALLOWED_ORIGINS.length === 0) {\r\n    // no explicit list -> echo whatever browser sent\r\n    return origin;\r\n  }\r\n\r\n  // explicit allow-list -> must match\r\n  return ALLOWED_ORIGINS.includes(origin) ? origin : undefined;\r\n}\r\n\r\nfunction baseCorsHeaders(origin?: string): Record<string, string> {\r\n  const h: Record<string, string> = {\r\n    \"Content-Type\": \"application/json\",\r\n    \"Access-Control-Allow-Headers\": ALLOW_HEADERS,\r\n    \"Access-Control-Allow-Methods\": \"GET,POST,DELETE,OPTIONS\",\r\n    \"Access-Control-Allow-Credentials\": \"true\",\r\n    \"Access-Control-Expose-Headers\":\r\n      \"ETag,Content-Type,Content-Length,Last-Modified,Accept-Ranges\",\r\n    Vary:\r\n      \"Origin, Access-Control-Request-Headers, Access-Control-Request-Method\",\r\n  };\r\n  if (origin) h[\"Access-Control-Allow-Origin\"] = origin;\r\n  return h;\r\n}\r\n\r\nfunction ok(\r\n  event: APIGatewayProxyEventV2,\r\n  body: unknown,\r\n  extra: Record<string, string> = {},\r\n): APIGatewayProxyResultV2 {\r\n  const origin = pickAllowedOrigin(event);\r\n  return {\r\n    statusCode: 200,\r\n    headers: {\r\n      ...baseCorsHeaders(origin),\r\n      \"Cache-Control\": \"no-store\",\r\n      ...extra,\r\n    },\r\n    body: JSON.stringify(body),\r\n  };\r\n}\r\n\r\nfunction noContent(event: APIGatewayProxyEventV2): APIGatewayProxyResultV2 {\r\n  const origin = pickAllowedOrigin(event);\r\n  const hadReqOrigin = !!requestOrigin(event);\r\n\r\n  // Browser sent an Origin but it's not allowed -> hard fail CORS\r\n  if (hadReqOrigin && !origin) {\r\n    return {\r\n      statusCode: 403,\r\n      headers: baseCorsHeaders(undefined),\r\n      body: \"\",\r\n    };\r\n  }\r\n\r\n  return { statusCode: 204, headers: baseCorsHeaders(origin), body: \"\" };\r\n}\r\n\r\nfunction bad(\r\n  event: APIGatewayProxyEventV2,\r\n  status: number,\r\n  msg: string,\r\n): APIGatewayProxyResultV2 {\r\n  const origin = pickAllowedOrigin(event);\r\n  const hadReqOrigin = !!requestOrigin(event);\r\n\r\n  if (hadReqOrigin && !origin) {\r\n    return {\r\n      statusCode: 403,\r\n      headers: baseCorsHeaders(undefined),\r\n      body: JSON.stringify({ message: \"CORS: origin not allowed\" }),\r\n    };\r\n  }\r\n\r\n  return {\r\n    statusCode: status,\r\n    headers: baseCorsHeaders(origin),\r\n    body: JSON.stringify({ message: msg }),\r\n  };\r\n}\r\n\r\n/* ---------------- auth / helpers ---------------- */\r\n\r\nconst claimsOf = (e: APIGatewayProxyEventV2) =>\r\n  (e.requestContext as any).authorizer?.claims ??\r\n  (e.requestContext as any).authorizer?.jwt?.claims ??\r\n  {};\r\n\r\nconst parseJson = (e: APIGatewayProxyEventV2) => {\r\n  const raw = (e as any).body ?? \"\";\r\n  if (!raw) return {};\r\n  const txt =\r\n    (e as any).isBase64Encoded && typeof raw === \"string\"\r\n      ? Buffer.from(raw, \"base64\").toString()\r\n      : raw;\r\n  try {\r\n    return typeof txt === \"string\" ? JSON.parse(txt) : txt;\r\n  } catch {\r\n    return {};\r\n  }\r\n};\r\n\r\n/** sanitize + enforce users/<sub>/ prefix FOR WRITES (POST/DELETE) */\r\nfunction scopeUserKey(sub: string, raw: string): string {\r\n  const safe = String(raw || \"\").replace(/\\.\\./g, \"\").replace(/^[/\\\\]+/, \"\");\r\n  const alreadyScoped = safe.startsWith(`users/${sub}/`);\r\n  const foreignUser = /^users\\/[^/]+\\//.test(safe) && !alreadyScoped;\r\n  return alreadyScoped\r\n    ? safe\r\n    : `users/${sub}/${foreignUser ? safe.replace(/^users\\/[^/]+\\//, \"\") : safe}`;\r\n}\r\n\r\nfunction readGroups(claims: any): string[] {\r\n  const g = claims?.[\"cognito:groups\"];\r\n  if (Array.isArray(g)) return g;\r\n  if (typeof g === \"string\") {\r\n    return g\r\n      .split(\",\")\r\n      .map((s) => s.trim())\r\n      .filter(Boolean);\r\n  }\r\n  return [];\r\n}\r\n\r\n/* ---------------- handler ---------------- */\r\n\r\nexport const handler = async (\r\n  event: APIGatewayProxyEventV2,\r\n): Promise<APIGatewayProxyResultV2> => {\r\n  const method = getMethod(event);\r\n\r\n  // CORS preflight\r\n  if (method === \"OPTIONS\") {\r\n    return noContent(event);\r\n  }\r\n\r\n  try {\r\n    const claims = claimsOf(event);\r\n    const sub = (claims?.sub as string) || \"\";\r\n    if (!sub) return bad(event, 401, \"Not authorized\");\r\n\r\n    // ---- tiered upload limits (in MB) ----\r\n    const groups = readGroups(claims);\r\n    const baseMb = Number(process.env.BASE_UPLOAD_LIMIT_MB || \"50\");\r\n    const bestieMb = Number(process.env.BESTIE_UPLOAD_LIMIT_MB || \"200\");\r\n    const maxMb = groups.includes(\"BESTIE\") ? bestieMb : baseMb;\r\n\r\n    // ---------------- POST: create PUT + GET presigns ----------------\r\n    if (method === \"POST\") {\r\n      const body: any = parseJson(event);\r\n      const rawKey: string = String(body.key || \"\");\r\n      const contentType: string = String(\r\n        body.contentType || \"application/octet-stream\",\r\n      );\r\n      if (!rawKey) return bad(event, 400, \"Missing 'key'\");\r\n\r\n      const contentLength = Number(body.contentLength || 0);\r\n      if (contentLength > 0 && contentLength > maxMb * 1024 * 1024) {\r\n        return bad(event, 413, `Max upload ${maxMb} MB for your tier`);\r\n      }\r\n\r\n      const key = scopeUserKey(sub, rawKey);\r\n      const putCmd = new PutObjectCommand({\r\n        Bucket: BUCKET,\r\n        Key: key,\r\n        ContentType: contentType,\r\n      });\r\n      const getCmd = new GetObjectCommand({ Bucket: BUCKET, Key: key });\r\n\r\n      const putUrl = await getSignedUrl(s3, putCmd, { expiresIn: 900 }); // 15m\r\n      const getUrl = await getSignedUrl(s3, getCmd, { expiresIn: 300 }); // 5m\r\n\r\n      return ok(event, {\r\n        bucket: BUCKET,\r\n        key,\r\n        method: \"PUT\",\r\n        url: putUrl,\r\n        headers: { \"Content-Type\": contentType },\r\n        putUrl,\r\n        getUrl,\r\n        maxBytesAllowed: maxMb * 1024 * 1024,\r\n      });\r\n    }\r\n\r\n    // ---------------- GET: presign read URL ----------------\r\n    if (method === \"GET\") {\r\n      const rawKey = String(\r\n        event.queryStringParameters?.key ??\r\n          (event as any).pathParameters?.key ??\r\n          \"\",\r\n      );\r\n      if (!rawKey) return bad(event, 400, \"Missing 'key'\");\r\n\r\n      // sanitise but allow users/<anySub>/... for READS\r\n      const safe = String(rawKey || \"\").replace(/\\.\\./g, \"\").replace(/^[/\\\\]+/, \"\");\r\n      let key = safe;\r\n\r\n      if (!/^users\\/[^/]+\\//.test(safe)) {\r\n        key = scopeUserKey(sub, safe);\r\n      }\r\n\r\n      const getCmd = new GetObjectCommand({ Bucket: BUCKET, Key: key });\r\n      const getUrl = await getSignedUrl(s3, getCmd, { expiresIn: 300 }); // 5m\r\n\r\n      return ok(event, {\r\n        bucket: BUCKET,\r\n        key,\r\n        getUrl,\r\n        url: getUrl,\r\n        publicUrl: getUrl,\r\n      });\r\n    }\r\n\r\n    // ---------------- DELETE: delete object ----------------\r\n    if (method === \"DELETE\") {\r\n      const rawKey = String(\r\n        event.queryStringParameters?.key ??\r\n          (event as any).pathParameters?.key ??\r\n          \"\",\r\n      );\r\n      if (!rawKey) return bad(event, 400, \"Missing 'key'\");\r\n\r\n      const key = scopeUserKey(sub, rawKey);\r\n\r\n      await s3.send(new DeleteObjectCommand({ Bucket: BUCKET, Key: key }));\r\n      return ok(event, { deleted: true, key });\r\n    }\r\n\r\n    return bad(event, 405, \"Method Not Allowed\");\r\n  } catch (e: any) {\r\n    console.error(e);\r\n    return bad(event, 500, e?.message ?? String(e));\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["index_exports", "__export", "handler", "__toCommonJS", "import_client_s3", "import_s3_request_presigner", "s3", "BUCKET", "ALLOWED_ORIGINS", "s", "ALLOW_HEADERS", "getMethod", "requestOrigin", "event", "pickAllowedOrigin", "origin", "baseCorsHeaders", "h", "ok", "body", "extra", "noContent", "bad", "status", "msg", "claimsOf", "parseJson", "raw", "txt", "scopeUserKey", "sub", "safe", "alreadyScoped", "foreignUser", "readGroups", "claims", "g", "method", "groups", "baseMb", "bestieMb", "maxMb", "rawKey", "contentType", "contentLength", "key", "putCmd", "getCmd", "putUrl", "getUrl", "e"]
}
