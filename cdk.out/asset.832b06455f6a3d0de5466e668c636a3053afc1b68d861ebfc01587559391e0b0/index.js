"use strict";var m=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var I=Object.getOwnPropertyNames;var D=Object.prototype.hasOwnProperty;var v=(t,n)=>{for(var e in n)m(t,e,{get:n[e],enumerable:!0})},B=(t,n,e,i)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of I(n))!D.call(t,s)&&s!==e&&m(t,s,{get:()=>n[s],enumerable:!(i=S(n,s))||i.enumerable});return t};var _=t=>B(m({},"__esModule",{value:!0}),t);var h={};v(h,{handler:()=>N});module.exports=_(h);var d=require("@aws-sdk/client-cognito-identity-provider"),A=require("@aws-sdk/client-dynamodb"),o=require("@aws-sdk/lib-dynamodb"),{USER_POOL_ID:y="",TABLE_NAME:c=""}=process.env;if(!c)throw new Error("Missing env TABLE_NAME");if(!y)throw new Error("Missing env USER_POOL_ID");var U=new d.CognitoIdentityProviderClient({}),f=o.DynamoDBDocumentClient.from(new A.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),E=t=>`USER#${t}`,b="BESTIE";async function l(t){let e=(await f.send(new o.GetCommand({TableName:c,Key:{pk:E(t),sk:b}}))).Item??{};return{active:!!e.active,since:e.since??null,until:e.until??null,source:e.source??null}}async function a(t,n){let e=new Date().toISOString();return await f.send(new o.UpdateCommand({TableName:c,Key:{pk:E(t),sk:b},UpdateExpression:"SET #doc = if_not_exists(#doc, :empty), updatedAt = :now",ExpressionAttributeNames:{"#doc":"doc"},ExpressionAttributeValues:{":empty":{},":now":e}})),await f.send(new o.UpdateCommand({TableName:c,Key:{pk:E(t),sk:b},UpdateExpression:"SET active = :a, since = if_not_exists(since, :since), until = :u, source = :s, updatedAt = :now",ExpressionAttributeValues:{":a":n.active,":since":n.since??e,":u":n.until??null,":s":n.source??null,":now":e}})),l(t)}async function p(t){let e=(await U.send(new d.ListUsersCommand({UserPoolId:y,Filter:`email = "${t}"`,Limit:1}))).Users?.[0];return e?.Attributes?e.Attributes.find(s=>s.Name==="sub")?.Value??null:null}function u(t){let n=t?.groups;return Array.isArray(n)&&n.includes("ADMIN")}var N=async t=>{let n=t.identity,e=t.info?.fieldName;if(e==="meBestieStatus"){if(!n?.sub)throw new Error("Unauthorized");return l(n.sub)}if(e==="isEpisodeEarlyAccess"){let i=Date.now(),s=n?.sub;if(!s)return{allowed:!1,reason:"not_signed_in"};let r=await l(s),w=r.until?Date.parse(r.until):0,g=r.active&&w>i;return{allowed:g,reason:g?null:"not_bestie"}}if(e==="claimBestieTrial"){if(!n?.sub)throw new Error("Unauthorized");let i=await l(n.sub);if(i.active&&i.until&&Date.parse(i.until)>Date.now()||i.source==="TRIAL")return i;let s=7*24*60*60*1e3,r=new Date(Date.now()+s).toISOString();return a(n.sub,{active:!0,until:r,source:"TRIAL"})}if(e==="adminSetBestie"){if(!u(n))throw new Error("Forbidden");let{userSub:i,active:s}=t.arguments,r=s?new Date(Date.now()+365*24*60*60*1e3).toISOString():null;return a(i,{active:!!s,until:r,source:"ADMIN"})}if(e==="adminRevokeBestie"){if(!u(n))throw new Error("Forbidden");let{userSub:i}=t.arguments;return a(i,{active:!1,until:null,source:"ADMIN"})}if(e==="adminSetBestieByEmail"){if(!u(n))throw new Error("Forbidden");let{email:i,active:s}=t.arguments,r=await p(i);if(!r)throw new Error("User not found");let w=s?new Date(Date.now()+365*24*60*60*1e3).toISOString():null;return a(r,{active:!!s,until:w,source:"ADMIN_EMAIL"})}if(e==="adminRevokeBestieByEmail"){if(!u(n))throw new Error("Forbidden");let{email:i}=t.arguments,s=await p(i);if(!s)throw new Error("User not found");return a(s,{active:!1,until:null,source:"ADMIN_EMAIL"})}throw new Error(`Unknown field ${e}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
