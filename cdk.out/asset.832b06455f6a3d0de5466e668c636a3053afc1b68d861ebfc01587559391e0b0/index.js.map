{
  "version": 3,
  "sources": ["../../lambda/bestie/index.ts"],
  "sourcesContent": ["// lambda/bestie/index.ts\r\nimport {\r\n  CognitoIdentityProviderClient,\r\n  ListUsersCommand,\r\n} from \"@aws-sdk/client-cognito-identity-provider\";\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  GetCommand,\r\n  UpdateCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\nimport type { AppSyncIdentityCognito } from \"aws-lambda\";\r\n\r\nconst { USER_POOL_ID = \"\", TABLE_NAME = \"\" } = process.env;\r\nif (!TABLE_NAME) throw new Error(\"Missing env TABLE_NAME\");\r\nif (!USER_POOL_ID) throw new Error(\"Missing env USER_POOL_ID\");\r\n\r\nconst cognito = new CognitoIdentityProviderClient({});\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}), {\r\n  marshallOptions: { removeUndefinedValues: true },\r\n});\r\n\r\ntype SAId =\r\n  | (AppSyncIdentityCognito & {\r\n      groups?: string[] | null;\r\n    })\r\n  | null\r\n  | undefined;\r\n\r\nconst PK = (sub: string) => `USER#${sub}`;\r\nconst SK_BESTIE = \"BESTIE\";\r\n\r\n/** Load current Bestie status from DDB. */\r\nasync function loadBestie(sub: string) {\r\n  const r = await ddb.send(\r\n    new GetCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: { pk: PK(sub), sk: SK_BESTIE },\r\n    })\r\n  );\r\n  const i = (r.Item as any) ?? {};\r\n  return {\r\n    active: !!i.active,\r\n    since: (i.since as string) ?? null,\r\n    until: (i.until as string) ?? null,\r\n    source: (i.source as string) ?? null,\r\n  };\r\n}\r\n\r\n/** Upsert Bestie status. */\r\nasync function saveBestie(\r\n  sub: string,\r\n  patch: { active: boolean; since?: string | null; until?: string | null; source?: string | null }\r\n) {\r\n  const now = new Date().toISOString();\r\n\r\n  // ensure document exists (optional bootstrap)\r\n  await ddb.send(\r\n    new UpdateCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: { pk: PK(sub), sk: SK_BESTIE },\r\n      UpdateExpression: \"SET #doc = if_not_exists(#doc, :empty), updatedAt = :now\",\r\n      ExpressionAttributeNames: { \"#doc\": \"doc\" },\r\n      ExpressionAttributeValues: { \":empty\": {}, \":now\": now },\r\n    })\r\n  );\r\n\r\n  // apply the patch\r\n  await ddb.send(\r\n    new UpdateCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: { pk: PK(sub), sk: SK_BESTIE },\r\n      UpdateExpression:\r\n        \"SET active = :a, since = if_not_exists(since, :since), until = :u, source = :s, updatedAt = :now\",\r\n      ExpressionAttributeValues: {\r\n        \":a\": patch.active,\r\n        \":since\": patch.since ?? now,\r\n        \":u\": patch.until ?? null,\r\n        \":s\": patch.source ?? null,\r\n        \":now\": now,\r\n      },\r\n    })\r\n  );\r\n\r\n  return loadBestie(sub);\r\n}\r\n\r\n/** Helper: find sub by email when admin sets bestie by email. */\r\nasync function lookupSubByEmail(email: string) {\r\n  const res = await cognito.send(\r\n    new ListUsersCommand({\r\n      UserPoolId: USER_POOL_ID,\r\n      Filter: `email = \"${email}\"`,\r\n      Limit: 1,\r\n    })\r\n  );\r\n  const user = res.Users?.[0];\r\n  if (!user?.Attributes) return null;\r\n  const subAttr = user.Attributes.find((a) => a.Name === \"sub\");\r\n  return subAttr?.Value ?? null;\r\n}\r\n\r\nfunction isAdmin(id: SAId) {\r\n  const g = (id as any)?.groups;\r\n  return Array.isArray(g) && g.includes(\"ADMIN\");\r\n}\r\n\r\nexport const handler = async (event: any) => {\r\n  const id = event.identity as SAId;\r\n  const fn = event.info?.fieldName as string;\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  // Query: meBestieStatus\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (fn === \"meBestieStatus\") {\r\n    if (!id?.sub) throw new Error(\"Unauthorized\");\r\n    return loadBestie(id.sub);\r\n  }\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  // Query: isEpisodeEarlyAccess(id)\r\n  // Rule: Bestie is active && until > now\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (fn === \"isEpisodeEarlyAccess\") {\r\n    const now = Date.now();\r\n    const sub = id?.sub;\r\n    if (!sub) return { allowed: false, reason: \"not_signed_in\" };\r\n    const b = await loadBestie(sub);\r\n    const untilMs = b.until ? Date.parse(b.until) : 0;\r\n    const allowed = b.active && untilMs > now;\r\n    return { allowed, reason: allowed ? null : \"not_bestie\" };\r\n  }\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  // Mutation: claimBestieTrial (7 days)\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (fn === \"claimBestieTrial\") {\r\n    if (!id?.sub) throw new Error(\"Unauthorized\");\r\n    const current = await loadBestie(id.sub);\r\n\r\n    // If already active with a future-until, just return\r\n    if (current.active && current.until && Date.parse(current.until) > Date.now()) {\r\n      return current;\r\n    }\r\n    // If they already had a trial, do not re-grant\r\n    if (current.source === \"TRIAL\") {\r\n      return current;\r\n    }\r\n\r\n    const sevenDays = 7 * 24 * 60 * 60 * 1000;\r\n    const until = new Date(Date.now() + sevenDays).toISOString();\r\n    return saveBestie(id.sub, { active: true, until, source: \"TRIAL\" });\r\n  }\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  // Admin helpers (require ADMIN group)\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (fn === \"adminSetBestie\") {\r\n    if (!isAdmin(id)) throw new Error(\"Forbidden\");\r\n    const { userSub, active } = event.arguments as { userSub: string; active: boolean };\r\n    const until = active ? new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString() : null;\r\n    return saveBestie(userSub, { active: !!active, until, source: \"ADMIN\" });\r\n  }\r\n\r\n  if (fn === \"adminRevokeBestie\") {\r\n    if (!isAdmin(id)) throw new Error(\"Forbidden\");\r\n    const { userSub } = event.arguments as { userSub: string };\r\n    return saveBestie(userSub, { active: false, until: null, source: \"ADMIN\" });\r\n  }\r\n\r\n  if (fn === \"adminSetBestieByEmail\") {\r\n    if (!isAdmin(id)) throw new Error(\"Forbidden\");\r\n    const { email, active } = event.arguments as { email: string; active: boolean };\r\n    const sub = await lookupSubByEmail(email);\r\n    if (!sub) throw new Error(\"User not found\");\r\n    const until = active ? new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString() : null;\r\n    return saveBestie(sub, { active: !!active, until, source: \"ADMIN_EMAIL\" });\r\n  }\r\n\r\n  if (fn === \"adminRevokeBestieByEmail\") {\r\n    if (!isAdmin(id)) throw new Error(\"Forbidden\");\r\n    const { email } = event.arguments as { email: string };\r\n    const sub = await lookupSubByEmail(email);\r\n    if (!sub) throw new Error(\"User not found\");\r\n    return saveBestie(sub, { active: false, until: null, source: \"ADMIN_EMAIL\" });\r\n  }\r\n\r\n  throw new Error(`Unknown field ${fn}`);\r\n};\r\n\r\n"],
  "mappings": "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",
  "names": ["bestie_exports", "__export", "handler", "__toCommonJS", "import_client_cognito_identity_provider", "import_client_dynamodb", "import_lib_dynamodb", "USER_POOL_ID", "TABLE_NAME", "cognito", "ddb", "PK", "sub", "SK_BESTIE", "loadBestie", "i", "saveBestie", "patch", "now", "lookupSubByEmail", "email", "user", "a", "isAdmin", "id", "g", "event", "fn", "b", "untilMs", "allowed", "current", "sevenDays", "until", "userSub", "active"]
}
