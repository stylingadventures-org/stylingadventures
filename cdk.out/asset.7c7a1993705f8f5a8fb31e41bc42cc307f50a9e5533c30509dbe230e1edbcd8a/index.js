"use strict";var p=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var T=Object.prototype.hasOwnProperty;var I=(e,n)=>{for(var o in n)p(e,o,{get:n[o],enumerable:!0})},k=(e,n,o,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of x(n))!T.call(e,r)&&r!==o&&p(e,r,{get:()=>n[r],enumerable:!(t=N(n,r))||t.enumerable});return e};var h=e=>k(p({},"__esModule",{value:!0}),e);var K={};I(K,{handler:()=>M});module.exports=h(K);var i=require("@aws-sdk/client-dynamodb"),u=require("@aws-sdk/client-sfn"),w=require("crypto"),d=new i.DynamoDBClient({}),C=new u.SFNClient({}),{TABLE_NAME:a="",APPROVAL_SM_ARN:A=""}=process.env;if(!a)throw new Error("Missing env: TABLE_NAME");var g=()=>new Date().toISOString(),s=e=>({S:e}),S=e=>e==null?{S:""}:{S:e};function m(e){let n=e?.identity?.claims||{},o=e?.identity?.sub||n?.sub,t=Array.isArray(n?.["cognito:groups"])?n["cognito:groups"]:String(n?.["cognito:groups"]||"").split(",").map(c=>c.trim()).filter(Boolean),r=t.includes("ADMIN")||t.includes("COLLAB");if(!o)throw new Error("Unauthorized");return{sub:o,isAdmin:r}}var y=async e=>{let{sub:n}=m(e);return((await d.send(new i.ScanCommand({TableName:a,FilterExpression:"begins_with(pk, :pfx) AND ownerSub = :me",ExpressionAttributeValues:{":pfx":s("ITEM#"),":me":s(n)},ProjectionExpression:"id, ownerSub, status, createdAt, updatedAt, mediaKey, title, reason",Limit:100}))).Items||[]).map(t=>({id:t.id?.S,ownerSub:t.ownerSub?.S,status:t.status?.S,createdAt:t.createdAt?.S,updatedAt:t.updatedAt?.S,mediaKey:t.mediaKey?.S||null,title:t.title?.S||null,reason:t.reason?.S||null}))},E=async e=>{let{isAdmin:n}=m(e);if(!n)throw new Error("Unauthorized");return((await d.send(new i.ScanCommand({TableName:a,FilterExpression:"begins_with(pk, :pfx) AND #s = :pending",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":pfx":s("ITEM#"),":pending":s("PENDING")},ProjectionExpression:"id, ownerSub, status, createdAt, updatedAt, mediaKey, title, reason",Limit:100}))).Items||[]).map(t=>({id:t.id?.S,ownerSub:t.ownerSub?.S,status:t.status?.S,createdAt:t.createdAt?.S,updatedAt:t.updatedAt?.S,mediaKey:t.mediaKey?.S||null,title:t.title?.S||null,reason:t.reason?.S||null}))},b=async e=>{let{sub:n,isAdmin:o}=m(e),t=e?.arguments?.id;if(!t)throw new Error("id required");let r=g();if(!o){let l=(await d.send(new i.GetItemCommand({TableName:a,Key:{pk:s(`ITEM#${t}`),sk:s("META")},ProjectionExpression:"ownerSub"}))).Item?.ownerSub?.S;if(!l)throw new Error("Not found");if(l!==n)throw new Error("Not authorized")}if(await d.send(new i.UpdateItemCommand({TableName:a,Key:{pk:s(`ITEM#${t}`),sk:s("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":s("PENDING"),":u":s(r),":g2pk":s("STATUS#PENDING"),":g2sk":s(r)}})),A)try{await C.send(new u.StartExecutionCommand({stateMachineArn:A,input:JSON.stringify({itemId:t,ownerSub:n}),name:`req-${t}-${Date.now()}`}))}catch{}return"OK"},f=async e=>{let{sub:n}=m(e),o=e?.arguments||{},t=(0,w.randomUUID)(),r=g();return await d.send(new i.PutItemCommand({TableName:a,Item:{pk:s(`ITEM#${t}`),sk:s("META"),id:s(t),ownerSub:s(n),status:s("DRAFT"),title:S(o.title),mediaKey:S(o.mediaKey),createdAt:s(r),updatedAt:s(r),gsi1pk:s(`OWNER#${n}`),gsi1sk:s(r),gsi2pk:s("STATUS#DRAFT"),gsi2sk:s(r)},ConditionExpression:"attribute_not_exists(pk)"})),{id:t,ownerSub:n,status:"DRAFT",title:o.title??"",mediaKey:o.mediaKey??"",createdAt:r,updatedAt:r}};var D={myCloset:y,adminListPending:E,createClosetItem:f,requestClosetApproval:b,hello:async()=>"Hello from Styling Adventures \u{1F44B}"},M=async e=>{let n=e?.info?.fieldName,o=D[n];if(!o)throw new Error(`No resolver for field ${n}`);return o(e)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
