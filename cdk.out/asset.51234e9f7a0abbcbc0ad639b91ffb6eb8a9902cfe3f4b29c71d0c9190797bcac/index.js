"use strict";var A=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var w=(t,n)=>{for(var e in n)A(t,e,{get:n[e],enumerable:!0})},x=(t,n,e,i)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of v(n))!N.call(t,s)&&s!==e&&A(t,s,{get:()=>n[s],enumerable:!(i=I(n,s))||i.enumerable});return t};var S=t=>x(A({},"__esModule",{value:!0}),t);var R={};w(R,{handler:()=>C});module.exports=S(R);var T=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb");var u=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!u)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var m=a.DynamoDBDocumentClient.from(new T.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),y=t=>`USER#${t}`,E="PROFILE";function L(t){let n=t?.claims||{},e=n.tier??n["custom:tier"];if(e&&["FREE","BESTIE","CREATOR","COLLAB","ADMIN","PRIME"].includes(e))return e;let s=n["cognito:groups"],r=Array.isArray(s)?s:String(s||"").split(",").map(l=>l.trim()).filter(Boolean);return r.includes("ADMIN")?"ADMIN":r.includes("PRIME")?"PRIME":r.includes("CREATOR")?"CREATOR":r.includes("COLLAB")?"COLLAB":r.includes("BESTIE")?"BESTIE":"FREE"}function f(t){return{userId:t,displayName:"Fan",level:1,xp:0,coins:0,badges:[],avatarUrl:null,bio:null,lastEventAt:null,streakCount:null,lastLoginAt:null,pinnedClosetItems:[]}}function b(t){let n=1,e=100,i=t|0;for(;i>=e;)i-=e,n++,e+=50;return n}async function g(t){let n=y(t),{Item:e}=await m.send(new a.GetCommand({TableName:u,Key:{pk:n,sk:E}}));if(!e){let d=new Date().toISOString();await m.send(new a.UpdateCommand({TableName:u,Key:{pk:n,sk:E},UpdateExpression:"SET #uid=:uid, #xp=:xp, #coins=:coins, #badges=:badges, #ts=:ts",ExpressionAttributeNames:{"#uid":"userId","#xp":"xp","#coins":"coins","#badges":"badges","#ts":"lastEventAt"},ExpressionAttributeValues:{":uid":t,":xp":0,":coins":0,":badges":[],":ts":d}}));let o=0;return{userId:t,level:b(o),xp:o,coins:0,badges:[],lastEventAt:d,streakCount:null,lastLoginAt:null,displayName:null,avatarUrl:null,bio:null}}e.userId||await m.send(new a.UpdateCommand({TableName:u,Key:{pk:n,sk:E},UpdateExpression:"SET #uid = if_not_exists(#uid, :uid)",ExpressionAttributeNames:{"#uid":"userId"},ExpressionAttributeValues:{":uid":t}}));let i=null,s=e.lastEventAt;typeof s=="number"?(i=new Date(s).toISOString(),await m.send(new a.UpdateCommand({TableName:u,Key:{pk:n,sk:E},UpdateExpression:"SET #ts = :ts",ExpressionAttributeNames:{"#ts":"lastEventAt"},ExpressionAttributeValues:{":ts":i}}))):typeof s=="string"?i=s:i=null;let r=null,l=e.lastLoginAt;typeof l=="number"?(r=new Date(l).toISOString(),await m.send(new a.UpdateCommand({TableName:u,Key:{pk:n,sk:E},UpdateExpression:"SET #ll = :ll",ExpressionAttributeNames:{"#ll":"lastLoginAt"},ExpressionAttributeValues:{":ll":r}}))):typeof l=="string"?r=l:r=null;let c=e.xp??0,p=e.coins??0;return{userId:e.userId??t,level:b(c),xp:c,coins:p,badges:Array.isArray(e.badges)?e.badges:[],displayName:e.displayName??null,avatarUrl:e.avatarUrl??null,bio:e.bio??null,lastEventAt:i,streakCount:typeof e.streakCount=="number"?e.streakCount:null,lastLoginAt:r}}async function U(t,n){let e=y(t),i=(n??"").trim().slice(0,40),s=new Date().toISOString();return await m.send(new a.UpdateCommand({TableName:u,Key:{pk:e,sk:E},UpdateExpression:"SET #dn=:dn, #ts=:ts ADD #xp :zero, #coins :zero",ExpressionAttributeNames:{"#dn":"displayName","#ts":"lastEventAt","#xp":"xp","#coins":"coins"},ExpressionAttributeValues:{":dn":i,":ts":s,":zero":0}})),g(t)}var C=async t=>{let n=t.identity,e=n?.sub;if(!e)throw new Error("Unauthorized: missing sub");let i=L(n);switch(t.info.fieldName){case"getMyProfile":return i==="FREE"?f(e):g(e);case"setDisplayName":return i==="FREE"?f(e):U(e,t.arguments.displayName);case"updateProfile":{if(i==="FREE")return f(e);let{displayName:s,avatarUrl:r,bio:l}=t.arguments.input||{},c=y(e),p={},d={},o=[];return typeof s=="string"&&(p["#dn"]="displayName",d[":dn"]=s.trim().slice(0,40),o.push("#dn = :dn")),typeof r=="string"&&(p["#av"]="avatarUrl",d[":av"]=r,o.push("#av = :av")),typeof l=="string"&&(p["#bio"]="bio",d[":bio"]=l.trim().slice(0,280),o.push("#bio = :bio")),p["#ts"]="lastEventAt",d[":ts"]=new Date().toISOString(),o.push("#ts = :ts"),o.length&&await m.send(new a.UpdateCommand({TableName:u,Key:{pk:c,sk:E},UpdateExpression:`SET ${o.join(", ")}`,ExpressionAttributeNames:p,ExpressionAttributeValues:d})),g(e)}default:throw new Error(`Unknown field ${t.info.fieldName}`)}};0&&(module.exports={handler});
