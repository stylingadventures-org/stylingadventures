"use strict";var C=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var W=(e,t)=>{for(var i in t)C(e,i,{get:t[i],enumerable:!0})},q=(e,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of G(t))!j.call(e,o)&&o!==i&&C(e,o,{get:()=>t[o],enumerable:!(s=B(t,o))||s.enumerable});return e};var H=e=>q(C({},"__esModule",{value:!0}),e);var se={};W(se,{adminApproveItem:()=>K,adminCreateClosetItem:()=>P,adminListBestieClosetItems:()=>O,adminListClosetItems:()=>N,adminListPending:()=>V,adminRejectItem:()=>U,adminSetClosetAudience:()=>R,adminUpdateClosetItem:()=>D,closetFeed:()=>k,handler:()=>ne,toggleFavoriteClosetItem:()=>_,topClosetLooks:()=>M});module.exports=H(se);var c=require("@aws-sdk/client-dynamodb"),S=require("@aws-sdk/client-sfn"),g=new c.DynamoDBClient({}),x=new S.SFNClient({}),{TABLE_NAME:m="",ADMIN_GROUP_NAME:J="admin",CREATOR_GROUP_NAME:z="creator"}=process.env;if(!m)throw new Error("Missing env: TABLE_NAME");var Q=J.toLowerCase(),X=z.toLowerCase(),w=()=>new Date().toISOString(),n=e=>({S:e});function p(e){let t=e?.S;if(typeof t=="string"&&t.trim())return t}function v(e){let t=e?.N;if(typeof t!="string")return;let i=Number(t);return Number.isFinite(i)?i:void 0}function Y(e){let t=e?.BOOL;return typeof t=="boolean"?t:void 0}function Z(e){let t=e?.L;if(!Array.isArray(t))return;let i=t.map(s=>typeof s?.S=="string"?s.S:null).filter(Boolean);return i.length?i:void 0}function ee(e){let t=e?.claims||{},i=t["cognito:groups"]||t["custom:groups"]||e?.groups||[];return Array.isArray(i)?i.map(s=>String(s)):typeof i=="string"?i.split(",").map(s=>s.trim()).filter(Boolean):[]}function b(e){let t=e.identity,i=t?.claims||{},s=t?.sub||i.sub;if(!s)throw new Error("Unauthorized");let o=ee(t),u=o.map(a=>a.toLowerCase()),r=u.includes(Q),l=u.includes(X);return{sub:s,isAdmin:r,isCreator:l,groups:o}}function E(e,t){let i=v(e.favoriteCount)??0,s=Y(e.pinned),o=p(e.createdAt)??w(),u=p(e.updatedAt)??o;return{id:p(e.id)??"",userId:p(e.ownerSub)??"",ownerSub:p(e.ownerSub)??"",status:p(e.status)??"PENDING",createdAt:o,updatedAt:u,mediaKey:p(e.mediaKey)??"",rawMediaKey:p(e.rawMediaKey)??"",title:p(e.title)??"",reason:p(e.reason)??"",season:p(e.season)??null,vibes:p(e.vibes)??null,audience:p(e.audience)??null,category:p(e.category)??null,subcategory:p(e.subcategory)??null,pinned:s,favoriteCount:i,viewerHasFaved:!1,coinValue:v(e.coinValue)??null,scheduledAt:p(e.scheduledAt)??null,episodeIds:Z(e.episodeIds)??null,backgroundStatus:p(e.backgroundStatus)??null,...t}}function te(){return globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`}function T(e){return e?Buffer.from(JSON.stringify(e),"utf8").toString("base64"):null}function L(e){if(e)try{return JSON.parse(Buffer.from(String(e),"base64").toString("utf8"))}catch{return}}var V=async e=>{let{isAdmin:t}=b(e);if(!t)throw new Error("Forbidden");let{limit:i=100,nextToken:s}=e.arguments||{},o=L(s),u=await g.send(new c.QueryCommand({TableName:m,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned, coinValue, scheduledAt, episodeIds, backgroundStatus",ExpressionAttributeNames:{"#s":"status"},Limit:i,ExclusiveStartKey:o}));return{items:(u.Items||[]).map(l=>E({...l,status:l.status})),nextToken:T(u.LastEvaluatedKey)}},N=async e=>{let{isAdmin:t}=b(e);if(!t)throw new Error("Forbidden");let{status:i,limit:s=50,nextToken:o}=e.arguments||{},u=L(o);if(i){let a=await g.send(new c.QueryCommand({TableName:m,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n(`STATUS#${i}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned, coinValue, scheduledAt, episodeIds, backgroundStatus",ExpressionAttributeNames:{"#s":"status"},Limit:s,ExclusiveStartKey:u}));return{items:(a.Items||[]).map(d=>E({...d,status:d.status})),nextToken:T(a.LastEvaluatedKey)}}let r=await g.send(new c.ScanCommand({TableName:m,FilterExpression:"begins_with(pk, :p)",ExpressionAttributeValues:{":p":n("ITEM#")},ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned, coinValue, scheduledAt, episodeIds, backgroundStatus",ExpressionAttributeNames:{"#s":"status"},Limit:s,ExclusiveStartKey:u})),l=(r.Items||[]).map(a=>E({...a,status:a.status}));return l.sort((a,f)=>new Date(f.createdAt||0).getTime()-new Date(a.createdAt||0).getTime()),{items:l,nextToken:T(r.LastEvaluatedKey)}},O=async e=>{let t=await N(e),i=new Set(["BESTIE","EXCLUSIVE"]),s=t.items.filter(o=>{let u=(o.audience||"").toUpperCase();return i.has(u)});return{...t,items:s}},k=async e=>{let{sub:t}=b(e),s=(e.arguments?.sort??"NEWEST")==="MOST_LOVED"?"MOST_LOVED":"NEWEST",o=["APPROVED","PUBLISHED"],u=await g.send(new c.QueryCommand({TableName:m,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:{":pk":n(`FAV#${t}`),":sk":n("CLOSET#")}})),r=new Set((u.Items||[]).map(a=>{let f=a.sk?.S??"";return f.startsWith("CLOSET#")?f.substring(7):a.closetId?.S??""})),l=[];for(let a of o){let d=((await g.send(new c.QueryCommand({TableName:m,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n(`STATUS#${a}`)},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, audience, favoriteCount, category, subcategory, season, vibes, pinned, coinValue, scheduledAt, episodeIds, backgroundStatus",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(y=>{let A=p(y.id)??"";return E({...y,status:y.status},{viewerHasFaved:A?r.has(A):!1})}).filter(y=>!!y.id);l.push(...d)}return l.sort((a,f)=>{let d=new Date(a.createdAt||0).getTime(),y=new Date(f.createdAt||0).getTime();if(s==="MOST_LOVED"){let A=a.favoriteCount??0,I=f.favoriteCount??0;return I!==A?I-A:y-d}return y-d}),{items:l,nextToken:null}},M=async e=>(await k({...e,arguments:{...e.arguments||{},sort:"NEWEST"}})).items,P=async e=>{let{sub:t,isAdmin:i}=b(e);if(!i)throw new Error("Forbidden");let s=e.arguments?.input||{};if(!s.title?.trim())throw new Error("title is required");let o=s.rawMediaKey||s.mediaKey;if(!o)throw new Error("rawMediaKey is required");let u=te(),r=w();return await g.send(new c.PutItemCommand({TableName:m,Item:{pk:n(`ITEM#${u}`),sk:n("META"),id:n(u),ownerSub:n(t),gsi2pk:n("STATUS#PENDING"),gsi2sk:n(r),status:n("PENDING"),createdAt:n(r),updatedAt:n(r),title:n(s.title.trim()),rawMediaKey:n(o),favoriteCount:{N:"0"},...s.season?{season:n(s.season)}:{},...s.vibes?{vibes:n(s.vibes)}:{},...s.category?{category:n(s.category)}:{},...s.subcategory?{subcategory:n(s.subcategory)}:{},...s.audience?{audience:n(s.audience)}:{},...s.description?{description:n(s.description)}:{},...s.story?{story:n(s.story)}:{}}})),{id:u,userId:t,ownerSub:t,status:"PENDING",createdAt:r,updatedAt:r,title:s.title.trim(),mediaKey:"",rawMediaKey:o,reason:"",season:s.season??null,vibes:s.vibes??null,audience:s.audience??null,category:s.category??null,subcategory:s.subcategory??null,favoriteCount:0,viewerHasFaved:!1,coinValue:null,scheduledAt:null,episodeIds:null,backgroundStatus:null}},K=async e=>{let{isAdmin:t}=b(e);if(!t)throw new Error("Forbidden");let i=e.arguments?.closetItemId;if(!i)throw new Error("closetItemId required");let s=w(),u=(await g.send(new c.UpdateItemCommand({TableName:m,Key:{pk:n(`ITEM#${i}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("APPROVED"),":u":n(s),":g2pk":n("STATUS#APPROVED"),":g2sk":n(s)},ReturnValues:"ALL_OLD"}))).Attributes,r=u.approvalToken?.S;if(r)try{await x.send(new S.SendTaskSuccessCommand({taskToken:r,output:JSON.stringify({approved:!0})}))}catch{}return E({...u,status:n("APPROVED")})},U=async e=>{let{isAdmin:t}=b(e);if(!t)throw new Error("Forbidden");let i=e.arguments?.closetItemId,s=e.arguments?.reason||"";if(!i)throw new Error("closetItemId required");let o=w(),r=(await g.send(new c.UpdateItemCommand({TableName:m,Key:{pk:n(`ITEM#${i}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("REJECTED"),":u":n(o),":g2pk":n("STATUS#REJECTED"),":g2sk":n(o),":r":n(s)},ReturnValues:"ALL_OLD"}))).Attributes,l=r.approvalToken?.S;if(l)try{await x.send(new S.SendTaskFailureCommand({taskToken:l,error:"Rejected",cause:s||"Rejected by admin"}))}catch{}return E({...r,status:n("REJECTED"),reason:n(s)})},D=async e=>{let{isAdmin:t}=b(e);if(!t)throw new Error("Forbidden");let i=e.arguments||{},s=i.input||{},o=i.closetItemId??s.id??i.id;if(!o)throw new Error("closetItemId or input.id required");if(!(await g.send(new c.GetItemCommand({TableName:m,Key:{pk:n(`ITEM#${o}`),sk:n("META")}}))).Item)throw new Error("Closet item not found");let r={...s};["title","category","subcategory","audience","pinned","season","vibes","coinValue","backgroundStatus","scheduledAt","episodeIds"].forEach(A=>{i[A]!==void 0&&r[A]===void 0&&(r[A]=i[A])});let l=w(),a=["#updatedAt = :u"],f={"#updatedAt":"updatedAt"},d={":u":n(l)};if(r.title!==void 0&&(a.push("#title = :title"),f["#title"]="title",d[":title"]=r.title===null?{NULL:!0}:n(r.title)),r.category!==void 0&&(a.push("#category = :category"),f["#category"]="category",d[":category"]=r.category===null?{NULL:!0}:n(r.category)),r.subcategory!==void 0&&(a.push("#subcategory = :subcategory"),f["#subcategory"]="subcategory",d[":subcategory"]=r.subcategory===null?{NULL:!0}:n(r.subcategory)),r.audience!==void 0&&(a.push("audience = :audience"),d[":audience"]=r.audience===null?{NULL:!0}:n(r.audience)),r.season!==void 0&&(a.push("season = :season"),d[":season"]=r.season===null?{NULL:!0}:n(r.season)),r.vibes!==void 0&&(a.push("vibes = :vibes"),d[":vibes"]=r.vibes===null?{NULL:!0}:n(r.vibes)),r.pinned!==void 0&&(a.push("pinned = :pinned"),d[":pinned"]=r.pinned===null?{NULL:!0}:{BOOL:!!r.pinned}),r.coinValue!==void 0&&(a.push("coinValue = :coinValue"),d[":coinValue"]=r.coinValue===null?{NULL:!0}:{N:String(r.coinValue)}),r.backgroundStatus!==void 0&&(a.push("backgroundStatus = :backgroundStatus"),d[":backgroundStatus"]=r.backgroundStatus===null?{NULL:!0}:n(r.backgroundStatus)),r.scheduledAt!==void 0&&(a.push("scheduledAt = :scheduledAt"),d[":scheduledAt"]=r.scheduledAt===null?{NULL:!0}:n(r.scheduledAt)),r.episodeIds!==void 0&&(a.push("episodeIds = :episodeIds"),d[":episodeIds"]=r.episodeIds===null?{NULL:!0}:{L:r.episodeIds.map(A=>n(A))}),a.length===1)throw new Error("No fields provided to update");let y=await g.send(new c.UpdateItemCommand({TableName:m,Key:{pk:n(`ITEM#${o}`),sk:n("META")},UpdateExpression:`SET ${a.join(", ")}`,ExpressionAttributeNames:f,ExpressionAttributeValues:d,ReturnValues:"ALL_NEW"}));if(!y.Attributes)throw new Error("Closet item not found");return E(y.Attributes)},R=async e=>{let{isAdmin:t}=b(e);if(!t)throw new Error("Forbidden");let i=e.arguments?.closetItemId,s=e.arguments?.audience;if(!i)throw new Error("closetItemId required");if(!s)throw new Error("audience required");let o=w(),u=await g.send(new c.UpdateItemCommand({TableName:m,Key:{pk:n(`ITEM#${i}`),sk:n("META")},UpdateExpression:"SET audience = :aud, updatedAt = :u",ExpressionAttributeValues:{":aud":n(s),":u":n(o)},ReturnValues:"ALL_NEW"}));if(!u.Attributes)throw new Error("Closet item not found");return E(u.Attributes)},_=async e=>{let{sub:t}=b(e),i=e.arguments?.id,s=e.arguments?.favoriteOn,o=e.arguments?.on,u=typeof s=="boolean"?s:o;if(!i)throw new Error("id required");let l=(await g.send(new c.GetItemCommand({TableName:m,Key:{pk:n(`ITEM#${i}`),sk:n("META")}}))).Item;if(!l)throw new Error("Closet item not found");let a={pk:n(`FAV#${t}`),sk:n(`CLOSET#${i}`)},d=!!(await g.send(new c.GetItemCommand({TableName:m,Key:a}))).Item,y=typeof u=="boolean"?u:!d,A=w(),I=0;y&&!d?(I=1,await g.send(new c.PutItemCommand({TableName:m,Item:{...a,userSub:n(t),closetId:n(i),createdAt:n(A)}}))):!y&&d&&(I=-1,await g.send(new c.DeleteItemCommand({TableName:m,Key:a}))),I!==0&&await g.send(new c.UpdateItemCommand({TableName:m,Key:{pk:n(`ITEM#${i}`),sk:n("META")},UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) + :delta, updatedAt = :u",ExpressionAttributeValues:{":zero":{N:"0"},":delta":{N:String(I)},":u":n(A)}}));let h=l.favoriteCount?.N,F=typeof h=="string"?Number(h):0,$=Math.max(0,F+I);return E(l,{favoriteCount:$,viewerHasFaved:y})},ne=async e=>{let t=e.info.fieldName;if(t==="adminListPending")return V(e);if(t==="adminListClosetItems")return N(e);if(t==="adminListBestieClosetItems")return O(e);if(t==="adminCreateClosetItem")return P(e);if(t==="adminApproveItem")return K(e);if(t==="adminRejectItem")return U(e);if(t==="adminSetClosetAudience")return R(e);if(t==="adminUpdateClosetItem")return D(e);if(t==="closetFeed")return k(e);if(t==="topClosetLooks")return M(e);if(t==="toggleFavoriteClosetItem"||t==="likeClosetItem")return _(e);throw new Error(`No resolver implemented for field ${t}`)};0&&(module.exports={adminApproveItem,adminCreateClosetItem,adminListBestieClosetItems,adminListClosetItems,adminListPending,adminRejectItem,adminSetClosetAudience,adminUpdateClosetItem,closetFeed,handler,toggleFavoriteClosetItem,topClosetLooks});
//# sourceMappingURL=index.js.map
