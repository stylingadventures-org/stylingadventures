"use strict";var u=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var E=(t,e)=>{for(var n in e)u(t,n,{get:e[n],enumerable:!0})},I=(t,e,n,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of w(e))!S.call(t,r)&&r!==n&&u(t,r,{get:()=>e[r],enumerable:!(s=C(e,r))||s.enumerable});return t};var R=t=>I(u({},"__esModule",{value:!0}),t);var L={};E(L,{handler:()=>N});module.exports=R(L);var o=require("@aws-sdk/client-s3"),m=require("@aws-sdk/s3-request-presigner"),g=new o.S3Client({region:process.env.AWS_REGION||"us-east-1",forcePathStyle:!0}),l=process.env.BUCKET,A=String(process.env.ALLOWED_ORIGINS||"").split(",").map(t=>t.trim()).filter(Boolean),G=process.env.WEB_ORIGIN||"",T=["authorization","Authorization","Content-Type","X-Amz-Date","X-Api-Key","X-Amz-Security-Token"].join(",");function y(t){let e=t?.headers?.origin||t?.headers?.Origin||"";return A.length?A.includes(e)?e:void 0:G||void 0}function c(t){let e={"Content-Type":"application/json","Access-Control-Allow-Headers":T,"Access-Control-Allow-Methods":"POST,DELETE,OPTIONS","Access-Control-Allow-Credentials":"true",Vary:"Origin"};return t&&(e["Access-Control-Allow-Origin"]=t),e}function f(t,e,n={}){let s=y(t);return{statusCode:200,headers:{...c(s),...n},body:JSON.stringify(e)}}function x(t){let e=y(t);return{statusCode:204,headers:c(e),body:""}}function a(t,e,n){let s=y(t);return!!(t.headers?.origin||t.headers?.Origin)&&!s?{statusCode:403,headers:c(void 0),body:JSON.stringify({message:"CORS: origin not allowed"})}:{statusCode:e,headers:c(s),body:JSON.stringify({message:n})}}function b(t){return t.httpMethod??t.requestContext?.http?.method??"GET"}function k(t){return t.requestContext?.authorizer?.claims??t.requestContext?.authorizer?.jwt?.claims??{}}function h(t,e){let n=String(e||"").replace(/\.\./g,"").replace(/^[/\\]+/,"");return n.startsWith(`users/${t}/`)?n:`users/${t}/${n}`}var N=async t=>{let e=b(t);if(e==="OPTIONS")return!y(t)&&(t.headers?.origin||t.headers?.Origin)?{statusCode:403,headers:c(void 0),body:""}:x(t);try{let s=k(t)?.sub;if(!s)return a(t,401,"Not authorized");if(e==="POST"){let r=JSON.parse(t.body||"{}"),i=String(r.key||""),p=String(r.contentType||"application/octet-stream");if(!i)return a(t,400,"Missing 'key'");let d=h(s,i),O=new o.PutObjectCommand({Bucket:l,Key:d,ContentType:p}),P=await(0,m.getSignedUrl)(g,O,{expiresIn:900});return f(t,{key:d,url:P})}if(e==="DELETE"){let r=t?.queryStringParameters?.key??t.pathParameters?.key??"";if(!r)return a(t,400,"Missing 'key'");let i=h(s,String(r));return await g.send(new o.DeleteObjectCommand({Bucket:l,Key:i})),f(t,{deleted:!0,key:i})}return a(t,405,"Method Not Allowed")}catch(n){return console.error(n),a(t,500,n?.message??String(n))}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
