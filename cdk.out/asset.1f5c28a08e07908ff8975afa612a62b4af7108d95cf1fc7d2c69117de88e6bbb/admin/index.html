<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Canonicalize host to non-www, but **never** on auth pages -->
  <script>
    (function canonicalize(){
      const p = location.pathname || "/";
      const isAuthPage = p.startsWith("/callback") || p.startsWith("/logout");
      if (!isAuthPage && location.hostname === "www.stylingadventures.com") {
        location.replace(location.href.replace("://www.", "://"));
      }
    })();
  </script>
  <title>Styling Adventures</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/css/thumbs.css" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="alternate icon" href="/favicon.ico" />
  <style>
    /* Dropzone */
    #dropzone.dz{padding:20px;border:2px dashed #bbb;border-radius:10px;transition:border-color .15s}
    #dropzone.dz.dragover{border-color:#666}
    /* Upload rows */
    .li-row{margin:6px 0}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .row strong{min-width:220px;word-break:break-all}
    .row .size{min-width:90px}
    .row .ctype{min-width:150px}
    .row progress{width:220px;height:10px;border-radius:6px;overflow:hidden}
    .row .status{min-width:120px}
    .ml-auto{margin-left:auto}
    .hidden{display:none}
    .sa-error{color:#b00020}
    /* Topbar & role badge */
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:.5rem}
    .who{font:500 14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:#475569}
    .badge{display:inline-flex;align-items:center;gap:.35rem;font:600 12px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      padding:.25rem .5rem;border-radius:999px;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;margin-left:.5rem}
    .badge .dot{width:.5rem;height:.5rem;border-radius:50%;background:#6366f1}
    .badge.admin{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .badge.admin .dot{background:#ef4444}
    .badge.creator{background:#ecfeff;border-color:#a5f3fc;color:#155e75}
    .badge.creator .dot{background:#06b6d4}
    /* Toast */
    .toast-wrap{position:fixed;inset:auto 0 16px 0;display:flex;flex-direction:column;align-items:center;gap:8px;z-index:9999;pointer-events:none}
    .toast{pointer-events:auto;max-width:min(92vw,680px);width:fit-content;padding:.6rem .9rem;border-radius:10px;
      background:#111827;color:#fff;font:500 14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .toast.ok{background:#065f46}
    .toast.err{background:#7f1d1d}
    .fade-in{animation:fadein .18s ease-out}
    @keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    /* Thumbs */
    .thumb{height:40px;border-radius:6px;cursor:pointer;display:none}
    .thumb.show{display:inline-block}
    /* Admin table */
    .sa-table-wrap{overflow:auto}
    .sa-table{width:100%;border-collapse:separate;border-spacing:0}
    .sa-table th,.sa-table td{padding:.6rem .7rem;border-bottom:1px solid #e5e7eb;text-align:left;vertical-align:top}
    .sa-table thead th{font-weight:600;color:#334155;background:#f8fafc;position:sticky;top:0}
    .pill{display:inline-block;padding:.15rem .45rem;border-radius:999px;font:600 11px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .pill.pending{background:#fdf4ff;color:#6b21a8;border:1px solid #f5d0fe}
    .pill.approved{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}
    .pill.rejected{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    .pill.published{background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe}
    .sa-btn.linklike{background:transparent;border:0;color:#2563eb;padding:0;cursor:pointer}
    .nowrap{white-space:nowrap}
    .mini{font-size:12px;color:#64748b;word-break:break-all}
  </style>
</head>
<body class="sa-body">
  <div class="topbar">
    <h1 class="sa-h1 m-0">StylingAdventures
      <span id="role-badge" class="badge"><span class="dot"></span><span class="txt">…</span></span>
    </h1>
    <div class="who">
      <span id="who-email">Not signed in</span>
      <span class="ml-2">
        <a id="signin" href="#" class="sa-link">Sign in</a>
        <button id="signout" class="sa-btn sa-btn-outline ml-2">Sign out</button>
        <button id="signout-global" class="sa-btn sa-btn-outline ml-2">Sign out everywhere</button>
        <a href="/fan/" class="sa-btn ml-2">Fan dashboard</a>
        <a href="/creator/" class="sa-btn ml-2">Creator dashboard</a>
      </span>
    </div>
  </div>

  <h2>Status</h2>
  <div id="status" class="sa-card">Loading…</div>
  <div class="mini" id="auth-url-out"></div>
  <button id="refresh-now" class="sa-btn mt-2" aria-label="Refresh tokens now">Refresh tokens now</button>

  <h3>Debug</h3>
  <pre id="dbg" class="sa-pre sa-muted"></pre>

  <h2>AppSync hello</h2>
  <div class="sa-card">
    <button id="btn-hello" class="sa-btn">Call { hello }</button>
    <span id="hello-out" class="ml-2 sa-muted" aria-live="polite"></span>
  </div>

  <!-- Roles UI -->
  <h2>My role</h2>
  <div class="sa-card" id="role-card">
    <div class="sa-role-row">
      <button id="btn-load-me" class="sa-btn">Load my role</button>
      <label>Role
        <select id="role" class="sa-input">
          <option>FAN</option><option>BESTIE</option><option>CREATOR</option><option>COLLAB</option><option>ADMIN</option>
        </select>
      </label>
      <label>Tier
        <select id="tier" class="sa-input">
          <option>FREE</option><option>PRIME</option>
        </select>
      </label>
      <button id="btn-save-role" class="sa-btn">Save role</button>
    </div>
    <pre id="meOut" class="sa-pre sa-muted sa-me-pre"></pre>
  </div>

  <h2>Uploads</h2>
  <div class="sa-card">
    <div class="form-row">
      <label for="upload-key" class="sa-label">Key prefix (optional)</label>
      <input id="upload-key" placeholder="e.g. photos/2025/" class="sa-input" />
    </div>
    <div class="form-row">
      <label for="upload-file" class="sa-label">Files</label>
      <input id="upload-file" type="file" multiple class="sa-input" />
    </div>
    <div id="dropzone" class="sa-card sa-muted dz" aria-label="Drop files here">
      Drag & drop files here, or use the file picker above.
    </div>
    <button id="btn-upload" class="sa-btn mt-2">Upload selected files</button>
    <p id="uploads-msg" class="sa-muted mt-2" aria-live="polite"></p>

    <img id="img" alt="thumbnail preview" width="200" />
    <ul id="upload-list" class="sa-muted mt-2"></ul>
  </div>

  <section id="creator-tools" class="sa-card hidden">
    <h2>Creator tools</h2>
    <p>Stuff for CREATOR / COLLAB / ADMIN.</p>
  </section>

  <section id="admin-tools" class="sa-card hidden">
    <h2>Admin</h2>
    <div class="mb-2">
      <button id="btn-list-pending" class="sa-btn">List pending uploads</button>
    </div>
    <div class="sa-table-wrap">
      <table class="sa-table" id="pending-table" aria-live="polite">
        <thead>
          <tr><th>ID</th><th>Owner</th><th>Title</th><th>Status</th><th>When</th><th>Actions</th></tr>
        </thead>
        <tbody id="pending-body"><tr><td colspan="6" class="sa-muted">No data</td></tr></tbody>
      </table>
    </div>
    <pre id="admin-out" class="sa-pre sa-muted mt-2"></pre>
  </section>

  <div class="toast-wrap" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <script type="module">
    import { decorateThumb } from '/js/thumbs-ui.js';

    const q  = (s, r=document) => r.querySelector(s);
    const qq = (s, r=document) => Array.from(r.querySelectorAll(s));
    const h  = (html) => { const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild; };
    const copy = async (txt) => { try { await navigator.clipboard.writeText(String(txt)); return true; } catch { return false; } };
    const fmtDate = (iso) => new Date(iso).toLocaleString();

    function toast(text, type='info', ms=2800){
      const wrap = q('#toasts');
      const el = document.createElement('div');
      el.className = `toast fade-in ${type==='error'?'err': type==='ok'?'ok':''}`;
      el.textContent = text;
      wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(4px)'; }, ms);
      setTimeout(()=>{ el.remove(); }, ms+250);
      const sr = q('#uploads-msg'); if (sr) { sr.textContent = text; sr.className = `sa-muted mt-2 ${type==='error'?'sa-error':''}`; }
    }

    /* ========================== config & auth (DROP-IN) ========================== */
    async function loadCfg(){
      const res = await fetch('/config.v2.json?ts=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load /config.v2.json');
      return res.json();
    }
    const cfg = await loadCfg();
    window._cfg = { ...cfg };
    const CLIENT_ID = cfg.clientId || cfg.clientID;

    // Resolve Hosted UI base
    function resolveHostedUiBase(c){
      if (c.hostedUiDomain) return `https://${c.hostedUiDomain}.auth.${c.region}.amazoncognito.com`;
      if (c.domain && c.domain.includes('amazoncognito.com')) return c.domain.replace(/\/+$/,'');
      if (c.domain && !c.domain.includes('_')) return `https://${c.domain}.auth.${c.region}.amazoncognito.com`;
      throw new Error('config.v2.json: Provide "hostedUiDomain" (prefix) or full "domain" URL for Cognito Hosted UI.');
    }
    const hostedBase = resolveHostedUiBase(cfg);

    /* ===== normalized redirect/logout URIs ===== */
    const PROD_CF = 'https://d1so4qr6zsby5r.cloudfront.net';
    const isLocal = location.origin.startsWith('http://localhost:');

    const expectedRedirect = isLocal
      ? 'http://localhost:5173/callback/'
      : `${PROD_CF}/callback/`;

    const expectedLogout = isLocal
      ? 'http://localhost:5173/'
      : `${PROD_CF}/`;

    function normalizeCallback(u) {
      if (!u) return expectedRedirect;
      return u
        .replace(/\/callback\/index\.html$/i, '/callback/')
        .replace('https://d1s04qr6zsby5r.cloudfront.net', PROD_CF);
    }
    function normalizeLogout(u) {
      if (!u) return expectedLogout;
      return u
        .replace(/\/logout\/index\.html$/i, '/')
        .replace(/\/logout\/?$/i, '/')
        .replace('https://d1s04qr6zsby5r.cloudfront.net', PROD_CF);
    }

    const redirectUri = normalizeCallback(
      cfg.redirectUri || cfg.redirectURL || cfg.redirectUrl
    );
    const logoutUri = normalizeLogout(
      cfg.logoutUri || cfg.logoutURL || cfg.logoutUrl
    );

    // ---------- PKCE helpers ----------
    const b64url = (buf) =>
      btoa(String.fromCharCode(...new Uint8Array(buf)))
        .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    const sha256 = (text) =>
      crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
    function genVerifier(){ return b64url(crypto.getRandomValues(new Uint8Array(32))); }

    async function buildLoginUrl(){
      const state = crypto.getRandomValues(new Uint32Array(1))[0].toString(36);
      sessionStorage.setItem('oauth_state', state);

      const verifier = genVerifier();
      sessionStorage.setItem('pkce_verifier', verifier);
      const challenge = b64url(await sha256(verifier));

      const p = new URLSearchParams({
        response_type: 'code',
        client_id: CLIENT_ID,
        redirect_uri: redirectUri,
        scope: 'email openid profile',
        state,
        code_challenge: challenge,
        code_challenge_method: 'S256'
      });
      return `${hostedBase}/oauth2/authorize?${p.toString()}`;
    }

    // Precompute URL (and show it)
    const loginUrl = await buildLoginUrl();
    const logoutUrl = `${hostedBase}/logout?client_id=${encodeURIComponent(CLIENT_ID)}&logout_uri=${encodeURIComponent(logoutUri)}`;
    q('#auth-url-out').innerHTML = `Auth URL: <code>${loginUrl}</code>`;
    q('#signin').href = loginUrl;
    console.log('Authorize URL →', loginUrl);

    function startLogin(e){
      e?.preventDefault();
      buildLoginUrl().then((url) => location.assign(url));
    }
    function signOutLocal(){ sessionStorage.clear(); render(); }

    async function signOutEverywhere(){
      try{
        const refresh = sessionStorage.getItem('refresh_token') ||
                        (JSON.parse(sessionStorage.getItem('tokens')||'{}').refresh_token);
        if (refresh){
          const body = new URLSearchParams({ token: refresh, token_type_hint:'refresh_token', client_id: CLIENT_ID });
          await fetch(`${hostedBase}/oauth2/revoke`, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body }).catch(()=>{});
        }
      } finally {
        sessionStorage.clear();
        location.replace(logoutUrl);
      }
    }

    // Wire auth buttons
    q('#signin').addEventListener('click', startLogin);
    q('#signout').addEventListener('click', e => { e.preventDefault(); signOutLocal(); });
    q('#signout-global').addEventListener('click', e => { e.preventDefault(); signOutEverywhere(); });

    // ---- Refresh tokens now ----
    q('#refresh-now').addEventListener('click', async () => {
      try{
        const { refreshTokens, scheduleRotation } = await import('/auth/refresh.js');
        const out = await refreshTokens({ domain: hostedBase, clientId: CLIENT_ID });
        scheduleRotation(out, { domain: hostedBase, clientId: CLIENT_ID });
        toast('Tokens refreshed','ok',1400);
      }catch(e){
        toast('Could not refresh tokens. Try signing in again.','error');
      }finally{
        render();
      }
    });
    /* ======================== end drop-in ======================== */

    const parseJwt = (t) => { if(!t) return null; try{ return JSON.parse(atob(t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));}catch{return null;} };
    const secondsLeft = id => { const p=parseJwt(id); return p?.exp ? Math.max(0, p.exp - Math.floor(Date.now()/1000)) : 0; };

    function setRoleBadge(role='…'){
      const b = document.getElementById('role-badge');
      const txt = b?.querySelector('.txt');
      if (!b || !txt) return;
      b.classList.remove('admin','creator');
      if (role === 'ADMIN') b.classList.add('admin');
      if (role === 'CREATOR' || role === 'COLLAB') b.classList.add('creator');
      txt.textContent = String(role || 'FAN');
    }

    function roleFromJwtOrDefault(){
      const p = parseJwt(sessionStorage.getItem('id_token') || '');
      const groups = (p?.['cognito:groups'] || []);
      if (groups.includes('ADMIN')) return 'ADMIN';
      if (groups.includes('COLLAB')) return 'COLLAB';
      if (groups.includes('CREATOR')) return 'CREATOR';
      if (groups.includes('BESTIE'))  return 'BESTIE';
      return 'FAN';
    }

    const appsyncUrl = (cfg.appSyncUrl || cfg.appsyncUrl);
    if (!appsyncUrl) console.warn('config.v2.json is missing "appSyncUrl"');

    function render(){
      const id  = sessionStorage.getItem('id_token');
      const payload = parseJwt(id || '');
      q('#signin').style.display         = id ? 'none' : 'inline';
      q('#signout').style.display        = id ? 'inline-block' : 'none';
      q('#signout-global').style.display = id ? 'inline-block' : 'none';

      const left = secondsLeft(id);
      const mins = Math.floor(left/60);
      const secs = String(left%60).padStart(2,'0');

      const baseStatus = id
        ? `Signed in · token refreshes in ${mins}:${secs}`
        : 'You’re signed out. Click “Sign in” to start.';
      const warn = !appsyncUrl
        ? ` <span class="sa-error">· Missing <code>appSyncUrl</code> in config — GraphQL calls are disabled.</span>`
        : '';
      q('#status').innerHTML = baseStatus + warn;

      if (!appsyncUrl) {
        q('#btn-hello')?.setAttribute('disabled', 'true');
        q('#hello-out')?.classList.add('sa-error');
      }

      q('#dbg').textContent    = id ? JSON.stringify(payload || {}, null, 2) : '';
      q('#who-email').textContent = id ? (payload?.email || '(no email)') : 'Not signed in';
      q('#role-card').style.opacity = id ? 1 : 0.5;

      if (id) setRoleBadge(roleFromJwtOrDefault());
    }

    async function gql(query, variables={}){
      const id = sessionStorage.getItem('id_token');
      if (!id) throw new Error('Not signed in.');
      const r = await fetch(appsyncUrl, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', Authorization: id },
        body: JSON.stringify({ query, variables })
      });
      if (r.status === 401) {
        console.error('AppSync 401 — ensure the API is using the same user pool for auth.');
      }
      const j = await r.json().catch(()=>({}));
      if (!r.ok || j?.errors) throw new Error((j?.errors && j.errors[0]?.message) || `AppSync ${r.status}`);
      return j.data;
    }

    async function callHello(){
      const id = sessionStorage.getItem('id_token');
      if (!id){ toast('Please sign in first','error'); return; }
      if (!appsyncUrl){ toast('AppSync URL missing in config','error'); return; }
      const res = await fetch(appsyncUrl,{
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization': id },
        body: JSON.stringify({ query: `query Hello { hello }` })
      });
      if (!res.ok) throw new Error(`AppSync ${res.status}: ${await res.text()}`);
      const j = await res.json();
      q('#hello-out').textContent = j.data?.hello ?? '(no data)';
      toast('Hello response received ✅','ok',1800);
    }

    function show(el, yes) { if (el) el.classList.toggle('hidden', !yes); }
    function applyRoleUi(roleFromMe) {
      const jwtRole = roleFromJwtOrDefault();
      const role = roleFromMe || jwtRole;

      const isCreatorish = role === 'CREATOR' || role === 'COLLAB' || role === 'ADMIN';
      const isAdmin      = role === 'ADMIN';

      const uploadsHeader = Array.from(document.querySelectorAll('h2'))
        .find(h => h.textContent?.trim().toLowerCase() === 'uploads');
      const uploadsCard = uploadsHeader?.nextElementSibling;
      show(uploadsHeader, isCreatorish);
      show(uploadsCard, isCreatorish);

      show(document.getElementById('creator-tools'), isCreatorish);
      show(document.getElementById('admin-tools'), isAdmin);
      setRoleBadge(role);
    }

    /* … (uploads code unchanged) … */

    // Kick off initial render and keep the countdown fresh
    render();
    setInterval(render, 1000);

    // Post-sign-in conveniences
    if (sessionStorage.getItem('id_token')) {
      applyRoleUi(roleFromJwtOrDefault());
      // optionally load user/profile here…
    } else {
      applyRoleUi('FAN');
    }
  </script>

  <!-- Tiny admin-link injector (shown only for ADMIN group) -->
  <script>
  (function addAdminLink(){
    try{
      const t = sessionStorage.getItem("id_token") || localStorage.getItem("sa_id_token");
      if(!t) return;
      const claims = JSON.parse(atob(t.split(".")[1].replace(/-/g,"+").replace(/_/g,"/")));
      const g = claims["cognito:groups"];
      const isAdmin = Array.isArray(g) ? g.includes("ADMIN") : String(g||"").includes("ADMIN");
      if(!isAdmin) return;
      const nav = document.querySelector("nav, .sa-nav, header") || document.body;
      const a = document.createElement("a");
      a.href = "/admin/"; a.textContent = "Admin dashboard"; a.style.marginLeft = "0.75rem";
      nav.appendChild(a);
    }catch{}
  })();
  </script>
</body>
</html>


