"use strict";var m=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var b=Object.prototype.hasOwnProperty;var L=(s,e)=>{for(var i in e)m(s,i,{get:e[i],enumerable:!0})},f=(s,e,i,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of w(e))!b.call(s,t)&&t!==i&&m(s,t,{get:()=>e[t],enumerable:!(n=g(e,t))||n.enumerable});return s};var k=s=>f(m({},"__esModule",{value:!0}),s);var y={};L(y,{handler:()=>T});module.exports=k(y);var A=require("@aws-sdk/client-dynamodb"),o=require("@aws-sdk/lib-dynamodb");var r=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!r)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var p=o.DynamoDBDocumentClient.from(new A.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),T=async s=>{let e=s.identity,i=s.info?.fieldName;if(i==="createPoll"){if(!e?.sub)throw new Error("Unauthorized");let{question:n,options:t}=s.arguments.input,d=String(Date.now()),u=new Date().toISOString();return await p.send(new o.PutCommand({TableName:r,Item:{pk:`POLL#${d}`,sk:"META",gsi2pk:"POLL",gsi2sk:`CREATED#${d}`,question:n,options:t,totals:new Array(t.length).fill(0),createdBy:e.username||e.sub,createdAt:u},ConditionExpression:"attribute_not_exists(pk)"})),{pollId:d,question:n,options:t,totals:new Array(t.length).fill(0),createdBy:e.username||e.sub,createdAt:u}}if(i==="votePoll"){if(!e?.sub)throw new Error("Unauthorized");let{pollId:n,optionIndex:t}=s.arguments;await p.send(new o.PutCommand({TableName:r,Item:{pk:`POLL#${n}`,sk:`VOTE#${t}#${e.sub}`,gsi2pk:`POLL#${n}`,gsi2sk:`VOTE#${t}#${e.sub}`,userId:e.sub,at:new Date().toISOString()},ConditionExpression:"attribute_not_exists(pk)"})).catch(a=>{if(!String(a).includes("ConditionalCheckFailed"))throw a});let u=(await p.send(new o.GetCommand({TableName:r,Key:{pk:`POLL#${n}`,sk:"META"}}))).Item?.options??[],c=[];for(let a=0;a<u.length;a++){let E=await p.send(new o.QueryCommand({TableName:r,IndexName:"gsi2",KeyConditionExpression:"#pk = :p AND begins_with(#sk, :pref)",ExpressionAttributeNames:{"#pk":"gsi2pk","#sk":"gsi2sk"},ExpressionAttributeValues:{":p":`POLL#${n}`,":pref":`VOTE#${a}#`},Select:"COUNT"}));c.push(E.Count??0)}let l=await p.send(new o.UpdateCommand({TableName:r,Key:{pk:`POLL#${n}`,sk:"META"},UpdateExpression:"SET totals = :t",ExpressionAttributeValues:{":t":c},ReturnValues:"ALL_NEW"}));return{pollId:n,question:l.Attributes?.question,options:l.Attributes?.options,totals:l.Attributes?.totals,createdBy:l.Attributes?.createdBy,createdAt:l.Attributes?.createdAt}}if(i==="getPoll"){let{pollId:n}=s.arguments,t=await p.send(new o.GetCommand({TableName:r,Key:{pk:`POLL#${n}`,sk:"META"}}));return t.Item?{pollId:n,question:t.Item.question,options:t.Item.options??[],totals:t.Item.totals??[],createdBy:t.Item.createdBy,createdAt:t.Item.createdAt}:null}throw new Error("Unknown field")};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
