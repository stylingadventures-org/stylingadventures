{
  "version": 3,
  "sources": ["../../lambda/closet/admin.ts"],
  "sourcesContent": ["// lambda/closet/admin.ts\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  QueryCommand,\r\n  UpdateCommand,\r\n  GetCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\nimport type { AppSyncResolverEvent, AppSyncIdentityCognito } from \"aws-lambda\";\r\n\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}));\r\n\r\n// Accept either CLOSET_TABLE or TABLE_NAME to be resilient with CDK envs\r\nconst TABLE =\r\n  process.env.CLOSET_TABLE ||\r\n  process.env.TABLE_NAME ||\r\n  (() => {\r\n    throw new Error(\"Missing env CLOSET_TABLE/TABLE_NAME\");\r\n  })();\r\n\r\n// Status GSI: defaults to \"gsi2\" (your table\u2019s status index)\r\nconst STATUS_GSI = process.env.STATUS_GSI || \"gsi2\";\r\n\r\ntype ClosetStatus = \"PENDING\" | \"APPROVED\" | \"REJECTED\" | \"PUBLISHED\";\r\n\r\nconst now = () => new Date().toISOString();\r\n\r\nfunction isPrivileged(id?: AppSyncIdentityCognito) {\r\n  const groups =\r\n    ((id as any)?.claims?.[\"cognito:groups\"] as string[] | undefined) ?? [];\r\n  return Array.isArray(groups) && (groups.includes(\"ADMIN\") || groups.includes(\"COLLAB\"));\r\n}\r\n\r\n// Your table uses pk/sk like ITEM#<id>/META\r\nconst itemKey = (id: string) => ({ pk: `ITEM#${id}`, sk: \"META\" });\r\n\r\n// Ensure GraphQL ClosetItem.userId (ID!) is always set (ownerSub fallback)\r\n// Order: userId \u2192 ownerSub \u2192 derive from gsi1pk (OWNER#sub) \u2192 \"\"\r\nfunction materializeUserId(item: any) {\r\n  if (!item) return item;\r\n  const fromGsi1 =\r\n    typeof item?.gsi1pk === \"string\" && item.gsi1pk.startsWith(\"OWNER#\")\r\n      ? item.gsi1pk.slice(\"OWNER#\".length)\r\n      : undefined;\r\n  const userId = item.userId ?? item.ownerSub ?? fromGsi1 ?? \"\";\r\n  return { ...item, userId };\r\n}\r\n\r\nexport const handler = async (event: AppSyncResolverEvent<any>) => {\r\n  const field = event.info.fieldName;\r\n  const ident = event.identity as AppSyncIdentityCognito | undefined;\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  // Admin: list pending items \u2014 ensure userId is non-null\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (field === \"adminListPending\") {\r\n    const out = await ddb.send(\r\n      new QueryCommand({\r\n        TableName: TABLE,\r\n        IndexName: STATUS_GSI, // e.g. \"gsi2\"\r\n        KeyConditionExpression: \"#gpk = :pk\",\r\n        ExpressionAttributeNames: { \"#gpk\": \"gsi2pk\" },\r\n        ExpressionAttributeValues: { \":pk\": \"STATUS#PENDING\" },\r\n        ScanIndexForward: true,\r\n        Limit: 100,\r\n      })\r\n    );\r\n\r\n    const items = (out.Items ?? []).map((raw: any) =>\r\n      materializeUserId({\r\n        id: raw.id,\r\n        title: raw.title ?? null,\r\n        status: raw.status as ClosetStatus,\r\n        mediaKey: raw.mediaKey ?? null,\r\n        ownerSub: raw.ownerSub,\r\n        createdAt: raw.createdAt,\r\n        updatedAt: raw.updatedAt,\r\n        reason: raw.reason ?? null,\r\n        userId: raw.userId,\r\n        gsi1pk: raw.gsi1pk, // optional: helps derive userId if needed\r\n      })\r\n    );\r\n\r\n    // Drop any that still lack userId to avoid non-nullable GraphQL error\r\n    return items.filter((x) => !!x.userId);\r\n  }\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  // Admin: approve item\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (field === \"adminApproveItem\") {\r\n    if (!isPrivileged(ident)) throw new Error(\"Not authorized\");\r\n    const id = String(event.arguments?.id || \"\");\r\n    if (!id) throw new Error(\"id is required\");\r\n\r\n    // Ensure it exists\r\n    const cur = await ddb.send(new GetCommand({ TableName: TABLE, Key: itemKey(id) }));\r\n    if (!cur.Item) throw new Error(\"Item not found\");\r\n\r\n    // Only allow from PENDING \u2192 APPROVED (and keep GSI2 in sync)\r\n    const out = await ddb.send(\r\n      new UpdateCommand({\r\n        TableName: TABLE,\r\n        Key: itemKey(id),\r\n        UpdateExpression:\r\n          \"SET #st = :approved, #updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE #reason\",\r\n        ExpressionAttributeNames: {\r\n          \"#st\": \"status\",\r\n          \"#updatedAt\": \"updatedAt\",\r\n          \"#reason\": \"reason\",\r\n        },\r\n        ExpressionAttributeValues: {\r\n          \":approved\": \"APPROVED\",\r\n          \":u\": now(),\r\n          \":g2pk\": \"STATUS#APPROVED\",\r\n          \":g2sk\": now(),\r\n          \":pending\": \"PENDING\",\r\n        },\r\n        ConditionExpression: \"#st = :pending\",\r\n        ReturnValues: \"ALL_NEW\",\r\n      })\r\n    );\r\n\r\n    return materializeUserId({ id, ...(out.Attributes || {}) });\r\n  }\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  // Admin: reject item\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (field === \"adminRejectItem\") {\r\n    if (!isPrivileged(ident)) throw new Error(\"Not authorized\");\r\n    const id = String(event.arguments?.id || \"\");\r\n    const reason = (event.arguments?.reason as string | undefined) ?? null;\r\n    if (!id) throw new Error(\"id is required\");\r\n\r\n    const cur = await ddb.send(new GetCommand({ TableName: TABLE, Key: itemKey(id) }));\r\n    if (!cur.Item) throw new Error(\"Item not found\");\r\n\r\n    const out = await ddb.send(\r\n      new UpdateCommand({\r\n        TableName: TABLE,\r\n        Key: itemKey(id),\r\n        UpdateExpression:\r\n          \"SET #st = :rejected, #updatedAt = :u, #reason = :rsn, gsi2pk = :g2pk, gsi2sk = :g2sk\",\r\n        ExpressionAttributeNames: {\r\n          \"#st\": \"status\",\r\n          \"#updatedAt\": \"updatedAt\",\r\n          \"#reason\": \"reason\",\r\n        },\r\n        ExpressionAttributeValues: {\r\n          \":rejected\": \"REJECTED\",\r\n          \":u\": now(),\r\n          \":rsn\": reason,\r\n          \":g2pk\": \"STATUS#REJECTED\",\r\n          \":g2sk\": now(),\r\n          \":pending\": \"PENDING\",\r\n        },\r\n        ConditionExpression: \"#st = :pending\",\r\n        ReturnValues: \"ALL_NEW\",\r\n      })\r\n    );\r\n\r\n    return materializeUserId({ id, ...(out.Attributes || {}) });\r\n  }\r\n\r\n  throw new Error(`Unhandled field: ${field}`);\r\n};\r\n"],
  "mappings": "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",
  "names": ["admin_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "ddb", "TABLE", "STATUS_GSI", "now", "isPrivileged", "id", "groups", "itemKey", "materializeUserId", "item", "fromGsi1", "userId", "event", "field", "ident", "raw", "x", "out", "reason"]
}
