"use strict";var E=Object.defineProperty;var l=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var y=Object.prototype.hasOwnProperty;var f=(e,t)=>{for(var i in t)E(e,i,{get:t[i],enumerable:!0})},T=(e,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of S(t))!y.call(e,o)&&o!==i&&E(e,o,{get:()=>t[o],enumerable:!(s=l(t,o))||s.enumerable});return e};var I=e=>T(E({},"__esModule",{value:!0}),e);var k={};f(k,{handler:()=>w});module.exports=I(k);var g=require("@aws-sdk/client-dynamodb"),r=require("@aws-sdk/lib-dynamodb"),d=r.DynamoDBDocumentClient.from(new g.DynamoDBClient({})),a=process.env.CLOSET_TABLE||process.env.TABLE_NAME||(()=>{throw new Error("Missing env CLOSET_TABLE/TABLE_NAME")})(),N=process.env.STATUS_GSI||"gsi2",u=()=>new Date().toISOString();function A(e){let t=e?.claims?.["cognito:groups"]??[];return Array.isArray(t)&&(t.includes("ADMIN")||t.includes("COLLAB"))}var p=e=>({pk:`ITEM#${e}`,sk:"META"});function c(e){if(!e)return e;let t=typeof e?.gsi1pk=="string"&&e.gsi1pk.startsWith("OWNER#")?e.gsi1pk.slice(6):void 0,i=e.userId??e.ownerSub??t??"";return{...e,userId:i}}var w=async e=>{let t=e.info.fieldName,i=e.identity;if(t==="adminListPending")return((await d.send(new r.QueryCommand({TableName:a,IndexName:N,KeyConditionExpression:"#gpk = :pk",ExpressionAttributeNames:{"#gpk":"gsi2pk"},ExpressionAttributeValues:{":pk":"STATUS#PENDING"},ScanIndexForward:!0,Limit:100}))).Items??[]).map(n=>c({id:n.id,title:n.title??null,status:n.status,mediaKey:n.mediaKey??null,ownerSub:n.ownerSub,createdAt:n.createdAt,updatedAt:n.updatedAt,reason:n.reason??null,userId:n.userId,gsi1pk:n.gsi1pk})).filter(n=>!!n.userId);if(t==="adminApproveItem"){if(!A(i))throw new Error("Not authorized");let s=String(e.arguments?.id||"");if(!s)throw new Error("id is required");if(!(await d.send(new r.GetCommand({TableName:a,Key:p(s)}))).Item)throw new Error("Item not found");let n=await d.send(new r.UpdateCommand({TableName:a,Key:p(s),UpdateExpression:"SET #st = :approved, #updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE #reason",ExpressionAttributeNames:{"#st":"status","#updatedAt":"updatedAt","#reason":"reason"},ExpressionAttributeValues:{":approved":"APPROVED",":u":u(),":g2pk":"STATUS#APPROVED",":g2sk":u(),":pending":"PENDING"},ConditionExpression:"#st = :pending",ReturnValues:"ALL_NEW"}));return c({id:s,...n.Attributes||{}})}if(t==="adminRejectItem"){if(!A(i))throw new Error("Not authorized");let s=String(e.arguments?.id||""),o=e.arguments?.reason??null;if(!s)throw new Error("id is required");if(!(await d.send(new r.GetCommand({TableName:a,Key:p(s)}))).Item)throw new Error("Item not found");let m=await d.send(new r.UpdateCommand({TableName:a,Key:p(s),UpdateExpression:"SET #st = :rejected, #updatedAt = :u, #reason = :rsn, gsi2pk = :g2pk, gsi2sk = :g2sk",ExpressionAttributeNames:{"#st":"status","#updatedAt":"updatedAt","#reason":"reason"},ExpressionAttributeValues:{":rejected":"REJECTED",":u":u(),":rsn":o,":g2pk":"STATUS#REJECTED",":g2sk":u(),":pending":"PENDING"},ConditionExpression:"#st = :pending",ReturnValues:"ALL_NEW"}));return c({id:s,...m.Attributes||{}})}throw new Error(`Unhandled field: ${t}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
