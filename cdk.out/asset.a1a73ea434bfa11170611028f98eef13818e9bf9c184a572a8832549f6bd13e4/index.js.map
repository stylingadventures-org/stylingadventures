{
  "version": 3,
  "sources": ["../../lambda/presign/index.ts"],
  "sourcesContent": ["import {\r\n  APIGatewayProxyEvent,\r\n  APIGatewayProxyEventV2,\r\n  APIGatewayProxyResult,\r\n} from \"aws-lambda\";\r\nimport { S3Client, PutObjectCommand } from \"@aws-sdk/client-s3\";\r\nimport { getSignedUrl } from \"@aws-sdk/s3-request-presigner\";\r\n\r\n// Path-style so host stays s3.us-east-1.amazonaws.com and avoids per-bucket DNS lookups.\r\nconst s3 = new S3Client({\r\n  region: process.env.AWS_REGION || \"us-east-1\",\r\n  forcePathStyle: true,\r\n});\r\n\r\nconst BUCKET = process.env.BUCKET!;\r\n\r\n/* ============================== CORS helpers ============================== */\r\nconst ALLOWED_ORIGINS = String(process.env.ALLOWED_ORIGINS || \"\")\r\n  .split(\",\")\r\n  .map((s) => s.trim())\r\n  .filter(Boolean);\r\nconst FALLBACK_ORIGIN = process.env.WEB_ORIGIN || \"\";\r\n\r\nconst ALLOW_HEADERS = [\r\n  \"authorization\",\r\n  \"Authorization\",\r\n  \"Content-Type\",\r\n  \"X-Amz-Date\",\r\n  \"X-Api-Key\",\r\n  \"X-Amz-Security-Token\",\r\n].join(\",\");\r\n\r\nfunction pickAllowedOrigin(event: any): string | undefined {\r\n  const reqOrigin = event?.headers?.origin || event?.headers?.Origin || \"\";\r\n  if (ALLOWED_ORIGINS.length) {\r\n    return ALLOWED_ORIGINS.includes(reqOrigin) ? reqOrigin : undefined;\r\n  }\r\n  return FALLBACK_ORIGIN || undefined;\r\n}\r\n\r\nfunction baseCorsHeaders(origin?: string) {\r\n  const h: Record<string, string> = {\r\n    \"Content-Type\": \"application/json\",\r\n    \"Access-Control-Allow-Headers\": ALLOW_HEADERS,\r\n    \"Access-Control-Allow-Methods\": \"POST,OPTIONS\",\r\n    \"Access-Control-Allow-Credentials\": \"true\",\r\n    Vary: \"Origin\",\r\n  };\r\n  if (origin) h[\"Access-Control-Allow-Origin\"] = origin;\r\n  return h;\r\n}\r\n\r\nfunction ok(\r\n  event: any,\r\n  body: unknown,\r\n  extra: Record<string, string> = {}\r\n): APIGatewayProxyResult {\r\n  const origin = pickAllowedOrigin(event);\r\n  return {\r\n    statusCode: 200,\r\n    headers: { ...baseCorsHeaders(origin), ...extra },\r\n    body: JSON.stringify(body),\r\n  };\r\n}\r\n\r\nfunction bad(event: any, status: number, msg: string): APIGatewayProxyResult {\r\n  const origin = pickAllowedOrigin(event);\r\n  const hasReqOrigin = !!(event.headers?.origin || event.headers?.Origin);\r\n  if (hasReqOrigin && !origin) {\r\n    return {\r\n      statusCode: 403,\r\n      headers: baseCorsHeaders(undefined),\r\n      body: JSON.stringify({ message: \"CORS: origin not allowed\" }),\r\n    };\r\n  }\r\n  return {\r\n    statusCode: status,\r\n    headers: baseCorsHeaders(origin),\r\n    body: JSON.stringify({ message: msg }),\r\n  };\r\n}\r\n/* ============================ end CORS helpers ============================ */\r\n\r\ntype AnyEvent = APIGatewayProxyEvent | APIGatewayProxyEventV2 | any;\r\n\r\nfunction getMethod(e: AnyEvent): string {\r\n  return (e as any).httpMethod ?? e.requestContext?.http?.method ?? \"GET\";\r\n}\r\n\r\nfunction getClaims(e: AnyEvent): Record<string, any> {\r\n  return (\r\n    (e as any).requestContext?.authorizer?.claims ??\r\n    (e as any).requestContext?.authorizer?.jwt?.claims ??\r\n    {}\r\n  );\r\n}\r\n\r\nexport const handler = async (\r\n  event: AnyEvent\r\n): Promise<APIGatewayProxyResult> => {\r\n  // CORS preflight\r\n  if (getMethod(event) === \"OPTIONS\") {\r\n    const origin = pickAllowedOrigin(event);\r\n    if (!origin && (event.headers?.origin || event.headers?.Origin)) {\r\n      return { statusCode: 403, headers: baseCorsHeaders(undefined), body: \"\" };\r\n    }\r\n    return { statusCode: 204, headers: baseCorsHeaders(origin), body: \"\" };\r\n  }\r\n\r\n  if (getMethod(event) !== \"POST\") {\r\n    return bad(event, 405, \"Method Not Allowed\");\r\n  }\r\n\r\n  try {\r\n    const claims = getClaims(event);\r\n    const sub = claims?.sub as string | undefined;\r\n\r\n    const body = JSON.parse((event as any).body || \"{}\");\r\n    const rawKey: string = String(body.key || \"\");\r\n    const contentType: string = String(\r\n      body.contentType || \"application/octet-stream\"\r\n    );\r\n\r\n    if (!sub) return bad(event, 401, \"Not authorized\");\r\n    if (!rawKey) return bad(event, 400, \"Missing 'key'\");\r\n\r\n    // sanitize and scope: users/<sub>/...\r\n    const safeKey = rawKey.replace(/\\.\\./g, \"\").replace(/^[/\\\\]+/, \"\");\r\n    const key = `users/${sub}/${safeKey}`;\r\n\r\n    const cmd = new PutObjectCommand({\r\n      Bucket: BUCKET,\r\n      Key: key,\r\n      ContentType: contentType,\r\n    });\r\n\r\n    const url = await getSignedUrl(s3, cmd, { expiresIn: 900 }); // 15 min\r\n    return ok(event, { key, url });\r\n  } catch (e: any) {\r\n    console.error(e);\r\n    return bad(event, 500, e?.message ?? String(e));\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["presign_exports", "__export", "handler", "__toCommonJS", "import_client_s3", "import_s3_request_presigner", "s3", "BUCKET", "ALLOWED_ORIGINS", "s", "FALLBACK_ORIGIN", "ALLOW_HEADERS", "pickAllowedOrigin", "event", "reqOrigin", "baseCorsHeaders", "origin", "h", "ok", "body", "extra", "bad", "status", "msg", "getMethod", "getClaims", "sub", "rawKey", "contentType", "safeKey", "key", "cmd", "url", "e"]
}
