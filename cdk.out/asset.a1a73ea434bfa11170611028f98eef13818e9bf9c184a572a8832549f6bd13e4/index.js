"use strict";var c=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var C=Object.prototype.hasOwnProperty;var P=(e,t)=>{for(var n in t)c(e,n,{get:t[n],enumerable:!0})},w=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of m(t))!C.call(e,o)&&o!==n&&c(e,o,{get:()=>t[o],enumerable:!(r=p(t,o))||r.enumerable});return e};var S=e=>w(c({},"__esModule",{value:!0}),e);var T={};P(T,{handler:()=>N});module.exports=S(T);var a=require("@aws-sdk/client-s3"),l=require("@aws-sdk/s3-request-presigner"),I=new a.S3Client({region:process.env.AWS_REGION||"us-east-1",forcePathStyle:!0}),E=process.env.BUCKET,d=String(process.env.ALLOWED_ORIGINS||"").split(",").map(e=>e.trim()).filter(Boolean),R=process.env.WEB_ORIGIN||"",G=["authorization","Authorization","Content-Type","X-Amz-Date","X-Api-Key","X-Amz-Security-Token"].join(",");function y(e){let t=e?.headers?.origin||e?.headers?.Origin||"";return d.length?d.includes(t)?t:void 0:R||void 0}function s(e){let t={"Content-Type":"application/json","Access-Control-Allow-Headers":G,"Access-Control-Allow-Methods":"POST,OPTIONS","Access-Control-Allow-Credentials":"true",Vary:"Origin"};return e&&(t["Access-Control-Allow-Origin"]=e),t}function b(e,t,n={}){let r=y(e);return{statusCode:200,headers:{...s(r),...n},body:JSON.stringify(t)}}function i(e,t,n){let r=y(e);return!!(e.headers?.origin||e.headers?.Origin)&&!r?{statusCode:403,headers:s(void 0),body:JSON.stringify({message:"CORS: origin not allowed"})}:{statusCode:t,headers:s(r),body:JSON.stringify({message:n})}}function g(e){return e.httpMethod??e.requestContext?.http?.method??"GET"}function x(e){return e.requestContext?.authorizer?.claims??e.requestContext?.authorizer?.jwt?.claims??{}}var N=async e=>{if(g(e)==="OPTIONS"){let t=y(e);return!t&&(e.headers?.origin||e.headers?.Origin)?{statusCode:403,headers:s(void 0),body:""}:{statusCode:204,headers:s(t),body:""}}if(g(e)!=="POST")return i(e,405,"Method Not Allowed");try{let n=x(e)?.sub,r=JSON.parse(e.body||"{}"),o=String(r.key||""),A=String(r.contentType||"application/octet-stream");if(!n)return i(e,401,"Not authorized");if(!o)return i(e,400,"Missing 'key'");let h=o.replace(/\.\./g,"").replace(/^[/\\]+/,""),u=`users/${n}/${h}`,f=new a.PutObjectCommand({Bucket:E,Key:u,ContentType:A}),O=await(0,l.getSignedUrl)(I,f,{expiresIn:900});return b(e,{key:u,url:O})}catch(t){return console.error(t),i(e,500,t?.message??String(t))}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
