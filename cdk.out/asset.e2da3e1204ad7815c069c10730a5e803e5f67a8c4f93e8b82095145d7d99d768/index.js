"use strict";var M=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var _=Object.prototype.hasOwnProperty;var I=(e,t)=>{for(var o in t)M(e,o,{get:t[o],enumerable:!0})},O=(e,t,o,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of E(t))!_.call(e,n)&&n!==o&&M(e,n,{get:()=>t[n],enumerable:!(a=b(t,n))||a.enumerable});return e};var v=e=>O(M({},"__esModule",{value:!0}),e);var g={};I(g,{handler:()=>f});module.exports=v(g);var C=require("@aws-sdk/client-dynamodb"),r=require("@aws-sdk/lib-dynamodb"),x=r.DynamoDBDocumentClient.from(new C.DynamoDBClient({})),d=process.env.TABLE_NAME,S=process.env.PK_NAME||"pk",P=process.env.SK_NAME||"sk";function N(){return new Date().toISOString()}var h={personality:30,nurture:30,authority:20,conversion:20},f=async e=>{let t=e?.creatorId||e?.creatorSub||e?.userId||e?.userSub;if(!t)throw new Error("creatorId is required");let o=`CREATOR#${t}`,a="GOAL_COMPASS",n=N(),k=await x.send(new r.GetCommand({TableName:d,Key:{[S]:o,[P]:a}}));if(!k.Item)return{ok:!1,reason:"NO_GOAL_COMPASS",creatorId:t};let c=k.Item,s={personality:c.contentMixTarget?.personality??h.personality,nurture:c.contentMixTarget?.nurture??h.nurture,authority:c.contentMixTarget?.authority??h.authority,conversion:c.contentMixTarget?.conversion??h.conversion},u=(i,m)=>{let A=Math.max(0,i-m),T=i+m;return Math.round(A+Math.random()*(T-A))},p={personality:u(s.personality,10),nurture:u(s.nurture,10),authority:u(s.authority,10),conversion:u(s.conversion,10)},l=i=>{let m=s[i]??0,A=p[i]??0;return Math.abs(A-m)},w=Math.max(l("personality"),l("nurture"),l("authority"),l("conversion")),y="ON_PATH";return w>25?y="OFF_PATH":w>15&&(y="SLIGHTLY_OFF"),await x.send(new r.UpdateCommand({TableName:d,Key:{[S]:o,[P]:a},UpdateExpression:"SET #contentMixActual = :contentMixActual, #weeklyPathStatus = :weeklyPathStatus, #lastWeeklyCheckAt = :now",ExpressionAttributeNames:{"#contentMixActual":"contentMixActual","#weeklyPathStatus":"weeklyPathStatus","#lastWeeklyCheckAt":"lastWeeklyCheckAt"},ExpressionAttributeValues:{":contentMixActual":p,":weeklyPathStatus":y,":now":n}})),{ok:!0,creatorId:t,contentMixActual:p,weeklyPathStatus:y,lastWeeklyCheckAt:n}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
