"use strict";var S=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var V=Object.prototype.hasOwnProperty;var _=(e,t)=>{for(var i in t)S(e,i,{get:t[i],enumerable:!0})},P=(e,t,i,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of R(t))!V.call(e,s)&&s!==i&&S(e,s,{get:()=>t[s],enumerable:!(n=K(t,s))||n.enumerable});return e};var D=e=>P(S({},"__esModule",{value:!0}),e);var Y={};_(Y,{handler:()=>X});module.exports=D(Y);var r=require("@aws-sdk/client-dynamodb"),f=require("@aws-sdk/client-sfn"),o=require("@aws-sdk/util-dynamodb"),T=require("crypto"),d=process.env.TABLE_NAME,M=process.env.APPROVAL_SM_ARN,te=process.env.STATUS_GSI??"gsi1",l=new r.DynamoDBClient({}),U=new f.SFNClient({});function g(){return new Date().toISOString()}function p(e){return`USER#${e}`}function w(e){return`CLOSET#${e}`}function h(e){return`CLOSET#${e}`}function N(e){return`CLOSET#STATUS#${e}`}function I(e){let t=(0,o.unmarshall)(e);return{id:t.id,userId:t.userId,ownerSub:t.ownerSub,status:t.status,createdAt:t.createdAt,updatedAt:t.updatedAt,mediaKey:t.mediaKey,rawMediaKey:t.rawMediaKey,title:t.title,reason:t.reason,audience:t.audience,category:t.category,subcategory:t.subcategory,storyTitle:t.storyTitle,storySeason:t.storySeason,storyVibes:t.storyVibes,pinned:t.pinned,favoriteCount:t.favoriteCount,likeCount:t.likeCount,commentCount:t.commentCount,wishlistCount:t.wishlistCount,viewerHasFaved:t.viewerHasFaved,viewerHasLiked:t.viewerHasLiked,viewerHasWishlisted:t.viewerHasWishlisted}}function C(e){if(!e?.sub)throw new Error("Not authenticated");return e.sub}async function H(e){let t=C(e);return((await l.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":p(t),":sk":"CLOSET#"})}))).Items??[]).map(I)}async function O(e,t){let i=C(t),n=(0,T.randomUUID)(),s=g(),a={id:n,userId:i,ownerSub:i,status:"DRAFT",createdAt:s,updatedAt:s,mediaKey:e.mediaKey,rawMediaKey:e.rawMediaKey,title:e.title,category:e.category??null,subcategory:e.subcategory??null};return await l.send(new r.PutItemCommand({TableName:d,Item:(0,o.marshall)({pk:p(i),sk:w(n),gsi1pk:N(a.status),gsi1sk:s,rawMediaKey:a.rawMediaKey,...a})})),a}async function W(e,t){let i=C(t),n=g(),s=await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(i),sk:w(e.id)}),UpdateExpression:"SET mediaKey = :mediaKey, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,o.marshall)({":mediaKey":e.mediaKey,":updatedAt":n,":gsi1pk":N("DRAFT"),":gsi1sk":n}),ReturnValues:"ALL_NEW"}));if(!s.Attributes)throw new Error("Item not found");return I(s.Attributes)}async function F(e,t){let i=C(t),n=g(),s=await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(i),sk:w(e.id)}),ConditionExpression:"status = :draft",UpdateExpression:"SET status = :pending, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,o.marshall)({":draft":"DRAFT",":pending":"PENDING",":updatedAt":n,":gsi1pk":N("PENDING"),":gsi1sk":n}),ReturnValues:"ALL_NEW"}));if(!s.Attributes)throw new Error("Item not found or not in DRAFT status");let a=I(s.Attributes);return await U.send(new f.StartExecutionCommand({stateMachineArn:M,input:JSON.stringify({itemId:a.id,userId:a.userId,ownerSub:a.ownerSub})})),a.id}async function z(e,t){let i=C(t),{id:n,storyTitle:s,storySeason:a,storyVibes:c}=e.input,m=g(),u=["updatedAt = :updatedAt"],y={":updatedAt":m};s!==void 0&&(u.push("storyTitle = :storyTitle"),y[":storyTitle"]=s),a!==void 0&&(u.push("storySeason = :storySeason"),y[":storySeason"]=a),c!==void 0&&(u.push("storyVibes = :storyVibes"),y[":storyVibes"]=c?.filter(E=>!!E));let k=await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(i),sk:w(n)}),UpdateExpression:"SET "+u.join(", "),ExpressionAttributeValues:(0,o.marshall)(y),ReturnValues:"ALL_NEW"}));if(!k.Attributes)throw new Error("Item not found");return I(k.Attributes)}async function v(e,t){let i=C(t),{ownerId:n,closetItemId:s}=e.input,a=g(),c={pk:h(s),sk:`LIKE#${i}`,entityType:"LIKE",itemOwnerSub:n,likerSub:i,createdAt:a};try{await l.send(new r.PutItemCommand({TableName:d,Item:(0,o.marshall)(c),ConditionExpression:"attribute_not_exists(pk)"}))}catch(y){if(y?.name!=="ConditionalCheckFailedException")throw y}let m=await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(n),sk:w(s)}),UpdateExpression:"SET likeCount = if_not_exists(likeCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":a}),ReturnValues:"ALL_NEW"}));if(!m.Attributes)throw new Error("Closet item not found");let u=I(m.Attributes);return u.viewerHasLiked=!0,u}async function B(e,t){let i=C(t),{ownerId:n,closetItemId:s,text:a}=e.input,c=g(),m=(0,T.randomUUID)(),u={pk:h(s),sk:`COMMENT#${m}`,entityType:"COMMENT",closetItemId:s,itemOwnerSub:n,authorSub:i,text:a,createdAt:c};return await l.send(new r.PutItemCommand({TableName:d,Item:(0,o.marshall)(u)})),await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(n),sk:w(s)}),UpdateExpression:"SET commentCount = if_not_exists(commentCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":c})})),{id:m,closetItemId:s,authorSub:i,text:a,createdAt:c}}async function $(e,t){let i=C(t),{ownerId:n,closetItemId:s,pinned:a}=e.input;if(i!==n)throw new Error("Not authorized to pin this closet item.");let c=g(),m=await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(n),sk:w(s)}),UpdateExpression:"SET pinned = :pinned, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":pinned":!!a,":now":c}),ReturnValues:"ALL_NEW"}));if(!m.Attributes)throw new Error("Closet item not found");return I(m.Attributes)}async function L(e){let{closetItemId:t}=e;return((await l.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":h(t),":sk":"COMMENT#"})}))).Items??[]).map(s=>(0,o.unmarshall)(s)).map(s=>({id:s.sk.replace("COMMENT#",""),closetItemId:s.closetItemId,authorSub:s.authorSub,text:s.text,createdAt:s.createdAt}))}async function G(e){let{closetItemId:t}=e;return((await l.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":h(t),":sk":"LIKE#"})}))).Items??[]).map(s=>(0,o.unmarshall)(s)).map(s=>({closetItemId:t,likerSub:s.likerSub,createdAt:s.createdAt}))}async function q(e){return L(e)}async function J(e,t){let i=C(t),{ownerId:n,closetItemId:s,on:a}=e.input,c=g(),m=p(i),u=`WISHLIST#${s}`;if(a===!1){await l.send(new r.DeleteItemCommand({TableName:d,Key:(0,o.marshall)({pk:m,sk:u})}));let b;try{let A=await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(n),sk:w(s)}),UpdateExpression:"SET wishlistCount = if_not_exists(wishlistCount, :zero) - :one, updatedAt = :now",ConditionExpression:"wishlistCount >= :one",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":c}),ReturnValues:"ALL_NEW"}));A.Attributes&&(b=I(A.Attributes))}catch(A){if(A?.name!=="ConditionalCheckFailedException")throw A;let x=((await l.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND sk = :sk",ExpressionAttributeValues:(0,o.marshall)({":pk":p(n),":sk":w(s)})}))).Items??[])[0];x&&(b=I(x))}if(!b)throw new Error("Closet item not found");return b.viewerHasWishlisted=!1,b}let y={pk:m,sk:u,entityType:"WISHLIST",closetItemId:s,ownerSub:n,ownerSub,ownerId:n,viewerSub:i,createdAt:c};try{await l.send(new r.PutItemCommand({TableName:d,Item:(0,o.marshall)(y),ConditionExpression:"attribute_not_exists(pk)"}))}catch(b){if(b?.name!=="ConditionalCheckFailedException")throw b}let k=await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(n),sk:w(s)}),UpdateExpression:"SET wishlistCount = if_not_exists(wishlistCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":c}),ReturnValues:"ALL_NEW"}));if(!k.Attributes)throw new Error("Closet item not found");let E=I(k.Attributes);return E.viewerHasWishlisted=!0,E}async function j(e){let t=C(e),n=((await l.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":p(t),":sk":"WISHLIST#"})}))).Items??[]).map(u=>(0,o.unmarshall)(u));if(!n.length)return[];let s=n.map(u=>({pk:p(u.ownerSub),sk:w(u.closetItemId)})),m=((await l.send(new r.BatchGetItemCommand({RequestItems:{[d]:{Keys:s.map(u=>(0,o.marshall)(u))}}}))).Responses?.[d]??[]).map(I);for(let u of m)u.viewerHasWishlisted=!0;return m}async function Q(e){let t=e.source||{},i=e.identity||{},n=t.userId||t.id||i.sub;if(!n)throw new Error("Cannot resolve pinnedClosetItems: missing userId");return((await l.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",FilterExpression:"#pinned = :true AND #status = :published",ExpressionAttributeNames:{"#pinned":"pinned","#status":"status"},ExpressionAttributeValues:(0,o.marshall)({":pk":p(n),":sk":"CLOSET#",":true":!0,":published":"PUBLISHED"})}))).Items??[]).map(I)}var X=async e=>{console.log("ClosetResolverFn event",JSON.stringify(e));let t=e.info?.fieldName;try{switch(t){case"myCloset":return await H(e.identity);case"myWishlist":return await j(e.identity);case"createClosetItem":return await O(e.arguments,e.identity);case"updateClosetMediaKey":return await W(e.arguments,e.identity);case"requestClosetApproval":return await F(e.arguments,e.identity);case"updateClosetItemStory":return await z(e.arguments,e.identity);case"likeClosetItem":return await v(e.arguments,e.identity);case"commentOnClosetItem":return await B(e.arguments,e.identity);case"pinHighlight":return await $(e.arguments,e.identity);case"closetItemComments":return await L(e.arguments);case"adminClosetItemLikes":return await G(e.arguments);case"adminClosetItemComments":return await q(e.arguments);case"toggleWishlistItem":return await J(e.arguments,e.identity);case"pinnedClosetItems":return await Q(e);default:throw new Error(`Unsupported field: ${t}`)}}catch(i){throw console.error("Error in ClosetResolverFn",i),i}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
