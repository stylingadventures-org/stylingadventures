"use strict";var S=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var V=Object.prototype.hasOwnProperty;var _=(e,t)=>{for(var n in t)S(e,n,{get:t[n],enumerable:!0})},P=(e,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of K(t))!V.call(e,s)&&s!==n&&S(e,s,{get:()=>t[s],enumerable:!(i=R(t,s))||i.enumerable});return e};var D=e=>P(S({},"__esModule",{value:!0}),e);var Z={};_(Z,{handler:()=>Y});module.exports=D(Z);var r=require("@aws-sdk/client-dynamodb"),f=require("@aws-sdk/client-sfn"),o=require("@aws-sdk/util-dynamodb"),T=require("crypto"),d=process.env.TABLE_NAME,U=process.env.APPROVAL_SM_ARN,se=process.env.STATUS_GSI??"gsi1",l=new r.DynamoDBClient({}),M=new f.SFNClient({});function b(){return new Date().toISOString()}function c(e){return`USER#${e}`}function I(e){return`CLOSET#${e}`}function h(e){return`CLOSET#${e}`}function N(e){return`CLOSET#STATUS#${e}`}function y(e){let t=(0,o.unmarshall)(e),n=t.userId??t.ownerSub??(typeof t.pk=="string"&&t.pk.startsWith("USER#")?t.pk.slice(5):""),i=t.ownerSub??t.userId??(typeof t.pk=="string"&&t.pk.startsWith("USER#")?t.pk.slice(5):"");return{id:t.id,userId:n,ownerSub:i,status:t.status,createdAt:t.createdAt,updatedAt:t.updatedAt,mediaKey:t.mediaKey,rawMediaKey:t.rawMediaKey,title:t.title,reason:t.reason,audience:t.audience,category:t.category,subcategory:t.subcategory,storyTitle:t.storyTitle,storySeason:t.storySeason,storyVibes:t.storyVibes,pinned:t.pinned,favoriteCount:t.favoriteCount,likeCount:t.likeCount,commentCount:t.commentCount,wishlistCount:t.wishlistCount,viewerHasFaved:t.viewerHasFaved,viewerHasLiked:t.viewerHasLiked,viewerHasWishlisted:t.viewerHasWishlisted}}function C(e){if(!e?.sub)throw new Error("Not authenticated");return e.sub}function O(e){let n=(e?.claims||{})["cognito:groups"],i=Array.isArray(n)?n:String(n||"").split(",").map(s=>s.trim()).filter(Boolean);return i.includes("ADMIN")||i.includes("COLLAB")}async function W(e){let t=C(e);return((await l.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":c(t),":sk":"CLOSET#"})}))).Items??[]).map(y)}async function H(e,t){let n=C(t),i=(0,T.randomUUID)(),s=b(),a={id:i,userId:n,ownerSub:n,status:"DRAFT",createdAt:s,updatedAt:s,mediaKey:e.mediaKey,rawMediaKey:e.rawMediaKey,title:e.title,category:e.category??null,subcategory:e.subcategory??null};return await l.send(new r.PutItemCommand({TableName:d,Item:(0,o.marshall)({pk:c(n),sk:I(i),gsi1pk:N(a.status),gsi1sk:s,rawMediaKey:a.rawMediaKey,...a})})),a}async function F(e,t){let n=C(t),i=b(),s=await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:c(n),sk:I(e.id)}),UpdateExpression:"SET mediaKey = :mediaKey, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,o.marshall)({":mediaKey":e.mediaKey,":updatedAt":i,":gsi1pk":N("DRAFT"),":gsi1sk":i}),ReturnValues:"ALL_NEW"}));if(!s.Attributes)throw new Error("Item not found");return y(s.Attributes)}async function B(e,t){let n=C(t),i=b(),s=await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:c(n),sk:I(e.id)}),ConditionExpression:"status = :draft",UpdateExpression:"SET status = :pending, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,o.marshall)({":draft":"DRAFT",":pending":"PENDING",":updatedAt":i,":gsi1pk":N("PENDING"),":gsi1sk":i}),ReturnValues:"ALL_NEW"}));if(!s.Attributes)throw new Error("Item not found or not in DRAFT status");let a=y(s.Attributes);return await M.send(new f.StartExecutionCommand({stateMachineArn:U,input:JSON.stringify({itemId:a.id,userId:a.userId,ownerSub:a.ownerSub})})),a.id}async function z(e,t){let n=C(t),{id:i,storyTitle:s,storySeason:a,storyVibes:m}=e.input,p=b(),u=["updatedAt = :updatedAt"],w={":updatedAt":p};s!==void 0&&(u.push("storyTitle = :storyTitle"),w[":storyTitle"]=s),a!==void 0&&(u.push("storySeason = :storySeason"),w[":storySeason"]=a),m!==void 0&&(u.push("storyVibes = :storyVibes"),w[":storyVibes"]=m?.filter(A=>!!A));let k=await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:c(n),sk:I(i)}),UpdateExpression:"SET "+u.join(", "),ExpressionAttributeValues:(0,o.marshall)(w),ReturnValues:"ALL_NEW"}));if(!k.Attributes)throw new Error("Item not found");return y(k.Attributes)}async function v(e,t){let n=C(t),{ownerId:i,closetItemId:s}=e.input,a=b(),m={pk:h(s),sk:`LIKE#${n}`,entityType:"LIKE",itemOwnerSub:i,likerSub:n,createdAt:a};try{await l.send(new r.PutItemCommand({TableName:d,Item:(0,o.marshall)(m),ConditionExpression:"attribute_not_exists(pk)"}))}catch(w){if(w?.name!=="ConditionalCheckFailedException")throw w}let p=await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:c(i),sk:I(s)}),UpdateExpression:"SET likeCount = if_not_exists(likeCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":a}),ReturnValues:"ALL_NEW"}));if(!p.Attributes)throw new Error("Closet item not found");let u=y(p.Attributes);return u.viewerHasLiked=!0,u}async function $(e,t){let n=C(t),{ownerId:i,closetItemId:s,text:a}=e.input,m=b(),p=(0,T.randomUUID)(),u={pk:h(s),sk:`COMMENT#${p}`,entityType:"COMMENT",closetItemId:s,itemOwnerSub:i,authorSub:n,text:a,createdAt:m};return await l.send(new r.PutItemCommand({TableName:d,Item:(0,o.marshall)(u)})),await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:c(i),sk:I(s)}),UpdateExpression:"SET commentCount = if_not_exists(commentCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":m})})),{id:p,closetItemId:s,authorSub:n,text:a,createdAt:m}}async function G(e,t){let n=C(t),i=O(t),s=e.input||e,a=s.closetItemId,m=!!s.pinned;if(!a)throw new Error("closetItemId is required");let u=((await l.send(new r.ScanCommand({TableName:d,FilterExpression:"sk = :sk",ExpressionAttributeValues:(0,o.marshall)({":sk":I(a)})}))).Items??[])[0];if(!u)throw new Error("Closet item not found");let w=y(u);if(!i&&w.userId!==n)throw new Error("Not authorized to pin this closet item.");let k=b(),A=await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:c(w.userId),sk:I(w.id)}),UpdateExpression:"SET pinned = :pinned, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":pinned":m,":now":k}),ReturnValues:"ALL_NEW"}));if(!A.Attributes)throw new Error("Closet item not found after update");return y(A.Attributes)}async function L(e){let{closetItemId:t}=e;return((await l.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":h(t),":sk":"COMMENT#"})}))).Items??[]).map(s=>(0,o.unmarshall)(s)).map(s=>({id:s.sk.replace("COMMENT#",""),closetItemId:s.closetItemId,authorSub:s.authorSub,text:s.text,createdAt:s.createdAt}))}async function q(e){let{closetItemId:t}=e;return((await l.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":h(t),":sk":"LIKE#"})}))).Items??[]).map(s=>(0,o.unmarshall)(s)).map(s=>({closetItemId:t,likerSub:s.likerSub,createdAt:s.createdAt}))}async function J(e){return L(e)}async function j(e,t){let n=C(t),{ownerId:i,closetItemId:s,on:a}=e.input,m=b(),p=c(n),u=`WISHLIST#${s}`;if(a===!1){await l.send(new r.DeleteItemCommand({TableName:d,Key:(0,o.marshall)({pk:p,sk:u})}));let g;try{let E=await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:c(i),sk:I(s)}),UpdateExpression:"SET wishlistCount = if_not_exists(wishlistCount, :zero) - :one, updatedAt = :now",ConditionExpression:"wishlistCount >= :one",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":m}),ReturnValues:"ALL_NEW"}));E.Attributes&&(g=y(E.Attributes))}catch(E){if(E?.name!=="ConditionalCheckFailedException")throw E;let x=((await l.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND sk = :sk",ExpressionAttributeValues:(0,o.marshall)({":pk":c(i),":sk":I(s)})}))).Items??[])[0];x&&(g=y(x))}if(!g)throw new Error("Closet item not found");return g.viewerHasWishlisted=!1,g}let w={pk:p,sk:u,entityType:"WISHLIST",closetItemId:s,ownerSub:i,viewerSub:n,createdAt:m};try{await l.send(new r.PutItemCommand({TableName:d,Item:(0,o.marshall)(w),ConditionExpression:"attribute_not_exists(pk)"}))}catch(g){if(g?.name!=="ConditionalCheckFailedException")throw g}let k=await l.send(new r.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:c(i),sk:I(s)}),UpdateExpression:"SET wishlistCount = if_not_exists(wishlistCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":m}),ReturnValues:"ALL_NEW"}));if(!k.Attributes)throw new Error("Closet item not found");let A=y(k.Attributes);return A.viewerHasWishlisted=!0,A}async function Q(e){let t=C(e),i=((await l.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":c(t),":sk":"WISHLIST#"})}))).Items??[]).map(u=>(0,o.unmarshall)(u));if(!i.length)return[];let s=i.map(u=>({pk:c(u.ownerSub),sk:I(u.closetItemId)})),p=((await l.send(new r.BatchGetItemCommand({RequestItems:{[d]:{Keys:s.map(u=>(0,o.marshall)(u))}}}))).Responses?.[d]??[]).map(y);for(let u of p)u.viewerHasWishlisted=!0;return p}async function X(e){let t=e.source||{},n=e.identity||{},i=t.userId||t.id||n.sub;if(!i)throw new Error("Cannot resolve pinnedClosetItems: missing userId");return((await l.send(new r.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",FilterExpression:"#pinned = :true AND #status = :published",ExpressionAttributeNames:{"#pinned":"pinned","#status":"status"},ExpressionAttributeValues:(0,o.marshall)({":pk":c(i),":sk":"CLOSET#",":true":!0,":published":"PUBLISHED"})}))).Items??[]).map(y)}var Y=async e=>{console.log("ClosetResolverFn event",JSON.stringify(e));let t=e.info?.fieldName;try{switch(t){case"myCloset":return await W(e.identity);case"myWishlist":return await Q(e.identity);case"createClosetItem":return await H(e.arguments,e.identity);case"updateClosetMediaKey":return await F(e.arguments,e.identity);case"requestClosetApproval":return await B(e.arguments,e.identity);case"updateClosetItemStory":return await z(e.arguments,e.identity);case"likeClosetItem":return await v(e.arguments,e.identity);case"commentOnClosetItem":return await $(e.arguments,e.identity);case"pinHighlight":return await G(e.arguments,e.identity);case"closetItemComments":return await L(e.arguments);case"adminClosetItemLikes":return await q(e.arguments);case"adminClosetItemComments":return await J(e.arguments);case"toggleWishlistItem":return await j(e.arguments,e.identity);case"pinnedClosetItems":return await X(e);default:throw new Error(`Unsupported field: ${t}`)}}catch(n){throw console.error("Error in ClosetResolverFn",n),n}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
