"use strict";var I=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var $=Object.prototype.hasOwnProperty;var B=(e,s)=>{for(var r in s)I(e,r,{get:s[r],enumerable:!0})},_=(e,s,r,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let o of R(s))!$.call(e,o)&&o!==r&&I(e,o,{get:()=>s[o],enumerable:!(t=F(s,o))||t.enumerable});return e};var j=e=>_(I({},"__esModule",{value:!0}),e);var G={};B(G,{adminApproveItem:()=>L,adminCreateClosetItem:()=>K,adminListClosetItems:()=>v,adminListPending:()=>k,adminRejectItem:()=>M,adminSetClosetAudience:()=>O,adminUpdateClosetItem:()=>P,closetFeed:()=>S,handler:()=>J,toggleFavoriteClosetItem:()=>D,topClosetLooks:()=>h});module.exports=j(G);var d=require("@aws-sdk/client-dynamodb"),A=require("@aws-sdk/client-sfn"),m=new d.DynamoDBClient({}),x=new A.SFNClient({}),{TABLE_NAME:l=""}=process.env;if(!l)throw new Error("Missing env: TABLE_NAME");var b=()=>new Date().toISOString(),n=e=>({S:e});function y(e){let s=e.identity?.claims||{},r=e.identity?.sub||s.sub,t=s["cognito:groups"],o=Array.isArray(t)?t:String(t||"").split(",").map(a=>a.trim()).filter(Boolean),i=o.includes("ADMIN")||o.includes("COLLAB");if(!r)throw new Error("Unauthorized");return{sub:r,isAdmin:i}}function g(e,s){let r=e.favoriteCount?.N,t=typeof r=="string"?Number(r):0,o=e.pinned,i=typeof o?.BOOL=="boolean"?o.BOOL:void 0;return{id:e.id.S,userId:e.ownerSub.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",rawMediaKey:e.rawMediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??"",season:e.season?.S??null,vibes:e.vibes?.S??null,audience:e.audience?.S??null,category:e.category?.S??null,subcategory:e.subcategory?.S??null,pinned:i,favoriteCount:t,viewerHasFaved:!1,...s}}function q(){return globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`}function N(e){return e?Buffer.from(JSON.stringify(e),"utf8").toString("base64"):null}function H(e){if(e)try{return JSON.parse(Buffer.from(String(e),"base64").toString("utf8"))}catch{return}}var k=async e=>{let{isAdmin:s}=y(e);if(!s)throw new Error("Forbidden");return((await m.send(new d.QueryCommand({TableName:l,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(t=>g({...t,status:t.status}))},v=async e=>{let{isAdmin:s}=y(e);if(!s)throw new Error("Forbidden");let{status:r,limit:t=50,nextToken:o}=e.arguments||{},i=H(o);if(r){let c=await m.send(new d.QueryCommand({TableName:l,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n(`STATUS#${r}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned",ExpressionAttributeNames:{"#s":"status"},Limit:t,ExclusiveStartKey:i}));return{items:(c.Items||[]).map(p=>g({...p,status:p.status})),nextToken:N(c.LastEvaluatedKey)}}let a=await m.send(new d.ScanCommand({TableName:l,FilterExpression:"begins_with(pk, :p)",ExpressionAttributeValues:{":p":n("ITEM#")},ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned",ExpressionAttributeNames:{"#s":"status"},Limit:t,ExclusiveStartKey:i})),u=(a.Items||[]).map(c=>g({...c,status:c.status}));return u.sort((c,E)=>new Date(E.createdAt||0).getTime()-new Date(c.createdAt||0).getTime()),{items:u,nextToken:N(a.LastEvaluatedKey)}},S=async e=>{let{sub:s}=y(e),{sort:r="NEWEST"}=e.arguments||{},[t,o]=await Promise.all([m.send(new d.QueryCommand({TableName:l,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n("STATUS#PUBLISHED")},ScanIndexForward:r==="NEWEST",ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, audience, favoriteCount, category, subcategory, season, vibes, pinned",ExpressionAttributeNames:{"#s":"status"}})),m.send(new d.QueryCommand({TableName:l,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:{":pk":n(`FAV#${s}`),":sk":n("CLOSET#")}}))]),i=new Set((o.Items||[]).map(u=>{let c=u.sk?.S??"";return c.startsWith("CLOSET#")?c.substring(7):u.closetId?.S??""})),a=(t.Items||[]).map(u=>g({...u,status:u.status},{viewerHasFaved:i.has(u.id.S)}));return r==="MOST_LOVED"&&a.sort((u,c)=>{let E=u.favoriteCount??0,p=c.favoriteCount??0;return p!==E?p-E:new Date(c.createdAt||0).getTime()-new Date(u.createdAt||0).getTime()}),a},h=async e=>S({...e,arguments:{sort:"NEWEST"}}),K=async e=>{let{sub:s,isAdmin:r}=y(e);if(!r)throw new Error("Forbidden");let t=e.arguments?.input||{};if(!t.title?.trim())throw new Error("title is required");let o=t.rawMediaKey||t.mediaKey;if(!o)throw new Error("rawMediaKey is required");let i=q(),a=b();return await m.send(new d.PutItemCommand({TableName:l,Item:{pk:n(`ITEM#${i}`),sk:n("META"),id:n(i),ownerSub:n(s),gsi2pk:n("STATUS#PENDING"),gsi2sk:n(a),status:n("PENDING"),createdAt:n(a),updatedAt:n(a),title:n(t.title.trim()),rawMediaKey:n(o),favoriteCount:{N:"0"},...t.season?{season:n(t.season)}:{},...t.vibes?{vibes:n(t.vibes)}:{},...t.category?{category:n(t.category)}:{},...t.subcategory?{subcategory:n(t.subcategory)}:{},...t.audience?{audience:n(t.audience)}:{},...t.description?{description:n(t.description)}:{},...t.story?{story:n(t.story)}:{}}})),{id:i,userId:s,ownerSub:s,status:"PENDING",createdAt:a,updatedAt:a,title:t.title.trim(),mediaKey:"",rawMediaKey:o,reason:"",season:t.season??null,vibes:t.vibes??null,audience:t.audience??null,category:t.category??null,subcategory:t.subcategory??null,favoriteCount:0,viewerHasFaved:!1}},L=async e=>{let{isAdmin:s}=y(e);if(!s)throw new Error("Forbidden");let r=e.arguments?.closetItemId;if(!r)throw new Error("closetItemId required");let t=b(),i=(await m.send(new d.UpdateItemCommand({TableName:l,Key:{pk:n(`ITEM#${r}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("APPROVED"),":u":n(t),":g2pk":n("STATUS#APPROVED"),":g2sk":n(t)},ReturnValues:"ALL_OLD"}))).Attributes,a=i.approvalToken?.S;if(a)try{await x.send(new A.SendTaskSuccessCommand({taskToken:a,output:JSON.stringify({approved:!0})}))}catch{}return g({...i,status:n("APPROVED")})},M=async e=>{let{isAdmin:s}=y(e);if(!s)throw new Error("Forbidden");let r=e.arguments?.closetItemId,t=e.arguments?.reason||"";if(!r)throw new Error("closetItemId required");let o=b(),a=(await m.send(new d.UpdateItemCommand({TableName:l,Key:{pk:n(`ITEM#${r}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("REJECTED"),":u":n(o),":g2pk":n("STATUS#REJECTED"),":g2sk":n(o),":r":n(t)},ReturnValues:"ALL_OLD"}))).Attributes,u=a.approvalToken?.S;if(u)try{await x.send(new A.SendTaskFailureCommand({taskToken:u,error:"Rejected",cause:t||"Rejected by admin"}))}catch{}return g({...a,status:n("REJECTED"),reason:n(t)})},P=async e=>{let{isAdmin:s}=y(e);if(!s)throw new Error("Forbidden");let r=e.arguments?.closetItemId,t=e.arguments?.input||{};if(!r)throw new Error("closetItemId required");let o=b(),i=["#updatedAt = :u"],a={"#updatedAt":"updatedAt"},u={":u":n(o)};if(t.title!==void 0&&(i.push("#title = :title"),a["#title"]="title",u[":title"]=t.title===null?{NULL:!0}:n(t.title)),t.category!==void 0&&(i.push("#category = :category"),a["#category"]="category",u[":category"]=t.category===null?{NULL:!0}:n(t.category)),t.subcategory!==void 0&&(i.push("#subcategory = :subcategory"),a["#subcategory"]="subcategory",u[":subcategory"]=t.subcategory===null?{NULL:!0}:n(t.subcategory)),t.audience!==void 0&&(i.push("audience = :audience"),u[":audience"]=t.audience===null?{NULL:!0}:n(t.audience)),i.length===1)throw new Error("No fields provided to update");let c=await m.send(new d.UpdateItemCommand({TableName:l,Key:{pk:n(`ITEM#${r}`),sk:n("META")},UpdateExpression:`SET ${i.join(", ")}`,ExpressionAttributeNames:a,ExpressionAttributeValues:u,ReturnValues:"ALL_NEW"}));if(!c.Attributes)throw new Error("Closet item not found");return g(c.Attributes)},O=async e=>{let{isAdmin:s}=y(e);if(!s)throw new Error("Forbidden");let r=e.arguments?.closetItemId,t=e.arguments?.audience;if(!r)throw new Error("closetItemId required");if(!t)throw new Error("audience required");let o=b(),i=await m.send(new d.UpdateItemCommand({TableName:l,Key:{pk:n(`ITEM#${r}`),sk:n("META")},UpdateExpression:"SET audience = :aud, updatedAt = :u",ExpressionAttributeValues:{":aud":n(t),":u":n(o)},ReturnValues:"ALL_NEW"}));if(!i.Attributes)throw new Error("Closet item not found");return g(i.Attributes)},D=async e=>{let{sub:s}=y(e),r=e.arguments?.id,t=e.arguments?.favoriteOn,o=e.arguments?.on,i=typeof t=="boolean"?t:o;if(!r)throw new Error("id required");let u=(await m.send(new d.GetItemCommand({TableName:l,Key:{pk:n(`ITEM#${r}`),sk:n("META")}}))).Item;if(!u)throw new Error("Closet item not found");let c={pk:n(`FAV#${s}`),sk:n(`CLOSET#${r}`)},p=!!(await m.send(new d.GetItemCommand({TableName:l,Key:c}))).Item,w=typeof i=="boolean"?i:!p,C=b(),f=0;w&&!p?(f=1,await m.send(new d.PutItemCommand({TableName:l,Item:{...c,userSub:n(s),closetId:n(r),createdAt:n(C)}}))):!w&&p&&(f=-1,await m.send(new d.DeleteItemCommand({TableName:l,Key:c}))),f!==0&&await m.send(new d.UpdateItemCommand({TableName:l,Key:{pk:n(`ITEM#${r}`),sk:n("META")},UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) + :delta, updatedAt = :u",ExpressionAttributeValues:{":zero":{N:"0"},":delta":{N:String(f)},":u":n(C)}}));let T=u.favoriteCount?.N,V=typeof T=="string"?Number(T):0,U=Math.max(0,V+f);return g(u,{favoriteCount:U,viewerHasFaved:w})},J=async e=>{let s=e.info.fieldName;if(s==="adminListPending")return k(e);if(s==="adminListClosetItems")return v(e);if(s==="adminCreateClosetItem")return K(e);if(s==="adminApproveItem")return L(e);if(s==="adminRejectItem")return M(e);if(s==="adminSetClosetAudience")return O(e);if(s==="adminUpdateClosetItem")return P(e);if(s==="closetFeed")return S(e);if(s==="topClosetLooks")return h(e);if(s==="toggleFavoriteClosetItem")return D(e);throw new Error(`No resolver implemented for field ${s}`)};0&&(module.exports={adminApproveItem,adminCreateClosetItem,adminListClosetItems,adminListPending,adminRejectItem,adminSetClosetAudience,adminUpdateClosetItem,closetFeed,handler,toggleFavoriteClosetItem,topClosetLooks});
//# sourceMappingURL=index.js.map
