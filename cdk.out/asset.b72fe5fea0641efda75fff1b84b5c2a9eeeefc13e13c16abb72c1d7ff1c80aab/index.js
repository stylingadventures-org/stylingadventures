"use strict";var c=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var f=Object.prototype.hasOwnProperty;var v=(e,t)=>{for(var s in t)c(e,s,{get:t[s],enumerable:!0})},x=(e,t,s,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of y(t))!f.call(e,i)&&i!==s&&c(e,i,{get:()=>t[i],enumerable:!(n=A(t,i))||n.enumerable});return e};var N=e=>x(c({},"__esModule",{value:!0}),e);var P={};v(P,{handler:()=>T});module.exports=N(P);var g=require("@aws-sdk/client-dynamodb"),r=require("@aws-sdk/lib-dynamodb");var a=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!a)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var d=r.DynamoDBDocumentClient.from(new g.DynamoDBClient({})),E=e=>`USER#${e}`,p="PROFILE";async function m(e){let t=E(e),{Item:s}=await d.send(new r.GetCommand({TableName:a,Key:{pk:t,sk:p}}));if(!s){let n=Date.now();return await d.send(new r.UpdateCommand({TableName:a,Key:{pk:t,sk:p},UpdateExpression:"SET #uid=:uid, #lvl=:lvl, #xp=:xp, #coins=:coins, #badges=:badges, #ts=:ts",ExpressionAttributeNames:{"#uid":"userId","#lvl":"level","#xp":"xp","#coins":"coins","#badges":"badges","#ts":"lastEventAt"},ExpressionAttributeValues:{":uid":e,":lvl":1,":xp":0,":coins":0,":badges":[],":ts":n}})),{userId:e,level:1,xp:0,coins:0,badges:[],lastEventAt:n}}return s.userId||await d.send(new r.UpdateCommand({TableName:a,Key:{pk:t,sk:p},UpdateExpression:"SET #uid = if_not_exists(#uid, :uid)",ExpressionAttributeNames:{"#uid":"userId"},ExpressionAttributeValues:{":uid":e}})),{userId:s.userId??e,level:s.level??1,xp:s.xp??0,coins:s.coins??0,badges:Array.isArray(s.badges)?s.badges:[],displayName:s.displayName??null,avatarUrl:s.avatarUrl??null,bio:s.bio??null,lastEventAt:s.lastEventAt??null,streakCount:s.streakCount??null,lastLoginAt:s.lastLoginAt??null}}async function w(e,t){let s=E(e),n=(t??"").trim().slice(0,40),i=Date.now();return await d.send(new r.UpdateCommand({TableName:a,Key:{pk:s,sk:p},UpdateExpression:"SET #dn=:dn, #ts=:ts ADD #lvl :zero, #xp :zero, #coins :zero",ExpressionAttributeNames:{"#dn":"displayName","#ts":"lastEventAt","#lvl":"level","#xp":"xp","#coins":"coins"},ExpressionAttributeValues:{":dn":n,":ts":i,":zero":0}})),m(e)}var T=async e=>{let t=e.identity?.sub;if(!t)throw new Error("Unauthorized: missing sub");switch(e.info.fieldName){case"getMyProfile":return m(t);case"setDisplayName":return w(t,e.arguments.displayName);case"updateProfile":{let{displayName:s,avatarUrl:n,bio:i}=e.arguments.input||{},b=E(t),l={},u={},o=[];return typeof s=="string"&&(l["#dn"]="displayName",u[":dn"]=s.trim().slice(0,40),o.push("#dn = :dn")),typeof n=="string"&&(l["#av"]="avatarUrl",u[":av"]=n,o.push("#av = :av")),typeof i=="string"&&(l["#bio"]="bio",u[":bio"]=i.trim().slice(0,280),o.push("#bio = :bio")),l["#ts"]="lastEventAt",u[":ts"]=Date.now(),o.push("#ts = :ts"),o.length&&await d.send(new r.UpdateCommand({TableName:a,Key:{pk:b,sk:p},UpdateExpression:`SET ${o.join(", ")}`,ExpressionAttributeNames:l,ExpressionAttributeValues:u})),m(t)}default:throw new Error(`Unknown field ${e.info.fieldName}`)}};0&&(module.exports={handler});
