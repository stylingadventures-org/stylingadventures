{
  "version": 3,
  "sources": ["../../lambda/closet/bg-worker.ts"],
  "sourcesContent": ["// lambda/closet/bg-worker.ts\r\n\r\nimport { S3Event, S3Handler } from \"aws-lambda\";\r\nimport {\r\n  DynamoDBClient,\r\n  QueryCommand,\r\n  UpdateItemCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport { S3Client } from \"@aws-sdk/client-s3\";\r\nimport { LambdaClient, InvokeCommand } from \"@aws-sdk/client-lambda\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\nconst s3 = new S3Client({});\r\nconst lambda = new LambdaClient({});\r\n\r\nconst {\r\n  TABLE_NAME = \"\",\r\n  RAW_MEDIA_GSI_NAME = \"rawMediaKeyIndex\",\r\n  OUTPUT_BUCKET = \"\",\r\n  IMAGE_SEGMENTATION_FN_NAME = \"\",\r\n} = process.env;\r\n\r\nif (!TABLE_NAME) throw new Error(\"Missing env: TABLE_NAME\");\r\nif (!RAW_MEDIA_GSI_NAME) throw new Error(\"Missing env: RAW_MEDIA_GSI_NAME\");\r\nif (!IMAGE_SEGMENTATION_FN_NAME)\r\n  throw new Error(\"Missing env: IMAGE_SEGMENTATION_FN_NAME (Docker Lambda)\");\r\n\r\nconst S = (v: string) => ({ S: v });\r\n\r\nfunction nowIso() {\r\n  return new Date().toISOString();\r\n}\r\n\r\n/**\r\n * Try to find a closet item by rawMediaKey, being tolerant of small key differences.\r\n */\r\nasync function findClosetItemByRawKey(rawKey: string) {\r\n  // Try several common variants:\r\n  const candidates = Array.from(\r\n    new Set([\r\n      rawKey,\r\n      // add a leading slash\r\n      \"/\" + rawKey.replace(/^\\/+/, \"\"),\r\n      // strip leading slash\r\n      rawKey.replace(/^\\/+/, \"\"),\r\n      // strip \"public/\" prefix\r\n      rawKey.replace(/^public\\//, \"\"),\r\n      // strip leading slash + \"public/\"\r\n      rawKey.replace(/^\\/?public\\//, \"\"),\r\n    ])\r\n  );\r\n\r\n  console.log(\"[bg-worker] Looking up closet item by rawMediaKey\", {\r\n    rawKey,\r\n    candidates,\r\n  });\r\n\r\n  for (const candidate of candidates) {\r\n    const q = await ddb.send(\r\n      new QueryCommand({\r\n        TableName: TABLE_NAME,\r\n        IndexName: RAW_MEDIA_GSI_NAME,\r\n        KeyConditionExpression: \"rawMediaKey = :k\",\r\n        ExpressionAttributeValues: { \":k\": S(candidate) },\r\n        Limit: 1,\r\n      })\r\n    );\r\n\r\n    const item = q.Items?.[0];\r\n    if (item) {\r\n      console.log(\"[bg-worker] Found closet item for candidate key\", {\r\n        candidate,\r\n        pk: item.pk?.S,\r\n        sk: item.sk?.S,\r\n        id: item.id?.S,\r\n      });\r\n      return item;\r\n    }\r\n  }\r\n\r\n  console.warn(\r\n    \"[bg-worker] No closet item found for any rawMediaKey candidate\",\r\n    candidates\r\n  );\r\n  return null;\r\n}\r\n\r\n/**\r\n * Process one S3 object: find the closet item, invoke the Docker\r\n * segmentation Lambda, and update Dynamo with mediaKey.\r\n */\r\nasync function processRecord(bucket: string, key: string): Promise<void> {\r\n  console.log(\"[bg-worker] Processing record\", { bucket, key });\r\n\r\n  const item = await findClosetItemByRawKey(key);\r\n  if (!item) {\r\n    // Nothing to do; we already logged.\r\n    return;\r\n  }\r\n\r\n  const pk = item.pk?.S;\r\n  const sk = item.sk?.S || \"META\";\r\n  const id = item.id?.S || pk?.replace(/^ITEM#/, \"\");\r\n\r\n  if (!pk) {\r\n    console.warn(\"[bg-worker] Item missing pk; skipping\", { item });\r\n    return;\r\n  }\r\n\r\n  console.log(\"[bg-worker] Using closet item\", { id, pk, sk });\r\n\r\n  // 1) Invoke the Docker image segmentation Lambda.\r\n  console.log(\"[bg-worker] Invoking image segmentation Lambda\", {\r\n    fn: IMAGE_SEGMENTATION_FN_NAME,\r\n    key,\r\n  });\r\n\r\n  const invokeRes = await lambda.send(\r\n    new InvokeCommand({\r\n      FunctionName: IMAGE_SEGMENTATION_FN_NAME,\r\n      InvocationType: \"RequestResponse\",\r\n      Payload: Buffer.from(\r\n        JSON.stringify({\r\n          item: { s3Key: key },\r\n        })\r\n      ),\r\n    })\r\n  );\r\n\r\n  if (!invokeRes.Payload) {\r\n    throw new Error(\"Segmentation Lambda returned no payload\");\r\n  }\r\n\r\n  const payloadJson = JSON.parse(\r\n    Buffer.from(invokeRes.Payload).toString(\"utf8\")\r\n  );\r\n\r\n  console.log(\"[bg-worker] Segmentation result\", payloadJson);\r\n\r\n  const processedKey =\r\n    payloadJson.processedKey ||\r\n    payloadJson.outputKey ||\r\n    payloadJson.segmentation?.processedKey;\r\n\r\n  if (!processedKey) {\r\n    console.error(\r\n      \"[bg-worker] Segmentation response missing processedKey / outputKey\",\r\n      payloadJson\r\n    );\r\n    return;\r\n  }\r\n\r\n  // This is the key we want the front-end to use. The Docker function already\r\n  // wrote the PNG into S3, so we don't need to re-upload anything here.\r\n  const cutoutKey = processedKey;\r\n\r\n  const updatedAt = nowIso();\r\n\r\n  await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: { pk: S(pk), sk: S(sk) },\r\n      UpdateExpression:\r\n        \"SET mediaKey = :m, updatedAt = :u, backgroundStatus = :s\",\r\n      ExpressionAttributeValues: {\r\n        \":m\": S(cutoutKey),\r\n        \":u\": S(updatedAt),\r\n        \":s\": S(\"DONE\"),\r\n      },\r\n    })\r\n  );\r\n\r\n  console.log(\"[bg-worker] Updated item with mediaKey\", {\r\n    id,\r\n    mediaKey: cutoutKey,\r\n    backgroundStatus: \"DONE\",\r\n  });\r\n}\r\n\r\n/**\r\n * Lambda entry point.\r\n */\r\nexport const handler: S3Handler = async (event: S3Event) => {\r\n  console.log(\r\n    \"[bg-worker] Received S3 event\",\r\n    JSON.stringify(\r\n      event.Records.map((r) => ({\r\n        bucket: r.s3.bucket.name,\r\n        key: decodeURIComponent(r.s3.object.key.replace(/\\+/g, \" \")),\r\n      })),\r\n      null,\r\n      2\r\n    )\r\n  );\r\n\r\n  for (const record of event.Records || []) {\r\n    const bucket = record.s3.bucket.name;\r\n    const key = decodeURIComponent(record.s3.object.key.replace(/\\+/g, \" \"));\r\n\r\n    try {\r\n      await processRecord(bucket, key);\r\n    } catch (err) {\r\n      console.error(\"[bg-worker] Error processing object\", {\r\n        bucket,\r\n        key,\r\n        error: (err as Error).message,\r\n      });\r\n    }\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["bg_worker_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_client_s3", "import_client_lambda", "ddb", "s3", "lambda", "TABLE_NAME", "RAW_MEDIA_GSI_NAME", "OUTPUT_BUCKET", "IMAGE_SEGMENTATION_FN_NAME", "S", "v", "nowIso", "findClosetItemByRawKey", "rawKey", "candidates", "candidate", "item", "processRecord", "bucket", "key", "pk", "sk", "id", "invokeRes", "payloadJson", "processedKey", "cutoutKey", "updatedAt", "event", "r", "record", "err"]
}
