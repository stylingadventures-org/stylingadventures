"use strict";var d=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var I=(o,e)=>{for(var n in e)d(o,n,{get:e[n],enumerable:!0})},N=(o,e,n,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of S(e))!A.call(o,r)&&r!==n&&d(o,r,{get:()=>e[r],enumerable:!(t=y(e,r))||t.enumerable});return o};var M=o=>N(d({},"__esModule",{value:!0}),o);var C={};I(C,{handler:()=>R});module.exports=M(C);var i=require("@aws-sdk/client-dynamodb"),w=require("@aws-sdk/client-s3"),c=require("@aws-sdk/client-lambda"),b=new i.DynamoDBClient({}),U=new w.S3Client({}),T=new c.LambdaClient({}),{TABLE_NAME:l="",RAW_MEDIA_GSI_NAME:f="rawMediaKeyIndex",OUTPUT_BUCKET:D="",IMAGE_SEGMENTATION_FN_NAME:m=""}=process.env;if(!l)throw new Error("Missing env: TABLE_NAME");if(!f)throw new Error("Missing env: RAW_MEDIA_GSI_NAME");if(!m)throw new Error("Missing env: IMAGE_SEGMENTATION_FN_NAME (Docker Lambda)");var s=o=>({S:o});function _(){return new Date().toISOString()}async function K(o){let e=Array.from(new Set([o,"/"+o.replace(/^\/+/,""),o.replace(/^\/+/,""),o.replace(/^public\//,""),o.replace(/^\/?public\//,"")]));console.log("[bg-worker] Looking up closet item by rawMediaKey",{rawKey:o,candidates:e});for(let n of e){let r=(await b.send(new i.QueryCommand({TableName:l,IndexName:f,KeyConditionExpression:"rawMediaKey = :k",ExpressionAttributeValues:{":k":s(n)},Limit:1}))).Items?.[0];if(r)return console.log("[bg-worker] Found closet item for candidate key",{candidate:n,pk:r.pk?.S,sk:r.sk?.S,id:r.id?.S}),r}return console.warn("[bg-worker] No closet item found for any rawMediaKey candidate",e),null}async function v(o,e){console.log("[bg-worker] Processing record",{bucket:o,key:e});let n=await K(e);if(!n)return;let t=n.pk?.S,r=n.sk?.S||"META",g=n.id?.S||t?.replace(/^ITEM#/,"");if(!t){console.warn("[bg-worker] Item missing pk; skipping",{item:n});return}console.log("[bg-worker] Using closet item",{id:g,pk:t,sk:r}),console.log("[bg-worker] Invoking image segmentation Lambda",{fn:m,key:e});let p=await T.send(new c.InvokeCommand({FunctionName:m,InvocationType:"RequestResponse",Payload:Buffer.from(JSON.stringify({item:{s3Key:e}}))}));if(!p.Payload)throw new Error("Segmentation Lambda returned no payload");let a=JSON.parse(Buffer.from(p.Payload).toString("utf8"));console.log("[bg-worker] Segmentation result",a);let u=a.processedKey||a.outputKey||a.segmentation?.processedKey;if(!u){console.error("[bg-worker] Segmentation response missing processedKey / outputKey",a);return}let k=u,E=_();await b.send(new i.UpdateItemCommand({TableName:l,Key:{pk:s(t),sk:s(r)},UpdateExpression:"SET mediaKey = :m, updatedAt = :u, backgroundStatus = :s",ExpressionAttributeValues:{":m":s(k),":u":s(E),":s":s("DONE")}})),console.log("[bg-worker] Updated item with mediaKey",{id:g,mediaKey:k,backgroundStatus:"DONE"})}var R=async o=>{console.log("[bg-worker] Received S3 event",JSON.stringify(o.Records.map(e=>({bucket:e.s3.bucket.name,key:decodeURIComponent(e.s3.object.key.replace(/\+/g," "))})),null,2));for(let e of o.Records||[]){let n=e.s3.bucket.name,t=decodeURIComponent(e.s3.object.key.replace(/\+/g," "));try{await v(n,t)}catch(r){console.error("[bg-worker] Error processing object",{bucket:n,key:t,error:r.message})}}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
