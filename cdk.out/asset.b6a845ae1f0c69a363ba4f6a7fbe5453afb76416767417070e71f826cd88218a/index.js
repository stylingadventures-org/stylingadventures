"use strict";var S=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var K=Object.prototype.hasOwnProperty;var R=(t,s)=>{for(var r in s)S(t,r,{get:s[r],enumerable:!0})},D=(t,s,r,e)=>{if(s&&typeof s=="object"||typeof s=="function")for(let o of C(s))!K.call(t,o)&&o!==r&&S(t,o,{get:()=>s[o],enumerable:!(e=x(s,o))||e.enumerable});return t};var M=t=>D(S({},"__esModule",{value:!0}),t);var P={};R(P,{handler:()=>h});module.exports=M(P);var i=require("@aws-sdk/client-dynamodb"),p=require("@aws-sdk/client-sfn"),y=require("crypto"),m=new i.DynamoDBClient({}),l=new p.SFNClient({}),{TABLE_NAME:u="",APPROVAL_SM_ARN:g=""}=process.env;if(!u)throw new Error("Missing env: TABLE_NAME");var n=t=>({S:t}),A=()=>new Date().toISOString();function c(t){let s=t?.identity?.claims||{},r=t?.identity?.sub||s?.sub,e=s?.["cognito:groups"],a=(Array.isArray(e)?e:String(e||"").split(",").map(d=>d.trim()).filter(Boolean)).includes("ADMIN");if(!r)throw new Error("Unauthorized");return{sub:r,isAdmin:a}}var b=async t=>{let{sub:s}=c(t);return((await m.send(new i.QueryCommand({TableName:u,IndexName:"gsi1",KeyConditionExpression:"gsi1pk = :p",ExpressionAttributeValues:{":p":n(`OWNER#${s}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, title, reason",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(e=>({id:e.id.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??""}))},k=async t=>{let{isAdmin:s}=c(t);if(!s)throw new Error("Forbidden");return((await m.send(new i.QueryCommand({TableName:u,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, title, reason",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(e=>({id:e.id.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??""}))},T=async t=>{let{sub:s}=c(t),r=t?.arguments||{},e=(0,y.randomUUID)(),o=A();return await m.send(new i.PutItemCommand({TableName:u,Item:{pk:n(`ITEM#${e}`),sk:n("META"),id:n(e),ownerSub:n(s),status:n("DRAFT"),title:n(r.title??""),mediaKey:n(r.mediaKey??""),createdAt:n(o),updatedAt:n(o),gsi1pk:n(`OWNER#${s}`),gsi1sk:n(o),gsi2pk:n("STATUS#DRAFT"),gsi2sk:n(o)},ConditionExpression:"attribute_not_exists(pk)"})),{id:e,ownerSub:s,status:"DRAFT",title:r.title??"",mediaKey:r.mediaKey??"",createdAt:o,updatedAt:o}},f=async t=>{let{sub:s,isAdmin:r}=c(t),e=t?.arguments?.id;if(!e)throw new Error("id required");let o=A();if(!r){let a=await m.send(new i.GetItemCommand({TableName:u,Key:{pk:n(`ITEM#${e}`),sk:n("META")},ProjectionExpression:"ownerSub"}));if(!a.Item?.ownerSub?.S)throw new Error("Not found");if(a.Item.ownerSub.S!==s)throw new Error("Not authorized")}if(await m.send(new i.UpdateItemCommand({TableName:u,Key:{pk:n(`ITEM#${e}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("PENDING"),":u":n(o),":g2pk":n("STATUS#PENDING"),":g2sk":n(o)}})),g)try{await l.send(new p.StartExecutionCommand({stateMachineArn:g,input:JSON.stringify({itemId:e,ownerSub:s}),name:`req-${e}-${Date.now()}`}))}catch{}return`requested:${e}`},I=async t=>{let{isAdmin:s}=c(t);if(!s)throw new Error("Forbidden");let r=t?.arguments?.id;if(!r)throw new Error("id required");let e=A(),a=(await m.send(new i.UpdateItemCommand({TableName:u,Key:{pk:n(`ITEM#${r}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("APPROVED"),":u":n(e),":g2pk":n("STATUS#APPROVED"),":g2sk":n(e)},ReturnValues:"ALL_OLD"}))).Attributes,d=a?.approvalToken?.S;if(d)try{await l.send(new p.SendTaskSuccessCommand({taskToken:d,output:JSON.stringify({approved:!0})}))}catch{}return{id:a.id.S,ownerSub:a.ownerSub.S,status:"APPROVED",createdAt:a.createdAt.S,updatedAt:e,mediaKey:a.mediaKey?.S??"",title:a.title?.S??"",reason:""}},N=async t=>{let{isAdmin:s}=c(t);if(!s)throw new Error("Forbidden");let r=t?.arguments?.id,e=t?.arguments?.reason??"";if(!r)throw new Error("id required");let o=A(),d=(await m.send(new i.UpdateItemCommand({TableName:u,Key:{pk:n(`ITEM#${r}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("REJECTED"),":u":n(o),":g2pk":n("STATUS#REJECTED"),":g2sk":n(o),":r":n(e)},ReturnValues:"ALL_OLD"}))).Attributes,E=d?.approvalToken?.S;if(E)try{await l.send(new p.SendTaskFailureCommand({taskToken:E,error:"Rejected",cause:e||"Rejected by admin"}))}catch{}return{id:d.id.S,ownerSub:d.ownerSub.S,status:"REJECTED",createdAt:d.createdAt.S,updatedAt:o,mediaKey:d.mediaKey?.S??"",title:d.title?.S??"",reason:e}};var h=async t=>{let s=t.info.fieldName;if(s==="hello")return"Hello from Styling Adventures \u{1F44B}";if(s==="myCloset")return b(t);if(s==="adminListPending")return k(t);if(s==="createClosetItem")return T(t);if(s==="requestClosetApproval")return f(t);if(s==="adminApproveItem")return I(t);if(s==="adminRejectItem")return N(t);if(s==="editClosetMediaKey")return(void 0)(t);throw new Error(`Unknown field: ${s}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
