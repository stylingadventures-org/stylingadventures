"use strict";var A=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var f=Object.prototype.hasOwnProperty;var k=(e,r)=>{for(var u in r)A(e,u,{get:r[u],enumerable:!0})},C=(e,r,u,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let t of N(r))!f.call(e,t)&&t!==u&&A(e,t,{get:()=>r[t],enumerable:!(n=T(r,t))||n.enumerable});return e};var h=e=>C(A({},"__esModule",{value:!0}),e);var K={};k(K,{handler:()=>x});module.exports=h(K);var b=require("crypto"),I=require("@aws-sdk/client-dynamodb"),s=require("@aws-sdk/lib-dynamodb"),w=require("@aws-sdk/client-sfn"),o=process.env.TABLE_NAME,S=process.env.APPROVAL_SM_ARN||"",d=s.DynamoDBDocumentClient.from(new I.DynamoDBClient({})),D=new w.SFNClient({}),c=()=>new Date().toISOString(),E=e=>{if(!e)throw new Error("Unauthenticated")},g=e=>{let r=e?.claims?.["cognito:groups"];return Array.isArray(r)?r.includes("ADMIN"):`${r||""}`.includes("ADMIN")},l=e=>({pk:`ITEM#${e}`,sk:"META"}),y=e=>({id:e.id,ownerSub:e.ownerSub,title:e.title??null,status:e.status,mediaKey:e.mediaKey??null,createdAt:e.createdAt,updatedAt:e.updatedAt}),R=new Set(["ep-001"]),x=async e=>{let r=e.info.fieldName,u=e.identity,n=u?.sub;switch(r){case"isEpisodeEarlyAccess":{let t=String(e.arguments?.id||"").trim();if(R.has(t))return{allowed:!0,reason:null};if(!n)return{allowed:!1,reason:"Sign in to check early access."};let a=(await d.send(new s.GetCommand({TableName:o,Key:{pk:`USER#${n}`,sk:"PROFILE"}}))).Item||{};if(a.bestie?.BOOL===!0||a.bestieActive?.BOOL===!0||a.tier?.S==="BESTIE"||a.tier==="BESTIE")return{allowed:!0,reason:null};try{let p=await d.send(new s.GetCommand({TableName:o,Key:{pk:`USER#${n}`,sk:"BESTIE"}}));if(p.Item?.active===!0||p.Item?.active?.BOOL===!0)return{allowed:!0,reason:null}}catch{}return{allowed:!1,reason:"This is an early drop for Bestie members."}}case"myCloset":return E(n),((await d.send(new s.QueryCommand({TableName:o,IndexName:"gsi1",KeyConditionExpression:"gsi1pk = :p",ExpressionAttributeValues:{":p":`OWNER#${n}`},ScanIndexForward:!1,Limit:50}))).Items||[]).filter(i=>i.sk==="META").map(y);case"createClosetItem":{E(n);let{title:t,mediaKey:i}=e.arguments||{},a=(0,b.randomUUID)(),m=c(),p={id:a,ownerSub:n,title:(t??"").trim()||null,mediaKey:(i??"").trim()||null,status:"DRAFT",createdAt:m,updatedAt:m};return await d.send(new s.PutCommand({TableName:o,Item:{...p,...l(a),gsi1pk:`OWNER#${n}`,gsi1sk:m,gsi2pk:"STATUS#DRAFT",gsi2sk:m},ConditionExpression:"attribute_not_exists(pk)"})),p}case"updateClosetMediaKey":{E(n);let{id:t,mediaKey:i}=e.arguments,a=await d.send(new s.GetCommand({TableName:o,Key:l(t)}));if(!a.Item)throw new Error("Not found");if(a.Item.ownerSub!==n)throw new Error("Forbidden");let m=c(),p=await d.send(new s.UpdateCommand({TableName:o,Key:l(t),UpdateExpression:"SET mediaKey = :k, updatedAt = :u",ExpressionAttributeValues:{":k":i,":u":m},ReturnValues:"ALL_NEW"}));return y(p.Attributes)}case"requestClosetApproval":{E(n);let{id:t}=e.arguments,i=await d.send(new s.GetCommand({TableName:o,Key:l(t)}));if(!i.Item)throw new Error("Not found");if(i.Item.ownerSub!==n)throw new Error("Forbidden");let a=c();return await d.send(new s.UpdateCommand({TableName:o,Key:l(t),UpdateExpression:"SET #s = :p, gsi2pk = :g, gsi2sk = :ts, updatedAt = :ts",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":p":"PENDING",":g":"STATUS#PENDING",":ts":a}})),S&&await D.send(new w.StartExecutionCommand({stateMachineArn:S,input:JSON.stringify({itemId:t,ownerSub:n})})),!0}case"adminListPending":{if(!g(u))throw new Error("Not authorized");return((await d.send(new s.QueryCommand({TableName:o,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":"STATUS#PENDING"},ScanIndexForward:!1,Limit:100}))).Items||[]).map(y)}case"adminApproveItem":{if(!g(u))throw new Error("Not authorized");let{id:t}=e.arguments,i=c();return await d.send(new s.UpdateCommand({TableName:o,Key:l(t),UpdateExpression:"SET #s = :a, gsi2pk = :g, gsi2sk = :ts, updatedAt = :ts REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":a":"APPROVED",":g":"STATUS#APPROVED",":ts":i}})),!0}case"adminRejectItem":{if(!g(u))throw new Error("Not authorized");let{id:t,reason:i}=e.arguments,a=c();return await d.send(new s.UpdateCommand({TableName:o,Key:l(t),UpdateExpression:"SET #s = :r, gsi2pk = :g, gsi2sk = :ts, updatedAt = :ts, reason = :why REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":r":"REJECTED",":g":"STATUS#REJECTED",":ts":a,":why":i??"Rejected by admin"}})),!0}case"deleteClosetItem":{E(n);let{id:t}=e.arguments,i=await d.send(new s.GetCommand({TableName:o,Key:l(t)}));if(!i.Item)throw new Error("Not found");if(i.Item.ownerSub!==n&&!g(u))throw new Error("Forbidden");return await d.send(new s.DeleteCommand({TableName:o,Key:l(t)})),!0}default:throw new Error(`Unhandled field: ${r}`)}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
