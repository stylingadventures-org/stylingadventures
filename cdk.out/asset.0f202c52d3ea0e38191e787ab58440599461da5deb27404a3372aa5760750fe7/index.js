"use strict";var S=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var x=(s,t)=>{for(var r in t)S(s,r,{get:t[r],enumerable:!0})},C=(s,t,r,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of N(t))!I.call(s,o)&&o!==r&&S(s,o,{get:()=>t[o],enumerable:!(e=k(t,o))||e.enumerable});return s};var K=s=>C(S({},"__esModule",{value:!0}),s);var D={};x(D,{handler:()=>R});module.exports=K(D);var a=require("@aws-sdk/client-dynamodb"),c=require("@aws-sdk/client-sfn"),E=require("crypto"),m=new a.DynamoDBClient({}),h=new c.SFNClient({}),{TABLE_NAME:u="",APPROVAL_SM_ARN:l=""}=process.env;if(!u)throw new Error("Missing env: TABLE_NAME");var n=s=>({S:s}),A=()=>new Date().toISOString();function p(s){let t=s?.identity?.claims||{},r=s?.identity?.sub||t?.sub,e=(Array.isArray(t["cognito:groups"])?t["cognito:groups"]:String(t["cognito:groups"]||"")).split(",").map(i=>i.trim()).filter(Boolean),o=e.includes("ADMIN")||e.includes("COLLAB");if(!r)throw new Error("Unauthorized");return{sub:r,isAdmin:o}}var w=async s=>{let{sub:t}=p(s);return((await m.send(new a.QueryCommand({TableName:u,IndexName:"gsi1",KeyConditionExpression:"gsi1pk = :p",ExpressionAttributeValues:{":p":n(`OWNER#${t}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, title, reason",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(e=>({id:e.id.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??""}))},g=async s=>{let{isAdmin:t}=p(s);if(!t)throw new Error("Forbidden");return((await m.send(new a.QueryCommand({TableName:u,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, title, reason",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(e=>({id:e.id.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??""}))},y=async s=>{let{sub:t}=p(s),r=s?.arguments||{},e=(0,E.randomUUID)(),o=A();return await m.send(new a.PutItemCommand({TableName:u,Item:{pk:n(`ITEM#${e}`),sk:n("META"),id:n(e),ownerSub:n(t),status:n("DRAFT"),title:n(r.title??""),mediaKey:n(r.mediaKey??""),createdAt:n(o),updatedAt:n(o),gsi1pk:n(`OWNER#${t}`),gsi1sk:n(o),gsi2pk:n("STATUS#DRAFT"),gsi2sk:n(o)},ConditionExpression:"attribute_not_exists(pk)"})),{id:e,ownerSub:t,status:"DRAFT",title:r.title??"",mediaKey:r.mediaKey??"",createdAt:o,updatedAt:o}},b=async s=>{let{sub:t,isAdmin:r}=p(s),e=s?.arguments?.id;if(!e)throw new Error("id required");let o=A();if(!r){let i=await m.send(new a.GetItemCommand({TableName:u,Key:{pk:n(`ITEM#${e}`),sk:n("META")},ProjectionExpression:"ownerSub"}));if(!i.Item?.ownerSub?.S)throw new Error("Not found");if(i.Item.ownerSub.S!==t)throw new Error("Not authorized")}if(await m.send(new a.UpdateItemCommand({TableName:u,Key:{pk:n(`ITEM#${e}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("PENDING"),":u":n(o),":g2pk":n("STATUS#PENDING"),":g2sk":n(o)}})),l)try{await h.send(new c.StartExecutionCommand({stateMachineArn:l,input:JSON.stringify({itemId:e,ownerSub:t}),name:`req-${e}-${Date.now()}`}))}catch{}return`requested:${e}`},f=async s=>{let{isAdmin:t}=p(s);if(!t)throw new Error("Forbidden");let r=s?.arguments?.id;if(!r)throw new Error("id required");let e=A(),i=(await m.send(new a.UpdateItemCommand({TableName:u,Key:{pk:n(`ITEM#${r}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("APPROVED"),":u":n(e),":g2pk":n("STATUS#APPROVED"),":g2sk":n(e)},ReturnValues:"ALL_NEW"}))).Attributes;return{id:i.id.S,ownerSub:i.ownerSub.S,status:i.status.S,createdAt:i.createdAt.S,updatedAt:i.updatedAt.S,mediaKey:i.mediaKey?.S??"",title:i.title?.S??"",reason:""}},T=async s=>{let{isAdmin:t}=p(s);if(!t)throw new Error("Forbidden");let r=s?.arguments?.id,e=s?.arguments?.reason??"";if(!r)throw new Error("id required");let o=A(),d=(await m.send(new a.UpdateItemCommand({TableName:u,Key:{pk:n(`ITEM#${r}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("REJECTED"),":u":n(o),":g2pk":n("STATUS#REJECTED"),":g2sk":n(o),":r":n(e)},ReturnValues:"ALL_NEW"}))).Attributes;return{id:d.id.S,ownerSub:d.ownerSub.S,status:d.status.S,createdAt:d.createdAt.S,updatedAt:d.updatedAt.S,mediaKey:d.mediaKey?.S??"",title:d.title?.S??"",reason:d.reason?.S??""}};var R=async s=>{let t=s.info.fieldName;if(t==="hello")return"Hello from Styling Adventures \u{1F44B}";if(t==="myCloset")return w(s);if(t==="adminListPending")return g(s);if(t==="createClosetItem")return y(s);if(t==="requestClosetApproval")return b(s);if(t==="adminApproveItem")return f(s);if(t==="adminRejectItem")return T(s);throw new Error(`Unknown field: ${t}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
