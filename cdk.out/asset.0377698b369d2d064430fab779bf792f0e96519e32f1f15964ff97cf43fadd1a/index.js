"use strict";var y=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var V=Object.prototype.hasOwnProperty;var R=(e,s)=>{for(var r in s)y(e,r,{get:s[r],enumerable:!0})},U=(e,s,r,n)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of F(s))!V.call(e,i)&&i!==r&&y(e,i,{get:()=>s[i],enumerable:!(n=O(s,i))||n.enumerable});return e};var $=e=>U(y({},"__esModule",{value:!0}),e);var H={};R(H,{adminApproveItem:()=>K,adminCreateClosetItem:()=>x,adminListClosetItems:()=>v,adminListPending:()=>k,adminRejectItem:()=>M,adminSetClosetAudience:()=>P,closetFeed:()=>b,handler:()=>j,toggleFavoriteClosetItem:()=>D,topClosetLooks:()=>N});module.exports=$(H);var o=require("@aws-sdk/client-dynamodb"),S=require("@aws-sdk/client-sfn"),l=new o.DynamoDBClient({}),I=new S.SFNClient({}),{TABLE_NAME:c=""}=process.env;if(!c)throw new Error("Missing env: TABLE_NAME");var w=()=>new Date().toISOString(),t=e=>({S:e});function g(e){let s=e.identity?.claims||{},r=e.identity?.sub||s.sub,n=s["cognito:groups"],i=Array.isArray(n)?n:String(n||"").split(",").map(u=>u.trim()).filter(Boolean),a=i.includes("ADMIN")||i.includes("COLLAB");if(!r)throw new Error("Unauthorized");return{sub:r,isAdmin:a}}function A(e,s){let r=e.favoriteCount?.N,n=typeof r=="string"?Number(r):0;return{id:e.id.S,userId:e.ownerSub.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",rawMediaKey:e.rawMediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??"",season:e.season?.S??null,vibes:e.vibes?.S??null,audience:e.audience?.S??null,favoriteCount:n,viewerHasFaved:!1,...s}}function _(){return globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`}function C(e){return e?Buffer.from(JSON.stringify(e),"utf8").toString("base64"):null}function B(e){if(e)try{return JSON.parse(Buffer.from(String(e),"base64").toString("utf8"))}catch{return}}var k=async e=>{let{isAdmin:s}=g(e);if(!s)throw new Error("Forbidden");return((await l.send(new o.QueryCommand({TableName:c,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(n=>A({...n,status:n.status}))},v=async e=>{let{isAdmin:s}=g(e);if(!s)throw new Error("Forbidden");let{status:r,limit:n=50,nextToken:i}=e.arguments||{},a=B(i);if(r){let d=await l.send(new o.QueryCommand({TableName:c,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t(`STATUS#${r}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount",ExpressionAttributeNames:{"#s":"status"},Limit:n,ExclusiveStartKey:a}));return{items:(d.Items||[]).map(E=>A({...E,status:E.status})),nextToken:C(d.LastEvaluatedKey)}}let u=await l.send(new o.ScanCommand({TableName:c,FilterExpression:"begins_with(pk, :p)",ExpressionAttributeValues:{":p":t("ITEM#")},ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount",ExpressionAttributeNames:{"#s":"status"},Limit:n,ExclusiveStartKey:a})),m=(u.Items||[]).map(d=>A({...d,status:d.status}));return m.sort((d,p)=>new Date(p.createdAt||0).getTime()-new Date(d.createdAt||0).getTime()),{items:m,nextToken:C(u.LastEvaluatedKey)}},b=async e=>{let{sub:s}=g(e),{sort:r="NEWEST"}=e.arguments||{},[n,i]=await Promise.all([l.send(new o.QueryCommand({TableName:c,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t("STATUS#PUBLISHED")},ScanIndexForward:r==="NEWEST",ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, audience, favoriteCount",ExpressionAttributeNames:{"#s":"status"}})),l.send(new o.QueryCommand({TableName:c,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:{":pk":t(`FAV#${s}`),":sk":t("CLOSET#")}}))]),a=new Set((i.Items||[]).map(m=>{let d=m.sk?.S??"";return d.startsWith("CLOSET#")?d.substring(7):m.closetId?.S??""})),u=(n.Items||[]).map(m=>A({...m,status:m.status},{viewerHasFaved:a.has(m.id.S)}));return r==="MOST_LOVED"&&u.sort((m,d)=>{let p=m.favoriteCount??0,E=d.favoriteCount??0;return E!==p?E-p:new Date(d.createdAt||0).getTime()-new Date(m.createdAt||0).getTime()}),u},N=async e=>b({...e,arguments:{sort:"NEWEST"}}),x=async e=>{let{sub:s,isAdmin:r}=g(e);if(!r)throw new Error("Forbidden");let n=e.arguments?.input||{};if(!n.title?.trim())throw new Error("title is required");if(!n.rawMediaKey)throw new Error("rawMediaKey is required");let i=_(),a=w();return await l.send(new o.PutItemCommand({TableName:c,Item:{pk:t(`ITEM#${i}`),sk:t("META"),id:t(i),ownerSub:t(s),gsi2pk:t("STATUS#PENDING"),gsi2sk:t(a),status:t("PENDING"),createdAt:t(a),updatedAt:t(a),title:t(n.title.trim()),rawMediaKey:t(n.rawMediaKey),favoriteCount:{N:"0"},...n.season?{season:t(n.season)}:{},...n.vibes?{vibes:t(n.vibes)}:{}}})),{id:i,userId:s,ownerSub:s,status:"PENDING",createdAt:a,updatedAt:a,title:n.title.trim(),mediaKey:"",rawMediaKey:n.rawMediaKey,reason:"",season:n.season??null,vibes:n.vibes??null,audience:null,favoriteCount:0,viewerHasFaved:!1}},K=async e=>{let{isAdmin:s}=g(e);if(!s)throw new Error("Forbidden");let r=e.arguments?.id;if(!r)throw new Error("id required");let n=w(),a=(await l.send(new o.UpdateItemCommand({TableName:c,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("APPROVED"),":u":t(n),":g2pk":t("STATUS#APPROVED"),":g2sk":t(n)},ReturnValues:"ALL_OLD"}))).Attributes,u=a.approvalToken?.S;if(u)try{await I.send(new S.SendTaskSuccessCommand({taskToken:u,output:JSON.stringify({approved:!0})}))}catch{}return A({...a,status:t("APPROVED")})},M=async e=>{let{isAdmin:s}=g(e);if(!s)throw new Error("Forbidden");let r=e.arguments?.id,n=e.arguments?.reason||"";if(!r)throw new Error("id required");let i=w(),u=(await l.send(new o.UpdateItemCommand({TableName:c,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("REJECTED"),":u":t(i),":g2pk":t("STATUS#REJECTED"),":g2sk":t(i),":r":t(n)},ReturnValues:"ALL_OLD"}))).Attributes,m=u.approvalToken?.S;if(m)try{await I.send(new S.SendTaskFailureCommand({taskToken:m,error:"Rejected",cause:n||"Rejected by admin"}))}catch{}return A({...u,status:t("REJECTED"),reason:t(n)})},P=async()=>"NOT_IMPLEMENTED",D=async e=>{let{sub:s}=g(e),r=e.arguments?.id,n=e.arguments?.on;if(!r)throw new Error("id required");let a=(await l.send(new o.GetItemCommand({TableName:c,Key:{pk:t(`ITEM#${r}`),sk:t("META")}}))).Item;if(!a)throw new Error("Closet item not found");let u={pk:t(`FAV#${s}`),sk:t(`CLOSET#${r}`)},d=!!(await l.send(new o.GetItemCommand({TableName:c,Key:u}))).Item,p=typeof n=="boolean"?n:!d,E=w(),f=0;p&&!d?(f=1,await l.send(new o.PutItemCommand({TableName:c,Item:{...u,userSub:t(s),closetId:t(r),createdAt:t(E)}}))):!p&&d&&(f=-1,await l.send(new o.DeleteItemCommand({TableName:c,Key:u}))),f!==0&&await l.send(new o.UpdateItemCommand({TableName:c,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) + :delta, updatedAt = :u",ExpressionAttributeValues:{":zero":{N:"0"},":delta":{N:String(f)},":u":t(E)}}));let T=a.favoriteCount?.N,h=typeof T=="string"?Number(T):0,L=Math.max(0,h+f);return A(a,{favoriteCount:L,viewerHasFaved:p})},j=async e=>{let s=e.info.fieldName;if(s==="adminListPending")return k(e);if(s==="adminListClosetItems")return v(e);if(s==="adminCreateClosetItem")return x(e);if(s==="adminApproveItem")return K(e);if(s==="adminRejectItem")return M(e);if(s==="adminSetClosetAudience")return P();if(s==="closetFeed")return b(e);if(s==="topClosetLooks")return N(e);if(s==="toggleFavoriteClosetItem")return D(e);throw new Error(`No resolver implemented for field ${s}`)};0&&(module.exports={adminApproveItem,adminCreateClosetItem,adminListClosetItems,adminListPending,adminRejectItem,adminSetClosetAudience,closetFeed,handler,toggleFavoriteClosetItem,topClosetLooks});
//# sourceMappingURL=index.js.map
