"use strict";var p=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var T=Object.prototype.hasOwnProperty;var I=(t,n)=>{for(var r in n)p(t,r,{get:n[r],enumerable:!0})},k=(t,n,r,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let o of x(n))!T.call(t,o)&&o!==r&&p(t,o,{get:()=>n[o],enumerable:!(e=N(n,o))||e.enumerable});return t};var K=t=>k(p({},"__esModule",{value:!0}),t);var M={};I(M,{handler:()=>D});module.exports=K(M);var i=require("@aws-sdk/client-dynamodb"),u=require("@aws-sdk/client-sfn"),w=require("crypto"),d=new i.DynamoDBClient({}),h=new u.SFNClient({}),{TABLE_NAME:a="",APPROVAL_SM_ARN:A=""}=process.env;if(!a)throw new Error("Missing env: TABLE_NAME");var y=()=>new Date().toISOString(),s=t=>({S:t}),S=t=>t==null?{S:""}:{S:t};function m(t){let n=t?.identity?.claims||{},r=t?.identity?.sub||n?.sub,e=Array.isArray(n?.["cognito:groups"])?n["cognito:groups"]:String(n?.["cognito:groups"]||"").split(",").map(c=>c.trim()).filter(Boolean),o=e.includes("ADMIN")||e.includes("COLLAB");if(!r)throw new Error("Unauthorized");return{sub:r,isAdmin:o}}var g=async t=>{let{sub:n}=m(t);return((await d.send(new i.ScanCommand({TableName:a,FilterExpression:"begins_with(pk, :pfx) AND ownerSub = :me",ExpressionAttributeValues:{":pfx":s("ITEM#"),":me":s(n)},ExpressionAttributeNames:{"#id":"id","#ownerSub":"ownerSub","#s":"status","#createdAt":"createdAt","#updatedAt":"updatedAt","#mediaKey":"mediaKey","#title":"title","#reason":"reason"},ProjectionExpression:"#id, #ownerSub, #s, #createdAt, #updatedAt, #mediaKey, #title, #reason",Limit:100}))).Items||[]).map(e=>({id:e.id?.S,ownerSub:e.ownerSub?.S,status:e.status?.S,createdAt:e.createdAt?.S,updatedAt:e.updatedAt?.S,mediaKey:e.mediaKey?.S||null,title:e.title?.S||null,reason:e.reason?.S||null}))},E=async t=>{let{isAdmin:n}=m(t);if(!n)throw new Error("Unauthorized");return((await d.send(new i.ScanCommand({TableName:a,FilterExpression:"begins_with(pk, :pfx) AND #s = :pending",ExpressionAttributeValues:{":pfx":s("ITEM#"),":pending":s("PENDING")},ExpressionAttributeNames:{"#id":"id","#ownerSub":"ownerSub","#s":"status","#createdAt":"createdAt","#updatedAt":"updatedAt","#mediaKey":"mediaKey","#title":"title","#reason":"reason"},ProjectionExpression:"#id, #ownerSub, #s, #createdAt, #updatedAt, #mediaKey, #title, #reason",Limit:100}))).Items||[]).map(e=>({id:e.id?.S,ownerSub:e.ownerSub?.S,status:e.status?.S,createdAt:e.createdAt?.S,updatedAt:e.updatedAt?.S,mediaKey:e.mediaKey?.S||null,title:e.title?.S||null,reason:e.reason?.S||null}))},b=async t=>{let{sub:n,isAdmin:r}=m(t),e=t?.arguments?.id;if(!e)throw new Error("id required");let o=y();if(!r){let l=(await d.send(new i.GetItemCommand({TableName:a,Key:{pk:s(`ITEM#${e}`),sk:s("META")},ProjectionExpression:"ownerSub"}))).Item?.ownerSub?.S;if(!l)throw new Error("Not found");if(l!==n)throw new Error("Not authorized")}if(await d.send(new i.UpdateItemCommand({TableName:a,Key:{pk:s(`ITEM#${e}`),sk:s("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":s("PENDING"),":u":s(o),":g2pk":s("STATUS#PENDING"),":g2sk":s(o)}})),A)try{await h.send(new u.StartExecutionCommand({stateMachineArn:A,input:JSON.stringify({itemId:e,ownerSub:n}),name:`req-${e}-${Date.now()}`}))}catch{}return"OK"},f=async t=>{let{sub:n}=m(t),r=t?.arguments||{},e=(0,w.randomUUID)(),o=y();return await d.send(new i.PutItemCommand({TableName:a,Item:{pk:s(`ITEM#${e}`),sk:s("META"),id:s(e),ownerSub:s(n),status:s("DRAFT"),title:S(r.title),mediaKey:S(r.mediaKey),createdAt:s(o),updatedAt:s(o),gsi1pk:s(`OWNER#${n}`),gsi1sk:s(o),gsi2pk:s("STATUS#DRAFT"),gsi2sk:s(o)},ConditionExpression:"attribute_not_exists(pk)"})),{id:e,ownerSub:n,status:"DRAFT",title:r.title??"",mediaKey:r.mediaKey??"",createdAt:o,updatedAt:o}};var C={myCloset:g,adminListPending:E,createClosetItem:f,requestClosetApproval:b,hello:async()=>"Hello from Styling Adventures \u{1F44B}"},D=async t=>{let n=t?.info?.fieldName,r=C[n];if(!r)throw new Error(`No resolver for field ${n}`);return r(t)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
