"use strict";var E=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var f=Object.prototype.hasOwnProperty;var v=(s,t)=>{for(var e in t)E(s,e,{get:t[e],enumerable:!0})},x=(s,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of A(t))!f.call(s,n)&&n!==e&&E(s,n,{get:()=>t[n],enumerable:!(i=y(t,n))||i.enumerable});return s};var w=s=>x(E({},"__esModule",{value:!0}),s);var S={};v(S,{handler:()=>T});module.exports=w(S);var b=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb");var o=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!o)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var p=a.DynamoDBDocumentClient.from(new b.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),c=s=>`USER#${s}`,d="PROFILE";async function g(s){let t=c(s),{Item:e}=await p.send(new a.GetCommand({TableName:o,Key:{pk:t,sk:d}}));if(!e){let l=new Date().toISOString();return await p.send(new a.UpdateCommand({TableName:o,Key:{pk:t,sk:d},UpdateExpression:"SET #uid=:uid, #lvl=:lvl, #xp=:xp, #coins=:coins, #badges=:badges, #ts=:ts",ExpressionAttributeNames:{"#uid":"userId","#lvl":"level","#xp":"xp","#coins":"coins","#badges":"badges","#ts":"lastEventAt"},ExpressionAttributeValues:{":uid":s,":lvl":1,":xp":0,":coins":0,":badges":[],":ts":l}})),{userId:s,level:1,xp:0,coins:0,badges:[],lastEventAt:l,streakCount:null,lastLoginAt:null}}e.userId||await p.send(new a.UpdateCommand({TableName:o,Key:{pk:t,sk:d},UpdateExpression:"SET #uid = if_not_exists(#uid, :uid)",ExpressionAttributeNames:{"#uid":"userId"},ExpressionAttributeValues:{":uid":s}}));let i=null,n=e.lastEventAt;typeof n=="number"?(i=new Date(n).toISOString(),await p.send(new a.UpdateCommand({TableName:o,Key:{pk:t,sk:d},UpdateExpression:"SET #ts = :ts",ExpressionAttributeNames:{"#ts":"lastEventAt"},ExpressionAttributeValues:{":ts":i}}))):typeof n=="string"?i=n:i=null;let u=null,r=e.lastLoginAt;return typeof r=="number"?(u=new Date(r).toISOString(),await p.send(new a.UpdateCommand({TableName:o,Key:{pk:t,sk:d},UpdateExpression:"SET #ll = :ll",ExpressionAttributeNames:{"#ll":"lastLoginAt"},ExpressionAttributeValues:{":ll":u}}))):typeof r=="string"?u=r:u=null,{userId:e.userId??s,level:e.level??1,xp:e.xp??0,coins:e.coins??0,badges:Array.isArray(e.badges)?e.badges:[],displayName:e.displayName??null,avatarUrl:e.avatarUrl??null,bio:e.bio??null,lastEventAt:i,streakCount:typeof e.streakCount=="number"?e.streakCount:null,lastLoginAt:u}}async function N(s,t){let e=c(s),i=(t??"").trim().slice(0,40),n=new Date().toISOString();return await p.send(new a.UpdateCommand({TableName:o,Key:{pk:e,sk:d},UpdateExpression:"SET #dn=:dn, #ts=:ts ADD #lvl :zero, #xp :zero, #coins :zero",ExpressionAttributeNames:{"#dn":"displayName","#ts":"lastEventAt","#lvl":"level","#xp":"xp","#coins":"coins"},ExpressionAttributeValues:{":dn":i,":ts":n,":zero":0}})),g(s)}var T=async s=>{let t=s.identity?.sub;if(!t)throw new Error("Unauthorized: missing sub");switch(s.info.fieldName){case"getMyProfile":return g(t);case"setDisplayName":return N(t,s.arguments.displayName);case"updateProfile":{let{displayName:e,avatarUrl:i,bio:n}=s.arguments.input||{},u=c(t),r={},l={},m=[];return typeof e=="string"&&(r["#dn"]="displayName",l[":dn"]=e.trim().slice(0,40),m.push("#dn = :dn")),typeof i=="string"&&(r["#av"]="avatarUrl",l[":av"]=i,m.push("#av = :av")),typeof n=="string"&&(r["#bio"]="bio",l[":bio"]=n.trim().slice(0,280),m.push("#bio = :bio")),r["#ts"]="lastEventAt",l[":ts"]=new Date().toISOString(),m.push("#ts = :ts"),m.length&&await p.send(new a.UpdateCommand({TableName:o,Key:{pk:u,sk:d},UpdateExpression:`SET ${m.join(", ")}`,ExpressionAttributeNames:r,ExpressionAttributeValues:l})),g(t)}default:throw new Error(`Unknown field ${s.info.fieldName}`)}};0&&(module.exports={handler});
