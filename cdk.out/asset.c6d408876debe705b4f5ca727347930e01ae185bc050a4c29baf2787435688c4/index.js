"use strict";var u=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var N=(n,e)=>{for(var a in e)u(n,a,{get:e[a],enumerable:!0})},G=(n,e,a,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of w(e))!I.call(n,s)&&s!==a&&u(n,s,{get:()=>e[s],enumerable:!(t=b(e,s))||t.enumerable});return n};var T=n=>G(u({},"__esModule",{value:!0}),n);var C={};N(C,{handler:()=>M});module.exports=T(C);var i=require("@aws-sdk/client-dynamodb"),l=require("@aws-sdk/util-dynamodb"),p=new i.DynamoDBClient({}),{TABLE_NAME:m="",PK_NAME:g="pk",SK_NAME:E="sk",ADMIN_GROUP_NAME:h="ADMIN",SUPERADMIN_EMAILS:R="",SKIP_ADMIN_CHECK:_="false"}=process.env,y="SETTINGS",A="GLOBAL",d={animationsEnabled:!0,soundsEnabled:!0,autoBadgeGrant:!0,badgeRules:[]};function f(n){return(n??"").toString().trim().toLowerCase()}function B(n){if(!n)return!1;if(_==="true")return!0;let e=n.claims||{},a=e["cognito:groups"]??e["custom:groups"]??n.groups??[],t=[];if(Array.isArray(a))t=a.map(r=>(r??"").toString());else if(typeof a=="string"){let r=a.trim();if(r.startsWith("[")&&r.endsWith("]"))try{let c=JSON.parse(r);Array.isArray(c)&&(t=c.map(S=>(S??"").toString()))}catch{t=r.split(",")}else t=r.split(",")}let s=h.toUpperCase();if(t.some(r=>(r??"").toUpperCase()===s))return!0;let o=f(e.email??e["cognito:username"]??n.username);return!!R.split(",").map(f).filter(Boolean).includes(o)}var M=async n=>{if(!n.identity)throw new Error("Unauthorized");if(!B(n.identity))throw new Error("Forbidden: admin only");if(!m)throw new Error("Missing TABLE_NAME env var for settings lambda");let e=(0,l.marshall)({[g]:y,[E]:A});switch(n.info.fieldName){case"getAdminSettings":{let a=await p.send(new i.GetItemCommand({TableName:m,Key:e}));if(!a.Item)return d;let t=(0,l.unmarshall)(a.Item);return{animationsEnabled:t.animationsEnabled??d.animationsEnabled,soundsEnabled:t.soundsEnabled??d.soundsEnabled,autoBadgeGrant:t.autoBadgeGrant??d.autoBadgeGrant,badgeRules:t.badgeRules??d.badgeRules}}case"updateAdminSettings":{let a=n.arguments.input||{},t=await p.send(new i.GetItemCommand({TableName:m,Key:e})),s=t.Item?(0,l.unmarshall)(t.Item):{},o={...d,...s,...a};return await p.send(new i.PutItemCommand({TableName:m,Item:(0,l.marshall)({[g]:y,[E]:A,...o})})),{animationsEnabled:o.animationsEnabled,soundsEnabled:o.soundsEnabled,autoBadgeGrant:o.autoBadgeGrant,badgeRules:o.badgeRules??[]}}default:throw new Error("Unknown field: "+n.info.fieldName)}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
