{
  "version": 3,
  "sources": ["../../lambda/admin/settings.ts"],
  "sourcesContent": ["import { AppSyncResolverHandler } from \"aws-lambda\";\r\nimport {\r\n  DynamoDBClient,\r\n  GetItemCommand,\r\n  PutItemCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport { marshall, unmarshall } from \"@aws-sdk/util-dynamodb\";\r\n\r\ntype AppSyncIdentity = {\r\n  sub?: string;\r\n  username?: string;\r\n  claims?: { [key: string]: any };\r\n  groups?: string[] | null;\r\n};\r\n\r\ntype AppSyncEvent = Parameters<AppSyncResolverHandler<any, any>>[0];\r\n\r\nconst client = new DynamoDBClient({});\r\n\r\n// Environment from ApiStack (DDB_ENV + ADMIN_GROUP_NAME)\r\nconst {\r\n  TABLE_NAME = \"\",\r\n  PK_NAME = \"pk\",\r\n  SK_NAME = \"sk\",\r\n  ADMIN_GROUP_NAME = \"ADMIN\",\r\n  SUPERADMIN_EMAILS = \"\",\r\n  SKIP_ADMIN_CHECK = \"false\",\r\n} = process.env;\r\n\r\n// Single-table keys for the settings row\r\nconst SETTINGS_PK = \"SETTINGS\";\r\nconst SETTINGS_SK = \"GLOBAL\";\r\n\r\nconst DEFAULT_SETTINGS = {\r\n  animationsEnabled: true,\r\n  soundsEnabled: true,\r\n  autoBadgeGrant: true,\r\n  badgeRules: [] as any[],\r\n};\r\n\r\nfunction normalizeEmail(val: any): string {\r\n  return (val ?? \"\").toString().trim().toLowerCase();\r\n}\r\n\r\n// Case-insensitive admin check with dev override\r\nfunction isAdmin(identity?: AppSyncIdentity): boolean {\r\n  if (!identity) return false;\r\n\r\n  // Hard override for local/dev if you ever need it\r\n  if (SKIP_ADMIN_CHECK === \"true\") {\r\n    return true;\r\n  }\r\n\r\n  const claims = identity.claims || {};\r\n\r\n  const rawGroups =\r\n    claims[\"cognito:groups\"] ??\r\n    claims[\"custom:groups\"] ??\r\n    identity.groups ??\r\n    [];\r\n\r\n  let groups: string[] = [];\r\n\r\n  if (Array.isArray(rawGroups)) {\r\n    groups = rawGroups.map((g) => (g ?? \"\").toString());\r\n  } else if (typeof rawGroups === \"string\") {\r\n    // Could be \"ADMIN\" or \"ADMIN,OTHER\" or even '[\"ADMIN\"]'\r\n    const trimmed = rawGroups.trim();\r\n    if (trimmed.startsWith(\"[\") && trimmed.endsWith(\"]\")) {\r\n      try {\r\n        const parsed = JSON.parse(trimmed);\r\n        if (Array.isArray(parsed)) {\r\n          groups = parsed.map((g) => (g ?? \"\").toString());\r\n        }\r\n      } catch {\r\n        groups = trimmed.split(\",\");\r\n      }\r\n    } else {\r\n      groups = trimmed.split(\",\");\r\n    }\r\n  }\r\n\r\n  const wanted = ADMIN_GROUP_NAME.toUpperCase();\r\n  if (groups.some((g) => (g ?? \"\").toUpperCase() === wanted)) {\r\n    return true;\r\n  }\r\n\r\n  // Fallback: treat specific emails as super-admins (from env)\r\n  const email = normalizeEmail(\r\n    claims[\"email\"] ?? claims[\"cognito:username\"] ?? identity.username,\r\n  );\r\n  const superAdmins = SUPERADMIN_EMAILS.split(\",\")\r\n    .map(normalizeEmail)\r\n    .filter(Boolean);\r\n\r\n  if (superAdmins.includes(email)) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport const handler: AppSyncResolverHandler<any, any> = async (\r\n  event: AppSyncEvent,\r\n) => {\r\n    // We only need to know that *some* identity exists; the concrete type varies\r\n  if (!event.identity) {\r\n    throw new Error(\"Unauthorized\");\r\n  }\r\n\r\n  if (!isAdmin(event.identity as AppSyncIdentity)) {\r\n    throw new Error(\"Forbidden: admin only\");\r\n  }\r\n\r\n  if (!TABLE_NAME) {\r\n    throw new Error(\"Missing TABLE_NAME env var for settings lambda\");\r\n  }\r\n\r\n  const key = marshall({\r\n    [PK_NAME]: SETTINGS_PK,\r\n    [SK_NAME]: SETTINGS_SK,\r\n  });\r\n\r\n  switch (event.info.fieldName) {\r\n    case \"getAdminSettings\": {\r\n      const res = await client.send(\r\n        new GetItemCommand({\r\n          TableName: TABLE_NAME,\r\n          Key: key,\r\n        }),\r\n      );\r\n\r\n      if (!res.Item) {\r\n        return DEFAULT_SETTINGS;\r\n      }\r\n\r\n      const item = unmarshall(res.Item) as any;\r\n\r\n      return {\r\n        animationsEnabled:\r\n          item.animationsEnabled ?? DEFAULT_SETTINGS.animationsEnabled,\r\n        soundsEnabled: item.soundsEnabled ?? DEFAULT_SETTINGS.soundsEnabled,\r\n        autoBadgeGrant:\r\n          item.autoBadgeGrant ?? DEFAULT_SETTINGS.autoBadgeGrant,\r\n        badgeRules: item.badgeRules ?? DEFAULT_SETTINGS.badgeRules,\r\n      };\r\n    }\r\n\r\n    case \"updateAdminSettings\": {\r\n      const input = event.arguments.input || {};\r\n\r\n      const existingRes = await client.send(\r\n        new GetItemCommand({\r\n          TableName: TABLE_NAME,\r\n          Key: key,\r\n        }),\r\n      );\r\n\r\n      const existing = existingRes.Item ? unmarshall(existingRes.Item) : {};\r\n\r\n      const merged = {\r\n        ...DEFAULT_SETTINGS,\r\n        ...existing,\r\n        ...input,\r\n      };\r\n\r\n      await client.send(\r\n        new PutItemCommand({\r\n          TableName: TABLE_NAME,\r\n          Item: marshall({\r\n            [PK_NAME]: SETTINGS_PK,\r\n            [SK_NAME]: SETTINGS_SK,\r\n            ...merged,\r\n          }),\r\n        }),\r\n      );\r\n\r\n      return {\r\n        animationsEnabled: merged.animationsEnabled,\r\n        soundsEnabled: merged.soundsEnabled,\r\n        autoBadgeGrant: merged.autoBadgeGrant,\r\n        badgeRules: merged.badgeRules ?? [],\r\n      };\r\n    }\r\n\r\n    default:\r\n      throw new Error(\"Unknown field: \" + event.info.fieldName);\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["settings_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_util_dynamodb", "client", "TABLE_NAME", "PK_NAME", "SK_NAME", "ADMIN_GROUP_NAME", "SUPERADMIN_EMAILS", "SKIP_ADMIN_CHECK", "SETTINGS_PK", "SETTINGS_SK", "DEFAULT_SETTINGS", "normalizeEmail", "val", "isAdmin", "identity", "claims", "rawGroups", "groups", "g", "trimmed", "parsed", "wanted", "email", "event", "key", "res", "item", "input", "existingRes", "existing", "merged"]
}
