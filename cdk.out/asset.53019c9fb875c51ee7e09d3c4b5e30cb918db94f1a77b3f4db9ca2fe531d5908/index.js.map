{
  "version": 3,
  "sources": ["../../lambda/list/index.ts"],
  "sourcesContent": ["import { APIGatewayProxyResult } from 'aws-lambda';\r\nimport { S3Client, ListObjectsV2Command } from '@aws-sdk/client-s3';\r\n\r\n// Path-style so host stays s3.us-east-1.amazonaws.com and avoids per-bucket DNS lookups.\r\nconst s3 = new S3Client({\r\n  region: process.env.AWS_REGION || 'us-east-1',\r\n  forcePathStyle: true,\r\n});\r\n\r\nconst BUCKET = process.env.BUCKET!;\r\n\r\n// NEW: comma-separated allow-list. Examples:\r\n// \"https://d1682i07dc1r3k.cloudfront.net,https://stylingadventures.com\"\r\nconst ALLOWED_ORIGINS = String(process.env.ALLOWED_ORIGINS || '')\r\n  .split(',')\r\n  .map(s => s.trim())\r\n  .filter(Boolean);\r\n\r\n// Back-compat fallback during rollout\r\nconst WEB_ORIGIN = process.env.WEB_ORIGIN || process.env.ORIGIN || '';\r\n\r\ntype AnyEvent = any;\r\n\r\n/* -------------------- CORS helpers -------------------- */\r\nfunction pickAllowedOrigin(event: AnyEvent): string | undefined {\r\n  const reqOrigin =\r\n    event.headers?.origin || event.headers?.Origin || event.headers?.['x-origin'] || '';\r\n\r\n  if (ALLOWED_ORIGINS.length > 0) {\r\n    return ALLOWED_ORIGINS.includes(reqOrigin) ? reqOrigin : undefined;\r\n  }\r\n  return WEB_ORIGIN || undefined;\r\n}\r\n\r\nfunction baseCorsHeaders(origin?: string) {\r\n  const h: Record<string, string> = {\r\n    'Content-Type': 'application/json',\r\n    'Access-Control-Allow-Headers':\r\n      'Authorization,Content-Type,X-Amz-Date,X-Api-Key,X-Amz-Security-Token',\r\n    'Access-Control-Allow-Methods': 'GET,OPTIONS',\r\n    'Access-Control-Allow-Credentials': 'true',\r\n    Vary: 'Origin',\r\n  };\r\n  if (origin) h['Access-Control-Allow-Origin'] = origin;\r\n  return h;\r\n}\r\n\r\nfunction ok(event: AnyEvent, body: unknown, extra: Record<string, string> = {}): APIGatewayProxyResult {\r\n  const origin = pickAllowedOrigin(event);\r\n  return { statusCode: 200, headers: { ...baseCorsHeaders(origin), ...extra }, body: JSON.stringify(body) };\r\n}\r\n\r\nfunction bad(event: AnyEvent, status: number, msg: string): APIGatewayProxyResult {\r\n  const origin = pickAllowedOrigin(event);\r\n  const hasReqOrigin = !!(event.headers?.origin || event.headers?.Origin);\r\n  if (hasReqOrigin && !origin) {\r\n    // CORS request from a non-allowed origin\r\n    return { statusCode: 403, headers: baseCorsHeaders(undefined), body: JSON.stringify({ message: 'CORS: origin not allowed' }) };\r\n  }\r\n  return { statusCode: status, headers: baseCorsHeaders(origin), body: JSON.stringify({ message: msg }) };\r\n}\r\n\r\n/* -------------------- utilities -------------------- */\r\nfunction getMethod(e: AnyEvent): string {\r\n  return e.httpMethod ?? e.requestContext?.http?.method ?? 'GET';\r\n}\r\nfunction getClaims(e: AnyEvent): Record<string, any> {\r\n  return e.requestContext?.authorizer?.claims ?? e.requestContext?.authorizer?.jwt?.claims ?? {};\r\n}\r\n\r\n/* -------------------- handler -------------------- */\r\nexport const handler = async (event: AnyEvent): Promise<APIGatewayProxyResult> => {\r\n  // CORS preflight\r\n  if (getMethod(event) === 'OPTIONS') {\r\n    const origin = pickAllowedOrigin(event);\r\n    if (!origin && (event.headers?.origin || event.headers?.Origin)) {\r\n      return { statusCode: 403, headers: baseCorsHeaders(undefined), body: '' };\r\n    }\r\n    return { statusCode: 204, headers: baseCorsHeaders(origin), body: '' };\r\n  }\r\n\r\n  try {\r\n    const claims = getClaims(event);\r\n    const sub = claims?.sub as string | undefined;\r\n\r\n    const queryPrefix = (event?.queryStringParameters?.prefix ?? '')\r\n      .replace(/\\.\\./g, '')\r\n      .replace(/^[/\\\\]+/, '');\r\n\r\n    const userPrefix = sub ? `users/${sub}/` : '';\r\n    const prefix = `${userPrefix}${queryPrefix}`;\r\n\r\n    const res = await s3.send(\r\n      new ListObjectsV2Command({\r\n        Bucket: BUCKET,\r\n        Prefix: prefix || undefined,\r\n        MaxKeys: 1000,\r\n      })\r\n    );\r\n\r\n    const items = (res.Contents ?? []).map(o => ({\r\n      key: o.Key,\r\n      size: o.Size,\r\n      lastModified: o.LastModified?.toISOString?.() ?? null,\r\n    }));\r\n\r\n    return ok(event, {\r\n      prefix,\r\n      items,\r\n      isTruncated: !!res.IsTruncated,\r\n      nextToken: res.NextContinuationToken ?? null,\r\n    });\r\n  } catch (e: any) {\r\n    console.error(e);\r\n    return bad(event, 500, e?.message ?? String(e));\r\n  }\r\n};\r\n\r\n"],
  "mappings": "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",
  "names": ["list_exports", "__export", "handler", "__toCommonJS", "import_client_s3", "s3", "BUCKET", "ALLOWED_ORIGINS", "s", "WEB_ORIGIN", "pickAllowedOrigin", "event", "reqOrigin", "baseCorsHeaders", "origin", "h", "ok", "body", "extra", "bad", "status", "msg", "getMethod", "getClaims", "sub", "queryPrefix", "prefix", "res", "items", "o", "e"]
}
