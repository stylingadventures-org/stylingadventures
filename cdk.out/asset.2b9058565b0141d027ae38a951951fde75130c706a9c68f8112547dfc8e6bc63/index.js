"use strict";var I=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var L=(e,s)=>{for(var i in s)I(e,i,{get:s[i],enumerable:!0})},P=(e,s,i,r)=>{if(s&&typeof s=="object"||typeof s=="function")for(let t of h(s))!x.call(e,t)&&t!==i&&I(e,t,{get:()=>s[t],enumerable:!(r=C(s,t))||r.enumerable});return e};var U=e=>P(I({},"__esModule",{value:!0}),e);var M={};L(M,{handler:()=>V});module.exports=U(M);var y=require("crypto"),b=require("@aws-sdk/client-dynamodb"),n=require("@aws-sdk/lib-dynamodb"),S=require("@aws-sdk/client-sfn"),u=process.env.TABLE_NAME||process.env.CLOSET_TABLE||(()=>{throw new Error("Missing env TABLE_NAME/CLOSET_TABLE")})(),T=process.env.APPROVAL_SM_ARN||"",f=process.env.STATUS_GSI||"gsi2",d=n.DynamoDBDocumentClient.from(new b.DynamoDBClient({})),R=new S.SFNClient({}),E=()=>new Date().toISOString(),w=e=>{if(!e)throw new Error("Unauthenticated")},p=e=>{let i=(e?.claims||{})["cognito:groups"];return Array.isArray(i)?i.includes("ADMIN"):`${i||""}`.includes("ADMIN")},m=e=>({pk:`ITEM#${e}`,sk:"META"});function O(e){if(e)try{return JSON.parse(Buffer.from(String(e),"base64").toString("utf8"))}catch{return}}function D(e){return e?Buffer.from(JSON.stringify(e),"utf8").toString("base64"):null}function K(e){if(!e)return e;let s=typeof e?.gsi1pk=="string"&&e.gsi1pk.startsWith("OWNER#")?e.gsi1pk.slice(6):void 0,i=e.userId??e.ownerSub??s??"",r=e.ownerSub??i;return{...e,userId:i,ownerSub:r}}var A=e=>{let s=K(e);return{id:s.id,userId:s.userId,ownerSub:s.ownerSub,title:s.title??null,status:s.status,mediaKey:s.mediaKey??null,createdAt:s.createdAt,updatedAt:s.updatedAt,audience:s.audience??null}},B=new Set(["ep-001"]),V=async e=>{let s=e.info.fieldName,i=e.identity,r=i?.sub;switch(s){case"isEpisodeEarlyAccess":{let t=String(e.arguments?.id||"").trim();if(B.has(t))return{allowed:!0,reason:null};if(!r)return{allowed:!1,reason:"Sign in to check early access."};let o=(await d.send(new n.GetCommand({TableName:u,Key:{pk:`USER#${r}`,sk:"PROFILE"}}))).Item||{};if(o.bestie?.BOOL===!0||o.bestieActive?.BOOL===!0||o.tier?.S==="BESTIE"||o.tier==="BESTIE")return{allowed:!0,reason:null};try{let l=await d.send(new n.GetCommand({TableName:u,Key:{pk:`USER#${r}`,sk:"BESTIE"}}));if(l.Item?.active===!0||l.Item?.active?.BOOL===!0)return{allowed:!0,reason:null}}catch{}return{allowed:!1,reason:"This is an early drop for Bestie members."}}case"myCloset":return w(r),((await d.send(new n.QueryCommand({TableName:u,IndexName:"gsi1",KeyConditionExpression:"gsi1pk = :p",ExpressionAttributeValues:{":p":`OWNER#${r}`},ScanIndexForward:!1,Limit:50}))).Items||[]).filter(a=>a.sk==="META").map(A);case"closetFeed":{let{limit:t,nextToken:a}=e.arguments||{},o=Math.min(Math.max(Number(t)||12,1),50),c=O(a),l=await d.send(new n.QueryCommand({TableName:u,IndexName:f,KeyConditionExpression:"#gpk = :pk",ExpressionAttributeNames:{"#gpk":"gsi2pk"},ExpressionAttributeValues:{":pk":"STATUS#APPROVED"},ScanIndexForward:!1,Limit:o,ExclusiveStartKey:c}));return{items:(l.Items||[]).filter(g=>g.sk==="META").map(A).filter(g=>{let N=g.status==="APPROVED"||g.status==="PUBLISHED",k=(g.audience||"PUBLIC")==="PUBLIC";return N&&k}),nextToken:D(l.LastEvaluatedKey)}}case"createClosetItem":{w(r);let{title:t,mediaKey:a}=e.arguments||{},o=(0,y.randomUUID)(),c=E(),l={id:o,userId:r,ownerSub:r,title:(t??"").trim()||null,mediaKey:(a??"").trim()||null,status:"DRAFT",createdAt:c,updatedAt:c,audience:"PUBLIC"};return await d.send(new n.PutCommand({TableName:u,Item:{...l,...m(o),gsi1pk:`OWNER#${r}`,gsi1sk:c,gsi2pk:"STATUS#DRAFT",gsi2sk:c},ConditionExpression:"attribute_not_exists(pk)"})),l}case"updateClosetMediaKey":{w(r);let{id:t,mediaKey:a}=e.arguments,o=await d.send(new n.GetCommand({TableName:u,Key:m(t)}));if(!o.Item)throw new Error("Not found");if(o.Item.ownerSub!==r&&!p(i))throw new Error("Forbidden");let c=E(),l=await d.send(new n.UpdateCommand({TableName:u,Key:m(t),UpdateExpression:"SET mediaKey = :k, updatedAt = :u",ExpressionAttributeValues:{":k":a,":u":c},ReturnValues:"ALL_NEW"}));return A(l.Attributes)}case"requestClosetApproval":{w(r);let{id:t}=e.arguments,a=await d.send(new n.GetCommand({TableName:u,Key:m(t)}));if(!a.Item)throw new Error("Not found");if(a.Item.ownerSub!==r&&!p(i))throw new Error("Forbidden");let o=E();return await d.send(new n.UpdateCommand({TableName:u,Key:m(t),UpdateExpression:"SET #s = :p, gsi2pk = :g, gsi2sk = :ts, updatedAt = :ts",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":p":"PENDING",":g":"STATUS#PENDING",":ts":o}})),T&&await R.send(new S.StartExecutionCommand({stateMachineArn:T,input:JSON.stringify({itemId:t,ownerSub:r})})),!0}case"adminListPending":{if(!p(i))throw new Error("Not authorized");return((await d.send(new n.QueryCommand({TableName:u,IndexName:f,KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":"STATUS#PENDING"},ScanIndexForward:!1,Limit:100}))).Items||[]).map(A)}case"adminApproveItem":{if(!p(i))throw new Error("Not authorized");let{id:t}=e.arguments,a=E();return await d.send(new n.UpdateCommand({TableName:u,Key:m(t),UpdateExpression:"SET #s = :a, gsi2pk = :g, gsi2sk = :ts, updatedAt = :ts REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":a":"APPROVED",":g":"STATUS#APPROVED",":ts":a}})),!0}case"adminRejectItem":{if(!p(i))throw new Error("Not authorized");let{id:t,reason:a}=e.arguments,o=E();return await d.send(new n.UpdateCommand({TableName:u,Key:m(t),UpdateExpression:"SET #s = :r, gsi2pk = :g, gsi2sk = :ts, updatedAt = :ts, reason = :why REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":r":"REJECTED",":g":"STATUS#REJECTED",":ts":o,":why":a??"Rejected by admin"}})),!0}case"adminSetClosetAudience":{if(!p(i))throw new Error("Not authorized");let{id:t,audience:a}=e.arguments,o=E(),c=await d.send(new n.UpdateCommand({TableName:u,Key:m(t),UpdateExpression:"SET audience = :aud, updatedAt = :ts",ExpressionAttributeValues:{":aud":a,":ts":o},ReturnValues:"ALL_NEW"}));return A(c.Attributes)}case"deleteClosetItem":{w(r);let{id:t}=e.arguments,a=await d.send(new n.GetCommand({TableName:u,Key:m(t)}));if(!a.Item)throw new Error("Not found");if(a.Item.ownerSub!==r&&!p(i))throw new Error("Forbidden");return await d.send(new n.DeleteCommand({TableName:u,Key:m(t)})),!0}default:throw new Error(`Unhandled field: ${s}`)}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
