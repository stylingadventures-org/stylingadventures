"use strict";var u=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var K=Object.prototype.hasOwnProperty;var _=(e,o)=>{for(var t in o)u(e,t,{get:o[t],enumerable:!0})},A=(e,o,t,r)=>{if(o&&typeof o=="object"||typeof o=="function")for(let n of b(o))!K.call(e,n)&&n!==t&&u(e,n,{get:()=>o[n],enumerable:!(r=k(o,n))||r.enumerable});return e};var S=e=>A(u({},"__esModule",{value:!0}),e);var h={};_(h,{handler:()=>P});module.exports=S(h);var c=require("@aws-sdk/client-dynamodb"),f=require("@aws-sdk/client-s3"),T="https://api.remove.bg/v1.0/removebg",y=new c.DynamoDBClient({}),w=new f.S3Client({}),p=process.env.TABLE_NAME,v=process.env.RAW_MEDIA_GSI_NAME||"rawMediaKeyIndex",l=process.env.REMOVE_BG_API_KEY,M=process.env.OUTPUT_BUCKET||"";if(!p)throw new Error("Missing env: TABLE_NAME");if(!l)throw new Error("Missing env: REMOVE_BG_API_KEY");async function O(e){return e?Buffer.isBuffer(e)?e:await new Promise((o,t)=>{let r=[];e.on("data",n=>r.push(n)),e.on("error",t),e.on("end",()=>o(Buffer.concat(r)))}):Buffer.alloc(0)}async function I(e){let{bucket:o,key:t,destKeyPrefix:r}=e,n=await w.send(new f.GetObjectCommand({Bucket:o,Key:t})),a=await O(n.Body),s=new FormData;s.set("size","auto"),s.set("format","png"),s.set("image_file",new Blob([a]),"original.png");let i=await fetch(T,{method:"POST",headers:{"X-Api-Key":l},body:s});if(!i.ok){let B=await i.text().catch(()=>"");throw console.error("remove.bg failed:",i.status,B),new Error(`remove.bg failed (${i.status})`)}let d=await i.arrayBuffer(),m=Buffer.from(d),E=M||o,g=`${r.replace(/\/+$/,"")}/removed-bg.png`;return await w.send(new f.PutObjectCommand({Bucket:E,Key:g,Body:m,ContentType:"image/png"})),g}var P=async e=>{for(let o of e.Records??[])try{let t=decodeURIComponent(o.s3.object.key.replace(/\+/g," ")),r=o.s3.bucket.name,a=(await y.send(new c.QueryCommand({TableName:p,IndexName:v,KeyConditionExpression:"rawMediaKey = :rk",ExpressionAttributeValues:{":rk":{S:t}},Limit:1}))).Items?.[0];if(!a){console.log("[bg-worker] no closet item found for rawMediaKey",t);continue}let s=a.pk?.S||"",i=a.sk?.S||"META",d=a.id?.S||s.replace(/^ITEM#/,"");if(!s){console.warn("[bg-worker] item missing pk; skipping",JSON.stringify(a));continue}console.log("[bg-worker] processing closet item",d,"rawMediaKey=",t);let m=await I({bucket:r,key:t,destKeyPrefix:`uploads/closet/${d}`});await y.send(new c.UpdateItemCommand({TableName:p,Key:{pk:{S:s},sk:{S:i}},UpdateExpression:"SET mediaKey = :mk, updatedAt = :u",ExpressionAttributeValues:{":mk":{S:m},":u":{S:new Date().toISOString()}}})),console.log("[bg-worker] updated item",d,"with mediaKey",m)}catch(t){console.error("[bg-worker] error processing record",t?.message||t)}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
