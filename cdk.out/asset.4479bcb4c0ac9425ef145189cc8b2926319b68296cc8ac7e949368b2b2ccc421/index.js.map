{
  "version": 3,
  "sources": ["../../lambda/closet/bg-worker.ts"],
  "sourcesContent": ["// lambda/closet/bg-worker.ts\r\nimport type { S3Event } from \"aws-lambda\";\r\nimport {\r\n  DynamoDBClient,\r\n  QueryCommand,\r\n  UpdateItemCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  S3Client,\r\n  GetObjectCommand,\r\n  PutObjectCommand,\r\n} from \"@aws-sdk/client-s3\";\r\n\r\nconst REMOVE_BG_ENDPOINT = \"https://api.remove.bg/v1.0/removebg\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\nconst s3 = new S3Client({});\r\n\r\n// ---- env vars (set in CDK / CloudFormation, NOT in code) ----\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\nconst RAW_INDEX = process.env.RAW_MEDIA_GSI_NAME || \"rawMediaKeyIndex\";\r\nconst REMOVE_BG_API_KEY = process.env.REMOVE_BG_API_KEY!;\r\nconst OUTPUT_BUCKET = process.env.OUTPUT_BUCKET || \"\"; // optional override\r\n\r\nif (!TABLE_NAME) throw new Error(\"Missing env: TABLE_NAME\");\r\nif (!REMOVE_BG_API_KEY) throw new Error(\"Missing env: REMOVE_BG_API_KEY\");\r\n\r\ntype RemoveBgOpts = {\r\n  bucket: string;\r\n  key: string;\r\n  destKeyPrefix: string;\r\n};\r\n\r\n/** Convert S3 stream to Buffer */\r\nasync function streamToBuffer(stream: any): Promise<Buffer> {\r\n  if (!stream) return Buffer.alloc(0);\r\n  if (Buffer.isBuffer(stream)) return stream;\r\n\r\n  return await new Promise<Buffer>((resolve, reject) => {\r\n    const chunks: Buffer[] = [];\r\n    stream.on(\"data\", (chunk: Buffer) => chunks.push(chunk));\r\n    stream.on(\"error\", reject);\r\n    stream.on(\"end\", () => resolve(Buffer.concat(chunks)));\r\n  });\r\n}\r\n\r\n/**\r\n * Download original from S3, send to remove.bg, upload cleaned PNG to S3.\r\n * Returns the final S3 key for the cleaned image.\r\n */\r\nasync function removeBackgroundForS3Object(\r\n  opts: RemoveBgOpts,\r\n): Promise<string> {\r\n  const { bucket, key, destKeyPrefix } = opts;\r\n\r\n  // 1) Download original from S3\r\n  const getRes = await s3.send(\r\n    new GetObjectCommand({\r\n      Bucket: bucket,\r\n      Key: key,\r\n    }),\r\n  );\r\n  const originalBuf = await streamToBuffer(getRes.Body as any);\r\n\r\n  // 2) Build multipart/form-data request to remove.bg\r\n  const form = new FormData();\r\n  form.set(\"size\", \"auto\");\r\n  form.set(\"format\", \"png\");\r\n  form.set(\"image_file\", new Blob([originalBuf]), \"original.png\");\r\n\r\n  const resp = await fetch(REMOVE_BG_ENDPOINT, {\r\n    method: \"POST\",\r\n    headers: {\r\n      \"X-Api-Key\": REMOVE_BG_API_KEY,\r\n    },\r\n    body: form as any,\r\n  });\r\n\r\n  if (!resp.ok) {\r\n    const text = await resp.text().catch(() => \"\");\r\n    console.error(\"remove.bg failed:\", resp.status, text);\r\n    throw new Error(`remove.bg failed (${resp.status})`);\r\n  }\r\n\r\n  const cleanedArrayBuf = await resp.arrayBuffer();\r\n  const cleanedBuf = Buffer.from(cleanedArrayBuf);\r\n\r\n  // 3) Upload cleaned PNG back to S3\r\n  const outBucket = OUTPUT_BUCKET || bucket;\r\n  const finalKey = `${destKeyPrefix.replace(/\\/+$/, \"\")}/removed-bg.png`;\r\n\r\n  await s3.send(\r\n    new PutObjectCommand({\r\n      Bucket: outBucket,\r\n      Key: finalKey,\r\n      Body: cleanedBuf,\r\n      ContentType: \"image/png\",\r\n    }),\r\n  );\r\n\r\n  return finalKey;\r\n}\r\n\r\nexport const handler = async (event: S3Event) => {\r\n  for (const record of event.Records ?? []) {\r\n    try {\r\n      const key = decodeURIComponent(\r\n        record.s3.object.key.replace(/\\+/g, \" \"),\r\n      );\r\n      const bucket = record.s3.bucket.name;\r\n\r\n      // 1) Find closet item by rawMediaKey\r\n      const q = await ddb.send(\r\n        new QueryCommand({\r\n          TableName: TABLE_NAME,\r\n          IndexName: RAW_INDEX,\r\n          KeyConditionExpression: \"rawMediaKey = :rk\",\r\n          ExpressionAttributeValues: { \":rk\": { S: key } },\r\n          Limit: 1,\r\n        }),\r\n      );\r\n\r\n      const item = q.Items?.[0];\r\n      if (!item) {\r\n        console.log(\"[bg-worker] no closet item found for rawMediaKey\", key);\r\n        continue;\r\n      }\r\n\r\n      const pk = item.pk?.S || \"\";\r\n      const sk = item.sk?.S || \"META\";\r\n      const id = item.id?.S || pk.replace(/^ITEM#/, \"\");\r\n\r\n      if (!pk) {\r\n        console.warn(\"[bg-worker] item missing pk; skipping\", JSON.stringify(item));\r\n        continue;\r\n      }\r\n\r\n      console.log(\r\n        \"[bg-worker] processing closet item\",\r\n        id,\r\n        \"rawMediaKey=\",\r\n        key,\r\n      );\r\n\r\n      // 2) Call remove.bg\r\n      const finalKey = await removeBackgroundForS3Object({\r\n        bucket,\r\n        key,\r\n        destKeyPrefix: `uploads/closet/${id}`,\r\n      });\r\n\r\n      // 3) Update DynamoDB item with final mediaKey\r\n      await ddb.send(\r\n        new UpdateItemCommand({\r\n          TableName: TABLE_NAME,\r\n          Key: { pk: { S: pk }, sk: { S: sk } },\r\n          UpdateExpression: \"SET mediaKey = :mk, updatedAt = :u\",\r\n          ExpressionAttributeValues: {\r\n            \":mk\": { S: finalKey },\r\n            \":u\": { S: new Date().toISOString() },\r\n          },\r\n        }),\r\n      );\r\n\r\n      console.log(\r\n        \"[bg-worker] updated item\",\r\n        id,\r\n        \"with mediaKey\",\r\n        finalKey,\r\n      );\r\n    } catch (e: any) {\r\n      console.error(\r\n        \"[bg-worker] error processing record\",\r\n        e?.message || e,\r\n      );\r\n      // move on to next record\r\n    }\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["bg_worker_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_client_s3", "REMOVE_BG_ENDPOINT", "ddb", "s3", "TABLE_NAME", "RAW_INDEX", "REMOVE_BG_API_KEY", "OUTPUT_BUCKET", "streamToBuffer", "stream", "resolve", "reject", "chunks", "chunk", "removeBackgroundForS3Object", "opts", "bucket", "key", "destKeyPrefix", "getRes", "originalBuf", "form", "resp", "text", "cleanedArrayBuf", "cleanedBuf", "outBucket", "finalKey", "event", "record", "item", "pk", "sk", "id", "e"]
}
