"use strict";var R=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var P=Object.prototype.hasOwnProperty;var B=(e,t)=>{for(var s in t)R(e,s,{get:t[s],enumerable:!0})},v=(e,t,s,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of O(t))!P.call(e,i)&&i!==s&&R(e,i,{get:()=>t[i],enumerable:!(n=M(t,i))||n.enumerable});return e};var h=e=>v(R({},"__esModule",{value:!0}),e);var J={};B(J,{handler:()=>j});module.exports=h(J);var U=require("@aws-sdk/client-dynamodb"),r=require("@aws-sdk/lib-dynamodb"),T=require("@aws-sdk/client-lambda");var u=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!u)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var E=r.DynamoDBDocumentClient.from(new U.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),F=new T.LambdaClient({}),S=process.env.AWARD_PRIME_COINS_FN_NAME||"";async function $(e,t,s,n){if(!S){console.warn("AWARD_PRIME_COINS_FN_NAME not set; skipping Prime Bank award");return}if(t<=0)return;let i={userId:e,amount:t,source:s,notes:n},o=new T.InvokeCommand({FunctionName:S,InvocationType:"Event",Payload:Buffer.from(JSON.stringify(i))});await F.send(o).catch(a=>{console.error("Failed to invoke AwardPrimeCoinsFn",a)})}function V(e){let t=e?.groups;return Array.isArray(t)?t.includes("ADMIN")||t.includes("PRIME"):!1}function z(e,t){if(!t?.sub)throw new Error("Unauthenticated");if(!V(t)&&t.sub!==e)throw new Error("Forbidden")}function Y(e){let t=e?.claims||{},s=t.tier??t["custom:tier"];if(s&&["FREE","BESTIE","CREATOR","COLLAB","ADMIN","PRIME"].includes(s))return s;let i=t["cognito:groups"],o=Array.isArray(i)?i:String(i||"").split(",").map(a=>a.trim()).filter(Boolean);return o.includes("ADMIN")?"ADMIN":o.includes("PRIME")?"PRIME":o.includes("CREATOR")?"CREATOR":o.includes("COLLAB")?"COLLAB":o.includes("BESTIE")?"BESTIE":"FREE"}function G(e){if(e==null)return null;if(typeof e=="string")try{return JSON.parse(e)}catch{return{raw:e}}return typeof e=="object"?e:{value:e}}function X(e){let t=1,s=100,n=e|0;for(;n>=s;)n-=s,t++,s+=50;return t}function I(e,t=12){return Math.max(0,e|0).toString().padStart(t,"0")}function W(e,t){if(!e||!t)return!1;let s=new Date(e),n=new Date(t);return s.getUTCFullYear()===n.getUTCFullYear()&&s.getUTCMonth()===n.getUTCMonth()&&s.getUTCDate()===n.getUTCDate()}function K(e,t){let s=new Date(e),n=new Date(t),i=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()-1));return s.getUTCFullYear()===i.getUTCFullYear()&&s.getUTCMonth()===i.getUTCMonth()&&s.getUTCDate()===i.getUTCDate()}var j=async e=>{let{fieldName:t}=e.info,s=e.identity;if(t==="logGameEvent"){if(!s?.sub)throw new Error("Unauthenticated");let n=s.sub,i=new Date().toISOString(),o=e.arguments?.input??{},a=o.type||"UNKNOWN",g=G(o.metadata);if(Y(s)==="FREE")return{success:!0,xp:0,coins:0,newXP:0,newCoins:0,lastEventAt:i};if(a==="DAILY_LOGIN"){let C=await E.send(new r.GetCommand({TableName:u,Key:{pk:`USER#${n}`,sk:"PROFILE"},ProjectionExpression:"lastLoginAt, streakCount, xp, coins, badges, displayName, lastEventAt"})),f=C.Item?.lastLoginAt,w=typeof f=="string"?f:typeof f=="number"?new Date(f).toISOString():void 0,c=Number(C.Item?.streakCount??0),L=1,m=0;w&&W(w,i)?(L=0,m=0):w&&K(w,i)?c+=1:c=1,L=c>0?10+Math.min(5,c):0,m=c>0?1:0;let y=await E.send(new r.UpdateCommand({TableName:u,Key:{pk:`USER#${n}`,sk:"PROFILE"},UpdateExpression:`
            SET xp = if_not_exists(xp,:z) + :xi,
                coins = if_not_exists(coins,:z) + :ci,
                lastEventAt = :now,
                lastLoginAt = :now,
                streakCount = :st
          `.replace(/\s+/g," "),ExpressionAttributeValues:{":z":0,":xi":L,":ci":m,":now":i,":st":c},ReturnValues:"ALL_NEW"})),b=Number(y.Attributes?.xp??0),D=Number(y.Attributes?.coins??0),k=y.Attributes?.lastEventAt??i;return await E.send(new r.PutCommand({TableName:u,Item:{pk:`USER#${n}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${I(b)}#${n}`,xp:b,coins:D,streakCount:c,updatedAt:i,type:"LEADER"}})),await $(n,m,"DAILY_LOGIN",`streak=${c}`),{success:!0,xp:b,coins:D,newXP:L,newCoins:m,lastEventAt:k}}let p=a==="LEVEL_CLEAR"?50:a==="SHARE"?5:a==="STYLE_IT"?Math.max(1,Math.round((g?.score??5)/5)):1,A=a==="LEVEL_CLEAR"?5:0,d=await E.send(new r.UpdateCommand({TableName:u,Key:{pk:`USER#${n}`,sk:"PROFILE"},UpdateExpression:`
          SET xp = if_not_exists(xp,:z) + :xi,
              coins = if_not_exists(coins,:z) + :ci,
              lastEventAt = :now
        `.replace(/\s+/g," "),ExpressionAttributeValues:{":z":0,":xi":p,":ci":A,":now":i},ReturnValues:"ALL_NEW"})),N=Number(d.Attributes?.xp??0),x=Number(d.Attributes?.coins??0),_=d.Attributes?.lastEventAt??i;return await E.send(new r.PutCommand({TableName:u,Item:{pk:`USER#${n}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${I(N)}#${n}`,xp:N,coins:x,updatedAt:i,type:"LEADER"}})),await E.send(new r.PutCommand({TableName:u,Item:{pk:`USER#${n}`,sk:`EVENT#${Date.now()}`,type:"EVENT",evType:a,metadata:g,at:i},ConditionExpression:"attribute_not_exists(pk)"})).catch(()=>{}),{success:!0,xp:N,coins:x,newXP:p,newCoins:A,lastEventAt:_}}if(t==="awardCoins"){let{userId:n,coins:i,xp:o}=e.arguments.input;z(n,s);let a=Math.max(0,i|0),g=Math.max(0,(o??0)|0),l=await E.send(new r.UpdateCommand({TableName:u,Key:{pk:`USER#${n}`,sk:"PROFILE"},UpdateExpression:"SET coins = if_not_exists(coins,:z) + :c, xp = if_not_exists(xp,:z) + :x",ExpressionAttributeValues:{":z":0,":c":a,":x":g},ReturnValues:"ALL_NEW"})),p=Number(l.Attributes?.xp??0),A=Number(l.Attributes?.coins??0),d=l.Attributes?.lastEventAt??null;return await E.send(new r.PutCommand({TableName:u,Item:{pk:`USER#${n}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${I(p)}#${n}`,xp:p,coins:A,updatedAt:new Date().toISOString(),type:"LEADER"}})),{userId:n,displayName:l.Attributes?.displayName||null,level:X(p),xp:p,coins:A,badges:Array.isArray(l.Attributes?.badges)?l.Attributes.badges:[],lastEventAt:d}}throw new Error(`Unknown field ${t}`)};0&&(module.exports={handler});
