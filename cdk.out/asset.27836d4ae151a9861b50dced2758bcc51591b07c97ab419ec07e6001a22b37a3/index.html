<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>StylingAdventures</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="alternate icon" href="/favicon.ico" /> <!-- optional fallback -->
</head>
<body class="sa-body">
  <header class="sa-header">
    <h1>StylingAdventures</h1>
    <nav class="sa-actions">
      <a id="signout" class="sa-btn sa-btn-outline" href="/logout/index.html">Sign out</a>
      <!-- New: global sign-out button -->
      <button id="signout-global" class="sa-btn sa-btn-outline">Sign out everywhere</button>
    </nav>
  </header>

  <main class="sa-main">
    <section class="sa-card">
      <h2>Status</h2>
      <div id="status" class="sa-mono sa-subtle">Checking…</div>

      <!-- New: token timer widget appears under Status -->
      <div id="token-timer" class="sa-subtle"></div>
    </section>

    <section class="sa-card">
      <h3>Debug</h3>
      <pre id="debug" class="sa-pre sa-scroll"></pre>
    </section>
  </main>

  <!-- Token timer widget -->
  <script type="module">
    const $ = (s)=>document.querySelector(s);
    const pad = (n)=>String(n).padStart(2,'0');
    const parseJwt = (t)=>JSON.parse(atob(t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));

    function updateTimer() {
      try {
        const raw = sessionStorage.getItem('tokens');
        if (!raw) { $('#token-timer').textContent = ''; return; }
        const t = JSON.parse(raw);
        const { exp } = parseJwt(t.id_token);
        const now = Math.floor(Date.now()/1000);
        const secs = Math.max(0, exp - now);
        const h = Math.floor(secs/3600), m = Math.floor((secs%3600)/60), s = secs%60;

        // our refresh is scheduled ~5 min before expiry
        const refreshEta = Math.max(0, secs - 300);
        const rh = Math.floor(refreshEta/3600), rm = Math.floor((refreshEta%3600)/60), rs = refreshEta%60;

        $('#token-timer').textContent =
          `ID token expires in ${pad(h)}:${pad(m)}:${pad(s)} · auto-refresh in ${pad(rh)}:${pad(rm)}:${pad(rs)}`;
      } catch {
        $('#token-timer').textContent = '';
      }
    }

    updateTimer();
    setInterval(updateTimer, 1000);
  </script>

  <!-- Global sign-out widget -->
  <script type="module">
    // Best-effort global sign-out:
    // 1) Revoke refresh token (if present)
    // 2) Clear session storage
    // 3) Redirect to Cognito Hosted UI logout to clear Cognito cookies
    async function signOutEverywhere() {
      try {
        const cfg = await fetch('/config.json', { cache: 'no-store' }).then(r => r.json());
        const domain = `https://${cfg.domain}.auth.${cfg.region}.amazoncognito.com`;
        const clientId = cfg.clientId;

        // Try token revocation (RFC 7009). Works without client secret for public clients.
        const refresh = sessionStorage.getItem('refresh_token') ||
                        (JSON.parse(sessionStorage.getItem('tokens') || '{}').refresh_token);
        if (refresh) {
          const body = new URLSearchParams({
            token: refresh,
            token_type_hint: 'refresh_token',
            client_id: clientId,
          });
          // Ignore errors—still proceed to clear and redirect
          await fetch(`${domain}/oauth2/revoke`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body
          }).catch(() => {});
        }
      } finally {
        // Clear local session and bounce to Cognito logout (clears Cognito cookies)
        const cfg = await fetch('/config.json', { cache: 'no-store' }).then(r => r.json());
        sessionStorage.clear();
        const logoutUrl =
          `https://${cfg.domain}.auth.${cfg.region}.amazoncognito.com/logout` +
          `?client_id=${encodeURIComponent(cfg.clientId)}` +
          `&logout_uri=${encodeURIComponent(cfg.logoutUri)}`;
        window.location.replace(logoutUrl);
      }
    }

    document.getElementById('signout-global')
      ?.addEventListener('click', (e) => { e.preventDefault(); signOutEverywhere(); });

    // Lightweight "Status" fill-in (optional)
    (function showStatus() {
      const el = document.getElementById('status');
      try {
        const raw = sessionStorage.getItem('tokens');
        if (!raw) { el.textContent = 'Not signed in'; return; }
        const { id_token } = JSON.parse(raw);
        const claims = JSON.parse(atob(id_token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));
        el.textContent = `Signed in as ${claims.email || claims.username || claims.sub}`;
        document.getElementById('debug').textContent = JSON.stringify(claims, null, 2);
      } catch {
        el.textContent = 'Signed in';
      }
    })();
  </script>
</body>
</html>
