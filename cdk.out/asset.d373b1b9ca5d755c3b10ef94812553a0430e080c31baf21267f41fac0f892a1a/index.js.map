{
  "version": 3,
  "sources": ["../../lambda/admin/fan-closet-upload.ts"],
  "sourcesContent": ["import { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport { DynamoDBDocumentClient, PutCommand } from \"@aws-sdk/lib-dynamodb\";\r\nimport { SFNClient, StartExecutionCommand } from \"@aws-sdk/client-sfn\";\r\nimport { randomUUID } from \"crypto\";\r\n\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}), {\r\n  marshallOptions: { removeUndefinedValues: true },\r\n});\r\nconst sfn = new SFNClient({});\r\n\r\nconst {\r\n  TABLE_NAME = \"\",\r\n  PK_NAME = \"pk\",\r\n  SK_NAME = \"sk\",\r\n\r\n  // Fan approval state machine (WAIT_FOR_TASK_TOKEN)\r\n  FAN_APPROVAL_SM_ARN = \"\",\r\n\r\n  // Optional defaults\r\n  DEFAULT_AUDIENCE = \"PUBLIC\",\r\n  DEFAULT_STATUS = \"PENDING\",\r\n} = process.env;\r\n\r\nif (!TABLE_NAME) throw new Error(\"Missing env: TABLE_NAME\");\r\nif (!FAN_APPROVAL_SM_ARN) throw new Error(\"Missing env: FAN_APPROVAL_SM_ARN\");\r\n\r\ntype HttpEvent = {\r\n  headers?: Record<string, string | undefined>;\r\n  requestContext?: any;\r\n  body?: string | null;\r\n  isBase64Encoded?: boolean;\r\n};\r\n\r\nfunction json(statusCode: number, payload: any) {\r\n  return {\r\n    statusCode,\r\n    headers: {\r\n      \"content-type\": \"application/json\",\r\n      \"access-control-allow-origin\": \"*\",\r\n      \"access-control-allow-methods\": \"OPTIONS,POST\",\r\n      \"access-control-allow-headers\": \"*\",\r\n    },\r\n    body: JSON.stringify(payload),\r\n  };\r\n}\r\n\r\nfunction nowIso() {\r\n  return new Date().toISOString();\r\n}\r\n\r\nfunction requireString(v: any, name: string) {\r\n  if (typeof v !== \"string\" || !v.trim()) {\r\n    throw new Error(`${name} is required`);\r\n  }\r\n  return v.trim();\r\n}\r\n\r\nfunction safeParseBody(event: HttpEvent): any {\r\n  if (!event.body) return {};\r\n  try {\r\n    const raw = event.isBase64Encoded\r\n      ? Buffer.from(event.body, \"base64\").toString(\"utf8\")\r\n      : event.body;\r\n    return JSON.parse(raw);\r\n  } catch {\r\n    throw new Error(\"Invalid JSON body\");\r\n  }\r\n}\r\n\r\n/**\r\n * Admin Fan Closet Upload\r\n *\r\n * Expected request body:\r\n * {\r\n *   \"title\": \"Cute fit\",\r\n *   \"s3Key\": \"closet/raw/abc.jpg\",        // OR rawMediaKey\r\n *   \"rawMediaKey\": \"closet/raw/abc.jpg\", // optional alias\r\n *   \"ownerSub\": \"cognito-sub-of-owner\",  // required unless JWT provides caller sub\r\n *   \"audience\": \"PUBLIC\",                // optional (defaults to DEFAULT_AUDIENCE)\r\n *   \"category\": \"...\",                   // optional\r\n *   \"subcategory\": \"...\",                // optional\r\n *   \"season\": \"...\",                     // optional\r\n *   \"vibes\": \"...\",                      // optional\r\n *   \"description\": \"...\",                // optional\r\n *   \"story\": \"...\",                      // optional\r\n *   \"id\": \"optional-item-id\"             // optional; otherwise generated\r\n * }\r\n *\r\n * Response:\r\n * {\r\n *   \"ok\": true,\r\n *   \"itemId\": \"...\",\r\n *   \"executionArn\": \"...\",\r\n *   \"status\": \"PENDING\"\r\n * }\r\n */\r\nexport const handler = async (event: HttpEvent) => {\r\n  // CORS preflight\r\n  const method =\r\n    event.requestContext?.http?.method ||\r\n    event.requestContext?.httpMethod ||\r\n    \"\";\r\n  if (method === \"OPTIONS\") {\r\n    return json(200, { ok: true });\r\n  }\r\n\r\n  try {\r\n    const body = safeParseBody(event);\r\n\r\n    const title = requireString(body.title, \"title\");\r\n\r\n    const s3Key = requireString(\r\n      body.s3Key ?? body.rawMediaKey,\r\n      \"s3Key/rawMediaKey\",\r\n    );\r\n\r\n    // If your HTTP API has JWT auth, you'll often have a sub here:\r\n    const callerSub =\r\n      event.requestContext?.authorizer?.jwt?.claims?.sub ||\r\n      event.requestContext?.authorizer?.claims?.sub ||\r\n      event.requestContext?.authorizer?.principalId ||\r\n      null;\r\n\r\n    // Admin is uploading \"for\" a closet owner.\r\n    // If you don't pass ownerSub, we fall back to callerSub (useful for dev).\r\n    const ownerSub = String(body.ownerSub || callerSub || \"\").trim();\r\n    if (!ownerSub) {\r\n      throw new Error(\r\n        \"ownerSub is required (or configure JWT auth so caller sub is available)\",\r\n      );\r\n    }\r\n\r\n    const id = (body.id && String(body.id).trim()) || randomUUID();\r\n    const now = nowIso();\r\n\r\n    const audience =\r\n      (body.audience && String(body.audience).trim()) || DEFAULT_AUDIENCE;\r\n\r\n    const status = String(DEFAULT_STATUS || \"PENDING\").trim() || \"PENDING\";\r\n\r\n    // Single-table admin namespace:\r\n    // pk=ITEM#<id>, sk=META\r\n    const itemPk = `ITEM#${id}`;\r\n    const itemSk = \"META\";\r\n\r\n    // Put item meta (PENDING) \u2014 NotifyAdminFn will later store taskToken on this record\r\n    await ddb.send(\r\n      new PutCommand({\r\n        TableName: TABLE_NAME,\r\n        Item: {\r\n          [PK_NAME]: itemPk,\r\n          [SK_NAME]: itemSk,\r\n\r\n          id,\r\n          ownerSub,\r\n\r\n          // Fan approval pipeline expects the raw upload key\r\n          rawMediaKey: s3Key,\r\n\r\n          title,\r\n          status,\r\n\r\n          // Index keys (keep as-is if your admin list uses gsi2; otherwise switch to gsi1 in one place consistently)\r\n          gsi2pk: `STATUS#${status}`,\r\n          gsi2sk: now,\r\n\r\n          createdAt: now,\r\n          updatedAt: now,\r\n\r\n          favoriteCount: 0,\r\n\r\n          audience,\r\n\r\n          category: body.category ? String(body.category) : undefined,\r\n          subcategory: body.subcategory ? String(body.subcategory) : undefined,\r\n          season: body.season ? String(body.season) : undefined,\r\n          vibes: body.vibes ? String(body.vibes) : undefined,\r\n          description: body.description ? String(body.description) : undefined,\r\n          story: body.story ? String(body.story) : undefined,\r\n        },\r\n\r\n        // Avoid overwriting if same id is re-used\r\n        ConditionExpression: \"attribute_not_exists(#pk)\",\r\n        ExpressionAttributeNames: {\r\n          \"#pk\": PK_NAME,\r\n        },\r\n      }),\r\n    );\r\n\r\n    // Start Fan approval state machine (WAIT_FOR_TASK_TOKEN flow)\r\n    const exec = await sfn.send(\r\n      new StartExecutionCommand({\r\n        stateMachineArn: FAN_APPROVAL_SM_ARN,\r\n        input: JSON.stringify({\r\n          item: {\r\n            id,\r\n            ownerSub,\r\n            userId: ownerSub, // compatibility\r\n            s3Key, // required by SegmentOutfit task in your SM\r\n          },\r\n        }),\r\n      }),\r\n    );\r\n\r\n    return json(201, {\r\n      ok: true,\r\n      itemId: id,\r\n      executionArn: exec.executionArn,\r\n      status,\r\n    });\r\n  } catch (err: any) {\r\n    console.error(\"fan-closet-upload error\", err);\r\n    const message = err?.message || \"Unknown error\";\r\n\r\n    const isBadRequest =\r\n      /required|invalid json|missing env|unauthorized/i.test(message);\r\n\r\n    return json(isBadRequest ? 400 : 500, {\r\n      ok: false,\r\n      error: message,\r\n    });\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["fan_closet_upload_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "import_client_sfn", "import_crypto", "ddb", "sfn", "TABLE_NAME", "PK_NAME", "SK_NAME", "FAN_APPROVAL_SM_ARN", "DEFAULT_AUDIENCE", "DEFAULT_STATUS", "json", "statusCode", "payload", "nowIso", "requireString", "v", "name", "safeParseBody", "event", "raw", "body", "title", "s3Key", "callerSub", "ownerSub", "id", "now", "audience", "status", "itemPk", "itemSk", "exec", "err", "message", "isBadRequest"]
}
