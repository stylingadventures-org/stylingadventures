"use strict";var m=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var P=(t,r)=>{for(var e in r)m(t,e,{get:r[e],enumerable:!0})},T=(t,r,e,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of C(r))!M.call(t,n)&&n!==e&&m(t,n,{get:()=>r[n],enumerable:!(o=I(r,n))||o.enumerable});return t};var x=t=>T(m({},"__esModule",{value:!0}),t);var L={};P(L,{handler:()=>K});module.exports=x(L);var g=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb"),d=require("@aws-sdk/client-sfn"),S=require("crypto"),_=a.DynamoDBDocumentClient.from(new g.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),D=new d.SFNClient({}),{TABLE_NAME:p="",PK_NAME:y="pk",SK_NAME:O="sk",FAN_APPROVAL_SM_ARN:w="",DEFAULT_AUDIENCE:k="PUBLIC",DEFAULT_STATUS:q="PENDING"}=process.env;if(!p)throw new Error("Missing env: TABLE_NAME");if(!w)throw new Error("Missing env: FAN_APPROVAL_SM_ARN");function l(t,r){return{statusCode:t,headers:{"content-type":"application/json","access-control-allow-origin":"*","access-control-allow-methods":"OPTIONS,POST","access-control-allow-headers":"*"},body:JSON.stringify(r)}}function B(){return new Date().toISOString()}function f(t,r){if(typeof t!="string"||!t.trim())throw new Error(`${r} is required`);return t.trim()}function U(t){if(!t.body)return{};try{let r=t.isBase64Encoded?Buffer.from(t.body,"base64").toString("utf8"):t.body;return JSON.parse(r)}catch{throw new Error("Invalid JSON body")}}var K=async t=>{if((t.requestContext?.http?.method||t.requestContext?.httpMethod||"")==="OPTIONS")return l(200,{ok:!0});try{let e=U(t),o=f(e.title,"title"),n=f(e.s3Key??e.rawMediaKey,"s3Key/rawMediaKey"),b=t.requestContext?.authorizer?.jwt?.claims?.sub||t.requestContext?.authorizer?.claims?.sub||t.requestContext?.authorizer?.principalId||null,i=String(e.ownerSub||b||"").trim();if(!i)throw new Error("ownerSub is required (or configure JWT auth so caller sub is available)");let s=e.id&&String(e.id).trim()||(0,S.randomUUID)(),u=B(),E=e.audience&&String(e.audience).trim()||k,c=String(q||"PENDING").trim()||"PENDING",A=`ITEM#${s}`,h="META";await _.send(new a.PutCommand({TableName:p,Item:{[y]:A,[O]:h,id:s,ownerSub:i,rawMediaKey:n,title:o,status:c,gsi2pk:`STATUS#${c}`,gsi2sk:u,createdAt:u,updatedAt:u,favoriteCount:0,audience:E,category:e.category?String(e.category):void 0,subcategory:e.subcategory?String(e.subcategory):void 0,season:e.season?String(e.season):void 0,vibes:e.vibes?String(e.vibes):void 0,description:e.description?String(e.description):void 0,story:e.story?String(e.story):void 0},ConditionExpression:"attribute_not_exists(#pk)",ExpressionAttributeNames:{"#pk":y}}));let N=await D.send(new d.StartExecutionCommand({stateMachineArn:w,input:JSON.stringify({item:{id:s,ownerSub:i,userId:i,s3Key:n}})}));return l(201,{ok:!0,itemId:s,executionArn:N.executionArn,status:c})}catch(e){console.error("fan-closet-upload error",e);let o=e?.message||"Unknown error",n=/required|invalid json|missing env|unauthorized/i.test(o);return l(n?400:500,{ok:!1,error:o})}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
