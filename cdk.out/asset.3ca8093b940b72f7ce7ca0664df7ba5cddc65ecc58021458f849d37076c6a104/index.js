"use strict";var S=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var h=Object.prototype.hasOwnProperty;var x=(e,t)=>{for(var d in t)S(e,d,{get:t[d],enumerable:!0})},C=(e,t,d,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of k(t))!h.call(e,s)&&s!==d&&S(e,s,{get:()=>t[s],enumerable:!(n=N(t,s))||n.enumerable});return e};var R=e=>C(S({},"__esModule",{value:!0}),e);var B={};x(B,{handler:()=>U});module.exports=R(B);var y=require("crypto"),I=require("@aws-sdk/client-dynamodb"),r=require("@aws-sdk/lib-dynamodb"),A=require("@aws-sdk/client-sfn"),o=process.env.TABLE_NAME||process.env.CLOSET_TABLE||(()=>{throw new Error("Missing env TABLE_NAME/CLOSET_TABLE")})(),T=process.env.APPROVAL_SM_ARN||"",f=process.env.STATUS_GSI||"gsi2",u=r.DynamoDBDocumentClient.from(new I.DynamoDBClient({})),D=new A.SFNClient({}),p=()=>new Date().toISOString(),E=e=>{if(!e)throw new Error("Unauthenticated")},g=e=>{let t=e?.claims?.["cognito:groups"];return Array.isArray(t)?t.includes("ADMIN"):`${t||""}`.includes("ADMIN")},m=e=>({pk:`ITEM#${e}`,sk:"META"});function K(e){if(e)try{return JSON.parse(Buffer.from(String(e),"base64").toString("utf8"))}catch{return}}function O(e){return e?Buffer.from(JSON.stringify(e),"utf8").toString("base64"):null}function L(e){if(!e)return e;let t=typeof e?.gsi1pk=="string"&&e.gsi1pk.startsWith("OWNER#")?e.gsi1pk.slice(6):void 0,d=e.userId??e.ownerSub??t??"",n=e.ownerSub??d;return{...e,userId:d,ownerSub:n}}var w=e=>{let t=L(e);return{id:t.id,userId:t.userId,ownerSub:t.ownerSub,title:t.title??null,status:t.status,mediaKey:t.mediaKey??null,createdAt:t.createdAt,updatedAt:t.updatedAt}},P=new Set(["ep-001"]),U=async e=>{let t=e.info.fieldName,d=e.identity,n=d?.sub;switch(t){case"isEpisodeEarlyAccess":{let s=String(e.arguments?.id||"").trim();if(P.has(s))return{allowed:!0,reason:null};if(!n)return{allowed:!1,reason:"Sign in to check early access."};let a=(await u.send(new r.GetCommand({TableName:o,Key:{pk:`USER#${n}`,sk:"PROFILE"}}))).Item||{};if(a.bestie?.BOOL===!0||a.bestieActive?.BOOL===!0||a.tier?.S==="BESTIE"||a.tier==="BESTIE")return{allowed:!0,reason:null};try{let l=await u.send(new r.GetCommand({TableName:o,Key:{pk:`USER#${n}`,sk:"BESTIE"}}));if(l.Item?.active===!0||l.Item?.active?.BOOL===!0)return{allowed:!0,reason:null}}catch{}return{allowed:!1,reason:"This is an early drop for Bestie members."}}case"myCloset":return E(n),((await u.send(new r.QueryCommand({TableName:o,IndexName:"gsi1",KeyConditionExpression:"gsi1pk = :p",ExpressionAttributeValues:{":p":`OWNER#${n}`},ScanIndexForward:!1,Limit:50}))).Items||[]).filter(i=>i.sk==="META").map(w);case"closetFeed":{let{limit:s,nextToken:i}=e.arguments||{},a=Math.min(Math.max(Number(s)||20,1),50),c=K(i),l=await u.send(new r.QueryCommand({TableName:o,IndexName:f,KeyConditionExpression:"#gpk = :pk",ExpressionAttributeNames:{"#gpk":"gsi2pk"},ExpressionAttributeValues:{":pk":"STATUS#APPROVED"},ScanIndexForward:!1,Limit:a,ExclusiveStartKey:c}));return{items:(l.Items??[]).filter(b=>b.sk==="META").map(w),nextToken:O(l.LastEvaluatedKey)}}case"createClosetItem":{E(n);let{title:s,mediaKey:i}=e.arguments||{},a=(0,y.randomUUID)(),c=p(),l={id:a,userId:n,ownerSub:n,title:(s??"").trim()||null,mediaKey:(i??"").trim()||null,status:"DRAFT",createdAt:c,updatedAt:c};return await u.send(new r.PutCommand({TableName:o,Item:{...l,...m(a),gsi1pk:`OWNER#${n}`,gsi1sk:c,gsi2pk:"STATUS#DRAFT",gsi2sk:c},ConditionExpression:"attribute_not_exists(pk)"})),l}case"updateClosetMediaKey":{E(n);let{id:s,mediaKey:i}=e.arguments,a=await u.send(new r.GetCommand({TableName:o,Key:m(s)}));if(!a.Item)throw new Error("Not found");if(a.Item.ownerSub!==n)throw new Error("Forbidden");let c=p(),l=await u.send(new r.UpdateCommand({TableName:o,Key:m(s),UpdateExpression:"SET mediaKey = :k, updatedAt = :u",ExpressionAttributeValues:{":k":i,":u":c},ReturnValues:"ALL_NEW"}));return w(l.Attributes)}case"requestClosetApproval":{E(n);let{id:s}=e.arguments,i=await u.send(new r.GetCommand({TableName:o,Key:m(s)}));if(!i.Item)throw new Error("Not found");if(i.Item.ownerSub!==n)throw new Error("Forbidden");let a=p();return await u.send(new r.UpdateCommand({TableName:o,Key:m(s),UpdateExpression:"SET #s = :p, gsi2pk = :g, gsi2sk = :ts, updatedAt = :ts",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":p":"PENDING",":g":"STATUS#PENDING",":ts":a}})),T&&await D.send(new A.StartExecutionCommand({stateMachineArn:T,input:JSON.stringify({itemId:s,ownerSub:n})})),!0}case"adminListPending":{if(!g(d))throw new Error("Not authorized");return((await u.send(new r.QueryCommand({TableName:o,IndexName:f,KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":"STATUS#PENDING"},ScanIndexForward:!1,Limit:100}))).Items||[]).map(w)}case"adminApproveItem":{if(!g(d))throw new Error("Not authorized");let{id:s}=e.arguments,i=p();return await u.send(new r.UpdateCommand({TableName:o,Key:m(s),UpdateExpression:"SET #s = :a, gsi2pk = :g, gsi2sk = :ts, updatedAt = :ts REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":a":"APPROVED",":g":"STATUS#APPROVED",":ts":i}})),!0}case"adminRejectItem":{if(!g(d))throw new Error("Not authorized");let{id:s,reason:i}=e.arguments,a=p();return await u.send(new r.UpdateCommand({TableName:o,Key:m(s),UpdateExpression:"SET #s = :r, gsi2pk = :g, gsi2sk = :ts, updatedAt = :ts, reason = :why REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":r":"REJECTED",":g":"STATUS#REJECTED",":ts":a,":why":i??"Rejected by admin"}})),!0}case"deleteClosetItem":{E(n);let{id:s}=e.arguments,i=await u.send(new r.GetCommand({TableName:o,Key:m(s)}));if(!i.Item)throw new Error("Not found");if(i.Item.ownerSub!==n&&!g(d))throw new Error("Forbidden");return await u.send(new r.DeleteCommand({TableName:o,Key:m(s)})),!0}default:throw new Error(`Unhandled field: ${t}`)}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
