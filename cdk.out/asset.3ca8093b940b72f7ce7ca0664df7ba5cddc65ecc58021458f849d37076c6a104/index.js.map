{
  "version": 3,
  "sources": ["../../lambda/graphql/index.ts"],
  "sourcesContent": ["// lambda/graphql/index.ts\r\nimport { randomUUID } from \"crypto\";\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  GetCommand,\r\n  PutCommand,\r\n  UpdateCommand,\r\n  DeleteCommand,\r\n  QueryCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\nimport type { AppSyncResolverEvent, AppSyncIdentityCognito } from \"aws-lambda\";\r\nimport { SFNClient, StartExecutionCommand } from \"@aws-sdk/client-sfn\";\r\n\r\nconst TABLE =\r\n  process.env.TABLE_NAME ||\r\n  process.env.CLOSET_TABLE ||\r\n  (() => {\r\n    throw new Error(\"Missing env TABLE_NAME/CLOSET_TABLE\");\r\n  })();\r\n\r\nconst APPROVAL_SM_ARN = process.env.APPROVAL_SM_ARN || \"\";\r\nconst STATUS_GSI = process.env.STATUS_GSI || \"gsi2\";\r\n\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}));\r\nconst sfn = new SFNClient({});\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// Helpers\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\ntype ClosetStatus = \"DRAFT\" | \"PENDING\" | \"APPROVED\" | \"REJECTED\" | \"PUBLISHED\";\r\n\r\ninterface ClosetItem {\r\n  id: string;\r\n  userId: string;\r\n  ownerSub: string;\r\n  title?: string | null;\r\n  status: ClosetStatus;\r\n  mediaKey?: string | null;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n  // single-table attributes:\r\n  pk?: string;\r\n  sk?: string;\r\n  gsi1pk?: string;\r\n  gsi1sk?: string;\r\n  gsi2pk?: string;\r\n  gsi2sk?: string;\r\n  approvalToken?: string;\r\n  reason?: string | null;\r\n}\r\n\r\nconst nowIso = () => new Date().toISOString();\r\n\r\nconst assertAuth = (sub?: string) => {\r\n  if (!sub) throw new Error(\"Unauthenticated\");\r\n};\r\n\r\nconst isAdmin = (ident?: AppSyncIdentityCognito) => {\r\n  const groups = (ident as any)?.claims?.[\"cognito:groups\"];\r\n  return Array.isArray(groups)\r\n    ? groups.includes(\"ADMIN\")\r\n    : `${groups || \"\"}`.includes(\"ADMIN\");\r\n};\r\n\r\nconst keysForId = (id: string) => ({ pk: `ITEM#${id}`, sk: \"META\" });\r\n\r\nfunction decodeToken(t?: string | null) {\r\n  if (!t) return undefined;\r\n  try {\r\n    return JSON.parse(Buffer.from(String(t), \"base64\").toString(\"utf8\"));\r\n  } catch {\r\n    return undefined;\r\n  }\r\n}\r\n\r\nfunction encodeToken(key: any) {\r\n  if (!key) return null;\r\n  return Buffer.from(JSON.stringify(key), \"utf8\").toString(\"base64\");\r\n}\r\n\r\n/**\r\n * Ensure we always have a non-empty userId and ownerSub on items.\r\n * - userId comes from item.userId, item.ownerSub, or OWNER#... gsi1pk\r\n * - ownerSub falls back to userId\r\n */\r\nfunction materializeUserId(item: any) {\r\n  if (!item) return item;\r\n\r\n  const fromGsi1 =\r\n    typeof item?.gsi1pk === \"string\" && item.gsi1pk.startsWith(\"OWNER#\")\r\n      ? item.gsi1pk.slice(\"OWNER#\".length)\r\n      : undefined;\r\n\r\n  const userId = item.userId ?? item.ownerSub ?? fromGsi1 ?? \"\";\r\n  const ownerSub = item.ownerSub ?? userId;\r\n\r\n  return {\r\n    ...item,\r\n    userId,\r\n    ownerSub,\r\n  };\r\n}\r\n\r\nconst toPublic = (raw: any): ClosetItem => {\r\n  const m = materializeUserId(raw);\r\n  return {\r\n    id: m.id,\r\n    userId: m.userId,\r\n    ownerSub: m.ownerSub,\r\n    title: m.title ?? null,\r\n    status: m.status,\r\n    mediaKey: m.mediaKey ?? null,\r\n    createdAt: m.createdAt,\r\n    updatedAt: m.updatedAt,\r\n  };\r\n};\r\n\r\n// Episodes gate: public ids allowed without checks\r\nconst PUBLIC_EPISODES = new Set<string>([\"ep-001\"]);\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// Router\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\nexport const handler = async (event: AppSyncResolverEvent<any>) => {\r\n  const field = event.info.fieldName;\r\n  const ident = event.identity as AppSyncIdentityCognito | undefined;\r\n  const sub = ident?.sub;\r\n\r\n  switch (field) {\r\n    // ------------------ Episodes early-access ------------------\r\n    case \"isEpisodeEarlyAccess\": {\r\n      const epId = String(event.arguments?.id || \"\").trim();\r\n\r\n      // Public episode? always allowed.\r\n      if (PUBLIC_EPISODES.has(epId)) {\r\n        return { allowed: true, reason: null };\r\n      }\r\n\r\n      // Must be signed in to check early drops.\r\n      if (!sub) return { allowed: false, reason: \"Sign in to check early access.\" };\r\n\r\n      // Look at profile flags that indicate Bestie.\r\n      const got = await ddb.send(\r\n        new GetCommand({ TableName: TABLE, Key: { pk: `USER#${sub}`, sk: \"PROFILE\" } })\r\n      );\r\n      const p = got.Item || {};\r\n      const bestieActive =\r\n        p.bestie?.BOOL === true ||\r\n        p.bestieActive?.BOOL === true ||\r\n        p.tier?.S === \"BESTIE\" ||\r\n        p.tier === \"BESTIE\"; // document client may already unmarshal\r\n\r\n      if (bestieActive) return { allowed: true, reason: null };\r\n\r\n      // Optional: dedicated BESTIE row\r\n      try {\r\n        const bestie = await ddb.send(\r\n          new GetCommand({ TableName: TABLE, Key: { pk: `USER#${sub}`, sk: \"BESTIE\" } })\r\n        );\r\n        if (bestie.Item?.active === true || bestie.Item?.active?.BOOL === true) {\r\n          return { allowed: true, reason: null };\r\n        }\r\n      } catch {\r\n        /* ignore */\r\n      }\r\n\r\n      return { allowed: false, reason: \"This is an early drop for Bestie members.\" };\r\n    }\r\n\r\n    // ------------------ Query.myCloset ------------------\r\n    case \"myCloset\": {\r\n      assertAuth(sub);\r\n\r\n      // Most-recent first by created/updated time\r\n      const out = await ddb.send(\r\n        new QueryCommand({\r\n          TableName: TABLE,\r\n          IndexName: \"gsi1\",\r\n          KeyConditionExpression: \"gsi1pk = :p\",\r\n          ExpressionAttributeValues: { \":p\": `OWNER#${sub}` },\r\n          ScanIndexForward: false,\r\n          Limit: 50,\r\n        })\r\n      );\r\n      return (out.Items || []).filter((x) => x.sk === \"META\").map(toPublic);\r\n    }\r\n\r\n    // ------------------ Query.closetFeed ------------------\r\n    case \"closetFeed\": {\r\n      const { limit, nextToken } = event.arguments || {};\r\n      const pageLimit = Math.min(Math.max(Number(limit) || 20, 1), 50); // 1\u201350\r\n      const startKey = decodeToken(nextToken);\r\n\r\n      const out = await ddb.send(\r\n        new QueryCommand({\r\n          TableName: TABLE,\r\n          IndexName: STATUS_GSI, // e.g. \"gsi2\"\r\n          KeyConditionExpression: \"#gpk = :pk\",\r\n          ExpressionAttributeNames: { \"#gpk\": \"gsi2pk\" },\r\n          ExpressionAttributeValues: { \":pk\": \"STATUS#APPROVED\" },\r\n          ScanIndexForward: false,\r\n          Limit: pageLimit,\r\n          ExclusiveStartKey: startKey,\r\n        })\r\n      );\r\n\r\n      const items = (out.Items ?? [])\r\n        .filter((x) => x.sk === \"META\")\r\n        .map(toPublic);\r\n\r\n      return {\r\n        items,\r\n        nextToken: encodeToken(out.LastEvaluatedKey),\r\n      };\r\n    }\r\n\r\n    // ------------------ Mutation.createClosetItem ------------------\r\n    case \"createClosetItem\": {\r\n      assertAuth(sub);\r\n      const { title, mediaKey } = (event.arguments || {}) as {\r\n        title?: string | null;\r\n        mediaKey?: string | null;\r\n      };\r\n\r\n      const id = randomUUID();\r\n      const ts = nowIso();\r\n      const item: ClosetItem = {\r\n        id,\r\n        userId: sub!,         // keep userId in the record\r\n        ownerSub: sub!,       // also keep legacy ownerSub\r\n        title: (title ?? \"\").trim() || null,\r\n        mediaKey: (mediaKey ?? \"\").trim() || null,\r\n        status: \"DRAFT\",\r\n        createdAt: ts,\r\n        updatedAt: ts,\r\n      };\r\n\r\n      await ddb.send(\r\n        new PutCommand({\r\n          TableName: TABLE,\r\n          Item: {\r\n            ...item,\r\n            ...keysForId(id),\r\n            gsi1pk: `OWNER#${sub}`,\r\n            gsi1sk: ts,\r\n            gsi2pk: `STATUS#DRAFT`,\r\n            gsi2sk: ts,\r\n          },\r\n          ConditionExpression: \"attribute_not_exists(pk)\",\r\n        })\r\n      );\r\n\r\n      return item;\r\n    }\r\n\r\n    // ------------------ Mutation.updateClosetMediaKey ------------------\r\n    case \"updateClosetMediaKey\": {\r\n      assertAuth(sub);\r\n      const { id, mediaKey } = event.arguments as { id: string; mediaKey: string };\r\n\r\n      const got = await ddb.send(new GetCommand({ TableName: TABLE, Key: keysForId(id) }));\r\n      if (!got.Item) throw new Error(\"Not found\");\r\n      if (got.Item.ownerSub !== sub) throw new Error(\"Forbidden\");\r\n\r\n      const ts = nowIso();\r\n      const updated = await ddb.send(\r\n        new UpdateCommand({\r\n          TableName: TABLE,\r\n          Key: keysForId(id),\r\n          UpdateExpression: \"SET mediaKey = :k, updatedAt = :u\",\r\n          ExpressionAttributeValues: { \":k\": mediaKey, \":u\": ts },\r\n          ReturnValues: \"ALL_NEW\",\r\n        })\r\n      );\r\n      return toPublic(updated.Attributes);\r\n    }\r\n\r\n    // ------------------ Mutation.requestClosetApproval ------------------\r\n    case \"requestClosetApproval\": {\r\n      assertAuth(sub);\r\n      const { id } = event.arguments as { id: string };\r\n\r\n      const got = await ddb.send(new GetCommand({ TableName: TABLE, Key: keysForId(id) }));\r\n      if (!got.Item) throw new Error(\"Not found\");\r\n      if (got.Item.ownerSub !== sub) throw new Error(\"Forbidden\");\r\n\r\n      const ts = nowIso();\r\n      await ddb.send(\r\n        new UpdateCommand({\r\n          TableName: TABLE,\r\n          Key: keysForId(id),\r\n          UpdateExpression:\r\n            \"SET #s = :p, gsi2pk = :g, gsi2sk = :ts, updatedAt = :ts\",\r\n          ExpressionAttributeNames: { \"#s\": \"status\" },\r\n          ExpressionAttributeValues: {\r\n            \":p\": \"PENDING\",\r\n            \":g\": \"STATUS#PENDING\",\r\n            \":ts\": ts,\r\n          },\r\n        })\r\n      );\r\n\r\n      if (APPROVAL_SM_ARN) {\r\n        await sfn.send(\r\n          new StartExecutionCommand({\r\n            stateMachineArn: APPROVAL_SM_ARN,\r\n            input: JSON.stringify({ itemId: id, ownerSub: sub }),\r\n          })\r\n        );\r\n      }\r\n      return true;\r\n    }\r\n\r\n    // ------------------ Query.adminListPending ------------------\r\n    case \"adminListPending\": {\r\n      if (!isAdmin(ident)) throw new Error(\"Not authorized\");\r\n\r\n      const out = await ddb.send(\r\n        new QueryCommand({\r\n          TableName: TABLE,\r\n          IndexName: STATUS_GSI,\r\n          KeyConditionExpression: \"gsi2pk = :p\",\r\n          ExpressionAttributeValues: { \":p\": \"STATUS#PENDING\" },\r\n          ScanIndexForward: false,\r\n          Limit: 100,\r\n        })\r\n      );\r\n\r\n      return (out.Items || []).map(toPublic);\r\n    }\r\n\r\n    // ------------------ Mutation.adminApproveItem ------------------\r\n    case \"adminApproveItem\": {\r\n      if (!isAdmin(ident)) throw new Error(\"Not authorized\");\r\n      const { id } = event.arguments as { id: string };\r\n\r\n      const ts = nowIso();\r\n      await ddb.send(\r\n        new UpdateCommand({\r\n          TableName: TABLE,\r\n          Key: keysForId(id),\r\n          UpdateExpression:\r\n            \"SET #s = :a, gsi2pk = :g, gsi2sk = :ts, updatedAt = :ts REMOVE approvalToken\",\r\n          ExpressionAttributeNames: { \"#s\": \"status\" },\r\n          ExpressionAttributeValues: {\r\n            \":a\": \"APPROVED\",\r\n            \":g\": \"STATUS#APPROVED\",\r\n            \":ts\": ts,\r\n          },\r\n        })\r\n      );\r\n      return true;\r\n    }\r\n\r\n    // ------------------ Mutation.adminRejectItem ------------------\r\n    case \"adminRejectItem\": {\r\n      if (!isAdmin(ident)) throw new Error(\"Not authorized\");\r\n      const { id, reason } = event.arguments as { id: string; reason?: string };\r\n\r\n      const ts = nowIso();\r\n      await ddb.send(\r\n        new UpdateCommand({\r\n          TableName: TABLE,\r\n          Key: keysForId(id),\r\n          UpdateExpression:\r\n            \"SET #s = :r, gsi2pk = :g, gsi2sk = :ts, updatedAt = :ts, reason = :why REMOVE approvalToken\",\r\n          ExpressionAttributeNames: { \"#s\": \"status\" },\r\n          ExpressionAttributeValues: {\r\n            \":r\": \"REJECTED\",\r\n            \":g\": \"STATUS#REJECTED\",\r\n            \":ts\": ts,\r\n            \":why\": reason ?? \"Rejected by admin\",\r\n          },\r\n        })\r\n      );\r\n      return true;\r\n    }\r\n\r\n    // ------------------ (Optional) Mutation.deleteClosetItem ------------------\r\n    case \"deleteClosetItem\": {\r\n      assertAuth(sub);\r\n      const { id } = event.arguments as { id: string };\r\n\r\n      const got = await ddb.send(new GetCommand({ TableName: TABLE, Key: keysForId(id) }));\r\n      if (!got.Item) throw new Error(\"Not found\");\r\n      if (got.Item.ownerSub !== sub && !isAdmin(ident)) throw new Error(\"Forbidden\");\r\n\r\n      await ddb.send(new DeleteCommand({ TableName: TABLE, Key: keysForId(id) }));\r\n      return true;\r\n    }\r\n\r\n    // ----------------------------------------------------------------\r\n    default:\r\n      throw new Error(`Unhandled field: ${field}`);\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["index_exports", "__export", "handler", "__toCommonJS", "import_crypto", "import_client_dynamodb", "import_lib_dynamodb", "import_client_sfn", "TABLE", "APPROVAL_SM_ARN", "STATUS_GSI", "ddb", "sfn", "nowIso", "assertAuth", "sub", "isAdmin", "ident", "groups", "keysForId", "id", "decodeToken", "t", "encodeToken", "key", "materializeUserId", "item", "fromGsi1", "userId", "ownerSub", "toPublic", "raw", "m", "PUBLIC_EPISODES", "event", "field", "epId", "p", "bestie", "x", "limit", "nextToken", "pageLimit", "startKey", "out", "title", "mediaKey", "ts", "got", "updated", "reason"]
}
