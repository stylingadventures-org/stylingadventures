"use strict";var S=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var v=Object.prototype.hasOwnProperty;var L=(e,t)=>{for(var i in t)S(e,i,{get:t[i],enumerable:!0})},h=(e,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of D(t))!v.call(e,r)&&r!==i&&S(e,r,{get:()=>t[r],enumerable:!(s=M(t,r))||s.enumerable});return e};var R=e=>h(S({},"__esModule",{value:!0}),e);var F={};L(F,{adminApproveItem:()=>N,adminCreateClosetItem:()=>k,adminListClosetItems:()=>x,adminListPending:()=>f,adminRejectItem:()=>P,adminSetClosetAudience:()=>K,closetFeed:()=>y,handler:()=>U,topClosetLooks:()=>C});module.exports=R(F);var a=require("@aws-sdk/client-dynamodb"),l=require("@aws-sdk/client-sfn"),c=new a.DynamoDBClient({}),T=new l.SFNClient({}),{TABLE_NAME:d=""}=process.env;if(!d)throw new Error("Missing env: TABLE_NAME");var g=()=>new Date().toISOString(),n=e=>({S:e});function E(e){let t=e.identity?.claims||{},i=e.identity?.sub||t.sub,s=t["cognito:groups"],r=Array.isArray(s)?s:String(s||"").split(",").map(u=>u.trim()).filter(Boolean),o=r.includes("ADMIN")||r.includes("COLLAB");if(!i)throw new Error("Unauthorized");return{sub:i,isAdmin:o}}function p(e){return{id:e.id.S,userId:e.ownerSub.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",rawMediaKey:e.rawMediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??"",season:e.season?.S??null,vibes:e.vibes?.S??null,audience:e.audience?.S??null}}function V(){return globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`}function I(e){return e?Buffer.from(JSON.stringify(e),"utf8").toString("base64"):null}function O(e){if(e)try{return JSON.parse(Buffer.from(String(e),"base64").toString("utf8"))}catch{return}}var f=async e=>{let{isAdmin:t}=E(e);if(!t)throw new Error("Forbidden");return((await c.send(new a.QueryCommand({TableName:d,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(s=>p({...s,status:s.status}))},x=async e=>{let{isAdmin:t}=E(e);if(!t)throw new Error("Forbidden");let{status:i,limit:s=50,nextToken:r}=e.arguments||{},o=O(r);if(i){let m=await c.send(new a.QueryCommand({TableName:d,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n(`STATUS#${i}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience",ExpressionAttributeNames:{"#s":"status"},Limit:s,ExclusiveStartKey:o}));return{items:(m.Items||[]).map(b=>p({...b,status:b.status})),nextToken:I(m.LastEvaluatedKey)}}let u=await c.send(new a.ScanCommand({TableName:d,FilterExpression:"begins_with(pk, :p)",ExpressionAttributeValues:{":p":n("ITEM#")},ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience",ExpressionAttributeNames:{"#s":"status"},Limit:s,ExclusiveStartKey:o})),A=(u.Items||[]).map(m=>p({...m,status:m.status}));return A.sort((m,w)=>new Date(w.createdAt||0).getTime()-new Date(m.createdAt||0).getTime()),{items:A,nextToken:I(u.LastEvaluatedKey)}},y=async e=>{E(e);let{sort:t="NEWEST"}=e.arguments||{},s=((await c.send(new a.QueryCommand({TableName:d,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n("STATUS#PUBLISHED")},ScanIndexForward:t==="NEWEST",ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, audience",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(r=>p({...r,status:r.status}));return s},C=async e=>y({...e,arguments:{sort:"NEWEST"}}),k=async e=>{let{sub:t,isAdmin:i}=E(e);if(!i)throw new Error("Forbidden");let s=e.arguments?.input||{};if(!s.title?.trim())throw new Error("title is required");if(!s.rawMediaKey)throw new Error("rawMediaKey is required");let r=V(),o=g();return await c.send(new a.PutItemCommand({TableName:d,Item:{pk:n(`ITEM#${r}`),sk:n("META"),id:n(r),ownerSub:n(t),gsi2pk:n("STATUS#PENDING"),gsi2sk:n(o),status:n("PENDING"),createdAt:n(o),updatedAt:n(o),title:n(s.title.trim()),rawMediaKey:n(s.rawMediaKey),...s.season?{season:n(s.season)}:{},...s.vibes?{vibes:n(s.vibes)}:{}}})),{id:r,userId:t,ownerSub:t,status:"PENDING",createdAt:o,updatedAt:o,title:s.title.trim(),mediaKey:"",rawMediaKey:s.rawMediaKey,reason:"",season:s.season??null,vibes:s.vibes??null,audience:null}},N=async e=>{let{isAdmin:t}=E(e);if(!t)throw new Error("Forbidden");let i=e.arguments?.id;if(!i)throw new Error("id required");let s=g(),o=(await c.send(new a.UpdateItemCommand({TableName:d,Key:{pk:n(`ITEM#${i}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("APPROVED"),":u":n(s),":g2pk":n("STATUS#APPROVED"),":g2sk":n(s)},ReturnValues:"ALL_OLD"}))).Attributes,u=o.approvalToken?.S;if(u)try{await T.send(new l.SendTaskSuccessCommand({taskToken:u,output:JSON.stringify({approved:!0})}))}catch{}return p({...o,status:n("APPROVED")})},P=async e=>{let{isAdmin:t}=E(e);if(!t)throw new Error("Forbidden");let i=e.arguments?.id,s=e.arguments?.reason||"";if(!i)throw new Error("id required");let r=g(),u=(await c.send(new a.UpdateItemCommand({TableName:d,Key:{pk:n(`ITEM#${i}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("REJECTED"),":u":n(r),":g2pk":n("STATUS#REJECTED"),":g2sk":n(r),":r":n(s)},ReturnValues:"ALL_OLD"}))).Attributes,A=u.approvalToken?.S;if(A)try{await T.send(new l.SendTaskFailureCommand({taskToken:A,error:"Rejected",cause:s||"Rejected by admin"}))}catch{}return p({...u,status:n("REJECTED"),reason:n(s)})},K=async()=>"NOT_IMPLEMENTED",U=async e=>{let t=e.info.fieldName;if(t==="adminListPending")return f(e);if(t==="adminListClosetItems")return x(e);if(t==="adminCreateClosetItem")return k(e);if(t==="adminApproveItem")return N(e);if(t==="adminRejectItem")return P(e);if(t==="adminSetClosetAudience")return K();if(t==="closetFeed")return y(e);if(t==="topClosetLooks")return C(e);throw new Error(`No resolver implemented for field ${t}`)};0&&(module.exports={adminApproveItem,adminCreateClosetItem,adminListClosetItems,adminListPending,adminRejectItem,adminSetClosetAudience,closetFeed,handler,topClosetLooks});
//# sourceMappingURL=index.js.map
