<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Signing you in…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .card { max-width: 720px; padding: 1rem 1.25rem; border: 1px solid #e5e7eb; border-radius: 12px; }
    .muted { color: #6b7280; }
    .err { color: #b00020; white-space: pre-wrap; }
    code { background:#f1f5f9; padding:.1rem .25rem; border-radius:6px }
    .grid{display:grid;grid-template-columns:160px 1fr;gap:.35rem .75rem;margin-top:.5rem}
  </style>
</head>
<body>
  <h1>Styling Adventures</h1>
  <div id="box" class="card">
    <p class="muted">Completing sign-in…</p>
  </div>

  <script>
  (async () => {
    function showDebug(info){
      const e = document.getElementById('box');
      e.innerHTML = `
        <h2>Callback received</h2>
        <div class="grid">
          <div>code</div><div><code>${info.code || '(none)'}</code></div>
          <div>state</div><div><code>${info.state || '(none)'}</code></div>
          <div>redirect_uri</div><div><code>${info.redirectUri}</code></div>
          <div>token endpoint</div><div><code>${info.tokenUrl}</code></div>
        </div>
        <p class="muted" style="margin-top:.75rem">Exchanging code for tokens…</p>`;
    }
    function showError(e, extra=''){
      const msg = (e && e.message) ? e.message : String(e);
      document.getElementById('box').innerHTML = `
        <h2>Sign-in error</h2>
        <p class="err">${msg}${extra ? '\n' + extra : ''}</p>
        <p><a href="/">Return to the app</a></p>`;
    }

    const cfg = await fetch('/config.v2.json?ts=' + Date.now(), { cache:'no-store' }).then(r => r.json());
    const hosted = cfg.domain || cfg.hostedUiDomain;
    if (!hosted) return showError('Missing Hosted UI domain in config.v2.json');

    const region = cfg.region;
    const clientId = cfg.clientId;
    if (!region || !clientId) return showError('Missing region or clientId in config.v2.json');

    const domain = `https://${hosted}.auth.${region}.amazoncognito.com`;

    // MUST be identical to what was used in /oauth2/authorize
    if (!cfg.redirectUri) return showError('redirectUri missing in config.v2.json');
    const redirectUri = String(cfg.redirectUri).trim();

    const qs = new URLSearchParams(location.search);
    const code = qs.get('code');
    const returnedState = qs.get('state');

    const expectedState = sessionStorage.getItem('oauth_state');
    const verifier = sessionStorage.getItem('pkce_verifier');

    try {
      if (!code) throw new Error('Missing authorization code in callback URL.');
      if (!verifier) throw new Error('Missing pkce_verifier in sessionStorage (start login from the app).');
      if (expectedState && returnedState && expectedState !== returnedState) {
        throw new Error('State mismatch. Please retry login.');
      }

      const tokenUrl = `${domain}/oauth2/token`;
      showDebug({ code, state: returnedState, tokenUrl, redirectUri });

      const body = new URLSearchParams({
        grant_type: 'authorization_code',
        client_id: clientId,
        redirect_uri: redirectUri,
        code,
        code_verifier: verifier
      });

      const res = await fetch(tokenUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });

      if (!res.ok) {
        const t = await res.text().catch(()=> '');
        throw new Error(`Token exchange failed: ${res.status} ${t}`);
      }

      const tokens = await res.json(); // { id_token, access_token, refresh_token, expires_in, ... }

      sessionStorage.setItem('id_token', tokens.id_token || '');
      sessionStorage.setItem('access_token', tokens.access_token || '');
      if (tokens.refresh_token) sessionStorage.setItem('refresh_token', tokens.refresh_token);
      sessionStorage.setItem('tokens', JSON.stringify(tokens));

      // Cleanup PKCE + state
      sessionStorage.removeItem('pkce_verifier');
      sessionStorage.removeItem('oauth_state');

      // Optional refresh scheduling (safe if missing)
      try {
        const { scheduleRotation } = await import('/auth/refresh.js');
        scheduleRotation(tokens, { domain, clientId });
      } catch {}

      // Normalize URL and go home
      history.replaceState({}, '', `${location.origin}/callback/`);
      const home = (cfg.webOrigin || location.origin).replace(/\/+$/, '/');
      location.replace(home);
    } catch (e) {
      showError(e, `\nclient_id=${clientId}\nredirect_uri=${redirectUri}\ndomain=${domain}`);
    }
  })();
  </script>
</body>
</html>

