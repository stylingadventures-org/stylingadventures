{
  "version": 3,
  "sources": ["../../lambda/roles/index.ts"],
  "sourcesContent": ["// lambda/roles/index.ts\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  GetCommand,\r\n  PutCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\nimport type {\r\n  AppSyncResolverEvent,\r\n  AppSyncIdentityCognito,\r\n} from \"aws-lambda\";\r\n\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\nconst PK_NAME = (process.env.PK_NAME || \"\").trim();  // e.g. \"pk\" for single-table; blank for id-table\r\nconst SK_NAME = (process.env.SK_NAME || \"\").trim();  // e.g. \"sk\" for single-table\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}));\r\n\r\ntype Role = \"FAN\" | \"BESTIE\" | \"CREATOR\" | \"COLLAB\" | \"ADMIN\";\r\ntype Tier = \"FREE\" | \"PRIME\";\r\n\r\ninterface User {\r\n  id: string;\r\n  email?: string | null;\r\n  role: Role;\r\n  tier?: Tier | null;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n}\r\n\r\nconst nowIso = () => new Date().toISOString();\r\n\r\n/** Build the key for Get/Put depending on table shape */\r\nfunction keyFor(sub: string) {\r\n  if (PK_NAME && SK_NAME) {\r\n    // single-table (pk/sk)\r\n    return {\r\n      [PK_NAME]: `USER#${sub}`,\r\n      [SK_NAME]: \"PROFILE\",\r\n    } as Record<string, any>;\r\n  }\r\n  // id-only table\r\n  return { id: sub } as Record<string, any>;\r\n}\r\n\r\n/** Normalize a DDB item \u2192 User */\r\nfunction toUser(item: any, sub: string, email?: string | null): User {\r\n  // Pull fields regardless of storage style\r\n  const base = {\r\n    id: sub,\r\n    email: (item?.email ?? email ?? null) || null,\r\n    role: (item?.role as Role) || \"FAN\",\r\n    tier: (item?.tier as Tier) || \"FREE\",\r\n    createdAt: item?.createdAt || nowIso(),\r\n    updatedAt: item?.updatedAt || nowIso(),\r\n  };\r\n  return base;\r\n}\r\n\r\n/** For single-table, we store the user under pk=USER#sub, sk=PROFILE */\r\nfunction toPutItem(u: User, sub: string) {\r\n  if (PK_NAME && SK_NAME) {\r\n    return {\r\n      [PK_NAME]: `USER#${sub}`,\r\n      [SK_NAME]: \"PROFILE\",\r\n      id: sub,\r\n      email: u.email ?? null,\r\n      role: u.role,\r\n      tier: u.tier ?? null,\r\n      createdAt: u.createdAt,\r\n      updatedAt: u.updatedAt,\r\n    };\r\n  }\r\n  // id-only\r\n  return {\r\n    id: sub,\r\n    email: u.email ?? null,\r\n    role: u.role,\r\n    tier: u.tier ?? null,\r\n    createdAt: u.createdAt,\r\n    updatedAt: u.updatedAt,\r\n  };\r\n}\r\n\r\nexport const handler = async (event: AppSyncResolverEvent<any>) => {\r\n  const field = event.info.fieldName;\r\n\r\n  const ident = event.identity as AppSyncIdentityCognito | undefined;\r\n  const sub = ident?.sub;\r\n  const email = (ident as any)?.claims?.email as string | undefined;\r\n  const groups = (ident as any)?.claims?.[\"cognito:groups\"];\r\n  const isAdmin = Array.isArray(groups)\r\n    ? groups.includes(\"ADMIN\")\r\n    : `${groups || \"\"}`.includes(\"ADMIN\");\r\n\r\n  /* ============================= me ============================= */\r\n  if (field === \"me\") {\r\n    if (!sub) throw new Error(\"Unauthenticated\");\r\n\r\n    // Try current storage (pk/sk or id)\r\n    const got = await ddb.send(\r\n      new GetCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: keyFor(sub),\r\n      })\r\n    );\r\n\r\n    if (got.Item) {\r\n      return toUser(got.Item, sub, email ?? null);\r\n    }\r\n\r\n    // Not found \u2192 create a default record (idempotent)\r\n    const now = nowIso();\r\n    const user: User = {\r\n      id: sub,\r\n      email: (email ?? null)?.toLowerCase?.() ?? null,\r\n      role: \"FAN\",\r\n      tier: \"FREE\",\r\n      createdAt: now,\r\n      updatedAt: now,\r\n    };\r\n\r\n    const put = toPutItem(user, sub);\r\n    await ddb.send(\r\n      new PutCommand({\r\n        TableName: TABLE_NAME,\r\n        Item: put,\r\n        ConditionExpression: \"attribute_not_exists(#k)\",\r\n        ExpressionAttributeNames: {\r\n          \"#k\": PK_NAME ? PK_NAME : \"id\",\r\n        },\r\n      })\r\n    ).catch(async () => {\r\n      // Race: someone created it; read it back\r\n      const again = await ddb.send(\r\n        new GetCommand({ TableName: TABLE_NAME, Key: keyFor(sub) })\r\n      );\r\n      if (again.Item) return toUser(again.Item, sub, email ?? null);\r\n    });\r\n\r\n    return user;\r\n  }\r\n\r\n  /* ========================= setUserRole ======================== */\r\n  if (field === \"setUserRole\") {\r\n    if (!sub) throw new Error(\"Unauthenticated\");\r\n\r\n    const input = event.arguments?.input as {\r\n      userId: string;\r\n      email?: string | null;\r\n      role: Role;\r\n      tier?: Tier | null;\r\n    };\r\n\r\n    if (!input?.userId || !input?.role) {\r\n      throw new Error(\"userId and role are required\");\r\n    }\r\n\r\n    const targetUserId = input.userId;\r\n\r\n    if (!isAdmin && targetUserId !== sub) {\r\n      throw new Error(\"Not authorized to modify other users\");\r\n    }\r\n\r\n    const got = await ddb.send(\r\n      new GetCommand({ TableName: TABLE_NAME, Key: keyFor(targetUserId) })\r\n    );\r\n\r\n    const now = nowIso();\r\n    const existing = got.Item ? toUser(got.Item, targetUserId, null) : null;\r\n\r\n    const merged: User = {\r\n      id: targetUserId,\r\n      email:\r\n        (input.email ??\r\n          existing?.email ??\r\n          null)?.toLowerCase?.() ?? null,\r\n      role: input.role,\r\n      tier: input.tier ?? existing?.tier ?? \"FREE\",\r\n      createdAt: existing?.createdAt ?? now,\r\n      updatedAt: now,\r\n    };\r\n\r\n    await ddb.send(\r\n      new PutCommand({\r\n        TableName: TABLE_NAME,\r\n        Item: toPutItem(merged, targetUserId),\r\n      })\r\n    );\r\n\r\n    return merged;\r\n  }\r\n\r\n  throw new Error(`Unhandled field: ${field}`);\r\n};\r\n"],
  "mappings": "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",
  "names": ["index_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "TABLE_NAME", "PK_NAME", "SK_NAME", "ddb", "nowIso", "keyFor", "sub", "toUser", "item", "email", "toPutItem", "u", "event", "field", "ident", "groups", "isAdmin", "got", "now", "user", "put", "again", "input", "targetUserId", "existing", "merged"]
}
