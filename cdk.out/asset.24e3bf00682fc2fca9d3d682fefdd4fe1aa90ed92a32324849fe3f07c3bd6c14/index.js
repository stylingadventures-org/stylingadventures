"use strict";var y=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var C=Object.prototype.hasOwnProperty;var S=(e,t)=>{for(var r in t)y(e,r,{get:t[r],enumerable:!0})},b=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of h(t))!C.call(e,i)&&i!==r&&y(e,i,{get:()=>t[i],enumerable:!(n=U(t,i))||n.enumerable});return e};var F=e=>b(y({},"__esModule",{value:!0}),e);var D={};S(D,{handler:()=>M});module.exports=F(D);var R=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb"),u=process.env.TABLE_NAME,d=(process.env.PK_NAME||"").trim(),p=(process.env.SK_NAME||"").trim(),m=a.DynamoDBDocumentClient.from(new R.DynamoDBClient({})),E=()=>new Date().toISOString();function g(e){return d&&p?{[d]:`USER#${e}`,[p]:"PROFILE"}:{id:e}}function f(e,t,r){return{id:t,email:(e?.email??r??null)||null,role:e?.role||"FAN",tier:e?.tier||"FREE",createdAt:e?.createdAt||E(),updatedAt:e?.updatedAt||E()}}function N(e,t){return d&&p?{[d]:`USER#${t}`,[p]:"PROFILE",id:t,email:e.email??null,role:e.role,tier:e.tier??null,createdAt:e.createdAt,updatedAt:e.updatedAt}:{id:t,email:e.email??null,role:e.role,tier:e.tier??null,createdAt:e.createdAt,updatedAt:e.updatedAt}}var M=async e=>{let t=e.info.fieldName,r=e.identity,n=r?.sub,i=r?.claims?.email,w=r?.claims?.["cognito:groups"],T=Array.isArray(w)?w.includes("ADMIN"):`${w||""}`.includes("ADMIN");if(t==="me"){if(!n)throw new Error("Unauthenticated");let o=await m.send(new a.GetCommand({TableName:u,Key:g(n)}));if(o.Item)return f(o.Item,n,i??null);let s=E(),c={id:n,email:(i??null)?.toLowerCase?.()??null,role:"FAN",tier:"FREE",createdAt:s,updatedAt:s},A=N(c,n);return await m.send(new a.PutCommand({TableName:u,Item:A,ConditionExpression:"attribute_not_exists(#k)",ExpressionAttributeNames:{"#k":d||"id"}})).catch(async()=>{let l=await m.send(new a.GetCommand({TableName:u,Key:g(n)}));if(l.Item)return f(l.Item,n,i??null)}),c}if(t==="setUserRole"){if(!n)throw new Error("Unauthenticated");let o=e.arguments?.input;if(!o?.userId||!o?.role)throw new Error("userId and role are required");let s=o.userId;if(!T&&s!==n)throw new Error("Not authorized to modify other users");let c=await m.send(new a.GetCommand({TableName:u,Key:g(s)})),A=E(),l=c.Item?f(c.Item,s,null):null,I={id:s,email:(o.email??l?.email??null)?.toLowerCase?.()??null,role:o.role,tier:o.tier??l?.tier??"FREE",createdAt:l?.createdAt??A,updatedAt:A};return await m.send(new a.PutCommand({TableName:u,Item:N(I,s)})),I}throw new Error(`Unhandled field: ${t}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
