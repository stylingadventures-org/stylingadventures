{
  "version": 3,
  "sources": ["../../lambda/prime/career-archive.ts"],
  "sourcesContent": ["// lambda/prime/career-archive.ts\r\n\r\n/**\r\n * Career Archive Lambda (Prime Studios)\r\n *\r\n * Purpose:\r\n *  - Track long-term viewer / story progression and character arcs.\r\n *  - Designed for internal Studio tools & workflows (Step Functions),\r\n *    not direct fan access.\r\n *\r\n * Current behavior:\r\n *  - Supports two simple operations:\r\n *      1) RECORD_EVENT \u2192 normalize and return a story progression event.\r\n *      2) GET_TIMELINE \u2192 return a mocked timeline summary.\r\n *\r\n * Future evolution:\r\n *  - Persist events into DynamoDB using TABLE_NAME, PK_NAME, SK_NAME.\r\n *  - Support richer queries: arc per character, per season, per viewer.\r\n */\r\n\r\nexport type CareerArchiveAction = \"RECORD_EVENT\" | \"GET_TIMELINE\";\r\n\r\nexport type ProgressEventType =\r\n  | \"EPISODE_STARTED\"\r\n  | \"EPISODE_COMPLETED\"\r\n  | \"BRANCH_SELECTED\"\r\n  | \"CHARACTER_MILESTONE\"\r\n  | \"ACHIEVEMENT_UNLOCKED\";\r\n\r\nexport interface RecordEventInput {\r\n  userId: string; // viewer / fan id\r\n  episodeId?: string;\r\n  characterId?: string;\r\n  arcId?: string; // e.g. \"prime.S1.C1.confidence-arc\"\r\n\r\n  eventType: ProgressEventType;\r\n  at?: string; // ISO timestamp, optional (defaults to now)\r\n\r\n  // Arbitrary extra data (branch id, poll option, etc.)\r\n  payload?: Record<string, unknown>;\r\n}\r\n\r\nexport interface GetTimelineInput {\r\n  userId: string;\r\n  characterId?: string;\r\n  arcId?: string;\r\n\r\n  // Optional pagination / filtering, not implemented yet\r\n  limit?: number;\r\n  cursor?: string;\r\n}\r\n\r\nexport interface CareerArchiveEvent {\r\n  action: CareerArchiveAction;\r\n  record?: RecordEventInput;\r\n  timeline?: GetTimelineInput;\r\n}\r\n\r\nexport interface RecordedProgressEvent {\r\n  eventId: string;\r\n  userId: string;\r\n  episodeId?: string;\r\n  characterId?: string;\r\n  arcId?: string;\r\n  eventType: ProgressEventType;\r\n  at: string;\r\n  payload?: Record<string, unknown>;\r\n}\r\n\r\nexport interface TimelineNode {\r\n  eventId: string;\r\n  label: string;\r\n  episodeId?: string;\r\n  characterId?: string;\r\n  arcId?: string;\r\n  eventType: ProgressEventType;\r\n  at: string;\r\n}\r\n\r\nexport interface TimelineSummary {\r\n  userId: string;\r\n  characterId?: string;\r\n  arcId?: string;\r\n  nodes: TimelineNode[];\r\n\r\n  // Helpful for Studio dashboards\r\n  stats: {\r\n    totalEvents: number;\r\n    episodesCompleted: number;\r\n    achievementsUnlocked: number;\r\n  };\r\n}\r\n\r\nexport type CareerArchiveResult =\r\n  | {\r\n      kind: \"recorded\";\r\n      event: RecordedProgressEvent;\r\n    }\r\n  | {\r\n      kind: \"timeline\";\r\n      summary: TimelineSummary;\r\n    };\r\n\r\nfunction ensureIsoTimestamp(ts?: string): string {\r\n  if (!ts) return new Date().toISOString();\r\n  const d = new Date(ts);\r\n  if (Number.isNaN(d.getTime())) {\r\n    return new Date().toISOString();\r\n  }\r\n  return d.toISOString();\r\n}\r\n\r\nfunction buildEventId(): string {\r\n  return `arc-${Math.random().toString(36).slice(2, 10)}`;\r\n}\r\n\r\nasync function handleRecordEvent(\r\n  input: RecordEventInput,\r\n): Promise<CareerArchiveResult> {\r\n  if (!input.userId) {\r\n    throw new Error(\"CareerArchive RECORD_EVENT: missing userId\");\r\n  }\r\n  if (!input.eventType) {\r\n    throw new Error(\"CareerArchive RECORD_EVENT: missing eventType\");\r\n  }\r\n\r\n  const at = ensureIsoTimestamp(input.at);\r\n\r\n  const event: RecordedProgressEvent = {\r\n    eventId: buildEventId(),\r\n    userId: input.userId,\r\n    episodeId: input.episodeId,\r\n    characterId: input.characterId,\r\n    arcId: input.arcId,\r\n    eventType: input.eventType,\r\n    at,\r\n    payload: input.payload,\r\n  };\r\n\r\n  console.log(\r\n    \"CareerArchive RECORD_EVENT normalized:\",\r\n    JSON.stringify(event, null, 2),\r\n  );\r\n\r\n  // \uD83D\uDD1C Future:\r\n  //   - If TABLE_NAME is set, persist event into DynamoDB.\r\n  //   - pk = `USER#${userId}`, sk = `ARC#${arcId}#${at}` or similar.\r\n  //\r\n  // const tableName = process.env.TABLE_NAME;\r\n  // if (tableName) { ... }\r\n\r\n  return { kind: \"recorded\", event };\r\n}\r\n\r\nasync function handleGetTimeline(\r\n  input: GetTimelineInput,\r\n): Promise<CareerArchiveResult> {\r\n  if (!input.userId) {\r\n    throw new Error(\"CareerArchive GET_TIMELINE: missing userId\");\r\n  }\r\n\r\n  // Mocked timeline \u2014 this is where you'd:\r\n  //   - Query DynamoDB for events scoped by userId + character/arc.\r\n  //   - Sort by time and project into a Studio-friendly format.\r\n\r\n  const now = new Date().toISOString();\r\n\r\n  const nodes: TimelineNode[] = [\r\n    {\r\n      eventId: \"mock-1\",\r\n      label: \"Started first episode\",\r\n      episodeId: \"EP-001\",\r\n      eventType: \"EPISODE_STARTED\",\r\n      at: now,\r\n    },\r\n    {\r\n      eventId: \"mock-2\",\r\n      label: \"Completed first episode\",\r\n      episodeId: \"EP-001\",\r\n      eventType: \"EPISODE_COMPLETED\",\r\n      at: now,\r\n    },\r\n  ];\r\n\r\n  const summary: TimelineSummary = {\r\n    userId: input.userId,\r\n    characterId: input.characterId,\r\n    arcId: input.arcId,\r\n    nodes,\r\n    stats: {\r\n      totalEvents: nodes.length,\r\n      episodesCompleted: nodes.filter(\r\n        (n) => n.eventType === \"EPISODE_COMPLETED\",\r\n      ).length,\r\n      achievementsUnlocked: nodes.filter(\r\n        (n) => n.eventType === \"ACHIEVEMENT_UNLOCKED\",\r\n      ).length,\r\n    },\r\n  };\r\n\r\n  console.log(\r\n    \"CareerArchive GET_TIMELINE summary (mock):\",\r\n    JSON.stringify(summary, null, 2),\r\n  );\r\n\r\n  return { kind: \"timeline\", summary };\r\n}\r\n\r\nexport const handler = async (\r\n  event: CareerArchiveEvent,\r\n): Promise<CareerArchiveResult> => {\r\n  console.log(\r\n    \"CareerArchive incoming event:\",\r\n    JSON.stringify(event, null, 2),\r\n  );\r\n\r\n  if (!event || !event.action) {\r\n    throw new Error(\"CareerArchive: missing action\");\r\n  }\r\n\r\n  switch (event.action) {\r\n    case \"RECORD_EVENT\":\r\n      if (!event.record) {\r\n        throw new Error(\"CareerArchive RECORD_EVENT: missing 'record' payload\");\r\n      }\r\n      return handleRecordEvent(event.record);\r\n\r\n    case \"GET_TIMELINE\":\r\n      if (!event.timeline) {\r\n        throw new Error(\r\n          \"CareerArchive GET_TIMELINE: missing 'timeline' payload\",\r\n        );\r\n      }\r\n      return handleGetTimeline(event.timeline);\r\n\r\n    default:\r\n      // Type guard safety; should never hit with the union above.\r\n      throw new Error(`CareerArchive: unsupported action ${(event as any).action}`);\r\n  }\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAuGA,SAASI,EAAmBC,EAAqB,CAC/C,GAAI,CAACA,EAAI,OAAO,IAAI,KAAK,EAAE,YAAY,EACvC,IAAMC,EAAI,IAAI,KAAKD,CAAE,EACrB,OAAI,OAAO,MAAMC,EAAE,QAAQ,CAAC,EACnB,IAAI,KAAK,EAAE,YAAY,EAEzBA,EAAE,YAAY,CACvB,CAEA,SAASC,GAAuB,CAC9B,MAAO,OAAO,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,MAAM,EAAG,EAAE,CAAC,EACvD,CAEA,eAAeC,EACbC,EAC8B,CAC9B,GAAI,CAACA,EAAM,OACT,MAAM,IAAI,MAAM,4CAA4C,EAE9D,GAAI,CAACA,EAAM,UACT,MAAM,IAAI,MAAM,+CAA+C,EAGjE,IAAMC,EAAKN,EAAmBK,EAAM,EAAE,EAEhCE,EAA+B,CACnC,QAASJ,EAAa,EACtB,OAAQE,EAAM,OACd,UAAWA,EAAM,UACjB,YAAaA,EAAM,YACnB,MAAOA,EAAM,MACb,UAAWA,EAAM,UACjB,GAAAC,EACA,QAASD,EAAM,OACjB,EAEA,eAAQ,IACN,yCACA,KAAK,UAAUE,EAAO,KAAM,CAAC,CAC/B,EASO,CAAE,KAAM,WAAY,MAAAA,CAAM,CACnC,CAEA,eAAeC,EACbH,EAC8B,CAC9B,GAAI,CAACA,EAAM,OACT,MAAM,IAAI,MAAM,4CAA4C,EAO9D,IAAMI,EAAM,IAAI,KAAK,EAAE,YAAY,EAE7BC,EAAwB,CAC5B,CACE,QAAS,SACT,MAAO,wBACP,UAAW,SACX,UAAW,kBACX,GAAID,CACN,EACA,CACE,QAAS,SACT,MAAO,0BACP,UAAW,SACX,UAAW,oBACX,GAAIA,CACN,CACF,EAEME,EAA2B,CAC/B,OAAQN,EAAM,OACd,YAAaA,EAAM,YACnB,MAAOA,EAAM,MACb,MAAAK,EACA,MAAO,CACL,YAAaA,EAAM,OACnB,kBAAmBA,EAAM,OACtB,GAAM,EAAE,YAAc,mBACzB,EAAE,OACF,qBAAsBA,EAAM,OACzB,GAAM,EAAE,YAAc,sBACzB,EAAE,MACJ,CACF,EAEA,eAAQ,IACN,6CACA,KAAK,UAAUC,EAAS,KAAM,CAAC,CACjC,EAEO,CAAE,KAAM,WAAY,QAAAA,CAAQ,CACrC,CAEO,IAAMb,EAAU,MACrBS,GACiC,CAMjC,GALA,QAAQ,IACN,gCACA,KAAK,UAAUA,EAAO,KAAM,CAAC,CAC/B,EAEI,CAACA,GAAS,CAACA,EAAM,OACnB,MAAM,IAAI,MAAM,+BAA+B,EAGjD,OAAQA,EAAM,OAAQ,CACpB,IAAK,eACH,GAAI,CAACA,EAAM,OACT,MAAM,IAAI,MAAM,sDAAsD,EAExE,OAAOH,EAAkBG,EAAM,MAAM,EAEvC,IAAK,eACH,GAAI,CAACA,EAAM,SACT,MAAM,IAAI,MACR,wDACF,EAEF,OAAOC,EAAkBD,EAAM,QAAQ,EAEzC,QAEE,MAAM,IAAI,MAAM,qCAAsCA,EAAc,MAAM,EAAE,CAChF,CACF",
  "names": ["career_archive_exports", "__export", "handler", "__toCommonJS", "ensureIsoTimestamp", "ts", "d", "buildEventId", "handleRecordEvent", "input", "at", "event", "handleGetTimeline", "now", "nodes", "summary"]
}
