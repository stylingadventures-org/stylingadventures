{
  "version": 3,
  "sources": ["../../lambda/emotional-pr/goalCompassAnalytics.ts"],
  "sourcesContent": ["// lambda/emotional-pr/goalCompassAnalytics.ts\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  GetCommand,\r\n  UpdateCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\n\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}));\r\n\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\nconst PK = process.env.PK_NAME || \"pk\";\r\nconst SK = process.env.SK_NAME || \"sk\";\r\n\r\nfunction now() {\r\n  return new Date().toISOString();\r\n}\r\n\r\n/**\r\n * Very lightweight Emotional PR Engine analytics stub.\r\n *\r\n * Input shape (from Step Functions):\r\n *   { \"creatorId\": \"sub-123\" }\r\n *\r\n * Later you can extend this to look at:\r\n * - CreatorPrItem rows for that creator\r\n * - Recent content performance from AnalyticsStack\r\n * - Emotional tone labels from the Emotional PR Engine\r\n */\r\nexport const handler = async (event: any) => {\r\n  const creatorId: string =\r\n    event?.creatorId ||\r\n    event?.creatorSub ||\r\n    event?.userId ||\r\n    event?.userSub;\r\n\r\n  if (!creatorId) {\r\n    throw new Error(\"creatorId is required\");\r\n  }\r\n\r\n  const pkValue = `CREATOR#${creatorId}`;\r\n  const skValue = \"GOAL_COMPASS\";\r\n\r\n  const nowIso = now();\r\n\r\n  // 1) Load existing compass (if none, nothing to update)\r\n  const getRes = await ddb.send(\r\n    new GetCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: {\r\n        [PK]: pkValue,\r\n        [SK]: skValue,\r\n      },\r\n    }),\r\n  );\r\n\r\n  if (!getRes.Item) {\r\n    // No compass yet; nothing to do for this creator\r\n    return {\r\n      ok: false,\r\n      reason: \"NO_GOAL_COMPASS\",\r\n      creatorId,\r\n    };\r\n  }\r\n\r\n  const compass = getRes.Item as any;\r\n  const targetMix = compass.contentMixTarget ?? {\r\n    personality: 30,\r\n    nurture: 30,\r\n    authority: 20,\r\n    conversion: 20,\r\n  };\r\n\r\n  // 2) TODO: calculate actual mix based on real data.\r\n  // For now, simulate a slightly wobbly mix around the target.\r\n  const wobble = (value: number, delta: number) => {\r\n    const min = Math.max(0, value - delta);\r\n    const max = value + delta;\r\n    return Math.round(min + Math.random() * (max - min));\r\n  };\r\n\r\n  const contentMixActual = {\r\n    personality: wobble(targetMix.personality ?? 30, 10),\r\n    nurture: wobble(targetMix.nurture ?? 30, 10),\r\n    authority: wobble(targetMix.authority ?? 20, 10),\r\n    conversion: wobble(targetMix.conversion ?? 20, 10),\r\n  };\r\n\r\n  // Simple heuristic for weeklyPathStatus\r\n  const deviation = (field: keyof typeof targetMix) => {\r\n    const t = targetMix[field] ?? 0;\r\n    const a = contentMixActual[field] ?? 0;\r\n    return Math.abs(a - t);\r\n  };\r\n\r\n  const maxDeviation = Math.max(\r\n    deviation(\"personality\"),\r\n    deviation(\"nurture\"),\r\n    deviation(\"authority\"),\r\n    deviation(\"conversion\"),\r\n  );\r\n\r\n  let weeklyPathStatus = \"ON_PATH\";\r\n  if (maxDeviation > 25) {\r\n    weeklyPathStatus = \"OFF_PATH\";\r\n  } else if (maxDeviation > 15) {\r\n    weeklyPathStatus = \"SLIGHTLY_OFF\";\r\n  }\r\n\r\n  // 3) Persist back to the GOAL_COMPASS item\r\n  await ddb.send(\r\n    new UpdateCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: {\r\n        [PK]: pkValue,\r\n        [SK]: skValue,\r\n      },\r\n      UpdateExpression:\r\n        \"SET #contentMixActual = :contentMixActual, #weeklyPathStatus = :weeklyPathStatus, #lastWeeklyCheckAt = :now\",\r\n      ExpressionAttributeNames: {\r\n        \"#contentMixActual\": \"contentMixActual\",\r\n        \"#weeklyPathStatus\": \"weeklyPathStatus\",\r\n        \"#lastWeeklyCheckAt\": \"lastWeeklyCheckAt\",\r\n      },\r\n      ExpressionAttributeValues: {\r\n        \":contentMixActual\": contentMixActual,\r\n        \":weeklyPathStatus\": weeklyPathStatus,\r\n        \":now\": nowIso,\r\n      },\r\n    }),\r\n  );\r\n\r\n  return {\r\n    ok: true,\r\n    creatorId,\r\n    contentMixActual,\r\n    weeklyPathStatus,\r\n    lastWeeklyCheckAt: nowIso,\r\n  };\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GACA,IAAAI,EAA+B,oCAC/BC,EAIO,iCAEDC,EAAM,yBAAuB,KAAK,IAAI,iBAAe,CAAC,CAAC,CAAC,EAExDC,EAAa,QAAQ,IAAI,WACzBC,EAAK,QAAQ,IAAI,SAAW,KAC5BC,EAAK,QAAQ,IAAI,SAAW,KAElC,SAASC,GAAM,CACb,OAAO,IAAI,KAAK,EAAE,YAAY,CAChC,CAaO,IAAMR,EAAU,MAAOS,GAAe,CAC3C,IAAMC,EACJD,GAAO,WACPA,GAAO,YACPA,GAAO,QACPA,GAAO,QAET,GAAI,CAACC,EACH,MAAM,IAAI,MAAM,uBAAuB,EAGzC,IAAMC,EAAU,WAAWD,CAAS,GAC9BE,EAAU,eAEVC,EAASL,EAAI,EAGbM,EAAS,MAAMV,EAAI,KACvB,IAAI,aAAW,CACb,UAAWC,EACX,IAAK,CACH,CAACC,CAAE,EAAGK,EACN,CAACJ,CAAE,EAAGK,CACR,CACF,CAAC,CACH,EAEA,GAAI,CAACE,EAAO,KAEV,MAAO,CACL,GAAI,GACJ,OAAQ,kBACR,UAAAJ,CACF,EAIF,IAAMK,EADUD,EAAO,KACG,kBAAoB,CAC5C,YAAa,GACb,QAAS,GACT,UAAW,GACX,WAAY,EACd,EAIME,EAAS,CAACC,EAAeC,IAAkB,CAC/C,IAAMC,EAAM,KAAK,IAAI,EAAGF,EAAQC,CAAK,EAC/BE,EAAMH,EAAQC,EACpB,OAAO,KAAK,MAAMC,EAAM,KAAK,OAAO,GAAKC,EAAMD,EAAI,CACrD,EAEME,EAAmB,CACvB,YAAaL,EAAOD,EAAU,aAAe,GAAI,EAAE,EACnD,QAASC,EAAOD,EAAU,SAAW,GAAI,EAAE,EAC3C,UAAWC,EAAOD,EAAU,WAAa,GAAI,EAAE,EAC/C,WAAYC,EAAOD,EAAU,YAAc,GAAI,EAAE,CACnD,EAGMO,EAAaC,GAAkC,CACnD,IAAMC,EAAIT,EAAUQ,CAAK,GAAK,EACxBE,EAAIJ,EAAiBE,CAAK,GAAK,EACrC,OAAO,KAAK,IAAIE,EAAID,CAAC,CACvB,EAEME,EAAe,KAAK,IACxBJ,EAAU,aAAa,EACvBA,EAAU,SAAS,EACnBA,EAAU,WAAW,EACrBA,EAAU,YAAY,CACxB,EAEIK,EAAmB,UACvB,OAAID,EAAe,GACjBC,EAAmB,WACVD,EAAe,KACxBC,EAAmB,gBAIrB,MAAMvB,EAAI,KACR,IAAI,gBAAc,CAChB,UAAWC,EACX,IAAK,CACH,CAACC,CAAE,EAAGK,EACN,CAACJ,CAAE,EAAGK,CACR,EACA,iBACE,8GACF,yBAA0B,CACxB,oBAAqB,mBACrB,oBAAqB,mBACrB,qBAAsB,mBACxB,EACA,0BAA2B,CACzB,oBAAqBS,EACrB,oBAAqBM,EACrB,OAAQd,CACV,CACF,CAAC,CACH,EAEO,CACL,GAAI,GACJ,UAAAH,EACA,iBAAAW,EACA,iBAAAM,EACA,kBAAmBd,CACrB,CACF",
  "names": ["goalCompassAnalytics_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "ddb", "TABLE_NAME", "PK", "SK", "now", "event", "creatorId", "pkValue", "skValue", "nowIso", "getRes", "targetMix", "wobble", "value", "delta", "min", "max", "contentMixActual", "deviation", "field", "t", "a", "maxDeviation", "weeklyPathStatus"]
}
