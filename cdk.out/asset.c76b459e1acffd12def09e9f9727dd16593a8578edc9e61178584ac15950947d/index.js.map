{
  "version": 3,
  "sources": ["../../lambda/admin/approve-closet-upload.ts"],
  "sourcesContent": ["import { SFNClient, SendTaskSuccessCommand } from \"@aws-sdk/client-sfn\";\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  GetCommand,\r\n  UpdateCommand,\r\n  PutCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\nimport { EventBridgeClient, PutEventsCommand } from \"@aws-sdk/client-eventbridge\";\r\nimport { SNSClient, PublishCommand } from \"@aws-sdk/client-sns\";\r\n\r\nconst sfn = new SFNClient({});\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}), {\r\n  marshallOptions: { removeUndefinedValues: true },\r\n});\r\nconst eb = new EventBridgeClient({});\r\nconst sns = new SNSClient({});\r\n\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\nconst AUDIT_TABLE_NAME = process.env.AUDIT_TABLE_NAME!;\r\nconst PK_NAME = process.env.PK_NAME || \"pk\";\r\nconst SK_NAME = process.env.SK_NAME || \"sk\";\r\nconst NOTIFY_TOPIC_ARN = process.env.NOTIFY_TOPIC_ARN;\r\n\r\nfunction response(statusCode: number, body: any) {\r\n  return {\r\n    statusCode,\r\n    headers: {\r\n      \"content-type\": \"application/json\",\r\n      \"access-control-allow-origin\": \"*\",\r\n      \"access-control-allow-methods\": \"OPTIONS,POST\",\r\n      \"access-control-allow-headers\": \"*\",\r\n    },\r\n    body: JSON.stringify(body),\r\n  };\r\n}\r\n\r\nasync function emit(detailType: string, detail: any) {\r\n  try {\r\n    await eb.send(\r\n      new PutEventsCommand({\r\n        Entries: [\r\n          {\r\n            Source: \"stylingadventures.closet\",\r\n            DetailType: detailType,\r\n            Detail: JSON.stringify(detail),\r\n          },\r\n        ],\r\n      }),\r\n    );\r\n  } catch (err) {\r\n    console.warn(\"[approve] EventBridge emit failed:\", err);\r\n  }\r\n}\r\n\r\nasync function notify(subject: string, message: string, detail: any) {\r\n  if (!NOTIFY_TOPIC_ARN) return;\r\n  try {\r\n    await sns.send(\r\n      new PublishCommand({\r\n        TopicArn: NOTIFY_TOPIC_ARN,\r\n        Subject: subject,\r\n        Message: `${message}\\n\\n${JSON.stringify(detail, null, 2)}`,\r\n      }),\r\n    );\r\n  } catch (err) {\r\n    console.warn(\"[approve] SNS publish failed:\", err);\r\n  }\r\n}\r\n\r\nasync function audit(action: string, approvalId: string, detail: any) {\r\n  const ts = new Date();\r\n  await ddb.send(\r\n    new PutCommand({\r\n      TableName: AUDIT_TABLE_NAME,\r\n      Item: {\r\n        pk: `APPROVAL#${approvalId}`,\r\n        sk: `TS#${ts.toISOString()}`,\r\n        action,\r\n        approvalId,\r\n        at: ts.toISOString(),\r\n        detail,\r\n      },\r\n    }),\r\n  );\r\n}\r\n\r\nexport const handler = async (event: any) => {\r\n  if (event?.requestContext?.http?.method === \"OPTIONS\") {\r\n    return response(200, { ok: true });\r\n  }\r\n\r\n  try {\r\n    const body =\r\n      typeof event.body === \"string\" ? JSON.parse(event.body) : event.body ?? {};\r\n\r\n    const { approvalId, decision } = body;\r\n\r\n    if (!approvalId || !decision) {\r\n      return response(400, { message: \"Missing approvalId or decision\" });\r\n    }\r\n    if (decision !== \"APPROVE\" && decision !== \"REJECT\") {\r\n      return response(400, { message: \"decision must be APPROVE or REJECT\" });\r\n    }\r\n\r\n    const pk = `ITEM#${approvalId}`;\r\n    const sk = \"META\";\r\n\r\n    const { Item } = await ddb.send(\r\n      new GetCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: { [PK_NAME]: pk, [SK_NAME]: sk },\r\n      }),\r\n    );\r\n\r\n    if (!Item) return response(404, { message: \"Item not found\" });\r\n\r\n    // Idempotency: OK to re-send\r\n    if (Item.status !== \"PENDING\") {\r\n      return response(200, { ok: true, idempotent: true, status: Item.status });\r\n    }\r\n\r\n    const taskToken = Item.taskToken as string | undefined;\r\n    if (!taskToken) {\r\n      return response(409, { message: \"Missing taskToken (NotifyAdminFn not run yet)\" });\r\n    }\r\n\r\n    const reason =\r\n      body.reason ??\r\n      (decision === \"APPROVE\" ? \"Approved by admin\" : \"Rejected by admin\");\r\n\r\n    // Resume Step Functions (Choice routes using decision)\r\n    await sfn.send(\r\n      new SendTaskSuccessCommand({\r\n        taskToken,\r\n        output: JSON.stringify({ decision, reason }),\r\n      }),\r\n    );\r\n\r\n    const now = new Date().toISOString();\r\n    const newStatus = decision === \"APPROVE\" ? \"APPROVED\" : \"REJECTED\";\r\n\r\n    // Race-safe\r\n    await ddb.send(\r\n      new UpdateCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: { [PK_NAME]: pk, [SK_NAME]: sk },\r\n        ConditionExpression: \"#s = :pending\",\r\n        UpdateExpression: `\r\n          SET #s = :s,\r\n              decidedAt = :t,\r\n              updatedAt = :t\r\n          REMOVE taskToken, taskTokenExpiresAt\r\n        `,\r\n        ExpressionAttributeNames: { \"#s\": \"status\" },\r\n        ExpressionAttributeValues: {\r\n          \":pending\": \"PENDING\",\r\n          \":s\": newStatus,\r\n          \":t\": now,\r\n        },\r\n      }),\r\n    );\r\n\r\n    await audit(decision === \"APPROVE\" ? \"ADMIN_APPROVE\" : \"ADMIN_REJECT\", approvalId, {\r\n      approvalId,\r\n      decision,\r\n      reason,\r\n      decidedAt: now,\r\n    });\r\n\r\n    await emit(decision === \"APPROVE\" ? \"ClosetItemApproved\" : \"ClosetItemRejected\", {\r\n      approvalId,\r\n      decision,\r\n      reason,\r\n      decidedAt: now,\r\n    });\r\n\r\n    await notify(\r\n      \"Closet approval decision\",\r\n      `${decision} for ${approvalId}`,\r\n      { approvalId, decision, reason, decidedAt: now },\r\n    );\r\n\r\n    return response(200, { ok: true, approvalId, status: newStatus });\r\n  } catch (err: any) {\r\n    console.error(\"[approve] error:\", err);\r\n\r\n    if (err?.name === \"ConditionalCheckFailedException\") {\r\n      return response(200, { ok: true, idempotent: true });\r\n    }\r\n\r\n    return response(500, { message: \"Internal error\" });\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["approve_closet_upload_exports", "__export", "handler", "__toCommonJS", "import_client_sfn", "import_client_dynamodb", "import_lib_dynamodb", "import_client_eventbridge", "import_client_sns", "sfn", "ddb", "eb", "sns", "TABLE_NAME", "AUDIT_TABLE_NAME", "PK_NAME", "SK_NAME", "NOTIFY_TOPIC_ARN", "response", "statusCode", "body", "emit", "detailType", "detail", "err", "notify", "subject", "message", "audit", "action", "approvalId", "ts", "event", "decision", "pk", "sk", "Item", "taskToken", "reason", "now", "newStatus"]
}
