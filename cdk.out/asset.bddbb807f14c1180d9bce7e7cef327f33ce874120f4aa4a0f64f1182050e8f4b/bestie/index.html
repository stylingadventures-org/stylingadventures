<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Styling Adventures · Bestie</title>

  <!-- Global styles -->
  <link rel="stylesheet" href="/styles.css" />

  <!-- Global SA boot (sets window.sa.cfg, graphql(), etc.) -->
  <script defer src="/sa.js"></script>

  <!-- Optional: small nav helper (no-op if those ids aren’t present) -->
  <script defer src="/partials/site-nav.js"></script>
</head>
<body class="sa-body">
  <header class="sa-top">
    <div class="brand">Styling Adventures</div>
    <nav class="chips">
      <a href="/?tab=fan" class="chip">Fan</a>
      <a href="/bestie/index.html" class="chip chip--active">Bestie</a>
      <a href="/collab/" class="chip">Collab</a>
      <a href="/prime/"  class="chip">Prime</a>
    </nav>
    <div class="chips" style="margin-left:auto">
      <span id="who-email" class="sa-muted">Not signed in</span>
      <a id="signin" href="#" class="chip">Sign in</a>
      <button id="signout" class="chip chip--primary">Sign out</button>
    </div>
  </header>

  <main class="wrap">
    <h1 class="sa-h1" style="margin-bottom: 6px;">Bestie dashboard</h1>
    <p class="sa-muted">Perks, early drops, and exclusive content.</p>

    <section class="sa-card" style="margin-top:16px">
      <h2>Membership</h2>
      <div id="auth-note" class="sa-muted" style="margin-bottom:8px">Checking…</div>

      <div class="chips" style="gap:8px">
        <button id="btn-claim"  class="sa-btn sa-btn--primary">Unlock with Bestie</button>
        <button id="btn-recheck" class="sa-btn">Recheck</button>
      </div>

      <div class="sa-muted" style="margin-top:10px" aria-live="polite">
        <span id="bestie-status">Status: unknown</span>
      </div>
    </section>

    <div class="grid" style="margin-top:16px">
      <section class="sa-card">
        <h2>My Profile</h2>
        <pre id="me" class="sa-pre sa-muted">Not loaded</pre>
        <button id="btn-load-me" class="sa-btn">Load Profile</button>
      </section>

      <section class="sa-card">
        <h2>GraphQL</h2>
        <button id="btn-hello" class="sa-btn">Call { hello }</button>
        <p id="hello-out" class="sa-muted" aria-live="polite">—</p>
      </section>
    </div>

    <p class="mt-2"><a class="sa-link" href="/">← Back to Home</a></p>
  </main>

  <script>
    // ─────────────────────────────────────────────────────────────────────
    // Hosted UI helpers (implicit flow) – keep in sync with /lib/sa-login.js
    // ─────────────────────────────────────────────────────────────────────
    function hostedUiLoginUrl(cfg) {
      const redirect = new URL("/callback/index.html", window.location.origin).toString();
      const u = new URL(`https://${cfg.cognitoDomain}/login`);
      u.searchParams.set("client_id", cfg.cognitoWebClientId);
      u.searchParams.set("response_type", "token");
      u.searchParams.set("scope", "openid profile email");
      u.searchParams.set("redirect_uri", redirect);
      return u.toString();
    }
    function hostedUiLogoutUrl(cfg) {
      const redirect = new URL("/", window.location.origin).toString();
      const u = new URL(`https://${cfg.cognitoDomain}/logout`);
      u.searchParams.set("client_id", cfg.cognitoWebClientId);
      u.searchParams.set("logout_uri", redirect);
      return u.toString();
    }

    // ─────────────────────────────────────────────────────────────────────
    // Tiny GraphQL fallback (if window.sa.graphql isn’t ready yet)
    // ─────────────────────────────────────────────────────────────────────
    async function fallbackGraphql(query, variables) {
      const url = window.sa?.cfg?.appsyncUrl;
      const idToken =
        localStorage.getItem("sa:idToken") ||
        (window.sa?.session && window.sa.session.idToken);
      if (!url || !idToken) throw new Error("Not signed in");
      const res = await fetch(url, {
        method: "POST",
        headers: { "content-type": "application/json", authorization: idToken },
        body: JSON.stringify({ query, variables }),
      });
      const json = await res.json();
      if (json.errors?.length) throw new Error(json.errors[0].message);
      return json.data;
    }
    async function gql(query, vars) {
      if (window.sa?.graphql) return window.sa.graphql(query, vars);
      return fallbackGraphql(query, vars);
    }

    // ─────────────────────────────────────────────────────────────────────
    // Page wiring
    // ─────────────────────────────────────────────────────────────────────
    const Q = {
      me: `query { me { id email role tier } }`,
      hello: `query { hello }`,
      bestieStatus: `query { meBestieStatus { active since until source } }`,
      claimTrial:  `mutation { claimBestieTrial { active since until source } }`,
    };

    function renderEmail() {
      const emailEl = document.getElementById("who-email");
      const idToken = localStorage.getItem("sa:idToken");
      const email = window.sa?.session?.email || window.sa?.getEmail?.();
      emailEl.textContent = idToken ? (email || "Signed in") : "Not signed in";
    }

    async function loadBestieStatus() {
      const note = document.getElementById("auth-note");
      const out  = document.getElementById("bestie-status");
      try {
        note.textContent = "Checking…";
        const data = await gql(Q.bestieStatus);
        const s = data?.meBestieStatus;
        if (s?.active) {
          out.textContent = `Status: ACTIVE (since ${s.since || "—"})`;
        } else {
          out.textContent = "Status: Not a Bestie yet";
        }
      } catch (e) {
        out.textContent = "Status: unknown";
        note.textContent = "Not signed in";
        return;
      }
      note.textContent = "";
    }

    async function claimTrial() {
      const out  = document.getElementById("bestie-status");
      const note = document.getElementById("auth-note");
      try {
        note.textContent = "Applying trial…";
        const data = await gql(Q.claimTrial);
        const s = data?.claimBestieTrial;
        if (s?.active) {
          out.textContent = `Status: ACTIVE (since ${s.since || "—"})`;
        } else {
          out.textContent = "Status: Not a Bestie yet";
        }
      } catch (e) {
        note.textContent = String(e?.message || e);
      } finally {
        setTimeout(() => (note.textContent = ""), 1200);
      }
    }

    async function loadMe() {
      const pre = document.getElementById("me");
      try {
        const data = await gql(Q.me);
        pre.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        pre.textContent = String(e?.message || e);
      }
    }

    async function callHello() {
      const p = document.getElementById("hello-out");
      try {
        const data = await gql(Q.hello);
        p.textContent = data?.hello || "No response";
      } catch (e) {
        p.textContent = String(e?.message || e);
      }
    }

    function wireAuthButtons() {
      const signIn  = document.getElementById("signin");
      const signOut = document.getElementById("signout");
      signIn.addEventListener("click", (e) => {
        e.preventDefault();
        sessionStorage.setItem("sa:returnTo", "/bestie/index.html");
        window.location.href = hostedUiLoginUrl(window.sa.cfg);
      });
      signOut.addEventListener("click", () => {
        try {
          localStorage.removeItem("sa:idToken");
          localStorage.removeItem("sa:accessToken");
          localStorage.removeItem("sa:expiresAt");
        } catch {}
        window.location.href = hostedUiLogoutUrl(window.sa.cfg);
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      // Wire UI
      document.getElementById("btn-hello").addEventListener("click", callHello);
      document.getElementById("btn-load-me").addEventListener("click", loadMe);
      document.getElementById("btn-claim").addEventListener("click", claimTrial);
      document.getElementById("btn-recheck").addEventListener("click", loadBestieStatus);

      wireAuthButtons();
      renderEmail();
      loadBestieStatus();

      // keep email sign-in indicator fresh
      setInterval(renderEmail, 1500);
    });
  </script>
</body>
</html>
