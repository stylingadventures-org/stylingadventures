"use strict";var K=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var H=Object.prototype.hasOwnProperty;var z=(e,t)=>{for(var r in t)K(e,r,{get:t[r],enumerable:!0})},G=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of v(t))!H.call(e,s)&&s!==r&&K(e,s,{get:()=>t[s],enumerable:!(n=M(t,s))||n.enumerable});return e};var W=e=>G(K({},"__esModule",{value:!0}),e);var we={};z(we,{handler:()=>F});module.exports=W(we);var V=require("@aws-sdk/client-dynamodb"),i=require("@aws-sdk/lib-dynamodb");var p=[];for(let e=0;e<256;++e)p.push((e+256).toString(16).slice(1));function D(e,t=0){return(p[e[t+0]]+p[e[t+1]]+p[e[t+2]]+p[e[t+3]]+"-"+p[e[t+4]]+p[e[t+5]]+"-"+p[e[t+6]]+p[e[t+7]]+"-"+p[e[t+8]]+p[e[t+9]]+"-"+p[e[t+10]]+p[e[t+11]]+p[e[t+12]]+p[e[t+13]]+p[e[t+14]]+p[e[t+15]]).toLowerCase()}var q=require("crypto"),N=new Uint8Array(256),h=N.length;function _(){return h>N.length-16&&((0,q.randomFillSync)(N),h=0),N.slice(h,h+=16)}var L=require("crypto"),B={randomUUID:L.randomUUID};function J(e,t,r){if(B.randomUUID&&!t&&!e)return B.randomUUID();e=e||{};let n=e.random??e.rng?.()??_();if(n.length<16)throw new Error("Random bytes length must be >= 16");if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,t){if(r=r||0,r<0||r+16>t.length)throw new RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let s=0;s<16;++s)t[r+s]=n[s];return t}return D(n)}var x=J;var k=require("@aws-sdk/client-s3"),P=require("@aws-sdk/s3-request-presigner"),l=i.DynamoDBDocumentClient.from(new V.DynamoDBClient({})),Q=new k.S3Client({}),c=process.env.TABLE_NAME,X=process.env.CREATOR_MEDIA_BUCKET,d=process.env.PK_NAME||"pk",u=process.env.SK_NAME||"sk",Z=process.env.STATUS_GSI||"gsi1";function m(){return new Date().toISOString()}var F=async e=>{console.log("[CreatorTools] event",JSON.stringify(e));let t=e.info?.fieldName,r=e.identity?.sub||e.identity?.claims?.sub||"anonymous";switch(t){case"creatorCabinets":return Y(r);case"creatorCabinet":return S(r,e.arguments?.id);case"createCreatorCabinet":return ee(r,e.arguments?.input);case"updateCreatorCabinet":return te(r,e.arguments?.id,e.arguments?.input);case"deleteCreatorCabinet":return re(r,e.arguments?.id);case"creatorFolders":return ne(r,e.arguments?.cabinetId);case"createCreatorFolder":return se(r,e.arguments?.input);case"renameCreatorFolder":return oe(r,e.arguments?.input);case"deleteCreatorFolder":return ae(r,e.arguments?.id,e.arguments?.cabinetId);case"creatorCabinetAssets":return ie(r,e.arguments);case"createCreatorAssetUpload":return de(r,e.arguments?.input);case"updateCreatorAsset":return ue(r,e.arguments?.input);case"deleteCreatorAsset":return le(r,e.arguments?.id,e.arguments?.cabinetId);case"moveCreatorAsset":return ce(r,e.arguments?.input);case"creatorAiSuggest":return pe(e);default:throw new Error(`Unknown field ${t}`)}};function O(e){return e?{id:e.id,ownerSub:e.ownerSub,name:e.name,description:e.description??null,defaultCategory:e.defaultCategory??null,tags:e.tags??[],createdAt:e.createdAt,updatedAt:e.updatedAt,assetCount:e.assetCount??0}:null}function U(e){return e?{id:e.id,cabinetId:e.cabinetId,name:e.name,specialKind:e.specialKind??null,createdAt:e.createdAt,updatedAt:e.updatedAt}:null}function R(e){if(!e)return null;let t=e.kind||"OTHER",r=t==="PHOTO"||t==="VIDEO"?t:"OTHER";return{id:e.id,cabinetId:e.cabinetId,folderId:e.folderId??null,ownerSub:e.ownerSub,kind:r,category:e.category??null,title:e.title??null,notes:e.notes??null,tags:e.tags??[],s3Key:e.s3Key,contentType:e.contentType??null,createdAt:e.createdAt,updatedAt:e.updatedAt}}async function Y(e){return((await l.send(new i.QueryCommand({TableName:c,IndexName:Z,KeyConditionExpression:"#gpk = :gpk AND begins_with(#gsk, :prefix)",ExpressionAttributeNames:{"#gpk":"gsi1pk","#gsk":"gsi1sk"},ExpressionAttributeValues:{":gpk":`CREATOR#${e}`,":prefix":"CAB#"}}))).Items??[]).map(O)}async function S(e,t){if(!t)throw new Error("id is required");let r=await l.send(new i.GetCommand({TableName:c,Key:{[d]:`CAB#${t}`,[u]:"META"}}));return!r.Item||r.Item.ownerSub!==e?null:O(r.Item)}async function ee(e,t){if(!t?.name)throw new Error("name is required");let r=x(),n=m(),s={[d]:`CAB#${r}`,[u]:"META",type:"CABINET",id:r,ownerSub:e,name:t.name,description:t.description??null,defaultCategory:t.defaultCategory??null,tags:t.tags??[],assetCount:0,createdAt:n,updatedAt:n,gsi1pk:`CREATOR#${e}`,gsi1sk:`CAB#${n}#${r}`};return await l.send(new i.PutCommand({TableName:c,Item:s,ConditionExpression:"attribute_not_exists(#pk)",ExpressionAttributeNames:{"#pk":d}})),O(s)}async function te(e,t,r){if(!t)throw new Error("id is required");if(!r)throw new Error("input is required");let n=m(),s={"#updatedAt":"updatedAt","#ownerSub":"ownerSub"},o={":updatedAt":n,":ownerSub":e},a=["#updatedAt = :updatedAt"];Object.prototype.hasOwnProperty.call(r,"name")&&(s["#name"]="name",o[":name"]=r.name,a.push("#name = :name")),Object.prototype.hasOwnProperty.call(r,"description")&&(s["#description"]="description",o[":description"]=r.description??null,a.push("#description = :description")),Object.prototype.hasOwnProperty.call(r,"defaultCategory")&&(s["#defaultCategory"]="defaultCategory",o[":defaultCategory"]=r.defaultCategory??null,a.push("#defaultCategory = :defaultCategory")),Object.prototype.hasOwnProperty.call(r,"tags")&&(s["#tags"]="tags",o[":tags"]=r.tags??[],a.push("#tags = :tags"));let w=await l.send(new i.UpdateCommand({TableName:c,Key:{[d]:`CAB#${t}`,[u]:"META"},UpdateExpression:"SET "+a.join(", "),ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:s,ExpressionAttributeValues:o,ReturnValues:"ALL_NEW"}));return O(w.Attributes)}async function re(e,t){if(!t)throw new Error("id is required");let r=`CAB#${t}`,s=(await l.send(new i.QueryCommand({TableName:c,KeyConditionExpression:"#pk = :pk",ExpressionAttributeNames:{"#pk":d},ExpressionAttributeValues:{":pk":r}}))).Items??[],o=s.find(a=>a.type==="CABINET");return!o||o.ownerSub!==e?!1:(await Promise.all(s.map(a=>l.send(new i.DeleteCommand({TableName:c,Key:{[d]:a[d],[u]:a[u]}})))),!0)}async function ne(e,t){if(!t)throw new Error("cabinetId is required");return await S(e,t)?((await l.send(new i.QueryCommand({TableName:c,KeyConditionExpression:"#pk = :pk AND begins_with(#sk, :prefix)",ExpressionAttributeNames:{"#pk":d,"#sk":u},ExpressionAttributeValues:{":pk":`CAB#${t}`,":prefix":"FOLDER#"}}))).Items??[]).map(U):[]}async function se(e,t){let{cabinetId:r,name:n}=t||{};if(!r)throw new Error("cabinetId is required");if(!n)throw new Error("name is required");if(!await S(e,r))throw new Error("Cabinet not found");let o=x(),a=m(),w={[d]:`CAB#${r}`,[u]:`FOLDER#${o}`,type:"FOLDER",id:o,cabinetId:r,ownerSub:e,name:n,specialKind:null,createdAt:a,updatedAt:a};return await l.send(new i.PutCommand({TableName:c,Item:w,ConditionExpression:"attribute_not_exists(#pk) AND attribute_not_exists(#sk)",ExpressionAttributeNames:{"#pk":d,"#sk":u}})),U(w)}async function oe(e,t){let{id:r,cabinetId:n,name:s}=t||{};if(!r)throw new Error("id is required");if(!n)throw new Error("cabinetId is required");if(!s)throw new Error("name is required");let o=m(),a=await l.send(new i.UpdateCommand({TableName:c,Key:{[d]:`CAB#${n}`,[u]:`FOLDER#${r}`},UpdateExpression:"SET #name = :name, #updatedAt = :updatedAt",ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:{"#name":"name","#updatedAt":"updatedAt","#ownerSub":"ownerSub"},ExpressionAttributeValues:{":name":s,":updatedAt":o,":ownerSub":e},ReturnValues:"ALL_NEW"}));return U(a.Attributes)}async function ae(e,t,r){if(!t)throw new Error("id is required");if(!r)throw new Error("cabinetId is required");await l.send(new i.DeleteCommand({TableName:c,Key:{[d]:`CAB#${r}`,[u]:`FOLDER#${t}`},ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:{"#ownerSub":"ownerSub"},ExpressionAttributeValues:{":ownerSub":e}}));let s=(await l.send(new i.QueryCommand({TableName:c,KeyConditionExpression:"#pk = :pk AND begins_with(#sk, :prefix)",FilterExpression:"#folderId = :folderId",ExpressionAttributeNames:{"#pk":d,"#sk":u,"#folderId":"folderId"},ExpressionAttributeValues:{":pk":`CAB#${r}`,":prefix":"ASSET#",":folderId":t}}))).Items??[];return await Promise.all(s.map(o=>l.send(new i.UpdateCommand({TableName:c,Key:{[d]:o[d],[u]:o[u]},UpdateExpression:"SET #folderId = :null",ExpressionAttributeNames:{"#folderId":"folderId"},ExpressionAttributeValues:{":null":null}})))),!0}async function ie(e,t){let{cabinetId:r,folderId:n,category:s,tag:o,search:a,limit:w=50,nextToken:b}=t||{};if(!r)throw new Error("cabinetId is required");if(!await S(e,r))return{items:[],nextToken:null};let E={TableName:c,KeyConditionExpression:"#pk = :pk AND begins_with(#sk, :prefix)",ExpressionAttributeNames:{"#pk":d,"#sk":u},ExpressionAttributeValues:{":pk":`CAB#${r}`,":prefix":"ASSET#"},Limit:w};b&&(E.ExclusiveStartKey={[d]:`CAB#${r}`,[u]:b});let I=await l.send(new i.QueryCommand(E)),f=(I.Items??[]).filter(A=>A.type==="ASSET");if(n!=null&&(f=f.filter(A=>A.folderId===n)),s&&(f=f.filter(A=>A.category===s)),o&&(f=f.filter(A=>Array.isArray(A.tags)&&A.tags.includes(o))),a){let A=String(a).toLowerCase();f=f.filter(y=>{let g=(y.title??"").toLowerCase(),T=(y.notes??"").toLowerCase();return g.includes(A)||T.includes(A)})}let $=I.LastEvaluatedKey?I.LastEvaluatedKey[u]:null;return{items:f.map(R),nextToken:$}}async function de(e,t){let{cabinetId:r,folderId:n,category:s,title:o,notes:a,tags:w=[],filename:b,contentType:C,kind:E}=t||{};if(!r)throw new Error("cabinetId is required");if(!b)throw new Error("filename is required");if(!C)throw new Error("contentType is required");if(!await S(e,r))throw new Error("Cabinet not found");let f=x(),$=n||"unsorted",A=b.replace(/[^a-zA-Z0-9._-]/g,"_"),y=["creator-media",e,r,$,`${f}-${A}`].join("/"),g=m(),T=E==="PHOTO"||E==="VIDEO"?E:"OTHER";await l.send(new i.PutCommand({TableName:c,Item:{[d]:`CAB#${r}`,[u]:`ASSET#${f}`,type:"ASSET",id:f,cabinetId:r,folderId:n??null,ownerSub:e,kind:T,category:s??null,title:o??null,notes:a??null,tags:w,s3Key:y,contentType:C,createdAt:g,updatedAt:g}})),await l.send(new i.UpdateCommand({TableName:c,Key:{[d]:`CAB#${r}`,[u]:"META"},UpdateExpression:"SET #assetCount = if_not_exists(#assetCount, :zero) + :one, #updatedAt = :updatedAt",ExpressionAttributeNames:{"#assetCount":"assetCount","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":zero":0,":one":1,":updatedAt":g}}));let j=new k.PutObjectCommand({Bucket:X,Key:y,ContentType:C});return{uploadUrl:await(0,P.getSignedUrl)(Q,j,{expiresIn:900}),asset:{id:f,cabinetId:r,folderId:n,ownerSub:e,kind:T,category:s,title:o,notes:a,tags:w,s3Key:y,contentType:C,createdAt:g,updatedAt:g}}}async function ue(e,t){let{id:r,cabinetId:n}=t||{};if(!r)throw new Error("id is required");if(!n)throw new Error("cabinetId is required");let s=m(),o={"#updatedAt":"updatedAt","#ownerSub":"ownerSub"},a={":updatedAt":s,":ownerSub":e},w=["#updatedAt = :updatedAt"];Object.prototype.hasOwnProperty.call(t,"folderId")&&(o["#folderId"]="folderId",a[":folderId"]=t.folderId??null,w.push("#folderId = :folderId")),Object.prototype.hasOwnProperty.call(t,"category")&&(o["#category"]="category",a[":category"]=t.category??null,w.push("#category = :category")),Object.prototype.hasOwnProperty.call(t,"title")&&(o["#title"]="title",a[":title"]=t.title??null,w.push("#title = :title")),Object.prototype.hasOwnProperty.call(t,"notes")&&(o["#notes"]="notes",a[":notes"]=t.notes??null,w.push("#notes = :notes")),Object.prototype.hasOwnProperty.call(t,"tags")&&(o["#tags"]="tags",a[":tags"]=t.tags??[],w.push("#tags = :tags"));let b=await l.send(new i.UpdateCommand({TableName:c,Key:{[d]:`CAB#${n}`,[u]:`ASSET#${r}`},UpdateExpression:"SET "+w.join(", "),ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:o,ExpressionAttributeValues:a,ReturnValues:"ALL_NEW"}));return R(b.Attributes)}async function le(e,t,r){if(!t)throw new Error("id is required");if(!r)throw new Error("cabinetId is required");let n=m();return await l.send(new i.DeleteCommand({TableName:c,Key:{[d]:`CAB#${r}`,[u]:`ASSET#${t}`},ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:{"#ownerSub":"ownerSub"},ExpressionAttributeValues:{":ownerSub":e}})),await l.send(new i.UpdateCommand({TableName:c,Key:{[d]:`CAB#${r}`,[u]:"META"},UpdateExpression:"SET #assetCount = if_not_exists(#assetCount, :zero) - :one, #updatedAt = :updatedAt",ExpressionAttributeNames:{"#assetCount":"assetCount","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":zero":0,":one":1,":updatedAt":n}})),!0}async function ce(e,t){let{id:r,cabinetId:n,destinationFolderId:s}=t||{};if(!r)throw new Error("id is required");if(!n)throw new Error("cabinetId is required");let o=m(),a=await l.send(new i.UpdateCommand({TableName:c,Key:{[d]:`CAB#${n}`,[u]:`ASSET#${r}`},UpdateExpression:"SET #folderId = :folderId, #updatedAt = :updatedAt",ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:{"#folderId":"folderId","#updatedAt":"updatedAt","#ownerSub":"ownerSub"},ExpressionAttributeValues:{":folderId":s??null,":updatedAt":o,":ownerSub":e},ReturnValues:"ALL_NEW"}));return R(a.Attributes)}async function pe(e){let t=e.arguments?.text??"",r=e.arguments?.kind??"OTHER",n=t||"your content",s=[];return r==="CAPTION"?s.push(`Behind the scenes of ${n} \u2728`,`Styling ${n} so you don't have to \u{1F485}`):r==="HASHTAGS"?s.push("#stylingadventures #creatorlife #behindthescenes","#outfitinspo #contentcreator #filmingday"):s.push(`Planning ideas for ${n}`),{suggestions:s}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
