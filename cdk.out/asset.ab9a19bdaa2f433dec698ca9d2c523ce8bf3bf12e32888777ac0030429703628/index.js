"use strict";var a=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var g=(e,n)=>{for(var s in n)a(e,s,{get:n[s],enumerable:!0})},y=(e,n,s,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of E(n))!A.call(e,r)&&r!==s&&a(e,r,{get:()=>n[r],enumerable:!(t=u(n,r))||t.enumerable});return e};var f=e=>y(a({},"__esModule",{value:!0}),e);var b={};g(b,{handler:()=>x});module.exports=f(b);var m=require("@aws-sdk/client-dynamodb"),o=require("@aws-sdk/lib-dynamodb");var i=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!i)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var l=o.DynamoDBDocumentClient.from(new m.DynamoDBClient({})),p=e=>`USER#${e}`,d="PROFILE";async function c(e){let n=p(e),{Item:s}=await l.send(new o.GetCommand({TableName:i,Key:{pk:n,sk:d}}));if(!s){let t={userId:e,level:1,xp:0,coins:0,badges:[],lastEventAt:Date.now()};return await l.send(new o.UpdateCommand({TableName:i,Key:{pk:n,sk:d},UpdateExpression:"SET #uid=:uid, #lvl=:lvl, #xp=:xp, #coins=:coins, #badges=:badges, #ts=:ts",ExpressionAttributeNames:{"#uid":"userId","#lvl":"level","#xp":"xp","#coins":"coins","#badges":"badges","#ts":"lastEventAt"},ExpressionAttributeValues:{":uid":t.userId,":lvl":t.level,":xp":t.xp,":coins":t.coins,":badges":t.badges,":ts":t.lastEventAt}})),t}return{userId:s.userId,level:s.level??1,xp:s.xp??0,coins:s.coins??0,badges:s.badges??[],displayName:s.displayName??null,lastEventAt:s.lastEventAt??null}}async function v(e,n){let s=p(e),t=(n??"").trim().slice(0,40),r=Date.now();return await l.send(new o.UpdateCommand({TableName:i,Key:{pk:s,sk:d},UpdateExpression:"SET #dn=:dn, #ts=:ts ADD #lvl :zero, #xpv :zero2, #coins :zero3",ExpressionAttributeNames:{"#dn":"displayName","#ts":"lastEventAt","#lvl":"level","#xpv":"xp","#coins":"coins"},ExpressionAttributeValues:{":dn":t,":ts":r,":zero":0,":zero2":0,":zero3":0}})),c(e)}var x=async(e,n)=>{let s=e.identity?.sub;if(!s)throw new Error("Unauthorized: missing sub");switch(e.info.fieldName){case"getMyProfile":return c(s);case"setDisplayName":return v(s,e.arguments.displayName);case"grantBadge":throw new Error("grantBadge not implemented in ProfileFn");default:throw new Error(`Unknown field ${e.info.fieldName}`)}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
