{
  "version": 3,
  "sources": ["../../lambda/game/profile.ts", "../../lambda/_shared/env.ts"],
  "sourcesContent": ["import { APIGatewayProxyResult, Context } from \"aws-lambda\";\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  GetCommand,\r\n  UpdateCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\nimport { TABLE_NAME } from \"../_shared/env\";\r\n\r\n/**\r\n * Table layout (existing):\r\n *  PK = 'USER#{sub}', SK = 'PROFILE'\r\n *  Item: { pk, sk, userId, level, xp, coins, badges, displayName?, lastEventAt? }\r\n */\r\n\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}));\r\n\r\ntype AppSyncEvent = {\r\n  info: { fieldName: string };\r\n  arguments: any;\r\n  identity?: { sub?: string };\r\n};\r\n\r\ntype GameProfile = {\r\n  userId: string;\r\n  level: number;\r\n  xp: number;\r\n  coins: number;\r\n  badges?: string[];\r\n  displayName?: string | null;\r\n  lastEventAt?: number | null;\r\n};\r\n\r\nconst PK = (sub: string) => `USER#${sub}`;\r\nconst SK = \"PROFILE\";\r\n\r\nasync function getMyProfile(sub: string): Promise<GameProfile> {\r\n  const pk = PK(sub);\r\n  const { Item } = await ddb.send(\r\n    new GetCommand({ TableName: TABLE_NAME, Key: { pk, sk: SK } })\r\n  );\r\n\r\n  // If profile doesn\u2019t exist yet, seed a minimal record.\r\n  if (!Item) {\r\n    const seed: GameProfile = {\r\n      userId: sub,\r\n      level: 1,\r\n      xp: 0,\r\n      coins: 0,\r\n      badges: [],\r\n      lastEventAt: Date.now(),\r\n    };\r\n    await ddb.send(\r\n      new UpdateCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: { pk, sk: SK },\r\n        UpdateExpression:\r\n          \"SET #uid=:uid, #lvl=:lvl, #xp=:xp, #coins=:coins, #badges=:badges, #ts=:ts\",\r\n        ExpressionAttributeNames: {\r\n          \"#uid\": \"userId\",\r\n          \"#lvl\": \"level\",\r\n          \"#xp\": \"xp\",\r\n          \"#coins\": \"coins\",\r\n          \"#badges\": \"badges\",\r\n          \"#ts\": \"lastEventAt\",\r\n        },\r\n        ExpressionAttributeValues: {\r\n          \":uid\": seed.userId,\r\n          \":lvl\": seed.level,\r\n          \":xp\": seed.xp,\r\n          \":coins\": seed.coins,\r\n          \":badges\": seed.badges,\r\n          \":ts\": seed.lastEventAt,\r\n        },\r\n      })\r\n    );\r\n    return seed;\r\n  }\r\n\r\n  return {\r\n    userId: Item.userId,\r\n    level: Item.level ?? 1,\r\n    xp: Item.xp ?? 0,\r\n    coins: Item.coins ?? 0,\r\n    badges: Item.badges ?? [],\r\n    displayName: Item.displayName ?? null,\r\n    lastEventAt: Item.lastEventAt ?? null,\r\n  };\r\n}\r\n\r\nasync function setDisplayName(sub: string, displayName: string): Promise<GameProfile> {\r\n  const pk = PK(sub);\r\n\r\n  // Normalize & trim\r\n  const name = (displayName ?? \"\").trim().slice(0, 40);\r\n\r\n  // Update profile\r\n  const now = Date.now();\r\n  await ddb.send(\r\n    new UpdateCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: { pk, sk: SK },\r\n      UpdateExpression:\r\n        \"SET #dn=:dn, #ts=:ts ADD #lvl :zero, #xpv :zero2, #coins :zero3\",\r\n      ExpressionAttributeNames: {\r\n        \"#dn\": \"displayName\",\r\n        \"#ts\": \"lastEventAt\",\r\n        \"#lvl\": \"level\",\r\n        \"#xpv\": \"xp\",\r\n        \"#coins\": \"coins\",\r\n      },\r\n      ExpressionAttributeValues: {\r\n        \":dn\": name,\r\n        \":ts\": now,\r\n        // The ADD lines are harmless no-ops if attrs are numbers; they ensure record exists\r\n        \":zero\": 0,\r\n        \":zero2\": 0,\r\n        \":zero3\": 0,\r\n      },\r\n    })\r\n  );\r\n\r\n  // Return fresh profile\r\n  return getMyProfile(sub);\r\n}\r\n\r\nexport const handler = async (\r\n  event: AppSyncEvent,\r\n  _ctx: Context\r\n): Promise<APIGatewayProxyResult | GameProfile> => {\r\n  const sub = event.identity?.sub;\r\n  if (!sub) {\r\n    throw new Error(\"Unauthorized: missing sub\");\r\n  }\r\n\r\n  switch (event.info.fieldName) {\r\n    case \"getMyProfile\":\r\n      return getMyProfile(sub);\r\n\r\n    case \"setDisplayName\":\r\n      return setDisplayName(sub, event.arguments.displayName);\r\n\r\n    // you may already have this; keep it here for completeness:\r\n    case \"grantBadge\": {\r\n      // noop here \u2013 your existing grantBadge resolver lives elsewhere\r\n      throw new Error(\"grantBadge not implemented in ProfileFn\");\r\n    }\r\n\r\n    default:\r\n      throw new Error(`Unknown field ${event.info.fieldName}`);\r\n  }\r\n};\r\n", "// lambda/_shared/env.ts\r\nexport const TABLE_NAME =\r\n  process.env.TABLE_NAME ??\r\n  process.env.APP_TABLE ??\r\n  process.env.TABLE ??\r\n  \"\";\r\n\r\nif (!TABLE_NAME) {\r\n  // Fail fast at cold start so you notice during deploy/tests\r\n  throw new Error(\r\n    \"Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).\"\r\n  );\r\n}\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GACA,IAAAI,EAA+B,oCAC/BC,EAIO,iCCLA,IAAMC,EACX,QAAQ,IAAI,YACZ,QAAQ,IAAI,WACZ,QAAQ,IAAI,OACZ,GAEF,GAAI,CAACA,EAEH,MAAM,IAAI,MACR,wEACF,EDIF,IAAMC,EAAM,yBAAuB,KAAK,IAAI,iBAAe,CAAC,CAAC,CAAC,EAkBxDC,EAAMC,GAAgB,QAAQA,CAAG,GACjCC,EAAK,UAEX,eAAeC,EAAaF,EAAmC,CAC7D,IAAMG,EAAKJ,EAAGC,CAAG,EACX,CAAE,KAAAI,CAAK,EAAI,MAAMN,EAAI,KACzB,IAAI,aAAW,CAAE,UAAWO,EAAY,IAAK,CAAE,GAAAF,EAAI,GAAIF,CAAG,CAAE,CAAC,CAC/D,EAGA,GAAI,CAACG,EAAM,CACT,IAAME,EAAoB,CACxB,OAAQN,EACR,MAAO,EACP,GAAI,EACJ,MAAO,EACP,OAAQ,CAAC,EACT,YAAa,KAAK,IAAI,CACxB,EACA,aAAMF,EAAI,KACR,IAAI,gBAAc,CAChB,UAAWO,EACX,IAAK,CAAE,GAAAF,EAAI,GAAIF,CAAG,EAClB,iBACE,6EACF,yBAA0B,CACxB,OAAQ,SACR,OAAQ,QACR,MAAO,KACP,SAAU,QACV,UAAW,SACX,MAAO,aACT,EACA,0BAA2B,CACzB,OAAQK,EAAK,OACb,OAAQA,EAAK,MACb,MAAOA,EAAK,GACZ,SAAUA,EAAK,MACf,UAAWA,EAAK,OAChB,MAAOA,EAAK,WACd,CACF,CAAC,CACH,EACOA,CACT,CAEA,MAAO,CACL,OAAQF,EAAK,OACb,MAAOA,EAAK,OAAS,EACrB,GAAIA,EAAK,IAAM,EACf,MAAOA,EAAK,OAAS,EACrB,OAAQA,EAAK,QAAU,CAAC,EACxB,YAAaA,EAAK,aAAe,KACjC,YAAaA,EAAK,aAAe,IACnC,CACF,CAEA,eAAeG,EAAeP,EAAaQ,EAA2C,CACpF,IAAML,EAAKJ,EAAGC,CAAG,EAGXS,GAAQD,GAAe,IAAI,KAAK,EAAE,MAAM,EAAG,EAAE,EAG7CE,EAAM,KAAK,IAAI,EACrB,aAAMZ,EAAI,KACR,IAAI,gBAAc,CAChB,UAAWO,EACX,IAAK,CAAE,GAAAF,EAAI,GAAIF,CAAG,EAClB,iBACE,kEACF,yBAA0B,CACxB,MAAO,cACP,MAAO,cACP,OAAQ,QACR,OAAQ,KACR,SAAU,OACZ,EACA,0BAA2B,CACzB,MAAOQ,EACP,MAAOC,EAEP,QAAS,EACT,SAAU,EACV,SAAU,CACZ,CACF,CAAC,CACH,EAGOR,EAAaF,CAAG,CACzB,CAEO,IAAMW,EAAU,MACrBC,EACAC,IACiD,CACjD,IAAMb,EAAMY,EAAM,UAAU,IAC5B,GAAI,CAACZ,EACH,MAAM,IAAI,MAAM,2BAA2B,EAG7C,OAAQY,EAAM,KAAK,UAAW,CAC5B,IAAK,eACH,OAAOV,EAAaF,CAAG,EAEzB,IAAK,iBACH,OAAOO,EAAeP,EAAKY,EAAM,UAAU,WAAW,EAGxD,IAAK,aAEH,MAAM,IAAI,MAAM,yCAAyC,EAG3D,QACE,MAAM,IAAI,MAAM,iBAAiBA,EAAM,KAAK,SAAS,EAAE,CAC3D,CACF",
  "names": ["profile_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "TABLE_NAME", "ddb", "PK", "sub", "SK", "getMyProfile", "pk", "Item", "TABLE_NAME", "seed", "setDisplayName", "displayName", "name", "now", "handler", "event", "_ctx"]
}
