"use strict";var i=Object.defineProperty;var u=Object.getOwnPropertyDescriptor;var g=Object.getOwnPropertyNames;var y=Object.prototype.hasOwnProperty;var x=(e,t)=>{for(var s in t)i(e,s,{get:t[s],enumerable:!0})},b=(e,t,s,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of g(t))!y.call(e,r)&&r!==s&&i(e,r,{get:()=>t[r],enumerable:!(n=u(t,r))||n.enumerable});return e};var f=e=>b(i({},"__esModule",{value:!0}),e);var w={};x(w,{handler:()=>v});module.exports=f(w);var m=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb"),o=a.DynamoDBDocumentClient.from(new m.DynamoDBClient({})),l=process.env.APP_TABLE,p=e=>`USER#${e}`,d="PROFILE";async function c(e){let t=p(e),{Item:s}=await o.send(new a.GetCommand({TableName:l,Key:{pk:t,sk:d}}));if(!s){let n={userId:e,level:1,xp:0,coins:0,badges:[],lastEventAt:Date.now()};return await o.send(new a.UpdateCommand({TableName:l,Key:{pk:t,sk:d},UpdateExpression:"SET #uid=:uid, #lvl=:lvl, #xp=:xp, #coins=:coins, #badges=:badges, #ts=:ts",ExpressionAttributeNames:{"#uid":"userId","#lvl":"level","#xp":"xp","#coins":"coins","#badges":"badges","#ts":"lastEventAt"},ExpressionAttributeValues:{":uid":n.userId,":lvl":n.level,":xp":n.xp,":coins":n.coins,":badges":n.badges,":ts":n.lastEventAt}})),n}return{userId:s.userId,level:s.level??1,xp:s.xp??0,coins:s.coins??0,badges:s.badges??[],displayName:s.displayName,lastEventAt:s.lastEventAt}}async function E(e,t){let s=p(e),n=(t??"").trim().slice(0,40),r=Date.now();return await o.send(new a.UpdateCommand({TableName:l,Key:{pk:s,sk:d},UpdateExpression:"SET #dn=:dn, #ts=:ts ADD #lvl :zero, #xpv :zero2, #coins :zero3",ExpressionAttributeNames:{"#dn":"displayName","#ts":"lastEventAt","#lvl":"level","#xpv":"xp","#coins":"coins"},ExpressionAttributeValues:{":dn":n,":ts":r,":zero":0,":zero2":0,":zero3":0}})),c(e)}var v=async(e,t)=>{let s=e.identity?.sub;if(!s)throw new Error("Unauthorized: missing sub");switch(e.info.fieldName){case"getMyProfile":return c(s);case"setDisplayName":return E(s,e.arguments.displayName);case"grantBadge":throw new Error("grantBadge not implemented in ProfileFn");default:throw new Error(`Unknown field ${e.info.fieldName}`)}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
