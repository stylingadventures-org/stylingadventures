{
  "version": 3,
  "sources": ["../../lambda/graphql/index.ts"],
  "sourcesContent": ["import {\r\n  BatchGetItemCommand,\r\n  DeleteItemCommand,\r\n  DynamoDBClient,\r\n  PutItemCommand,\r\n  QueryCommand,\r\n  UpdateItemCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport { SFNClient, StartExecutionCommand } from \"@aws-sdk/client-sfn\";\r\nimport { marshall, unmarshall } from \"@aws-sdk/util-dynamodb\";\r\nimport { randomUUID } from \"crypto\";\r\n\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\nconst APPROVAL_SM_ARN = process.env.APPROVAL_SM_ARN!;\r\nconst STATUS_GSI = process.env.STATUS_GSI ?? \"gsi1\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\nconst sfn = new SFNClient({});\r\n\r\ntype ClosetStatus =\r\n  | \"DRAFT\"\r\n  | \"PENDING\"\r\n  | \"APPROVED\"\r\n  | \"REJECTED\"\r\n  | \"PUBLISHED\"\r\n  | \"ARCHIVED\";\r\n\r\ntype ClosetAudience =\r\n  | \"PRIVATE\"\r\n  | \"FOLLOWERS\"\r\n  | \"PUBLIC\"\r\n  | \"BESTIE\"\r\n  | \"EXCLUSIVE\"\r\n  | \"ADMIN_ONLY\"\r\n  | \"HIDDEN\";\r\n\r\ninterface ClosetItem {\r\n  id: string;\r\n  userId: string;\r\n  ownerSub: string;\r\n  status: ClosetStatus;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n\r\n  // S3 keys\r\n  mediaKey?: string;\r\n  rawMediaKey?: string;\r\n\r\n  title?: string;\r\n  reason?: string;\r\n  audience?: ClosetAudience;\r\n\r\n  // New categorization fields\r\n  category?: string | null;\r\n  subcategory?: string | null;\r\n\r\n  // Story-style metadata (Bestie / fan-facing)\r\n  storyTitle?: string;\r\n  storySeason?: string;\r\n  storyVibes?: string[];\r\n\r\n  // Bestie / profile highlight\r\n  pinned?: boolean;\r\n\r\n  // Aggregates\r\n  favoriteCount?: number;\r\n  likeCount?: number;\r\n  commentCount?: number;\r\n  wishlistCount?: number;\r\n\r\n  // Per-viewer flags (set by resolvers)\r\n  viewerHasFaved?: boolean;\r\n  viewerHasLiked?: boolean;\r\n  viewerHasWishlisted?: boolean;\r\n}\r\n\r\ninterface ClosetItemComment {\r\n  id: string;\r\n  closetItemId: string;\r\n  authorSub: string;\r\n  text: string;\r\n  createdAt: string;\r\n}\r\n\r\ninterface ClosetItemLike {\r\n  closetItemId: string;\r\n  likerSub: string;\r\n  createdAt: string;\r\n}\r\n\r\nfunction nowIso() {\r\n  return new Date().toISOString();\r\n}\r\n\r\nfunction pkForUser(userId: string) {\r\n  return `USER#${userId}`;\r\n}\r\n\r\nfunction skForClosetItem(id: string) {\r\n  return `CLOSET#${id}`;\r\n}\r\n\r\n// Root partition for item-level aggregates (likes, comments, etc.)\r\nfunction pkForClosetRoot(closetItemId: string) {\r\n  return `CLOSET#${closetItemId}`;\r\n}\r\n\r\nfunction gsi1ForStatus(status: ClosetStatus) {\r\n  return `CLOSET#STATUS#${status}`;\r\n}\r\n\r\n/**\r\n * Map a raw DynamoDB item into our ClosetItem shape.\r\n */\r\nfunction mapClosetItem(raw: Record<string, any>): ClosetItem {\r\n  const item = unmarshall(raw) as any;\r\n\r\n  const closetItem: ClosetItem = {\r\n    id: item.id,\r\n    userId: item.userId,\r\n    ownerSub: item.ownerSub,\r\n    status: item.status,\r\n    createdAt: item.createdAt,\r\n    updatedAt: item.updatedAt,\r\n    mediaKey: item.mediaKey,\r\n    rawMediaKey: item.rawMediaKey,\r\n    title: item.title,\r\n    reason: item.reason,\r\n    audience: item.audience,\r\n    category: item.category,\r\n    subcategory: item.subcategory,\r\n    storyTitle: item.storyTitle,\r\n    storySeason: item.storySeason,\r\n    storyVibes: item.storyVibes,\r\n    pinned: item.pinned,\r\n    favoriteCount: item.favoriteCount,\r\n    likeCount: item.likeCount,\r\n    commentCount: item.commentCount,\r\n    wishlistCount: item.wishlistCount,\r\n    viewerHasFaved: item.viewerHasFaved,\r\n    viewerHasLiked: item.viewerHasLiked,\r\n    viewerHasWishlisted: item.viewerHasWishlisted,\r\n  };\r\n\r\n  return closetItem;\r\n}\r\n\r\n/**\r\n * Ensure the caller is authenticated and return sub/userId.\r\n */\r\nfunction requireUserSub(identity: any): string {\r\n  if (!identity?.sub) {\r\n    throw new Error(\"Not authenticated\");\r\n  }\r\n  return identity.sub as string;\r\n}\r\n\r\n// add near the top of lambda/graphql/index.ts, next to other helpers if you like\r\nfunction isAdminIdentity(identity: any): boolean {\r\n  const claims = identity?.claims || {};\r\n  const raw = claims[\"cognito:groups\"];\r\n  const groups = Array.isArray(raw)\r\n    ? raw\r\n    : String(raw || \"\")\r\n        .split(\",\")\r\n        .map((g) => g.trim())\r\n        .filter(Boolean);\r\n\r\n  return groups.includes(\"ADMIN\") || groups.includes(\"COLLAB\");\r\n}\r\n\r\n/**\r\n * 1) myCloset \u2013 return all items owned by the current user.\r\n */\r\nasync function handleMyCloset(identity: any): Promise<ClosetItem[]> {\r\n  const sub = requireUserSub(identity);\r\n\r\n  const res = await ddb.send(\r\n    new QueryCommand({\r\n      TableName: TABLE_NAME,\r\n      KeyConditionExpression: \"pk = :pk AND begins_with(sk, :sk)\",\r\n      ExpressionAttributeValues: marshall({\r\n        \":pk\": pkForUser(sub),\r\n        \":sk\": \"CLOSET#\",\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return (res.Items ?? []).map(mapClosetItem);\r\n}\r\n\r\n/**\r\n * 2) createClosetItem \u2013 create a new item in DRAFT.\r\n *    We now accept rawMediaKey = FULL S3 key (including \"closet/\" prefix)\r\n *    and optional category/subcategory.\r\n *\r\n * NOTE: the VTL mapping template may either:\r\n *   - pass the input fields flattened as top-level arguments, or\r\n *   - pass them under args.input.{...}\r\n * This handler assumes the template flattens them.\r\n */\r\nasync function handleCreateClosetItem(\r\n  args: {\r\n    title?: string;\r\n    mediaKey?: string;\r\n    rawMediaKey?: string;\r\n    category?: string | null;\r\n    subcategory?: string | null;\r\n  },\r\n  identity: any,\r\n): Promise<ClosetItem> {\r\n  const sub = requireUserSub(identity);\r\n  const id = randomUUID();\r\n  const now = nowIso();\r\n\r\n  const item: ClosetItem = {\r\n    id,\r\n    userId: sub,\r\n    ownerSub: sub,\r\n    status: \"DRAFT\",\r\n    createdAt: now,\r\n    updatedAt: now,\r\n    mediaKey: args.mediaKey,\r\n    rawMediaKey: args.rawMediaKey,\r\n    title: args.title,\r\n    category: args.category ?? null,\r\n    subcategory: args.subcategory ?? null,\r\n  };\r\n\r\n  await ddb.send(\r\n    new PutItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Item: marshall({\r\n        pk: pkForUser(sub),\r\n        sk: skForClosetItem(id),\r\n\r\n        // status GSI\r\n        gsi1pk: gsi1ForStatus(item.status),\r\n        gsi1sk: now,\r\n\r\n        // rawMediaKey GSI uses \"rawMediaKey\" as its partition key\r\n        // (index name is RAW_MEDIA_GSI_NAME = \"rawMediaKeyIndex\" on the table)\r\n        rawMediaKey: item.rawMediaKey,\r\n\r\n        ...item,\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return item;\r\n}\r\n\r\n/**\r\n * 3) updateClosetMediaKey \u2013 update the media key on an item owned by the user.\r\n *    rawMediaKey stays the same; bg-worker updates mediaKey after cutout.\r\n */\r\nasync function handleUpdateClosetMediaKey(\r\n  args: { id: string; mediaKey: string },\r\n  identity: any,\r\n): Promise<ClosetItem> {\r\n  const sub = requireUserSub(identity);\r\n  const now = nowIso();\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: marshall({\r\n        pk: pkForUser(sub),\r\n        sk: skForClosetItem(args.id),\r\n      }),\r\n      UpdateExpression:\r\n        \"SET mediaKey = :mediaKey, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk\",\r\n      ExpressionAttributeValues: marshall({\r\n        \":mediaKey\": args.mediaKey,\r\n        \":updatedAt\": now,\r\n        \":gsi1pk\": gsi1ForStatus(\"DRAFT\"),\r\n        \":gsi1sk\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Item not found\");\r\n  }\r\n\r\n  return mapClosetItem(res.Attributes);\r\n}\r\n\r\n/**\r\n * 4) requestClosetApproval \u2013 mark DRAFT\u2192PENDING and kick off Step Functions.\r\n */\r\nasync function handleRequestClosetApproval(\r\n  args: { id: string },\r\n  identity: any,\r\n): Promise<string> {\r\n  const sub = requireUserSub(identity);\r\n  const now = nowIso();\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: marshall({\r\n        pk: pkForUser(sub),\r\n        sk: skForClosetItem(args.id),\r\n      }),\r\n      ConditionExpression: \"status = :draft\",\r\n      UpdateExpression:\r\n        \"SET status = :pending, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk\",\r\n      ExpressionAttributeValues: marshall({\r\n        \":draft\": \"DRAFT\",\r\n        \":pending\": \"PENDING\",\r\n        \":updatedAt\": now,\r\n        \":gsi1pk\": gsi1ForStatus(\"PENDING\"),\r\n        \":gsi1sk\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Item not found or not in DRAFT status\");\r\n  }\r\n\r\n  const item = mapClosetItem(res.Attributes);\r\n\r\n  // Fire-and-forget Step Functions execution\r\n  await sfn.send(\r\n    new StartExecutionCommand({\r\n      stateMachineArn: APPROVAL_SM_ARN,\r\n      input: JSON.stringify({\r\n        itemId: item.id,\r\n        userId: item.userId,\r\n        ownerSub: item.ownerSub,\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return item.id;\r\n}\r\n\r\n/**\r\n * 5) updateClosetItemStory \u2013 Bestie-side metadata for fan-facing view.\r\n */\r\nasync function handleUpdateClosetItemStory(\r\n  args: {\r\n    input: {\r\n      id: string;\r\n      storyTitle?: string | null;\r\n      storySeason?: string | null;\r\n      storyVibes?: (string | null)[] | null;\r\n    };\r\n  },\r\n  identity: any,\r\n): Promise<ClosetItem> {\r\n  const sub = requireUserSub(identity);\r\n  const { id, storyTitle, storySeason, storyVibes } = args.input;\r\n\r\n  const now = nowIso();\r\n\r\n  const updateExpressions: string[] = [\"updatedAt = :updatedAt\"];\r\n  const expressionValues: Record<string, any> = {\r\n    \":updatedAt\": now,\r\n  };\r\n\r\n  if (storyTitle !== undefined) {\r\n    updateExpressions.push(\"storyTitle = :storyTitle\");\r\n    expressionValues[\":storyTitle\"] = storyTitle;\r\n  }\r\n\r\n  if (storySeason !== undefined) {\r\n    updateExpressions.push(\"storySeason = :storySeason\");\r\n    expressionValues[\":storySeason\"] = storySeason;\r\n  }\r\n\r\n  if (storyVibes !== undefined) {\r\n    updateExpressions.push(\"storyVibes = :storyVibes\");\r\n    expressionValues[\":storyVibes\"] = storyVibes?.filter(\r\n      (v): v is string => !!v,\r\n    );\r\n  }\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: marshall({\r\n        pk: pkForUser(sub),\r\n        sk: skForClosetItem(id),\r\n      }),\r\n      UpdateExpression: \"SET \" + updateExpressions.join(\", \"),\r\n      ExpressionAttributeValues: marshall(expressionValues),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Item not found\");\r\n  }\r\n\r\n  return mapClosetItem(res.Attributes);\r\n}\r\n\r\n/**\r\n * 6) likeClosetItem \u2013 public like/heart interaction.\r\n *\r\n * - Child row: pk = CLOSET#<closetItemId>, sk = LIKE#<viewerSub>\r\n * - Parent row: pk = USER#<ownerId>, sk = CLOSET#<closetItemId>\r\n */\r\nasync function handleLikeClosetItem(\r\n  args: { input: { ownerId: string; closetItemId: string } },\r\n  identity: any,\r\n): Promise<ClosetItem> {\r\n  const viewerSub = requireUserSub(identity);\r\n  const { ownerId, closetItemId } = args.input;\r\n  const now = nowIso();\r\n\r\n  // 1) Insert LIKE child row (idempotent using ConditionalCheckFailedException)\r\n  const likeItem = {\r\n    pk: pkForClosetRoot(closetItemId),\r\n    sk: `LIKE#${viewerSub}`,\r\n    entityType: \"LIKE\",\r\n    itemOwnerSub: ownerId,\r\n    likerSub: viewerSub,\r\n    createdAt: now,\r\n  };\r\n\r\n  try {\r\n    await ddb.send(\r\n      new PutItemCommand({\r\n        TableName: TABLE_NAME,\r\n        Item: marshall(likeItem),\r\n        ConditionExpression: \"attribute_not_exists(pk)\",\r\n      }),\r\n    );\r\n  } catch (err: any) {\r\n    // If the like already exists, ignore; otherwise bubble up\r\n    if (err?.name !== \"ConditionalCheckFailedException\") {\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  // 2) Increment likeCount on the closet item row\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: marshall({\r\n        pk: pkForUser(ownerId),\r\n        sk: skForClosetItem(closetItemId),\r\n      }),\r\n      UpdateExpression:\r\n        \"SET likeCount = if_not_exists(likeCount, :zero) + :one, updatedAt = :now\",\r\n      ExpressionAttributeValues: marshall({\r\n        \":zero\": 0,\r\n        \":one\": 1,\r\n        \":now\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Closet item not found\");\r\n  }\r\n\r\n  const item = mapClosetItem(res.Attributes);\r\n  item.viewerHasLiked = true;\r\n  return item;\r\n}\r\n\r\n/**\r\n * 7) commentOnClosetItem \u2013 create a new COMMENT child and bump commentCount.\r\n */\r\nasync function handleCommentOnClosetItem(\r\n  args: { input: { ownerId: string; closetItemId: string; text: string } },\r\n  identity: any,\r\n): Promise<ClosetItemComment> {\r\n  const authorSub = requireUserSub(identity);\r\n  const { ownerId, closetItemId, text } = args.input;\r\n  const now = nowIso();\r\n  const commentId = randomUUID();\r\n\r\n  const commentItem = {\r\n    pk: pkForClosetRoot(closetItemId),\r\n    sk: `COMMENT#${commentId}`,\r\n    entityType: \"COMMENT\",\r\n    closetItemId,\r\n    itemOwnerSub: ownerId,\r\n    authorSub,\r\n    text,\r\n    createdAt: now,\r\n  };\r\n\r\n  // 1) Put the comment item\r\n  await ddb.send(\r\n    new PutItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Item: marshall(commentItem),\r\n    }),\r\n  );\r\n\r\n  // 2) Increment commentCount on the closet item row\r\n  await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: marshall({\r\n        pk: pkForUser(ownerId),\r\n        sk: skForClosetItem(closetItemId),\r\n      }),\r\n      UpdateExpression:\r\n        \"SET commentCount = if_not_exists(commentCount, :zero) + :one, updatedAt = :now\",\r\n      ExpressionAttributeValues: marshall({\r\n        \":zero\": 0,\r\n        \":one\": 1,\r\n        \":now\": now,\r\n      }),\r\n    }),\r\n  );\r\n\r\n  // 3) Return GraphQL comment type\r\n  const comment: ClosetItemComment = {\r\n    id: commentId,\r\n    closetItemId,\r\n    authorSub,\r\n    text,\r\n    createdAt: now,\r\n  };\r\n\r\n  return comment;\r\n}\r\n\r\n/**\r\n * 8) pinHighlight \u2013 owner (or admin) can pin/unpin a closet item.\r\n *\r\n * GraphQL may call this either as:\r\n *   pinHighlight(input: { ownerId, closetItemId, pinned })\r\n * or as:\r\n *   pinHighlight(ownerId: ..., closetItemId: ..., pinned: ...)\r\n *\r\n * This resolver supports both shapes.\r\n */\r\nasync function handlePinHighlight(\r\n  args: {\r\n    input?: { ownerId?: string; closetItemId: string; pinned: boolean };\r\n    ownerId?: string;\r\n    closetItemId?: string;\r\n    pinned?: boolean;\r\n  },\r\n  identity: any,\r\n): Promise<ClosetItem> {\r\n  const callerSub = requireUserSub(identity);\r\n  const admin = isAdminIdentity(identity);\r\n\r\n  // Support both shapes: with or without `input`\r\n  const src = (args.input as any) || (args as any);\r\n\r\n  const closetItemId = src.closetItemId as string | undefined;\r\n  const pinned = !!src.pinned;\r\n  // If ownerId is omitted, assume caller is the owner\r\n  const ownerId = (src.ownerId as string | undefined) || callerSub;\r\n\r\n  if (!closetItemId) {\r\n    throw new Error(\"closetItemId is required\");\r\n  }\r\n\r\n  // Non-admins can only pin their own closet items\r\n  if (!admin && callerSub !== ownerId) {\r\n    throw new Error(\"Not authorized to pin this closet item.\");\r\n  }\r\n\r\n  const now = nowIso();\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: marshall({\r\n        pk: pkForUser(ownerId),\r\n        sk: skForClosetItem(closetItemId),\r\n      }),\r\n      UpdateExpression: \"SET pinned = :pinned, updatedAt = :now\",\r\n      ExpressionAttributeValues: marshall({\r\n        \":pinned\": pinned,\r\n        \":now\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Closet item not found\");\r\n  }\r\n\r\n  return mapClosetItem(res.Attributes);\r\n}\r\n\r\n/**\r\n * 9) closetItemComments \u2013 query all COMMENT# children for a closet item.\r\n */\r\nasync function handleClosetItemComments(args: {\r\n  closetItemId: string;\r\n}): Promise<ClosetItemComment[]> {\r\n  const { closetItemId } = args;\r\n\r\n  const res = await ddb.send(\r\n    new QueryCommand({\r\n      TableName: TABLE_NAME,\r\n      KeyConditionExpression: \"pk = :pk AND begins_with(sk, :sk)\",\r\n      ExpressionAttributeValues: marshall({\r\n        \":pk\": pkForClosetRoot(closetItemId),\r\n        \":sk\": \"COMMENT#\",\r\n      }),\r\n    }),\r\n  );\r\n\r\n  const items = (res.Items ?? []).map((raw) => unmarshall(raw) as any);\r\n\r\n  return items.map((item) => ({\r\n    id: item.sk.replace(\"COMMENT#\", \"\"),\r\n    closetItemId: item.closetItemId,\r\n    authorSub: item.authorSub,\r\n    text: item.text,\r\n    createdAt: item.createdAt,\r\n  }));\r\n}\r\n\r\n/**\r\n * 10) adminClosetItemLikes \u2013 admin view of all LIKE children under pk=CLOSET#id\r\n */\r\nasync function handleAdminClosetItemLikes(args: {\r\n  closetItemId: string;\r\n}): Promise<ClosetItemLike[]> {\r\n  const { closetItemId } = args;\r\n\r\n  const res = await ddb.send(\r\n    new QueryCommand({\r\n      TableName: TABLE_NAME,\r\n      KeyConditionExpression: \"pk = :pk AND begins_with(sk, :sk)\",\r\n      ExpressionAttributeValues: marshall({\r\n        \":pk\": pkForClosetRoot(closetItemId),\r\n        \":sk\": \"LIKE#\",\r\n      }),\r\n    }),\r\n  );\r\n\r\n  const items = (res.Items ?? []).map((raw) => unmarshall(raw) as any);\r\n\r\n  return items.map((item) => ({\r\n    closetItemId,\r\n    likerSub: item.likerSub,\r\n    createdAt: item.createdAt,\r\n  }));\r\n}\r\n\r\n/**\r\n * 11) adminClosetItemComments \u2013 alias for closetItemComments but admin-guarded.\r\n */\r\nasync function handleAdminClosetItemComments(args: {\r\n  closetItemId: string;\r\n}): Promise<ClosetItemComment[]> {\r\n  return handleClosetItemComments(args);\r\n}\r\n\r\n/**\r\n * 12) toggleWishlistItem \u2013 viewer's wishlist for a closet item.\r\n *\r\n * - Wishlist row: pk = USER#<viewerSub>, sk = WISHLIST#<closetItemId>\r\n * - Parent row: pk = USER#<ownerId>,  sk = CLOSET#<closetItemId>\r\n */\r\nasync function handleToggleWishlistItem(\r\n  args: { input: { ownerId: string; closetItemId: string; on?: boolean | null } },\r\n  identity: any,\r\n): Promise<ClosetItem> {\r\n  const viewerSub = requireUserSub(identity);\r\n  const { ownerId, closetItemId, on } = args.input;\r\n  const now = nowIso();\r\n\r\n  const wishlistPk = pkForUser(viewerSub);\r\n  const wishlistSk = `WISHLIST#${closetItemId}`;\r\n\r\n  // If on === false -> remove from wishlist (if exists) and decrement count.\r\n  if (on === false) {\r\n    // Delete wishlist entry (best-effort)\r\n    await ddb.send(\r\n      new DeleteItemCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: marshall({\r\n          pk: wishlistPk,\r\n          sk: wishlistSk,\r\n        }),\r\n      }),\r\n    );\r\n\r\n    // Decrement wishlistCount if >= 1\r\n    let updated: ClosetItem | undefined;\r\n\r\n    try {\r\n      const res = await ddb.send(\r\n        new UpdateItemCommand({\r\n          TableName: TABLE_NAME,\r\n          Key: marshall({\r\n            pk: pkForUser(ownerId),\r\n            sk: skForClosetItem(closetItemId),\r\n          }),\r\n          UpdateExpression:\r\n            \"SET wishlistCount = if_not_exists(wishlistCount, :zero) - :one, updatedAt = :now\",\r\n          ConditionExpression: \"wishlistCount >= :one\",\r\n          ExpressionAttributeValues: marshall({\r\n            \":zero\": 0,\r\n            \":one\": 1,\r\n            \":now\": now,\r\n          }),\r\n          ReturnValues: \"ALL_NEW\",\r\n        }),\r\n      );\r\n      if (res.Attributes) {\r\n        updated = mapClosetItem(res.Attributes);\r\n      }\r\n    } catch (err: any) {\r\n      if (err?.name !== \"ConditionalCheckFailedException\") {\r\n        throw err;\r\n      }\r\n      // If we hit the condition, we just fetch the item without changing count\r\n      const fallbackRes = await ddb.send(\r\n        new QueryCommand({\r\n          TableName: TABLE_NAME,\r\n          KeyConditionExpression: \"pk = :pk AND sk = :sk\",\r\n          ExpressionAttributeValues: marshall({\r\n            \":pk\": pkForUser(ownerId),\r\n            \":sk\": skForClosetItem(closetItemId),\r\n          }),\r\n        }),\r\n      );\r\n      const itemRaw = (fallbackRes.Items ?? [])[0];\r\n      if (itemRaw) {\r\n        updated = mapClosetItem(itemRaw);\r\n      }\r\n    }\r\n\r\n    if (!updated) {\r\n      throw new Error(\"Closet item not found\");\r\n    }\r\n\r\n    updated.viewerHasWishlisted = false;\r\n    return updated;\r\n  }\r\n\r\n  // Default branch: add to wishlist (on === true or on === null)\r\n  const wishlistItem = {\r\n    pk: wishlistPk,\r\n    sk: wishlistSk,\r\n    entityType: \"WISHLIST\",\r\n    closetItemId,\r\n    ownerSub: ownerId,\r\n    ownerSub,\r\n    ownerId,\r\n    viewerSub,\r\n    createdAt: now,\r\n  };\r\n\r\n  try {\r\n    await ddb.send(\r\n      new PutItemCommand({\r\n        TableName: TABLE_NAME,\r\n        Item: marshall(wishlistItem),\r\n        ConditionExpression: \"attribute_not_exists(pk)\",\r\n      }),\r\n    );\r\n  } catch (err: any) {\r\n    if (err?.name !== \"ConditionalCheckFailedException\") {\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: marshall({\r\n        pk: pkForUser(ownerId),\r\n        sk: skForClosetItem(closetItemId),\r\n      }),\r\n      UpdateExpression:\r\n        \"SET wishlistCount = if_not_exists(wishlistCount, :zero) + :one, updatedAt = :now\",\r\n      ExpressionAttributeValues: marshall({\r\n        \":zero\": 0,\r\n        \":one\": 1,\r\n        \":now\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Closet item not found\");\r\n  }\r\n\r\n  const item = mapClosetItem(res.Attributes);\r\n  item.viewerHasWishlisted = true;\r\n  return item;\r\n}\r\n\r\n/**\r\n * 13) myWishlist \u2013 viewer's wishlist expanded to ClosetItem objects.\r\n */\r\nasync function handleMyWishlist(identity: any): Promise<ClosetItem[]> {\r\n  const viewerSub = requireUserSub(identity);\r\n\r\n  // 1) Fetch wishlist entries under USER#<viewerSub>\r\n  const res = await ddb.send(\r\n    new QueryCommand({\r\n      TableName: TABLE_NAME,\r\n      KeyConditionExpression: \"pk = :pk AND begins_with(sk, :sk)\",\r\n      ExpressionAttributeValues: marshall({\r\n        \":pk\": pkForUser(viewerSub),\r\n        \":sk\": \"WISHLIST#\",\r\n      }),\r\n    }),\r\n  );\r\n\r\n  const entries = (res.Items ?? []).map((raw) => unmarshall(raw) as any);\r\n\r\n  if (!entries.length) {\r\n    return [];\r\n  }\r\n\r\n  // 2) Batch-get the referenced closet items\r\n  const keys = entries.map((e) => ({\r\n    pk: pkForUser(e.ownerSub),\r\n    sk: skForClosetItem(e.closetItemId),\r\n  }));\r\n\r\n  const batchRes = await ddb.send(\r\n    new BatchGetItemCommand({\r\n      RequestItems: {\r\n        [TABLE_NAME]: {\r\n          Keys: keys.map((k) => marshall(k)),\r\n        },\r\n      },\r\n    }),\r\n  );\r\n\r\n  const itemsRaw = batchRes.Responses?.[TABLE_NAME] ?? [];\r\n  const closetItems = itemsRaw.map(mapClosetItem);\r\n\r\n  // 3) Mark viewerHasWishlisted = true for each\r\n  for (const ci of closetItems) {\r\n    ci.viewerHasWishlisted = true;\r\n  }\r\n\r\n  return closetItems;\r\n}\r\n\r\n/**\r\n * 14) pinnedClosetItems \u2013 field resolver for GameProfile.pinnedClosetItems.\r\n *\r\n * Called as a child resolver with `event.source` being the GameProfile object.\r\n */\r\nasync function handlePinnedClosetItems(event: any): Promise<ClosetItem[]> {\r\n  const source = event.source || {};\r\n  const identity = event.identity || {};\r\n\r\n  // Prefer explicit userId from GameProfile, fall back to identity.sub\r\n  const userId: string | undefined =\r\n    (source.userId as string | undefined) ||\r\n    (source.id as string | undefined) ||\r\n    (identity.sub as string | undefined);\r\n\r\n  if (!userId) {\r\n    throw new Error(\"Cannot resolve pinnedClosetItems: missing userId\");\r\n  }\r\n\r\n  const res = await ddb.send(\r\n    new QueryCommand({\r\n      TableName: TABLE_NAME,\r\n      KeyConditionExpression: \"pk = :pk AND begins_with(sk, :sk)\",\r\n      FilterExpression: \"#pinned = :true AND #status = :published\",\r\n      ExpressionAttributeNames: {\r\n        \"#pinned\": \"pinned\",\r\n        \"#status\": \"status\",\r\n      },\r\n      ExpressionAttributeValues: marshall({\r\n        \":pk\": pkForUser(userId),\r\n        \":sk\": \"CLOSET#\",\r\n        \":true\": true,\r\n        \":published\": \"PUBLISHED\",\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return (res.Items ?? []).map(mapClosetItem);\r\n}\r\n\r\n/**\r\n * AppSync Lambda resolver entrypoint.\r\n */\r\nexport const handler = async (event: any) => {\r\n  console.log(\"ClosetResolverFn event\", JSON.stringify(event));\r\n\r\n  const fieldName = event.info?.fieldName;\r\n\r\n  try {\r\n    switch (fieldName) {\r\n      case \"myCloset\":\r\n        return await handleMyCloset(event.identity);\r\n\r\n      case \"myWishlist\":\r\n        return await handleMyWishlist(event.identity);\r\n\r\n      case \"createClosetItem\":\r\n        return await handleCreateClosetItem(event.arguments, event.identity);\r\n\r\n      case \"updateClosetMediaKey\":\r\n        return await handleUpdateClosetMediaKey(\r\n          event.arguments,\r\n          event.identity,\r\n        );\r\n\r\n      case \"requestClosetApproval\":\r\n        return await handleRequestClosetApproval(\r\n          event.arguments,\r\n          event.identity,\r\n        );\r\n\r\n      case \"updateClosetItemStory\":\r\n        return await handleUpdateClosetItemStory(\r\n          event.arguments,\r\n          event.identity,\r\n        );\r\n\r\n      case \"likeClosetItem\":\r\n        return await handleLikeClosetItem(event.arguments, event.identity);\r\n\r\n      case \"commentOnClosetItem\":\r\n        return await handleCommentOnClosetItem(\r\n          event.arguments,\r\n          event.identity,\r\n        );\r\n\r\n      case \"pinHighlight\":\r\n        return await handlePinHighlight(event.arguments, event.identity);\r\n\r\n      case \"closetItemComments\":\r\n        return await handleClosetItemComments(event.arguments);\r\n\r\n      case \"adminClosetItemLikes\":\r\n        return await handleAdminClosetItemLikes(event.arguments);\r\n\r\n      case \"adminClosetItemComments\":\r\n        return await handleAdminClosetItemComments(event.arguments);\r\n\r\n      case \"toggleWishlistItem\":\r\n        return await handleToggleWishlistItem(\r\n          event.arguments,\r\n          event.identity,\r\n        );\r\n\r\n      // child resolver on GameProfile\r\n      case \"pinnedClosetItems\":\r\n        return await handlePinnedClosetItems(event);\r\n\r\n      default:\r\n        throw new Error(`Unsupported field: ${fieldName}`);\r\n    }\r\n  } catch (err: any) {\r\n    console.error(\"Error in ClosetResolverFn\", err);\r\n    throw err;\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["index_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_client_sfn", "import_util_dynamodb", "import_crypto", "TABLE_NAME", "APPROVAL_SM_ARN", "STATUS_GSI", "ddb", "sfn", "nowIso", "pkForUser", "userId", "skForClosetItem", "id", "pkForClosetRoot", "closetItemId", "gsi1ForStatus", "status", "mapClosetItem", "raw", "item", "requireUserSub", "identity", "isAdminIdentity", "groups", "g", "handleMyCloset", "sub", "handleCreateClosetItem", "args", "now", "handleUpdateClosetMediaKey", "res", "handleRequestClosetApproval", "handleUpdateClosetItemStory", "storyTitle", "storySeason", "storyVibes", "updateExpressions", "expressionValues", "v", "handleLikeClosetItem", "viewerSub", "ownerId", "likeItem", "err", "handleCommentOnClosetItem", "authorSub", "text", "commentId", "commentItem", "handlePinHighlight", "callerSub", "admin", "src", "pinned", "handleClosetItemComments", "handleAdminClosetItemLikes", "handleAdminClosetItemComments", "handleToggleWishlistItem", "on", "wishlistPk", "wishlistSk", "updated", "itemRaw", "wishlistItem", "handleMyWishlist", "entries", "keys", "e", "closetItems", "k", "ci", "handlePinnedClosetItems", "event", "source", "fieldName"]
}
