{
  "version": 3,
  "sources": ["../../lambda/game/polls.ts"],
  "sourcesContent": ["import { DynamoDBClient, PutItemCommand, QueryCommand, UpdateItemCommand } from \"@aws-sdk/client-dynamodb\";\r\nimport { AppSyncIdentityCognito } from \"aws-lambda\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\nconst TABLE = process.env.TABLE_NAME!;\r\n\r\nexport const handler = async (event: any) => {\r\n  const id = event.identity as AppSyncIdentityCognito;\r\n  const fn = event.info.fieldName;\r\n\r\n  if (fn === 'createPoll') {\r\n    const { question, options } = event.arguments.input as { question: string, options: string[] };\r\n    if (!id) throw new Error('Unauthorized');\r\n    const pollId = `${Date.now()}`;\r\n    await ddb.send(new PutItemCommand({\r\n      TableName: TABLE,\r\n      Item: {\r\n        pk: { S: `POLL#${pollId}` }, sk: { S: 'META' },\r\n        gsi2pk: { S: `POLL#${pollId}` }, gsi2sk: { S: 'META' },\r\n        question: { S: question },\r\n        options: { S: JSON.stringify(options) },\r\n        totals: { S: JSON.stringify(Array(options.length).fill(0)) },\r\n        createdBy: { S: id.username || id.sub },\r\n        createdAt: { S: new Date().toISOString() },\r\n      }\r\n    }));\r\n    return { pollId, question, options, totals: Array(options.length).fill(0), createdBy: id.username || id.sub, createdAt: new Date().toISOString() };\r\n  }\r\n\r\n  if (fn === 'votePoll') {\r\n    const { pollId, optionIndex } = event.arguments as { pollId: string, optionIndex: number };\r\n    const userKey = id?.sub!;\r\n    // record the vote as an item; use conditional write to make votes idempotent per user\r\n    await ddb.send(new PutItemCommand({\r\n      TableName: TABLE,\r\n      Item: {\r\n        pk: { S: `POLL#${pollId}` }, sk: { S: `VOTE#${optionIndex}#${userKey}` },\r\n        gsi2pk: { S: `POLL#${pollId}` }, gsi2sk: { S: `VOTE#${optionIndex}#${userKey}` },\r\n        userId: { S: userKey }\r\n      },\r\n      ConditionExpression: 'attribute_not_exists(pk)'\r\n    })).catch(async err => {\r\n      if (!`${err}`.includes('ConditionalCheckFailed')) throw err;\r\n    });\r\n\r\n    // recompute totals cheaply by counting votes per option via GSI2\r\n    // (for big polls, maintain counters via UpdateItem + ADD)\r\n    const meta = await ddb.send(new QueryCommand({\r\n      TableName: TABLE,\r\n      KeyConditionExpression: 'pk = :p AND sk = :s',\r\n      ExpressionAttributeValues: { ':p': { S: `POLL#${pollId}` }, ':s': { S: 'META' } }\r\n    }));\r\n    const opts = JSON.parse(meta.Items?.[0]?.options?.S ?? '[]') as string[];\r\n\r\n    const totals: number[] = [];\r\n    for (let i = 0; i < opts.length; i++) {\r\n      const q = await ddb.send(new QueryCommand({\r\n        TableName: TABLE,\r\n        IndexName: 'GSI2',\r\n        KeyConditionExpression: 'gsi2pk = :p AND begins_with(gsi2sk, :pref)',\r\n        ExpressionAttributeValues: { ':p': { S: `POLL#${pollId}` }, ':pref': { S: `VOTE#${i}#` } }\r\n      }));\r\n      totals.push(q.Count ?? 0);\r\n    }\r\n\r\n    await ddb.send(new UpdateItemCommand({\r\n      TableName: TABLE,\r\n      Key: { pk: { S: `POLL#${pollId}` }, sk: { S: 'META' } },\r\n      UpdateExpression: 'SET totals = :t',\r\n      ExpressionAttributeValues: { ':t': { S: JSON.stringify(totals) } }\r\n    }));\r\n\r\n    return { pollId, question: meta.Items?.[0]?.question?.S, options: opts, totals, createdBy: meta.Items?.[0]?.createdBy?.S, createdAt: meta.Items?.[0]?.createdAt?.S };\r\n  }\r\n\r\n  if (fn === 'getPoll') {\r\n    const { pollId } = event.arguments as { pollId: string };\r\n    const meta = await ddb.send(new QueryCommand({\r\n      TableName: TABLE,\r\n      KeyConditionExpression: 'pk = :p AND sk = :s',\r\n      ExpressionAttributeValues: { ':p': { S: `POLL#${pollId}` }, ':s': { S: 'META' } }\r\n    }));\r\n    const i = meta.Items?.[0];\r\n    return i ? {\r\n      pollId,\r\n      question: i.question.S,\r\n      options: JSON.parse(i.options.S),\r\n      totals: JSON.parse(i.totals.S),\r\n      createdBy: i.createdBy.S,\r\n      createdAt: i.createdAt.S\r\n    } : null;\r\n  }\r\n\r\n  throw new Error('Unknown field');\r\n};\r\n"],
  "mappings": "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",
  "names": ["polls_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "ddb", "TABLE", "event", "id", "fn", "question", "options", "pollId", "optionIndex", "userKey", "err", "meta", "opts", "totals", "i", "q"]
}
