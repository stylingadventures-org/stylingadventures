"use strict";var u=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var w=(o,t)=>{for(var a in t)u(o,a,{get:t[a],enumerable:!0})},E=(o,t,a,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of y(t))!A.call(o,s)&&s!==a&&u(o,s,{get:()=>t[s],enumerable:!(e=g(t,s))||e.enumerable});return o};var I=o=>E(u({},"__esModule",{value:!0}),o);var k={};w(k,{handler:()=>f});module.exports=I(k);var i=require("@aws-sdk/client-dynamodb"),p=new i.DynamoDBClient({}),d=process.env.TABLE_NAME,f=async o=>{let t=o.identity,a=o.info.fieldName;if(a==="createPoll"){let{question:e,options:s}=o.arguments.input;if(!t)throw new Error("Unauthorized");let n=`${Date.now()}`;return await p.send(new i.PutItemCommand({TableName:d,Item:{pk:{S:`POLL#${n}`},sk:{S:"META"},gsi2pk:{S:`POLL#${n}`},gsi2sk:{S:"META"},question:{S:e},options:{S:JSON.stringify(s)},totals:{S:JSON.stringify(Array(s.length).fill(0))},createdBy:{S:t.username||t.sub},createdAt:{S:new Date().toISOString()}}})),{pollId:n,question:e,options:s,totals:Array(s.length).fill(0),createdBy:t.username||t.sub,createdAt:new Date().toISOString()}}if(a==="votePoll"){let{pollId:e,optionIndex:s}=o.arguments,n=t?.sub;await p.send(new i.PutItemCommand({TableName:d,Item:{pk:{S:`POLL#${e}`},sk:{S:`VOTE#${s}#${n}`},gsi2pk:{S:`POLL#${e}`},gsi2sk:{S:`VOTE#${s}#${n}`},userId:{S:n}},ConditionExpression:"attribute_not_exists(pk)"})).catch(async r=>{if(!`${r}`.includes("ConditionalCheckFailed"))throw r});let l=await p.send(new i.QueryCommand({TableName:d,KeyConditionExpression:"pk = :p AND sk = :s",ExpressionAttributeValues:{":p":{S:`POLL#${e}`},":s":{S:"META"}}})),c=JSON.parse(l.Items?.[0]?.options?.S??"[]"),S=[];for(let r=0;r<c.length;r++){let m=await p.send(new i.QueryCommand({TableName:d,IndexName:"GSI2",KeyConditionExpression:"gsi2pk = :p AND begins_with(gsi2sk, :pref)",ExpressionAttributeValues:{":p":{S:`POLL#${e}`},":pref":{S:`VOTE#${r}#`}}}));S.push(m.Count??0)}return await p.send(new i.UpdateItemCommand({TableName:d,Key:{pk:{S:`POLL#${e}`},sk:{S:"META"}},UpdateExpression:"SET totals = :t",ExpressionAttributeValues:{":t":{S:JSON.stringify(S)}}})),{pollId:e,question:l.Items?.[0]?.question?.S,options:c,totals:S,createdBy:l.Items?.[0]?.createdBy?.S,createdAt:l.Items?.[0]?.createdAt?.S}}if(a==="getPoll"){let{pollId:e}=o.arguments,n=(await p.send(new i.QueryCommand({TableName:d,KeyConditionExpression:"pk = :p AND sk = :s",ExpressionAttributeValues:{":p":{S:`POLL#${e}`},":s":{S:"META"}}}))).Items?.[0];return n?{pollId:e,question:n.question.S,options:JSON.parse(n.options.S),totals:JSON.parse(n.totals.S),createdBy:n.createdBy.S,createdAt:n.createdAt.S}:null}throw new Error("Unknown field")};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
