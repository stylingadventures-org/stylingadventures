"use strict";var S=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var G=Object.prototype.hasOwnProperty;var H=(e,s)=>{for(var r in s)S(e,r,{get:s[r],enumerable:!0})},W=(e,s,r,n)=>{if(s&&typeof s=="object"||typeof s=="function")for(let a of $(s))!G.call(e,a)&&a!==r&&S(e,a,{get:()=>s[a],enumerable:!(n=B(s,a))||n.enumerable});return e};var j=e=>W(S({},"__esModule",{value:!0}),e);var ee={};H(ee,{adminApproveItem:()=>O,adminCreateClosetItem:()=>M,adminListBestieClosetItems:()=>h,adminListClosetItems:()=>T,adminListPending:()=>L,adminPublishClosetItem:()=>D,adminRejectItem:()=>K,adminSetClosetAudience:()=>R,adminUpdateClosetItem:()=>U,closetFeed:()=>N,handler:()=>Z,toggleFavoriteClosetItem:()=>V,topClosetLooks:()=>P});module.exports=j(ee);var d=require("@aws-sdk/client-dynamodb"),I=require("@aws-sdk/client-sfn"),g=new d.DynamoDBClient({}),x=new I.SFNClient({}),{TABLE_NAME:p="",ADMIN_GROUP_NAME:q="admin",CREATOR_GROUP_NAME:J="creator"}=process.env;if(!p)throw new Error("Missing env: TABLE_NAME");var z=q.toLowerCase(),Q=J.toLowerCase(),w=()=>new Date().toISOString(),t=e=>({S:e});function X(e){let s=e?.claims||{},r=s["cognito:groups"]||s["custom:groups"]||e?.groups||[];return Array.isArray(r)?r.map(n=>String(n)):typeof r=="string"?r.split(",").map(n=>n.trim()).filter(Boolean):[]}function f(e){let s=e.identity,r=s?.claims||{},n=s?.sub||r.sub;if(!n)throw new Error("Unauthorized");let a=X(s),u=a.map(i=>i.toLowerCase()),o=u.includes(z),l=u.includes(Q);return{sub:n,isAdmin:o,isCreator:l,groups:a}}function y(e,s){let r=e.id?.S??"",n=e.ownerSub?.S??"",a=e.status?.S??"PENDING",u=e.createdAt?.S||w(),o=e.updatedAt?.S||u,l=e.favoriteCount?.N,i=typeof l=="string"?Number(l):0,m=e.pinned,c=typeof m?.BOOL=="boolean"?m.BOOL:void 0;return{id:r,userId:n,ownerSub:n,status:a,createdAt:u,updatedAt:o,mediaKey:e.mediaKey?.S??"",rawMediaKey:e.rawMediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??"",season:e.season?.S??null,vibes:e.vibes?.S??null,audience:e.audience?.S??null,category:e.category?.S??null,subcategory:e.subcategory?.S??null,pinned:c,favoriteCount:i,viewerHasFaved:!1,...s}}function Y(){return globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`}function C(e){return e?Buffer.from(JSON.stringify(e),"utf8").toString("base64"):null}function v(e){if(e)try{return JSON.parse(Buffer.from(String(e),"base64").toString("utf8"))}catch{return}}var L=async e=>{let{isAdmin:s}=f(e);if(!s)throw new Error("Forbidden");let{limit:r=100,nextToken:n}=e.arguments||{},a=v(n),u=await g.send(new d.QueryCommand({TableName:p,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned",ExpressionAttributeNames:{"#s":"status"},Limit:r,ExclusiveStartKey:a}));return{items:(u.Items||[]).map(l=>y({...l,status:l.status})),nextToken:C(u.LastEvaluatedKey)}},T=async e=>{let{isAdmin:s}=f(e);if(!s)throw new Error("Forbidden");let{status:r,limit:n=50,nextToken:a}=e.arguments||{},u=v(a);if(r){let i=await g.send(new d.QueryCommand({TableName:p,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t(`STATUS#${r}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned",ExpressionAttributeNames:{"#s":"status"},Limit:n,ExclusiveStartKey:u}));return{items:(i.Items||[]).map(c=>y({...c,status:c.status})),nextToken:C(i.LastEvaluatedKey)}}let o=await g.send(new d.ScanCommand({TableName:p,FilterExpression:"begins_with(pk, :p)",ExpressionAttributeValues:{":p":t("ITEM#")},ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned",ExpressionAttributeNames:{"#s":"status"},Limit:n,ExclusiveStartKey:u})),l=(o.Items||[]).map(i=>y({...i,status:i.status}));return l.sort((i,m)=>new Date(m.createdAt||0).getTime()-new Date(i.createdAt||0).getTime()),{items:l,nextToken:C(o.LastEvaluatedKey)}},h=async e=>{let s=await T(e),r=new Set(["BESTIE","EXCLUSIVE"]),n=s.items.filter(a=>{let u=(a.audience||"").toUpperCase();return r.has(u)});return{...s,items:n}},N=async e=>{let{sub:s}=f(e),n=(e.arguments?.sort??"NEWEST")==="MOST_LOVED"?"MOST_LOVED":"NEWEST",a=await g.send(new d.QueryCommand({TableName:p,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:{":pk":t(`FAV#${s}`),":sk":t("CLOSET#")}})),u=new Set((a.Items||[]).map(i=>{let m=i.sk?.S??"";return m.startsWith("CLOSET#")?m.substring(7):i.closetId?.S??""})),o=await g.send(new d.ScanCommand({TableName:p,FilterExpression:"begins_with(pk, :p)",ExpressionAttributeValues:{":p":t("ITEM#")},ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, audience, favoriteCount, category, subcategory, season, vibes, pinned",ExpressionAttributeNames:{"#s":"status"}})),l=[];for(let i of o.Items||[]){let m=i.status?.S;if(m!=="APPROVED"&&m!=="PUBLISHED")continue;let c=i.createdAt?.S||"";if(!c.trim())continue;let E=y({...i,status:i.status,createdAt:{S:c},updatedAt:i.updatedAt??{S:c}},{viewerHasFaved:u.has(i.id?.S??"")});l.push(E)}return l.sort((i,m)=>{let c=new Date(i.createdAt||0).getTime(),E=new Date(m.createdAt||0).getTime();if(n==="MOST_LOVED"){let A=i.favoriteCount??0,b=m.favoriteCount??0;return b!==A?b-A:E-c}return E-c}),{items:l,nextToken:null}},P=async e=>(await N({...e,arguments:{...e.arguments||{},sort:"NEWEST"}})).items,M=async e=>{let{sub:s,isAdmin:r}=f(e);if(!r)throw new Error("Forbidden");let n=e.arguments?.input||{};if(!n.title?.trim())throw new Error("title is required");let a=n.rawMediaKey||n.mediaKey;if(!a)throw new Error("rawMediaKey is required");let u=Y(),o=w();return await g.send(new d.PutItemCommand({TableName:p,Item:{pk:t(`ITEM#${u}`),sk:t("META"),id:t(u),ownerSub:t(s),gsi2pk:t("STATUS#PENDING"),gsi2sk:t(o),status:t("PENDING"),createdAt:t(o),updatedAt:t(o),title:t(n.title.trim()),rawMediaKey:t(a),favoriteCount:{N:"0"},...n.season?{season:t(n.season)}:{},...n.vibes?{vibes:t(n.vibes)}:{},...n.category?{category:t(n.category)}:{},...n.subcategory?{subcategory:t(n.subcategory)}:{},...n.audience?{audience:t(n.audience)}:{},...n.description?{description:t(n.description)}:{},...n.story?{story:t(n.story)}:{}}})),{id:u,userId:s,ownerSub:s,status:"PENDING",createdAt:o,updatedAt:o,title:n.title.trim(),mediaKey:"",rawMediaKey:a,reason:"",season:n.season??null,vibes:n.vibes??null,audience:n.audience??null,category:n.category??null,subcategory:n.subcategory??null,favoriteCount:0,viewerHasFaved:!1}},O=async e=>{let{isAdmin:s}=f(e);if(!s)throw new Error("Forbidden");let r=e.arguments?.closetItemId;if(!r)throw new Error("closetItemId required");let n=w(),u=(await g.send(new d.UpdateItemCommand({TableName:p,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("APPROVED"),":u":t(n),":g2pk":t("STATUS#APPROVED"),":g2sk":t(n)},ReturnValues:"ALL_OLD"}))).Attributes,o=u.approvalToken?.S;if(o)try{await x.send(new I.SendTaskSuccessCommand({taskToken:o,output:JSON.stringify({approved:!0})}))}catch{}return y({...u,status:t("APPROVED")})},K=async e=>{let{isAdmin:s}=f(e);if(!s)throw new Error("Forbidden");let r=e.arguments?.closetItemId,n=e.arguments?.reason||"";if(!r)throw new Error("closetItemId required");let a=w(),o=(await g.send(new d.UpdateItemCommand({TableName:p,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("REJECTED"),":u":t(a),":g2pk":t("STATUS#REJECTED"),":g2sk":t(a),":r":t(n)},ReturnValues:"ALL_OLD"}))).Attributes,l=o.approvalToken?.S;if(l)try{await x.send(new I.SendTaskFailureCommand({taskToken:l,error:"Rejected",cause:n||"Rejected by admin"}))}catch{}return y({...o,status:t("REJECTED"),reason:t(n)})},D=async e=>{let{isAdmin:s}=f(e);if(!s)throw new Error("Forbidden");let r=e.arguments?.closetItemId;if(!r)throw new Error("closetItemId required");let n=w(),a=await g.send(new d.UpdateItemCommand({TableName:p,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("PUBLISHED"),":u":t(n),":g2pk":t("STATUS#PUBLISHED"),":g2sk":t(n)},ReturnValues:"ALL_NEW"}));if(!a.Attributes)throw new Error("Closet item not found");return y(a.Attributes)},U=async e=>{let{isAdmin:s}=f(e);if(!s)throw new Error("Forbidden");let r=e.arguments||{},n=r.input||{},a=r.closetItemId??n.id??r.id;if(!a)throw new Error("closetItemId or input.id required");if(!(await g.send(new d.GetItemCommand({TableName:p,Key:{pk:t(`ITEM#${a}`),sk:t("META")}}))).Item)throw new Error("Closet item not found");let o={...n};["title","category","subcategory","audience","pinned","season","vibes"].forEach(A=>{r[A]!==void 0&&o[A]===void 0&&(o[A]=r[A])});let l=w(),i=["#updatedAt = :u"],m={"#updatedAt":"updatedAt"},c={":u":t(l)};if(o.title!==void 0&&(i.push("#title = :title"),m["#title"]="title",c[":title"]=o.title===null?{NULL:!0}:t(o.title)),o.category!==void 0&&(i.push("#category = :category"),m["#category"]="category",c[":category"]=o.category===null?{NULL:!0}:t(o.category)),o.subcategory!==void 0&&(i.push("#subcategory = :subcategory"),m["#subcategory"]="subcategory",c[":subcategory"]=o.subcategory===null?{NULL:!0}:t(o.subcategory)),o.audience!==void 0&&(i.push("audience = :audience"),c[":audience"]=o.audience===null?{NULL:!0}:t(o.audience)),o.season!==void 0&&(i.push("season = :season"),c[":season"]=o.season===null?{NULL:!0}:t(o.season)),o.vibes!==void 0&&(i.push("vibes = :vibes"),c[":vibes"]=o.vibes===null?{NULL:!0}:t(o.vibes)),o.pinned!==void 0&&(i.push("pinned = :pinned"),c[":pinned"]=o.pinned===null?{NULL:!0}:{BOOL:!!o.pinned}),i.length===1)throw new Error("No fields provided to update");let E=await g.send(new d.UpdateItemCommand({TableName:p,Key:{pk:t(`ITEM#${a}`),sk:t("META")},UpdateExpression:`SET ${i.join(", ")}`,ExpressionAttributeNames:m,ExpressionAttributeValues:c,ReturnValues:"ALL_NEW"}));if(!E.Attributes)throw new Error("Closet item not found");return y(E.Attributes)},R=async e=>{let{isAdmin:s}=f(e);if(!s)throw new Error("Forbidden");let r=e.arguments?.closetItemId,n=e.arguments?.audience;if(!r)throw new Error("closetItemId required");if(!n)throw new Error("audience required");let a=w(),u=await g.send(new d.UpdateItemCommand({TableName:p,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET audience = :aud, updatedAt = :u",ExpressionAttributeValues:{":aud":t(n),":u":t(a)},ReturnValues:"ALL_NEW"}));if(!u.Attributes)throw new Error("Closet item not found");return y(u.Attributes)},V=async e=>{let{sub:s}=f(e),r=e.arguments?.id,n=e.arguments?.favoriteOn,a=e.arguments?.on,u=typeof n=="boolean"?n:a;if(!r)throw new Error("id required");let l=(await g.send(new d.GetItemCommand({TableName:p,Key:{pk:t(`ITEM#${r}`),sk:t("META")}}))).Item;if(!l)throw new Error("Closet item not found");let i={pk:t(`FAV#${s}`),sk:t(`CLOSET#${r}`)},c=!!(await g.send(new d.GetItemCommand({TableName:p,Key:i}))).Item,E=typeof u=="boolean"?u:!c,A=w(),b=0;E&&!c?(b=1,await g.send(new d.PutItemCommand({TableName:p,Item:{...i,userSub:t(s),closetId:t(r),createdAt:t(A)}}))):!E&&c&&(b=-1,await g.send(new d.DeleteItemCommand({TableName:p,Key:i}))),b!==0&&await g.send(new d.UpdateItemCommand({TableName:p,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) + :delta, updatedAt = :u",ExpressionAttributeValues:{":zero":{N:"0"},":delta":{N:String(b)},":u":t(A)}}));let k=l.favoriteCount?.N,_=typeof k=="string"?Number(k):0,F=Math.max(0,_+b);return y(l,{favoriteCount:F,viewerHasFaved:E})},Z=async e=>{let s=e.info.fieldName;if(s==="adminListPending")return L(e);if(s==="adminListClosetItems")return T(e);if(s==="adminListBestieClosetItems")return h(e);if(s==="adminCreateClosetItem")return M(e);if(s==="adminApproveItem")return O(e);if(s==="adminRejectItem")return K(e);if(s==="adminPublishClosetItem")return D(e);if(s==="adminSetClosetAudience")return R(e);if(s==="adminUpdateClosetItem")return U(e);if(s==="closetFeed")return N(e);if(s==="topClosetLooks")return P(e);if(s==="toggleFavoriteClosetItem"||s==="likeClosetItem")return V(e);throw new Error(`No resolver implemented for field ${s}`)};0&&(module.exports={adminApproveItem,adminCreateClosetItem,adminListBestieClosetItems,adminListClosetItems,adminListPending,adminPublishClosetItem,adminRejectItem,adminSetClosetAudience,adminUpdateClosetItem,closetFeed,handler,toggleFavoriteClosetItem,topClosetLooks});
//# sourceMappingURL=index.js.map
