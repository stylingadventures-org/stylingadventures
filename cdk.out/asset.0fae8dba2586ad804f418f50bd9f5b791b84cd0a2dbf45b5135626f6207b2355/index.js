"use strict";var S=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var h=(t,e)=>{for(var s in e)S(t,s,{get:e[s],enumerable:!0})},R=(t,e,s,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of K(e))!N.call(t,n)&&n!==s&&S(t,n,{get:()=>e[n],enumerable:!(r=k(e,n))||r.enumerable});return t};var V=t=>R(S({},"__esModule",{value:!0}),t);var O={};h(O,{handler:()=>F});module.exports=V(O);var a=require("@aws-sdk/client-dynamodb"),c=require("@aws-sdk/client-sfn"),o=require("@aws-sdk/util-dynamodb"),b=require("crypto"),u=process.env.TABLE_NAME,U=process.env.APPROVAL_SM_ARN,G=process.env.STATUS_GSI??"gsi1",d=new a.DynamoDBClient({}),P=new c.SFNClient({});function g(){return new Date().toISOString()}function l(t){return`USER#${t}`}function A(t){return`CLOSET#${t}`}function E(t){return`CLOSET#STATUS#${t}`}function w(t){let e=(0,o.unmarshall)(t);return{id:e.id,userId:e.userId,ownerSub:e.ownerSub,status:e.status,createdAt:e.createdAt,updatedAt:e.updatedAt,mediaKey:e.mediaKey,rawMediaKey:e.rawMediaKey,title:e.title,reason:e.reason,audience:e.audience,storyTitle:e.storyTitle,storySeason:e.storySeason,storyVibes:e.storyVibes}}function y(t){if(!t?.sub)throw new Error("Not authenticated");return t.sub}async function D(t){let e=y(t);return((await d.send(new a.QueryCommand({TableName:u,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":l(e),":sk":"CLOSET#"})}))).Items??[]).map(w)}async function L(t,e){let s=y(e),r=(0,b.randomUUID)(),n=g(),i={id:r,userId:s,ownerSub:s,status:"DRAFT",createdAt:n,updatedAt:n,mediaKey:t.mediaKey,rawMediaKey:t.rawMediaKey,title:t.title};return await d.send(new a.PutItemCommand({TableName:u,Item:(0,o.marshall)({pk:l(s),sk:A(r),gsi1pk:E(i.status),gsi1sk:n,rawMediaKey:i.rawMediaKey,...i})})),i}async function M(t,e){let s=y(e),r=g(),n=await d.send(new a.UpdateItemCommand({TableName:u,Key:(0,o.marshall)({pk:l(s),sk:A(t.id)}),UpdateExpression:"SET mediaKey = :mediaKey, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,o.marshall)({":mediaKey":t.mediaKey,":updatedAt":r,":gsi1pk":E("DRAFT"),":gsi1sk":r}),ReturnValues:"ALL_NEW"}));if(!n.Attributes)throw new Error("Item not found");return w(n.Attributes)}async function x(t,e){let s=y(e),r=g(),n=await d.send(new a.UpdateItemCommand({TableName:u,Key:(0,o.marshall)({pk:l(s),sk:A(t.id)}),ConditionExpression:"status = :draft",UpdateExpression:"SET status = :pending, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,o.marshall)({":draft":"DRAFT",":pending":"PENDING",":updatedAt":r,":gsi1pk":E("PENDING"),":gsi1sk":r}),ReturnValues:"ALL_NEW"}));if(!n.Attributes)throw new Error("Item not found or not in DRAFT status");let i=w(n.Attributes);return await P.send(new c.StartExecutionCommand({stateMachineArn:U,input:JSON.stringify({itemId:i.id,userId:i.userId,ownerSub:i.ownerSub})})),i.id}async function _(t,e){let s=y(e),{id:r,storyTitle:n,storySeason:i,storyVibes:C}=t.input,I=g(),m=["updatedAt = :updatedAt"],p={":updatedAt":I};n!==void 0&&(m.push("storyTitle = :storyTitle"),p[":storyTitle"]=n),i!==void 0&&(m.push("storySeason = :storySeason"),p[":storySeason"]=i),C!==void 0&&(m.push("storyVibes = :storyVibes"),p[":storyVibes"]=C?.filter(T=>!!T));let f=await d.send(new a.UpdateItemCommand({TableName:u,Key:(0,o.marshall)({pk:l(s),sk:A(r)}),UpdateExpression:"SET "+m.join(", "),ExpressionAttributeValues:(0,o.marshall)(p),ReturnValues:"ALL_NEW"}));if(!f.Attributes)throw new Error("Item not found");return w(f.Attributes)}var F=async t=>{console.log("ClosetResolverFn event",JSON.stringify(t));let e=t.info?.fieldName;try{switch(e){case"myCloset":return await D(t.identity);case"createClosetItem":return await L(t.arguments,t.identity);case"updateClosetMediaKey":return await M(t.arguments,t.identity);case"requestClosetApproval":return await x(t.arguments,t.identity);case"updateClosetItemStory":return await _(t.arguments,t.identity);default:throw new Error(`Unsupported field: ${e}`)}}catch(s){throw console.error("Error in ClosetResolverFn",s),s}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
