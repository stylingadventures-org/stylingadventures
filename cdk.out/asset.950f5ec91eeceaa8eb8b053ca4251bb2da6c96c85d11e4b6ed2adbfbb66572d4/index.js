"use strict";var w=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var h=(t,n)=>{for(var r in n)w(t,r,{get:n[r],enumerable:!0})},R=(t,n,r,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let o of C(n))!M.call(t,o)&&o!==r&&w(t,o,{get:()=>n[o],enumerable:!(e=K(n,o))||e.enumerable});return t};var D=t=>R(w({},"__esModule",{value:!0}),t);var L={};h(L,{handler:()=>V});module.exports=D(L);var i=require("@aws-sdk/client-dynamodb"),c=require("@aws-sdk/client-sfn"),g=require("crypto"),m=new i.DynamoDBClient({}),E=new c.SFNClient({}),{TABLE_NAME:p="",APPROVAL_SM_ARN:y=""}=process.env;if(!p)throw new Error("Missing env: TABLE_NAME");var s=t=>({S:t}),A=()=>new Date().toISOString();function S(t){let n=t?.identity?.claims||{},r=t?.identity?.sub||n?.sub,e=n?.["cognito:groups"],a=(Array.isArray(e)?e:String(e||"").split(",").map(d=>d.trim()).filter(Boolean)).includes("ADMIN");if(!r)throw new Error("Unauthorized");return{sub:r,isAdmin:a}}var b=async t=>{let{sub:n}=S(t);return((await m.send(new i.QueryCommand({TableName:p,IndexName:"gsi1",KeyConditionExpression:"gsi1pk = :p",ExpressionAttributeValues:{":p":s(`OWNER#${n}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, title, reason",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(e=>({id:e.id.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??""}))},k=async t=>{let{isAdmin:n}=S(t);if(!n)throw new Error("Forbidden");return((await m.send(new i.QueryCommand({TableName:p,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":s("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, title, reason",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(e=>({id:e.id.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??""}))},T=async t=>{let{sub:n}=S(t),r=t?.arguments||{},e=(0,g.randomUUID)(),o=A();return await m.send(new i.PutItemCommand({TableName:p,Item:{pk:s(`ITEM#${e}`),sk:s("META"),id:s(e),ownerSub:s(n),status:s("DRAFT"),title:s(r.title??""),mediaKey:s(r.mediaKey??""),createdAt:s(o),updatedAt:s(o),gsi1pk:s(`OWNER#${n}`),gsi1sk:s(o),gsi2pk:s("STATUS#DRAFT"),gsi2sk:s(o)},ConditionExpression:"attribute_not_exists(pk)"})),{id:e,ownerSub:n,status:"DRAFT",title:r.title??"",mediaKey:r.mediaKey??"",createdAt:o,updatedAt:o}},f=async t=>{let{sub:n,isAdmin:r}=S(t),e=t?.arguments?.id,o=t?.arguments?.mediaKey;if(!e||!o)throw new Error("id and mediaKey required");if(!r){let l=await m.send(new i.GetItemCommand({TableName:p,Key:{pk:s(`ITEM#${e}`),sk:s("META")},ProjectionExpression:"ownerSub"}));if(!l.Item?.ownerSub?.S)throw new Error("Not found");if(l.Item.ownerSub.S!==n)throw new Error("Not authorized")}let a=A(),u=(await m.send(new i.UpdateItemCommand({TableName:p,Key:{pk:s(`ITEM#${e}`),sk:s("META")},UpdateExpression:"SET mediaKey = :k, updatedAt = :u",ExpressionAttributeValues:{":k":s(o),":u":s(a)},ReturnValues:"ALL_NEW"}))).Attributes;return{id:u.id.S,ownerSub:u.ownerSub.S,status:u.status.S,createdAt:u.createdAt.S,updatedAt:u.updatedAt.S,mediaKey:u.mediaKey?.S??"",title:u.title?.S??"",reason:u.reason?.S??""}},N=async t=>{let{sub:n,isAdmin:r}=S(t),e=t?.arguments?.id;if(!e)throw new Error("id required");let o=A();if(!r){let a=await m.send(new i.GetItemCommand({TableName:p,Key:{pk:s(`ITEM#${e}`),sk:s("META")},ProjectionExpression:"ownerSub"}));if(!a.Item?.ownerSub?.S)throw new Error("Not found");if(a.Item.ownerSub.S!==n)throw new Error("Not authorized")}if(await m.send(new i.UpdateItemCommand({TableName:p,Key:{pk:s(`ITEM#${e}`),sk:s("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":s("PENDING"),":u":s(o),":g2pk":s("STATUS#PENDING"),":g2sk":s(o)}})),y)try{await E.send(new c.StartExecutionCommand({stateMachineArn:y,input:JSON.stringify({itemId:e,ownerSub:n}),name:`req-${e}-${Date.now()}`}))}catch{}return`requested:${e}`},I=async t=>{let{isAdmin:n}=S(t);if(!n)throw new Error("Forbidden");let r=t?.arguments?.id;if(!r)throw new Error("id required");let e=A(),a=(await m.send(new i.UpdateItemCommand({TableName:p,Key:{pk:s(`ITEM#${r}`),sk:s("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":s("APPROVED"),":u":s(e),":g2pk":s("STATUS#APPROVED"),":g2sk":s(e)},ReturnValues:"ALL_OLD"}))).Attributes,d=a?.approvalToken?.S;if(d)try{await E.send(new c.SendTaskSuccessCommand({taskToken:d,output:JSON.stringify({approved:!0})}))}catch{}return{id:a.id.S,ownerSub:a.ownerSub.S,status:"APPROVED",createdAt:a.createdAt.S,updatedAt:e,mediaKey:a.mediaKey?.S??"",title:a.title?.S??"",reason:""}},x=async t=>{let{isAdmin:n}=S(t);if(!n)throw new Error("Forbidden");let r=t?.arguments?.id,e=t?.arguments?.reason??"";if(!r)throw new Error("id required");let o=A(),d=(await m.send(new i.UpdateItemCommand({TableName:p,Key:{pk:s(`ITEM#${r}`),sk:s("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":s("REJECTED"),":u":s(o),":g2pk":s("STATUS#REJECTED"),":g2sk":s(o),":r":s(e)},ReturnValues:"ALL_OLD"}))).Attributes,u=d?.approvalToken?.S;if(u)try{await E.send(new c.SendTaskFailureCommand({taskToken:u,error:"Rejected",cause:e||"Rejected by admin"}))}catch{}return{id:d.id.S,ownerSub:d.ownerSub.S,status:"REJECTED",createdAt:d.createdAt.S,updatedAt:o,mediaKey:d.mediaKey?.S??"",title:d.title?.S??"",reason:e}};var V=async t=>{let n=t.info.fieldName;if(n==="hello")return"Hello from Styling Adventures \u{1F44B}";if(n==="myCloset")return b(t);if(n==="adminListPending")return k(t);if(n==="createClosetItem")return T(t);if(n==="updateClosetMediaKey"||n==="editClosetMediaKey")return f(t);if(n==="requestClosetApproval")return N(t);if(n==="adminApproveItem")return I(t);if(n==="adminRejectItem")return x(t);throw new Error(`Unknown field: ${n}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
