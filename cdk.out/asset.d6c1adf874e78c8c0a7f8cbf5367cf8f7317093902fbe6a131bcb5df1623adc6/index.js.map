{
  "version": 3,
  "sources": ["../../lambda/presign/index.ts"],
  "sourcesContent": ["import {\r\n  S3Client,\r\n  PutObjectCommand,\r\n  ListObjectsV2Command,\r\n  DeleteObjectCommand,\r\n} from \"@aws-sdk/client-s3\";\r\nimport { getSignedUrl } from \"@aws-sdk/s3-request-presigner\";\r\nimport {\r\n  APIGatewayProxyEventV2,\r\n  APIGatewayProxyResultV2,\r\n} from \"aws-lambda\";\r\n\r\nconst BUCKET = process.env.BUCKET!;\r\nconst WEB_ORIGIN = process.env.WEB_ORIGIN ?? \"https://stylingadventures.com\";\r\nconst ALLOWED_ORIGINS = (process.env.ALLOWED_ORIGINS ?? WEB_ORIGIN)\r\n  .split(\",\")\r\n  .map((s) => s.trim())\r\n  .filter(Boolean);\r\n\r\nconst THUMBS_CDN = process.env.THUMBS_CDN;\r\nconst DISABLE_UPLOAD_AUTH =\r\n  process.env.DISABLE_UPLOAD_AUTH === \"true\" ||\r\n  process.env.DISABLE_UPLOAD_AUTH === \"1\";\r\n\r\nconst s3 = new S3Client({});\r\n\r\n// ----- helpers -----\r\n\r\ntype AnyEvent = APIGatewayProxyEventV2 & { requestContext: any };\r\n\r\nfunction resolveOrigin(event: AnyEvent): string {\r\n  const hdrs = event.headers || {};\r\n  const reqOrigin = (hdrs.origin || hdrs.Origin || \"\").trim();\r\n  if (reqOrigin && ALLOWED_ORIGINS.includes(reqOrigin)) return reqOrigin;\r\n  return WEB_ORIGIN;\r\n}\r\n\r\nfunction makeBaseHeaders(origin: string) {\r\n  return {\r\n    \"Content-Type\": \"application/json\",\r\n    \"Access-Control-Allow-Origin\": origin,\r\n    \"Access-Control-Allow-Headers\":\r\n      \"Authorization,Content-Type,X-Amz-Date,X-Api-Key,X-Amz-Security-Token\",\r\n    \"Access-Control-Allow-Methods\": \"GET,POST,DELETE,OPTIONS\",\r\n    \"Access-Control-Allow-Credentials\": \"true\",\r\n    Vary: \"Origin\",\r\n  };\r\n}\r\n\r\nfunction methodOf(event: AnyEvent): string {\r\n  return (\r\n    event.requestContext?.http?.method ||\r\n    (event as any).httpMethod ||\r\n    \"GET\"\r\n  ).toUpperCase();\r\n}\r\n\r\nfunction pathOf(event: AnyEvent): string {\r\n  return event.rawPath || (event as any).path || \"/\";\r\n}\r\n\r\nfunction claimsOf(event: AnyEvent): Record<string, any> {\r\n  return (\r\n    event.requestContext?.authorizer?.jwt?.claims ||\r\n    event.requestContext?.authorizer?.claims ||\r\n    {}\r\n  );\r\n}\r\n\r\nfunction parseBody<T = any>(event: AnyEvent): T | undefined {\r\n  if (!event.body) return;\r\n  const raw = event.isBase64Encoded\r\n    ? Buffer.from(event.body, \"base64\").toString()\r\n    : event.body;\r\n  try {\r\n    return JSON.parse(raw);\r\n  } catch {\r\n    return undefined;\r\n  }\r\n}\r\n\r\nfunction ok(\r\n  headers: Record<string, string>,\r\n  body: any,\r\n  extraHeaders: Record<string, string> = {}\r\n): APIGatewayProxyResultV2 {\r\n  return {\r\n    statusCode: 200,\r\n    headers: { ...headers, ...extraHeaders },\r\n    body: JSON.stringify(body),\r\n  };\r\n}\r\n\r\nfunction err(\r\n  headers: Record<string, string>,\r\n  statusCode: number,\r\n  message: string\r\n): APIGatewayProxyResultV2 {\r\n  return {\r\n    statusCode,\r\n    headers,\r\n    body: JSON.stringify({ message }),\r\n  };\r\n}\r\n\r\n// ----- handler -----\r\n\r\nexport const handler = async (\r\n  event: AnyEvent\r\n): Promise<APIGatewayProxyResultV2> => {\r\n  const origin = resolveOrigin(event);\r\n  const headers = makeBaseHeaders(origin);\r\n  const method = methodOf(event);\r\n  const path = pathOf(event);\r\n  const claims = claimsOf(event);\r\n  const sub: string | undefined = claims.sub;\r\n\r\n  // CORS preflight\r\n  if (method === \"OPTIONS\") {\r\n    return {\r\n      statusCode: 204,\r\n      headers,\r\n      body: \"\",\r\n    };\r\n  }\r\n\r\n  try {\r\n    // --- POST /presign ---\r\n    if (method === \"POST\" && /\\/presign$/.test(path)) {\r\n      const body = parseBody<{ key: string; contentType: string }>(event);\r\n      if (!body) return err(headers, 400, \"Missing body\");\r\n\r\n      let { key, contentType } = body;\r\n\r\n      if (!key || typeof key !== \"string\") {\r\n        return err(headers, 400, 'Invalid \"key\"');\r\n      }\r\n      if (!contentType || typeof contentType !== \"string\") {\r\n        return err(headers, 400, 'Invalid \"contentType\"');\r\n      }\r\n      if (key.includes(\"..\")) {\r\n        return err(headers, 400, \"Illegal key\");\r\n      }\r\n\r\n      // In normal authenticated mode, auto-scope under users/{sub}/\r\n      if (sub && !key.startsWith(\"users/\")) {\r\n        key = `users/${sub}/${key}`;\r\n      }\r\n\r\n      const put = new PutObjectCommand({\r\n        Bucket: BUCKET,\r\n        Key: key,\r\n        ContentType: contentType,\r\n      });\r\n\r\n      const url = await getSignedUrl(s3, put, { expiresIn: 900 });\r\n\r\n      return ok(headers, { url, key, thumbsCdn: THUMBS_CDN ?? undefined });\r\n    }\r\n\r\n    // --- GET /list ---\r\n    if (method === \"GET\" && /\\/list$/.test(path)) {\r\n      const listParams: any = { Bucket: BUCKET };\r\n\r\n      // In normal mode: only list user's own objects.\r\n      if (!DISABLE_UPLOAD_AUTH && sub) {\r\n        listParams.Prefix = `users/${sub}/`;\r\n      }\r\n\r\n      const res = await s3.send(new ListObjectsV2Command(listParams));\r\n      const items =\r\n        res.Contents?.map((obj) => ({\r\n          key: obj.Key,\r\n          size: obj.Size,\r\n          lastModified: obj.LastModified?.toISOString?.(),\r\n        })) ?? [];\r\n\r\n      return ok(headers, { items });\r\n    }\r\n\r\n    // --- DELETE /delete ---\r\n    if (method === \"DELETE\" && /\\/delete$/.test(path)) {\r\n      const body = parseBody<{ key?: string }>(event);\r\n      const qsKey = event.queryStringParameters?.key\r\n        ? decodeURIComponent(event.queryStringParameters.key)\r\n        : undefined;\r\n      const key = body?.key ?? qsKey;\r\n\r\n      if (!key || typeof key !== \"string\") {\r\n        return err(headers, 400, 'Invalid \"key\"');\r\n      }\r\n\r\n      // In normal mode, enforce ownership; in DISABLE_UPLOAD_AUTH we skip this.\r\n      if (!DISABLE_UPLOAD_AUTH && sub && !key.startsWith(`users/${sub}/`)) {\r\n        return err(headers, 403, \"Forbidden\");\r\n      }\r\n\r\n      await s3.send(\r\n        new DeleteObjectCommand({\r\n          Bucket: BUCKET,\r\n          Key: key,\r\n        })\r\n      );\r\n\r\n      return ok(headers, { deleted: key });\r\n    }\r\n\r\n    // Fallback\r\n    return err(headers, 404, \"Not Found\");\r\n  } catch (e: any) {\r\n    console.error(\"presign handler error\", e);\r\n    return err(headers, 500, e?.message ?? \"Server error\");\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["index_exports", "__export", "handler", "__toCommonJS", "import_client_s3", "import_s3_request_presigner", "BUCKET", "WEB_ORIGIN", "ALLOWED_ORIGINS", "s", "THUMBS_CDN", "DISABLE_UPLOAD_AUTH", "s3", "resolveOrigin", "event", "hdrs", "reqOrigin", "makeBaseHeaders", "origin", "methodOf", "pathOf", "claimsOf", "parseBody", "raw", "ok", "headers", "body", "extraHeaders", "err", "statusCode", "message", "method", "path", "sub", "key", "contentType", "put", "url", "listParams", "items", "obj", "qsKey", "e"]
}
