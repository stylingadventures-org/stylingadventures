"use strict";var d=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var I=(t,e)=>{for(var n in e)d(t,n,{get:e[n],enumerable:!0})},R=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of E(e))!S.call(t,s)&&s!==n&&d(t,s,{get:()=>e[s],enumerable:!(r=P(e,s))||r.enumerable});return t};var G=t=>R(d({},"__esModule",{value:!0}),t);var L={};I(L,{handler:()=>K});module.exports=G(L);var o=require("@aws-sdk/client-s3"),l=require("@aws-sdk/s3-request-presigner"),g=new o.S3Client({region:process.env.AWS_REGION||"us-east-1",forcePathStyle:!0}),c=process.env.BUCKET,f=String(process.env.ALLOWED_ORIGINS||"").split(",").map(t=>t.trim()).filter(Boolean),T=process.env.WEB_ORIGIN||"",b=["authorization","Authorization","Content-Type","X-Amz-Date","X-Api-Key","X-Amz-Security-Token"].join(",");function u(t){let e=t?.headers?.origin||t?.headers?.Origin||"";return f.length?f.includes(e)?e:void 0:T||void 0}function a(t){let e={"Content-Type":"application/json","Access-Control-Allow-Headers":b,"Access-Control-Allow-Methods":"GET,POST,DELETE,OPTIONS","Access-Control-Allow-Credentials":"true",Vary:"Origin, Access-Control-Request-Headers, Access-Control-Request-Method"};return t&&(e["Access-Control-Allow-Origin"]=t),e}function p(t,e,n={}){let r=u(t);return{statusCode:200,headers:{...a(r),...n},body:JSON.stringify(e)}}function x(t){let e=u(t);return{statusCode:204,headers:a(e),body:""}}function i(t,e,n){let r=u(t);return!!(t.headers?.origin||t.headers?.Origin)&&!r?{statusCode:403,headers:a(void 0),body:JSON.stringify({message:"CORS: origin not allowed"})}:{statusCode,headers:a(r),body:JSON.stringify({message:n})}}function k(t){return t.httpMethod??t.requestContext?.http?.method??"GET"}function N(t){return t.requestContext?.authorizer?.claims??t.requestContext?.authorizer?.jwt?.claims??{}}function B(t){let e=t.body??"";if(!e)return{};let n=t.isBase64Encoded&&typeof e=="string"?Buffer.from(e,"base64").toString():e;try{return typeof n=="string"?JSON.parse(n):n}catch{return{}}}function A(t,e){let n=String(e||"").replace(/\.\./g,"").replace(/^[/\\]+/,""),r=n.startsWith(`users/${t}/`),s=/^users\/[^/]+\//.test(n)&&!r;return r?n:`users/${t}/${s?n.replace(/^users\/[^/]+\//,""):n}`}var K=async t=>{let e=k(t);if(e==="OPTIONS")return!u(t)&&(t.headers?.origin||t.headers?.Origin)?{statusCode:403,headers:a(void 0),body:""}:x(t);try{let n=N(t)?.sub;if(!n)return i(t,401,"Not authorized");if(e==="POST"){let r=B(t),s=String(r.key||""),h=String(r.contentType||"application/octet-stream");if(!s)return i(t,400,"Missing 'key'");let y=A(n,s),m=new o.PutObjectCommand({Bucket:c,Key:y,ContentType:h}),C=new o.GetObjectCommand({Bucket:c,Key:y}),O=await(0,l.getSignedUrl)(g,m,{expiresIn:900}),w=await(0,l.getSignedUrl)(g,C,{expiresIn:300});return p(t,{bucket:c,key:y,method:"PUT",putUrl:O,getUrl:w})}if(e==="DELETE"){let r=t?.queryStringParameters?.key??t.pathParameters?.key??"";if(!r)return i(t,400,"Missing 'key'");let s=A(n,String(r));return await g.send(new o.DeleteObjectCommand({Bucket:c,Key:s})),p(t,{deleted:!0,key:s})}return i(t,405,"Method Not Allowed")}catch(n){return console.error(n),i(t,500,n?.message??String(n))}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
