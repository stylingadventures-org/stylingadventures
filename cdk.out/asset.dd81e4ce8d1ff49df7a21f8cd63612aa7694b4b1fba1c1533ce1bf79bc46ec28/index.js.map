{
  "version": 3,
  "sources": ["../../lambda/game/gameplay.ts"],
  "sourcesContent": ["// lambda/game/gameplay.ts\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  UpdateCommand,\r\n  PutCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\nimport { AppSyncIdentityCognito } from \"aws-lambda\";\r\n\r\nconst TABLE = process.env.TABLE_NAME!;\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}), {\r\n  marshallOptions: { removeUndefinedValues: true },\r\n});\r\n\r\n// AppSync sometimes sends `groups: null`. Accept null|undefined.\r\ntype SAIdentity = (AppSyncIdentityCognito & { groups?: string[] | null }) | null | undefined;\r\n\r\ntype AppSyncEvent = {\r\n  arguments: any;\r\n  info: { fieldName: string };\r\n  identity?: SAIdentity;\r\n};\r\n\r\nfunction isAdmin(id: SAIdentity): boolean {\r\n  const g = (id as any)?.groups;\r\n  return Array.isArray(g) && g.includes(\"ADMIN\");\r\n}\r\n\r\nfunction assertSelfOrAdmin(targetUserId: string, identity?: SAIdentity) {\r\n  if (!identity?.sub) throw new Error(\"Unauthenticated\");\r\n  if (!isAdmin(identity) && identity.sub !== targetUserId) throw new Error(\"Forbidden\");\r\n}\r\n\r\n// Accept object or JSON string\r\nfunction coerceMeta(m: unknown): Record<string, any> | null {\r\n  if (m == null) return null;\r\n  if (typeof m === \"string\") {\r\n    try { return JSON.parse(m); } catch { return { raw: m }; }\r\n  }\r\n  return typeof m === \"object\" ? (m as any) : { value: m };\r\n}\r\n\r\nfunction levelFromXp(xp: number): number {\r\n  let lvl = 1, need = 100, left = xp;\r\n  while (left >= need) { left -= need; lvl++; need += 50; }\r\n  return lvl;\r\n}\r\n\r\nfunction pad(n: number, width = 12) {\r\n  const s = Math.max(0, n | 0).toString();\r\n  return s.padStart(width, \"0\");\r\n}\r\n\r\nexport const handler = async (event: AppSyncEvent) => {\r\n  const { fieldName } = event.info;\r\n  const identity = event.identity;\r\n\r\n  if (fieldName === \"logGameEvent\") {\r\n    if (!identity?.sub) throw new Error(\"Unauthenticated\");\r\n    const userId = identity.sub;\r\n    const nowIso = new Date().toISOString();\r\n\r\n    const input = event.arguments?.input ?? {};\r\n    const evType: string = input.type || \"UNKNOWN\";\r\n    const metadata = coerceMeta(input.metadata);\r\n\r\n    const xpInc =\r\n      evType === \"LEVEL_CLEAR\" ? 50 :\r\n      evType === \"DAILY_LOGIN\" ? 10 :\r\n      evType === \"SHARE\"       ? 5  :\r\n      evType === \"STYLE_IT\"    ? Math.max(1, Math.round((metadata?.score ?? 5) / 5)) :\r\n      1;\r\n\r\n    const coinInc =\r\n      evType === \"LEVEL_CLEAR\" ? 5 :\r\n      evType === \"DAILY_LOGIN\" ? 1 :\r\n      0;\r\n\r\n    const upd = await ddb.send(new UpdateCommand({\r\n      TableName: TABLE,\r\n      Key: { pk: `USER#${userId}`, sk: \"PROFILE\" },\r\n      UpdateExpression: \"SET xp = if_not_exists(xp, :z) + :xi, coins = if_not_exists(coins, :z) + :ci, lastEventAt = :now\",\r\n      ExpressionAttributeValues: { \":z\": 0, \":xi\": xpInc, \":ci\": coinInc, \":now\": nowIso },\r\n      ReturnValues: \"ALL_NEW\",\r\n    }));\r\n\r\n    const xpNow = Number(upd.Attributes?.xp ?? 0);\r\n\r\n    await ddb.send(new PutCommand({\r\n      TableName: TABLE,\r\n      Item: {\r\n        pk: `USER#${userId}`,\r\n        sk: \"LEADER\",\r\n        gsi1pk: \"LEADERBOARD#GLOBAL\",\r\n        gsi1sk: `XP#${pad(xpNow)}#${userId}`,\r\n        xp: xpNow,\r\n        coins: Number(upd.Attributes?.coins ?? 0),\r\n        updatedAt: nowIso,\r\n        type: \"LEADER\",\r\n      },\r\n    }));\r\n\r\n    await ddb.send(new PutCommand({\r\n      TableName: TABLE,\r\n      Item: {\r\n        pk: `USER#${userId}`,\r\n        sk: `EVENT#${Date.now()}`,\r\n        type: \"EVENT\",\r\n        evType,\r\n        metadata,\r\n        at: nowIso,\r\n      },\r\n      ConditionExpression: \"attribute_not_exists(pk)\",\r\n    })).catch(() => { /* duplicate clock collisions are fine */ });\r\n\r\n    return {\r\n      userId,\r\n      level: levelFromXp(xpNow),\r\n      xp: xpNow,\r\n      coins: Number(upd.Attributes?.coins ?? 0),\r\n      badges: Array.isArray(upd.Attributes?.badges) ? upd.Attributes?.badges : [],\r\n      lastEventAt: upd.Attributes?.lastEventAt ?? nowIso,\r\n    };\r\n  }\r\n\r\n  if (fieldName === \"awardCoins\") {\r\n    const { userId, coins, xp } = event.arguments.input as { userId: string; coins: number; xp?: number };\r\n    assertSelfOrAdmin(userId, identity);\r\n\r\n    const incCoins = Math.max(0, coins | 0);\r\n    const incXp = Math.max(0, (xp ?? 0) | 0);\r\n\r\n    const upd = await ddb.send(new UpdateCommand({\r\n      TableName: TABLE,\r\n      Key: { pk: `USER#${userId}`, sk: \"PROFILE\" },\r\n      UpdateExpression: \"SET coins = if_not_exists(coins,:z) + :c, xp = if_not_exists(xp,:z) + :x\",\r\n      ExpressionAttributeValues: { \":z\": 0, \":c\": incCoins, \":x\": incXp },\r\n      ReturnValues: \"ALL_NEW\",\r\n    }));\r\n\r\n    const xpNow = Number(upd.Attributes?.xp ?? 0);\r\n\r\n    await ddb.send(new PutCommand({\r\n      TableName: TABLE,\r\n      Item: {\r\n        pk: `USER#${userId}`,\r\n        sk: \"LEADER\",\r\n        gsi1pk: \"LEADERBOARD#GLOBAL\",\r\n        gsi1sk: `XP#${pad(xpNow)}#${userId}`,\r\n        xp: xpNow,\r\n        coins: Number(upd.Attributes?.coins ?? 0),\r\n        updatedAt: new Date().toISOString(),\r\n        type: \"LEADER\",\r\n      },\r\n    }));\r\n\r\n    return {\r\n      userId,\r\n      level: levelFromXp(xpNow),\r\n      xp: xpNow,\r\n      coins: Number(upd.Attributes?.coins ?? 0),\r\n      badges: Array.isArray(upd.Attributes?.badges) ? upd.Attributes?.badges : [],\r\n      lastEventAt: upd.Attributes?.lastEventAt ?? null,\r\n    };\r\n  }\r\n\r\n  throw new Error(`Unknown field ${fieldName}`);\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GACA,IAAAI,EAA+B,oCAC/BC,EAIO,iCAGDC,EAAQ,QAAQ,IAAI,WACpBC,EAAM,yBAAuB,KAAK,IAAI,iBAAe,CAAC,CAAC,EAAG,CAC9D,gBAAiB,CAAE,sBAAuB,EAAK,CACjD,CAAC,EAWD,SAASC,EAAQC,EAAyB,CACxC,IAAMC,EAAKD,GAAY,OACvB,OAAO,MAAM,QAAQC,CAAC,GAAKA,EAAE,SAAS,OAAO,CAC/C,CAEA,SAASC,EAAkBC,EAAsBC,EAAuB,CACtE,GAAI,CAACA,GAAU,IAAK,MAAM,IAAI,MAAM,iBAAiB,EACrD,GAAI,CAACL,EAAQK,CAAQ,GAAKA,EAAS,MAAQD,EAAc,MAAM,IAAI,MAAM,WAAW,CACtF,CAGA,SAASE,EAAWC,EAAwC,CAC1D,GAAIA,GAAK,KAAM,OAAO,KACtB,GAAI,OAAOA,GAAM,SACf,GAAI,CAAE,OAAO,KAAK,MAAMA,CAAC,CAAG,MAAQ,CAAE,MAAO,CAAE,IAAKA,CAAE,CAAG,CAE3D,OAAO,OAAOA,GAAM,SAAYA,EAAY,CAAE,MAAOA,CAAE,CACzD,CAEA,SAASC,EAAYC,EAAoB,CACvC,IAAIC,EAAM,EAAGC,EAAO,IAAKC,EAAOH,EAChC,KAAOG,GAAQD,GAAQC,GAAQD,EAAMD,IAAOC,GAAQ,GACpD,OAAOD,CACT,CAEA,SAASG,EAAIC,EAAWC,EAAQ,GAAI,CAElC,OADU,KAAK,IAAI,EAAGD,EAAI,CAAC,EAAE,SAAS,EAC7B,SAASC,EAAO,GAAG,CAC9B,CAEO,IAAMrB,EAAU,MAAOsB,GAAwB,CACpD,GAAM,CAAE,UAAAC,CAAU,EAAID,EAAM,KACtBX,EAAWW,EAAM,SAEvB,GAAIC,IAAc,eAAgB,CAChC,GAAI,CAACZ,GAAU,IAAK,MAAM,IAAI,MAAM,iBAAiB,EACrD,IAAMa,EAASb,EAAS,IAClBc,EAAS,IAAI,KAAK,EAAE,YAAY,EAEhCC,EAAQJ,EAAM,WAAW,OAAS,CAAC,EACnCK,EAAiBD,EAAM,MAAQ,UAC/BE,EAAWhB,EAAWc,EAAM,QAAQ,EAEpCG,EACJF,IAAW,cAAgB,GAC3BA,IAAW,cAAgB,GAC3BA,IAAW,QAAgB,EAC3BA,IAAW,WAAgB,KAAK,IAAI,EAAG,KAAK,OAAOC,GAAU,OAAS,GAAK,CAAC,CAAC,EAC7E,EAEIE,EACJH,IAAW,cAAgB,EAC3BA,IAAW,cAAgB,EAC3B,EAEII,EAAM,MAAM1B,EAAI,KAAK,IAAI,gBAAc,CAC3C,UAAWD,EACX,IAAK,CAAE,GAAI,QAAQoB,CAAM,GAAI,GAAI,SAAU,EAC3C,iBAAkB,mGAClB,0BAA2B,CAAE,KAAM,EAAG,MAAOK,EAAO,MAAOC,EAAS,OAAQL,CAAO,EACnF,aAAc,SAChB,CAAC,CAAC,EAEIO,EAAQ,OAAOD,EAAI,YAAY,IAAM,CAAC,EAE5C,aAAM1B,EAAI,KAAK,IAAI,aAAW,CAC5B,UAAWD,EACX,KAAM,CACJ,GAAI,QAAQoB,CAAM,GAClB,GAAI,SACJ,OAAQ,qBACR,OAAQ,MAAML,EAAIa,CAAK,CAAC,IAAIR,CAAM,GAClC,GAAIQ,EACJ,MAAO,OAAOD,EAAI,YAAY,OAAS,CAAC,EACxC,UAAWN,EACX,KAAM,QACR,CACF,CAAC,CAAC,EAEF,MAAMpB,EAAI,KAAK,IAAI,aAAW,CAC5B,UAAWD,EACX,KAAM,CACJ,GAAI,QAAQoB,CAAM,GAClB,GAAI,SAAS,KAAK,IAAI,CAAC,GACvB,KAAM,QACN,OAAAG,EACA,SAAAC,EACA,GAAIH,CACN,EACA,oBAAqB,0BACvB,CAAC,CAAC,EAAE,MAAM,IAAM,CAA4C,CAAC,EAEtD,CACL,OAAAD,EACA,MAAOV,EAAYkB,CAAK,EACxB,GAAIA,EACJ,MAAO,OAAOD,EAAI,YAAY,OAAS,CAAC,EACxC,OAAQ,MAAM,QAAQA,EAAI,YAAY,MAAM,EAAIA,EAAI,YAAY,OAAS,CAAC,EAC1E,YAAaA,EAAI,YAAY,aAAeN,CAC9C,CACF,CAEA,GAAIF,IAAc,aAAc,CAC9B,GAAM,CAAE,OAAAC,EAAQ,MAAAS,EAAO,GAAAlB,CAAG,EAAIO,EAAM,UAAU,MAC9Cb,EAAkBe,EAAQb,CAAQ,EAElC,IAAMuB,EAAW,KAAK,IAAI,EAAGD,EAAQ,CAAC,EAChCE,EAAQ,KAAK,IAAI,GAAIpB,GAAM,GAAK,CAAC,EAEjCgB,EAAM,MAAM1B,EAAI,KAAK,IAAI,gBAAc,CAC3C,UAAWD,EACX,IAAK,CAAE,GAAI,QAAQoB,CAAM,GAAI,GAAI,SAAU,EAC3C,iBAAkB,2EAClB,0BAA2B,CAAE,KAAM,EAAG,KAAMU,EAAU,KAAMC,CAAM,EAClE,aAAc,SAChB,CAAC,CAAC,EAEIH,EAAQ,OAAOD,EAAI,YAAY,IAAM,CAAC,EAE5C,aAAM1B,EAAI,KAAK,IAAI,aAAW,CAC5B,UAAWD,EACX,KAAM,CACJ,GAAI,QAAQoB,CAAM,GAClB,GAAI,SACJ,OAAQ,qBACR,OAAQ,MAAML,EAAIa,CAAK,CAAC,IAAIR,CAAM,GAClC,GAAIQ,EACJ,MAAO,OAAOD,EAAI,YAAY,OAAS,CAAC,EACxC,UAAW,IAAI,KAAK,EAAE,YAAY,EAClC,KAAM,QACR,CACF,CAAC,CAAC,EAEK,CACL,OAAAP,EACA,MAAOV,EAAYkB,CAAK,EACxB,GAAIA,EACJ,MAAO,OAAOD,EAAI,YAAY,OAAS,CAAC,EACxC,OAAQ,MAAM,QAAQA,EAAI,YAAY,MAAM,EAAIA,EAAI,YAAY,OAAS,CAAC,EAC1E,YAAaA,EAAI,YAAY,aAAe,IAC9C,CACF,CAEA,MAAM,IAAI,MAAM,iBAAiBR,CAAS,EAAE,CAC9C",
  "names": ["gameplay_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "TABLE", "ddb", "isAdmin", "id", "g", "assertSelfOrAdmin", "targetUserId", "identity", "coerceMeta", "m", "levelFromXp", "xp", "lvl", "need", "left", "pad", "n", "width", "event", "fieldName", "userId", "nowIso", "input", "evType", "metadata", "xpInc", "coinInc", "upd", "xpNow", "coins", "incCoins", "incXp"]
}
