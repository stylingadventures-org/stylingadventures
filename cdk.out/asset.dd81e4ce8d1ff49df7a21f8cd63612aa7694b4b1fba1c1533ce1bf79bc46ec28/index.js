"use strict";var b=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var g=Object.prototype.hasOwnProperty;var L=(t,n)=>{for(var s in n)b(t,s,{get:n[s],enumerable:!0})},N=(t,n,s,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let r of f(n))!g.call(t,r)&&r!==s&&b(t,r,{get:()=>n[r],enumerable:!(e=w(n,r))||e.enumerable});return t};var I=t=>N(b({},"__esModule",{value:!0}),t);var k={};L(k,{handler:()=>_});module.exports=I(k);var x=require("@aws-sdk/client-dynamodb"),o=require("@aws-sdk/lib-dynamodb"),p=process.env.TABLE_NAME,d=o.DynamoDBDocumentClient.from(new x.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}});function S(t){let n=t?.groups;return Array.isArray(n)&&n.includes("ADMIN")}function R(t,n){if(!n?.sub)throw new Error("Unauthenticated");if(!S(n)&&n.sub!==t)throw new Error("Forbidden")}function D(t){if(t==null)return null;if(typeof t=="string")try{return JSON.parse(t)}catch{return{raw:t}}return typeof t=="object"?t:{value:t}}function m(t){let n=1,s=100,e=t;for(;e>=s;)e-=s,n++,s+=50;return n}function y(t,n=12){return Math.max(0,t|0).toString().padStart(n,"0")}var _=async t=>{let{fieldName:n}=t.info,s=t.identity;if(n==="logGameEvent"){if(!s?.sub)throw new Error("Unauthenticated");let e=s.sub,r=new Date().toISOString(),A=t.arguments?.input??{},i=A.type||"UNKNOWN",E=D(A.metadata),a=i==="LEVEL_CLEAR"?50:i==="DAILY_LOGIN"?10:i==="SHARE"?5:i==="STYLE_IT"?Math.max(1,Math.round((E?.score??5)/5)):1,u=i==="LEVEL_CLEAR"?5:i==="DAILY_LOGIN"?1:0,c=await d.send(new o.UpdateCommand({TableName:p,Key:{pk:`USER#${e}`,sk:"PROFILE"},UpdateExpression:"SET xp = if_not_exists(xp, :z) + :xi, coins = if_not_exists(coins, :z) + :ci, lastEventAt = :now",ExpressionAttributeValues:{":z":0,":xi":a,":ci":u,":now":r},ReturnValues:"ALL_NEW"})),l=Number(c.Attributes?.xp??0);return await d.send(new o.PutCommand({TableName:p,Item:{pk:`USER#${e}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${y(l)}#${e}`,xp:l,coins:Number(c.Attributes?.coins??0),updatedAt:r,type:"LEADER"}})),await d.send(new o.PutCommand({TableName:p,Item:{pk:`USER#${e}`,sk:`EVENT#${Date.now()}`,type:"EVENT",evType:i,metadata:E,at:r},ConditionExpression:"attribute_not_exists(pk)"})).catch(()=>{}),{userId:e,level:m(l),xp:l,coins:Number(c.Attributes?.coins??0),badges:Array.isArray(c.Attributes?.badges)?c.Attributes?.badges:[],lastEventAt:c.Attributes?.lastEventAt??r}}if(n==="awardCoins"){let{userId:e,coins:r,xp:A}=t.arguments.input;R(e,s);let i=Math.max(0,r|0),E=Math.max(0,(A??0)|0),a=await d.send(new o.UpdateCommand({TableName:p,Key:{pk:`USER#${e}`,sk:"PROFILE"},UpdateExpression:"SET coins = if_not_exists(coins,:z) + :c, xp = if_not_exists(xp,:z) + :x",ExpressionAttributeValues:{":z":0,":c":i,":x":E},ReturnValues:"ALL_NEW"})),u=Number(a.Attributes?.xp??0);return await d.send(new o.PutCommand({TableName:p,Item:{pk:`USER#${e}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${y(u)}#${e}`,xp:u,coins:Number(a.Attributes?.coins??0),updatedAt:new Date().toISOString(),type:"LEADER"}})),{userId:e,level:m(u),xp:u,coins:Number(a.Attributes?.coins??0),badges:Array.isArray(a.Attributes?.badges)?a.Attributes?.badges:[],lastEventAt:a.Attributes?.lastEventAt??null}}throw new Error(`Unknown field ${n}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
