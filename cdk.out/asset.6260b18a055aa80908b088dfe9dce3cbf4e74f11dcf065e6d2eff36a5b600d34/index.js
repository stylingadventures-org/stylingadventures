"use strict";var I=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var D=Object.prototype.hasOwnProperty;var b=(e,t)=>{for(var n in t)I(e,n,{get:t[n],enumerable:!0})},T=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of C(t))!D.call(e,r)&&r!==n&&I(e,r,{get:()=>t[r],enumerable:!(s=$(t,r))||s.enumerable});return e};var x=e=>T(I({},"__esModule",{value:!0}),e);var H={};b(H,{handler:()=>v});module.exports=x(H);var g=require("@aws-sdk/client-appsync"),w=e=>new Promise(t=>setTimeout(t,e));function E(){return new Date().toISOString()}function f(...e){console.log(`[schema-ready] ${E()}`,...e)}function P(...e){console.warn(`[schema-ready] ${E()}`,...e)}function L(...e){console.error(`[schema-ready] ${E()}`,...e)}function R(e,t){if(typeof e=="string"&&e.trim().length>0)return e.trim();throw new Error(`Missing required "${t}" (got ${JSON.stringify(e)})`)}function y(e,t){let n=Number(e);return Number.isFinite(n)&&n>0?n:t}function F(e){let t=e.match(/type\s+Mutation\s*\{[\s\S]*?\}/m);return t?t[0]:null}function N(e,t){return new RegExp(`\\b${M(t)}\\b`).test(e)}function _(e,t){let n=F(e);return n?new RegExp(`\\b${M(t)}\\b`).test(n):!1}function M(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async function k(e,t){let n=await e.send(new g.GetSchemaCreationStatusCommand({apiId:t}));return{status:n.status??"UNKNOWN",details:n.details??""}}async function O(e,t){let s=(await e.send(new g.GetIntrospectionSchemaCommand({apiId:t,format:"SDL"}))).schema;return s?(typeof s=="string"?Buffer.from(s,"base64"):Buffer.from(s)).toString("utf8"):""}async function U(e,t,n,s){for(let r=1;r<=n;r++){let{status:c,details:u}=await k(e,t);if(f(`schema status attempt ${r}/${n}: ${c} (${u})`),c==="SUCCESS")return{status:c,details:u};if(c==="FAILED")throw new Error(`Schema status FAILED: ${u||"no details"}`);await w(s)}throw new Error("Timed out waiting for schema to reach SUCCESS")}async function q(e,t,n,s,r){let c=0,u=!1;for(let d=1;d<=s;d++){let a="";try{a=await O(e,t)}catch(i){P(`introspection attempt ${d}/${s} error:`,i?.message??i),await w(r);continue}c=a.length;let m=N(a,n),l=_(a,n);if(u=l,f(`introspection attempt ${d}/${s}: sdlLen=${a.length} fieldAnywhere=${m} fieldInMutation=${l}`),m){let i=a.search(new RegExp(`\\b${M(n)}\\b`));if(i>=0){let h=Math.max(0,i-80),o=Math.min(a.length,i+120);f("field context snippet:",JSON.stringify(a.slice(h,o)))}return{ok:!0,fieldAnywhere:!0,fieldInMutation:l,sdlLen:a.length}}let S=Math.floor(Math.random()*Math.min(500,r));await w(r+S)}return{ok:!1,fieldAnywhere:!1,fieldInMutation:u,sdlLen:c}}async function v(e){let t=e?.ResourceProperties??{},n=process.env.APPSYNC_API_ID??process.env.API_ID??t.apiId??t.ApiId,s=process.env.EXPECTED_FIELD??t.expectedField??t.ExpectedField,r=process.env.AWS_REGION??process.env.REGION??t.region??t.Region,c=y(process.env.SCHEMA_STATUS_MAX_ATTEMPTS??t.schemaStatusMaxAttempts,30),u=y(process.env.SCHEMA_STATUS_DELAY_MS??t.schemaStatusDelayMs,2e3),d=y(process.env.INTROSPECTION_MAX_ATTEMPTS??t.introspectionMaxAttempts,40),a=y(process.env.INTROSPECTION_DELAY_MS??t.introspectionDelayMs,2500),m=e.PhysicalResourceId??`AppSyncSchemaReady:${String(n??"unknown")}`;if(e.RequestType==="Delete")return f("Delete request -> skipping checks"),{PhysicalResourceId:m,Data:{skipped:!0}};let l=R(n,"apiId"),S=R(r,"region"),i=String(s??"").trim();f("starting",{requestType:e.RequestType,apiId:l,expectedField:i||"(none)",region:S,maxSchemaAttempts:c,schemaDelayMs:u,maxIntrospectionAttempts:d,introspectionDelayMs:a});let h=new g.AppSyncClient({region:S}),o=await U(h,l,c,u);if(i){let p=await q(h,l,i,d,a);if(!p.ok){let A=`Schema SUCCESS but expectedField "${i}" not found via introspection after retries. details=${o.details||"no details"} (sdlLen=${p.sdlLen}, fieldInMutation=${p.fieldInMutation})`;throw L(A),new Error(A)}return f("READY",{status:o.status,details:o.details,expectedField:i,fieldInMutation:p.fieldInMutation,sdlLen:p.sdlLen}),{PhysicalResourceId:m,Data:{ok:!0,apiId:l,expectedField:i,schemaStatus:o.status,schemaDetails:o.details,fieldInMutation:p.fieldInMutation,sdlLen:p.sdlLen}}}return f("READY (no expectedField check)",{status:o.status,details:o.details}),{PhysicalResourceId:m,Data:{ok:!0,apiId:l,schemaStatus:o.status,schemaDetails:o.details,expectedField:""}}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
