{
  "version": 3,
  "sources": ["../../lambda/bestie/index.ts"],
  "sourcesContent": ["// lambda/bestie/index.ts\r\nimport {\r\n  CognitoIdentityProviderClient,\r\n  ListUsersCommand,\r\n} from \"@aws-sdk/client-cognito-identity-provider\";\r\nimport { AppSyncResolverEvent } from \"aws-lambda\";\r\n\r\n/**\r\n * This lambda handles:\r\n *  - Query.meBestieStatus\r\n *  - Query.isEpisodeEarlyAccess\r\n *  - Mutation.claimBestieTrial\r\n *  - Mutation.adminSetBestie\r\n *  - Mutation.adminRevokeBestie\r\n *  - Mutation.adminSetBestieByEmail   (NEW)\r\n *  - Mutation.adminRevokeBestieByEmail(NEW)\r\n *\r\n * For demo purposes we store nothing and return computed objects.\r\n * Replace the stubs that say TODO with your DynamoDB writes when ready.\r\n */\r\n\r\nconst USER_POOL_ID = process.env.USER_POOL_ID as string;\r\nconst REGION = process.env.AWS_REGION || \"us-east-1\";\r\n\r\nconst cognito = new CognitoIdentityProviderClient({ region: REGION });\r\n\r\ntype Ctx = AppSyncResolverEvent<any>;\r\n\r\nfunction nowIso() {\r\n  return new Date().toISOString();\r\n}\r\n\r\nasync function meStatus(ctx: Ctx) {\r\n  // TODO: load real status from DynamoDB/user profile\r\n  return {\r\n    active: true,\r\n    since: nowIso(),\r\n    until: null,\r\n    source: \"TRIAL\", // or ADMIN/GRANT/etc.\r\n  };\r\n}\r\n\r\nasync function earlyAccess(_ctx: Ctx, id: string) {\r\n  // Simple rule: ep-1 is gated unless user is active Bestie\r\n  const allowed = id !== \"ep-1\" ? true : (await meStatus(_ctx)).active;\r\n  return { allowed, reason: allowed ? null : \"BESTIE_REQUIRED\" };\r\n}\r\n\r\nasync function claimTrial(ctx: Ctx) {\r\n  // TODO: write a trial grant tied to ctx.identity.sub\r\n  return {\r\n    active: true,\r\n    since: nowIso(),\r\n    until: null,\r\n    source: \"TRIAL\",\r\n  };\r\n}\r\n\r\nasync function setBestieBySub(_ctx: Ctx, userSub: string, active: boolean) {\r\n  // TODO: persist to single-table (pk=USER#sub, sk=BESTIE, active, since/until/source)\r\n  return {\r\n    active,\r\n    since: nowIso(),\r\n    until: null,\r\n    source: \"ADMIN\",\r\n  };\r\n}\r\n\r\nasync function findSubByEmail(email: string): Promise<string | null> {\r\n  // Use ListUsers with a filter on email (works with usernameAttributes=email)\r\n  const cmd = new ListUsersCommand({\r\n    UserPoolId: USER_POOL_ID,\r\n    Filter: `email = \\\"${email}\\\"`,\r\n    Limit: 1,\r\n  });\r\n  const res = await cognito.send(cmd);\r\n  const user = (res.Users || [])[0];\r\n  if (!user) return null;\r\n  const attr = (user.Attributes || []).find((a) => a.Name === \"sub\");\r\n  return attr?.Value || null;\r\n}\r\n\r\nexport const handler = async (ctx: Ctx) => {\r\n  const field = ctx.info.fieldName;\r\n\r\n  switch (field) {\r\n    /* ------------- Queries ------------- */\r\n    case \"meBestieStatus\":\r\n      return meStatus(ctx);\r\n\r\n    case \"isEpisodeEarlyAccess\": {\r\n      const id: string = ctx.arguments.id;\r\n      if (!id) throw new Error(\"Missing id\");\r\n      return earlyAccess(ctx, id);\r\n    }\r\n\r\n    /* ------------- Mutations ------------- */\r\n    case \"claimBestieTrial\":\r\n      return claimTrial(ctx);\r\n\r\n    case \"adminSetBestie\": {\r\n      const { userSub, active } = ctx.arguments as {\r\n        userSub: string;\r\n        active: boolean;\r\n      };\r\n      if (!userSub) throw new Error(\"Missing userSub\");\r\n      return setBestieBySub(ctx, userSub, !!active);\r\n    }\r\n\r\n    case \"adminRevokeBestie\": {\r\n      const { userSub } = ctx.arguments as { userSub: string };\r\n      if (!userSub) throw new Error(\"Missing userSub\");\r\n      return setBestieBySub(ctx, userSub, false);\r\n    }\r\n\r\n    // ------ NEW: by email convenience ------\r\n    case \"adminSetBestieByEmail\": {\r\n      const { email, active } = ctx.arguments as {\r\n        email: string;\r\n        active: boolean;\r\n      };\r\n      const sub = await findSubByEmail(email);\r\n      if (!sub) throw new Error(\"User does not exist.\");\r\n      return setBestieBySub(ctx, sub, !!active);\r\n    }\r\n\r\n    case \"adminRevokeBestieByEmail\": {\r\n      const { email } = ctx.arguments as { email: string };\r\n      const sub = await findSubByEmail(email);\r\n      if (!sub) throw new Error(\"User does not exist.\");\r\n      return setBestieBySub(ctx, sub, false);\r\n    }\r\n\r\n    default:\r\n      throw new Error(`Unknown field ${field}`);\r\n  }\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GACA,IAAAI,EAGO,qDAiBDC,EAAe,QAAQ,IAAI,aAC3BC,EAAS,QAAQ,IAAI,YAAc,YAEnCC,EAAU,IAAI,gCAA8B,CAAE,OAAQD,CAAO,CAAC,EAIpE,SAASE,GAAS,CAChB,OAAO,IAAI,KAAK,EAAE,YAAY,CAChC,CAEA,eAAeC,EAASC,EAAU,CAEhC,MAAO,CACL,OAAQ,GACR,MAAOF,EAAO,EACd,MAAO,KACP,OAAQ,OACV,CACF,CAEA,eAAeG,EAAYC,EAAWC,EAAY,CAEhD,IAAMC,EAAUD,IAAO,OAAS,IAAQ,MAAMJ,EAASG,CAAI,GAAG,OAC9D,MAAO,CAAE,QAAAE,EAAS,OAAQA,EAAU,KAAO,iBAAkB,CAC/D,CAEA,eAAeC,EAAWL,EAAU,CAElC,MAAO,CACL,OAAQ,GACR,MAAOF,EAAO,EACd,MAAO,KACP,OAAQ,OACV,CACF,CAEA,eAAeQ,EAAeJ,EAAWK,EAAiBC,EAAiB,CAEzE,MAAO,CACL,OAAAA,EACA,MAAOV,EAAO,EACd,MAAO,KACP,OAAQ,OACV,CACF,CAEA,eAAeW,EAAeC,EAAuC,CAEnE,IAAMC,EAAM,IAAI,mBAAiB,CAC/B,WAAYhB,EACZ,OAAQ,YAAae,CAAK,IAC1B,MAAO,CACT,CAAC,EAEKE,IADM,MAAMf,EAAQ,KAAKc,CAAG,GAChB,OAAS,CAAC,GAAG,CAAC,EAChC,OAAKC,IACSA,EAAK,YAAc,CAAC,GAAG,KAAMC,GAAMA,EAAE,OAAS,KAAK,GACpD,OAAS,IACxB,CAEO,IAAMrB,EAAU,MAAOQ,GAAa,CACzC,IAAMc,EAAQd,EAAI,KAAK,UAEvB,OAAQc,EAAO,CAEb,IAAK,iBACH,OAAOf,EAASC,CAAG,EAErB,IAAK,uBAAwB,CAC3B,IAAMG,EAAaH,EAAI,UAAU,GACjC,GAAI,CAACG,EAAI,MAAM,IAAI,MAAM,YAAY,EACrC,OAAOF,EAAYD,EAAKG,CAAE,CAC5B,CAGA,IAAK,mBACH,OAAOE,EAAWL,CAAG,EAEvB,IAAK,iBAAkB,CACrB,GAAM,CAAE,QAAAO,EAAS,OAAAC,CAAO,EAAIR,EAAI,UAIhC,GAAI,CAACO,EAAS,MAAM,IAAI,MAAM,iBAAiB,EAC/C,OAAOD,EAAeN,EAAKO,EAAS,CAAC,CAACC,CAAM,CAC9C,CAEA,IAAK,oBAAqB,CACxB,GAAM,CAAE,QAAAD,CAAQ,EAAIP,EAAI,UACxB,GAAI,CAACO,EAAS,MAAM,IAAI,MAAM,iBAAiB,EAC/C,OAAOD,EAAeN,EAAKO,EAAS,EAAK,CAC3C,CAGA,IAAK,wBAAyB,CAC5B,GAAM,CAAE,MAAAG,EAAO,OAAAF,CAAO,EAAIR,EAAI,UAIxBe,EAAM,MAAMN,EAAeC,CAAK,EACtC,GAAI,CAACK,EAAK,MAAM,IAAI,MAAM,sBAAsB,EAChD,OAAOT,EAAeN,EAAKe,EAAK,CAAC,CAACP,CAAM,CAC1C,CAEA,IAAK,2BAA4B,CAC/B,GAAM,CAAE,MAAAE,CAAM,EAAIV,EAAI,UAChBe,EAAM,MAAMN,EAAeC,CAAK,EACtC,GAAI,CAACK,EAAK,MAAM,IAAI,MAAM,sBAAsB,EAChD,OAAOT,EAAeN,EAAKe,EAAK,EAAK,CACvC,CAEA,QACE,MAAM,IAAI,MAAM,iBAAiBD,CAAK,EAAE,CAC5C,CACF",
  "names": ["bestie_exports", "__export", "handler", "__toCommonJS", "import_client_cognito_identity_provider", "USER_POOL_ID", "REGION", "cognito", "nowIso", "meStatus", "ctx", "earlyAccess", "_ctx", "id", "allowed", "claimTrial", "setBestieBySub", "userSub", "active", "findSubByEmail", "email", "cmd", "user", "a", "field", "sub"]
}
