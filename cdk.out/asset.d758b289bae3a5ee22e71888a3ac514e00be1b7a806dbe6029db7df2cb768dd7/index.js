"use strict";var S=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var x=(t,s)=>{for(var r in s)S(t,r,{get:s[r],enumerable:!0})},C=(t,s,r,e)=>{if(s&&typeof s=="object"||typeof s=="function")for(let o of N(s))!I.call(t,o)&&o!==r&&S(t,o,{get:()=>s[o],enumerable:!(e=k(s,o))||e.enumerable});return t};var K=t=>C(S({},"__esModule",{value:!0}),t);var D={};x(D,{handler:()=>R});module.exports=K(D);var a=require("@aws-sdk/client-dynamodb"),c=require("@aws-sdk/client-sfn"),E=require("crypto"),m=new a.DynamoDBClient({}),h=new c.SFNClient({}),{TABLE_NAME:u="",APPROVAL_SM_ARN:w=""}=process.env;if(!u)throw new Error("Missing env: TABLE_NAME");var n=t=>({S:t}),A=()=>new Date().toISOString();function p(t){let s=t?.identity?.claims||{},r=t?.identity?.sub||s?.sub,e=s?.["cognito:groups"],i=(Array.isArray(e)?e:String(e||"").split(",").map(d=>d.trim()).filter(Boolean)).includes("ADMIN");if(!r)throw new Error("Unauthorized");return{sub:r,isAdmin:i}}var l=async t=>{let{sub:s}=p(t);return((await m.send(new a.QueryCommand({TableName:u,IndexName:"gsi1",KeyConditionExpression:"gsi1pk = :p",ExpressionAttributeValues:{":p":n(`OWNER#${s}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, title, reason",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(e=>({id:e.id.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??""}))},g=async t=>{let{isAdmin:s}=p(t);if(!s)throw new Error("Forbidden");return((await m.send(new a.QueryCommand({TableName:u,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, title, reason",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(e=>({id:e.id.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??""}))},y=async t=>{let{sub:s}=p(t),r=t?.arguments||{},e=(0,E.randomUUID)(),o=A();return await m.send(new a.PutItemCommand({TableName:u,Item:{pk:n(`ITEM#${e}`),sk:n("META"),id:n(e),ownerSub:n(s),status:n("DRAFT"),title:n(r.title??""),mediaKey:n(r.mediaKey??""),createdAt:n(o),updatedAt:n(o),gsi1pk:n(`OWNER#${s}`),gsi1sk:n(o),gsi2pk:n("STATUS#DRAFT"),gsi2sk:n(o)},ConditionExpression:"attribute_not_exists(pk)"})),{id:e,ownerSub:s,status:"DRAFT",title:r.title??"",mediaKey:r.mediaKey??"",createdAt:o,updatedAt:o}},b=async t=>{let{sub:s,isAdmin:r}=p(t),e=t?.arguments?.id;if(!e)throw new Error("id required");let o=A();if(!r){let i=await m.send(new a.GetItemCommand({TableName:u,Key:{pk:n(`ITEM#${e}`),sk:n("META")},ProjectionExpression:"ownerSub"}));if(!i.Item?.ownerSub?.S)throw new Error("Not found");if(i.Item.ownerSub.S!==s)throw new Error("Not authorized")}if(await m.send(new a.UpdateItemCommand({TableName:u,Key:{pk:n(`ITEM#${e}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("PENDING"),":u":n(o),":g2pk":n("STATUS#PENDING"),":g2sk":n(o)}})),w)try{await h.send(new c.StartExecutionCommand({stateMachineArn:w,input:JSON.stringify({itemId:e,ownerSub:s}),name:`req-${e}-${Date.now()}`}))}catch{}return`requested:${e}`},f=async t=>{let{isAdmin:s}=p(t);if(!s)throw new Error("Forbidden");let r=t?.arguments?.id;if(!r)throw new Error("id required");let e=A(),i=(await m.send(new a.UpdateItemCommand({TableName:u,Key:{pk:n(`ITEM#${r}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("APPROVED"),":u":n(e),":g2pk":n("STATUS#APPROVED"),":g2sk":n(e)},ReturnValues:"ALL_NEW"}))).Attributes;return{id:i.id.S,ownerSub:i.ownerSub.S,status:i.status.S,createdAt:i.createdAt.S,updatedAt:i.updatedAt.S,mediaKey:i.mediaKey?.S??"",title:i.title?.S??"",reason:""}},T=async t=>{let{isAdmin:s}=p(t);if(!s)throw new Error("Forbidden");let r=t?.arguments?.id,e=t?.arguments?.reason??"";if(!r)throw new Error("id required");let o=A(),d=(await m.send(new a.UpdateItemCommand({TableName:u,Key:{pk:n(`ITEM#${r}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("REJECTED"),":u":n(o),":g2pk":n("STATUS#REJECTED"),":g2sk":n(o),":r":n(e)},ReturnValues:"ALL_NEW"}))).Attributes;return{id:d.id.S,ownerSub:d.ownerSub.S,status:d.status.S,createdAt:d.createdAt.S,updatedAt:d.updatedAt.S,mediaKey:d.mediaKey?.S??"",title:d.title?.S??"",reason:d.reason?.S??""}};var R=async t=>{let s=t.info.fieldName;if(s==="hello")return"Hello from Styling Adventures \u{1F44B}";if(s==="myCloset")return l(t);if(s==="adminListPending")return g(t);if(s==="createClosetItem")return y(t);if(s==="requestClosetApproval")return b(t);if(s==="adminApproveItem")return f(t);if(s==="adminRejectItem")return T(t);throw new Error(`Unknown field: ${s}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
