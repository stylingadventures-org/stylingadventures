{
  "version": 3,
  "sources": ["../../lambda/game/profile.ts", "../../lambda/_shared/env.ts"],
  "sourcesContent": ["// lambda/game/profile.ts\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport { DynamoDBDocumentClient, GetCommand, UpdateCommand } from \"@aws-sdk/lib-dynamodb\";\r\nimport { TABLE_NAME } from \"../_shared/env\";\r\n\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}));\r\n\r\nconst PK = (sub: string) => `USER#${sub}`;\r\nconst SK = \"PROFILE\";\r\n\r\ntype GameProfile = {\r\n  userId: string;\r\n  level: number;\r\n  xp: number;\r\n  coins: number;\r\n  badges?: string[];\r\n  displayName?: string | null;\r\n  avatarUrl?: string | null;\r\n  bio?: string | null;\r\n  lastEventAt?: number | null;\r\n  // streakCount / lastLoginAt exist in schema but are optional and may be absent here\r\n  streakCount?: number | null;\r\n  lastLoginAt?: number | null;\r\n};\r\n\r\nasync function getMyProfile(sub: string): Promise<GameProfile> {\r\n  const pk = PK(sub);\r\n\r\n  const { Item } = await ddb.send(\r\n    new GetCommand({ TableName: TABLE_NAME, Key: { pk, sk: SK } })\r\n  );\r\n\r\n  // If no item yet, seed it.\r\n  if (!Item) {\r\n    const now = Date.now();\r\n    await ddb.send(new UpdateCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: { pk, sk: SK },\r\n      UpdateExpression:\r\n        \"SET #uid=:uid, #lvl=:lvl, #xp=:xp, #coins=:coins, #badges=:badges, #ts=:ts\",\r\n      ExpressionAttributeNames: {\r\n        \"#uid\": \"userId\",\r\n        \"#lvl\": \"level\",\r\n        \"#xp\": \"xp\",\r\n        \"#coins\": \"coins\",\r\n        \"#badges\": \"badges\",\r\n        \"#ts\": \"lastEventAt\",\r\n      },\r\n      ExpressionAttributeValues: {\r\n        \":uid\": sub,\r\n        \":lvl\": 1,\r\n        \":xp\": 0,\r\n        \":coins\": 0,\r\n        \":badges\": [],\r\n        \":ts\": now,\r\n      },\r\n    }));\r\n    return {\r\n      userId: sub,\r\n      level: 1,\r\n      xp: 0,\r\n      coins: 0,\r\n      badges: [],\r\n      lastEventAt: now,\r\n    };\r\n  }\r\n\r\n  // Self-heal: if userId is missing on an old record, set it now.\r\n  if (!Item.userId) {\r\n    await ddb.send(new UpdateCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: { pk, sk: SK },\r\n      UpdateExpression: \"SET #uid = if_not_exists(#uid, :uid)\",\r\n      ExpressionAttributeNames: { \"#uid\": \"userId\" },\r\n      ExpressionAttributeValues: { \":uid\": sub },\r\n    }));\r\n  }\r\n\r\n  return {\r\n    // \u2190 never return null: fall back to sub\r\n    userId: (Item.userId as string) ?? sub,\r\n    level: Item.level ?? 1,\r\n    xp: Item.xp ?? 0,\r\n    coins: Item.coins ?? 0,\r\n    badges: Array.isArray(Item.badges) ? Item.badges : [],\r\n    displayName: Item.displayName ?? null,\r\n    avatarUrl: Item.avatarUrl ?? null,\r\n    bio: Item.bio ?? null,\r\n    lastEventAt: Item.lastEventAt ?? null,\r\n    streakCount: Item.streakCount ?? null,\r\n    lastLoginAt: Item.lastLoginAt ?? null,\r\n  };\r\n}\r\n\r\nasync function setDisplayName(sub: string, displayName: string): Promise<GameProfile> {\r\n  const pk = PK(sub);\r\n  const name = (displayName ?? \"\").trim().slice(0, 40);\r\n  const now = Date.now();\r\n\r\n  await ddb.send(new UpdateCommand({\r\n    TableName: TABLE_NAME,\r\n    Key: { pk, sk: SK },\r\n    UpdateExpression:\r\n      \"SET #dn=:dn, #ts=:ts ADD #lvl :zero, #xp :zero, #coins :zero\",\r\n    ExpressionAttributeNames: {\r\n      \"#dn\": \"displayName\",\r\n      \"#ts\": \"lastEventAt\",\r\n      \"#lvl\": \"level\",\r\n      \"#xp\": \"xp\",\r\n      \"#coins\": \"coins\",\r\n    },\r\n    ExpressionAttributeValues: {\r\n      \":dn\": name,\r\n      \":ts\": now,\r\n      \":zero\": 0,\r\n    },\r\n  }));\r\n\r\n  return getMyProfile(sub);\r\n}\r\n\r\ntype AppSyncEvent = {\r\n  info: { fieldName: string };\r\n  arguments: any;\r\n  identity?: { sub?: string };\r\n};\r\n\r\nexport const handler = async (event: AppSyncEvent) => {\r\n  const sub = event.identity?.sub;\r\n  if (!sub) throw new Error(\"Unauthorized: missing sub\");\r\n\r\n  switch (event.info.fieldName) {\r\n    case \"getMyProfile\":\r\n      return getMyProfile(sub);\r\n\r\n    case \"setDisplayName\":\r\n      return setDisplayName(sub, event.arguments.displayName);\r\n\r\n    // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n    // NEW: minimal, safe updates for profile patch\r\n    // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n    case \"updateProfile\": {\r\n      const { displayName, avatarUrl, bio } = event.arguments.input || {};\r\n      const pk = PK(sub);\r\n\r\n      const names: Record<string, string> = {};\r\n      const vals: Record<string, any> = {};\r\n      const sets: string[] = [];\r\n\r\n      if (typeof displayName === \"string\") {\r\n        names[\"#dn\"] = \"displayName\";\r\n        vals[\":dn\"] = displayName.trim().slice(0, 40);\r\n        sets.push(\"#dn = :dn\");\r\n      }\r\n      if (typeof avatarUrl === \"string\") {\r\n        names[\"#av\"] = \"avatarUrl\";\r\n        vals[\":av\"] = avatarUrl;\r\n        sets.push(\"#av = :av\");\r\n      }\r\n      if (typeof bio === \"string\") {\r\n        names[\"#bio\"] = \"bio\";\r\n        vals[\":bio\"] = bio.trim().slice(0, 280);\r\n        sets.push(\"#bio = :bio\");\r\n      }\r\n\r\n      names[\"#ts\"] = \"lastEventAt\";\r\n      vals[\":ts\"] = Date.now();\r\n      sets.push(\"#ts = :ts\");\r\n\r\n      if (!sets.length) return getMyProfile(sub);\r\n\r\n      await ddb.send(new UpdateCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: { pk, sk: SK },\r\n        UpdateExpression: `SET ${sets.join(\", \")}`,\r\n        ExpressionAttributeNames: names,\r\n        ExpressionAttributeValues: vals,\r\n      }));\r\n\r\n      return getMyProfile(sub);\r\n    }\r\n\r\n    default:\r\n      throw new Error(`Unknown field ${event.info.fieldName}`);\r\n  }\r\n};\r\n", "// lambda/_shared/env.ts\r\nexport const TABLE_NAME =\r\n  process.env.TABLE_NAME ??\r\n  process.env.APP_TABLE ??\r\n  process.env.TABLE ??\r\n  \"\";\r\n\r\nif (!TABLE_NAME) {\r\n  // Fail fast at cold start so you notice during deploy/tests\r\n  throw new Error(\r\n    \"Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).\"\r\n  );\r\n}\r\n"],
  "mappings": "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",
  "names": ["profile_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "TABLE_NAME", "ddb", "PK", "sub", "SK", "getMyProfile", "pk", "Item", "TABLE_NAME", "now", "setDisplayName", "displayName", "name", "handler", "event", "avatarUrl", "bio", "names", "vals", "sets"]
}
