{
  "version": 3,
  "sources": ["../../lambda/oauth/token-exchange/index.js"],
  "sourcesContent": ["const https = require('https');\r\nconst querystring = require('querystring');\r\n\r\nconst COGNITO_DOMAIN = process.env.COGNITO_DOMAIN; // e.g., https://sa-dev-637423256673.auth.us-east-1.amazoncognito.com\r\nconst CLIENT_ID = process.env.CLIENT_ID;\r\nconst CLIENT_SECRET = process.env.CLIENT_SECRET;\r\nconst REDIRECT_URI = process.env.REDIRECT_URI; // https://app.stylingadventures.com/callback\r\n\r\nexports.handler = async (event) => {\r\n  console.log('Token exchange request:', JSON.stringify(event, null, 2));\r\n\r\n  const corsHeaders = {\r\n    'Access-Control-Allow-Origin': '*',\r\n    'Access-Control-Allow-Methods': 'POST, OPTIONS',\r\n    'Access-Control-Allow-Headers': 'Content-Type',\r\n  };\r\n\r\n  try {\r\n    // Handle CORS preflight\r\n    if (event.httpMethod === 'OPTIONS') {\r\n      return {\r\n        statusCode: 200,\r\n        headers: corsHeaders,\r\n        body: '',\r\n      };\r\n    }\r\n\r\n    // Parse request body\r\n    const body = typeof event.body === 'string' ? JSON.parse(event.body) : event.body;\r\n    const { code } = body;\r\n\r\n    if (!code) {\r\n      return {\r\n        statusCode: 400,\r\n        headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ error: 'Missing authorization code' }),\r\n      };\r\n    }\r\n\r\n    // Exchange code for tokens\r\n    const tokenResponse = await exchangeCodeForTokens(code);\r\n\r\n    return {\r\n      statusCode: 200,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      body: JSON.stringify(tokenResponse),\r\n    };\r\n  } catch (error) {\r\n    console.error('Token exchange error:', error);\r\n    return {\r\n      statusCode: 400,\r\n      headers: { ...corsHeaders, 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ \r\n        error: 'Token exchange failed',\r\n        message: error.message,\r\n      }),\r\n    };\r\n  }\r\n};\r\n\r\nfunction exchangeCodeForTokens(code) {\r\n  return new Promise((resolve, reject) => {\r\n    const tokenUrl = new URL(COGNITO_DOMAIN);\r\n    const path = '/oauth2/token';\r\n\r\n    const postData = querystring.stringify({\r\n      grant_type: 'authorization_code',\r\n      client_id: CLIENT_ID,\r\n      client_secret: CLIENT_SECRET,\r\n      code: code,\r\n      redirect_uri: REDIRECT_URI,\r\n    });\r\n\r\n    const options = {\r\n      hostname: tokenUrl.hostname,\r\n      port: 443,\r\n      path: path,\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/x-www-form-urlencoded',\r\n        'Content-Length': Buffer.byteLength(postData),\r\n      },\r\n    };\r\n\r\n    const req = https.request(options, (res) => {\r\n      let data = '';\r\n\r\n      res.on('data', (chunk) => {\r\n        data += chunk;\r\n      });\r\n\r\n      res.on('end', () => {\r\n        try {\r\n          if (res.statusCode >= 200 && res.statusCode < 300) {\r\n            const tokenData = JSON.parse(data);\r\n            resolve(tokenData);\r\n          } else {\r\n            reject(new Error(`Cognito returned ${res.statusCode}: ${data}`));\r\n          }\r\n        } catch (error) {\r\n          reject(new Error(`Failed to parse response: ${error.message}`));\r\n        }\r\n      });\r\n    });\r\n\r\n    req.on('error', reject);\r\n    req.write(postData);\r\n    req.end();\r\n  });\r\n}\r\n"],
  "mappings": ";;;AAAA,IAAM,QAAQ,QAAQ,OAAO;AAC7B,IAAM,cAAc,QAAQ,aAAa;AAEzC,IAAM,iBAAiB,QAAQ,IAAI;AACnC,IAAM,YAAY,QAAQ,IAAI;AAC9B,IAAM,gBAAgB,QAAQ,IAAI;AAClC,IAAM,eAAe,QAAQ,IAAI;AAEjC,QAAQ,UAAU,OAAO,UAAU;AACjC,UAAQ,IAAI,2BAA2B,KAAK,UAAU,OAAO,MAAM,CAAC,CAAC;AAErE,QAAM,cAAc;AAAA,IAClB,+BAA+B;AAAA,IAC/B,gCAAgC;AAAA,IAChC,gCAAgC;AAAA,EAClC;AAEA,MAAI;AAEF,QAAI,MAAM,eAAe,WAAW;AAClC,aAAO;AAAA,QACL,YAAY;AAAA,QACZ,SAAS;AAAA,QACT,MAAM;AAAA,MACR;AAAA,IACF;AAGA,UAAM,OAAO,OAAO,MAAM,SAAS,WAAW,KAAK,MAAM,MAAM,IAAI,IAAI,MAAM;AAC7E,UAAM,EAAE,KAAK,IAAI;AAEjB,QAAI,CAAC,MAAM;AACT,aAAO;AAAA,QACL,YAAY;AAAA,QACZ,SAAS,EAAE,GAAG,aAAa,gBAAgB,mBAAmB;AAAA,QAC9D,MAAM,KAAK,UAAU,EAAE,OAAO,6BAA6B,CAAC;AAAA,MAC9D;AAAA,IACF;AAGA,UAAM,gBAAgB,MAAM,sBAAsB,IAAI;AAEtD,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,SAAS,EAAE,GAAG,aAAa,gBAAgB,mBAAmB;AAAA,MAC9D,MAAM,KAAK,UAAU,aAAa;AAAA,IACpC;AAAA,EACF,SAAS,OAAO;AACd,YAAQ,MAAM,yBAAyB,KAAK;AAC5C,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,SAAS,EAAE,GAAG,aAAa,gBAAgB,mBAAmB;AAAA,MAC9D,MAAM,KAAK,UAAU;AAAA,QACnB,OAAO;AAAA,QACP,SAAS,MAAM;AAAA,MACjB,CAAC;AAAA,IACH;AAAA,EACF;AACF;AAEA,SAAS,sBAAsB,MAAM;AACnC,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,UAAM,WAAW,IAAI,IAAI,cAAc;AACvC,UAAM,OAAO;AAEb,UAAM,WAAW,YAAY,UAAU;AAAA,MACrC,YAAY;AAAA,MACZ,WAAW;AAAA,MACX,eAAe;AAAA,MACf;AAAA,MACA,cAAc;AAAA,IAChB,CAAC;AAED,UAAM,UAAU;AAAA,MACd,UAAU,SAAS;AAAA,MACnB,MAAM;AAAA,MACN;AAAA,MACA,QAAQ;AAAA,MACR,SAAS;AAAA,QACP,gBAAgB;AAAA,QAChB,kBAAkB,OAAO,WAAW,QAAQ;AAAA,MAC9C;AAAA,IACF;AAEA,UAAM,MAAM,MAAM,QAAQ,SAAS,CAAC,QAAQ;AAC1C,UAAI,OAAO;AAEX,UAAI,GAAG,QAAQ,CAAC,UAAU;AACxB,gBAAQ;AAAA,MACV,CAAC;AAED,UAAI,GAAG,OAAO,MAAM;AAClB,YAAI;AACF,cAAI,IAAI,cAAc,OAAO,IAAI,aAAa,KAAK;AACjD,kBAAM,YAAY,KAAK,MAAM,IAAI;AACjC,oBAAQ,SAAS;AAAA,UACnB,OAAO;AACL,mBAAO,IAAI,MAAM,oBAAoB,IAAI,UAAU,KAAK,IAAI,EAAE,CAAC;AAAA,UACjE;AAAA,QACF,SAAS,OAAO;AACd,iBAAO,IAAI,MAAM,6BAA6B,MAAM,OAAO,EAAE,CAAC;AAAA,QAChE;AAAA,MACF,CAAC;AAAA,IACH,CAAC;AAED,QAAI,GAAG,SAAS,MAAM;AACtB,QAAI,MAAM,QAAQ;AAClB,QAAI,IAAI;AAAA,EACV,CAAC;AACH;",
  "names": []
}
