"use strict";var L=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var k=Object.prototype.hasOwnProperty;var D=(e,s)=>{for(var a in s)L(e,a,{get:s[a],enumerable:!0})},S=(e,s,a,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let n of R(s))!k.call(e,n)&&n!==a&&L(e,n,{get:()=>s[n],enumerable:!(t=U(s,n))||t.enumerable});return e};var C=e=>S(L({},"__esModule",{value:!0}),e);var B={};D(B,{handler:()=>P});module.exports=C(B);var T=require("@aws-sdk/client-dynamodb"),i=require("@aws-sdk/lib-dynamodb");var o=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!o)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var u=i.DynamoDBDocumentClient.from(new T.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}});function _(e){let s=e?.groups;return Array.isArray(s)&&s.includes("ADMIN")}function h(e,s){if(!s?.sub)throw new Error("Unauthenticated");if(!_(s)&&s.sub!==e)throw new Error("Forbidden")}function v(e){if(e==null)return null;if(typeof e=="string")try{return JSON.parse(e)}catch{return{raw:e}}return typeof e=="object"?e:{value:e}}function g(e){let s=1,a=100,t=e;for(;t>=a;)t-=a,s++,a+=50;return s}function f(e,s=12){return Math.max(0,e|0).toString().padStart(s,"0")}function O(e,s){if(!e||!s)return!1;let a=new Date(e),t=new Date(s);return a.getUTCFullYear()===t.getUTCFullYear()&&a.getUTCMonth()===t.getUTCMonth()&&a.getUTCDate()===t.getUTCDate()}function M(e,s){let a=new Date(e),t=new Date(s),n=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()-1));return a.getUTCFullYear()===n.getUTCFullYear()&&a.getUTCMonth()===n.getUTCMonth()&&a.getUTCDate()===n.getUTCDate()}var P=async e=>{let{fieldName:s}=e.info,a=e.identity;if(s==="getMyProfile"){if(!a?.sub)throw new Error("Unauthenticated");let t=a.sub,n=await u.send(new i.GetCommand({TableName:o,Key:{pk:`USER#${t}`,sk:"PROFILE"}})),l=Number(n.Item?.xp??0);return{userId:t,displayName:n.Item?.displayName||null,level:g(l),xp:l,coins:Number(n.Item?.coins??0),badges:Array.isArray(n.Item?.badges)?n.Item.badges:[],lastEventAt:n.Item?.lastEventAt??null}}if(s==="setDisplayName"){if(!a?.sub)throw new Error("Unauthenticated");let t=a.sub,l=(e.arguments?.displayName||"").trim().slice(0,40),r=await u.send(new i.UpdateCommand({TableName:o,Key:{pk:`USER#${t}`,sk:"PROFILE"},UpdateExpression:"SET displayName = :n, updatedAt = :u, xp = if_not_exists(xp,:z), coins = if_not_exists(coins,:z)",ExpressionAttributeValues:{":n":l,":u":new Date().toISOString(),":z":0},ReturnValues:"ALL_NEW"})),p=Number(r.Attributes?.xp??0);return{userId:t,displayName:r.Attributes?.displayName||null,level:g(p),xp:p,coins:Number(r.Attributes?.coins??0),badges:Array.isArray(r.Attributes?.badges)?r.Attributes.badges:[],lastEventAt:r.Attributes?.lastEventAt??null}}if(s==="logGameEvent"){if(!a?.sub)throw new Error("Unauthenticated");let t=a.sub,n=new Date().toISOString(),l=e.arguments?.input??{},r=l.type||"UNKNOWN",p=v(l.metadata);if(r==="DAILY_LOGIN"){let I=await u.send(new i.GetCommand({TableName:o,Key:{pk:`USER#${t}`,sk:"PROFILE"},ProjectionExpression:"lastLoginAt, streakCount, xp, coins, badges, displayName, lastEventAt"})),y=I.Item?.lastLoginAt,m=Number(I.Item?.streakCount??0),N=1,w=0;y&&O(y,n)?(N=0,w=0):y&&M(y,n)?m+=1:m=1,N=m>0?10+Math.min(5,m):0,w=m>0?1:0;let E=await u.send(new i.UpdateCommand({TableName:o,Key:{pk:`USER#${t}`,sk:"PROFILE"},UpdateExpression:`
          SET xp = if_not_exists(xp,:z) + :xi,
              coins = if_not_exists(coins,:z) + :ci,
              lastEventAt = :now,
              lastLoginAt = :now,
              streakCount = :st
        `.replace(/\s+/g," "),ExpressionAttributeValues:{":z":0,":xi":N,":ci":w,":now":n,":st":m},ReturnValues:"ALL_NEW"})),x=Number(E.Attributes?.xp??0);return await u.send(new i.PutCommand({TableName:o,Item:{pk:`USER#${t}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${f(x)}#${t}`,xp:x,coins:Number(E.Attributes?.coins??0),streakCount:m,updatedAt:n,type:"LEADER"}})),{userId:t,displayName:E.Attributes?.displayName||null,level:g(x),xp:x,coins:Number(E.Attributes?.coins??0),badges:Array.isArray(E.Attributes?.badges)?E.Attributes.badges:[],lastEventAt:E.Attributes?.lastEventAt??n,lastLoginAt:n,streakCount:m}}let c=r==="LEVEL_CLEAR"?50:r==="SHARE"?5:r==="STYLE_IT"?Math.max(1,Math.round((p?.score??5)/5)):1,A=r==="LEVEL_CLEAR"?5:0,d=await u.send(new i.UpdateCommand({TableName:o,Key:{pk:`USER#${t}`,sk:"PROFILE"},UpdateExpression:`
        SET xp = if_not_exists(xp,:z) + :xi,
            coins = if_not_exists(coins,:z) + :ci,
            lastEventAt = :now
      `.replace(/\s+/g," "),ExpressionAttributeValues:{":z":0,":xi":c,":ci":A,":now":n},ReturnValues:"ALL_NEW"})),b=Number(d.Attributes?.xp??0);return await u.send(new i.PutCommand({TableName:o,Item:{pk:`USER#${t}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${f(b)}#${t}`,xp:b,coins:Number(d.Attributes?.coins??0),updatedAt:n,type:"LEADER"}})),await u.send(new i.PutCommand({TableName:o,Item:{pk:`USER#${t}`,sk:`EVENT#${Date.now()}`,type:"EVENT",evType:r,metadata:p,at:n},ConditionExpression:"attribute_not_exists(pk)"})).catch(()=>{}),{userId:t,displayName:d.Attributes?.displayName||null,level:g(b),xp:b,coins:Number(d.Attributes?.coins??0),badges:Array.isArray(d.Attributes?.badges)?d.Attributes.badges:[],lastEventAt:d.Attributes?.lastEventAt??n}}if(s==="awardCoins"){let{userId:t,coins:n,xp:l}=e.arguments.input;h(t,a);let r=Math.max(0,n|0),p=Math.max(0,(l??0)|0),c=await u.send(new i.UpdateCommand({TableName:o,Key:{pk:`USER#${t}`,sk:"PROFILE"},UpdateExpression:"SET coins = if_not_exists(coins,:z) + :c, xp = if_not_exists(xp,:z) + :x",ExpressionAttributeValues:{":z":0,":c":r,":x":p},ReturnValues:"ALL_NEW"})),A=Number(c.Attributes?.xp??0);return await u.send(new i.PutCommand({TableName:o,Item:{pk:`USER#${t}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${f(A)}#${t}`,xp:A,coins:Number(c.Attributes?.coins??0),updatedAt:new Date().toISOString(),type:"LEADER"}})),{userId:t,displayName:c.Attributes?.displayName||null,level:g(A),xp:A,coins:Number(c.Attributes?.coins??0),badges:Array.isArray(c.Attributes?.badges)?c.Attributes.badges:[],lastEventAt:c.Attributes?.lastEventAt??null}}if(s==="topXP"){let t=Math.max(1,Math.min(100,Number(e.arguments?.limit??10))),l=(await u.send(new i.QueryCommand({TableName:o,IndexName:"gsi1",KeyConditionExpression:"gsi1pk = :p",ExpressionAttributeValues:{":p":"LEADERBOARD#GLOBAL"},ScanIndexForward:!1,Limit:t}))).Items??[];return await Promise.all(l.map(async(p,c)=>{let A=p.pk.replace("USER#",""),d;try{d=(await u.send(new i.GetCommand({TableName:o,Key:{pk:`USER#${A}`,sk:"PROFILE"},ProjectionExpression:"displayName"}))).Item?.displayName}catch{}return{userId:A,displayName:d,xp:Number(p.xp??0),coins:Number(p.coins??0),rank:c+1}}))}throw new Error(`Unknown field ${s}`)};0&&(module.exports={handler});
