"use strict";var h=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var N=(e,t)=>{for(var n in t)h(e,n,{get:t[n],enumerable:!0})},L=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of G(t))!B.call(e,s)&&s!==n&&h(e,s,{get:()=>t[s],enumerable:!(r=R(t,s))||r.enumerable});return e};var M=e=>L(h({},"__esModule",{value:!0}),e);var j={};N(j,{handler:()=>$});module.exports=M(j);var a=require("@aws-sdk/client-s3"),f=require("@aws-sdk/s3-request-presigner"),p=new a.S3Client({region:process.env.AWS_REGION||"us-east-1",forcePathStyle:!0}),d=process.env.BUCKET,P=String(process.env.ALLOWED_ORIGINS||"").split(",").map(e=>e.trim().replace(/\/+$/,"")).filter(Boolean),w=(process.env.WEB_ORIGIN||"").replace(/\/+$/,""),_=["authorization","Authorization","Content-Type","X-Amz-Date","X-Api-Key","X-Amz-Security-Token"].join(","),K=process.env.STAGE==="prod"||process.env.NODE_ENV==="production"||process.env.ENV==="prod";function O(e){return String(e?.headers?.origin||e?.headers?.Origin||"").replace(/\/+$/,"")}function A(e){let t=O(e);if(t){if(P.length>0)return P.includes(t)?t:void 0;if(w)return t===w?t:void 0;if(!K)return t}}function g(e){let t={"Content-Type":"application/json","Access-Control-Allow-Headers":_,"Access-Control-Allow-Methods":"GET,POST,DELETE,OPTIONS","Access-Control-Allow-Credentials":"true","Access-Control-Expose-Headers":"ETag,Content-Type,Content-Length,Last-Modified,Accept-Ranges",Vary:"Origin, Access-Control-Request-Headers, Access-Control-Request-Method"};return e&&(t["Access-Control-Allow-Origin"]=e),t}function E(e,t,n={}){let r=A(e);return{statusCode:200,headers:{...g(r),"Cache-Control":"no-store",...n},body:JSON.stringify(t)}}function U(e){let t=A(e);return{statusCode:204,headers:g(t),body:""}}function u(e,t,n){let r=A(e);return!!O(e)&&!r?{statusCode:403,headers:g(void 0),body:JSON.stringify({message:"CORS: origin not allowed"})}:{statusCode:t,headers:g(r),body:JSON.stringify({message:n})}}var D=e=>e.httpMethod??e.requestContext?.http?.method??"GET",q=e=>e.requestContext?.authorizer?.claims??e.requestContext?.authorizer?.jwt?.claims??{},z=e=>{let t=e.body??"";if(!t)return{};let n=e.isBase64Encoded&&typeof t=="string"?Buffer.from(t,"base64").toString():t;try{return typeof n=="string"?JSON.parse(n):n}catch{return{}}};function C(e,t){let n=String(t||"").replace(/\.\./g,"").replace(/^[/\\]+/,""),r=n.startsWith(`users/${e}/`),s=/^users\/[^/]+\//.test(n)&&!r;return r?n:`users/${e}/${s?n.replace(/^users\/[^/]+\//,""):n}`}function W(e){let t=e?.["cognito:groups"];return Array.isArray(t)?t:typeof t=="string"?t.split(",").map(n=>n.trim()).filter(Boolean):[]}var $=async e=>{let t=D(e);if(t==="OPTIONS")return!A(e)&&O(e)?{statusCode:403,headers:g(void 0),body:""}:U(e);try{let n=q(e),r=n?.sub||"";if(!r)return u(e,401,"Not authorized");let s=W(n),I=Number(process.env.BASE_UPLOAD_LIMIT_MB||"50"),b=Number(process.env.BESTIE_UPLOAD_LIMIT_MB||"200"),m=s.includes("BESTIE")?b:I;if(t==="POST"){let o=z(e),i=String(o.key||""),y=String(o.contentType||"application/octet-stream");if(!i)return u(e,400,"Missing 'key'");let l=Number(o.contentLength||0);if(l>0&&l>m*1024*1024)return u(e,413,`Max upload ${m} MB for your tier`);let c=C(r,i),T=new a.PutObjectCommand({Bucket:d,Key:c,ContentType:y}),k=new a.GetObjectCommand({Bucket:d,Key:c}),S=await(0,f.getSignedUrl)(p,T,{expiresIn:900}),x=await(0,f.getSignedUrl)(p,k,{expiresIn:300});return E(e,{bucket:d,key:c,method:"PUT",url:S,headers:{"Content-Type":y},putUrl:S,getUrl:x,maxBytesAllowed:m*1024*1024})}if(t==="GET"){let o=String(e?.queryStringParameters?.key??e.pathParameters?.key??"");if(!o)return u(e,400,"Missing 'key'");let i=String(o||"").replace(/\.\./g,"").replace(/^[/\\]+/,""),y=i;/^users\/[^/]+\//.test(i)||(y=C(r,i));let l=new a.GetObjectCommand({Bucket:d,Key:y}),c=await(0,f.getSignedUrl)(p,l,{expiresIn:300});return E(e,{bucket:d,key:y,getUrl:c,url:c,publicUrl:c})}if(t==="DELETE"){let o=String(e?.queryStringParameters?.key??e.pathParameters?.key??"");if(!o)return u(e,400,"Missing 'key'");let i=C(r,o);return await p.send(new a.DeleteObjectCommand({Bucket:d,Key:i})),E(e,{deleted:!0,key:i})}return u(e,405,"Method Not Allowed")}catch(n){return console.error(n),u(e,500,n?.message??String(n))}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
