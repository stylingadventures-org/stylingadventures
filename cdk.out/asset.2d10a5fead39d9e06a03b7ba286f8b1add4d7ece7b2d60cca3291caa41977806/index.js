"use strict";var m=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var g=Object.prototype.hasOwnProperty;var T=(t,n)=>{for(var e in n)m(t,e,{get:n[e],enumerable:!0})},v=(t,n,e,r)=>{if(n&&typeof n=="object"||typeof n=="function")for(let o of E(n))!g.call(t,o)&&o!==e&&m(t,o,{get:()=>n[o],enumerable:!(r=w(n,o))||r.enumerable});return t};var I=t=>v(m({},"__esModule",{value:!0}),t);var B={};T(B,{handler:()=>k});module.exports=I(B);var y=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb"),l=require("@aws-sdk/client-eventbridge"),p=require("@aws-sdk/client-sns"),f=a.DynamoDBDocumentClient.from(new y.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),O=new l.EventBridgeClient({}),D=new p.SNSClient({}),_=process.env.TABLE_NAME,P=process.env.AUDIT_TABLE_NAME,b=process.env.PK_NAME||"pk",C=process.env.SK_NAME||"sk",N=process.env.NOTIFY_TOPIC_ARN;function A(t){if(typeof t!="string")return t;try{return JSON.parse(t)}catch{return t}}async function h(t,n){try{await O.send(new l.PutEventsCommand({Entries:[{Source:"stylingadventures.closet",DetailType:t,Detail:JSON.stringify(n)}]}))}catch(e){console.warn("[dlq] EventBridge put failed:",e)}}async function K(t,n,e){if(N)try{await D.send(new p.PublishCommand({TopicArn:N,Subject:t,Message:`${n}

${JSON.stringify(e,null,2)}`}))}catch(r){console.warn("[dlq] SNS publish failed:",r)}}async function M(t,n,e){let r=new Date;try{await f.send(new a.PutCommand({TableName:P,Item:{pk:`APPROVAL#${n}`,sk:`TS#${r.toISOString()}`,action:t,approvalId:n,at:r.toISOString(),detail:e}}))}catch(o){console.warn("[dlq] audit write failed:",o)}}function U(t){let n=A(t?.input),e=n?.approvalId||n?.item?.id||n?.itemId||n?.id||t?.approvalId||t?.item?.id;return e?String(e):"UNKNOWN"}var k=async t=>{let n=t.Records??[];console.log("[dlq] records:",n.length);for(let e of n){let r=e?.body,o=A(r),d=o?.detail??o,s=d?.status,i=d?.executionArn,c=U(d);if(await M("STEPFN_DLQ",c,{status:s,executionArn:i,detail:d}),await h("ClosetApprovalDeadLetter",{approvalId:c,status:s,executionArn:i}),await K("Closet approval dead-letter",`Step Functions execution entered DLQ state: ${s??"UNKNOWN"}`,{approvalId:c,status:s,executionArn:i}),c!=="UNKNOWN")try{let u=`ITEM#${c}`,S="META";await f.send(new a.UpdateCommand({TableName:_,Key:{[b]:u,[C]:S},UpdateExpression:"SET lastError = :e, updatedAt = :t",ExpressionAttributeValues:{":e":`StepFn execution ${s??"UNKNOWN"} (${i??"no-arn"})`,":t":new Date().toISOString()}}))}catch(u){console.warn("[dlq] failed to mark item error",u)}else console.warn("[dlq] could not determine approvalId",{status:s,executionArn:i})}return{ok:!0}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
