"use strict";var m=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var O=(e,t)=>{for(var n in t)m(e,n,{get:t[n],enumerable:!0})},w=(e,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of P(t))!I.call(e,s)&&s!==n&&m(e,s,{get:()=>t[s],enumerable:!(i=k(t,s))||i.enumerable});return e};var S=e=>w(m({},"__esModule",{value:!0}),e);var g={};O(g,{handler:()=>b});module.exports=S(g);var r=require("@aws-sdk/client-sfn"),T=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb"),E=new r.SFNClient({}),l=a.DynamoDBDocumentClient.from(new T.DynamoDBClient({})),y=process.env.TABLE_NAME,A=process.env.PK_NAME||"pk",f=process.env.SK_NAME||"sk";function o(e,t){return{statusCode:e,headers:{"content-type":"application/json","access-control-allow-origin":"*","access-control-allow-methods":"OPTIONS,POST","access-control-allow-headers":"*"},body:JSON.stringify(t)}}var b=async e=>{if((e?.requestContext?.http?.method||e?.requestContext?.httpMethod)==="OPTIONS")return o(200,{ok:!0});try{let n=typeof e.body=="string"?JSON.parse(e.body):e.body??{},i=n.approvalId,s=n.decision;if(!i||!s)return o(400,{message:"Missing approvalId or decision"});if(s!=="APPROVE"&&s!=="REJECT")return o(400,{message:"decision must be APPROVE or REJECT"});let p=`ITEM#${i}`,u="META",d=await l.send(new a.GetCommand({TableName:y,Key:{[A]:p,[f]:u}}));if(!d.Item)return o(404,{message:"Item not found"});if(d.Item.status!=="PENDING")return o(409,{message:`Already ${d.Item.status}`});let c=d.Item.taskToken||d.Item.approvalToken;if(!c)return o(409,{message:"No taskToken on item. NotifyAdminFn did not store it yet (or record is malformed)."});let N=new Date().toISOString();return s==="APPROVE"?await E.send(new r.SendTaskSuccessCommand({taskToken:c,output:JSON.stringify({decision:"APPROVE",reason:"Approved by admin UI"})})):await E.send(new r.SendTaskFailureCommand({taskToken:c,error:"RejectedByAdmin",cause:"Rejected by admin UI"})),await l.send(new a.UpdateCommand({TableName:y,Key:{[A]:p,[f]:u},UpdateExpression:"SET #status = :s, decidedAt = :t, updatedAt = :t REMOVE taskToken, approvalToken",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":s":s==="APPROVE"?"APPROVED":"REJECTED",":t":N}})),o(200,{ok:!0})}catch(n){return console.error(n),o(500,{message:"Internal error"})}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
