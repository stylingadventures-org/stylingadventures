{
  "version": 3,
  "sources": ["../../lambda/admin/approve-closet-upload.ts"],
  "sourcesContent": ["import {\r\n  SFNClient,\r\n  SendTaskFailureCommand,\r\n  SendTaskSuccessCommand,\r\n} from \"@aws-sdk/client-sfn\";\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  GetCommand,\r\n  UpdateCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\n\r\nconst sfn = new SFNClient({});\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}));\r\n\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\nconst PK_NAME = process.env.PK_NAME || \"pk\";\r\nconst SK_NAME = process.env.SK_NAME || \"sk\";\r\n\r\nfunction response(statusCode: number, body: any) {\r\n  return {\r\n    statusCode,\r\n    headers: {\r\n      \"content-type\": \"application/json\",\r\n      \"access-control-allow-origin\": \"*\",\r\n      \"access-control-allow-methods\": \"OPTIONS,POST\",\r\n      \"access-control-allow-headers\": \"*\",\r\n    },\r\n    body: JSON.stringify(body),\r\n  };\r\n}\r\n\r\nexport const handler = async (event: any) => {\r\n  // CORS preflight\r\n  const method =\r\n    event?.requestContext?.http?.method || event?.requestContext?.httpMethod;\r\n  if (method === \"OPTIONS\") return response(200, { ok: true });\r\n\r\n  try {\r\n    const body =\r\n      typeof event.body === \"string\" ? JSON.parse(event.body) : (event.body ?? {});\r\n\r\n    const approvalId = body.approvalId;\r\n    const decision = body.decision;\r\n\r\n    if (!approvalId || !decision) {\r\n      return response(400, { message: \"Missing approvalId or decision\" });\r\n    }\r\n    if (decision !== \"APPROVE\" && decision !== \"REJECT\") {\r\n      return response(400, { message: \"decision must be APPROVE or REJECT\" });\r\n    }\r\n\r\n    const pk = `ITEM#${approvalId}`;\r\n    const sk = \"META\";\r\n\r\n    const res = await ddb.send(\r\n      new GetCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: { [PK_NAME]: pk, [SK_NAME]: sk },\r\n      }),\r\n    );\r\n\r\n    if (!res.Item) {\r\n      return response(404, { message: \"Item not found\" });\r\n    }\r\n\r\n    if (res.Item.status !== \"PENDING\") {\r\n      return response(409, { message: `Already ${res.Item.status}` });\r\n    }\r\n\r\n    // Prefer taskToken; fallback to legacy approvalToken if it exists\r\n    const taskToken =\r\n      (res.Item.taskToken as string | undefined) ||\r\n      (res.Item.approvalToken as string | undefined);\r\n\r\n    if (!taskToken) {\r\n      return response(409, {\r\n        message:\r\n          \"No taskToken on item. NotifyAdminFn did not store it yet (or record is malformed).\",\r\n      });\r\n    }\r\n\r\n    const now = new Date().toISOString();\r\n\r\n    if (decision === \"APPROVE\") {\r\n      await sfn.send(\r\n        new SendTaskSuccessCommand({\r\n          taskToken,\r\n          output: JSON.stringify({\r\n            decision: \"APPROVE\",\r\n            reason: \"Approved by admin UI\",\r\n          }),\r\n        }),\r\n      );\r\n    } else {\r\n      // REJECT: Fail the task so the StepFn goes into the Reject fail state cleanly\r\n      await sfn.send(\r\n        new SendTaskFailureCommand({\r\n          taskToken,\r\n          error: \"RejectedByAdmin\",\r\n          cause: \"Rejected by admin UI\",\r\n        }),\r\n      );\r\n    }\r\n\r\n    await ddb.send(\r\n      new UpdateCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: { [PK_NAME]: pk, [SK_NAME]: sk },\r\n        UpdateExpression:\r\n          \"SET #status = :s, decidedAt = :t, updatedAt = :t REMOVE taskToken, approvalToken\",\r\n        ExpressionAttributeNames: { \"#status\": \"status\" },\r\n        ExpressionAttributeValues: {\r\n          \":s\": decision === \"APPROVE\" ? \"APPROVED\" : \"REJECTED\",\r\n          \":t\": now,\r\n        },\r\n      }),\r\n    );\r\n\r\n    return response(200, { ok: true });\r\n  } catch (err) {\r\n    console.error(err);\r\n    return response(500, { message: \"Internal error\" });\r\n  }\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAAA,IAAAI,EAIO,+BACPC,EAA+B,oCAC/BC,EAIO,iCAEDC,EAAM,IAAI,YAAU,CAAC,CAAC,EACtBC,EAAM,yBAAuB,KAAK,IAAI,iBAAe,CAAC,CAAC,CAAC,EAExDC,EAAa,QAAQ,IAAI,WACzBC,EAAU,QAAQ,IAAI,SAAW,KACjCC,EAAU,QAAQ,IAAI,SAAW,KAEvC,SAASC,EAASC,EAAoBC,EAAW,CAC/C,MAAO,CACL,WAAAD,EACA,QAAS,CACP,eAAgB,mBAChB,8BAA+B,IAC/B,+BAAgC,eAChC,+BAAgC,GAClC,EACA,KAAM,KAAK,UAAUC,CAAI,CAC3B,CACF,CAEO,IAAMZ,EAAU,MAAOa,GAAe,CAI3C,IADEA,GAAO,gBAAgB,MAAM,QAAUA,GAAO,gBAAgB,cACjD,UAAW,OAAOH,EAAS,IAAK,CAAE,GAAI,EAAK,CAAC,EAE3D,GAAI,CACF,IAAME,EACJ,OAAOC,EAAM,MAAS,SAAW,KAAK,MAAMA,EAAM,IAAI,EAAKA,EAAM,MAAQ,CAAC,EAEtEC,EAAaF,EAAK,WAClBG,EAAWH,EAAK,SAEtB,GAAI,CAACE,GAAc,CAACC,EAClB,OAAOL,EAAS,IAAK,CAAE,QAAS,gCAAiC,CAAC,EAEpE,GAAIK,IAAa,WAAaA,IAAa,SACzC,OAAOL,EAAS,IAAK,CAAE,QAAS,oCAAqC,CAAC,EAGxE,IAAMM,EAAK,QAAQF,CAAU,GACvBG,EAAK,OAELC,EAAM,MAAMZ,EAAI,KACpB,IAAI,aAAW,CACb,UAAWC,EACX,IAAK,CAAE,CAACC,CAAO,EAAGQ,EAAI,CAACP,CAAO,EAAGQ,CAAG,CACtC,CAAC,CACH,EAEA,GAAI,CAACC,EAAI,KACP,OAAOR,EAAS,IAAK,CAAE,QAAS,gBAAiB,CAAC,EAGpD,GAAIQ,EAAI,KAAK,SAAW,UACtB,OAAOR,EAAS,IAAK,CAAE,QAAS,WAAWQ,EAAI,KAAK,MAAM,EAAG,CAAC,EAIhE,IAAMC,EACHD,EAAI,KAAK,WACTA,EAAI,KAAK,cAEZ,GAAI,CAACC,EACH,OAAOT,EAAS,IAAK,CACnB,QACE,oFACJ,CAAC,EAGH,IAAMU,EAAM,IAAI,KAAK,EAAE,YAAY,EAEnC,OAAIL,IAAa,UACf,MAAMV,EAAI,KACR,IAAI,yBAAuB,CACzB,UAAAc,EACA,OAAQ,KAAK,UAAU,CACrB,SAAU,UACV,OAAQ,sBACV,CAAC,CACH,CAAC,CACH,EAGA,MAAMd,EAAI,KACR,IAAI,yBAAuB,CACzB,UAAAc,EACA,MAAO,kBACP,MAAO,sBACT,CAAC,CACH,EAGF,MAAMb,EAAI,KACR,IAAI,gBAAc,CAChB,UAAWC,EACX,IAAK,CAAE,CAACC,CAAO,EAAGQ,EAAI,CAACP,CAAO,EAAGQ,CAAG,EACpC,iBACE,mFACF,yBAA0B,CAAE,UAAW,QAAS,EAChD,0BAA2B,CACzB,KAAMF,IAAa,UAAY,WAAa,WAC5C,KAAMK,CACR,CACF,CAAC,CACH,EAEOV,EAAS,IAAK,CAAE,GAAI,EAAK,CAAC,CACnC,OAASW,EAAK,CACZ,eAAQ,MAAMA,CAAG,EACVX,EAAS,IAAK,CAAE,QAAS,gBAAiB,CAAC,CACpD,CACF",
  "names": ["approve_closet_upload_exports", "__export", "handler", "__toCommonJS", "import_client_sfn", "import_client_dynamodb", "import_lib_dynamodb", "sfn", "ddb", "TABLE_NAME", "PK_NAME", "SK_NAME", "response", "statusCode", "body", "event", "approvalId", "decision", "pk", "sk", "res", "taskToken", "now", "err"]
}
