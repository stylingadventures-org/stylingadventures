{
  "version": 3,
  "sources": ["../../lambda/admin/settings.ts", "../../lambda/_shared/env.ts"],
  "sourcesContent": ["// lambda/admin/settings.ts\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  GetCommand,\r\n  PutCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\nimport { AppSyncIdentityCognito } from \"aws-lambda\";\r\nimport { TABLE_NAME } from \"../_shared/env\";\r\n\r\nconst {\r\n  ADMIN_GROUP_NAME = \"ADMIN\",\r\n  SUPERADMIN_EMAILS = \"\",\r\n  SKIP_ADMIN_CHECK = \"false\",\r\n} = process.env;\r\n\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}), {\r\n  marshallOptions: { removeUndefinedValues: true },\r\n});\r\n\r\nconst SUPERADMINS = SUPERADMIN_EMAILS.split(\",\")\r\n  .map((s) => s.trim().toLowerCase())\r\n  .filter(Boolean);\r\n\r\ntype SAIdentity = (AppSyncIdentityCognito & { groups?: string[] | null }) | null | undefined;\r\n\r\nfunction getGroups(id: SAIdentity): string[] {\r\n  if (!id) return [];\r\n  const claims: any = (id as any).claims || {};\r\n  const raw =\r\n    claims[\"cognito:groups\"] ||\r\n    claims[\"custom:groups\"] ||\r\n    (id as any).groups ||\r\n    [];\r\n  if (Array.isArray(raw)) return raw.map((g) => String(g));\r\n  if (typeof raw === \"string\") {\r\n    return raw\r\n      .split(\",\")\r\n      .map((x) => x.trim())\r\n      .filter(Boolean);\r\n  }\r\n  return [];\r\n}\r\n\r\nfunction isAdmin(identity: SAIdentity): boolean {\r\n  if (SKIP_ADMIN_CHECK === \"true\") return true;\r\n\r\n  const groups = getGroups(identity).map((g) => g.toUpperCase());\r\n  if (groups.includes(ADMIN_GROUP_NAME.toUpperCase())) return true;\r\n\r\n  const email =\r\n    (identity as any)?.claims?.email ||\r\n    (identity as any)?.claims?.[\"custom:email\"] ||\r\n    \"\";\r\n  if (email && SUPERADMINS.includes(String(email).toLowerCase())) return true;\r\n\r\n  return false;\r\n}\r\n\r\nfunction requireAdmin(identity: SAIdentity) {\r\n  if (!identity?.sub) throw new Error(\"Unauthorized\");\r\n  if (!isAdmin(identity)) throw new Error(\"Forbidden\");\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// AdminSettings helpers\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nconst ADMIN_SETTINGS_PK = \"ADMIN#SETTINGS\";\r\nconst ADMIN_SETTINGS_SK = \"CURRENT\";\r\n\r\nconst DEFAULT_ADMIN_SETTINGS = {\r\n  animationsEnabled: true,\r\n  soundsEnabled: true,\r\n  autoBadgeGrant: true,\r\n  badgeRules: [] as any[],\r\n};\r\n\r\nasync function loadAdminSettings() {\r\n  const r = await ddb.send(\r\n    new GetCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: { pk: ADMIN_SETTINGS_PK, sk: ADMIN_SETTINGS_SK },\r\n    }),\r\n  );\r\n  const raw = (r.Item || {}) as any;\r\n  return {\r\n    ...DEFAULT_ADMIN_SETTINGS,\r\n    ...raw.settings,\r\n  };\r\n}\r\n\r\nasync function saveAdminSettings(\r\n  settings: any,\r\n  identity: SAIdentity,\r\n) {\r\n  const nowIso = new Date().toISOString();\r\n  await ddb.send(\r\n    new PutCommand({\r\n      TableName: TABLE_NAME,\r\n      Item: {\r\n        pk: ADMIN_SETTINGS_PK,\r\n        sk: ADMIN_SETTINGS_SK,\r\n        settings,\r\n        updatedAt: nowIso,\r\n        updatedBy: identity?.sub || \"unknown\",\r\n        type: \"ADMIN_SETTINGS\",\r\n      },\r\n    }),\r\n  );\r\n  return settings;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// GameEconomyConfig helpers\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nconst GAME_CFG_PK = \"ADMIN#GAME_RULES\";\r\nconst GAME_CFG_SK = \"CURRENT\";\r\n\r\nconst DEFAULT_GAME_CFG = {\r\n  version: 1,\r\n  economy: {\r\n    coinToUsdRatio: 1,\r\n    dailyCoinCap: 10,\r\n    weeklyCoinCap: 60,\r\n    monthlyEventLimit: 2,\r\n  },\r\n  watch: {\r\n    coinPerMinutes: 10, // 1 LC / 10 min\r\n    dailyMax: 4,\r\n  },\r\n  chat: {\r\n    coinPerMinutes: 5, // 1 LC / 5 min\r\n    dailyMax: 5,\r\n    minWords: 5,\r\n    cooldownMinutes: 5,\r\n  },\r\n  trivia: {\r\n    coinPerCorrect: 1,\r\n    challengeBonus: 3,\r\n    dailyMax: 5,\r\n  },\r\n  streaks: {\r\n    day3: 3,\r\n    day7: 10,\r\n    day30: 40,\r\n    minWatchMinutesPerDay: 10,\r\n  },\r\n  social: {\r\n    shareReward: 5,\r\n    clipWeeklyReward: 20,\r\n    bringFriendReward: 15,\r\n  },\r\n  events: {\r\n    doubleCoinEnabled: false,\r\n    bigEventMonthlyLimit: 2,\r\n    surpriseDropMin: 3,\r\n    surpriseDropMax: 5,\r\n  },\r\n  redemption: {\r\n    minEarnedEngagement: 20,\r\n    weeklyRedemptionLimit: 1,\r\n    rewards: [] as any[],\r\n  },\r\n};\r\n\r\nasync function loadGameEconomyConfig() {\r\n  const r = await ddb.send(\r\n    new GetCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: { pk: GAME_CFG_PK, sk: GAME_CFG_SK },\r\n    }),\r\n  );\r\n  if (!r.Item) {\r\n    const nowIso = new Date().toISOString();\r\n    return {\r\n      ...DEFAULT_GAME_CFG,\r\n      updatedAt: nowIso,\r\n      updatedBy: null,\r\n    };\r\n  }\r\n  const { config, version, updatedAt, updatedBy } = r.Item as any;\r\n  return {\r\n    ...DEFAULT_GAME_CFG,\r\n    ...config,\r\n    version: version ?? 1,\r\n    updatedAt,\r\n    updatedBy,\r\n  };\r\n}\r\n\r\nfunction deepMerge<T>(base: T, patch: any): T {\r\n  if (!patch || typeof patch !== \"object\") return base;\r\n  const out: any = Array.isArray(base) ? [...(base as any)] : { ...(base as any) };\r\n  for (const [k, v] of Object.entries(patch)) {\r\n    if (\r\n      v &&\r\n      typeof v === \"object\" &&\r\n      !Array.isArray(v) &&\r\n      typeof (base as any)[k] === \"object\" &&\r\n      !Array.isArray((base as any)[k])\r\n    ) {\r\n      out[k] = deepMerge((base as any)[k], v);\r\n    } else {\r\n      out[k] = v;\r\n    }\r\n  }\r\n  return out;\r\n}\r\n\r\nasync function saveGameEconomyConfig(\r\n  input: any,\r\n  identity: SAIdentity,\r\n) {\r\n  const current = await loadGameEconomyConfig();\r\n  const merged = {\r\n    ...current,\r\n    ...deepMerge(current, input),\r\n  };\r\n  const nextVersion = (current.version || 1) + 1;\r\n  const nowIso = new Date().toISOString();\r\n\r\n  await ddb.send(\r\n    new PutCommand({\r\n      TableName: TABLE_NAME,\r\n      Item: {\r\n        pk: GAME_CFG_PK,\r\n        sk: GAME_CFG_SK,\r\n        type: \"GAME_RULES\",\r\n        version: nextVersion,\r\n        updatedAt: nowIso,\r\n        updatedBy: identity?.sub || \"unknown\",\r\n        config: merged,\r\n      },\r\n    }),\r\n  );\r\n\r\n  return {\r\n    ...merged,\r\n    version: nextVersion,\r\n    updatedAt: nowIso,\r\n    updatedBy: identity?.sub || \"unknown\",\r\n  };\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// AppSync handler\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\ntype AppSyncEvent = {\r\n  info: { fieldName: string };\r\n  arguments: any;\r\n  identity?: SAIdentity;\r\n};\r\n\r\nexport const handler = async (event: AppSyncEvent) => {\r\n  const { fieldName } = event.info;\r\n  const identity = event.identity;\r\n\r\n  if (fieldName === \"getAdminSettings\") {\r\n    requireAdmin(identity);\r\n    const settings = await loadAdminSettings();\r\n    return settings;\r\n  }\r\n\r\n  if (fieldName === \"updateAdminSettings\") {\r\n    requireAdmin(identity);\r\n    const merged = {\r\n      ...DEFAULT_ADMIN_SETTINGS,\r\n      ...(await loadAdminSettings()),\r\n      ...(event.arguments?.input || {}),\r\n    };\r\n    await saveAdminSettings(merged, identity);\r\n    return merged;\r\n  }\r\n\r\n  if (fieldName === \"getGameEconomyConfig\") {\r\n    requireAdmin(identity);\r\n    return loadGameEconomyConfig();\r\n  }\r\n\r\n  if (fieldName === \"updateGameEconomyConfig\") {\r\n    requireAdmin(identity);\r\n    const input = event.arguments?.input || {};\r\n    return saveGameEconomyConfig(input, identity);\r\n  }\r\n\r\n  throw new Error(`Unknown field ${fieldName}`);\r\n};\r\n", "// lambda/_shared/env.ts\r\nexport const TABLE_NAME =\r\n  process.env.TABLE_NAME ??\r\n  process.env.APP_TABLE ??\r\n  process.env.TABLE ??\r\n  \"\";\r\n\r\nif (!TABLE_NAME) {\r\n  // Fail fast at cold start so you notice during deploy/tests\r\n  throw new Error(\r\n    \"Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).\"\r\n  );\r\n}\r\n"],
  "mappings": "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",
  "names": ["settings_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "TABLE_NAME", "ADMIN_GROUP_NAME", "SUPERADMIN_EMAILS", "SKIP_ADMIN_CHECK", "ddb", "SUPERADMINS", "s", "getGroups", "id", "claims", "raw", "g", "x", "isAdmin", "identity", "email", "requireAdmin", "ADMIN_SETTINGS_PK", "ADMIN_SETTINGS_SK", "DEFAULT_ADMIN_SETTINGS", "loadAdminSettings", "TABLE_NAME", "saveAdminSettings", "settings", "nowIso", "GAME_CFG_PK", "GAME_CFG_SK", "DEFAULT_GAME_CFG", "loadGameEconomyConfig", "r", "config", "version", "updatedAt", "updatedBy", "deepMerge", "base", "patch", "out", "k", "v", "saveGameEconomyConfig", "input", "current", "merged", "nextVersion", "handler", "event", "fieldName"]
}
