"use strict";var c=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var T=Object.prototype.hasOwnProperty;var N=(n,e)=>{for(var t in e)c(n,t,{get:e[t],enumerable:!0})},C=(n,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of M(e))!T.call(n,r)&&r!==t&&c(n,r,{get:()=>e[r],enumerable:!(o=I(e,r))||o.enumerable});return n};var D=n=>C(c({},"__esModule",{value:!0}),n);var U={};N(U,{handler:()=>R});module.exports=D(U);var p=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb");var i=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!i)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var{ADMIN_GROUP_NAME:_="ADMIN",SUPERADMIN_EMAILS:G="",SKIP_ADMIN_CHECK:B="false"}=process.env,d=a.DynamoDBDocumentClient.from(new p.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),v=G.split(",").map(n=>n.trim().toLowerCase()).filter(Boolean);function L(n){if(!n)return[];let e=n.claims||{},t=e["cognito:groups"]||e["custom:groups"]||n.groups||[];return Array.isArray(t)?t.map(o=>String(o)):typeof t=="string"?t.split(",").map(o=>o.trim()).filter(Boolean):[]}function b(n){if(B==="true"||L(n).map(o=>o.toUpperCase()).includes(_.toUpperCase()))return!0;let t=n?.claims?.email||n?.claims?.["custom:email"]||"";return!!(t&&v.includes(String(t).toLowerCase()))}function u(n){if(!n?.sub)throw new Error("Unauthorized");if(!b(n))throw new Error("Forbidden")}var A="ADMIN#SETTINGS",l="CURRENT",f={animationsEnabled:!0,soundsEnabled:!0,autoBadgeGrant:!0,badgeRules:[]};async function y(){let e=(await d.send(new a.GetCommand({TableName:i,Key:{pk:A,sk:l}}))).Item||{};return{...f,...e.settings}}async function k(n,e){let t=new Date().toISOString();return await d.send(new a.PutCommand({TableName:i,Item:{pk:A,sk:l,settings:n,updatedAt:t,updatedBy:e?.sub||"unknown",type:"ADMIN_SETTINGS"}})),n}var E="ADMIN#GAME_RULES",g="CURRENT",m={version:1,economy:{coinToUsdRatio:1,dailyCoinCap:10,weeklyCoinCap:60,monthlyEventLimit:2},watch:{coinPerMinutes:10,dailyMax:4},chat:{coinPerMinutes:5,dailyMax:5,minWords:5,cooldownMinutes:5},trivia:{coinPerCorrect:1,challengeBonus:3,dailyMax:5},streaks:{day3:3,day7:10,day30:40,minWatchMinutesPerDay:10},social:{shareReward:5,clipWeeklyReward:20,bringFriendReward:15},events:{doubleCoinEnabled:!1,bigEventMonthlyLimit:2,surpriseDropMin:3,surpriseDropMax:5},redemption:{minEarnedEngagement:20,weeklyRedemptionLimit:1,rewards:[]}};async function w(){let n=await d.send(new a.GetCommand({TableName:i,Key:{pk:E,sk:g}}));if(!n.Item){let s=new Date().toISOString();return{...m,updatedAt:s,updatedBy:null}}let{config:e,version:t,updatedAt:o,updatedBy:r}=n.Item;return{...m,...e,version:t??1,updatedAt:o,updatedBy:r}}function S(n,e){if(!e||typeof e!="object")return n;let t=Array.isArray(n)?[...n]:{...n};for(let[o,r]of Object.entries(e))r&&typeof r=="object"&&!Array.isArray(r)&&typeof n[o]=="object"&&!Array.isArray(n[o])?t[o]=S(n[o],r):t[o]=r;return t}async function P(n,e){let t=await w(),o={...t,...S(t,n)},r=(t.version||1)+1,s=new Date().toISOString();return await d.send(new a.PutCommand({TableName:i,Item:{pk:E,sk:g,type:"GAME_RULES",version:r,updatedAt:s,updatedBy:e?.sub||"unknown",config:o}})),{...o,version:r,updatedAt:s,updatedBy:e?.sub||"unknown"}}var R=async n=>{let{fieldName:e}=n.info,t=n.identity;if(e==="getAdminSettings")return u(t),await y();if(e==="updateAdminSettings"){u(t);let o={...f,...await y(),...n.arguments?.input||{}};return await k(o,t),o}if(e==="getGameEconomyConfig")return u(t),w();if(e==="updateGameEconomyConfig"){u(t);let o=n.arguments?.input||{};return P(o,t)}throw new Error(`Unknown field ${e}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
