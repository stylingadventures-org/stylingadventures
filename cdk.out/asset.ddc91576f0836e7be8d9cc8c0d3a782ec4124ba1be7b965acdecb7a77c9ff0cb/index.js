"use strict";var p=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var k=(t,e)=>{for(var n in e)p(t,n,{get:e[n],enumerable:!0})},T=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of S(e))!I.call(t,s)&&s!==n&&p(t,s,{get:()=>e[s],enumerable:!(r=E(e,s))||r.enumerable});return t};var R=t=>T(p({},"__esModule",{value:!0}),t);var q={};k(q,{handler:()=>B});module.exports=R(q);var o=require("@aws-sdk/client-s3"),d=require("@aws-sdk/s3-request-presigner"),u=new o.S3Client({region:process.env.AWS_REGION||"us-east-1",forcePathStyle:!0}),a=process.env.BUCKET,C=String(process.env.ALLOWED_ORIGINS||"").split(",").map(t=>t.trim().replace(/\/+$/,"")).filter(Boolean),x=(process.env.WEB_ORIGIN||"").replace(/\/+$/,""),G=["authorization","Authorization","Content-Type","X-Amz-Date","X-Api-Key","X-Amz-Security-Token"].join(",");function m(t){return String(t?.headers?.origin||t?.headers?.Origin||"").replace(/\/+$/,"")}function g(t){let e=m(t);return C.length>0?e&&C.includes(e)?e:void 0:x||void 0}function y(t){let e={"Content-Type":"application/json","Access-Control-Allow-Headers":G,"Access-Control-Allow-Methods":"GET,POST,DELETE,OPTIONS","Access-Control-Allow-Credentials":"true","Access-Control-Expose-Headers":"ETag,Content-Type,Content-Length,Last-Modified,Accept-Ranges",Vary:"Origin, Access-Control-Request-Headers, Access-Control-Request-Method"};return t&&(e["Access-Control-Allow-Origin"]=t),e}function f(t,e,n={}){let r=g(t);return{statusCode:200,headers:{...y(r),"Cache-Control":"no-store",...n},body:JSON.stringify(e)}}function b(t){let e=g(t);return{statusCode:204,headers:y(e),body:""}}function i(t,e,n){let r=g(t);return!!m(t)&&!r?{statusCode:403,headers:y(void 0),body:JSON.stringify({message:"CORS: origin not allowed"})}:{statusCode:e,headers:y(r),body:JSON.stringify({message:n})}}var N=t=>t.httpMethod??t.requestContext?.http?.method??"GET",K=t=>t.requestContext?.authorizer?.claims??t.requestContext?.authorizer?.jwt?.claims??{},L=t=>{let e=t.body??"";if(!e)return{};let n=t.isBase64Encoded&&typeof e=="string"?Buffer.from(e,"base64").toString():e;try{return typeof n=="string"?JSON.parse(n):n}catch{return{}}};function A(t,e){let n=String(e||"").replace(/\.\./g,"").replace(/^[/\\]+/,""),r=n.startsWith(`users/${t}/`),s=/^users\/[^/]+\//.test(n)&&!r;return r?n:`users/${t}/${s?n.replace(/^users\/[^/]+\//,""):n}`}var B=async t=>{let e=N(t);if(e==="OPTIONS")return!g(t)&&m(t)?{statusCode:403,headers:y(void 0),body:""}:b(t);try{let n=K(t)?.sub||"";if(!n)return i(t,401,"Not authorized");if(e==="POST"){let r=L(t),s=String(r.key||""),l=String(r.contentType||"application/octet-stream");if(!s)return i(t,400,"Missing 'key'");let c=A(n,s),h=new o.PutObjectCommand({Bucket:a,Key:c,ContentType:l}),w=new o.GetObjectCommand({Bucket:a,Key:c}),O=await(0,d.getSignedUrl)(u,h,{expiresIn:900}),P=await(0,d.getSignedUrl)(u,w,{expiresIn:300});return f(t,{bucket:a,key:c,method:"PUT",putUrl:O,getUrl:P})}if(e==="GET"){let r=String(t?.queryStringParameters?.key??t.pathParameters?.key??"");if(!r)return i(t,400,"Missing 'key'");let s=A(n,r),l=new o.GetObjectCommand({Bucket:a,Key:s}),c=await(0,d.getSignedUrl)(u,l,{expiresIn:300});return f(t,{bucket:a,key:s,getUrl:c})}if(e==="DELETE"){let r=String(t?.queryStringParameters?.key??t.pathParameters?.key??"");if(!r)return i(t,400,"Missing 'key'");let s=A(n,r);return await u.send(new o.DeleteObjectCommand({Bucket:a,Key:s})),f(t,{deleted:!0,key:s})}return i(t,405,"Method Not Allowed")}catch(n){return console.error(n),i(t,500,n?.message??String(n))}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
