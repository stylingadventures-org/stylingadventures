"use strict";var i=Object.defineProperty;var l=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var b=Object.prototype.hasOwnProperty;var g=(n,t)=>{for(var o in t)i(n,o,{get:t[o],enumerable:!0})},u=(n,t,o,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of p(t))!b.call(n,e)&&e!==o&&i(n,e,{get:()=>t[e],enumerable:!(s=l(t,e))||s.enumerable});return n};var c=n=>u(i({},"__esModule",{value:!0}),n);var E={};g(E,{handler:()=>S});module.exports=c(E);var a=require("@aws-sdk/client-dynamodb"),d=new a.DynamoDBClient({}),m=process.env.TABLE_NAME,S=async n=>{let t=n.identity,o=n.info.fieldName;if(o==="getMyProfile"){let s=t?.sub,e=await d.send(new a.GetItemCommand({TableName:m,Key:{pk:{S:`USER#${s}`},sk:{S:"PROFILE"}}}));if(!e.Item)return await d.send(new a.PutItemCommand({TableName:m,Item:{pk:{S:`USER#${s}`},sk:{S:"PROFILE"},xp:{N:"0"},coins:{N:"0"},badges:{S:"[]"}}})),{userId:s,level:1,xp:0,coins:0,badges:[],lastEventAt:null};let r=Number(e.Item.xp.N??"0");return{userId:s,level:Math.floor(r/100)+1,xp:r,coins:Number(e.Item.coins?.N??"0"),badges:JSON.parse(e.Item.badges?.S??"[]"),lastEventAt:e.Item.lastEventAt?.S??null}}if(o==="grantBadge"){if(!(t?.groups??[]).includes("ADMIN"))throw new Error("Forbidden");let{userId:e=t?.sub,badge:r}=n.arguments;return await d.send(new a.UpdateItemCommand({TableName:m,Key:{pk:{S:`USER#${e}`},sk:{S:"PROFILE"}},UpdateExpression:"SET badges = list_append(if_not_exists(badges, :empty), :b)",ExpressionAttributeValues:{":empty":{S:"[]"},":b":{S:JSON.stringify([r])}}})),{userId:e,level:0,xp:0,coins:0,badges:[r],lastEventAt:null}}throw new Error("Unknown field")};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
