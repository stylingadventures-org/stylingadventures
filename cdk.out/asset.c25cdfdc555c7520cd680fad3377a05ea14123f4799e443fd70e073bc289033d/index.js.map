{
  "version": 3,
  "sources": ["../../lambda/game/profile.ts"],
  "sourcesContent": ["import { DynamoDBClient, GetItemCommand, UpdateItemCommand, PutItemCommand } from \"@aws-sdk/client-dynamodb\";\r\nimport { AppSyncIdentityCognito } from \"aws-lambda\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\nconst TABLE = process.env.TABLE_NAME!;\r\n\r\nexport const handler = async (event: any) => {\r\n  const id = event.identity as AppSyncIdentityCognito;\r\n  const fn = event.info.fieldName;\r\n\r\n  if (fn === 'getMyProfile') {\r\n    const userId = id?.sub!;\r\n    const res = await ddb.send(new GetItemCommand({\r\n      TableName: TABLE,\r\n      Key: { pk: { S: `USER#${userId}` }, sk: { S: 'PROFILE' } }\r\n    }));\r\n    if (!res.Item) {\r\n      await ddb.send(new PutItemCommand({\r\n        TableName: TABLE,\r\n        Item: { pk: { S: `USER#${userId}` }, sk: { S: 'PROFILE' }, xp: { N: '0' }, coins: { N: '0' }, badges: { S: '[]' } }\r\n      }));\r\n      return { userId, level: 1, xp: 0, coins: 0, badges: [], lastEventAt: null };\r\n    }\r\n    const xp = Number(res.Item.xp.N ?? '0');\r\n    return {\r\n      userId,\r\n      level: Math.floor(xp / 100) + 1,\r\n      xp,\r\n      coins: Number(res.Item.coins?.N ?? '0'),\r\n      badges: JSON.parse(res.Item.badges?.S ?? '[]'),\r\n      lastEventAt: res.Item.lastEventAt?.S ?? null\r\n    };\r\n  }\r\n\r\n  if (fn === 'grantBadge') {\r\n    // Only ADMIN or self-grant with server rules; here we enforce ADMIN\r\n    const groups = (id as any)?.groups ?? [];\r\n    if (!groups.includes('ADMIN')) throw new Error('Forbidden');\r\n    const { userId = id?.sub, badge } = event.arguments as { userId: string, badge: string };\r\n    await ddb.send(new UpdateItemCommand({\r\n      TableName: TABLE,\r\n      Key: { pk: { S: `USER#${userId}` }, sk: { S: 'PROFILE' } },\r\n      UpdateExpression: 'SET badges = list_append(if_not_exists(badges, :empty), :b)',\r\n      ExpressionAttributeValues: { ':empty': { S: '[]' }, ':b': { S: JSON.stringify([badge]) } },\r\n    }));\r\n    // read-back omitted for brevity\r\n    return { userId, level: 0, xp: 0, coins: 0, badges: [badge], lastEventAt: null };\r\n  }\r\n\r\n  throw new Error('Unknown field');\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAAA,IAAAI,EAAkF,oCAG5EC,EAAM,IAAI,iBAAe,CAAC,CAAC,EAC3BC,EAAQ,QAAQ,IAAI,WAEbJ,EAAU,MAAOK,GAAe,CAC3C,IAAMC,EAAKD,EAAM,SACXE,EAAKF,EAAM,KAAK,UAEtB,GAAIE,IAAO,eAAgB,CACzB,IAAMC,EAASF,GAAI,IACbG,EAAM,MAAMN,EAAI,KAAK,IAAI,iBAAe,CAC5C,UAAWC,EACX,IAAK,CAAE,GAAI,CAAE,EAAG,QAAQI,CAAM,EAAG,EAAG,GAAI,CAAE,EAAG,SAAU,CAAE,CAC3D,CAAC,CAAC,EACF,GAAI,CAACC,EAAI,KACP,aAAMN,EAAI,KAAK,IAAI,iBAAe,CAChC,UAAWC,EACX,KAAM,CAAE,GAAI,CAAE,EAAG,QAAQI,CAAM,EAAG,EAAG,GAAI,CAAE,EAAG,SAAU,EAAG,GAAI,CAAE,EAAG,GAAI,EAAG,MAAO,CAAE,EAAG,GAAI,EAAG,OAAQ,CAAE,EAAG,IAAK,CAAE,CACpH,CAAC,CAAC,EACK,CAAE,OAAAA,EAAQ,MAAO,EAAG,GAAI,EAAG,MAAO,EAAG,OAAQ,CAAC,EAAG,YAAa,IAAK,EAE5E,IAAME,EAAK,OAAOD,EAAI,KAAK,GAAG,GAAK,GAAG,EACtC,MAAO,CACL,OAAAD,EACA,MAAO,KAAK,MAAME,EAAK,GAAG,EAAI,EAC9B,GAAAA,EACA,MAAO,OAAOD,EAAI,KAAK,OAAO,GAAK,GAAG,EACtC,OAAQ,KAAK,MAAMA,EAAI,KAAK,QAAQ,GAAK,IAAI,EAC7C,YAAaA,EAAI,KAAK,aAAa,GAAK,IAC1C,CACF,CAEA,GAAIF,IAAO,aAAc,CAGvB,GAAI,EADYD,GAAY,QAAU,CAAC,GAC3B,SAAS,OAAO,EAAG,MAAM,IAAI,MAAM,WAAW,EAC1D,GAAM,CAAE,OAAAE,EAASF,GAAI,IAAK,MAAAK,CAAM,EAAIN,EAAM,UAC1C,aAAMF,EAAI,KAAK,IAAI,oBAAkB,CACnC,UAAWC,EACX,IAAK,CAAE,GAAI,CAAE,EAAG,QAAQI,CAAM,EAAG,EAAG,GAAI,CAAE,EAAG,SAAU,CAAE,EACzD,iBAAkB,8DAClB,0BAA2B,CAAE,SAAU,CAAE,EAAG,IAAK,EAAG,KAAM,CAAE,EAAG,KAAK,UAAU,CAACG,CAAK,CAAC,CAAE,CAAE,CAC3F,CAAC,CAAC,EAEK,CAAE,OAAAH,EAAQ,MAAO,EAAG,GAAI,EAAG,MAAO,EAAG,OAAQ,CAACG,CAAK,EAAG,YAAa,IAAK,CACjF,CAEA,MAAM,IAAI,MAAM,eAAe,CACjC",
  "names": ["profile_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "ddb", "TABLE", "event", "id", "fn", "userId", "res", "xp", "badge"]
}
