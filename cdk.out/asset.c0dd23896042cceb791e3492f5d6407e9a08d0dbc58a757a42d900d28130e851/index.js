"use strict";var d=Object.defineProperty;var c=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var y=(e,s)=>{for(var n in s)d(e,n,{get:s[n],enumerable:!0})},g=(e,s,n,i)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of E(s))!A.call(e,r)&&r!==n&&d(e,r,{get:()=>s[r],enumerable:!(i=c(s,r))||i.enumerable});return e};var b=e=>g(d({},"__esModule",{value:!0}),e);var v={};y(v,{handler:()=>x});module.exports=b(v);var p=require("@aws-sdk/client-dynamodb"),t=require("@aws-sdk/lib-dynamodb");var a=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!a)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var o=t.DynamoDBDocumentClient.from(new p.DynamoDBClient({})),m=e=>`USER#${e}`,l="PROFILE";async function u(e){let s=m(e),{Item:n}=await o.send(new t.GetCommand({TableName:a,Key:{pk:s,sk:l}}));if(!n){let i=Date.now();return await o.send(new t.UpdateCommand({TableName:a,Key:{pk:s,sk:l},UpdateExpression:"SET #uid=:uid, #lvl=:lvl, #xp=:xp, #coins=:coins, #badges=:badges, #ts=:ts",ExpressionAttributeNames:{"#uid":"userId","#lvl":"level","#xp":"xp","#coins":"coins","#badges":"badges","#ts":"lastEventAt"},ExpressionAttributeValues:{":uid":e,":lvl":1,":xp":0,":coins":0,":badges":[],":ts":i}})),{userId:e,level:1,xp:0,coins:0,badges:[],lastEventAt:i}}return n.userId||await o.send(new t.UpdateCommand({TableName:a,Key:{pk:s,sk:l},UpdateExpression:"SET #uid = if_not_exists(#uid, :uid)",ExpressionAttributeNames:{"#uid":"userId"},ExpressionAttributeValues:{":uid":e}})),{userId:n.userId??e,level:n.level??1,xp:n.xp??0,coins:n.coins??0,badges:Array.isArray(n.badges)?n.badges:[],displayName:n.displayName??null,lastEventAt:n.lastEventAt??null}}async function f(e,s){let n=m(e),i=(s??"").trim().slice(0,40),r=Date.now();return await o.send(new t.UpdateCommand({TableName:a,Key:{pk:n,sk:l},UpdateExpression:"SET #dn=:dn, #ts=:ts ADD #lvl :zero, #xp :zero, #coins :zero",ExpressionAttributeNames:{"#dn":"displayName","#ts":"lastEventAt","#lvl":"level","#xp":"xp","#coins":"coins"},ExpressionAttributeValues:{":dn":i,":ts":r,":zero":0}})),u(e)}var x=async e=>{let s=e.identity?.sub;if(!s)throw new Error("Unauthorized: missing sub");switch(e.info.fieldName){case"getMyProfile":return u(s);case"setDisplayName":return f(s,e.arguments.displayName);default:throw new Error(`Unknown field ${e.info.fieldName}`)}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
