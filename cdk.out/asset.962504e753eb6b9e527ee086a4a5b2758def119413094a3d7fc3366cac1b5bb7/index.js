"use strict";var S=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var G=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var j=(e,r)=>{for(var t in r)S(e,t,{get:r[t],enumerable:!0})},W=(e,r,t,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of G(r))!B.call(e,i)&&i!==t&&S(e,i,{get:()=>r[i],enumerable:!(s=$(r,i))||s.enumerable});return e};var q=e=>W(S({},"__esModule",{value:!0}),e);var ee={};j(ee,{adminApproveItem:()=>K,adminCreateClosetItem:()=>P,adminListBestieClosetItems:()=>M,adminListClosetItems:()=>T,adminListPending:()=>h,adminRejectItem:()=>D,adminSetClosetAudience:()=>U,adminUpdateClosetItem:()=>R,closetFeed:()=>N,handler:()=>Z,toggleFavoriteClosetItem:()=>V,topClosetLooks:()=>O});module.exports=q(ee);var d=require("@aws-sdk/client-dynamodb"),I=require("@aws-sdk/client-sfn"),x=require("@aws-sdk/util-dynamodb"),p=new d.DynamoDBClient({}),v=new I.SFNClient({}),{TABLE_NAME:m="",ADMIN_GROUP_NAME:H="admin",CREATOR_GROUP_NAME:J="creator"}=process.env;if(!m)throw new Error("Missing env: TABLE_NAME");var z=H.toLowerCase(),Q=J.toLowerCase(),b=()=>new Date().toISOString(),n=e=>({S:e});function X(e){let r=e?.claims||{},t=r["cognito:groups"]||r["custom:groups"]||e?.groups||[];return Array.isArray(t)?t.map(s=>String(s)):typeof t=="string"?t.split(",").map(s=>s.trim()).filter(Boolean):[]}function f(e){let r=e.identity,t=r?.claims||{},s=r?.sub||t.sub;if(!s)throw new Error("Unauthorized");let i=X(r),u=i.map(a=>a.toLowerCase()),o=u.includes(z),c=u.includes(Q);return{sub:s,isAdmin:o,isCreator:c,groups:i}}function A(e,r){let t=(0,x.unmarshall)(e),s=t.id??(typeof t.pk=="string"&&t.pk.startsWith("ITEM#")?t.pk.slice(5):void 0),i=typeof t.favoriteCount=="number"?t.favoriteCount:0,u=typeof t.pinned=="boolean"?t.pinned:void 0;return{id:String(s||""),userId:String(t.ownerSub??t.userSub??""),ownerSub:String(t.ownerSub??t.userSub??""),status:t.status??"PENDING",createdAt:String(t.createdAt??b()),updatedAt:String(t.updatedAt??t.createdAt??b()),mediaKey:t.mediaKey??"",rawMediaKey:t.rawMediaKey??"",title:t.title??"",reason:t.reason??"",season:t.season??null,vibes:t.vibes??null,audience:t.audience??null,category:t.category??null,subcategory:t.subcategory??null,pinned:u,favoriteCount:i,viewerHasFaved:!1,...r}}function Y(){return globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`}function C(e){return e?Buffer.from(JSON.stringify(e),"utf8").toString("base64"):null}function L(e){if(e)try{return JSON.parse(Buffer.from(String(e),"base64").toString("utf8"))}catch{return}}var h=async e=>{let{isAdmin:r}=f(e);if(!r)throw new Error("Forbidden");let{limit:t=100,nextToken:s}=e.arguments||{},i=L(s),u=await p.send(new d.QueryCommand({TableName:m,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned",ExpressionAttributeNames:{"#s":"status"},Limit:t,ExclusiveStartKey:i}));return{items:(u.Items||[]).map(c=>A({...c,status:c.status})),nextToken:C(u.LastEvaluatedKey)}},T=async e=>{let{isAdmin:r}=f(e);if(!r)throw new Error("Forbidden");let{status:t,limit:s=50,nextToken:i}=e.arguments||{},u=L(i);if(t){let a=await p.send(new d.QueryCommand({TableName:m,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n(`STATUS#${t}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned",ExpressionAttributeNames:{"#s":"status"},Limit:s,ExclusiveStartKey:u}));return{items:(a.Items||[]).map(l=>A({...l,status:l.status})),nextToken:C(a.LastEvaluatedKey)}}let o=await p.send(new d.ScanCommand({TableName:m,FilterExpression:"begins_with(pk, :p)",ExpressionAttributeValues:{":p":n("ITEM#")},ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned",ExpressionAttributeNames:{"#s":"status"},Limit:s,ExclusiveStartKey:u})),c=(o.Items||[]).map(a=>A({...a,status:a.status}));return c.sort((a,g)=>new Date(g.createdAt||0).getTime()-new Date(a.createdAt||0).getTime()),{items:c,nextToken:C(o.LastEvaluatedKey)}},M=async e=>{let r=await T(e),t=new Set(["BESTIE","EXCLUSIVE"]),s=r.items.filter(i=>{let u=(i.audience||"").toUpperCase();return t.has(u)});return{...r,items:s}},N=async e=>{let{sub:r}=f(e),s=(e.arguments?.sort??"NEWEST")==="MOST_LOVED"?"MOST_LOVED":"NEWEST",i=["APPROVED","PUBLISHED"],u=await p.send(new d.QueryCommand({TableName:m,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:{":pk":n(`FAV#${r}`),":sk":n("CLOSET#")}})),o=new Set((u.Items||[]).map(a=>{let g=a.sk?.S??"";return g.startsWith("CLOSET#")?g.substring(7):a.closetId?.S??""})),c=[];for(let a of i){let l=((await p.send(new d.QueryCommand({TableName:m,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n(`STATUS#${a}`)},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, audience, favoriteCount, category, subcategory, season, vibes, pinned",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(E=>A({...E,status:E.status},{viewerHasFaved:o.has(E.id.S)}));c.push(...l)}return c.sort((a,g)=>{let l=new Date(a.createdAt||0).getTime(),E=new Date(g.createdAt||0).getTime();if(s==="MOST_LOVED"){let y=a.favoriteCount??0,w=g.favoriteCount??0;return w!==y?w-y:E-l}return E-l}),{items:c,nextToken:null}},O=async e=>(await N({...e,arguments:{...e.arguments||{},sort:"NEWEST"}})).items,P=async e=>{let{sub:r,isAdmin:t}=f(e);if(!t)throw new Error("Forbidden");let s=e.arguments?.input||{};if(!s.title?.trim())throw new Error("title is required");let i=s.rawMediaKey||s.mediaKey;if(!i)throw new Error("rawMediaKey is required");let u=Y(),o=b();return await p.send(new d.PutItemCommand({TableName:m,Item:{pk:n(`ITEM#${u}`),sk:n("META"),id:n(u),ownerSub:n(r),gsi2pk:n("STATUS#PENDING"),gsi2sk:n(o),status:n("PENDING"),createdAt:n(o),updatedAt:n(o),title:n(s.title.trim()),rawMediaKey:n(i),favoriteCount:{N:"0"},...s.season?{season:n(s.season)}:{},...s.vibes?{vibes:n(s.vibes)}:{},...s.category?{category:n(s.category)}:{},...s.subcategory?{subcategory:n(s.subcategory)}:{},...s.audience?{audience:n(s.audience)}:{},...s.description?{description:n(s.description)}:{},...s.story?{story:n(s.story)}:{}}})),{id:u,userId:r,ownerSub:r,status:"PENDING",createdAt:o,updatedAt:o,title:s.title.trim(),mediaKey:"",rawMediaKey:i,reason:"",season:s.season??null,vibes:s.vibes??null,audience:s.audience??null,category:s.category??null,subcategory:s.subcategory??null,favoriteCount:0,viewerHasFaved:!1}},K=async e=>{let{isAdmin:r}=f(e);if(!r)throw new Error("Forbidden");let t=e.arguments?.closetItemId;if(!t)throw new Error("closetItemId required");let s=b(),u=(await p.send(new d.UpdateItemCommand({TableName:m,Key:{pk:n(`ITEM#${t}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("APPROVED"),":u":n(s),":g2pk":n("STATUS#APPROVED"),":g2sk":n(s)},ReturnValues:"ALL_OLD"}))).Attributes,o=u.approvalToken?.S;if(o)try{await v.send(new I.SendTaskSuccessCommand({taskToken:o,output:JSON.stringify({approved:!0})}))}catch{}return A({...u,status:n("APPROVED")})},D=async e=>{let{isAdmin:r}=f(e);if(!r)throw new Error("Forbidden");let t=e.arguments?.closetItemId,s=e.arguments?.reason||"";if(!t)throw new Error("closetItemId required");let i=b(),o=(await p.send(new d.UpdateItemCommand({TableName:m,Key:{pk:n(`ITEM#${t}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("REJECTED"),":u":n(i),":g2pk":n("STATUS#REJECTED"),":g2sk":n(i),":r":n(s)},ReturnValues:"ALL_OLD"}))).Attributes,c=o.approvalToken?.S;if(c)try{await v.send(new I.SendTaskFailureCommand({taskToken:c,error:"Rejected",cause:s||"Rejected by admin"}))}catch{}return A({...o,status:n("REJECTED"),reason:n(s)})},R=async e=>{let{isAdmin:r}=f(e);if(!r)throw new Error("Forbidden");let t=e.arguments||{},s=t.input||{},i=t.closetItemId??s.id??t.id;if(!i)throw new Error("closetItemId or input.id required");if(!(await p.send(new d.GetItemCommand({TableName:m,Key:{pk:n(`ITEM#${i}`),sk:n("META")}}))).Item)throw new Error("Closet item not found");let o={...s};["title","category","subcategory","audience","pinned","season","vibes"].forEach(y=>{t[y]!==void 0&&o[y]===void 0&&(o[y]=t[y])});let c=b(),a=["#updatedAt = :u"],g={"#updatedAt":"updatedAt"},l={":u":n(c)};if(o.title!==void 0&&(a.push("#title = :title"),g["#title"]="title",l[":title"]=o.title===null?{NULL:!0}:n(o.title)),o.category!==void 0&&(a.push("#category = :category"),g["#category"]="category",l[":category"]=o.category===null?{NULL:!0}:n(o.category)),o.subcategory!==void 0&&(a.push("#subcategory = :subcategory"),g["#subcategory"]="subcategory",l[":subcategory"]=o.subcategory===null?{NULL:!0}:n(o.subcategory)),o.audience!==void 0&&(a.push("audience = :audience"),l[":audience"]=o.audience===null?{NULL:!0}:n(o.audience)),o.season!==void 0&&(a.push("season = :season"),l[":season"]=o.season===null?{NULL:!0}:n(o.season)),o.vibes!==void 0&&(a.push("vibes = :vibes"),l[":vibes"]=o.vibes===null?{NULL:!0}:n(o.vibes)),o.pinned!==void 0&&(a.push("pinned = :pinned"),l[":pinned"]=o.pinned===null?{NULL:!0}:{BOOL:!!o.pinned}),a.length===1)throw new Error("No fields provided to update");let E=await p.send(new d.UpdateItemCommand({TableName:m,Key:{pk:n(`ITEM#${i}`),sk:n("META")},UpdateExpression:`SET ${a.join(", ")}`,ExpressionAttributeNames:g,ExpressionAttributeValues:l,ReturnValues:"ALL_NEW"}));if(!E.Attributes)throw new Error("Closet item not found");return A(E.Attributes)},U=async e=>{let{isAdmin:r}=f(e);if(!r)throw new Error("Forbidden");let t=e.arguments?.closetItemId,s=e.arguments?.audience;if(!t)throw new Error("closetItemId required");if(!s)throw new Error("audience required");let i=b(),u=await p.send(new d.UpdateItemCommand({TableName:m,Key:{pk:n(`ITEM#${t}`),sk:n("META")},UpdateExpression:"SET audience = :aud, updatedAt = :u",ExpressionAttributeValues:{":aud":n(s),":u":n(i)},ReturnValues:"ALL_NEW"}));if(!u.Attributes)throw new Error("Closet item not found");return A(u.Attributes)},V=async e=>{let{sub:r}=f(e),t=e.arguments?.id,s=e.arguments?.favoriteOn,i=e.arguments?.on,u=typeof s=="boolean"?s:i;if(!t)throw new Error("id required");let c=(await p.send(new d.GetItemCommand({TableName:m,Key:{pk:n(`ITEM#${t}`),sk:n("META")}}))).Item;if(!c)throw new Error("Closet item not found");let a={pk:n(`FAV#${r}`),sk:n(`CLOSET#${t}`)},l=!!(await p.send(new d.GetItemCommand({TableName:m,Key:a}))).Item,E=typeof u=="boolean"?u:!l,y=b(),w=0;E&&!l?(w=1,await p.send(new d.PutItemCommand({TableName:m,Item:{...a,userSub:n(r),closetId:n(t),createdAt:n(y)}}))):!E&&l&&(w=-1,await p.send(new d.DeleteItemCommand({TableName:m,Key:a}))),w!==0&&await p.send(new d.UpdateItemCommand({TableName:m,Key:{pk:n(`ITEM#${t}`),sk:n("META")},UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) + :delta, updatedAt = :u",ExpressionAttributeValues:{":zero":{N:"0"},":delta":{N:String(w)},":u":n(y)}}));let k=c.favoriteCount?.N,_=typeof k=="string"?Number(k):0,F=Math.max(0,_+w);return A(c,{favoriteCount:F,viewerHasFaved:E})},Z=async e=>{let r=e.info.fieldName;if(r==="adminListPending")return h(e);if(r==="adminListClosetItems")return T(e);if(r==="adminListBestieClosetItems")return M(e);if(r==="adminCreateClosetItem")return P(e);if(r==="adminApproveItem")return K(e);if(r==="adminRejectItem")return D(e);if(r==="adminSetClosetAudience")return U(e);if(r==="adminUpdateClosetItem")return R(e);if(r==="closetFeed")return N(e);if(r==="topClosetLooks")return O(e);if(r==="toggleFavoriteClosetItem"||r==="likeClosetItem")return V(e);throw new Error(`No resolver implemented for field ${r}`)};0&&(module.exports={adminApproveItem,adminCreateClosetItem,adminListBestieClosetItems,adminListClosetItems,adminListPending,adminRejectItem,adminSetClosetAudience,adminUpdateClosetItem,closetFeed,handler,toggleFavoriteClosetItem,topClosetLooks});
//# sourceMappingURL=index.js.map
