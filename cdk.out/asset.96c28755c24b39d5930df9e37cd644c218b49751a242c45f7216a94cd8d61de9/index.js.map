{
  "version": 3,
  "sources": ["../../lambda/prime/validate-episode.ts"],
  "sourcesContent": ["// lambda/prime/validate-episode.ts\r\n\r\n/**\r\n * Prime Studios - Episode Validator\r\n *\r\n * Role in pipeline:\r\n *  - Validate a full episode document before publish.\r\n *  - Run structural checks on modular components (invite, envelope, closet, etc).\r\n *  - Optionally respect layout checklist results provided by LayoutEngine.\r\n *\r\n * This is intentionally lightweight: pure validation, no DB writes.\r\n */\r\n\r\ntype Severity = \"INFO\" | \"WARNING\" | \"ERROR\";\r\n\r\nexport interface ValidationIssue {\r\n  code: string;\r\n  severity: Severity;\r\n  message: string;\r\n  path?: string; // JSONPath-ish hint, e.g. \"components[0].id\"\r\n}\r\n\r\nexport interface EpisodeComponent {\r\n  id?: string;\r\n  kind?: string; // \"invite\" | \"envelope\" | \"closet\" | \"outfit\" | ...\r\n  [key: string]: any;\r\n}\r\n\r\nexport interface EpisodeLayoutChecklist {\r\n  passed: boolean;\r\n  issues?: ValidationIssue[];\r\n  checkedAt?: string;\r\n}\r\n\r\nexport interface EpisodeDocument {\r\n  episodeId?: string;\r\n  slug?: string;\r\n  title?: string;\r\n  status?: string;\r\n  version?: string;\r\n  components?: EpisodeComponent[];\r\n  layout?: any;\r\n\r\n  // optional layout checklist from LayoutEngineStack\r\n  layoutChecklist?: EpisodeLayoutChecklist;\r\n\r\n  // anything else\r\n  [key: string]: any;\r\n}\r\n\r\nexport interface ValidateEpisodeEvent {\r\n  /**\r\n   * The episode document to validate.\r\n   */\r\n  episode?: EpisodeDocument;\r\n\r\n  /**\r\n   * If true, this Lambda is expected to enforce layoutChecklist presence.\r\n   * If false/undefined, layout is treated as best-effort.\r\n   */\r\n  requireLayoutChecklist?: boolean;\r\n}\r\n\r\nexport interface ValidateEpisodeResult {\r\n  ok: boolean;\r\n  issues: ValidationIssue[];\r\n\r\n  // normalized / minimally enriched episode for the rest of the pipeline\r\n  episode: EpisodeDocument;\r\n\r\n  // convenient flags for downstream steps / Step Functions\r\n  summary: {\r\n    hasInvite: boolean;\r\n    hasEnvelope: boolean;\r\n    hasCloset: boolean;\r\n    hasOutfit: boolean;\r\n    hasDialogue: boolean;\r\n    hasSideQuests: boolean;\r\n    hasCoinsConfig: boolean;\r\n    hasLocations: boolean;\r\n    hasPhotoshoots: boolean;\r\n    hasLayoutChecklist: boolean;\r\n    layoutChecklistPassed: boolean | null;\r\n  };\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// Helpers\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nfunction issue(\r\n  code: string,\r\n  severity: Severity,\r\n  message: string,\r\n  path?: string,\r\n): ValidationIssue {\r\n  return { code, severity, message, path };\r\n}\r\n\r\nfunction ensureEpisodeId(ep: EpisodeDocument, issues: ValidationIssue[]) {\r\n  if (!ep.episodeId && !ep.slug) {\r\n    issues.push(\r\n      issue(\r\n        \"MISSING_EPISODE_ID\",\r\n        \"ERROR\",\r\n        \"Episode must have an 'episodeId' or 'slug'.\",\r\n      ),\r\n    );\r\n  }\r\n}\r\n\r\nfunction ensureTitle(ep: EpisodeDocument, issues: ValidationIssue[]) {\r\n  if (!ep.title || !ep.title.trim()) {\r\n    issues.push(\r\n      issue(\"MISSING_TITLE\", \"ERROR\", \"Episode must have a title.\", \"title\"),\r\n    );\r\n  } else if (ep.title.length > 140) {\r\n    issues.push(\r\n      issue(\r\n        \"TITLE_TOO_LONG\",\r\n        \"WARNING\",\r\n        \"Episode title is quite long (over 140 chars).\",\r\n        \"title\",\r\n      ),\r\n    );\r\n  }\r\n}\r\n\r\nfunction ensureComponents(ep: EpisodeDocument, issues: ValidationIssue[]) {\r\n  const comps = ep.components ?? [];\r\n\r\n  if (!Array.isArray(comps) || comps.length === 0) {\r\n    issues.push(\r\n      issue(\r\n        \"NO_COMPONENTS\",\r\n        \"ERROR\",\r\n        \"Episode must contain at least one component.\",\r\n        \"components\",\r\n      ),\r\n    );\r\n    return;\r\n  }\r\n\r\n  // Validate basic structure\r\n  comps.forEach((c, idx) => {\r\n    if (!c.kind) {\r\n      issues.push(\r\n        issue(\r\n          \"COMPONENT_KIND_MISSING\",\r\n          \"ERROR\",\r\n          `Component at index ${idx} is missing 'kind'.`,\r\n          `components[${idx}]`,\r\n        ),\r\n      );\r\n    }\r\n    if (!c.id) {\r\n      issues.push(\r\n        issue(\r\n          \"COMPONENT_ID_MISSING\",\r\n          \"WARNING\",\r\n          `Component at index ${idx} is missing 'id'.`,\r\n          `components[${idx}]`,\r\n        ),\r\n      );\r\n    }\r\n  });\r\n}\r\n\r\nfunction summarizeComponents(ep: EpisodeDocument) {\r\n  const comps = ep.components ?? [];\r\n  const has = (kind: string) =>\r\n    comps.some((c) => typeof c.kind === \"string\" && c.kind === kind);\r\n\r\n  return {\r\n    hasInvite: has(\"invite\"),\r\n    hasEnvelope: has(\"envelope\"),\r\n    hasCloset: has(\"closet\"),\r\n    hasOutfit: has(\"outfit\"),\r\n    hasDialogue: has(\"dialogue\"),\r\n    hasSideQuests: has(\"side-quest\") || has(\"sideQuest\") || has(\"side_quest\"),\r\n    hasCoinsConfig: has(\"coins\") || has(\"coin-config\") || has(\"rewards\"),\r\n    hasLocations: has(\"location\") || has(\"locations\"),\r\n    hasPhotoshoots: has(\"photoshoot\") || has(\"photoshoots\"),\r\n  };\r\n}\r\n\r\nfunction checkBasicStoryFlow(\r\n  summary: ReturnType<typeof summarizeComponents>,\r\n  issues: ValidationIssue[],\r\n) {\r\n  if (!summary.hasInvite) {\r\n    issues.push(\r\n      issue(\r\n        \"NO_INVITE\",\r\n        \"WARNING\",\r\n        \"No 'invite' component found \u2013 consider adding an entry hook.\",\r\n      ),\r\n    );\r\n  }\r\n  if (!summary.hasDialogue) {\r\n    issues.push(\r\n      issue(\r\n        \"NO_DIALOGUE\",\r\n        \"WARNING\",\r\n        \"No 'dialogue' components found \u2013 episode may feel silent.\",\r\n      ),\r\n    );\r\n  }\r\n  if (!summary.hasCoinsConfig) {\r\n    issues.push(\r\n      issue(\r\n        \"NO_COINS_CONFIG\",\r\n        \"INFO\",\r\n        \"No coins / rewards configuration found; gig may not reward XP/coins.\",\r\n      ),\r\n    );\r\n  }\r\n}\r\n\r\nfunction checkLayoutChecklist(\r\n  ep: EpisodeDocument,\r\n  requireLayoutChecklist: boolean | undefined,\r\n  issues: ValidationIssue[],\r\n): { hasLayoutChecklist: boolean; layoutChecklistPassed: boolean | null } {\r\n  const checklist = ep.layoutChecklist;\r\n\r\n  if (!checklist) {\r\n    if (requireLayoutChecklist) {\r\n      issues.push(\r\n        issue(\r\n          \"MISSING_LAYOUT_CHECKLIST\",\r\n          \"ERROR\",\r\n          \"Layout checklist is required but was not provided.\",\r\n          \"layoutChecklist\",\r\n        ),\r\n      );\r\n    } else {\r\n      issues.push(\r\n        issue(\r\n          \"MISSING_LAYOUT_CHECKLIST\",\r\n          \"WARNING\",\r\n          \"No layoutChecklist present; episode will skip layout safety checks.\",\r\n          \"layoutChecklist\",\r\n        ),\r\n      );\r\n    }\r\n    return { hasLayoutChecklist: false, layoutChecklistPassed: null };\r\n  }\r\n\r\n  if (!checklist.passed) {\r\n    issues.push(\r\n      issue(\r\n        \"LAYOUT_CHECKLIST_FAILED\",\r\n        requireLayoutChecklist ? \"ERROR\" : \"WARNING\",\r\n        \"Layout checklist did not pass all rules.\",\r\n        \"layoutChecklist\",\r\n      ),\r\n    );\r\n  }\r\n\r\n  if (Array.isArray(checklist.issues)) {\r\n    checklist.issues.forEach((i) =>\r\n      issues.push(\r\n        issue(\r\n          `LAYOUT_${i.code ?? \"ISSUE\"}`,\r\n          i.severity ?? \"WARNING\",\r\n          i.message ?? \"Layout checklist issue.\",\r\n          i.path,\r\n        ),\r\n      ),\r\n    );\r\n  }\r\n\r\n  return {\r\n    hasLayoutChecklist: true,\r\n    layoutChecklistPassed: !!checklist.passed,\r\n  };\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// Lambda handler\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nexport const handler = async (\r\n  event: ValidateEpisodeEvent,\r\n): Promise<ValidateEpisodeResult> => {\r\n  console.log(\r\n    \"ValidateEpisode incoming event:\",\r\n    JSON.stringify(event, null, 2),\r\n  );\r\n\r\n  const issues: ValidationIssue[] = [];\r\n\r\n  if (!event || !event.episode) {\r\n    issues.push(\r\n      issue(\r\n        \"MISSING_EPISODE\",\r\n        \"ERROR\",\r\n        \"ValidateEpisode requires 'episode' in the payload.\",\r\n      ),\r\n    );\r\n    return {\r\n      ok: false,\r\n      issues,\r\n      episode: event?.episode ?? ({} as EpisodeDocument),\r\n      summary: {\r\n        hasInvite: false,\r\n        hasEnvelope: false,\r\n        hasCloset: false,\r\n        hasOutfit: false,\r\n        hasDialogue: false,\r\n        hasSideQuests: false,\r\n        hasCoinsConfig: false,\r\n        hasLocations: false,\r\n        hasPhotoshoots: false,\r\n        hasLayoutChecklist: false,\r\n        layoutChecklistPassed: null,\r\n      },\r\n    };\r\n  }\r\n\r\n  const ep: EpisodeDocument = {\r\n    status: \"draft\",\r\n    ...event.episode,\r\n  };\r\n\r\n  ensureEpisodeId(ep, issues);\r\n  ensureTitle(ep, issues);\r\n  ensureComponents(ep, issues);\r\n\r\n  const summary = summarizeComponents(ep);\r\n  checkBasicStoryFlow(summary, issues);\r\n\r\n  const layoutStatus = checkLayoutChecklist(\r\n    ep,\r\n    event.requireLayoutChecklist,\r\n    issues,\r\n  );\r\n\r\n  const ok = issues.every((i) => i.severity !== \"ERROR\");\r\n\r\n  const result: ValidateEpisodeResult = {\r\n    ok,\r\n    issues,\r\n    episode: ep,\r\n    summary: {\r\n      ...summary,\r\n      hasLayoutChecklist: layoutStatus.hasLayoutChecklist,\r\n      layoutChecklistPassed: layoutStatus.layoutChecklistPassed,\r\n    },\r\n  };\r\n\r\n  console.log(\"ValidateEpisode result:\", JSON.stringify(result, null, 2));\r\n\r\n  return result;\r\n};\r\n"],
  "mappings": "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",
  "names": ["validate_episode_exports", "__export", "handler", "__toCommonJS", "issue", "code", "severity", "message", "path", "ensureEpisodeId", "ep", "issues", "ensureTitle", "ensureComponents", "comps", "c", "idx", "summarizeComponents", "has", "kind", "checkBasicStoryFlow", "summary", "checkLayoutChecklist", "requireLayoutChecklist", "checklist", "i", "event", "layoutStatus", "result"]
}
