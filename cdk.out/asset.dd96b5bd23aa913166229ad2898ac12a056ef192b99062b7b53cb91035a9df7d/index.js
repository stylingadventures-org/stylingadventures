"use strict";var L=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var U=(t,n)=>{for(var r in n)L(t,r,{get:n[r],enumerable:!0})},_=(t,n,r,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of S(n))!R.call(t,s)&&s!==r&&L(t,s,{get:()=>n[s],enumerable:!(e=D(n,s))||e.enumerable});return t};var h=t=>_(L({},"__esModule",{value:!0}),t);var F={};U(F,{handler:()=>$});module.exports=h(F);var T=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb");var l=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!l)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var c=a.DynamoDBDocumentClient.from(new T.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}});function O(t){let n=t?.groups;return Array.isArray(n)&&n.includes("ADMIN")}function v(t,n){if(!n?.sub)throw new Error("Unauthenticated");if(!O(n)&&n.sub!==t)throw new Error("Forbidden")}function M(t){if(t==null)return null;if(typeof t=="string")try{return JSON.parse(t)}catch{return{raw:t}}return typeof t=="object"?t:{value:t}}function y(t){let n=1,r=100,e=t;for(;e>=r;)e-=r,n++,r+=50;return n}function k(t,n=12){return Math.max(0,t|0).toString().padStart(n,"0")}function b(t){if(t==null)return null;if(typeof t=="number"){let n=new Date(t);return isNaN(n.getTime())?null:n.toISOString()}if(typeof t=="string"){let n=t.trim();if(!n)return null;let r=Number(n);if(!Number.isNaN(r)){let s=new Date(r);return isNaN(s.getTime())?null:s.toISOString()}let e=new Date(n);return isNaN(e.getTime())?null:e.toISOString()}return null}function P(t,n){if(!t||!n)return!1;let r=new Date(t),e=new Date(n);return r.getUTCFullYear()===e.getUTCFullYear()&&r.getUTCMonth()===e.getUTCMonth()&&r.getUTCDate()===e.getUTCDate()}function B(t,n){let r=new Date(t),e=new Date(n),s=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()-1));return r.getUTCFullYear()===s.getUTCFullYear()&&r.getUTCMonth()===s.getUTCMonth()&&r.getUTCDate()===s.getUTCDate()}var $=async t=>{let{fieldName:n}=t.info,r=t.identity;if(n==="getMyProfile"){if(!r?.sub)throw new Error("Unauthenticated");let e=r.sub,s=await c.send(new a.GetCommand({TableName:l,Key:{pk:`USER#${e}`,sk:"PROFILE"}})),A=Number(s.Item?.xp??0);return{userId:e,displayName:s.Item?.displayName||null,level:y(A),xp:A,coins:Number(s.Item?.coins??0),badges:Array.isArray(s.Item?.badges)?s.Item.badges:[],lastEventAt:b(s.Item?.lastEventAt),lastLoginAt:b(s.Item?.lastLoginAt),streakCount:Number(s.Item?.streakCount??0)||null}}if(n==="setDisplayName"){if(!r?.sub)throw new Error("Unauthenticated");let e=r.sub,A=(t.arguments?.displayName||"").trim().slice(0,40),p=new Date().toISOString(),i=await c.send(new a.UpdateCommand({TableName:l,Key:{pk:`USER#${e}`,sk:"PROFILE"},UpdateExpression:"SET displayName = :n, updatedAt = :u, xp = if_not_exists(xp,:z), coins = if_not_exists(coins,:z), lastEventAt = if_not_exists(lastEventAt, :now)",ExpressionAttributeValues:{":n":A,":u":p,":z":0,":now":p},ReturnValues:"ALL_NEW"})),o=Number(i.Attributes?.xp??0);return{userId:e,displayName:i.Attributes?.displayName||null,level:y(o),xp:o,coins:Number(i.Attributes?.coins??0),badges:Array.isArray(i.Attributes?.badges)?i.Attributes.badges:[],lastEventAt:b(i.Attributes?.lastEventAt)??p,lastLoginAt:b(i.Attributes?.lastLoginAt),streakCount:typeof i.Attributes?.streakCount=="number"?i.Attributes.streakCount:null}}if(n==="logGameEvent"){if(!r?.sub)throw new Error("Unauthenticated");let e=r.sub,s=new Date().toISOString(),A=t.arguments?.input??{},p=A.type||"UNKNOWN",i=M(A.metadata);if(p==="DAILY_LOGIN"){let I=await c.send(new a.GetCommand({TableName:l,Key:{pk:`USER#${e}`,sk:"PROFILE"},ProjectionExpression:"lastLoginAt, streakCount, xp, coins, badges, displayName, lastEventAt"})),C=I.Item?.lastLoginAt,N=b(C),d=Number(I.Item?.streakCount??0),x=1,f=0;N&&P(N,s)?(x=0,f=0):N&&B(N,s)?d+=1:d=1,x=d>0?10+Math.min(5,d):0,f=d>0?1:0;let g=await c.send(new a.UpdateCommand({TableName:l,Key:{pk:`USER#${e}`,sk:"PROFILE"},UpdateExpression:`
          SET xp = if_not_exists(xp,:z) + :xi,
              coins = if_not_exists(coins,:z) + :ci,
              lastEventAt = :now,
              lastLoginAt = :now,
              streakCount = :st
        `.replace(/\s+/g," "),ExpressionAttributeValues:{":z":0,":xi":x,":ci":f,":now":s,":st":d},ReturnValues:"ALL_NEW"})),w=Number(g.Attributes?.xp??0);return await c.send(new a.PutCommand({TableName:l,Item:{pk:`USER#${e}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${k(w)}#${e}`,xp:w,coins:Number(g.Attributes?.coins??0),streakCount:d,updatedAt:s,type:"LEADER"}})),{userId:e,displayName:g.Attributes?.displayName||null,level:y(w),xp:w,coins:Number(g.Attributes?.coins??0),badges:Array.isArray(g.Attributes?.badges)?g.Attributes.badges:[],lastEventAt:s,lastLoginAt:s,streakCount:d}}let o=p==="LEVEL_CLEAR"?50:p==="SHARE"?5:p==="STYLE_IT"?Math.max(1,Math.round((i?.score??5)/5)):1,m=p==="LEVEL_CLEAR"?5:0,u=await c.send(new a.UpdateCommand({TableName:l,Key:{pk:`USER#${e}`,sk:"PROFILE"},UpdateExpression:`
        SET xp = if_not_exists(xp,:z) + :xi,
            coins = if_not_exists(coins,:z) + :ci,
            lastEventAt = :now
      `.replace(/\s+/g," "),ExpressionAttributeValues:{":z":0,":xi":o,":ci":m,":now":s},ReturnValues:"ALL_NEW"})),E=Number(u.Attributes?.xp??0);return await c.send(new a.PutCommand({TableName:l,Item:{pk:`USER#${e}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${k(E)}#${e}`,xp:E,coins:Number(u.Attributes?.coins??0),updatedAt:s,type:"LEADER"}})),await c.send(new a.PutCommand({TableName:l,Item:{pk:`USER#${e}`,sk:`EVENT#${Date.now()}`,type:"EVENT",evType:p,metadata:i,at:s},ConditionExpression:"attribute_not_exists(pk)"})).catch(()=>{}),{userId:e,displayName:u.Attributes?.displayName||null,level:y(E),xp:E,coins:Number(u.Attributes?.coins??0),badges:Array.isArray(u.Attributes?.badges)?u.Attributes.badges:[],lastEventAt:s,lastLoginAt:b(u.Attributes?.lastLoginAt),streakCount:typeof u.Attributes?.streakCount=="number"?u.Attributes.streakCount:null}}if(n==="awardCoins"){let{userId:e,coins:s,xp:A}=t.arguments.input;v(e,r);let p=Math.max(0,s|0),i=Math.max(0,(A??0)|0),o=await c.send(new a.UpdateCommand({TableName:l,Key:{pk:`USER#${e}`,sk:"PROFILE"},UpdateExpression:"SET coins = if_not_exists(coins,:z) + :c, xp = if_not_exists(xp,:z) + :x",ExpressionAttributeValues:{":z":0,":c":p,":x":i},ReturnValues:"ALL_NEW"})),m=Number(o.Attributes?.xp??0),u=new Date().toISOString();return await c.send(new a.PutCommand({TableName:l,Item:{pk:`USER#${e}`,sk:"LEADER",gsi1pk:"LEADERBOARD#GLOBAL",gsi1sk:`XP#${k(m)}#${e}`,xp:m,coins:Number(o.Attributes?.coins??0),updatedAt:u,type:"LEADER"}})),{userId:e,displayName:o.Attributes?.displayName||null,level:y(m),xp:m,coins:Number(o.Attributes?.coins??0),badges:Array.isArray(o.Attributes?.badges)?o.Attributes.badges:[],lastEventAt:b(o.Attributes?.lastEventAt),lastLoginAt:b(o.Attributes?.lastLoginAt),streakCount:typeof o.Attributes?.streakCount=="number"?o.Attributes.streakCount:null}}if(n==="topXP"){let e=Math.max(1,Math.min(100,Number(t.arguments?.limit??10))),A=(await c.send(new a.QueryCommand({TableName:l,IndexName:"gsi1",KeyConditionExpression:"gsi1pk = :p",ExpressionAttributeValues:{":p":"LEADERBOARD#GLOBAL"},ScanIndexForward:!1,Limit:e}))).Items??[];return await Promise.all(A.map(async(i,o)=>{let m=i.pk.replace("USER#",""),u;try{u=(await c.send(new a.GetCommand({TableName:l,Key:{pk:`USER#${m}`,sk:"PROFILE"},ProjectionExpression:"displayName"}))).Item?.displayName}catch{}return{userId:m,displayName:u,xp:Number(i.xp??0),coins:Number(i.coins??0),rank:o+1}}))}throw new Error(`Unknown field ${n}`)};0&&(module.exports={handler});
