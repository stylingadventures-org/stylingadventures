"use strict";var h=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var _=Object.prototype.hasOwnProperty;var V=(e,t)=>{for(var i in t)h(e,i,{get:t[i],enumerable:!0})},D=(e,t,i,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of P(t))!_.call(e,s)&&s!==i&&h(e,s,{get:()=>t[s],enumerable:!(n=K(t,s))||n.enumerable});return e};var M=e=>D(h({},"__esModule",{value:!0}),e);var ee={};V(ee,{handler:()=>Z});module.exports=M(ee);var a=require("@aws-sdk/client-dynamodb"),A=require("@aws-sdk/client-sfn"),o=require("@aws-sdk/util-dynamodb"),S=require("crypto"),d=process.env.TABLE_NAME,U=process.env.APPROVAL_SM_ARN,ne=process.env.STATUS_GSI??"gsi1",m=new a.DynamoDBClient({}),O=new A.SFNClient({});function g(){return new Date().toISOString()}function p(e){return`USER#${e}`}function w(e){return`CLOSET#${e}`}function E(e){return`CLOSET#${e}`}function T(e){return`CLOSET#STATUS#${e}`}function I(e){let t=(0,o.unmarshall)(e),i=t.pk,n=t.sk,s=typeof n=="string"&&n.startsWith("CLOSET#")?n.substring(7):void 0,r=typeof i=="string"&&i.startsWith("USER#")?i.substring(5):void 0,u=t.id??s??"",c=t.userId??t.ownerSub??r??"",l=t.ownerSub??t.userId??r??c;return{id:u,userId:c,ownerSub:l,status:t.status,createdAt:t.createdAt,updatedAt:t.updatedAt,mediaKey:t.mediaKey,rawMediaKey:t.rawMediaKey,title:t.title,reason:t.reason,audience:t.audience,category:t.category,subcategory:t.subcategory,storyTitle:t.storyTitle,storySeason:t.storySeason,storyVibes:t.storyVibes,pinned:t.pinned,favoriteCount:t.favoriteCount,likeCount:t.likeCount,commentCount:t.commentCount,wishlistCount:t.wishlistCount,viewerHasFaved:t.viewerHasFaved,viewerHasLiked:t.viewerHasLiked,viewerHasWishlisted:t.viewerHasWishlisted}}function y(e){if(!e?.sub)throw new Error("Not authenticated");return e.sub}function F(e){let i=(e?.claims||{})["cognito:groups"],n=Array.isArray(i)?i:String(i||"").split(",").map(s=>s.trim()).filter(Boolean);return n.includes("ADMIN")||n.includes("COLLAB")}async function W(e){let t=y(e);return((await m.send(new a.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":p(t),":sk":"CLOSET#"})}))).Items??[]).map(I)}async function H(e,t){let i=y(t),n=(0,S.randomUUID)(),s=g(),r=e.input,u={id:n,userId:i,ownerSub:i,status:"DRAFT",createdAt:s,updatedAt:s,mediaKey:r.mediaKey??void 0,rawMediaKey:r.rawMediaKey??void 0,title:r.title??void 0,category:r.category??null,subcategory:r.subcategory??null,audience:r.audience??"PRIVATE"};return await m.send(new a.PutItemCommand({TableName:d,Item:(0,o.marshall)({pk:p(i),sk:w(n),gsi1pk:T(u.status),gsi1sk:s,rawMediaKey:u.rawMediaKey,...u})})),u}async function B(e,t){let i=y(t),n=g(),s=await m.send(new a.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(i),sk:w(e.closetItemId)}),UpdateExpression:"SET mediaKey = :mediaKey, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,o.marshall)({":mediaKey":e.mediaKey,":updatedAt":n,":gsi1pk":T("DRAFT"),":gsi1sk":n}),ReturnValues:"ALL_NEW"}));if(!s.Attributes)throw new Error("Item not found");return I(s.Attributes)}async function z(e,t){let i=y(t),n=g(),s=await m.send(new a.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(i),sk:w(e.closetItemId)}),ConditionExpression:"status = :draft",UpdateExpression:"SET status = :pending, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,o.marshall)({":draft":"DRAFT",":pending":"PENDING",":updatedAt":n,":gsi1pk":T("PENDING"),":gsi1sk":n}),ReturnValues:"ALL_NEW"}));if(!s.Attributes)throw new Error("Item not found or not in DRAFT status");let r=I(s.Attributes);return await O.send(new A.StartExecutionCommand({stateMachineArn:U,input:JSON.stringify({itemId:r.id,userId:r.userId,ownerSub:r.ownerSub})})),r}async function $(e,t){let i=y(t),{closetItemId:n,story:s}=e,r=g(),u=await m.send(new a.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(i),sk:w(n)}),UpdateExpression:"SET storyTitle = :storyTitle, updatedAt = :updatedAt",ExpressionAttributeValues:(0,o.marshall)({":storyTitle":s,":updatedAt":r}),ReturnValues:"ALL_NEW"}));if(!u.Attributes)throw new Error("Item not found");return I(u.Attributes)}async function f(e){let i=((await m.send(new a.ScanCommand({TableName:d,FilterExpression:"sk = :sk",ExpressionAttributeValues:(0,o.marshall)({":sk":w(e)})}))).Items??[])[0];if(!i)throw new Error("Closet item not found");let n=I(i),s=n.userId;if(!s)throw new Error("Closet item missing owner");return{base:n,ownerId:s}}async function v(e,t){let i=y(t),{closetItemId:n}=e,s=g(),{ownerId:r}=await f(n),u={pk:E(n),sk:`LIKE#${i}`,entityType:"LIKE",itemOwnerSub:r,likerSub:i,createdAt:s};try{await m.send(new a.PutItemCommand({TableName:d,Item:(0,o.marshall)(u),ConditionExpression:"attribute_not_exists(pk)"}))}catch(b){if(b?.name!=="ConditionalCheckFailedException")throw b}let c=await m.send(new a.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(r),sk:w(n)}),UpdateExpression:"SET likeCount = if_not_exists(likeCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":s}),ReturnValues:"ALL_NEW"}));if(!c.Attributes)throw new Error("Closet item not found");let l=I(c.Attributes);return l.viewerHasLiked=!0,l}async function G(e,t){let i=y(t),{closetItemId:n,text:s}=e,r=g(),u=(0,S.randomUUID)(),{ownerId:c}=await f(n),l={pk:E(n),sk:`COMMENT#${u}`,entityType:"COMMENT",closetItemId:n,itemOwnerSub:c,authorSub:i,text:s,createdAt:r};return await m.send(new a.PutItemCommand({TableName:d,Item:(0,o.marshall)(l)})),await m.send(new a.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(c),sk:w(n)}),UpdateExpression:"SET commentCount = if_not_exists(commentCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":r})})),{id:u,closetItemId:n,authorSub:i,text:s,createdAt:r}}async function q(e,t){let i=y(t),n=F(t),s=e.closetItemId,r=!!e.pinned;if(!s)throw new Error("closetItemId is required");let{base:u}=await f(s);if(!n&&u.userId!==i)throw new Error("Not authorized to pin this closet item.");let c=g(),l=await m.send(new a.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(u.userId),sk:w(u.id)}),UpdateExpression:"SET pinned = :pinned, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":pinned":r,":now":c}),ReturnValues:"ALL_NEW"}));if(!l.Attributes)throw new Error("Closet item not found after update");return I(l.Attributes)}async function R(e){let{closetItemId:t}=e;return((await m.send(new a.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":E(t),":sk":"COMMENT#"})}))).Items??[]).map(s=>(0,o.unmarshall)(s)).map(s=>({id:s.sk.replace("COMMENT#",""),closetItemId:s.closetItemId,authorSub:s.authorSub,text:s.text,createdAt:s.createdAt}))}async function J(e){let{closetItemId:t}=e;return((await m.send(new a.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":E(t),":sk":"LIKE#"})}))).Items??[]).map(s=>(0,o.unmarshall)(s)).map(s=>({closetItemId:t,likerSub:s.likerSub,createdAt:s.createdAt}))}async function Q(e){return R(e)}async function X(e,t){let i=y(t),{closetItemId:n,on:s}=e,r=g(),{ownerId:u}=await f(n),c=p(i),l=`WISHLIST#${n}`;if(s===!1){await m.send(new a.DeleteItemCommand({TableName:d,Key:(0,o.marshall)({pk:c,sk:l})}));let C;try{let k=await m.send(new a.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(u),sk:w(n)}),UpdateExpression:"SET wishlistCount = if_not_exists(wishlistCount, :zero) - :one, updatedAt = :now",ConditionExpression:"wishlistCount >= :one",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":r}),ReturnValues:"ALL_NEW"}));k.Attributes&&(C=I(k.Attributes))}catch(k){if(k?.name!=="ConditionalCheckFailedException")throw k;let L=((await m.send(new a.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND sk = :sk",ExpressionAttributeValues:(0,o.marshall)({":pk":p(u),":sk":w(n)})}))).Items??[])[0];L&&(C=I(L))}if(!C)throw new Error("Closet item not found");return C.viewerHasWishlisted=!1,C}let b={pk:c,sk:l,entityType:"WISHLIST",closetItemId:n,ownerSub:u,viewerSub:i,createdAt:r};try{await m.send(new a.PutItemCommand({TableName:d,Item:(0,o.marshall)(b),ConditionExpression:"attribute_not_exists(pk)"}))}catch(C){if(C?.name!=="ConditionalCheckFailedException")throw C}let N=await m.send(new a.UpdateItemCommand({TableName:d,Key:(0,o.marshall)({pk:p(u),sk:w(n)}),UpdateExpression:"SET wishlistCount = if_not_exists(wishlistCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,o.marshall)({":zero":0,":one":1,":now":r}),ReturnValues:"ALL_NEW"}));if(!N.Attributes)throw new Error("Closet item not found");let x=I(N.Attributes);return x.viewerHasWishlisted=!0,x}async function Y(e){let t=y(e),n=((await m.send(new a.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":p(t),":sk":"WISHLIST#"})}))).Items??[]).map(l=>(0,o.unmarshall)(l));if(!n.length)return[];let s=n.map(l=>({pk:p(l.ownerSub),sk:w(l.closetItemId)})),c=((await m.send(new a.BatchGetItemCommand({RequestItems:{[d]:{Keys:s.map(l=>(0,o.marshall)(l))}}}))).Responses?.[d]??[]).map(I);for(let l of c)l.viewerHasWishlisted=!0;return c}async function j(e){let t=e.source||{},i=e.identity||{},n=t.userId||t.id||i.sub;if(!n)throw new Error("Cannot resolve pinnedClosetItems: missing userId");return((await m.send(new a.QueryCommand({TableName:d,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",FilterExpression:"#pinned = :true AND #status = :published",ExpressionAttributeNames:{"#pinned":"pinned","#status":"status"},ExpressionAttributeValues:(0,o.marshall)({":pk":p(n),":sk":"CLOSET#",":true":!0,":published":"PUBLISHED"})}))).Items??[]).map(I)}var Z=async e=>{console.log("ClosetResolverFn event",JSON.stringify(e));let t=e.info?.fieldName;try{switch(t){case"myCloset":return await W(e.identity);case"myWishlist":return await Y(e.identity);case"createClosetItem":return await H(e.arguments,e.identity);case"updateClosetMediaKey":return await B(e.arguments,e.identity);case"requestClosetApproval":return await z(e.arguments,e.identity);case"updateClosetItemStory":return await $(e.arguments,e.identity);case"likeClosetItem":return await v(e.arguments,e.identity);case"commentOnClosetItem":return await G(e.arguments,e.identity);case"pinHighlight":return await q(e.arguments,e.identity);case"closetItemComments":return await R(e.arguments);case"adminClosetItemLikes":return await J(e.arguments);case"adminClosetItemComments":return await Q(e.arguments);case"toggleWishlistItem":return await X(e.arguments,e.identity);case"pinnedClosetItems":return await j(e);default:throw new Error(`Unsupported field: ${t}`)}}catch(i){throw console.error("Error in ClosetResolverFn",i),i}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
