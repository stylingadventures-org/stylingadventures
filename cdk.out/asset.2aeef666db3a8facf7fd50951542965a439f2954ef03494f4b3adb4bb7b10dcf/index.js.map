{
  "version": 3,
  "sources": ["../../lambda/admin/approve-closet-upload.ts"],
  "sourcesContent": ["import { SFNClient, SendTaskSuccessCommand } from \"@aws-sdk/client-sfn\";\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  GetCommand,\r\n  UpdateCommand,\r\n  PutCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\nimport { EventBridgeClient, PutEventsCommand } from \"@aws-sdk/client-eventbridge\";\r\nimport { SNSClient, PublishCommand } from \"@aws-sdk/client-sns\";\r\n\r\nconst sfn = new SFNClient({});\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}), {\r\n  marshallOptions: { removeUndefinedValues: true },\r\n});\r\nconst eb = new EventBridgeClient({});\r\nconst sns = new SNSClient({});\r\n\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\nconst AUDIT_TABLE_NAME = process.env.AUDIT_TABLE_NAME!;\r\nconst PK_NAME = process.env.PK_NAME || \"pk\";\r\nconst SK_NAME = process.env.SK_NAME || \"sk\";\r\nconst NOTIFY_TOPIC_ARN = process.env.NOTIFY_TOPIC_ARN;\r\n\r\nfunction response(statusCode: number, body: any) {\r\n  return {\r\n    statusCode,\r\n    headers: {\r\n      \"content-type\": \"application/json\",\r\n      \"access-control-allow-origin\": \"*\",\r\n      \"access-control-allow-methods\": \"OPTIONS,POST\",\r\n      \"access-control-allow-headers\": \"*\",\r\n    },\r\n    body: JSON.stringify(body),\r\n  };\r\n}\r\n\r\nfunction getHttpMethod(event: any): string | undefined {\r\n  // HTTP API v2\r\n  const m2 = event?.requestContext?.http?.method;\r\n  if (m2) return String(m2).toUpperCase();\r\n  // REST API v1\r\n  const m1 = event?.requestContext?.httpMethod;\r\n  if (m1) return String(m1).toUpperCase();\r\n  // fallback\r\n  const mf = event?.httpMethod;\r\n  if (mf) return String(mf).toUpperCase();\r\n  return undefined;\r\n}\r\n\r\nfunction safeJsonParse(s: any): any {\r\n  if (typeof s !== \"string\") return s ?? {};\r\n  try {\r\n    return JSON.parse(s);\r\n  } catch {\r\n    return {};\r\n  }\r\n}\r\n\r\nfunction isConditionalCheckFailed(err: any) {\r\n  return err?.name === \"ConditionalCheckFailedException\";\r\n}\r\n\r\nfunction isTaskTokenInvalidOrClosed(err: any) {\r\n  const name = String(err?.name || \"\");\r\n  const msg = String(err?.message || \"\").toLowerCase();\r\n\r\n  // Common SFN responses when a task token can\u2019t be used anymore\r\n  return (\r\n    name.includes(\"TaskTimedOut\") ||\r\n    name.includes(\"InvalidToken\") ||\r\n    name.includes(\"TaskDoesNotExist\") ||\r\n    name.includes(\"ExecutionDoesNotExist\") ||\r\n    msg.includes(\"invalid token\") ||\r\n    msg.includes(\"task does not exist\") ||\r\n    msg.includes(\"timed out\")\r\n  );\r\n}\r\n\r\nasync function emit(detailType: string, detail: any) {\r\n  try {\r\n    await eb.send(\r\n      new PutEventsCommand({\r\n        Entries: [\r\n          {\r\n            Source: \"stylingadventures.closet\",\r\n            DetailType: detailType,\r\n            Detail: JSON.stringify(detail),\r\n          },\r\n        ],\r\n      }),\r\n    );\r\n  } catch (err) {\r\n    console.warn(\"[approve] EventBridge emit failed:\", err);\r\n  }\r\n}\r\n\r\nasync function notify(subject: string, message: string, detail: any) {\r\n  if (!NOTIFY_TOPIC_ARN) return;\r\n  try {\r\n    await sns.send(\r\n      new PublishCommand({\r\n        TopicArn: NOTIFY_TOPIC_ARN,\r\n        Subject: subject,\r\n        Message: `${message}\\n\\n${JSON.stringify(detail, null, 2)}`,\r\n      }),\r\n    );\r\n  } catch (err) {\r\n    console.warn(\"[approve] SNS publish failed:\", err);\r\n  }\r\n}\r\n\r\nasync function audit(action: string, approvalId: string, detail: any) {\r\n  const ts = new Date();\r\n  try {\r\n    await ddb.send(\r\n      new PutCommand({\r\n        TableName: AUDIT_TABLE_NAME,\r\n        Item: {\r\n          pk: `APPROVAL#${approvalId}`,\r\n          sk: `TS#${ts.toISOString()}`,\r\n          action,\r\n          approvalId,\r\n          at: ts.toISOString(),\r\n          detail,\r\n        },\r\n      }),\r\n    );\r\n  } catch (err) {\r\n    console.warn(\"[approve] audit write failed:\", err);\r\n  }\r\n}\r\n\r\nexport const handler = async (event: any) => {\r\n  // CORS preflight\r\n  const method = getHttpMethod(event);\r\n  if (method === \"OPTIONS\") return response(200, { ok: true });\r\n\r\n  try {\r\n    const body = safeJsonParse(event?.body);\r\n\r\n    const approvalId = body?.approvalId;\r\n    const decision = body?.decision;\r\n    const reason =\r\n      body?.reason ??\r\n      (decision === \"APPROVE\" ? \"Approved by admin\" : \"Rejected by admin\");\r\n\r\n    if (!approvalId || !decision) {\r\n      return response(400, { message: \"Missing approvalId or decision\" });\r\n    }\r\n    if (decision !== \"APPROVE\" && decision !== \"REJECT\") {\r\n      return response(400, { message: \"decision must be APPROVE or REJECT\" });\r\n    }\r\n\r\n    const pk = `ITEM#${approvalId}`;\r\n    const sk = \"META\";\r\n\r\n    const { Item } = await ddb.send(\r\n      new GetCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: { [PK_NAME]: pk, [SK_NAME]: sk },\r\n      }),\r\n    );\r\n\r\n    if (!Item) return response(404, { message: \"Item not found\" });\r\n\r\n    // Idempotency: safe replay\r\n    if (Item.status !== \"PENDING\") {\r\n      return response(200, {\r\n        ok: true,\r\n        idempotent: true,\r\n        approvalId,\r\n        status: Item.status,\r\n      });\r\n    }\r\n\r\n    const taskToken = Item.taskToken as string | undefined;\r\n    if (!taskToken) {\r\n      return response(409, {\r\n        message: \"Missing taskToken (NotifyAdminFn not run yet)\",\r\n      });\r\n    }\r\n\r\n    const now = new Date().toISOString();\r\n    const newStatus = decision === \"APPROVE\" ? \"APPROVED\" : \"REJECTED\";\r\n\r\n    // 1) Resume Step Functions (Choice routes using decision)\r\n    // If token is already closed/invalid, we still finalize DynamoDB for convergence.\r\n    let sfnOk = true;\r\n    try {\r\n      await sfn.send(\r\n        new SendTaskSuccessCommand({\r\n          taskToken,\r\n          output: JSON.stringify({ decision, reason }),\r\n        }),\r\n      );\r\n    } catch (err: any) {\r\n      sfnOk = false;\r\n      if (isTaskTokenInvalidOrClosed(err)) {\r\n        console.warn(\"[approve] task token already closed/invalid; continuing\", {\r\n          approvalId,\r\n          err: err?.name || err,\r\n        });\r\n        await audit(\"ADMIN_DECISION_TOKEN_CLOSED\", approvalId, {\r\n          approvalId,\r\n          decision,\r\n          reason,\r\n          at: now,\r\n          error: String(err?.message || err),\r\n        });\r\n      } else {\r\n        console.error(\"[approve] SendTaskSuccess failed\", err);\r\n        await audit(\"ADMIN_DECISION_SFN_ERROR\", approvalId, {\r\n          approvalId,\r\n          decision,\r\n          reason,\r\n          at: now,\r\n          error: String(err?.message || err),\r\n        });\r\n        // still continue to DDB update\r\n      }\r\n    }\r\n\r\n    // 2) Race-safe conditional update (prevents double-submit races)\r\n    try {\r\n      await ddb.send(\r\n        new UpdateCommand({\r\n          TableName: TABLE_NAME,\r\n          Key: { [PK_NAME]: pk, [SK_NAME]: sk },\r\n          ConditionExpression: \"#s = :pending\",\r\n          UpdateExpression: `\r\n            SET #s = :s,\r\n                decidedAt = :t,\r\n                updatedAt = :t\r\n            REMOVE taskToken, taskTokenExpiresAt\r\n          `,\r\n          ExpressionAttributeNames: { \"#s\": \"status\" },\r\n          ExpressionAttributeValues: {\r\n            \":pending\": \"PENDING\",\r\n            \":s\": newStatus,\r\n            \":t\": now,\r\n          },\r\n        }),\r\n      );\r\n    } catch (err: any) {\r\n      if (isConditionalCheckFailed(err)) {\r\n        return response(200, { ok: true, idempotent: true, approvalId });\r\n      }\r\n      throw err;\r\n    }\r\n\r\n    // 3) Audit + events + notifications (best-effort)\r\n    await audit(decision === \"APPROVE\" ? \"ADMIN_APPROVE\" : \"ADMIN_REJECT\", approvalId, {\r\n      approvalId,\r\n      decision,\r\n      reason,\r\n      decidedAt: now,\r\n      sfnOk,\r\n    });\r\n\r\n    await emit(decision === \"APPROVE\" ? \"ClosetItemApproved\" : \"ClosetItemRejected\", {\r\n      approvalId,\r\n      decision,\r\n      reason,\r\n      decidedAt: now,\r\n      sfnOk,\r\n    });\r\n\r\n    await notify(\r\n      \"Closet approval decision\",\r\n      `${decision} for ${approvalId}`,\r\n      { approvalId, decision, reason, decidedAt: now, sfnOk },\r\n    );\r\n\r\n    return response(200, { ok: true, approvalId, status: newStatus, sfnOk });\r\n  } catch (err: any) {\r\n    console.error(\"[approve] error:\", err);\r\n\r\n    if (isConditionalCheckFailed(err)) {\r\n      return response(200, { ok: true, idempotent: true });\r\n    }\r\n\r\n    return response(500, { message: \"Internal error\" });\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["approve_closet_upload_exports", "__export", "handler", "__toCommonJS", "import_client_sfn", "import_client_dynamodb", "import_lib_dynamodb", "import_client_eventbridge", "import_client_sns", "sfn", "ddb", "eb", "sns", "TABLE_NAME", "AUDIT_TABLE_NAME", "PK_NAME", "SK_NAME", "NOTIFY_TOPIC_ARN", "response", "statusCode", "body", "getHttpMethod", "event", "m2", "m1", "mf", "safeJsonParse", "s", "isConditionalCheckFailed", "err", "isTaskTokenInvalidOrClosed", "name", "msg", "emit", "detailType", "detail", "notify", "subject", "message", "audit", "action", "approvalId", "ts", "decision", "reason", "pk", "sk", "Item", "taskToken", "now", "newStatus", "sfnOk"]
}
