"use strict";var l=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var T=Object.prototype.hasOwnProperty;var S=(t,n)=>{for(var e in n)l(t,e,{get:n[e],enumerable:!0})},w=(t,n,e,u)=>{if(n&&typeof n=="object"||typeof n=="function")for(let i of P(n))!T.call(t,i)&&i!==e&&l(t,i,{get:()=>n[i],enumerable:!(u=I(n,i))||u.enumerable});return t};var k=t=>w(l({},"__esModule",{value:!0}),t);var N={};S(N,{handler:()=>R});module.exports=k(N);var c=require("@aws-sdk/client-s3"),O=require("@aws-sdk/s3-request-presigner"),f=process.env.BUCKET,C=process.env.WEB_ORIGIN??"https://stylingadventures.com",B=(process.env.ALLOWED_ORIGINS??C).split(",").map(t=>t.trim()).filter(Boolean),b=process.env.THUMBS_CDN,m=process.env.DISABLE_UPLOAD_AUTH==="true"||process.env.DISABLE_UPLOAD_AUTH==="1",p=new c.S3Client({});function U(t){let n=t.headers||{},e=(n.origin||n.Origin||"").trim();return e&&B.includes(e)?e:C}function D(t){return{"Content-Type":"application/json","Access-Control-Allow-Origin":t,"Access-Control-Allow-Headers":"Authorization,Content-Type,X-Amz-Date,X-Api-Key,X-Amz-Security-Token","Access-Control-Allow-Methods":"GET,POST,DELETE,OPTIONS","Access-Control-Allow-Credentials":"true",Vary:"Origin"}}function L(t){return(t.requestContext?.http?.method||t.httpMethod||"GET").toUpperCase()}function x(t){return t.rawPath||t.path||"/"}function G(t){return t.requestContext?.authorizer?.jwt?.claims||t.requestContext?.authorizer?.claims||{}}function A(t){if(!t.body)return;let n=t.isBase64Encoded?Buffer.from(t.body,"base64").toString():t.body;try{return JSON.parse(n)}catch{return}}function g(t,n,e={}){return{statusCode:200,headers:{...t,...e},body:JSON.stringify(n)}}function a(t,n,e){return{statusCode:n,headers:t,body:JSON.stringify({message:e})}}var R=async t=>{let n=U(t),e=D(n),u=L(t),i=x(t),y=G(t).sub;if(u==="OPTIONS")return{statusCode:204,headers:e,body:""};try{if(u==="POST"&&/\/presign$/.test(i)){let o=A(t);if(!o)return a(e,400,"Missing body");let{key:r,contentType:s,kind:d}=o;if(!r||typeof r!="string")return a(e,400,'Invalid "key"');if(!s||typeof s!="string")return a(e,400,'Invalid "contentType"');if(r.includes(".."))return a(e,400,"Illegal key");r=r.replace(/^\/+/,""),d==="closet"?r.startsWith("closet/")||(r=`closet/${r}`):y&&!r.startsWith("users/")&&(r=`users/${y}/${r}`);let E=new c.PutObjectCommand({Bucket:f,Key:r,ContentType:s}),h=await(0,O.getSignedUrl)(p,E,{expiresIn:900});return g(e,{url:h,key:r,thumbsCdn:b??void 0})}if(u==="GET"&&/\/list$/.test(i)){let o={Bucket:f};!m&&y&&(o.Prefix=`users/${y}/`);let s=(await p.send(new c.ListObjectsV2Command(o))).Contents?.map(d=>({key:d.Key,size:d.Size,lastModified:d.LastModified?.toISOString?.()}))??[];return g(e,{items:s})}if(u==="DELETE"&&/\/delete$/.test(i)){let o=A(t),r=t.queryStringParameters?.key?decodeURIComponent(t.queryStringParameters.key):void 0,s=o?.key??r;return!s||typeof s!="string"?a(e,400,'Invalid "key"'):!m&&y&&!s.startsWith(`users/${y}/`)?a(e,403,"Forbidden"):(await p.send(new c.DeleteObjectCommand({Bucket:f,Key:s})),g(e,{deleted:s}))}return a(e,404,"Not Found")}catch(o){return console.error("presign handler error",o),a(e,500,o?.message??"Server error")}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
