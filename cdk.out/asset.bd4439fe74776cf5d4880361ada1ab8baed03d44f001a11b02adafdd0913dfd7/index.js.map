{
  "version": 3,
  "sources": ["../../lambda/prime/episode-components.ts", "../../lambda/prime/utils/auth.ts"],
  "sourcesContent": ["// lambda/prime/episode-components.ts\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport { DynamoDBDocumentClient, PutCommand } from \"@aws-sdk/lib-dynamodb\";\r\nimport { assertInternalUser } from \"./utils/auth\";\r\n\r\nconst client = new DynamoDBClient({});\r\nconst ddb = DynamoDBDocumentClient.from(client);\r\n\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\nconst ADMIN_GROUP_NAME = process.env.ADMIN_GROUP_NAME ?? \"admin\";\r\nconst CREATOR_GROUP_NAME = process.env.CREATOR_GROUP_NAME ?? \"creator\";\r\n\r\nexport const handler = async (event: any) => {\r\n  // Expect to be called via AppSync or StepFunctions with identity context\r\n  const identity = event.identity ?? event.requestContext?.identity;\r\n  assertInternalUser(identity, [ADMIN_GROUP_NAME, CREATOR_GROUP_NAME]);\r\n\r\n  const episodeId = event.episodeId ?? `ep_${Date.now()}`;\r\n\r\n  // TODO: generate modular parts; for now just stub a record\r\n  const pk = `EPISODE#${episodeId}`;\r\n  const sk = `COMPONENTS#v1`;\r\n\r\n  await ddb.send(\r\n    new PutCommand({\r\n      TableName: TABLE_NAME,\r\n      Item: {\r\n        pk,\r\n        sk,\r\n        type: \"episode-components\",\r\n        episodeId,\r\n        components: {\r\n          invite: {},\r\n          envelope: {},\r\n          closet: {},\r\n          outfit: {},\r\n          dialogue: [],\r\n          sideQuests: [],\r\n          coins: {},\r\n          locations: [],\r\n          photoshoots: [],\r\n        },\r\n        createdAt: new Date().toISOString(),\r\n      },\r\n    }),\r\n  );\r\n\r\n  return {\r\n    episodeId,\r\n    pk,\r\n    sk,\r\n  };\r\n};\r\n", "// lambda/prime/utils/auth.ts\r\nexport function assertInternalUser(identity: any, allowedGroups: string[]) {\r\n  const claims = identity?.claims ?? {};\r\n  const groups: string[] =\r\n    claims[\"cognito:groups\"] ||\r\n    claims[\"cognito:groups:custom\"] ||\r\n    [];\r\n\r\n  const asArray = Array.isArray(groups) ? groups : `${groups}`.split(\",\");\r\n  const ok = asArray.some((g) => allowedGroups.includes(g.trim()));\r\n\r\n  if (!ok) {\r\n    const msg = \"Forbidden: internal studio/admin access only\";\r\n    console.warn(msg, { groups: asArray });\r\n    throw new Error(msg);\r\n  }\r\n}\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GACA,IAAAI,EAA+B,oCAC/BC,EAAmD,iCCD5C,SAASC,EAAmBC,EAAeC,EAAyB,CACzE,IAAMC,EAASF,GAAU,QAAU,CAAC,EAC9BG,EACJD,EAAO,gBAAgB,GACvBA,EAAO,uBAAuB,GAC9B,CAAC,EAEGE,EAAU,MAAM,QAAQD,CAAM,EAAIA,EAAS,GAAGA,CAAM,GAAG,MAAM,GAAG,EAGtE,GAAI,CAFOC,EAAQ,KAAMC,GAAMJ,EAAc,SAASI,EAAE,KAAK,CAAC,CAAC,EAEtD,CACP,IAAMC,EAAM,+CACZ,cAAQ,KAAKA,EAAK,CAAE,OAAQF,CAAQ,CAAC,EAC/B,IAAI,MAAME,CAAG,CACrB,CACF,CDXA,IAAMC,EAAS,IAAI,iBAAe,CAAC,CAAC,EAC9BC,EAAM,yBAAuB,KAAKD,CAAM,EAExCE,EAAa,QAAQ,IAAI,WACzBC,EAAmB,QAAQ,IAAI,kBAAoB,QACnDC,EAAqB,QAAQ,IAAI,oBAAsB,UAEhDC,EAAU,MAAOC,GAAe,CAE3C,IAAMC,EAAWD,EAAM,UAAYA,EAAM,gBAAgB,SACzDE,EAAmBD,EAAU,CAACJ,EAAkBC,CAAkB,CAAC,EAEnE,IAAMK,EAAYH,EAAM,WAAa,MAAM,KAAK,IAAI,CAAC,GAG/CI,EAAK,WAAWD,CAAS,GACzBE,EAAK,gBAEX,aAAMV,EAAI,KACR,IAAI,aAAW,CACb,UAAWC,EACX,KAAM,CACJ,GAAAQ,EACA,GAAAC,EACA,KAAM,qBACN,UAAAF,EACA,WAAY,CACV,OAAQ,CAAC,EACT,SAAU,CAAC,EACX,OAAQ,CAAC,EACT,OAAQ,CAAC,EACT,SAAU,CAAC,EACX,WAAY,CAAC,EACb,MAAO,CAAC,EACR,UAAW,CAAC,EACZ,YAAa,CAAC,CAChB,EACA,UAAW,IAAI,KAAK,EAAE,YAAY,CACpC,CACF,CAAC,CACH,EAEO,CACL,UAAAA,EACA,GAAAC,EACA,GAAAC,CACF,CACF",
  "names": ["episode_components_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "assertInternalUser", "identity", "allowedGroups", "claims", "groups", "asArray", "g", "msg", "client", "ddb", "TABLE_NAME", "ADMIN_GROUP_NAME", "CREATOR_GROUP_NAME", "handler", "event", "identity", "assertInternalUser", "episodeId", "pk", "sk"]
}
