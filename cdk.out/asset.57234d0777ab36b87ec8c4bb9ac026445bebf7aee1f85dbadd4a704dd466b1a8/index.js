"use strict";var f=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var k=Object.prototype.hasOwnProperty;var B=(e,r)=>{for(var t in r)f(e,t,{get:r[t],enumerable:!0})},L=(e,r,t,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let a of x(r))!k.call(e,a)&&a!==t&&f(e,a,{get:()=>r[a],enumerable:!(n=I(r,a))||n.enumerable});return e};var U=e=>L(f({},"__esModule",{value:!0}),e);var q={};B(q,{handler:()=>H});module.exports=U(q);var i=require("@aws-sdk/client-s3"),d=require("@aws-sdk/s3-request-presigner"),p=new i.S3Client({region:process.env.AWS_REGION||"us-east-1",forcePathStyle:!0}),l=process.env.BUCKET,S=process.env.DISABLE_UPLOAD_AUTH==="true"||process.env.DISABLE_UPLOAD_AUTH==="1",M=["authorization","Authorization","Content-Type","X-Amz-Date","X-Api-Key","X-Amz-Security-Token"].join(",");function _(e){return String(e?.headers?.origin||e?.headers?.Origin||"").replace(/\/+$/,"")}function h(e){return{"Content-Type":"application/json","Access-Control-Allow-Origin":_(e)||"*","Access-Control-Allow-Headers":M,"Access-Control-Allow-Methods":"GET,POST,DELETE,OPTIONS","Access-Control-Allow-Credentials":"true","Access-Control-Expose-Headers":"ETag,Content-Type,Content-Length,Last-Modified,Accept-Ranges",Vary:"Origin, Access-Control-Request-Headers, Access-Control-Request-Method"}}function m(e,r,t={}){return{statusCode:200,headers:{...h(e),"Cache-Control":"no-store",...t},body:JSON.stringify(r)}}function D(e){return{statusCode:204,headers:h(e),body:""}}function y(e,r,t){return console.error("[presign] error",r,t),{statusCode:r,headers:h(e),body:JSON.stringify({message:t})}}var G=e=>e.httpMethod??e.requestContext?.http?.method??"GET",R=e=>e.requestContext?.authorizer?.claims??e.requestContext?.authorizer?.jwt?.claims??{},K=e=>{let r=e.body??"";if(!r)return{};let t=e.isBase64Encoded&&typeof r=="string"?Buffer.from(r,"base64").toString():r;try{return typeof t=="string"?JSON.parse(t):t}catch{return{}}};function P(e,r){let t=String(r||"").replace(/\.\./g,"").replace(/^[/\\]+/,"");if(t.startsWith("closet/"))return t;let n=t.startsWith(`users/${e}/`),a=/^users\/[^/]+\//.test(t)&&!n;return n?t:`users/${e}/${a?t.replace(/^users\/[^/]+\//,""):t}`}function N(e){let r=e?.["cognito:groups"];return Array.isArray(r)?r:typeof r=="string"?r.split(",").map(t=>t.trim()).filter(Boolean):[]}var H=async e=>{let r=G(e);if(r==="OPTIONS")return D(e);try{let t="",n={};if(S)t="dev-anon",n={},console.log("[presign] DISABLE_UPLOAD_AUTH=true, using sub",t);else if(n=R(e),t=n?.sub||"",!t)return y(e,401,"Not authorized");let a=S?[]:N(n),w=Number(process.env.BASE_UPLOAD_LIMIT_MB||"50"),C=Number(process.env.BESTIE_UPLOAD_LIMIT_MB||"200"),A=a.includes("BESTIE")?C:w;if(r==="POST"){let s=K(e);console.log("[presign] POST body",s);let o=String(s.key||""),u=String(s.contentType||"application/octet-stream");if(!o)return y(e,400,"Missing 'key'");let g=Number(s.contentLength||0);if(g>0&&g>A*1024*1024)return y(e,413,`Max upload ${A} MB for your tier`);let c=P(t,o),T=new i.PutObjectCommand({Bucket:l,Key:c,ContentType:u}),O=new i.GetObjectCommand({Bucket:l,Key:c}),E=await(0,d.getSignedUrl)(p,T,{expiresIn:900}),b=await(0,d.getSignedUrl)(p,O,{expiresIn:300});return m(e,{bucket:l,key:c,method:"PUT",url:E,headers:{"Content-Type":u},putUrl:E,getUrl:b,maxBytesAllowed:A*1024*1024})}if(r==="GET"){let s=String(e?.queryStringParameters?.key??e.pathParameters?.key??"");if(!s)return y(e,400,"Missing 'key'");let o=String(s||"").replace(/\.\./g,"").replace(/^[/\\]+/,""),u=o;!o.startsWith("closet/")&&!/^users\/[^/]+\//.test(o)&&(u=P(t,o));let g=new i.GetObjectCommand({Bucket:l,Key:u}),c=await(0,d.getSignedUrl)(p,g,{expiresIn:300});return m(e,{bucket:l,key:u,getUrl:c,url:c,publicUrl:c})}if(r==="DELETE"){let s=String(e?.queryStringParameters?.key??e.pathParameters?.key??"");if(!s)return y(e,400,"Missing 'key'");let o=P(t,s);return await p.send(new i.DeleteObjectCommand({Bucket:l,Key:o})),m(e,{deleted:!0,key:o})}return y(e,405,"Method Not Allowed")}catch(t){return console.error("[presign] unhandled error",t),y(e,500,t?.message??String(t))}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
