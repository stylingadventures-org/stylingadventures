"use strict";var c=Object.defineProperty;var l=Object.getOwnPropertyDescriptor;var w=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var f=(e,t)=>{for(var r in t)c(e,r,{get:t[r],enumerable:!0})},I=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of w(t))!N.call(e,s)&&s!==r&&c(e,s,{get:()=>t[s],enumerable:!(n=l(t,s))||n.enumerable});return e};var y=e=>I(c({},"__esModule",{value:!0}),e);var C={};f(C,{handler:()=>b});module.exports=y(C);var m=require("@aws-sdk/client-dynamodb"),i=require("@aws-sdk/lib-dynamodb"),a=i.DynamoDBDocumentClient.from(new m.DynamoDBClient({})),d=process.env.CLOSET_TABLE||process.env.TABLE_NAME||(()=>{throw new Error("Missing env CLOSET_TABLE/TABLE_NAME")})(),T=process.env.STATUS_GSI||"gsi2",E=()=>new Date().toISOString();function A(e){let t=e?.claims?.["cognito:groups"]??[];return Array.isArray(t)&&(t.includes("ADMIN")||t.includes("COLLAB"))}var p=e=>({pk:`ITEM#${e}`,sk:"META"});function k(e){if(!e)return e;let t=typeof e?.gsi1pk=="string"&&e.gsi1pk.startsWith("OWNER#")?e.gsi1pk.slice(6):void 0,r=e.userId??e.ownerSub??t??"",n=e.ownerSub??r??"";return n===""&&(n="UNKNOWN"),{...e,userId:r,ownerSub:n}}function g(e){let t=k(e),r=t?.id||"";!r&&typeof t?.pk=="string"&&t.pk.startsWith("ITEM#")&&(r=t.pk.slice(5));let n=String(t?.userId||""),s=String(t?.ownerSub||"UNKNOWN");return{id:String(r||""),userId:n,ownerSub:s,title:String(t?.title||""),status:t?.status||"PENDING",mediaKey:String(t?.mediaKey||""),createdAt:String(t?.createdAt||t?.gsi2sk||E()),updatedAt:String(t?.updatedAt||t?.createdAt||E()),reason:t?.reason?String(t.reason):""}}var b=async e=>{let t=e.info.fieldName,r=e.identity;if(t==="adminListPending")try{return((await a.send(new i.QueryCommand({TableName:d,IndexName:T,KeyConditionExpression:"#gpk = :pk",ExpressionAttributeNames:{"#gpk":"gsi2pk"},ExpressionAttributeValues:{":pk":"STATUS#PENDING"},ScanIndexForward:!1,Limit:100}))).Items??[]).map(g).filter(o=>o.id&&o.userId&&o.ownerSub&&o.createdAt)}catch(n){return console.error("adminListPending error:",n),[]}if(t==="adminApproveItem"){if(!A(r))throw new Error("Not authorized");let n=String(e.arguments?.id||"");if(!n)throw new Error("id is required");if(!(await a.send(new i.GetCommand({TableName:d,Key:p(n)}))).Item)throw new Error("Item not found");let o=E(),u=await a.send(new i.UpdateCommand({TableName:d,Key:p(n),UpdateExpression:"SET #st = :approved, #updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE #reason",ExpressionAttributeNames:{"#st":"status","#updatedAt":"updatedAt","#reason":"reason"},ExpressionAttributeValues:{":approved":"APPROVED",":u":o,":g2pk":"STATUS#APPROVED",":g2sk":o,":pending":"PENDING"},ConditionExpression:"#st = :pending",ReturnValues:"ALL_NEW"}));return g({id:n,...u.Attributes||{}})}if(t==="adminRejectItem"){if(!A(r))throw new Error("Not authorized");let n=String(e.arguments?.id||""),s=e.arguments?.reason??"";if(!n)throw new Error("id is required");if(!(await a.send(new i.GetCommand({TableName:d,Key:p(n)}))).Item)throw new Error("Item not found");let u=E(),S=await a.send(new i.UpdateCommand({TableName:d,Key:p(n),UpdateExpression:"SET #st = :rejected, #updatedAt = :u, #reason = :rsn, gsi2pk = :g2pk, gsi2sk = :g2sk",ExpressionAttributeNames:{"#st":"status","#updatedAt":"updatedAt","#reason":"reason"},ExpressionAttributeValues:{":rejected":"REJECTED",":u":u,":rsn":s,":g2pk":"STATUS#REJECTED",":g2sk":u,":pending":"PENDING"},ConditionExpression:"#st = :pending",ReturnValues:"ALL_NEW"}));return g({id:n,...S.Attributes||{}})}throw new Error(`Unhandled field: ${t}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
