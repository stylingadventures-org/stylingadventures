{
  "version": 3,
  "sources": ["../../lambda/closet/admin.ts"],
  "sourcesContent": ["// lambda/closet/admin.ts\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  QueryCommand,\r\n  UpdateCommand,\r\n  GetCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\nimport type { AppSyncResolverEvent, AppSyncIdentityCognito } from \"aws-lambda\";\r\n\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}));\r\n\r\nconst TABLE =\r\n  process.env.CLOSET_TABLE ||\r\n  process.env.TABLE_NAME ||\r\n  (() => {\r\n    throw new Error(\"Missing env CLOSET_TABLE/TABLE_NAME\");\r\n  })();\r\n\r\nconst STATUS_GSI = process.env.STATUS_GSI || \"gsi2\";\r\ntype ClosetStatus = \"PENDING\" | \"APPROVED\" | \"REJECTED\" | \"PUBLISHED\";\r\nconst now = () => new Date().toISOString();\r\n\r\nfunction isPrivileged(id?: AppSyncIdentityCognito) {\r\n  const groups = ((id as any)?.claims?.[\"cognito:groups\"] as string[] | undefined) ?? [];\r\n  return Array.isArray(groups) && (groups.includes(\"ADMIN\") || groups.includes(\"COLLAB\"));\r\n}\r\n\r\n// Keys are pk = ITEM#<id>, sk = META\r\nconst itemKey = (id: string) => ({ pk: `ITEM#${id}`, sk: \"META\" });\r\n\r\n/**\r\n * Ensure we always have a stable userId and a non-empty ownerSub.\r\n * - userId = item.userId ?? item.ownerSub ?? OWNER#<sub> (from gsi1pk) ?? \"\"\r\n * - ownerSub = item.ownerSub ?? userId, and if still \"\", set to \"UNKNOWN\"\r\n */\r\nfunction materializeUserId(item: any) {\r\n  if (!item) return item;\r\n\r\n  const fromGsi1 =\r\n    typeof item?.gsi1pk === \"string\" && item.gsi1pk.startsWith(\"OWNER#\")\r\n      ? item.gsi1pk.slice(\"OWNER#\".length)\r\n      : undefined;\r\n\r\n  const userId = item.userId ?? item.ownerSub ?? fromGsi1 ?? \"\";\r\n\r\n  let ownerSub = item.ownerSub ?? userId ?? \"\";\r\n  if (ownerSub === \"\") ownerSub = \"UNKNOWN\";\r\n\r\n  return {\r\n    ...item,\r\n    userId,\r\n    ownerSub,\r\n  };\r\n}\r\n\r\n/**\r\n * Map a raw Dynamo item to the GraphQL ClosetItem shape.\r\n * Ensures required non-nullable fields are present and stringified.\r\n * Includes ownerSub: String! (non-empty; \"UNKNOWN\" worst-case).\r\n */\r\nfunction toClosetItem(raw: any) {\r\n  const withIds = materializeUserId(raw);\r\n\r\n  // id: prefer explicit id, else derive from pk/sk\r\n  let id = withIds?.id || \"\";\r\n  if (!id && typeof withIds?.pk === \"string\" && withIds.pk.startsWith(\"ITEM#\")) {\r\n    id = withIds.pk.slice(\"ITEM#\".length);\r\n  }\r\n\r\n  // Stable fields\r\n  const userId = String(withIds?.userId || \"\");\r\n  const ownerSub = String(withIds?.ownerSub || \"UNKNOWN\");\r\n\r\n  return {\r\n    id: String(id || \"\"),\r\n    userId,\r\n    ownerSub,\r\n    title: String(withIds?.title || \"\"),\r\n    status: (withIds?.status as ClosetStatus) || \"PENDING\",\r\n    mediaKey: String(withIds?.mediaKey || \"\"),\r\n    createdAt: String(withIds?.createdAt || withIds?.gsi2sk || now()),\r\n    updatedAt: String(withIds?.updatedAt || withIds?.createdAt || now()),\r\n    // 'reason' might not exist; keep it as empty string if absent\r\n    reason: withIds?.reason ? String(withIds.reason) : \"\",\r\n  };\r\n}\r\n\r\nexport const handler = async (event: AppSyncResolverEvent<any>) => {\r\n  const field = event.info.fieldName;\r\n  const ident = event.identity as AppSyncIdentityCognito | undefined;\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  // Admin: list pending items \u2014 MUST NEVER RETURN null\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (field === \"adminListPending\") {\r\n    try {\r\n      const out = await ddb.send(\r\n        new QueryCommand({\r\n          TableName: TABLE,\r\n          IndexName: STATUS_GSI, // \"gsi2\"\r\n          KeyConditionExpression: \"#gpk = :pk\",\r\n          ExpressionAttributeNames: { \"#gpk\": \"gsi2pk\" },\r\n          ExpressionAttributeValues: { \":pk\": \"STATUS#PENDING\" },\r\n          ScanIndexForward: false,\r\n          Limit: 100,\r\n        })\r\n      );\r\n\r\n      const items = (out.Items ?? [])\r\n        .map(toClosetItem)\r\n        // ensure non-nullable invariants\r\n        .filter((i) => i.id && i.userId && i.ownerSub && i.createdAt);\r\n\r\n      return items; // [] is fine; NEVER return null\r\n    } catch (err) {\r\n      console.error(\"adminListPending error:\", err);\r\n      return []; // protect [ClosetItem!]!\r\n    }\r\n  }\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  // Admin: approve item\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (field === \"adminApproveItem\") {\r\n    if (!isPrivileged(ident)) throw new Error(\"Not authorized\");\r\n    const id = String(event.arguments?.id || \"\");\r\n    if (!id) throw new Error(\"id is required\");\r\n\r\n    const cur = await ddb.send(new GetCommand({ TableName: TABLE, Key: itemKey(id) }));\r\n    if (!cur.Item) throw new Error(\"Item not found\");\r\n\r\n    const updatedAt = now();\r\n\r\n    const out = await ddb.send(\r\n      new UpdateCommand({\r\n        TableName: TABLE,\r\n        Key: itemKey(id),\r\n        UpdateExpression:\r\n          \"SET #st = :approved, #updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE #reason\",\r\n        ExpressionAttributeNames: {\r\n          \"#st\": \"status\",\r\n          \"#updatedAt\": \"updatedAt\",\r\n          \"#reason\": \"reason\",\r\n        },\r\n        ExpressionAttributeValues: {\r\n          \":approved\": \"APPROVED\",\r\n          \":u\": updatedAt,\r\n          \":g2pk\": \"STATUS#APPROVED\",\r\n          \":g2sk\": updatedAt,\r\n          \":pending\": \"PENDING\",\r\n        },\r\n        ConditionExpression: \"#st = :pending\",\r\n        ReturnValues: \"ALL_NEW\",\r\n      })\r\n    );\r\n\r\n    // Merge id in case it's not stored as an attribute\r\n    return toClosetItem({ id, ...(out.Attributes || {}) });\r\n  }\r\n\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  // Admin: reject item\r\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n  if (field === \"adminRejectItem\") {\r\n    if (!isPrivileged(ident)) throw new Error(\"Not authorized\");\r\n    const id = String(event.arguments?.id || \"\");\r\n    const reason = (event.arguments?.reason as string | undefined) ?? \"\";\r\n    if (!id) throw new Error(\"id is required\");\r\n\r\n    const cur = await ddb.send(new GetCommand({ TableName: TABLE, Key: itemKey(id) }));\r\n    if (!cur.Item) throw new Error(\"Item not found\");\r\n\r\n    const updatedAt = now();\r\n\r\n    const out = await ddb.send(\r\n      new UpdateCommand({\r\n        TableName: TABLE,\r\n        Key: itemKey(id),\r\n        UpdateExpression:\r\n          \"SET #st = :rejected, #updatedAt = :u, #reason = :rsn, gsi2pk = :g2pk, gsi2sk = :g2sk\",\r\n        ExpressionAttributeNames: {\r\n          \"#st\": \"status\",\r\n          \"#updatedAt\": \"updatedAt\",\r\n          \"#reason\": \"reason\",\r\n        },\r\n        ExpressionAttributeValues: {\r\n          \":rejected\": \"REJECTED\",\r\n          \":u\": updatedAt,\r\n          \":rsn\": reason,\r\n          \":g2pk\": \"STATUS#REJECTED\",\r\n          \":g2sk\": updatedAt,\r\n          \":pending\": \"PENDING\",\r\n        },\r\n        ConditionExpression: \"#st = :pending\",\r\n        ReturnValues: \"ALL_NEW\",\r\n      })\r\n    );\r\n\r\n    return toClosetItem({ id, ...(out.Attributes || {}) });\r\n  }\r\n\r\n  throw new Error(`Unhandled field: ${field}`);\r\n};\r\n"],
  "mappings": "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",
  "names": ["admin_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "ddb", "TABLE", "STATUS_GSI", "now", "isPrivileged", "id", "groups", "itemKey", "materializeUserId", "item", "fromGsi1", "userId", "ownerSub", "toClosetItem", "raw", "withIds", "event", "field", "ident", "i", "err", "updatedAt", "out", "reason"]
}
