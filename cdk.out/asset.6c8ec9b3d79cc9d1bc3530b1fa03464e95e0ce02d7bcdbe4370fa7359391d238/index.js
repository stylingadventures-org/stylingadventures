"use strict";var l=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var f=(t,e)=>{for(var n in e)l(t,n,{get:e[n],enumerable:!0})},A=(t,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of p(e))!w.call(t,s)&&s!==n&&l(t,s,{get:()=>e[s],enumerable:!(i=m(e,s))||i.enumerable});return t};var b=t=>A(l({},"__esModule",{value:!0}),t);var h={};f(h,{handler:()=>B});module.exports=b(h);var o=require("@aws-sdk/client-dynamodb"),c=new o.DynamoDBClient({}),d=process.env.TABLE_NAME;function E(t){let e=t?.groups||[];return e.includes("ADMIN")||e.includes("COLLAB")}async function S(t){if(!t)return!1;let e=await c.send(new o.GetItemCommand({TableName:d,Key:{pk:{S:`USER#${t}`},sk:{S:"BESTIE"}}})),n=e.Item?.active?.BOOL??!1,i=e.Item?.until?.S?new Date(e.Item.until.S):null;return!!n&&(!i||i>new Date)}async function g(t){let e=await c.send(new o.GetItemCommand({TableName:d,Key:{pk:{S:`EPISODE#${t}`},sk:{S:"META"}}}));return e.Item?{title:e.Item.title?.S??t,publishedAt:e.Item.publishedAt?.S??null,earlyHours:e.Item.earlyHours?.N?Number(e.Item.earlyHours.N):0,bestieOnly:e.Item.bestieOnly?.BOOL??!1}:t==="ep-002"||t==="ep-003"?{title:t,publishedAt:new Date(Date.now()-7200*1e3).toISOString(),earlyHours:48,bestieOnly:!1}:{title:t,publishedAt:null,earlyHours:0,bestieOnly:!1}}var B=async t=>{let{fieldName:e}=t.info;if(e!=="isEpisodeEarlyAccess")throw new Error(`Unknown field ${e}`);let n=t.arguments.id,i=t.identity;if(E(i))return{allowed:!0,reason:"Admin / collaborator override."};let r=await g(n),y=new Date,a=r.publishedAt?new Date(r.publishedAt):null,u=!!a&&r.earlyHours>0&&y.getTime()-a.getTime()<r.earlyHours*3600*1e3;return r.bestieOnly||u?await S(i?.sub)?{allowed:!0,reason:"Bestie access."}:{allowed:!1,reason:u?"Early drops are Bestie-only for a short window. Unlock with Bestie.":"This episode is Bestie-only."}:{allowed:!0,reason:null}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
