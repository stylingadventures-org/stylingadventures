{
  "version": 3,
  "sources": ["../../lambda/episodes/gate.ts"],
  "sourcesContent": ["// lambda/episodes/gate.ts\r\nimport {\r\n  DynamoDBClient,\r\n  GetItemCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport type { AppSyncIdentityCognito } from \"aws-lambda\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\nconst TABLE = process.env.TABLE_NAME!;\r\n\r\ntype AppSyncEvent = {\r\n  info: { fieldName: string };\r\n  arguments: { id: string };\r\n  identity?: (AppSyncIdentityCognito & { groups?: string[] }) | null;\r\n};\r\n\r\nfunction isAdmin(identity?: AppSyncEvent[\"identity\"]) {\r\n  const gs = identity?.groups || [];\r\n  return gs.includes(\"ADMIN\") || gs.includes(\"COLLAB\");\r\n}\r\n\r\nasync function bestieActive(userSub?: string) {\r\n  if (!userSub) return false;\r\n  const r = await ddb.send(\r\n    new GetItemCommand({\r\n      TableName: TABLE,\r\n      Key: { pk: { S: `USER#${userSub}` }, sk: { S: \"BESTIE\" } },\r\n    })\r\n  );\r\n  const active = r.Item?.active?.BOOL ?? false;\r\n  const until = r.Item?.until?.S ? new Date(r.Item.until.S) : null;\r\n  return !!active && (!until || until > new Date());\r\n}\r\n\r\nasync function loadEpisodeMeta(epId: string) {\r\n  // Meta convention:  pk=EPISODE#<id>  sk=META\r\n  const r = await ddb.send(\r\n    new GetItemCommand({\r\n      TableName: TABLE,\r\n      Key: { pk: { S: `EPISODE#${epId}` }, sk: { S: \"META\" } },\r\n    })\r\n  );\r\n\r\n  if (r.Item) {\r\n    return {\r\n      title: r.Item.title?.S ?? epId,\r\n      publishedAt: r.Item.publishedAt?.S ?? null,\r\n      earlyHours: r.Item.earlyHours?.N ? Number(r.Item.earlyHours.N) : 0,\r\n      bestieOnly: r.Item.bestieOnly?.BOOL ?? false,\r\n    };\r\n  }\r\n\r\n  // Sensible fallback so you can try it immediately without seeding data:\r\n  // Treat ep-002 and ep-003 as \"early for 48h\" unless Bestie.\r\n  if (epId === \"ep-002\" || epId === \"ep-003\") {\r\n    return {\r\n      title: epId,\r\n      publishedAt: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), // 2h ago\r\n      earlyHours: 48,\r\n      bestieOnly: false,\r\n    };\r\n  }\r\n  return { title: epId, publishedAt: null, earlyHours: 0, bestieOnly: false };\r\n}\r\n\r\nexport const handler = async (event: AppSyncEvent) => {\r\n  const { fieldName } = event.info;\r\n\r\n  if (fieldName !== \"isEpisodeEarlyAccess\") {\r\n    throw new Error(`Unknown field ${fieldName}`);\r\n  }\r\n\r\n  const epId = event.arguments.id;\r\n  const id = event.identity;\r\n  const admin = isAdmin(id);\r\n\r\n  // Admins & collabs always allowed\r\n  if (admin) return { allowed: true, reason: \"Admin / collaborator override.\" };\r\n\r\n  const meta = await loadEpisodeMeta(epId);\r\n\r\n  const now = new Date();\r\n  const publishedAt = meta.publishedAt ? new Date(meta.publishedAt) : null;\r\n  const inEarlyWindow =\r\n    !!publishedAt &&\r\n    meta.earlyHours > 0 &&\r\n    now.getTime() - publishedAt.getTime() < meta.earlyHours * 3600 * 1000;\r\n\r\n  // Gate if (bestieOnly) or (in early window)\r\n  const requiresBestie = meta.bestieOnly || inEarlyWindow;\r\n\r\n  if (!requiresBestie) {\r\n    return { allowed: true, reason: null };\r\n  }\r\n\r\n  // Require Bestie\r\n  const active = await bestieActive(id?.sub);\r\n  if (active) return { allowed: true, reason: \"Bestie access.\" };\r\n\r\n  return {\r\n    allowed: false,\r\n    reason: inEarlyWindow\r\n      ? \"Early drops are Bestie-only for a short window. Unlock with Bestie.\"\r\n      : \"This episode is Bestie-only.\",\r\n  };\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GACA,IAAAI,EAGO,oCAGDC,EAAM,IAAI,iBAAe,CAAC,CAAC,EAC3BC,EAAQ,QAAQ,IAAI,WAQ1B,SAASC,EAAQC,EAAqC,CACpD,IAAMC,EAAKD,GAAU,QAAU,CAAC,EAChC,OAAOC,EAAG,SAAS,OAAO,GAAKA,EAAG,SAAS,QAAQ,CACrD,CAEA,eAAeC,EAAaC,EAAkB,CAC5C,GAAI,CAACA,EAAS,MAAO,GACrB,IAAMC,EAAI,MAAMP,EAAI,KAClB,IAAI,iBAAe,CACjB,UAAWC,EACX,IAAK,CAAE,GAAI,CAAE,EAAG,QAAQK,CAAO,EAAG,EAAG,GAAI,CAAE,EAAG,QAAS,CAAE,CAC3D,CAAC,CACH,EACME,EAASD,EAAE,MAAM,QAAQ,MAAQ,GACjCE,EAAQF,EAAE,MAAM,OAAO,EAAI,IAAI,KAAKA,EAAE,KAAK,MAAM,CAAC,EAAI,KAC5D,MAAO,CAAC,CAACC,IAAW,CAACC,GAASA,EAAQ,IAAI,KAC5C,CAEA,eAAeC,EAAgBC,EAAc,CAE3C,IAAMJ,EAAI,MAAMP,EAAI,KAClB,IAAI,iBAAe,CACjB,UAAWC,EACX,IAAK,CAAE,GAAI,CAAE,EAAG,WAAWU,CAAI,EAAG,EAAG,GAAI,CAAE,EAAG,MAAO,CAAE,CACzD,CAAC,CACH,EAEA,OAAIJ,EAAE,KACG,CACL,MAAOA,EAAE,KAAK,OAAO,GAAKI,EAC1B,YAAaJ,EAAE,KAAK,aAAa,GAAK,KACtC,WAAYA,EAAE,KAAK,YAAY,EAAI,OAAOA,EAAE,KAAK,WAAW,CAAC,EAAI,EACjE,WAAYA,EAAE,KAAK,YAAY,MAAQ,EACzC,EAKEI,IAAS,UAAYA,IAAS,SACzB,CACL,MAAOA,EACP,YAAa,IAAI,KAAK,KAAK,IAAI,EAAI,KAAc,GAAI,EAAE,YAAY,EACnE,WAAY,GACZ,WAAY,EACd,EAEK,CAAE,MAAOA,EAAM,YAAa,KAAM,WAAY,EAAG,WAAY,EAAM,CAC5E,CAEO,IAAMd,EAAU,MAAOe,GAAwB,CACpD,GAAM,CAAE,UAAAC,CAAU,EAAID,EAAM,KAE5B,GAAIC,IAAc,uBAChB,MAAM,IAAI,MAAM,iBAAiBA,CAAS,EAAE,EAG9C,IAAMF,EAAOC,EAAM,UAAU,GACvBE,EAAKF,EAAM,SAIjB,GAHcV,EAAQY,CAAE,EAGb,MAAO,CAAE,QAAS,GAAM,OAAQ,gCAAiC,EAE5E,IAAMC,EAAO,MAAML,EAAgBC,CAAI,EAEjCK,EAAM,IAAI,KACVC,EAAcF,EAAK,YAAc,IAAI,KAAKA,EAAK,WAAW,EAAI,KAC9DG,EACJ,CAAC,CAACD,GACFF,EAAK,WAAa,GAClBC,EAAI,QAAQ,EAAIC,EAAY,QAAQ,EAAIF,EAAK,WAAa,KAAO,IAKnE,OAFuBA,EAAK,YAAcG,EAO3B,MAAMb,EAAaS,GAAI,GAAG,EACtB,CAAE,QAAS,GAAM,OAAQ,gBAAiB,EAEtD,CACL,QAAS,GACT,OAAQI,EACJ,sEACA,8BACN,EAZS,CAAE,QAAS,GAAM,OAAQ,IAAK,CAazC",
  "names": ["gate_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "ddb", "TABLE", "isAdmin", "identity", "gs", "bestieActive", "userSub", "r", "active", "until", "loadEpisodeMeta", "epId", "event", "fieldName", "id", "meta", "now", "publishedAt", "inEarlyWindow"]
}
