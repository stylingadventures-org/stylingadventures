"use strict";var h=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var G=Object.prototype.hasOwnProperty;var R=(t,e)=>{for(var n in e)h(t,n,{get:e[n],enumerable:!0})},L=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of B(e))!G.call(t,s)&&s!==n&&h(t,s,{get:()=>e[s],enumerable:!(r=x(e,s))||r.enumerable});return t};var M=t=>L(h({},"__esModule",{value:!0}),t);var j={};R(j,{handler:()=>$});module.exports=M(j);var i=require("@aws-sdk/client-s3"),p=require("@aws-sdk/s3-request-presigner"),l=new i.S3Client({region:process.env.AWS_REGION||"us-east-1",forcePathStyle:!0}),y=process.env.BUCKET,P=String(process.env.ALLOWED_ORIGINS||"").split(",").map(t=>t.trim().replace(/\/+$/,"")).filter(Boolean),N=(process.env.WEB_ORIGIN||"").replace(/\/+$/,""),K=["authorization","Authorization","Content-Type","X-Amz-Date","X-Api-Key","X-Amz-Security-Token"].join(",");function O(t){return String(t?.headers?.origin||t?.headers?.Origin||"").replace(/\/+$/,"")}function f(t){let e=O(t);return P.length>0?e&&P.includes(e)?e:void 0:N||void 0}function d(t){let e={"Content-Type":"application/json","Access-Control-Allow-Headers":K,"Access-Control-Allow-Methods":"GET,POST,DELETE,OPTIONS","Access-Control-Allow-Credentials":"true","Access-Control-Expose-Headers":"ETag,Content-Type,Content-Length,Last-Modified,Accept-Ranges",Vary:"Origin, Access-Control-Request-Headers, Access-Control-Request-Method"};return t&&(e["Access-Control-Allow-Origin"]=t),e}function C(t,e,n={}){let r=f(t);return{statusCode:200,headers:{...d(r),"Cache-Control":"no-store",...n},body:JSON.stringify(e)}}function U(t){let e=f(t);return{statusCode:204,headers:d(e),body:""}}function c(t,e,n){let r=f(t);return!!O(t)&&!r?{statusCode:403,headers:d(void 0),body:JSON.stringify({message:"CORS: origin not allowed"})}:{statusCode:e,headers:d(r),body:JSON.stringify({message:n})}}var _=t=>t.httpMethod??t.requestContext?.http?.method??"GET",q=t=>t.requestContext?.authorizer?.claims??t.requestContext?.authorizer?.jwt?.claims??{},D=t=>{let e=t.body??"";if(!e)return{};let n=t.isBase64Encoded&&typeof e=="string"?Buffer.from(e,"base64").toString():e;try{return typeof n=="string"?JSON.parse(n):n}catch{return{}}};function E(t,e){let n=String(e||"").replace(/\.\./g,"").replace(/^[/\\]+/,""),r=n.startsWith(`users/${t}/`),s=/^users\/[^/]+\//.test(n)&&!r;return r?n:`users/${t}/${s?n.replace(/^users\/[^/]+\//,""):n}`}function z(t){let e=t?.["cognito:groups"];return Array.isArray(e)?e:typeof e=="string"?e.split(",").map(n=>n.trim()).filter(Boolean):[]}var $=async t=>{let e=_(t);if(e==="OPTIONS")return!f(t)&&O(t)?{statusCode:403,headers:d(void 0),body:""}:U(t);try{let n=q(t),r=n?.sub||"";if(!r)return c(t,401,"Not authorized");let s=z(n),S=Number(process.env.BASE_UPLOAD_LIMIT_MB||"50"),I=Number(process.env.BESTIE_UPLOAD_LIMIT_MB||"200"),m=s.includes("BESTIE")?I:S;if(e==="POST"){let o=D(t),a=String(o.key||""),g=String(o.contentType||"application/octet-stream");if(!a)return c(t,400,"Missing 'key'");let u=Number(o.contentLength||0);if(u>0&&u>m*1024*1024)return c(t,413,`Max upload ${m} MB for your tier`);let A=E(r,a),b=new i.PutObjectCommand({Bucket:y,Key:A,ContentType:g}),T=new i.GetObjectCommand({Bucket:y,Key:A}),w=await(0,p.getSignedUrl)(l,b,{expiresIn:900}),k=await(0,p.getSignedUrl)(l,T,{expiresIn:300});return C(t,{bucket:y,key:A,method:"PUT",url:w,headers:{"Content-Type":g},putUrl:w,getUrl:k,maxBytesAllowed:m*1024*1024})}if(e==="GET"){let o=String(t?.queryStringParameters?.key??t.pathParameters?.key??"");if(!o)return c(t,400,"Missing 'key'");let a=E(r,o),g=new i.GetObjectCommand({Bucket:y,Key:a}),u=await(0,p.getSignedUrl)(l,g,{expiresIn:300});return C(t,{bucket:y,key:a,getUrl:u,url:u,publicUrl:u})}if(e==="DELETE"){let o=String(t?.queryStringParameters?.key??t.pathParameters?.key??"");if(!o)return c(t,400,"Missing 'key'");let a=E(r,o);return await l.send(new i.DeleteObjectCommand({Bucket:y,Key:a})),C(t,{deleted:!0,key:a})}return c(t,405,"Method Not Allowed")}catch(n){return console.error(n),c(t,500,n?.message??String(n))}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
