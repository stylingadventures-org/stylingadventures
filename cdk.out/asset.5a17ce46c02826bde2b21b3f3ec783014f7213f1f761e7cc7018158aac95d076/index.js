"use strict";var u=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var c=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var g=(e,s)=>{for(var i in s)u(e,i,{get:s[i],enumerable:!0})},b=(e,s,i,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let o of c(s))!E.call(e,o)&&o!==i&&u(e,o,{get:()=>s[o],enumerable:!(t=p(s,o))||t.enumerable});return e};var I=e=>b(u({},"__esModule",{value:!0}),e);var _={};g(_,{handler:()=>P});module.exports=I(_);var a=require("@aws-sdk/client-dynamodb"),f=new a.DynamoDBClient({}),l=process.env.EPISODE_FEED_TABLE,D=process.env.EPISODE_FEED_PK_PREFIX??"EPISODE#",S=process.env.EPISODE_FEED_SK_PREFIX??"VERSION#";function h(e){!e.episodeId&&e.slug&&(e.episodeId=e.slug)}function m(e){if(!e.version){let s=new Date,i=o=>o.toString().padStart(2,"0"),t=s.getUTCFullYear().toString()+i(s.getUTCMonth()+1)+i(s.getUTCDate())+i(s.getUTCHours())+i(s.getUTCMinutes())+i(s.getUTCSeconds());e.version=t}}async function y(e){if(!l){console.log("EPISODE_FEED_TABLE not set; skipping DynamoDB write, but publish succeeds.");return}let s=e.episodeId??e.slug;if(!s){console.warn("No episodeId or slug present; skipping DynamoDB write, but publish succeeds.");return}let i=`${D}${s}`,t=`${S}${e.version}`;console.log("Writing episode feed item to DynamoDB:",{table:l,pk:i,sk:t,item:e});let o={pk:{S:i},sk:{S:t},type:{S:"episode#feed"}};for(let[d,n]of Object.entries(e))n!=null&&(o[d]={S:String(n)});await f.send(new a.PutItemCommand({TableName:l,Item:o}))}var P=async e=>{if(console.log("PublishEpisode incoming event:",JSON.stringify(e,null,2)),!e||!e.episode)throw new Error("PublishEpisode requires 'episode' in payload.");if(e.validation&&e.validation.ok===!1){console.warn("Refusing to publish: validation.ok === false. Issues:",JSON.stringify(e.validation.issues??[],null,2));let r={...e.episode,status:e.episode.status??"validation_failed"};return{published:!1,status:r.status,episode:r,validation:e.validation,skippedWrite:!0}}let s=new Date().toISOString(),i=e.targetStatus??"published",t={status:i,...e.episode,publishedAt:e.episode.publishedAt??s};h(t),m(t);let o={episodeId:t.episodeId,slug:t.slug,title:t.title,version:t.version,status:t.status??i,publishedAt:t.publishedAt},d=!1;if(e.dryRun)console.log("Dry-run publish; not writing to any datastore."),d=!0;else try{await y(o)}catch(r){throw console.error("Error writing episode feed record:",r),r}let n={published:!0,status:t.status??i,episode:t,feedItem:o,validation:e.validation,skippedWrite:d};return console.log("PublishEpisode result:",JSON.stringify(n,null,2)),n};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
