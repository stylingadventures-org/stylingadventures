{
  "version": 3,
  "sources": ["../../lambda/graphql/index.ts"],
  "sourcesContent": ["// lambda/graphql/index.ts\r\nimport {\r\n  DynamoDBClient,\r\n  PutItemCommand,\r\n  QueryCommand,\r\n  UpdateItemCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport { SFNClient, StartExecutionCommand } from \"@aws-sdk/client-sfn\";\r\nimport { marshall, unmarshall } from \"@aws-sdk/util-dynamodb\";\r\nimport { randomUUID } from \"crypto\";\r\n\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\nconst APPROVAL_SM_ARN = process.env.APPROVAL_SM_ARN!;\r\nconst STATUS_GSI = process.env.STATUS_GSI ?? \"gsi1\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\nconst sfn = new SFNClient({});\r\n\r\ntype ClosetStatus = \"DRAFT\" | \"PENDING\" | \"APPROVED\" | \"REJECTED\" | \"PUBLISHED\";\r\ntype ClosetAudience = \"PUBLIC\" | \"BESTIE\" | \"EXCLUSIVE\";\r\n\r\ninterface ClosetItem {\r\n  id: string;\r\n  userId: string;\r\n  ownerSub: string;\r\n  status: ClosetStatus;\r\n  createdAt: string;\r\n  updatedAt: string;\r\n  mediaKey?: string;\r\n  title?: string;\r\n  reason?: string;\r\n  audience?: ClosetAudience;\r\n\r\n  // Story-style metadata (Bestie / fan-facing)\r\n  storyTitle?: string;\r\n  storySeason?: string;\r\n  storyVibes?: string[];\r\n}\r\n\r\nfunction nowIso() {\r\n  return new Date().toISOString();\r\n}\r\n\r\nfunction pkForUser(userId: string) {\r\n  return `USER#${userId}`;\r\n}\r\n\r\nfunction skForClosetItem(id: string) {\r\n  return `CLOSET#${id}`;\r\n}\r\n\r\nfunction gsi1ForStatus(status: ClosetStatus) {\r\n  return `CLOSET#STATUS#${status}`;\r\n}\r\n\r\n/**\r\n * Map a raw DynamoDB item into our ClosetItem shape.\r\n */\r\nfunction mapClosetItem(raw: Record<string, any>): ClosetItem {\r\n  const item = unmarshall(raw) as any;\r\n\r\n  return {\r\n    id: item.id,\r\n    userId: item.userId,\r\n    ownerSub: item.ownerSub,\r\n    status: item.status,\r\n    createdAt: item.createdAt,\r\n    updatedAt: item.updatedAt,\r\n    mediaKey: item.mediaKey,\r\n    title: item.title,\r\n    reason: item.reason,\r\n    audience: item.audience,\r\n    storyTitle: item.storyTitle,\r\n    storySeason: item.storySeason,\r\n    storyVibes: item.storyVibes,\r\n  };\r\n}\r\n\r\n/**\r\n * Ensure the caller is authenticated and return sub/userId.\r\n */\r\nfunction requireUserSub(identity: any): string {\r\n  if (!identity?.sub) {\r\n    throw new Error(\"Not authenticated\");\r\n  }\r\n  return identity.sub as string;\r\n}\r\n\r\n/**\r\n * 1) myCloset \u2013 return all items owned by the current user.\r\n */\r\nasync function handleMyCloset(identity: any): Promise<ClosetItem[]> {\r\n  const sub = requireUserSub(identity);\r\n\r\n  const res = await ddb.send(\r\n    new QueryCommand({\r\n      TableName: TABLE_NAME,\r\n      KeyConditionExpression: \"pk = :pk AND begins_with(sk, :sk)\",\r\n      ExpressionAttributeValues: marshall({\r\n        \":pk\": pkForUser(sub),\r\n        \":sk\": \"CLOSET#\",\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return (res.Items ?? []).map(mapClosetItem);\r\n}\r\n\r\n/**\r\n * 2) createClosetItem \u2013 create a new item in DRAFT.\r\n */\r\nasync function handleCreateClosetItem(\r\n  args: { title?: string; mediaKey?: string },\r\n  identity: any,\r\n): Promise<ClosetItem> {\r\n  const sub = requireUserSub(identity);\r\n  const id = randomUUID();\r\n  const now = nowIso();\r\n\r\n  const item: ClosetItem = {\r\n    id,\r\n    userId: sub,\r\n    ownerSub: sub,\r\n    status: \"DRAFT\",\r\n    createdAt: now,\r\n    updatedAt: now,\r\n    mediaKey: args.mediaKey,\r\n    title: args.title,\r\n  };\r\n\r\n  await ddb.send(\r\n    new PutItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Item: marshall({\r\n        pk: pkForUser(sub),\r\n        sk: skForClosetItem(id),\r\n        gsi1pk: gsi1ForStatus(item.status),\r\n        gsi1sk: now,\r\n        ...item,\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return item;\r\n}\r\n\r\n/**\r\n * 3) updateClosetMediaKey \u2013 update the media key on an item owned by the user.\r\n */\r\nasync function handleUpdateClosetMediaKey(\r\n  args: { id: string; mediaKey: string },\r\n  identity: any,\r\n): Promise<ClosetItem> {\r\n  const sub = requireUserSub(identity);\r\n\r\n  const now = nowIso();\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: marshall({\r\n        pk: pkForUser(sub),\r\n        sk: skForClosetItem(args.id),\r\n      }),\r\n      UpdateExpression:\r\n        \"SET mediaKey = :mediaKey, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk\",\r\n      ExpressionAttributeValues: marshall({\r\n        \":mediaKey\": args.mediaKey,\r\n        \":updatedAt\": now,\r\n        \":gsi1pk\": gsi1ForStatus(\"DRAFT\"),\r\n        \":gsi1sk\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Item not found\");\r\n  }\r\n\r\n  return mapClosetItem(res.Attributes);\r\n}\r\n\r\n/**\r\n * 4) requestClosetApproval \u2013 mark DRAFT\u2192PENDING and kick off Step Functions.\r\n */\r\nasync function handleRequestClosetApproval(\r\n  args: { id: string },\r\n  identity: any,\r\n): Promise<string> {\r\n  const sub = requireUserSub(identity);\r\n  const now = nowIso();\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: marshall({\r\n        pk: pkForUser(sub),\r\n        sk: skForClosetItem(args.id),\r\n      }),\r\n      ConditionExpression: \"status = :draft\",\r\n      UpdateExpression:\r\n        \"SET status = :pending, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk\",\r\n      ExpressionAttributeValues: marshall({\r\n        \":draft\": \"DRAFT\",\r\n        \":pending\": \"PENDING\",\r\n        \":updatedAt\": now,\r\n        \":gsi1pk\": gsi1ForStatus(\"PENDING\"),\r\n        \":gsi1sk\": now,\r\n      }),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Item not found or not in DRAFT status\");\r\n  }\r\n\r\n  const item = mapClosetItem(res.Attributes);\r\n\r\n  // Fire-and-forget Step Functions execution\r\n  await sfn.send(\r\n    new StartExecutionCommand({\r\n      stateMachineArn: APPROVAL_SM_ARN,\r\n      input: JSON.stringify({\r\n        itemId: item.id,\r\n        userId: item.userId,\r\n        ownerSub: item.ownerSub,\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return item.id;\r\n}\r\n\r\n/**\r\n * 5) updateClosetItemStory \u2013 Bestie-side metadata for fan-facing view.\r\n */\r\nasync function handleUpdateClosetItemStory(\r\n  args: {\r\n    input: {\r\n      id: string;\r\n      storyTitle?: string | null;\r\n      storySeason?: string | null;\r\n      storyVibes?: (string | null)[] | null;\r\n    };\r\n  },\r\n  identity: any,\r\n): Promise<ClosetItem> {\r\n  const sub = requireUserSub(identity);\r\n  const { id, storyTitle, storySeason, storyVibes } = args.input;\r\n\r\n  const now = nowIso();\r\n\r\n  const updateExpressions: string[] = [\"updatedAt = :updatedAt\"];\r\n  const expressionValues: Record<string, any> = {\r\n    \":updatedAt\": now,\r\n  };\r\n\r\n  if (storyTitle !== undefined) {\r\n    updateExpressions.push(\"storyTitle = :storyTitle\");\r\n    expressionValues[\":storyTitle\"] = storyTitle;\r\n  }\r\n\r\n  if (storySeason !== undefined) {\r\n    updateExpressions.push(\"storySeason = :storySeason\");\r\n    expressionValues[\":storySeason\"] = storySeason;\r\n  }\r\n\r\n  if (storyVibes !== undefined) {\r\n    updateExpressions.push(\"storyVibes = :storyVibes\");\r\n    expressionValues[\":storyVibes\"] = storyVibes?.filter(\r\n      (v): v is string => !!v,\r\n    );\r\n  }\r\n\r\n  const res = await ddb.send(\r\n    new UpdateItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: marshall({\r\n        pk: pkForUser(sub),\r\n        sk: skForClosetItem(id),\r\n      }),\r\n      UpdateExpression: \"SET \" + updateExpressions.join(\", \"),\r\n      ExpressionAttributeValues: marshall(expressionValues),\r\n      ReturnValues: \"ALL_NEW\",\r\n    }),\r\n  );\r\n\r\n  if (!res.Attributes) {\r\n    throw new Error(\"Item not found\");\r\n  }\r\n\r\n  return mapClosetItem(res.Attributes);\r\n}\r\n\r\n/**\r\n * AppSync Lambda resolver entrypoint.\r\n */\r\nexport const handler = async (event: any) => {\r\n  console.log(\"ClosetResolverFn event\", JSON.stringify(event));\r\n\r\n  const fieldName = event.info?.fieldName;\r\n\r\n  try {\r\n    switch (fieldName) {\r\n      case \"myCloset\":\r\n        return await handleMyCloset(event.identity);\r\n\r\n      case \"createClosetItem\":\r\n        return await handleCreateClosetItem(event.arguments, event.identity);\r\n\r\n      case \"updateClosetMediaKey\":\r\n        return await handleUpdateClosetMediaKey(event.arguments, event.identity);\r\n\r\n      case \"requestClosetApproval\":\r\n        return await handleRequestClosetApproval(event.arguments, event.identity);\r\n\r\n      case \"updateClosetItemStory\":\r\n        return await handleUpdateClosetItemStory(event.arguments, event.identity);\r\n\r\n      default:\r\n        throw new Error(`Unsupported field: ${fieldName}`);\r\n    }\r\n  } catch (err: any) {\r\n    console.error(\"Error in ClosetResolverFn\", err);\r\n    throw err;\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["index_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_client_sfn", "import_util_dynamodb", "import_crypto", "TABLE_NAME", "APPROVAL_SM_ARN", "STATUS_GSI", "ddb", "sfn", "nowIso", "pkForUser", "userId", "skForClosetItem", "id", "gsi1ForStatus", "status", "mapClosetItem", "raw", "item", "requireUserSub", "identity", "handleMyCloset", "sub", "handleCreateClosetItem", "args", "now", "handleUpdateClosetMediaKey", "res", "handleRequestClosetApproval", "handleUpdateClosetItemStory", "storyTitle", "storySeason", "storyVibes", "updateExpressions", "expressionValues", "v", "event", "fieldName", "err"]
}
