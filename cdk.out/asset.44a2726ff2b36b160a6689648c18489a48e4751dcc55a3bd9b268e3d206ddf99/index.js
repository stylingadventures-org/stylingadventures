"use strict";var w=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var h=Object.prototype.hasOwnProperty;var R=(t,e)=>{for(var s in e)w(t,s,{get:e[s],enumerable:!0})},V=(t,e,s,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of N(e))!h.call(t,n)&&n!==s&&w(t,n,{get:()=>e[n],enumerable:!(r=k(e,n))||r.enumerable});return t};var U=t=>V(w({},"__esModule",{value:!0}),t);var M={};R(M,{handler:()=>O});module.exports=U(M);var a=require("@aws-sdk/client-dynamodb"),y=require("@aws-sdk/client-sfn"),o=require("@aws-sdk/util-dynamodb"),b=require("crypto"),u=process.env.TABLE_NAME,K=process.env.APPROVAL_SM_ARN,G=process.env.STATUS_GSI??"gsi1",d=new a.DynamoDBClient({}),P=new y.SFNClient({});function A(){return new Date().toISOString()}function l(t){return`USER#${t}`}function g(t){return`CLOSET#${t}`}function E(t){return`CLOSET#STATUS#${t}`}function S(t){let e=(0,o.unmarshall)(t);return{id:e.id,userId:e.userId,ownerSub:e.ownerSub,status:e.status,createdAt:e.createdAt,updatedAt:e.updatedAt,mediaKey:e.mediaKey,title:e.title,reason:e.reason,audience:e.audience,storyTitle:e.storyTitle,storySeason:e.storySeason,storyVibes:e.storyVibes}}function m(t){if(!t?.sub)throw new Error("Not authenticated");return t.sub}async function D(t){let e=m(t);return((await d.send(new a.QueryCommand({TableName:u,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,o.marshall)({":pk":l(e),":sk":"CLOSET#"})}))).Items??[]).map(S)}async function L(t,e){let s=m(e),r=(0,b.randomUUID)(),n=A(),i={id:r,userId:s,ownerSub:s,status:"DRAFT",createdAt:n,updatedAt:n,mediaKey:t.mediaKey,title:t.title};return await d.send(new a.PutItemCommand({TableName:u,Item:(0,o.marshall)({pk:l(s),sk:g(r),gsi1pk:E(i.status),gsi1sk:n,...i})})),i}async function x(t,e){let s=m(e),r=A(),n=await d.send(new a.UpdateItemCommand({TableName:u,Key:(0,o.marshall)({pk:l(s),sk:g(t.id)}),UpdateExpression:"SET mediaKey = :mediaKey, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,o.marshall)({":mediaKey":t.mediaKey,":updatedAt":r,":gsi1pk":E("DRAFT"),":gsi1sk":r}),ReturnValues:"ALL_NEW"}));if(!n.Attributes)throw new Error("Item not found");return S(n.Attributes)}async function _(t,e){let s=m(e),r=A(),n=await d.send(new a.UpdateItemCommand({TableName:u,Key:(0,o.marshall)({pk:l(s),sk:g(t.id)}),ConditionExpression:"status = :draft",UpdateExpression:"SET status = :pending, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,o.marshall)({":draft":"DRAFT",":pending":"PENDING",":updatedAt":r,":gsi1pk":E("PENDING"),":gsi1sk":r}),ReturnValues:"ALL_NEW"}));if(!n.Attributes)throw new Error("Item not found or not in DRAFT status");let i=S(n.Attributes);return await P.send(new y.StartExecutionCommand({stateMachineArn:K,input:JSON.stringify({itemId:i.id,userId:i.userId,ownerSub:i.ownerSub})})),i.id}async function F(t,e){let s=m(e),{id:r,storyTitle:n,storySeason:i,storyVibes:C}=t.input,I=A(),p=["updatedAt = :updatedAt"],c={":updatedAt":I};n!==void 0&&(p.push("storyTitle = :storyTitle"),c[":storyTitle"]=n),i!==void 0&&(p.push("storySeason = :storySeason"),c[":storySeason"]=i),C!==void 0&&(p.push("storyVibes = :storyVibes"),c[":storyVibes"]=C?.filter(T=>!!T));let f=await d.send(new a.UpdateItemCommand({TableName:u,Key:(0,o.marshall)({pk:l(s),sk:g(r)}),UpdateExpression:"SET "+p.join(", "),ExpressionAttributeValues:(0,o.marshall)(c),ReturnValues:"ALL_NEW"}));if(!f.Attributes)throw new Error("Item not found");return S(f.Attributes)}var O=async t=>{console.log("ClosetResolverFn event",JSON.stringify(t));let e=t.info?.fieldName;try{switch(e){case"myCloset":return await D(t.identity);case"createClosetItem":return await L(t.arguments,t.identity);case"updateClosetMediaKey":return await x(t.arguments,t.identity);case"requestClosetApproval":return await _(t.arguments,t.identity);case"updateClosetItemStory":return await F(t.arguments,t.identity);default:throw new Error(`Unsupported field: ${e}`)}}catch(s){throw console.error("Error in ClosetResolverFn",s),s}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
