"use strict";var E=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var P=Object.prototype.hasOwnProperty;var M=(t,e)=>{for(var i in e)E(t,i,{get:e[i],enumerable:!0})},D=(t,e,i,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of N(e))!P.call(t,r)&&r!==i&&E(t,r,{get:()=>e[r],enumerable:!(s=k(e,r))||s.enumerable});return t};var x=t=>D(E({},"__esModule",{value:!0}),t);var R={};M(R,{adminApproveItem:()=>b,adminCreateClosetItem:()=>T,adminListPending:()=>w,adminRejectItem:()=>C,adminSetClosetAudience:()=>f,closetFeed:()=>S,handler:()=>v,topClosetLooks:()=>I});module.exports=x(R);var a=require("@aws-sdk/client-dynamodb"),u=require("@aws-sdk/client-sfn"),m=new a.DynamoDBClient({}),g=new u.SFNClient({}),{TABLE_NAME:p="",APPROVAL_SM_ARN:O=""}=process.env;if(!p)throw new Error("Missing env: TABLE_NAME");var A=()=>new Date().toISOString(),n=t=>({S:t});function c(t){let e=t.identity?.claims||{},i=t.identity?.sub||e.sub,s=e["cognito:groups"],r=Array.isArray(s)?s:String(s||"").split(",").map(d=>d.trim()).filter(Boolean),o=r.includes("ADMIN")||r.includes("COLLAB");if(!i)throw new Error("Unauthorized");return{sub:i,isAdmin:o}}function l(t){return{id:t.id.S,userId:t.ownerSub.S,ownerSub:t.ownerSub.S,status:t.status.S,createdAt:t.createdAt.S,updatedAt:t.updatedAt.S,mediaKey:t.mediaKey?.S??"",rawMediaKey:t.rawMediaKey?.S??"",title:t.title?.S??"",reason:t.reason?.S??"",season:t.season?.S??null,vibes:t.vibes?.S??null}}function K(){return globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`}var w=async t=>{let{isAdmin:e}=c(t);if(!e)throw new Error("Forbidden");return((await m.send(new a.QueryCommand({TableName:p,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(s=>l({...s,status:s.status}))},S=async t=>{c(t);let{sort:e="NEWEST"}=t.arguments||{},s=((await m.send(new a.QueryCommand({TableName:p,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n("STATUS#PUBLISHED")},ScanIndexForward:e==="NEWEST",ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(r=>l({...r,status:r.status}));return s},I=async t=>S({...t,arguments:{sort:"NEWEST"}}),T=async t=>{let{sub:e,isAdmin:i}=c(t);if(!i)throw new Error("Forbidden");let s=t.arguments?.input||{};if(!s.title?.trim())throw new Error("title is required");if(!s.rawMediaKey)throw new Error("rawMediaKey is required");let r=K(),o=A();return await m.send(new a.PutItemCommand({TableName:p,Item:{pk:n(`ITEM#${r}`),sk:n("META"),id:n(r),ownerSub:n(e),gsi2pk:n("STATUS#PENDING"),gsi2sk:n(o),status:n("PENDING"),createdAt:n(o),updatedAt:n(o),title:n(s.title.trim()),rawMediaKey:n(s.rawMediaKey),...s.season?{season:n(s.season)}:{},...s.vibes?{vibes:n(s.vibes)}:{}}})),{id:r,userId:e,ownerSub:e,status:"PENDING",createdAt:o,updatedAt:o,title:s.title.trim(),mediaKey:"",rawMediaKey:s.rawMediaKey,reason:"",season:s.season??null,vibes:s.vibes??null}},b=async t=>{let{isAdmin:e}=c(t);if(!e)throw new Error("Forbidden");let i=t.arguments?.id;if(!i)throw new Error("id required");let s=A(),o=(await m.send(new a.UpdateItemCommand({TableName:p,Key:{pk:n(`ITEM#${i}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("APPROVED"),":u":n(s),":g2pk":n("STATUS#APPROVED"),":g2sk":n(s)},ReturnValues:"ALL_OLD"}))).Attributes,d=o.approvalToken?.S;if(d)try{await g.send(new u.SendTaskSuccessCommand({taskToken:d,output:JSON.stringify({approved:!0})}))}catch{}return l({...o,status:n("APPROVED")})},C=async t=>{let{isAdmin:e}=c(t);if(!e)throw new Error("Forbidden");let i=t.arguments?.id,s=t.arguments?.reason||"";if(!i)throw new Error("id required");let r=A(),d=(await m.send(new a.UpdateItemCommand({TableName:p,Key:{pk:n(`ITEM#${i}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("REJECTED"),":u":n(r),":g2pk":n("STATUS#REJECTED"),":g2sk":n(r),":r":n(s)},ReturnValues:"ALL_OLD"}))).Attributes,y=d.approvalToken?.S;if(y)try{await g.send(new u.SendTaskFailureCommand({taskToken:y,error:"Rejected",cause:s||"Rejected by admin"}))}catch{}return l({...d,status:n("REJECTED"),reason:n(s)})},f=async t=>"NOT_IMPLEMENTED",v=async t=>{let e=t.info.fieldName;if(e==="adminListPending")return w(t);if(e==="adminCreateClosetItem")return T(t);if(e==="adminApproveItem")return b(t);if(e==="adminRejectItem")return C(t);if(e==="adminSetClosetAudience")return f(t);if(e==="closetFeed")return S(t);if(e==="topClosetLooks")return I(t);throw new Error(`No resolver for field ${e}`)};0&&(module.exports={adminApproveItem,adminCreateClosetItem,adminListPending,adminRejectItem,adminSetClosetAudience,closetFeed,handler,topClosetLooks});
//# sourceMappingURL=index.js.map
