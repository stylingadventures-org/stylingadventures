{
  "version": 3,
  "sources": ["../../lambda/closet/publish.ts"],
  "sourcesContent": ["import { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport { DynamoDBDocumentClient, GetCommand, UpdateCommand } from \"@aws-sdk/lib-dynamodb\";\r\nimport { EventBridgeClient, PutEventsCommand } from \"@aws-sdk/client-eventbridge\";\r\n\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}), {\r\n  marshallOptions: { removeUndefinedValues: true },\r\n});\r\nconst eb = new EventBridgeClient({});\r\n\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\nconst PK_NAME = process.env.PK_NAME || \"pk\";\r\nconst SK_NAME = process.env.SK_NAME || \"sk\";\r\n\r\nasync function emit(detailType: string, detail: any) {\r\n  try {\r\n    await eb.send(\r\n      new PutEventsCommand({\r\n        Entries: [\r\n          {\r\n            Source: \"stylingadventures.closet\",\r\n            DetailType: detailType,\r\n            Detail: JSON.stringify(detail),\r\n          },\r\n        ],\r\n      }),\r\n    );\r\n  } catch (e) {\r\n    console.warn(\"[publish] EventBridge put failed:\", e);\r\n  }\r\n}\r\n\r\nfunction isConditionalCheckFailed(err: any) {\r\n  return err?.name === \"ConditionalCheckFailedException\";\r\n}\r\n\r\nexport const handler = async (event: any) => {\r\n  console.log(\"[publish] incoming event:\", JSON.stringify(event));\r\n\r\n  // Deterministic ID resolution (we now pass approvalId explicitly from the SM)\r\n  const approvalId =\r\n    event?.approvalId ||\r\n    event?.item?.id ||\r\n    event?.itemId ||\r\n    event?.closetItemId ||\r\n    event?.admin?.approvalId;\r\n\r\n  if (!approvalId) {\r\n    console.warn(\"[publish] missing approvalId; no-op publish\");\r\n    return { ok: false, status: \"NO_ID\" };\r\n  }\r\n\r\n  const pk = `ITEM#${approvalId}`;\r\n  const sk = \"META\";\r\n  const now = new Date().toISOString();\r\n\r\n  // Prefer processed image for published mediaKey\r\n  const mediaKey =\r\n    event?.segmentation?.outputKey ||\r\n    event?.processedImageKey ||\r\n    event?.item?.s3Key ||\r\n    null;\r\n\r\n  // 0) Read current status (idempotency + better return values)\r\n  const { Item } = await ddb.send(\r\n    new GetCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: { [PK_NAME]: pk, [SK_NAME]: sk },\r\n      ConsistentRead: true,\r\n    }),\r\n  );\r\n\r\n  if (!Item) {\r\n    console.warn(\"[publish] meta not found\", { approvalId });\r\n    return { ok: false, status: \"NOT_FOUND\", approvalId };\r\n  }\r\n\r\n  const currentStatus = Item.status as string | undefined;\r\n\r\n  // If already published, return idempotent success\r\n  if (currentStatus === \"PUBLISHED\") {\r\n    return {\r\n      ok: true,\r\n      approvalId,\r\n      status: \"PUBLISHED\",\r\n      idempotent: true,\r\n      mediaKey: (Item.mediaKey as string | undefined) ?? mediaKey,\r\n    };\r\n  }\r\n\r\n  // Only APPROVED -> PUBLISHED\r\n  if (currentStatus !== \"APPROVED\") {\r\n    return { ok: false, approvalId, status: \"NOT_APPROVED\", currentStatus };\r\n  }\r\n\r\n  // 1) Conditional update ensures deterministic transition\r\n  try {\r\n    await ddb.send(\r\n      new UpdateCommand({\r\n        TableName: TABLE_NAME,\r\n        Key: { [PK_NAME]: pk, [SK_NAME]: sk },\r\n        ConditionExpression: \"#status = :approved\",\r\n        UpdateExpression:\r\n          \"SET #status = :published, updatedAt = :t, publishedAt = :t, mediaKey = :m\",\r\n        ExpressionAttributeNames: { \"#status\": \"status\" },\r\n        ExpressionAttributeValues: {\r\n          \":approved\": \"APPROVED\",\r\n          \":published\": \"PUBLISHED\",\r\n          \":t\": now,\r\n          \":m\": mediaKey,\r\n        },\r\n      }),\r\n    );\r\n  } catch (err: any) {\r\n    if (isConditionalCheckFailed(err)) {\r\n      // Another invocation may have published; re-read and return stable outcome\r\n      const reread = await ddb.send(\r\n        new GetCommand({\r\n          TableName: TABLE_NAME,\r\n          Key: { [PK_NAME]: pk, [SK_NAME]: sk },\r\n          ConsistentRead: true,\r\n        }),\r\n      );\r\n      const s = (reread.Item?.status as string | undefined) ?? \"UNKNOWN\";\r\n      if (s === \"PUBLISHED\") {\r\n        return {\r\n          ok: true,\r\n          approvalId,\r\n          status: \"PUBLISHED\",\r\n          idempotent: true,\r\n          mediaKey: (reread.Item?.mediaKey as string | undefined) ?? mediaKey,\r\n        };\r\n      }\r\n      return { ok: false, approvalId, status: \"RACE_LOST\", currentStatus: s };\r\n    }\r\n    throw err;\r\n  }\r\n\r\n  // 2) Emit event (best-effort)\r\n  await emit(\"ClosetItemPublished\", {\r\n    approvalId,\r\n    publishedAt: now,\r\n    mediaKey,\r\n  });\r\n\r\n  return { ok: true, approvalId, status: \"PUBLISHED\", mediaKey };\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAAA,IAAAI,EAA+B,oCAC/BC,EAAkE,iCAClEC,EAAoD,uCAE9CC,EAAM,yBAAuB,KAAK,IAAI,iBAAe,CAAC,CAAC,EAAG,CAC9D,gBAAiB,CAAE,sBAAuB,EAAK,CACjD,CAAC,EACKC,EAAK,IAAI,oBAAkB,CAAC,CAAC,EAE7BC,EAAa,QAAQ,IAAI,WACzBC,EAAU,QAAQ,IAAI,SAAW,KACjCC,EAAU,QAAQ,IAAI,SAAW,KAEvC,eAAeC,EAAKC,EAAoBC,EAAa,CACnD,GAAI,CACF,MAAMN,EAAG,KACP,IAAI,mBAAiB,CACnB,QAAS,CACP,CACE,OAAQ,2BACR,WAAYK,EACZ,OAAQ,KAAK,UAAUC,CAAM,CAC/B,CACF,CACF,CAAC,CACH,CACF,OAASC,EAAG,CACV,QAAQ,KAAK,oCAAqCA,CAAC,CACrD,CACF,CAEA,SAASC,EAAyBC,EAAU,CAC1C,OAAOA,GAAK,OAAS,iCACvB,CAEO,IAAMf,EAAU,MAAOgB,GAAe,CAC3C,QAAQ,IAAI,4BAA6B,KAAK,UAAUA,CAAK,CAAC,EAG9D,IAAMC,EACJD,GAAO,YACPA,GAAO,MAAM,IACbA,GAAO,QACPA,GAAO,cACPA,GAAO,OAAO,WAEhB,GAAI,CAACC,EACH,eAAQ,KAAK,6CAA6C,EACnD,CAAE,GAAI,GAAO,OAAQ,OAAQ,EAGtC,IAAMC,EAAK,QAAQD,CAAU,GACvBE,EAAK,OACLC,EAAM,IAAI,KAAK,EAAE,YAAY,EAG7BC,EACJL,GAAO,cAAc,WACrBA,GAAO,mBACPA,GAAO,MAAM,OACb,KAGI,CAAE,KAAAM,CAAK,EAAI,MAAMjB,EAAI,KACzB,IAAI,aAAW,CACb,UAAWE,EACX,IAAK,CAAE,CAACC,CAAO,EAAGU,EAAI,CAACT,CAAO,EAAGU,CAAG,EACpC,eAAgB,EAClB,CAAC,CACH,EAEA,GAAI,CAACG,EACH,eAAQ,KAAK,2BAA4B,CAAE,WAAAL,CAAW,CAAC,EAChD,CAAE,GAAI,GAAO,OAAQ,YAAa,WAAAA,CAAW,EAGtD,IAAMM,EAAgBD,EAAK,OAG3B,GAAIC,IAAkB,YACpB,MAAO,CACL,GAAI,GACJ,WAAAN,EACA,OAAQ,YACR,WAAY,GACZ,SAAWK,EAAK,UAAmCD,CACrD,EAIF,GAAIE,IAAkB,WACpB,MAAO,CAAE,GAAI,GAAO,WAAAN,EAAY,OAAQ,eAAgB,cAAAM,CAAc,EAIxE,GAAI,CACF,MAAMlB,EAAI,KACR,IAAI,gBAAc,CAChB,UAAWE,EACX,IAAK,CAAE,CAACC,CAAO,EAAGU,EAAI,CAACT,CAAO,EAAGU,CAAG,EACpC,oBAAqB,sBACrB,iBACE,4EACF,yBAA0B,CAAE,UAAW,QAAS,EAChD,0BAA2B,CACzB,YAAa,WACb,aAAc,YACd,KAAMC,EACN,KAAMC,CACR,CACF,CAAC,CACH,CACF,OAASN,EAAU,CACjB,GAAID,EAAyBC,CAAG,EAAG,CAEjC,IAAMS,EAAS,MAAMnB,EAAI,KACvB,IAAI,aAAW,CACb,UAAWE,EACX,IAAK,CAAE,CAACC,CAAO,EAAGU,EAAI,CAACT,CAAO,EAAGU,CAAG,EACpC,eAAgB,EAClB,CAAC,CACH,EACMM,EAAKD,EAAO,MAAM,QAAiC,UACzD,OAAIC,IAAM,YACD,CACL,GAAI,GACJ,WAAAR,EACA,OAAQ,YACR,WAAY,GACZ,SAAWO,EAAO,MAAM,UAAmCH,CAC7D,EAEK,CAAE,GAAI,GAAO,WAAAJ,EAAY,OAAQ,YAAa,cAAeQ,CAAE,CACxE,CACA,MAAMV,CACR,CAGA,aAAML,EAAK,sBAAuB,CAChC,WAAAO,EACA,YAAaG,EACb,SAAAC,CACF,CAAC,EAEM,CAAE,GAAI,GAAM,WAAAJ,EAAY,OAAQ,YAAa,SAAAI,CAAS,CAC/D",
  "names": ["publish_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "import_client_eventbridge", "ddb", "eb", "TABLE_NAME", "PK_NAME", "SK_NAME", "emit", "detailType", "detail", "e", "isConditionalCheckFailed", "err", "event", "approvalId", "pk", "sk", "now", "mediaKey", "Item", "currentStatus", "reread", "s"]
}
