"use strict";var m=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var b=Object.prototype.hasOwnProperty;var h=(e,t)=>{for(var s in t)m(e,s,{get:t[s],enumerable:!0})},w=(e,t,s,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of A(t))!b.call(e,n)&&n!==s&&m(e,n,{get:()=>t[n],enumerable:!(i=N(t,n))||i.enumerable});return e};var K=e=>w(m({},"__esModule",{value:!0}),e);var k={};h(k,{handler:()=>C});module.exports=K(k);var D=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb"),r=require("@aws-sdk/client-eventbridge"),l=a.DynamoDBDocumentClient.from(new D.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),S=new r.EventBridgeClient({}),p=process.env.TABLE_NAME,c=process.env.PK_NAME||"pk",E=process.env.SK_NAME||"sk";async function g(e,t){try{await S.send(new r.PutEventsCommand({Entries:[{Source:"stylingadventures.closet",DetailType:e,Detail:JSON.stringify(t)}]}))}catch(s){console.warn("[publish] EventBridge put failed:",s)}}function P(e){return e?.name==="ConditionalCheckFailedException"}var C=async e=>{console.log("[publish] incoming event:",JSON.stringify(e));let t=e?.approvalId||e?.item?.id||e?.itemId||e?.closetItemId||e?.admin?.approvalId;if(!t)return console.warn("[publish] missing approvalId; no-op publish"),{ok:!1,status:"NO_ID"};let s=`ITEM#${t}`,i="META",n=new Date().toISOString(),o=e?.segmentation?.outputKey||e?.processedImageKey||e?.item?.s3Key||null,{Item:u}=await l.send(new a.GetCommand({TableName:p,Key:{[c]:s,[E]:i},ConsistentRead:!0}));if(!u)return console.warn("[publish] meta not found",{approvalId:t}),{ok:!1,status:"NOT_FOUND",approvalId:t};let d=u.status;if(d==="PUBLISHED")return{ok:!0,approvalId:t,status:"PUBLISHED",idempotent:!0,mediaKey:u.mediaKey??o};if(d!=="APPROVED")return{ok:!1,approvalId:t,status:"NOT_APPROVED",currentStatus:d};try{await l.send(new a.UpdateCommand({TableName:p,Key:{[c]:s,[E]:i},ConditionExpression:"#status = :approved",UpdateExpression:"SET #status = :published, updatedAt = :t, publishedAt = :t, mediaKey = :m",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:{":approved":"APPROVED",":published":"PUBLISHED",":t":n,":m":o}}))}catch(y){if(P(y)){let f=await l.send(new a.GetCommand({TableName:p,Key:{[c]:s,[E]:i},ConsistentRead:!0})),I=f.Item?.status??"UNKNOWN";return I==="PUBLISHED"?{ok:!0,approvalId:t,status:"PUBLISHED",idempotent:!0,mediaKey:f.Item?.mediaKey??o}:{ok:!1,approvalId:t,status:"RACE_LOST",currentStatus:I}}throw y}return await g("ClosetItemPublished",{approvalId:t,publishedAt:n,mediaKey:o}),{ok:!0,approvalId:t,status:"PUBLISHED",mediaKey:o}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
