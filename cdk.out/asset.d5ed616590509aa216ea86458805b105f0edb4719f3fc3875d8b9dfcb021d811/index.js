"use strict";var c=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var v=(e,t)=>{for(var n in t)c(e,n,{get:t[n],enumerable:!0})},w=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of y(t))!N.call(e,i)&&i!==n&&c(e,i,{get:()=>t[i],enumerable:!(s=A(t,i))||s.enumerable});return e};var x=e=>w(c({},"__esModule",{value:!0}),e);var D={};v(D,{handler:()=>S});module.exports=x(D);var f=require("@aws-sdk/client-dynamodb"),r=require("@aws-sdk/lib-dynamodb");var a=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!a)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var d=r.DynamoDBDocumentClient.from(new f.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),g=e=>`USER#${e}`,m="PROFILE";function E(e){if(e==null)return null;if(typeof e=="number"){let t=new Date(e);return isNaN(t.getTime())?null:t.toISOString()}if(typeof e=="string"){let t=e.trim();if(!t)return null;let n=Number(t);if(!Number.isNaN(n)){let i=new Date(n);return isNaN(i.getTime())?null:i.toISOString()}let s=new Date(t);return isNaN(s.getTime())?null:s.toISOString()}return null}async function p(e){let t=g(e),{Item:n}=await d.send(new r.GetCommand({TableName:a,Key:{pk:t,sk:m}}));if(!n){let s=new Date().toISOString();return await d.send(new r.UpdateCommand({TableName:a,Key:{pk:t,sk:m},UpdateExpression:"SET #uid=:uid, #lvl=:lvl, #xp=:xp, #coins=:coins, #badges=:badges, #ts=:ts",ExpressionAttributeNames:{"#uid":"userId","#lvl":"level","#xp":"xp","#coins":"coins","#badges":"badges","#ts":"lastEventAt"},ExpressionAttributeValues:{":uid":e,":lvl":1,":xp":0,":coins":0,":badges":[],":ts":s}})),{userId:e,level:1,xp:0,coins:0,badges:[],lastEventAt:s,streakCount:null,lastLoginAt:null}}return n.userId||await d.send(new r.UpdateCommand({TableName:a,Key:{pk:t,sk:m},UpdateExpression:"SET #uid = if_not_exists(#uid, :uid)",ExpressionAttributeNames:{"#uid":"userId"},ExpressionAttributeValues:{":uid":e}})),{userId:n.userId??e,level:n.level??1,xp:n.xp??0,coins:n.coins??0,badges:Array.isArray(n.badges)?n.badges:[],displayName:n.displayName??null,avatarUrl:n.avatarUrl??null,bio:n.bio??null,lastEventAt:E(n.lastEventAt),streakCount:n.streakCount??null,lastLoginAt:E(n.lastLoginAt)}}async function T(e,t){let n=g(e),s=(t??"").trim().slice(0,40),i=new Date().toISOString();return await d.send(new r.UpdateCommand({TableName:a,Key:{pk:n,sk:m},UpdateExpression:"SET #dn=:dn, #ts=:ts ADD #lvl :zero, #xp :zero, #coins :zero",ExpressionAttributeNames:{"#dn":"displayName","#ts":"lastEventAt","#lvl":"level","#xp":"xp","#coins":"coins"},ExpressionAttributeValues:{":dn":s,":ts":i,":zero":0}})),p(e)}var S=async e=>{let t=e.identity?.sub;if(!t)throw new Error("Unauthorized: missing sub");switch(e.info.fieldName){case"getMyProfile":return p(t);case"setDisplayName":return T(t,e.arguments.displayName);case"updateProfile":{let{displayName:n,avatarUrl:s,bio:i}=e.arguments.input||{},b=g(t),l={},u={},o=[];return typeof n=="string"&&(l["#dn"]="displayName",u[":dn"]=n.trim().slice(0,40),o.push("#dn = :dn")),typeof s=="string"&&(l["#av"]="avatarUrl",u[":av"]=s,o.push("#av = :av")),typeof i=="string"&&(l["#bio"]="bio",u[":bio"]=i.trim().slice(0,280),o.push("#bio = :bio")),l["#ts"]="lastEventAt",u[":ts"]=new Date().toISOString(),o.push("#ts = :ts"),o.length&&await d.send(new r.UpdateCommand({TableName:a,Key:{pk:b,sk:m},UpdateExpression:`SET ${o.join(", ")}`,ExpressionAttributeNames:l,ExpressionAttributeValues:u})),p(t)}default:throw new Error(`Unknown field ${e.info.fieldName}`)}};0&&(module.exports={handler});
