"use strict";var F=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var H=(e,t)=>{for(var o in t)F(e,o,{get:t[o],enumerable:!0})},W=(e,t,o,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of M(t))!B.call(e,n)&&n!==o&&F(e,n,{get:()=>t[n],enumerable:!(s=V(t,n))||s.enumerable});return e};var v=e=>W(F({},"__esModule",{value:!0}),e);var ge={};H(ge,{handler:()=>Ce});module.exports=v(ge);var u=require("@aws-sdk/client-dynamodb"),h=require("@aws-sdk/client-sfn"),P=require("@aws-sdk/client-eventbridge"),i=require("@aws-sdk/util-dynamodb"),T=require("crypto"),l=process.env.TABLE_NAME,G=process.env.APPROVAL_SM_ARN,z=process.env.BG_CHANGE_SM_ARN,q=process.env.STORY_PUBLISH_SM_ARN,$=process.env.STATUS_GSI??"gsi1",c=new u.DynamoDBClient({}),K=new h.SFNClient({}),J=new P.EventBridgeClient({});function g(){return new Date().toISOString()}function I(e){return`USER#${e}`}function E(e){return`CLOSET#${e}`}function D(e){return`STORY#${e}`}function N(e){return`CLOSET#${e}`}function _(e){return`CLOSET#STATUS#${e}`}function Y(e){if(typeof e=="string")return e.startsWith("CLOSET#")?e.slice(7)||void 0:e}async function k(e){try{await J.send(new P.PutEventsCommand({Entries:[{Source:"stylingadventures.besties",DetailType:"BestieEngagement",Detail:JSON.stringify(e)}]}))}catch(t){console.error("Failed to put engagement event",t)}}function y(e){let t=(0,i.unmarshall)(e),o=t.id??Y(t.sk)??(0,T.randomUUID)(),s=typeof t.pk=="string"&&t.pk.startsWith("USER#")?t.pk.slice(5):void 0,n=t.userId??t.ownerSub??s??"UNKNOWN",r=t.ownerSub??t.userId??s??"UNKNOWN",a=t.createdAt??t.updatedAt??new Date(0).toISOString(),d=t.updatedAt??a,m=t.status??"DRAFT";return{id:o,userId:n,ownerSub:r,status:m,createdAt:a,updatedAt:d,mediaKey:t.mediaKey,rawMediaKey:t.rawMediaKey,title:t.title,reason:t.reason,audience:t.audience,category:t.category,subcategory:t.subcategory,storyTitle:t.storyTitle,storySeason:t.storySeason,storyVibes:t.storyVibes,pinned:t.pinned,pendingBackgroundKey:t.pendingBackgroundKey,inCommunityFeed:t.inCommunityFeed,favoriteCount:t.favoriteCount,likeCount:t.likeCount,commentCount:t.commentCount,wishlistCount:t.wishlistCount,viewerHasFaved:t.viewerHasFaved,viewerHasLiked:t.viewerHasLiked,viewerHasWishlisted:t.viewerHasWishlisted}}function C(e){if(!e?.sub)throw new Error("Not authenticated");return e.sub}function O(e){let o=(e?.claims||{})["cognito:groups"],s=Array.isArray(o)?o:String(o||"").split(",").map(n=>n.trim()).filter(Boolean);return s.includes("ADMIN")||s.includes("COLLAB")}function Q(e){let t=e?.claims||{},o=t["custom:tier"]||t.tier,s="FREE";o&&["FREE","BESTIE","CREATOR","COLLAB","ADMIN","PRIME"].includes(o)&&(s=o);let n=t["cognito:groups"],r=Array.isArray(n)?n:String(n||"").split(",").map(a=>a.trim()).filter(Boolean);return r.includes("ADMIN")?"ADMIN":r.includes("COLLAB")?"COLLAB":r.includes("PRIME")?"PRIME":r.includes("CREATOR")?"CREATOR":r.includes("BESTIE")?"BESTIE":s}function R(e){let t=Q(e);if(!["BESTIE","CREATOR","COLLAB","ADMIN","PRIME"].includes(t))throw new Error("Bestie tier required");return t}async function X(e){let t=C(e);return((await c.send(new u.QueryCommand({TableName:l,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,i.marshall)({":pk":I(t),":sk":"CLOSET#"})}))).Items??[]).map(y).filter(s=>s.id&&s.id!=="undefined")}async function j(e,t){let o=C(t),s=(0,T.randomUUID)(),n=g(),r=e.input,a={id:s,userId:o,ownerSub:o,status:"DRAFT",createdAt:n,updatedAt:n,mediaKey:r.mediaKey??void 0,rawMediaKey:r.rawMediaKey??void 0,title:r.title??void 0,category:r.category??null,subcategory:r.subcategory??null,audience:r.audience??"PRIVATE"};return await c.send(new u.PutItemCommand({TableName:l,Item:(0,i.marshall)({pk:I(o),sk:E(s),gsi1pk:_(a.status),gsi1sk:n,rawMediaKey:a.rawMediaKey,...a})})),a}async function Z(e,t){let o=C(t),s=g(),n=await c.send(new u.UpdateItemCommand({TableName:l,Key:(0,i.marshall)({pk:I(o),sk:E(e.closetItemId)}),UpdateExpression:"SET mediaKey = :mediaKey, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,i.marshall)({":mediaKey":e.mediaKey,":updatedAt":s,":gsi1pk":_("DRAFT"),":gsi1sk":s}),ReturnValues:"ALL_NEW"}));if(!n.Attributes)throw new Error("Item not found");return y(n.Attributes)}async function ee(e,t){let o=C(t),s=g(),n=await c.send(new u.UpdateItemCommand({TableName:l,Key:(0,i.marshall)({pk:I(o),sk:E(e.closetItemId)}),ConditionExpression:"status = :draft",UpdateExpression:"SET status = :pending, updatedAt = :updatedAt, gsi1pk = :gsi1pk, gsi1sk = :gsi1sk",ExpressionAttributeValues:(0,i.marshall)({":draft":"DRAFT",":pending":"PENDING",":updatedAt":s,":gsi1pk":_("PENDING"),":gsi1sk":s}),ReturnValues:"ALL_NEW"}));if(!n.Attributes)throw new Error("Item not found or not in DRAFT status");let r=y(n.Attributes);return await K.send(new h.StartExecutionCommand({stateMachineArn:G,input:JSON.stringify({itemId:r.id,userId:r.userId,ownerSub:r.ownerSub})})),r}async function te(e,t){let o=C(t),{closetItemId:s,story:n}=e,r=g(),a=await c.send(new u.UpdateItemCommand({TableName:l,Key:(0,i.marshall)({pk:I(o),sk:E(s)}),UpdateExpression:"SET storyTitle = :storyTitle, updatedAt = :updatedAt",ExpressionAttributeValues:(0,i.marshall)({":storyTitle":n,":updatedAt":r}),ReturnValues:"ALL_NEW"}));if(!a.Attributes)throw new Error("Item not found");return y(a.Attributes)}async function S(e){let o=((await c.send(new u.ScanCommand({TableName:l,FilterExpression:"sk = :sk",ExpressionAttributeValues:(0,i.marshall)({":sk":E(e)})}))).Items??[])[0];if(!o)throw new Error("Closet item not found");let s=y(o),n=s.userId;if(!n)throw new Error("Closet item missing owner");return{base:s,ownerId:n}}async function se(e,t){let o=C(t),{closetItemId:s}=e,n=g(),{ownerId:r}=await S(s),a={pk:N(s),sk:`LIKE#${o}`,entityType:"LIKE",itemOwnerSub:r,likerSub:o,createdAt:n};try{await c.send(new u.PutItemCommand({TableName:l,Item:(0,i.marshall)(a),ConditionExpression:"attribute_not_exists(sk)"}))}catch(w){if(w?.name!=="ConditionalCheckFailedException")throw w}let d=await c.send(new u.UpdateItemCommand({TableName:l,Key:(0,i.marshall)({pk:I(r),sk:E(s)}),UpdateExpression:"SET likeCount = if_not_exists(likeCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,i.marshall)({":zero":0,":one":1,":now":n}),ReturnValues:"ALL_NEW"}));if(!d.Attributes)throw new Error("Closet item not found");let m=y(d.Attributes);return m.viewerHasLiked=!0,await k({action:"LIKED",closetItemId:s,ownerSub:r,actorSub:o,delta:1}),m}async function ne(e,t){let o=C(t),{closetItemId:s,text:n}=e,r=g(),a=(0,T.randomUUID)(),{ownerId:d}=await S(s),m={pk:N(s),sk:`COMMENT#${a}`,entityType:"COMMENT",closetItemId:s,itemOwnerSub:d,authorSub:o,text:n,createdAt:r};await c.send(new u.PutItemCommand({TableName:l,Item:(0,i.marshall)(m)})),await c.send(new u.UpdateItemCommand({TableName:l,Key:(0,i.marshall)({pk:I(d),sk:E(s)}),UpdateExpression:"SET commentCount = if_not_exists(commentCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,i.marshall)({":zero":0,":one":1,":now":r})}));let w={id:a,closetItemId:s,authorSub:o,text:n,createdAt:r};return await k({action:"COMMENTED",closetItemId:s,ownerSub:d,actorSub:o,commentId:a,commentText:n}),w}async function oe(e,t){let o=C(t),s=O(t),n=e.closetItemId,r=!!e.pinned;if(!n)throw new Error("closetItemId is required");let{base:a}=await S(n);if(!s&&a.userId!==o)throw new Error("Not authorized to pin this closet item.");let d=g(),m=await c.send(new u.UpdateItemCommand({TableName:l,Key:(0,i.marshall)({pk:I(a.userId),sk:E(a.id)}),UpdateExpression:"SET pinned = :pinned, updatedAt = :now",ExpressionAttributeValues:(0,i.marshall)({":pinned":r,":now":d}),ReturnValues:"ALL_NEW"}));if(!m.Attributes)throw new Error("Closet item not found after update");return y(m.Attributes)}async function U(e){let{closetItemId:t}=e;return((await c.send(new u.QueryCommand({TableName:l,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,i.marshall)({":pk":N(t),":sk":"COMMENT#"})}))).Items??[]).map(n=>(0,i.unmarshall)(n)).map(n=>({id:n.sk.replace("COMMENT#",""),closetItemId:n.closetItemId,authorSub:n.authorSub,text:n.text,createdAt:n.createdAt}))}async function re(e){let{closetItemId:t}=e;return((await c.send(new u.QueryCommand({TableName:l,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,i.marshall)({":pk":N(t),":sk":"LIKE#"})}))).Items??[]).map(n=>(0,i.unmarshall)(n)).map(n=>({closetItemId:t,likerSub:n.likerSub,createdAt:n.createdAt}))}async function ie(e){return U(e)}async function ae(e,t){let o=C(t),{closetItemId:s,on:n}=e,r=g(),{ownerId:a}=await S(s),d=I(o),m=`WISHLIST#${s}`;if(n===!1){await c.send(new u.DeleteItemCommand({TableName:l,Key:(0,i.marshall)({pk:d,sk:m})}));let p;try{let A=await c.send(new u.UpdateItemCommand({TableName:l,Key:(0,i.marshall)({pk:I(a),sk:E(s)}),UpdateExpression:"SET wishlistCount = if_not_exists(wishlistCount, :zero) - :one, updatedAt = :now",ConditionExpression:"wishlistCount >= :one",ExpressionAttributeValues:(0,i.marshall)({":zero":0,":one":1,":now":r}),ReturnValues:"ALL_NEW"}));A.Attributes&&(p=y(A.Attributes))}catch(A){if(A?.name!=="ConditionalCheckFailedException")throw A;let L=((await c.send(new u.QueryCommand({TableName:l,KeyConditionExpression:"pk = :pk AND sk = :sk",ExpressionAttributeValues:(0,i.marshall)({":pk":I(a),":sk":E(s)})}))).Items??[])[0];L&&(p=y(L))}if(!p)throw new Error("Closet item not found");return p.viewerHasWishlisted=!1,await k({action:"WISHLIST_TOGGLED",closetItemId:s,ownerSub:a,actorSub:o,delta:-1}),p}let w={pk:d,sk:m,entityType:"WISHLIST",closetItemId:s,ownerSub:a,viewerSub:o,createdAt:r};try{await c.send(new u.PutItemCommand({TableName:l,Item:(0,i.marshall)(w),ConditionExpression:"attribute_not_exists(sk)"}))}catch(p){if(p?.name!=="ConditionalCheckFailedException")throw p}let b=await c.send(new u.UpdateItemCommand({TableName:l,Key:(0,i.marshall)({pk:I(a),sk:E(s)}),UpdateExpression:"SET wishlistCount = if_not_exists(wishlistCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,i.marshall)({":zero":0,":one":1,":now":r}),ReturnValues:"ALL_NEW"}));if(!b.Attributes)throw new Error("Closet item not found");let f=y(b.Attributes);return f.viewerHasWishlisted=!0,await k({action:"WISHLIST_TOGGLED",closetItemId:s,ownerSub:a,actorSub:o,delta:1}),f}async function ue(e){let t=C(e),s=((await c.send(new u.QueryCommand({TableName:l,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:(0,i.marshall)({":pk":I(t),":sk":"WISHLIST#"})}))).Items??[]).map(m=>(0,i.unmarshall)(m));if(!s.length)return[];let n=s.map(m=>({pk:I(m.ownerSub),sk:E(m.closetItemId)})),d=((await c.send(new u.BatchGetItemCommand({RequestItems:{[l]:{Keys:n.map(m=>(0,i.marshall)(m))}}}))).Responses?.[l]??[]).map(y);for(let m of d)m.viewerHasWishlisted=!0;return d}async function de(e){let t=e.source||{},o=e.identity||{},s=t.userId||t.id||o.sub;if(!s)throw new Error("Cannot resolve pinnedClosetItems: missing userId");return((await c.send(new u.QueryCommand({TableName:l,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",FilterExpression:"#pinned = :true AND #status = :published",ExpressionAttributeNames:{"#pinned":"pinned","#status":"status"},ExpressionAttributeValues:(0,i.marshall)({":pk":I(s),":sk":"CLOSET#",":true":!0,":published":"PUBLISHED"})}))).Items??[]).map(y)}async function le(e){let t=e?.arguments||{},o=t.sort||"NEWEST",s=t.limit&&t.limit>0&&t.limit<=50?t.limit:24,n=["APPROVED","PUBLISHED"],r=[];for(let w of n){let f=((await c.send(new u.QueryCommand({TableName:l,IndexName:$,KeyConditionExpression:"gsi1pk = :pk",ExpressionAttributeValues:(0,i.marshall)({":pk":_(w)}),ScanIndexForward:!1,Limit:s*2}))).Items??[]).map(y);r.push(...f)}let a=r.filter(w=>{let b=w.status==="APPROVED"||w.status==="PUBLISHED",p=(w.audience??"PUBLIC")==="PUBLIC";return b&&p}),d=new Map;for(let w of a)d.has(w.id)||d.set(w.id,w);let m=Array.from(d.values());return m.sort((w,b)=>{let f=w.createdAt||"",p=b.createdAt||"";if(o==="MOST_LOVED"){let A=w.favoriteCount??0,x=b.favoriteCount??0;return x!==A?x-A:p.localeCompare(f)}return p.localeCompare(f)}),m.slice(0,s)}async function ce(e,t){let o=C(t),{id:s,favoriteOn:n}=e,r=g(),{ownerId:a}=await S(s),d=N(s),m=`FAVORITE#${o}`;if(n===!1){await c.send(new u.DeleteItemCommand({TableName:l,Key:(0,i.marshall)({pk:d,sk:m})}));let p;try{let A=await c.send(new u.UpdateItemCommand({TableName:l,Key:(0,i.marshall)({pk:I(a),sk:E(s)}),UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) - :one, updatedAt = :now",ConditionExpression:"favoriteCount >= :one",ExpressionAttributeValues:(0,i.marshall)({":zero":0,":one":1,":now":r}),ReturnValues:"ALL_NEW"}));A.Attributes&&(p=y(A.Attributes))}catch(A){if(A?.name!=="ConditionalCheckFailedException")throw A;let L=((await c.send(new u.QueryCommand({TableName:l,KeyConditionExpression:"pk = :pk AND sk = :sk",ExpressionAttributeValues:(0,i.marshall)({":pk":I(a),":sk":E(s)})}))).Items??[])[0];L&&(p=y(L))}if(!p)throw new Error("Closet item not found");return p.viewerHasFaved=!1,p}let w={pk:d,sk:m,entityType:"FAVORITE",closetItemId:s,ownerSub:a,viewerSub:o,createdAt:r};try{await c.send(new u.PutItemCommand({TableName:l,Item:(0,i.marshall)(w),ConditionExpression:"attribute_not_exists(sk)"}))}catch(p){if(p?.name!=="ConditionalCheckFailedException")throw p}let b=await c.send(new u.UpdateItemCommand({TableName:l,Key:(0,i.marshall)({pk:I(a),sk:E(s)}),UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) + :one, updatedAt = :now",ExpressionAttributeValues:(0,i.marshall)({":zero":0,":one":1,":now":r}),ReturnValues:"ALL_NEW"}));if(!b.Attributes)throw new Error("Closet item not found");let f=y(b.Attributes);return f.viewerHasFaved=!0,f}async function me(e,t){R(t);let o=C(t),{closetItemId:s,requestedBackgroundKey:n,mode:r}=e,a=g(),{base:d}=await S(s);if(d.userId!==o&&!O(t))throw new Error("Not authorized to change background for this item");let m=await c.send(new u.UpdateItemCommand({TableName:l,Key:(0,i.marshall)({pk:I(d.userId),sk:E(d.id)}),UpdateExpression:"SET pendingBackgroundKey = :bg, updatedAt = :now",ExpressionAttributeValues:(0,i.marshall)({":bg":n??null,":now":a}),ReturnValues:"ALL_NEW"}));if(!m.Attributes)throw new Error("Closet item not found while setting background");let w=y(m.Attributes);return await K.send(new h.StartExecutionCommand({stateMachineArn:z,input:JSON.stringify({closetItemId:w.id,userId:w.userId,ownerSub:w.ownerSub,requestedBackgroundKey:n??null,mode:r??"REPLACE"})})),w}async function we(e,t){R(t);let o=C(t),s=g(),n=(0,T.randomUUID)(),r=e.input||{},a={id:n,userId:o,ownerSub:o,title:r.title??void 0,createdAt:s,updatedAt:s,status:"DRAFT",closetItemIds:r.closetItemIds??[],scheduledAt:r.scheduledAt??null};return await c.send(new u.PutItemCommand({TableName:l,Item:(0,i.marshall)({pk:I(o),sk:D(n),entityType:"STORY",...a})})),a}async function Ie(e,t){R(t);let o=C(t),{storyId:s,scheduledAt:n}=e,r=g(),a=await c.send(new u.UpdateItemCommand({TableName:l,Key:(0,i.marshall)({pk:I(o),sk:D(s)}),UpdateExpression:"SET #status = :pending, updatedAt = :now, scheduledAt = :scheduledAt",ExpressionAttributeNames:{"#status":"status"},ExpressionAttributeValues:(0,i.marshall)({":pending":"PENDING_PUBLISH",":now":r,":scheduledAt":n??null}),ReturnValues:"ALL_NEW"}));if(!a.Attributes)throw new Error("Story not found");let d=(0,i.unmarshall)(a.Attributes);return await K.send(new h.StartExecutionCommand({stateMachineArn:q,input:JSON.stringify({storyId:d.id,userId:d.userId,ownerSub:d.ownerSub,scheduledAt:d.scheduledAt??null})})),d}async function pe(e,t){R(t);let o=C(t),{closetItemId:s}=e,n=g(),{base:r}=await S(s);if(r.userId!==o&&!O(t))throw new Error("Not authorized to feature this item");let a=await c.send(new u.UpdateItemCommand({TableName:l,Key:(0,i.marshall)({pk:I(r.userId),sk:E(r.id)}),UpdateExpression:"SET inCommunityFeed = :true, updatedAt = :now",ExpressionAttributeValues:(0,i.marshall)({":true":!0,":now":n}),ReturnValues:"ALL_NEW"}));if(!a.Attributes)throw new Error("Closet item not found");let d=y(a.Attributes);return await k({action:"COMMUNITY_FEATURED",closetItemId:s,ownerSub:r.userId,actorSub:o}),d}async function ye(e,t){R(t);let o=C(t),{closetItemId:s}=e,n=g(),{base:r}=await S(s);if(r.userId!==o&&!O(t))throw new Error("Not authorized to unfeature this item");let a=await c.send(new u.UpdateItemCommand({TableName:l,Key:(0,i.marshall)({pk:I(r.userId),sk:E(r.id)}),UpdateExpression:"SET inCommunityFeed = :false, updatedAt = :now",ExpressionAttributeValues:(0,i.marshall)({":false":!1,":now":n}),ReturnValues:"ALL_NEW"}));if(!a.Attributes)throw new Error("Closet item not found");return y(a.Attributes)}async function Ee(e,t){R(t);let o=C(t),{closetItemId:s}=e,n=g(),{ownerId:r}=await S(s),a={pk:N(s),sk:`PINTEREST_SHARE#${(0,T.randomUUID)()}`,entityType:"PINTEREST_SHARE",closetItemId:s,itemOwnerSub:r,sharerSub:o,createdAt:n};return await c.send(new u.PutItemCommand({TableName:l,Item:(0,i.marshall)(a)})),await k({action:"PINTEREST_SHARE_REQUESTED",closetItemId:s,ownerSub:r,actorSub:o}),!0}var Ce=async e=>{console.log("ClosetResolverFn event",JSON.stringify(e));let t=e.info?.fieldName;try{switch(t){case"myCloset":return await X(e.identity);case"myWishlist":return await ue(e.identity);case"createClosetItem":return await j(e.arguments,e.identity);case"updateClosetMediaKey":return await Z(e.arguments,e.identity);case"requestClosetApproval":return await ee(e.arguments,e.identity);case"updateClosetItemStory":return await te(e.arguments,e.identity);case"likeClosetItem":return await se(e.arguments,e.identity);case"commentOnClosetItem":return await ne(e.arguments,e.identity);case"pinHighlight":return await oe(e.arguments,e.identity);case"closetItemComments":return await U(e.arguments);case"adminClosetItemLikes":return await re(e.arguments);case"adminClosetItemComments":return await ie(e.arguments);case"toggleWishlistItem":return await ae(e.arguments,e.identity);case"pinnedClosetItems":return await de(e);case"closetFeed":return await le(e);case"toggleFavoriteClosetItem":return await ce(e.arguments,e.identity);case"requestClosetBackgroundChange":return await me(e.arguments,e.identity);case"createStory":return await we(e.arguments,e.identity);case"publishStory":return await Ie(e.arguments,e.identity);case"addClosetItemToCommunityFeed":return await pe(e.arguments,e.identity);case"removeClosetItemFromCommunityFeed":return await ye(e.arguments,e.identity);case"shareClosetItemToPinterest":return await Ee(e.arguments,e.identity);default:throw new Error(`Unsupported field: ${t}`)}}catch(o){throw console.error("Error in ClosetResolverFn",o),o}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
