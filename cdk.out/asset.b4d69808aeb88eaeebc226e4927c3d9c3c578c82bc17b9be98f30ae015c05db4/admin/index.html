<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Styling Adventures — Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/css/admin.css" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <style>
    /* tiny extras for queue */
    .pill{display:inline-block;padding:.15rem .45rem;border-radius:999px;font:600 11px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .pill.pending{background:#fdf4ff;color:#6b21a8;border:1px solid #f5d0fe}
    .pill.approved{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}
    .pill.rejected{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    .sa-table-wrap{overflow:auto}
    .sa-table{width:100%;border-collapse:separate;border-spacing:0}
    .sa-table th,.sa-table td{padding:.55rem .65rem;border-bottom:1px solid #e5e7eb;text-align:left;vertical-align:top}
    .sa-table thead th{font-weight:600;color:#334155;background:#f8fafc;position:sticky;top:0}
    .sa-btn.link{background:transparent;border:0;color:#2563eb;padding:0;cursor:pointer}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body class="sa-body">
  <div class="page-head">
    <h1>Admin</h1>
    <span class="badge" id="badge-admin" title="Admin only"><span class="dot"></span>ADMIN</span>
    <span class="muted" id="who-line"></span>
    <span class="ml-auto"><a class="sa-link" href="/">← Back to app</a></span>
  </div>

  <!-- Gate -->
  <div id="gate" class="sa-card hidden">
    <h2>Access required</h2>
    <p id="gate-msg" class="muted"></p>
    <p><a class="sa-btn sa-btn-outline" href="/">Go back</a></p>
  </div>

  <!-- Roles block -->
  <div id="admin-block" class="sa-card hidden">
    <h2>Set user role</h2>
    <form id="role-form" class="admin-form" novalidate>
      <div class="row">
        <label>User ID
          <input id="user-id" class="sa-input" required />
        </label>
        <label>Email (optional)
          <input id="user-email" class="sa-input" type="email" />
        </label>
      </div>
      <div class="row">
        <label>Role
          <select id="user-role" class="sa-input">
            <option>FAN</option><option>BESTIE</option><option>CREATOR</option><option>COLLAB</option><option>ADMIN</option>
          </select>
        </label>
        <label>Tier
          <select id="user-tier" class="sa-input">
            <option>FREE</option><option>PRIME</option>
          </select>
        </label>
      </div>
      <div class="row">
        <button class="sa-btn" id="btn-save" type="submit">Save</button>
        <button class="sa-btn sa-btn-outline" id="btn-use-me" type="button" title="Fill with your own ID/email">Use my ID</button>
        <button class="sa-btn sa-btn-outline" id="btn-promote-me" type="button" title="Set yourself to ADMIN quickly">Promote me to ADMIN</button>
        <span id="admin-msg" class="muted ml-2" aria-live="polite"></span>
      </div>
      <p id="hint" class="hint muted">Tip: you can deep-link here with <code>?userId=abc&amp;email=x@y.com</code> to pre-fill the form.</p>
    </form>
  </div>

  <!-- Moderation queue -->
  <div id="mod-block" class="sa-card hidden">
    <div class="row" style="align-items:center">
      <h2 class="mr-2">Moderation queue</h2>
      <button id="btn-reload" class="sa-btn">Reload</button>
      <span id="mod-msg" class="muted ml-2" aria-live="polite"></span>
    </div>
    <div class="sa-table-wrap">
      <table class="sa-table">
        <thead><tr>
          <th>Title</th><th>Owner</th><th>Status</th><th>When</th><th>Media</th><th>Actions</th>
        </tr></thead>
        <tbody id="mod-body"><tr><td colspan="6" class="muted">Loading…</td></tr></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    /* ========================= minimal utils ========================= */
    const $ = s => document.querySelector(s);
    const parseJwt = (t) => { if (!t) return null; try { return JSON.parse(atob(t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));} catch { return null; } };
    const secondsLeft = (id) => { const p=parseJwt(id); return p?.exp ? Math.max(0, p.exp - Math.floor(Date.now()/1000)) : 0; };
    const show = (el, yes) => { if (el) el.classList.toggle('hidden', !yes); };
    const setMsg = (txt, isErr=false) => { const m=$('#admin-msg'); m.textContent = txt || ''; m.className = 'ml-2 ' + (isErr?'err':'muted'); };

    /* ========================== config & auth ========================= */
    async function loadCfg() {
      const r = await fetch('/config.v2.json?ts=' + Date.now(), { cache: 'no-store' });
      if (!r.ok) throw new Error('Failed to load config');
      return r.json();
    }
    const cfg = await loadCfg();

    const hosted = cfg.domain || cfg.hostedUiDomain;
    if (!hosted) throw new Error('Missing Cognito Hosted UI domain in config');
    const domain = `https://${hosted}.auth.${cfg.region}.amazoncognito.com`;

    async function ensureFreshIdToken(minSeconds=60){
      let id = sessionStorage.getItem('id_token');
      if (!id) return null;
      if (secondsLeft(id) > minSeconds) return id;
      try{
        const { refreshTokens, scheduleRotation } = await import('/auth/refresh.js');
        const out = await refreshTokens({ domain, clientId: cfg.clientId });
        scheduleRotation(out, { domain, clientId: cfg.clientId });
        return out.id_token || sessionStorage.getItem('id_token');
      }catch{
        return sessionStorage.getItem('id_token'); // best effort
      }
    }

    async function gql(query, variables={}){
      const id = await ensureFreshIdToken();
      if (!id) throw new Error('Not signed in.');
      const r = await fetch(cfg.appsyncUrl, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', Authorization: id },
        body: JSON.stringify({ query, variables })
      });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(`GraphQL ${r.status}`);
      if (j.errors?.length) throw new Error(j.errors[0]?.message || 'GraphQL error');
      return j.data;
    }

    /* ============================ admin gate =========================== */
    function looksAdminFromJwt(){
      const p = parseJwt(sessionStorage.getItem('id_token') || '');
      const groups = p?.['cognito:groups'] || [];
      return Array.isArray(groups) ? groups.includes('ADMIN') || groups.includes('COLLAB') : /ADMIN|COLLAB/.test(String(groups));
    }

    async function isAdminAuthoritative(){
      try{
        const data = await gql(`query { me { id email role } }`);
        const me = data?.me;
        if (me?.email) $('#who-line').textContent = me.email;
        return me?.role === 'ADMIN' || me?.role === 'COLLAB';
      }catch{
        return looksAdminFromJwt();
      }
    }

    async function gate(){
      const id = sessionStorage.getItem('id_token');
      if (!id){
        $('#gate-msg').textContent = 'You must be signed in to view this page.';
        show($('#gate'), true);
        return false;
      }
      const ok = await isAdminAuthoritative();
      if (!ok){
        $('#gate-msg').textContent = 'Admin or Collab role required. If you believe this is a mistake, sign out and back in after your role is updated.';
        show($('#gate'), true);
        return false;
      }
      show($('#admin-block'), true);
      show($('#mod-block'), true);
      return true;
    }

    /* ============================ form QoL ============================ */
    function prefillFromQuery(){
      const qs = new URLSearchParams(location.search);
      const uid = qs.get('userId'); if (uid) $('#user-id').value = uid;
      const eml = qs.get('email');  if (eml) $('#user-email').value = eml;
    }

    async function useMyId(){
      const id = await ensureFreshIdToken();
      if (!id){ setMsg('Please sign in first', true); return; }
      const p = parseJwt(id);
      $('#user-id').value = p?.sub || '';
      $('#user-email').value = p?.email || '';
      setMsg('Filled with your ID');
    }

    async function promoteMe(){
      const id = await ensureFreshIdToken();
      if (!id){ setMsg('Please sign in first', true); return; }
      const p = parseJwt(id);
      if (!p?.sub){ setMsg('Could not find your user ID', true); return; }
      try{
        const out = await gql(
          `mutation($input:SetUserRoleInput!){
            setUserRole(input:$input){ id role updatedAt }
          }`,
          { input: { userId: p.sub, email: p.email || null, role: 'ADMIN', tier: 'FREE' } }
        );
        setMsg(`You are now ${out.setUserRole.role} ✅`);
      }catch(e){
        setMsg(String(e?.message||e), true);
      }
    }

    /* ============================== submit ============================== */
    const form = document.getElementById('role-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setMsg('');
      const btn = $('#btn-save');
      btn.disabled = true; btn.textContent = 'Saving…';

      const idToken = await ensureFreshIdToken();
      if (!idToken) { setMsg('Sign in first', true); btn.disabled=false; btn.textContent='Save'; return; }

      const userId = /** @type {HTMLInputElement} */(document.getElementById('user-id')).value.trim();
      const email  = /** @type {HTMLInputElement} */(document.getElementById('user-email')).value.trim() || undefined;
      const role   = /** @type {HTMLSelectElement} */(document.getElementById('user-role')).value;
      const tier   = /** @type {HTMLSelectElement} */(document.getElementById('user-tier')).value;

      if (!userId){ setMsg('User ID is required', true); btn.disabled=false; btn.textContent='Save'; return; }

      try {
        await gql(`
          mutation SetUserRole($input: SetUserRoleInput!) {
            setUserRole(input: $input) { id email role tier updatedAt }
          }
        `, { input: { userId, email, role, tier }});
        setMsg('Saved ✔');
      } catch (err) {
        setMsg(String(err?.message || err), true);
      } finally {
        btn.disabled = false; btn.textContent = 'Save';
      }
    });

    // Buttons
    $('#btn-use-me').addEventListener('click', useMyId);
    $('#btn-promote-me').addEventListener('click', promoteMe);

    // ---------- Moderation queue ----------
    const pill = (s)=>{ s=String(s||'').toUpperCase(); const cls=s==='APPROVED'?'approved':s==='REJECTED'?'rejected':'pending'; return `<span class="pill ${cls}">${s}</span>`; };
    const setModMsg = (t,e=false)=>{ const m=$('#mod-msg'); m.textContent=t||''; m.className='muted ml-2'+(e?' err':''); };

    async function loadQueue(){
      const tb = $('#mod-body');
      tb.innerHTML = `<tr><td colspan="6" class="muted">Loading…</td></tr>`;
      try{
        const data = await gql(`query { adminListPending { id title mediaKey ownerSub status createdAt updatedAt } }`);
        const items = data?.adminListPending || [];
        tb.innerHTML = '';
        if(items.length===0){ tb.innerHTML = `<tr><td colspan="6" class="muted">Nothing pending</td></tr>`; return; }
        for(const it of items){
          const tr = document.createElement('tr');
          tr.dataset.id = it.id;
          tr.innerHTML = `
            <td>${(it.title||'').replace(/</g,'&lt;')}</td>
            <td class="nowrap"><code>${it.ownerSub}</code></td>
            <td>${pill(it.status)}</td>
            <td class="nowrap">${new Date(it.updatedAt||it.createdAt).toLocaleString()}</td>
            <td>${it.mediaKey?`<code>${(it.mediaKey.split('/').pop()||'')}</code>`:'—'}</td>
            <td class="nowrap">
              <button class="sa-btn link js-open">Open</button> ·
              <button class="sa-btn link js-approve">Approve</button> ·
              <button class="sa-btn link js-reject">Reject</button>
            </td>`;
          tb.appendChild(tr);
        }
        wireRowActions(items);
      }catch(e){
        setModMsg(String(e?.message||e), true);
      }
    }

    function wireRowActions(items){
      $('#mod-body').querySelectorAll('tr[data-id]').forEach(tr=>{
        const id=tr.dataset.id;
        tr.querySelector('.js-open')?.addEventListener('click', ()=>{
          const it=items.find(x=>x.id===id); if(!it?.mediaKey) return;
          const base=(cfg.thumbsCdn||cfg.cdnUrl||cfg.webOrigin||location.origin).replace(/\/+$/,'');
          const jpg=String(it.mediaKey).replace(/\.[^.]+$/,'.jpg').split('/').map(encodeURIComponent).join('/');
          window.open(`${base}/thumbs/${jpg}`,'_blank','noopener,noreferrer');
        });
        tr.querySelector('.js-approve')?.addEventListener('click', async ()=>{
          try{ await gql(`mutation($id:ID!){ adminApproveItem(id:$id){ id status } }`,{id}); await loadQueue(); setModMsg('Approved ✔'); }
          catch(e){ setModMsg(String(e?.message||e), true); }
        });
        tr.querySelector('.js-reject')?.addEventListener('click', async ()=>{
          const reason = prompt('Reason? (optional)',''); if(reason===null) return;
          try{ await gql(`mutation($id:ID!,$r:String){ adminRejectItem(id:$id, reason:$r){ id status } }`,{id, r:reason||''}); await loadQueue(); setModMsg('Rejected ✔'); }
          catch(e){ setModMsg(String(e?.message||e), true); }
        });
      });
    }

    $('#btn-reload').addEventListener('click', (e)=>{ e.preventDefault(); loadQueue(); });

    // Boot
    prefillFromQuery();
    (async () => {
      const ok = await gate();
      if (ok) await loadQueue();
    })();
  </script>
</body>
</html>

