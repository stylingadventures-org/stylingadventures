<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Styling Adventures — Creator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/css/thumbs.css" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <style>
    .pill{display:inline-block;padding:.15rem .45rem;border-radius:999px;font:600 11px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .pill.pending{background:#fdf4ff;color:#6b21a8;border:1px solid #f5d0fe}
    .pill.approved{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}
    .pill.rejected{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    .pill.published{background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe}

    .sa-table-wrap{overflow:auto}
    .sa-table{width:100%;border-collapse:separate;border-spacing:0}
    .sa-table th,.sa-table td{padding:.6rem .7rem;border-bottom:1px solid #e5e7eb;text-align:left;vertical-align:top}
    .sa-table thead th{font-weight:600;color:#334155;background:#f8fafc;position:sticky;top:0}
    .sa-btn.link{background:transparent;border:0;color:#2563eb;padding:0;cursor:pointer}
    .nowrap{white-space:nowrap}
    .thumb16{width:48px;height:48px;border-radius:8px;object-fit:cover;background:#f1f5f9;display:block}
    .row-actions{display:flex;gap:.6rem;flex-wrap:wrap}
    .muted{color:#64748b}
    .sa-error{color:#b00020}
    .toolbar{display:flex;align-items:center;gap:.75rem;margin:.5rem 0}
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#fff;max-width:min(92vw,780px);width:100%;max-height:80vh;overflow:auto;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:1rem}
    .grid-sm{display:grid;grid-template-columns:64px 1fr;gap:.6rem .75rem;align-items:center}
    .input-inline{border:1px solid #e5e7eb;border-radius:8px;padding:.25rem .4rem}
    code.small{font-size:12px;color:#475569;word-break:break-all}
  </style>
</head>
<body class="sa-body">
  <h1>Creator dashboard</h1>

  <div class="sa-card">
    <h2>New item</h2>
    <form id="new-form" class="admin-form">
      <label>Title
        <input id="new-title" class="sa-input" required maxlength="120" />
      </label>
      <label>Media key (from Uploads)
        <div style="display:flex;gap:.5rem;align-items:center">
          <input id="new-key" class="sa-input" placeholder="users/{sub}/…/file.png" required />
          <button type="button" id="pick-key" class="sa-btn sa-btn-outline">Pick from Uploads</button>
        </div>
      </label>
      <button class="sa-btn" type="submit">Create</button>
      <span id="msg" class="sa-muted ml-2" aria-live="polite"></span>
    </form>
  </div>

  <div class="sa-card">
    <div class="toolbar">
      <button id="btn-reload" class="sa-btn">Reload my items</button>
      <label class="muted">Filter
        <select id="flt" class="sa-input" style="height:32px;padding:.2rem .45rem">
          <option value="ALL">All</option>
          <option value="PENDING">Pending</option>
          <option value="APPROVED">Approved</option>
          <option value="REJECTED">Rejected</option>
          <option value="PUBLISHED">Published</option>
        </select>
      </label>
    </div>
    <div class="sa-table-wrap">
      <table class="sa-table" aria-live="polite">
        <thead>
          <tr><th>Media</th><th>Title</th><th>Status</th><th>When</th><th>Actions</th></tr>
        </thead>
        <tbody id="body"><tr><td colspan="5" class="sa-muted">Loading…</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Media picker modal -->
  <div id="picker" class="modal-back" role="dialog" aria-modal="true" aria-labelledby="picker-title">
    <div class="modal">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:.5rem">
        <h3 id="picker-title" class="m-0">Pick a media key from your uploads</h3>
        <button id="pick-close" class="sa-btn sa-btn-outline sa-sm">Close</button>
      </div>
      <p class="muted" id="pick-msg">Loading…</p>
      <div id="pick-grid" class="grid-sm"></div>
    </div>
  </div>

  <script type="module">
    const q=(s,r=document)=>r.querySelector(s);
    const qq=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const h=(html)=>{const t=document.createElement('template');t.innerHTML=html.trim();return t.content.firstElementChild;}
    const fmt=(iso)=>new Date(iso).toLocaleString();
    const toast=(t,e=false)=>{const m=q('#msg');m.textContent=t;m.className='sa-muted ml-2'+(e?' sa-error':'');}
    const ORIGIN = location.origin;

    async function cfg(){const r=await fetch('/config.v2.json?ts='+Date.now(),{cache:'no-store'});if(!r.ok)throw new Error('cfg');return r.json();}
    const C = await cfg();

    function parseJwt(t){ if(!t) return null; try{ return JSON.parse(atob(t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));}catch{return null;} }
    const id = ()=>sessionStorage.getItem('id_token');

    async function gql(query,variables={}){
      const tok=id(); if(!tok) throw new Error('Please sign in');
      const r=await fetch(C.appsyncUrl,{method:'POST',headers:{'Content-Type':'application/json','Authorization':tok},body:JSON.stringify({query,variables})});
      const j=await r.json(); if(!r.ok||j.errors) throw new Error((j.errors&&j.errors[0]?.message)||'GraphQL error'); return j.data;
    }

    const thumbBase = () => (C.thumbsCdn||C.cdnUrl||C.webOrigin||ORIGIN).replace(/\/+$/,'');
    const thumbUrl  = (key) => `${thumbBase()}/thumbs/${String(key).replace(/\.[^.]+$/,'.jpg').split('/').map(encodeURIComponent).join('/')}`;

    function pill(s){s=String(s||'').toUpperCase();const cls=s==='APPROVED'?'approved':s==='REJECTED'?'rejected':s==='PUBLISHED'?'published':'pending';return `<span class="pill ${cls}">${s||'PENDING'}</span>`}

    let ALL_ITEMS = [];

    function render(items){
      const flt = q('#flt').value;
      const tb=q('#body'); tb.innerHTML='';
      const list = items.filter(it => flt==='ALL' ? true : String(it.status||'').toUpperCase()===flt);
      if(list.length===0){tb.innerHTML='<tr><td colspan="5" class="sa-muted">No items</td></tr>'; return;}

      for(const it of list){
        const row=h(`
          <tr data-id="${it.id}">
            <td class="nowrap">
              ${it.mediaKey ? `<img class="thumb16" src="${thumbUrl(it.mediaKey)}" alt="thumb" onerror="this.style.visibility='hidden'"/>` : '<span class="muted">—</span>'}
              ${it.mediaKey ? `<div><code class="small">${it.mediaKey.split('/').slice(-1)[0]}</code></div>` : ''}
            </td>
            <td>
              <div style="display:flex;gap:.4rem;align-items:center">
                <input class="input-inline js-title" value="${(it.title||'').replace(/"/g,'&quot;')}" maxlength="120" />
                <button class="sa-btn sa-btn-outline sa-sm js-save">Save</button>
              </div>
            </td>
            <td>${pill(it.status)}</td>
            <td class="nowrap">${fmt(it.updatedAt||it.createdAt)}</td>
            <td class="nowrap">
              <div class="row-actions">
                <button class="sa-btn link js-request">Request approval</button>
                ${it.mediaKey?`<button class="sa-btn link js-open">Open</button>`:''}
                <button class="sa-btn link js-copy">Copy ID</button>
                <button class="sa-btn link js-del" style="color:#b91c1c">Delete</button>
              </div>
            </td>
          </tr>
        `);
        tb.appendChild(row);
      }

      // wire actions
      qq('tr[data-id]').forEach(tr=>{
        const idv = tr.getAttribute('data-id');
        tr.querySelector('.js-open')?.addEventListener('click', ()=>{
          const key = ALL_ITEMS.find(x=>x.id===idv)?.mediaKey; if(!key) return;
          window.open(thumbUrl(key),'_blank','noopener,noreferrer');
        });
        tr.querySelector('.js-copy')?.addEventListener('click', async ()=>{
          try{ await navigator.clipboard.writeText(idv); toast('Copied ✔'); } catch{ toast('Copy failed',true); }
        });
        tr.querySelector('.js-request')?.addEventListener('click', async ()=>{
          try{ await gql(`mutation($id:ID!){ requestClosetApproval(id:$id) }`, { id: idv }); toast('Requested approval ✔'); }
          catch(e){ toast(String(e.message||e), true); }
        });
        tr.querySelector('.js-save')?.addEventListener('click', async ()=>{
          const title = tr.querySelector('.js-title')?.value.trim() || '';
          if(!title){ toast('Title required', true); return; }
          try{
            // If your schema differs, adjust this mutation name/shape:
            await gql(`mutation Update($id:ID!,$title:String){ updateClosetItem(id:$id, title:$title){ id } }`, { id: idv, title });
            toast('Saved ✔'); await loadMine();
          }catch(e){ toast(String(e.message||e), true); }
        });
        tr.querySelector('.js-del')?.addEventListener('click', async ()=>{
          if(!confirm('Delete this item?')) return;
          try{
            await gql(`mutation Del($id:ID!){ deleteClosetItem(id:$id) }`, { id: idv });
            toast('Deleted ✔'); await loadMine();
          }catch(e){ toast(String(e.message||e), true); }
        });
      });
    }

    async function loadMine(){
      const data=await gql(`query{ myCloset{ id title status mediaKey createdAt updatedAt } }`);
      ALL_ITEMS = data.myCloset||[];
      render(ALL_ITEMS);
    }

    // ------- uploads picker -------
    function togglePicker(show){ q('#picker').style.display = show ? 'flex' : 'none'; }
    q('#pick-close').addEventListener('click', ()=>togglePicker(false));
    q('#pick-key').addEventListener('click', async ()=>{
      togglePicker(true);
      const msg = q('#pick-msg'); const grid = q('#pick-grid'); grid.innerHTML=''; msg.textContent='Loading…';
      try{
        const tok=id(); if(!tok) throw new Error('Sign in');
        const api=(C.uploadsApiUrl||C.uploadsUrl||C.apiUrl||'').replace(/\/+$/,'');
        const r = await fetch(`${api}/list`, { headers:{ Authorization: tok }});
        if(!r.ok) throw new Error(`List failed ${r.status}`);
        const j = await r.json();
        const items = Array.isArray(j) ? j : (j.items || j.keys || []);
        if(!items.length){ msg.textContent='No uploads yet'; return; }
        msg.textContent='Click a file to use its key:';
        for(const rec of items){
          const key = typeof rec==='string' ? rec : rec.key;
          const el = h(`
            <div class="grid-sm" data-key="${key}">
              <img class="thumb16" src="${thumbUrl(key)}" alt="">
              <div>
                <div>${key.split('/').slice(-1)[0]}</div>
                <code class="small">${key}</code>
              </div>
            </div>
          `);
          el.addEventListener('click', ()=>{
            q('#new-key').value = key;
            togglePicker(false);
            toast('Media key selected ✔');
          });
          grid.appendChild(el);
        }
      }catch(e){
        msg.textContent = 'Failed to load uploads: ' + (e?.message||e);
      }
    });

    // ------- create -------
    q('#new-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const title=q('#new-title').value.trim();
      const mediaKey=q('#new-key').value.trim();
      if(!title||!mediaKey){ toast('Title and media key required',true); return;}
      try{
        await gql(`mutation($t:String,$k:String){ createClosetItem(title:$t, mediaKey:$k){ id } }`,{t:title,k:mediaKey});
        toast('Created ✔'); q('#new-title').value=''; q('#new-key').value=''; await loadMine();
      }catch(err){ toast(String(err.message||err),true); }
    });

    q('#btn-reload').addEventListener('click', e=>{
      e.preventDefault(); loadMine().catch(err=>toast(String(err.message||err),true));
    });
    q('#flt').addEventListener('change', ()=> render(ALL_ITEMS));

    // ------- access guard -------
    const payload = parseJwt(id()||'');
    const groups=(payload?.['cognito:groups']||[]);
    if(!(groups.includes('CREATOR')||groups.includes('COLLAB')||groups.includes('ADMIN'))){
      document.body.innerHTML='<div class="sa-card"><h2>Access</h2><p class="sa-muted">This page is for creators only.</p></div>';
    }else{
      loadMine().catch(err=>toast(String(err.message||err),true));
    }
  </script>
</body>
</html>
