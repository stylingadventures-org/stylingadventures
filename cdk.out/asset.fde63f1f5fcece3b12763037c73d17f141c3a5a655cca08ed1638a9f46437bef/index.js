"use strict";var T=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var W=Object.prototype.hasOwnProperty;var q=(e,n)=>{for(var r in n)T(e,r,{get:n[r],enumerable:!0})},H=(e,n,r,s)=>{if(n&&typeof n=="object"||typeof n=="function")for(let i of j(n))!W.call(e,i)&&i!==r&&T(e,i,{get:()=>n[i],enumerable:!(s=G(n,i))||s.enumerable});return e};var J=e=>H(T({},"__esModule",{value:!0}),e);var re={};q(re,{adminApproveItem:()=>D,adminCreateClosetItem:()=>V,adminListBestieClosetItems:()=>P,adminListClosetItems:()=>k,adminListPending:()=>M,adminRejectItem:()=>R,adminSetClosetAudience:()=>_,adminUpdateClosetItem:()=>U,closetFeed:()=>x,handler:()=>se,toggleFavoriteClosetItem:()=>F,topClosetLooks:()=>K});module.exports=J(re);var d=require("@aws-sdk/client-dynamodb"),S=require("@aws-sdk/client-sfn"),p=new d.DynamoDBClient({}),h=new S.SFNClient({}),{TABLE_NAME:m="",ADMIN_GROUP_NAME:z="admin",CREATOR_GROUP_NAME:Q="creator"}=process.env;if(!m)throw new Error("Missing env: TABLE_NAME");var X=z.toLowerCase(),Y=Q.toLowerCase(),C=()=>new Date().toISOString(),t=e=>({S:e});function Z(e){let n=e?.claims||{},r=n["cognito:groups"]||n["custom:groups"]||e?.groups||[];return Array.isArray(r)?r.map(s=>String(s)):typeof r=="string"?r.split(",").map(s=>s.trim()).filter(Boolean):[]}function b(e){let n=e.identity,r=n?.claims||{},s=n?.sub||r.sub;if(!s)throw new Error("Unauthorized");let i=Z(n),u=i.map(a=>a.toLowerCase()),o=u.includes(X),c=u.includes(Y);return{sub:s,isAdmin:o,isCreator:c,groups:i}}function w(e){return typeof e?.S=="string"?e.S:""}function E(e){return typeof e?.S=="string"?e.S:null}function L(e){let n=e?.N;if(typeof n=="string"){let r=Number(n);return Number.isNaN(r)?null:r}return null}function ee(e){return typeof e?.BOOL=="boolean"?e.BOOL:void 0}function te(e){return Array.isArray(e?.L)?e.L.map(n=>w(n)).filter(Boolean):Array.isArray(e?.SS)?e.SS.filter(n=>typeof n=="string"):null}function f(e,n){let r=w(e.id),s=w(e.ownerSub);(!r||!s)&&console.warn("[ClosetAdmin] mapItem saw item without id/ownerSub",e);let i=w(e.status)||"PENDING",u=L(e.favoriteCount)??0,o=ee(e.pinned);return{id:r,userId:s,ownerSub:s,status:i,createdAt:w(e.createdAt),updatedAt:w(e.updatedAt),mediaKey:E(e.mediaKey)??"",rawMediaKey:E(e.rawMediaKey)??"",title:E(e.title)??"",reason:E(e.reason)??"",season:E(e.season),vibes:E(e.vibes),audience:E(e.audience),category:E(e.category),subcategory:E(e.subcategory),pinned:o,favoriteCount:u,viewerHasFaved:!1,coinValue:L(e.coinValue),backgroundStatus:E(e.backgroundStatus),scheduledAt:E(e.scheduledAt),episodeIds:te(e.episodeIds),...n}}function ne(){return globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`}function N(e){return e?Buffer.from(JSON.stringify(e),"utf8").toString("base64"):null}function O(e){if(e)try{return JSON.parse(Buffer.from(String(e),"base64").toString("utf8"))}catch{return}}var M=async e=>{let{isAdmin:n}=b(e);if(!n)throw new Error("Forbidden");let{limit:r=100,nextToken:s}=e.arguments||{},i=O(s),u=await p.send(new d.QueryCommand({TableName:m,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned, coinValue, backgroundStatus, scheduledAt, episodeIds",ExpressionAttributeNames:{"#s":"status"},Limit:r,ExclusiveStartKey:i}));return{items:(u.Items||[]).map(c=>f({...c,status:c.status})),nextToken:N(u.LastEvaluatedKey)}},k=async e=>{let{isAdmin:n}=b(e);if(!n)throw new Error("Forbidden");let{status:r,limit:s=50,nextToken:i}=e.arguments||{},u=O(i);if(r){let a=await p.send(new d.QueryCommand({TableName:m,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t(`STATUS#${r}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned, coinValue, backgroundStatus, scheduledAt, episodeIds",ExpressionAttributeNames:{"#s":"status"},Limit:s,ExclusiveStartKey:u}));return{items:(a.Items||[]).map(l=>f({...l,status:l.status})),nextToken:N(a.LastEvaluatedKey)}}let o=await p.send(new d.ScanCommand({TableName:m,FilterExpression:"begins_with(pk, :p)",ExpressionAttributeValues:{":p":t("ITEM#")},ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory, pinned, coinValue, backgroundStatus, scheduledAt, episodeIds",ExpressionAttributeNames:{"#s":"status"},Limit:s,ExclusiveStartKey:u})),c=(o.Items||[]).map(a=>f({...a,status:a.status}));return c.sort((a,g)=>new Date(g.createdAt||0).getTime()-new Date(a.createdAt||0).getTime()),{items:c,nextToken:N(o.LastEvaluatedKey)}},P=async e=>{let n=await k(e),r=new Set(["BESTIE","EXCLUSIVE"]),s=n.items.filter(i=>{let u=(i.audience||"").toUpperCase();return r.has(u)});return{...n,items:s}},x=async e=>{let{sub:n}=b(e),s=(e.arguments?.sort??"NEWEST")==="MOST_LOVED"?"MOST_LOVED":"NEWEST",i=["APPROVED","PUBLISHED"],u=await p.send(new d.QueryCommand({TableName:m,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:{":pk":t(`FAV#${n}`),":sk":t("CLOSET#")}})),o=new Set((u.Items||[]).map(a=>{let g=a.sk?.S??"";return g.startsWith("CLOSET#")?g.substring(7):a.closetId?.S??""})),c=[];for(let a of i){let l=((await p.send(new d.QueryCommand({TableName:m,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":t(`STATUS#${a}`)},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, audience, favoriteCount, category, subcategory, season, vibes, pinned, coinValue, backgroundStatus, scheduledAt, episodeIds",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(y=>f({...y,status:y.status},{viewerHasFaved:o.has(y.id?.S)}));c.push(...l)}return c.sort((a,g)=>{let l=new Date(a.createdAt||0).getTime(),y=new Date(g.createdAt||0).getTime();if(s==="MOST_LOVED"){let A=a.favoriteCount??0,I=g.favoriteCount??0;return I!==A?I-A:y-l}return y-l}),{items:c,nextToken:null}},K=async e=>(await x({...e,arguments:{...e.arguments||{},sort:"NEWEST"}})).items,V=async e=>{let{sub:n,isAdmin:r}=b(e);if(!r)throw new Error("Forbidden");let s=e.arguments?.input||{};if(!s.title?.trim())throw new Error("title is required");let i=s.rawMediaKey||s.mediaKey;if(!i)throw new Error("rawMediaKey is required");let u=ne(),o=C();return await p.send(new d.PutItemCommand({TableName:m,Item:{pk:t(`ITEM#${u}`),sk:t("META"),id:t(u),ownerSub:t(n),gsi2pk:t("STATUS#PENDING"),gsi2sk:t(o),status:t("PENDING"),createdAt:t(o),updatedAt:t(o),title:t(s.title.trim()),rawMediaKey:t(i),favoriteCount:{N:"0"},...s.season?{season:t(s.season)}:{},...s.vibes?{vibes:t(s.vibes)}:{},...s.category?{category:t(s.category)}:{},...s.subcategory?{subcategory:t(s.subcategory)}:{},...s.audience?{audience:t(s.audience)}:{},...s.description?{description:t(s.description)}:{},...s.story?{story:t(s.story)}:{}}})),{id:u,userId:n,ownerSub:n,status:"PENDING",createdAt:o,updatedAt:o,title:s.title.trim(),mediaKey:"",rawMediaKey:i,reason:"",season:s.season??null,vibes:s.vibes??null,audience:s.audience??null,category:s.category??null,subcategory:s.subcategory??null,favoriteCount:0,viewerHasFaved:!1}},D=async e=>{let{isAdmin:n}=b(e);if(!n)throw new Error("Forbidden");let r=e.arguments?.closetItemId;if(!r)throw new Error("closetItemId required");let s=C(),u=(await p.send(new d.UpdateItemCommand({TableName:m,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("APPROVED"),":u":t(s),":g2pk":t("STATUS#APPROVED"),":g2sk":t(s)},ReturnValues:"ALL_OLD"}))).Attributes,o=u.approvalToken?.S;if(o)try{await h.send(new S.SendTaskSuccessCommand({taskToken:o,output:JSON.stringify({approved:!0})}))}catch{}return f({...u,status:t("APPROVED")})},R=async e=>{let{isAdmin:n}=b(e);if(!n)throw new Error("Forbidden");let r=e.arguments?.closetItemId,s=e.arguments?.reason||"";if(!r)throw new Error("closetItemId required");let i=C(),o=(await p.send(new d.UpdateItemCommand({TableName:m,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":t("REJECTED"),":u":t(i),":g2pk":t("STATUS#REJECTED"),":g2sk":t(i),":r":t(s)},ReturnValues:"ALL_OLD"}))).Attributes,c=o.approvalToken?.S;if(c)try{await h.send(new S.SendTaskFailureCommand({taskToken:c,error:"Rejected",cause:s||"Rejected by admin"}))}catch{}return f({...o,status:t("REJECTED"),reason:t(s)})},U=async e=>{let{isAdmin:n}=b(e);if(!n)throw new Error("Forbidden");let r=e.arguments||{},s=r.input||{},i=r.closetItemId??s.id??r.id;if(!i)throw new Error("closetItemId or input.id required");if(!(await p.send(new d.GetItemCommand({TableName:m,Key:{pk:t(`ITEM#${i}`),sk:t("META")}}))).Item)throw new Error("Closet item not found");let o={...s};["title","category","subcategory","audience","pinned","season","vibes"].forEach(A=>{r[A]!==void 0&&o[A]===void 0&&(o[A]=r[A])});let c=C(),a=["#updatedAt = :u"],g={"#updatedAt":"updatedAt"},l={":u":t(c)};if(o.title!==void 0&&(a.push("#title = :title"),g["#title"]="title",l[":title"]=o.title===null?{NULL:!0}:t(o.title)),o.category!==void 0&&(a.push("#category = :category"),g["#category"]="category",l[":category"]=o.category===null?{NULL:!0}:t(o.category)),o.subcategory!==void 0&&(a.push("#subcategory = :subcategory"),g["#subcategory"]="subcategory",l[":subcategory"]=o.subcategory===null?{NULL:!0}:t(o.subcategory)),o.audience!==void 0&&(a.push("audience = :audience"),l[":audience"]=o.audience===null?{NULL:!0}:t(o.audience)),o.season!==void 0&&(a.push("season = :season"),l[":season"]=o.season===null?{NULL:!0}:t(o.season)),o.vibes!==void 0&&(a.push("vibes = :vibes"),l[":vibes"]=o.vibes===null?{NULL:!0}:t(o.vibes)),o.pinned!==void 0&&(a.push("pinned = :pinned"),l[":pinned"]=o.pinned===null?{NULL:!0}:{BOOL:!!o.pinned}),a.length===1)throw new Error("No fields provided to update");let y=await p.send(new d.UpdateItemCommand({TableName:m,Key:{pk:t(`ITEM#${i}`),sk:t("META")},UpdateExpression:`SET ${a.join(", ")}`,ExpressionAttributeNames:g,ExpressionAttributeValues:l,ReturnValues:"ALL_NEW"}));if(!y.Attributes)throw new Error("Closet item not found");return f(y.Attributes)},_=async e=>{let{isAdmin:n}=b(e);if(!n)throw new Error("Forbidden");let r=e.arguments?.closetItemId,s=e.arguments?.audience;if(!r)throw new Error("closetItemId required");if(!s)throw new Error("audience required");let i=C(),u=await p.send(new d.UpdateItemCommand({TableName:m,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET audience = :aud, updatedAt = :u",ExpressionAttributeValues:{":aud":t(s),":u":t(i)},ReturnValues:"ALL_NEW"}));if(!u.Attributes)throw new Error("Closet item not found");return f(u.Attributes)},F=async e=>{let{sub:n}=b(e),r=e.arguments?.id,s=e.arguments?.favoriteOn,i=e.arguments?.on,u=typeof s=="boolean"?s:i;if(!r)throw new Error("id required");let c=(await p.send(new d.GetItemCommand({TableName:m,Key:{pk:t(`ITEM#${r}`),sk:t("META")}}))).Item;if(!c)throw new Error("Closet item not found");let a={pk:t(`FAV#${n}`),sk:t(`CLOSET#${r}`)},l=!!(await p.send(new d.GetItemCommand({TableName:m,Key:a}))).Item,y=typeof u=="boolean"?u:!l,A=C(),I=0;y&&!l?(I=1,await p.send(new d.PutItemCommand({TableName:m,Item:{...a,userSub:t(n),closetId:t(r),createdAt:t(A)}}))):!y&&l&&(I=-1,await p.send(new d.DeleteItemCommand({TableName:m,Key:a}))),I!==0&&await p.send(new d.UpdateItemCommand({TableName:m,Key:{pk:t(`ITEM#${r}`),sk:t("META")},UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) + :delta, updatedAt = :u",ExpressionAttributeValues:{":zero":{N:"0"},":delta":{N:String(I)},":u":t(A)}}));let v=c.favoriteCount?.N,B=typeof v=="string"?Number(v):0,$=Math.max(0,B+I);return f(c,{favoriteCount:$,viewerHasFaved:y})},se=async e=>{let n=e.info.fieldName;if(n==="adminListPending")return M(e);if(n==="adminListClosetItems")return k(e);if(n==="adminListBestieClosetItems")return P(e);if(n==="adminCreateClosetItem")return V(e);if(n==="adminApproveItem")return D(e);if(n==="adminRejectItem")return R(e);if(n==="adminSetClosetAudience")return _(e);if(n==="adminUpdateClosetItem")return U(e);if(n==="closetFeed")return x(e);if(n==="topClosetLooks")return K(e);if(n==="toggleFavoriteClosetItem"||n==="likeClosetItem")return F(e);throw new Error(`No resolver implemented for field ${n}`)};0&&(module.exports={adminApproveItem,adminCreateClosetItem,adminListBestieClosetItems,adminListClosetItems,adminListPending,adminRejectItem,adminSetClosetAudience,adminUpdateClosetItem,closetFeed,handler,toggleFavoriteClosetItem,topClosetLooks});
//# sourceMappingURL=index.js.map
