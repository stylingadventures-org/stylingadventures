"use strict";var v=Object.create;var l=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var T=Object.getPrototypeOf,R=Object.prototype.hasOwnProperty;var N=(e,n)=>{for(var t in n)l(e,t,{get:n[t],enumerable:!0})},_=(e,n,t,s)=>{if(n&&typeof n=="object"||typeof n=="function")for(let i of B(n))!R.call(e,i)&&i!==t&&l(e,i,{get:()=>n[i],enumerable:!(s=C(n,i))||s.enumerable});return e};var k=(e,n,t)=>(t=e!=null?v(T(e)):{},_(n||!e||!e.__esModule?l(t,"default",{value:e,enumerable:!0}):t,e)),L=e=>_(l({},"__esModule",{value:!0}),e);var O={};N(O,{handler:()=>M});module.exports=L(O);var E=require("@aws-sdk/client-cognito-identity-provider"),D=require("@aws-sdk/client-dynamodb"),o=require("@aws-sdk/lib-dynamodb"),h=k(require("stripe")),{USER_POOL_ID:U="",TABLE_NAME:w=""}=process.env;if(!w)throw new Error("Missing env TABLE_NAME");if(!U)throw new Error("Missing env USER_POOL_ID");var g=process.env.STRIPE_SECRET_KEY||"",y=process.env.STRIPE_PRICE_ID||"",I=(process.env.BASE_SUCCESS_URL||"http://localhost:5173").replace(/\/$/,""),P=new E.CognitoIdentityProviderClient({}),f=o.DynamoDBDocumentClient.from(new D.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),S=e=>`USER#${e}`,p="BESTIE";async function m(e){let t=(await f.send(new o.GetCommand({TableName:w,Key:{pk:S(e),sk:p}}))).Item??{};return{active:!!t.active,since:t.since??null,until:t.until??null,source:t.source??null}}async function u(e,n){let t=new Date().toISOString();return await f.send(new o.UpdateCommand({TableName:w,Key:{pk:S(e),sk:p},UpdateExpression:"SET #doc = if_not_exists(#doc, :empty), updatedAt = :now",ExpressionAttributeNames:{"#doc":"doc"},ExpressionAttributeValues:{":empty":{},":now":t}})),await f.send(new o.UpdateCommand({TableName:w,Key:{pk:S(e),sk:p},UpdateExpression:"SET active = :a, since = if_not_exists(since, :since), until = :u, source = :s, updatedAt = :now",ExpressionAttributeValues:{":a":n.active,":since":n.since??t,":u":n.until??null,":s":n.source??null,":now":t}})),m(e)}async function A(e){let t=(await P.send(new E.ListUsersCommand({UserPoolId:U,Filter:`email = "${e}"`,Limit:1}))).Users?.[0];return t?.Attributes?t.Attributes.find(i=>i.Name==="sub")?.Value??null:null}function d(e){let n=e?.groups;return Array.isArray(n)&&n.includes("ADMIN")}var M=async e=>{let n=e.identity,t=e.info?.fieldName;if(t==="startBestieCheckout"){let s=e.identity;if(!s?.sub)throw new Error("Unauthorized");if(!g||!y)throw new Error("Stripe not configured");let i=new h.default(g),r=e.arguments?.successPath??"/bestie/thanks",a=`${I}${r}`,c=`${I}/bestie?cancelled=1`,b=await i.checkout.sessions.create({mode:"subscription",line_items:[{price:y,quantity:1}],success_url:`${a}?session_id={CHECKOUT_SESSION_ID}`,cancel_url:c,client_reference_id:s.sub,customer_email:s?.claims?.email,metadata:{sub:s.sub,email:s?.claims?.email??""},allow_promotion_codes:!0});if(!b.url)throw new Error("No checkout URL from Stripe");return{url:b.url}}if(t==="meBestieStatus"){if(!n?.sub)throw new Error("Unauthorized");return m(n.sub)}if(t==="isEpisodeEarlyAccess"){let s=Date.now(),i=n?.sub;if(!i)return{allowed:!1,reason:"not_signed_in"};let r=await m(i),a=r.until?Date.parse(r.until):0,c=r.active&&a>s;return{allowed:c,reason:c?null:"not_bestie"}}if(t==="claimBestieTrial"){if(!n?.sub)throw new Error("Unauthorized");let s=await m(n.sub);if(s.active&&s.until&&Date.parse(s.until)>Date.now()||s.source==="TRIAL")return s;let i=10080*60*1e3,r=new Date(Date.now()+i).toISOString();return u(n.sub,{active:!0,until:r,source:"TRIAL"})}if(t==="adminSetBestie"){if(!d(n))throw new Error("Forbidden");let{userSub:s,active:i}=e.arguments,r=i?new Date(Date.now()+365*24*60*60*1e3).toISOString():null;return u(s,{active:!!i,until:r,source:"ADMIN"})}if(t==="adminRevokeBestie"){if(!d(n))throw new Error("Forbidden");let{userSub:s}=e.arguments;return u(s,{active:!1,until:null,source:"ADMIN"})}if(t==="adminSetBestieByEmail"){if(!d(n))throw new Error("Forbidden");let{email:s,active:i}=e.arguments,r=await A(s);if(!r)throw new Error("User not found");let a=i?new Date(Date.now()+365*24*60*60*1e3).toISOString():null;return u(r,{active:!!i,until:a,source:"ADMIN_EMAIL"})}if(t==="adminRevokeBestieByEmail"){if(!d(n))throw new Error("Forbidden");let{email:s}=e.arguments,i=await A(s);if(!i)throw new Error("User not found");return u(i,{active:!1,until:null,source:"ADMIN_EMAIL"})}throw new Error(`Unknown field ${t}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
