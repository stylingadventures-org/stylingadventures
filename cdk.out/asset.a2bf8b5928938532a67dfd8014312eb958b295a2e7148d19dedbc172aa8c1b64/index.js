"use strict";var D=Object.defineProperty;var re=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var oe=Object.prototype.hasOwnProperty;var ae=(e,t)=>{for(var r in t)D(e,r,{get:t[r],enumerable:!0})},se=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of ne(t))!oe.call(e,o)&&o!==r&&D(e,o,{get:()=>t[o],enumerable:!(n=re(t,o))||n.enumerable});return e};var ie=e=>se(D({},"__esModule",{value:!0}),e);var Je={};ae(Je,{handler:()=>Ye});module.exports=ie(Je);var z=require("@aws-sdk/client-dynamodb"),d=require("@aws-sdk/lib-dynamodb");var g=[];for(let e=0;e<256;++e)g.push((e+256).toString(16).slice(1));function H(e,t=0){return(g[e[t+0]]+g[e[t+1]]+g[e[t+2]]+g[e[t+3]]+"-"+g[e[t+4]]+g[e[t+5]]+"-"+g[e[t+6]]+g[e[t+7]]+"-"+g[e[t+8]]+g[e[t+9]]+"-"+g[e[t+10]]+g[e[t+11]]+g[e[t+12]]+g[e[t+13]]+g[e[t+14]]+g[e[t+15]]).toLowerCase()}var V=require("crypto"),P=new Uint8Array(256),O=P.length;function L(){return O>P.length-16&&((0,V.randomFillSync)(P),O=0),P.slice(O,O+=16)}var F=require("crypto"),U={randomUUID:F.randomUUID};function de(e,t,r){if(U.randomUUID&&!t&&!e)return U.randomUUID();e=e||{};let n=e.random??e.rng?.()??L();if(n.length<16)throw new Error("Random bytes length must be >= 16");if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,t){if(r=r||0,r<0||r+16>t.length)throw new RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let o=0;o<16;++o)t[r+o]=n[o];return t}return H(n)}var C=de;var _=require("@aws-sdk/client-s3"),W=require("@aws-sdk/s3-request-presigner"),$=require("@aws-sdk/client-sfn"),l=d.DynamoDBDocumentClient.from(new z.DynamoDBClient({})),ue=new _.S3Client({}),le=new $.SFNClient({}),c=process.env.TABLE_NAME,ce=process.env.CREATOR_MEDIA_BUCKET,i=process.env.PK_NAME||"pk",u=process.env.SK_NAME||"sk",v=process.env.STATUS_GSI||"gsi1",G=process.env.SOCIAL_PULSE_SFN_ARN||"";function E(){return new Date().toISOString()}async function pe(e){let t=e.arguments?.window||"LAST_30_DAYS",r=t==="LAST_7_DAYS"?7:t==="LAST_90_DAYS"?90:30,n="USD",o=[{platform:"tiktok",label:"TikTok / Reels",currency:n,amount:420.5,lastPayoutAt:new Date().toISOString()},{platform:"youtube",label:"YouTube",currency:n,amount:310.2,lastPayoutAt:new Date(Date.now()-3*864e5).toISOString()},{platform:"instagram",label:"Instagram",currency:n,amount:165,lastPayoutAt:null}],s=o.reduce((f,m)=>f+m.amount,0),a=new Date,p=Array.from({length:r}).map((f,m)=>{let y=new Date(a);y.setDate(a.getDate()-(r-1-m));let w=s/r,I=m/(r-1||1)*.4+.8;return{date:y.toISOString().slice(0,10),totalRevenue:Math.round(w*I*100)/100}}),A=p.reduce((f,m)=>f+m.totalRevenue,0);return{currency:n,totalRevenue:A,platforms:o,timeseries:p}}async function Ae(e,t){if(!e)throw new Error("Not authenticated");if(!t)throw new Error("id is required");let r=`CREATOR#${e}`,n=`DIRECTOR_SHOOT#${t}`,o=await l.send(new d.GetCommand({TableName:c,Key:{[i]:r,[u]:n}}));if(!o.Item)return null;let s=o.Item;return{id:s.id,creatorId:e,shootName:s.shootName,primaryPlatform:s.primaryPlatform,objective:s.objective,scenes:s.scenes||[],createdAt:s.createdAt,updatedAt:s.updatedAt}}async function me(e,t){if(!e)throw new Error("Not authenticated");if(!t)throw new Error("input is required");let r=t.id||"default",n=E(),o=`CREATOR#${e}`,s=`DIRECTOR_SHOOT#${r}`,a={[i]:o,[u]:s,id:r,creatorId:e,shootName:t.shootName,primaryPlatform:t.primaryPlatform,objective:t.objective,scenes:t.scenes||[],createdAt:n,updatedAt:n,type:"DIRECTOR_SHOOT_PLAN"};return await l.send(new d.PutCommand({TableName:c,Item:a})),{id:r,creatorId:e,shootName:a.shootName,primaryPlatform:a.primaryPlatform,objective:a.objective,scenes:a.scenes,createdAt:a.createdAt,updatedAt:a.updatedAt}}function B(e){return e?{id:e.id,ownerSub:e.ownerSub,name:e.name,description:e.description??null,defaultCategory:e.defaultCategory??null,tags:e.tags??[],createdAt:e.createdAt,updatedAt:e.updatedAt,assetCount:e.assetCount??0}:null}function K(e){return e?{id:e.id,cabinetId:e.cabinetId,name:e.name,specialKind:e.specialKind??null,createdAt:e.createdAt,updatedAt:e.updatedAt}:null}function b(e){return e?{id:e.id,cabinetId:e.cabinetId,folderId:e.folderId??null,ownerSub:e.ownerSub,kind:e.kind??"OTHER",category:e.category??null,title:e.title??null,notes:e.notes??null,tags:e.tags??[],s3Key:e.s3Key,contentType:e.contentType??null,createdAt:e.createdAt,updatedAt:e.updatedAt,moderationStatus:e.moderationStatus??"ACTIVE",moderationReason:e.moderationReason??null,moderatedBy:e.moderatedBy??null,moderatedAt:e.moderatedAt??null}:null}function Y(e){return e?{id:e.id,creatorId:e.creatorId,title:e.title,description:e.description??null,goalCompassSnapshot:e.goalCompassSnapshot??null,timeHorizonFrom:e.timeHorizonFrom??null,timeHorizonTo:e.timeHorizonTo??null,createdAt:e.createdAt,updatedAt:e.updatedAt}:null}function J(e){return e?{id:e.id,boardId:e.boardId,creatorId:e.creatorId,title:e.title,platform:e.platform,status:e.status??"IDEA",notes:e.notes??null,pulseId:e.pulseId??null,contentIdeaId:e.contentIdeaId??null,emotionalToneLabels:e.emotionalToneLabels??[],audienceResponseLabel:e.audienceResponseLabel??null,brandAlignmentScore:typeof e.brandAlignmentScore=="number"?e.brandAlignmentScore:null,prRiskLevel:e.prRiskLevel??null,lastEmotionalReviewAt:e.lastEmotionalReviewAt??null,directorShootPlanId:e.directorShootPlanId??null,directorAssetIds:e.directorAssetIds??[],scheduleSlotId:e.scheduleSlotId??null,createdAt:e.createdAt,updatedAt:e.updatedAt}:null}function q(e,t){if(!e)return null;let r=e[u],n=e.id;return!n&&typeof r=="string"&&r.startsWith("PULSE#")&&(n=r.slice(6)),{id:n,creatorId:e.creatorId??t,niche:e.niche??null,platforms:Array.isArray(e.platforms)?e.platforms:[],trendBriefs:Array.isArray(e.trendBriefs)?e.trendBriefs:[],contentIdeas:Array.isArray(e.contentIdeas)?e.contentIdeas:[],createdAt:e.createdAt??e.updatedAt??E()}}async function fe(e){let r=(await l.send(new d.QueryCommand({TableName:c,IndexName:v,KeyConditionExpression:"#gpk = :gpk AND begins_with(#gsk, :prefix)",ExpressionAttributeNames:{"#gpk":"gsi1pk","#gsk":"gsi1sk"},ExpressionAttributeValues:{":gpk":`CREATOR#${e}`,":prefix":"CAB#"}}))).Items??[];return r.length===0&&(r=[await we(e)]),r.map(B)}async function x(e,t){if(!t)throw new Error("id is required");let r=await l.send(new d.GetCommand({TableName:c,Key:{[i]:`CAB#${t}`,[u]:"META"}}));return!r.Item||r.Item.ownerSub!==e?null:B(r.Item)}async function we(e){let t=E(),r=C(),n={[i]:`CAB#${r}`,[u]:"META",type:"CABINET",id:r,ownerSub:e,name:"From my closet",description:"Imported looks and outfit references from your Bestie closet",defaultCategory:"OUTFIT_REFS",tags:["closet-import"],assetCount:0,createdAt:t,updatedAt:t,gsi1pk:`CREATOR#${e}`,gsi1sk:`CAB#${t}#${r}`};return await l.send(new d.PutCommand({TableName:c,Item:n,ConditionExpression:"attribute_not_exists(#pk)",ExpressionAttributeNames:{"#pk":i}})),n}async function ye(e,t){if(!t?.name)throw new Error("name is required");let r=C(),n=E(),o={[i]:`CAB#${r}`,[u]:"META",type:"CABINET",id:r,ownerSub:e,name:t.name,description:t.description??null,defaultCategory:t.defaultCategory??null,tags:t.tags??[],assetCount:0,createdAt:n,updatedAt:n,gsi1pk:`CREATOR#${e}`,gsi1sk:`CAB#${n}#${r}`};return await l.send(new d.PutCommand({TableName:c,Item:o,ConditionExpression:"attribute_not_exists(#pk)",ExpressionAttributeNames:{"#pk":i}})),B(o)}async function Ee(e,t){let r=t?.id;if(!r)throw new Error("id is required");if(!t)throw new Error("input is required");let n=E(),o={"#updatedAt":"updatedAt","#ownerSub":"ownerSub"},s={":updatedAt":n,":ownerSub":e},a=["#updatedAt = :updatedAt"];Object.prototype.hasOwnProperty.call(t,"name")&&(o["#name"]="name",s[":name"]=t.name,a.push("#name = :name")),Object.prototype.hasOwnProperty.call(t,"description")&&(o["#description"]="description",s[":description"]=t.description??null,a.push("#description = :description")),Object.prototype.hasOwnProperty.call(t,"defaultCategory")&&(o["#defaultCategory"]="defaultCategory",s[":defaultCategory"]=t.defaultCategory??null,a.push("#defaultCategory = :defaultCategory")),Object.prototype.hasOwnProperty.call(t,"tags")&&(o["#tags"]="tags",s[":tags"]=t.tags??[],a.push("#tags = :tags"));let p=await l.send(new d.UpdateCommand({TableName:c,Key:{[i]:`CAB#${r}`,[u]:"META"},UpdateExpression:"SET "+a.join(", "),ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:o,ExpressionAttributeValues:s,ReturnValues:"ALL_NEW"}));return B(p.Attributes)}async function Se(e,t){if(!t)throw new Error("id is required");let r=`CAB#${t}`,o=(await l.send(new d.QueryCommand({TableName:c,KeyConditionExpression:"#pk = :pk",ExpressionAttributeNames:{"#pk":i},ExpressionAttributeValues:{":pk":r}}))).Items??[],s=o.find(a=>a.type==="CABINET");return!s||s.ownerSub!==e?!1:(await Promise.all(o.map(a=>l.send(new d.DeleteCommand({TableName:c,Key:{[i]:a[i],[u]:a[u]}})))),!0)}async function j(e,t){if(!t)throw new Error("cabinetId is required");return await x(e,t)?((await l.send(new d.QueryCommand({TableName:c,KeyConditionExpression:"#pk = :pk AND begins_with(#sk, :prefix)",ExpressionAttributeNames:{"#pk":i,"#sk":u},ExpressionAttributeValues:{":pk":`CAB#${t}`,":prefix":"FOLDER#"}}))).Items??[]).map(K):[]}async function ge(e,t){let{cabinetId:r,name:n}=t||{};if(!r)throw new Error("cabinetId is required");if(!n)throw new Error("name is required");if(!await x(e,r))throw new Error("Cabinet not found");let s=C(),a=E(),p={[i]:`CAB#${r}`,[u]:`FOLDER#${s}`,type:"FOLDER",id:s,cabinetId:r,ownerSub:e,name:n,specialKind:null,createdAt:a,updatedAt:a};return await l.send(new d.PutCommand({TableName:c,Item:p,ConditionExpression:"attribute_not_exists(#pk) AND attribute_not_exists(#sk)",ExpressionAttributeNames:{"#pk":i,"#sk":u}})),K(p)}async function Ce(e,t){let{id:r,cabinetId:n,name:o}=t||{};if(!r)throw new Error("id is required");if(!n)throw new Error("cabinetId is required");if(!o)throw new Error("name is required");let s=E(),a=await l.send(new d.UpdateCommand({TableName:c,Key:{[i]:`CAB#${n}`,[u]:`FOLDER#${r}`},UpdateExpression:"SET #name = :name, #updatedAt = :updatedAt",ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:{"#name":"name","#updatedAt":"updatedAt","#ownerSub":"ownerSub"},ExpressionAttributeValues:{":name":o,":updatedAt":s,":ownerSub":e},ReturnValues:"ALL_NEW"}));return K(a.Attributes)}async function be(e,t,r){if(!t)throw new Error("id is required");if(!r)throw new Error("cabinetId is required");await l.send(new d.DeleteCommand({TableName:c,Key:{[i]:`CAB#${r}`,[u]:`FOLDER#${t}`},ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:{"#ownerSub":"ownerSub"},ExpressionAttributeValues:{":ownerSub":e}}));let o=(await l.send(new d.QueryCommand({TableName:c,KeyConditionExpression:"#pk = :pk AND begins_with(#sk, :prefix)",ExpressionAttributeNames:{"#pk":i,"#sk":u,"#folderId":"folderId"},ExpressionAttributeValues:{":pk":`CAB#${r}`,":prefix":"ASSET#",":folderId":t},FilterExpression:"#folderId = :folderId"}))).Items??[];return await Promise.all(o.map(s=>l.send(new d.UpdateCommand({TableName:c,Key:{[i]:s[i],[u]:s[u]},UpdateExpression:"SET #folderId = :null",ExpressionAttributeNames:{"#folderId":"folderId"},ExpressionAttributeValues:{":null":null}})))),!0}async function Ie(e,t){let{cabinetId:r,folderId:n,category:o,tag:s,search:a,limit:p=50,nextToken:A}=t||{};if(!r)throw new Error("cabinetId is required");if(!await x(e,r))return{items:[],nextToken:null};let m={TableName:c,KeyConditionExpression:"#pk = :pk AND begins_with(#sk, :prefix)",ExpressionAttributeNames:{"#pk":i,"#sk":u},ExpressionAttributeValues:{":pk":`CAB#${r}`,":prefix":"ASSET#"},Limit:p};A&&(m.ExclusiveStartKey={[i]:`CAB#${r}`,[u]:A});let y=await l.send(new d.QueryCommand(m)),w=(y.Items??[]).filter(S=>S.type==="ASSET");if(w=w.filter(S=>String(S.moderationStatus??"ACTIVE").toUpperCase()==="ACTIVE"),n!=null&&(w=w.filter(S=>S.folderId===n)),o&&(w=w.filter(S=>S.category===o)),s&&(w=w.filter(S=>Array.isArray(S.tags)&&S.tags.includes(s))),a){let S=String(a).toLowerCase();w=w.filter(T=>{let R=(T.title??"").toLowerCase(),h=(T.notes??"").toLowerCase();return R.includes(S)||h.includes(S)})}let I=y.LastEvaluatedKey?y.LastEvaluatedKey[u]:null;return{items:w.map(b),nextToken:I}}async function Te(e,t){let{cabinetId:r,folderId:n,category:o,title:s,notes:a,tags:p=[],fileName:A,filename:f,contentType:m,kind:y}=t||{},w=A??f;if(!r)throw new Error("cabinetId is required");if(!w)throw new Error("fileName is required");if(!m)throw new Error("contentType is required");if(!await x(e,r))throw new Error("Cabinet not found");let S=C(),T=n||"unsorted",R=String(w).replace(/[^a-zA-Z0-9._-]/g,"_"),h=["creator-media",e,r,T,`${S}-${R}`].join("/"),k=E(),N=y??"OTHER",M={[i]:`CAB#${r}`,[u]:`ASSET#${S}`,type:"ASSET",id:S,cabinetId:r,folderId:n??null,ownerSub:e,kind:N,category:o??null,title:s??null,notes:a??null,tags:p,s3Key:h,contentType:m,createdAt:k,updatedAt:k,moderationStatus:"ACTIVE",moderationReason:null,moderatedBy:null,moderatedAt:null,gsi1pk:`CREATOR#${e}`,gsi1sk:`CAB_ASSET#${r}#${k}#${S}`};await l.send(new d.PutCommand({TableName:c,Item:M})),await l.send(new d.UpdateCommand({TableName:c,Key:{[i]:`CAB#${r}`,[u]:"META"},UpdateExpression:"SET #assetCount = if_not_exists(#assetCount, :zero) + :one, #updatedAt = :updatedAt",ExpressionAttributeNames:{"#assetCount":"assetCount","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":zero":0,":one":1,":updatedAt":k}}));let te=new _.PutObjectCommand({Bucket:ce,Key:h,ContentType:m});return{uploadUrl:await(0,W.getSignedUrl)(ue,te,{expiresIn:900}),asset:b(M)}}async function he(e,t){let{id:r,cabinetId:n}=t||{};if(!r)throw new Error("id is required");if(!n)throw new Error("cabinetId is required");let o=E(),s={"#updatedAt":"updatedAt","#ownerSub":"ownerSub"},a={":updatedAt":o,":ownerSub":e},p=["#updatedAt = :updatedAt"];Object.prototype.hasOwnProperty.call(t,"folderId")&&(s["#folderId"]="folderId",a[":folderId"]=t.folderId??null,p.push("#folderId = :folderId")),Object.prototype.hasOwnProperty.call(t,"category")&&(s["#category"]="category",a[":category"]=t.category??null,p.push("#category = :category")),Object.prototype.hasOwnProperty.call(t,"title")&&(s["#title"]="title",a[":title"]=t.title??null,p.push("#title = :title")),Object.prototype.hasOwnProperty.call(t,"notes")&&(s["#notes"]="notes",a[":notes"]=t.notes??null,p.push("#notes = :notes")),Object.prototype.hasOwnProperty.call(t,"tags")&&(s["#tags"]="tags",a[":tags"]=t.tags??[],p.push("#tags = :tags")),Object.prototype.hasOwnProperty.call(t,"kind")&&(s["#kind"]="kind",a[":kind"]=t.kind??"OTHER",p.push("#kind = :kind")),Object.prototype.hasOwnProperty.call(t,"contentType")&&(s["#contentType"]="contentType",a[":contentType"]=t.contentType??null,p.push("#contentType = :contentType"));let A=await l.send(new d.UpdateCommand({TableName:c,Key:{[i]:`CAB#${n}`,[u]:`ASSET#${r}`},UpdateExpression:"SET "+p.join(", "),ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:s,ExpressionAttributeValues:a,ReturnValues:"ALL_NEW"}));return b(A.Attributes)}async function ke(e,t,r){if(!t)throw new Error("id is required");if(!r)throw new Error("cabinetId is required");let n=E();return await l.send(new d.DeleteCommand({TableName:c,Key:{[i]:`CAB#${r}`,[u]:`ASSET#${t}`},ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:{"#ownerSub":"ownerSub"},ExpressionAttributeValues:{":ownerSub":e}})),await l.send(new d.UpdateCommand({TableName:c,Key:{[i]:`CAB#${r}`,[u]:"META"},UpdateExpression:"SET #assetCount = if_not_exists(#assetCount, :zero) - :one, #updatedAt = :updatedAt",ExpressionAttributeNames:{"#assetCount":"assetCount","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":zero":0,":one":1,":updatedAt":n}})),!0}async function xe(e,t){let{id:r,cabinetId:n,destinationFolderId:o}=t||{};if(!r)throw new Error("id is required");if(!n)throw new Error("cabinetId is required");let s=E(),a=await l.send(new d.UpdateCommand({TableName:c,Key:{[i]:`CAB#${n}`,[u]:`ASSET#${r}`},UpdateExpression:"SET #folderId = :folderId, #updatedAt = :updatedAt",ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:{"#folderId":"folderId","#updatedAt":"updatedAt","#ownerSub":"ownerSub"},ExpressionAttributeValues:{":folderId":o??null,":updatedAt":s,":ownerSub":e},ReturnValues:"ALL_NEW"}));return b(a.Attributes)}async function Re(e){let{ownerSub:t,cabinetId:r,folderId:n,moderationStatus:o,includeSoftDeleted:s=!0,limit:a=50}=e||{};if(!t)throw new Error("ownerSub is required");let A=((await l.send(new d.QueryCommand({TableName:c,IndexName:v,KeyConditionExpression:"#gpk = :gpk AND begins_with(#gsk, :prefix)",ExpressionAttributeNames:{"#gpk":"gsi1pk","#gsk":"gsi1sk"},ExpressionAttributeValues:{":gpk":`CREATOR#${t}`,":prefix":"CAB_ASSET#"},Limit:a}))).Items??[]).filter(f=>f.type==="ASSET");if(r&&(A=A.filter(f=>f.cabinetId===r)),n!=null&&(A=A.filter(f=>f.folderId===n)),o){let f=String(o).toUpperCase();A=A.filter(m=>String(m.moderationStatus??"ACTIVE").toUpperCase()===f)}return s||(A=A.filter(f=>String(f.moderationStatus??"ACTIVE").toUpperCase()!=="SOFT_DELETED")),{items:A.map(b),nextToken:null}}async function Ne(e){let{cabinetId:t,id:r}=e||{};if(!t)throw new Error("cabinetId is required");if(!r)throw new Error("id is required");let n=await l.send(new d.GetCommand({TableName:c,Key:{[i]:`CAB#${t}`,[u]:`ASSET#${r}`}}));return!n.Item||n.Item.type!=="ASSET"?null:b(n.Item)}async function Q(e,t){let{cabinetId:r,id:n,moderationStatus:o,moderationReason:s,tags:a}=t||{};if(!r)throw new Error("cabinetId is required");if(!n)throw new Error("id is required");if(!o)throw new Error("moderationStatus is required");let p=E(),A={"#moderationStatus":"moderationStatus","#updatedAt":"updatedAt","#moderatedAt":"moderatedAt","#moderatedBy":"moderatedBy"},f={":moderationStatus":o,":updatedAt":p,":moderatedAt":p,":moderatedBy":e},m=["#moderationStatus = :moderationStatus","#updatedAt = :updatedAt","#moderatedAt = :moderatedAt","#moderatedBy = :moderatedBy"];Object.prototype.hasOwnProperty.call(t,"moderationReason")&&(A["#moderationReason"]="moderationReason",f[":moderationReason"]=s??null,m.push("#moderationReason = :moderationReason")),Array.isArray(a)&&(A["#tags"]="tags",f[":tags"]=a,m.push("#tags = :tags"));let y=await l.send(new d.UpdateCommand({TableName:c,Key:{[i]:`CAB#${r}`,[u]:`ASSET#${n}`},UpdateExpression:"SET "+m.join(", "),ReturnValues:"ALL_NEW"}));return b(y.Attributes)}async function Oe(e,t){if(!t)throw new Error("input is required");let{cabinetId:r,id:n,moderationReason:o,tags:s}=t;return Q(e,{cabinetId:r,id:n,moderationStatus:"REJECTED",moderationReason:o,tags:s})}async function Pe(e,t){let{cabinetId:r,id:n,reason:o}=t||{};if(!r)throw new Error("cabinetId is required");if(!n)throw new Error("id is required");let s=E(),a=await l.send(new d.UpdateCommand({TableName:c,Key:{[i]:`CAB#${r}`,[u]:`ASSET#${n}`},UpdateExpression:"SET #moderationStatus = :status, #moderationReason = :reason, #moderatedBy = :moderatedBy, #moderatedAt = :moderatedAt, #updatedAt = :updatedAt",ExpressionAttributeNames:{"#moderationStatus":"moderationStatus","#moderationReason":"moderationReason","#moderatedBy":"moderatedBy","#moderatedAt":"moderatedAt","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":status":"SOFT_DELETED",":reason":o??null,":moderatedBy":e,":moderatedAt":s,":updatedAt":s},ReturnValues:"ALL_NEW"}));return b(a.Attributes)}async function _e(e,t){let{cabinetId:r,id:n}=t||{};if(!r)throw new Error("cabinetId is required");if(!n)throw new Error("id is required");let o=E(),s=await l.send(new d.UpdateCommand({TableName:c,Key:{[i]:`CAB#${r}`,[u]:`ASSET#${n}`},UpdateExpression:"SET #moderationStatus = :status, #moderationReason = :reason, #moderatedBy = :moderatedBy, #moderatedAt = :moderatedAt, #updatedAt = :updatedAt",ExpressionAttributeNames:{"#moderationStatus":"moderationStatus","#moderationReason":"moderationReason","#moderatedBy":"moderatedBy","#moderatedAt":"moderatedAt","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":status":"ACTIVE",":reason":null,":moderatedBy":e,":moderatedAt":o,":updatedAt":o},ReturnValues:"ALL_NEW"}));return b(s.Attributes)}async function $e(e){return((await l.send(new d.QueryCommand({TableName:c,IndexName:v,KeyConditionExpression:"#gpk = :gpk AND begins_with(#gsk, :prefix)",ExpressionAttributeNames:{"#gpk":"gsi1pk","#gsk":"gsi1sk"},ExpressionAttributeValues:{":gpk":`CREATOR#${e}`,":prefix":"CPB#"}}))).Items??[]).filter(n=>n.type==="CREATOR_PR_BOARD").map(Y)}async function Be(e,t){if(!t)throw new Error("boardId is required");return await X(e,t),((await l.send(new d.QueryCommand({TableName:c,KeyConditionExpression:"#pk = :pk AND begins_with(#sk, :prefix)",ExpressionAttributeNames:{"#pk":i,"#sk":u},ExpressionAttributeValues:{":pk":`CPB#${t}`,":prefix":"ITEM#"}}))).Items??[]).filter(o=>o.type==="CREATOR_PR_ITEM").map(J)}async function De(e,t){if(!t)throw new Error("input is required");if(!t.title)throw new Error("title is required");let r=E(),n=C(),o=await Z(e),s=o?{primaryGoal:o.primaryGoal??null,timeHorizon:o.timeHorizon??null,weeklyCapacity:o.weeklyCapacity??null,focusAreas:o.focusAreas??null,riskTolerance:o.riskTolerance??null,contentMixTarget:o.contentMixTarget??null}:null,a={[i]:`CPB#${n}`,[u]:"META",type:"CREATOR_PR_BOARD",id:n,creatorId:e,ownerSub:e,title:t.title,description:t.description??null,goalCompassSnapshot:s,timeHorizonFrom:t.timeHorizonFrom??null,timeHorizonTo:t.timeHorizonTo??null,createdAt:r,updatedAt:r,gsi1pk:`CREATOR#${e}`,gsi1sk:`CPB#${r}#${n}`};return await l.send(new d.PutCommand({TableName:c,Item:a,ConditionExpression:"attribute_not_exists(#pk)",ExpressionAttributeNames:{"#pk":i}})),Y(a)}async function X(e,t){if(!t)throw new Error("boardId is required");let n=(await l.send(new d.GetCommand({TableName:c,Key:{[i]:`CPB#${t}`,[u]:"META"}}))).Item;if(!n||n.ownerSub!==e)throw new Error("CreatorPrBoard not found");return n}async function Le(e,t){if(!t)throw new Error("pulseId is required");let r=await l.send(new d.GetCommand({TableName:c,Key:{[i]:`CREATOR#${e}`,[u]:`PULSE#${t}`}}));if(!r.Item)throw new Error("CreatorSocialPulse not found");return r.Item}function Ue(e,t){let r=Array.isArray(e.contentIdeas)?e.contentIdeas:[],n=r.find(o=>o.id===t)??r.find(o=>o.ideaId===t);if(!n)throw new Error("Content idea not found in pulse");return n}async function qe(e,t){let{limit:r=20,nextToken:n}=t||{},o={TableName:c,KeyConditionExpression:"#pk = :pk AND begins_with(#sk, :prefix)",ExpressionAttributeNames:{"#pk":i,"#sk":u},ExpressionAttributeValues:{":pk":`CREATOR#${e}`,":prefix":"PULSE#"},Limit:r};return n&&(o.ExclusiveStartKey={[i]:`CREATOR#${e}`,[u]:n}),((await l.send(new d.QueryCommand(o))).Items??[]).map(p=>q(p,e))}async function ve(e,t){if(!e)throw new Error("Not authenticated");if(!G){console.warn("[SocialPulse] SOCIAL_PULSE_SFN_ARN not set \u2013 using local fallback");let s=E(),a=C(),p=`CREATOR#${e}`,A=`PULSE#${a}`,f=t?.nicheOverride??null,m=t?.platforms,y=m&&m.length?m:["TIKTOK","INSTAGRAM","YOUTUBE_SHORTS"],w={[i]:p,[u]:A,type:"CREATOR_SOCIAL_PULSE",id:a,creatorId:e,niche:f,platforms:y,trendBriefs:[],contentIdeas:[],createdAt:s,updatedAt:s};return await l.send(new d.PutCommand({TableName:c,Item:w,ConditionExpression:"attribute_not_exists(#pk) AND attribute_not_exists(#sk)",ExpressionAttributeNames:{"#pk":i,"#sk":u}})),q(w,e)}let r={creatorId:e,nicheOverride:t?.nicheOverride??null,platforms:t?.platforms??null},n=await le.send(new $.StartSyncExecutionCommand({stateMachineArn:G,input:JSON.stringify(r)}));if(!n.output)throw new Error("Social Pulse state machine returned no output");let o=JSON.parse(n.output);return o&&o.pk&&o.sk?q(o,e):{id:o.id,creatorId:o.creatorId??e,niche:o.niche??null,platforms:o.platforms??[],trendBriefs:o.trendBriefs??[],contentIdeas:o.contentIdeas??[],createdAt:o.createdAt??E()}}async function Ke(e,t){if(!t)throw new Error("input is required");let{boardId:r,pulseId:n,contentIdeaId:o}=t;if(!r)throw new Error("boardId is required");if(!n)throw new Error("pulseId is required");if(!o)throw new Error("contentIdeaId is required");await X(e,r);let s=await Le(e,n),a=Ue(s,o),p=E(),A=C(),f=t.platform??a.recommendedPlatform??"TIKTOK",m=t.status??"IDEA",y=t.notes??a.hook??null,w={[i]:`CPB#${r}`,[u]:`ITEM#${p}#${A}`,type:"CREATOR_PR_ITEM",id:A,boardId:r,creatorId:e,ownerSub:e,title:a.title,platform:f,status:m,notes:y,pulseId:n,contentIdeaId:o,ideaSnapshot:{title:a.title,hook:a.hook??null,outline:a.outline??null,recommendedPlatform:a.recommendedPlatform??null,recommendedLengthSec:a.recommendedLengthSec??null},emotionalToneLabels:[],audienceResponseLabel:null,brandAlignmentScore:null,prRiskLevel:null,lastEmotionalReviewAt:null,directorShootPlanId:null,directorAssetIds:[],scheduleSlotId:null,createdAt:p,updatedAt:p,gsi1pk:`CREATOR#${e}`,gsi1sk:`CPI#${r}#${p}#${A}`};return await l.send(new d.PutCommand({TableName:c,Item:w,ConditionExpression:"attribute_not_exists(#pk)",ExpressionAttributeNames:{"#pk":i}})),J(w)}function Me(){return{primaryGoal:"GROWTH",timeHorizon:"90_DAYS",weeklyCapacity:5,focusAreas:["PERSONALITY","NURTURE"],riskTolerance:"MEDIUM",notes:null,updatedAt:null,contentMixTarget:{personality:30,nurture:30,authority:20,conversion:20},contentMixActual:null,weeklyPathStatus:null,lastWeeklyCheckAt:null}}async function Z(e){let t=await l.send(new d.GetCommand({TableName:c,Key:{[i]:`CREATOR#${e}`,[u]:"GOAL_COMPASS"}}));if(!t.Item)return Me();let r=t.Item;return{primaryGoal:r.primaryGoal??"GROWTH",timeHorizon:r.timeHorizon??"90_DAYS",weeklyCapacity:typeof r.weeklyCapacity=="number"?r.weeklyCapacity:5,focusAreas:Array.isArray(r.focusAreas)&&r.focusAreas.length?r.focusAreas:["PERSONALITY","NURTURE"],riskTolerance:r.riskTolerance??"MEDIUM",notes:r.notes??null,updatedAt:r.updatedAt??null,contentMixTarget:r.contentMixTarget??null,contentMixActual:r.contentMixActual??null,weeklyPathStatus:r.weeklyPathStatus??null,lastWeeklyCheckAt:r.lastWeeklyCheckAt??null}}async function He(e,t){if(!t)throw new Error("input is required");let r=E(),n={[i]:`CREATOR#${e}`,[u]:"GOAL_COMPASS",type:"CREATOR_GOAL_COMPASS",primaryGoal:t.primaryGoal??"GROWTH",timeHorizon:t.timeHorizon??"90_DAYS",weeklyCapacity:typeof t.weeklyCapacity=="number"?t.weeklyCapacity:5,focusAreas:Array.isArray(t.focusAreas)&&t.focusAreas.length?t.focusAreas:["PERSONALITY","NURTURE"],riskTolerance:t.riskTolerance??"MEDIUM",notes:t.notes??null,updatedAt:r,contentMixTarget:t.contentMixTarget??{personality:30,nurture:30,authority:20,conversion:20}};return await l.send(new d.PutCommand({TableName:c,Item:n})),{primaryGoal:n.primaryGoal,timeHorizon:n.timeHorizon,weeklyCapacity:n.weeklyCapacity,focusAreas:n.focusAreas,riskTolerance:n.riskTolerance,notes:n.notes,updatedAt:n.updatedAt,contentMixTarget:n.contentMixTarget,contentMixActual:n.contentMixActual??null,weeklyPathStatus:n.weeklyPathStatus??null,lastWeeklyCheckAt:n.lastWeeklyCheckAt??null}}async function Ve(e){let t=e.identity?.sub||e.identity?.claims?.sub||e.arguments?.creatorId;if(!t)throw new Error("Missing creator identity");let n=`CREATOR#${t}`,o="GOAL_COMPASS",a=(await l.send(new d.GetCommand({TableName:c,Key:{[i]:n,[u]:o}}))).Item,p={personality:30,nurture:30,authority:20,conversion:20},A=a?.contentMixTarget??p,f=a?.contentMixActual??A,m=a?.weeklyPathStatus??"ON_PATH",y=a?.lastWeeklyCheckAt??a?.updatedAt;return{target:A,actual:f,weeklyPathStatus:m,lastWeeklyCheckAt:y||null}}function ee(e){return e?{id:e.id,creatorSub:e.creatorSub,weekOf:e.weekOf,day:e.day,timeOfDay:e.timeOfDay,platformHint:e.platformHint??null,focusHint:e.focusHint??null,status:e.status??"PLANNED",notes:e.notes??null,directorShootId:e.directorShootId??null,createdAt:e.createdAt,updatedAt:e.updatedAt}:null}async function Fe(e,t){if(!t)throw new Error("weekOf is required");let n=((await l.send(new d.QueryCommand({TableName:c,KeyConditionExpression:"#pk = :pk AND begins_with(#sk, :skPrefix)",ExpressionAttributeNames:{"#pk":i,"#sk":u},ExpressionAttributeValues:{":pk":`CREATOR#${e}`,":skPrefix":`SCHEDULE#${t}#`}}))).Items||[]).filter(o=>o.type==="CREATOR_SCHEDULE_SLOT")??[];return{weekOf:t,slots:n.map(ee)}}async function Ge(e,t){if(!t)throw new Error("input is required");let{weekOf:r,day:n,timeOfDay:o}=t;if(!r)throw new Error("weekOf is required");if(!n)throw new Error("day is required");if(!o)throw new Error("timeOfDay is required");let s=t.id||C(),a=E(),p={[i]:`CREATOR#${e}`,[u]:`SCHEDULE#${r}#${s}`,type:"CREATOR_SCHEDULE_SLOT",id:s,creatorSub:e,weekOf:r,day:n,timeOfDay:o,platformHint:t.platformHint??null,focusHint:t.focusHint??null,status:t.status??"PLANNED",notes:t.notes??null,directorShootId:t.directorShootId??null,createdAt:t.createdAt||a,updatedAt:a};return await l.send(new d.PutCommand({TableName:c,Item:p})),ee(p)}async function je(e,t,r){if(!t)throw new Error("id is required");if(!r)throw new Error("weekOf is required");return await l.send(new d.DeleteCommand({TableName:c,Key:{[i]:`CREATOR#${e}`,[u]:`SCHEDULE#${r}#${t}`}})),!0}async function ze(e,t){let{closetItemId:r,cabinetId:n,folderId:o,kind:s,title:a,notes:p,tags:A=[]}=t||{};if(!r)throw new Error("closetItemId is required");if(!n)throw new Error("cabinetId is required");if(!await x(e,n))throw new Error("Cabinet not found");let y=(await l.send(new d.GetCommand({TableName:c,Key:{[i]:`CLOSET#${e}`,[u]:`ITEM#${r}`}}))).Item;if(!y||y.ownerSub!==e)throw new Error("Closet item not found");let w=C(),I=E(),S=y.mediaKey||y.rawMediaKey||(()=>{throw new Error("Closet item has no media key")})(),T=s??"PHOTO",R=a??y.title??null,h=p??y.notes??null,k=A.length?A:y.colorTags??[],N={[i]:`CAB#${n}`,[u]:`ASSET#${w}`,type:"ASSET",id:w,cabinetId:n,folderId:o??null,ownerSub:e,kind:T,category:"OUTFIT_REFS",title:R,notes:h,tags:k,s3Key:S,contentType:y.contentType??"image/jpeg",createdAt:I,updatedAt:I,sourceClosetItemId:r,moderationStatus:"ACTIVE",moderationReason:null,moderatedBy:null,moderatedAt:null,gsi1pk:`CREATOR#${e}`,gsi1sk:`CAB_ASSET#${n}#${I}#${w}`};return await l.send(new d.PutCommand({TableName:c,Item:N})),await l.send(new d.UpdateCommand({TableName:c,Key:{[i]:`CAB#${n}`,[u]:"META"},UpdateExpression:"SET #assetCount = if_not_exists(#assetCount, :zero) + :one, #updatedAt = :updatedAt",ExpressionAttributeNames:{"#assetCount":"assetCount","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":zero":0,":one":1,":updatedAt":I}})),b(N)}async function We(e){let t=e.arguments?.text??"",r=e.arguments?.kind??"OTHER",n=t||"your content",o=[];return r==="CAPTION"?o.push(`Behind the scenes of ${n} \u2728`,`Styling ${n} so you don't have to \u{1F485}`):r==="HASHTAGS"?o.push("#stylingadventures #creatorlife #behindthescenes","#outfitinspo #contentcreator #filmingday"):o.push(`Planning ideas for ${n}`),{suggestions:o}}var Ye=async e=>{let t=e.info?.fieldName,r=e.identity?.sub||e.identity?.claims?.sub||"anonymous",n=e.arguments||{};switch(t){case"creatorCabinets":return fe(r);case"creatorCabinet":return x(r,n.id);case"createCreatorCabinet":return ye(r,n.input);case"updateCreatorCabinet":return Ee(r,n.input);case"deleteCreatorCabinet":return Se(r,n.id);case"creatorCabinetFolders":return j(r,n.cabinetId);case"creatorFolders":return j(r,n.cabinetId);case"createCreatorFolder":return ge(r,n.input);case"renameCreatorFolder":return Ce(r,n.input);case"deleteCreatorFolder":return be(r,n.id,n.cabinetId);case"creatorCabinetAssets":return Ie(r,n);case"createCreatorAssetUpload":return Te(r,n.input);case"updateCreatorAsset":return he(r,n.input);case"deleteCreatorAsset":return ke(r,n.id,n.cabinetId);case"moveCreatorAsset":return xe(r,n.input);case"importClosetItemToCabinet":return ze(r,n.input);case"adminListCreatorAssetsByUser":return Re(n);case"adminGetCreatorAsset":return Ne(n);case"adminModerateCreatorAsset":return Q(r,n.input);case"adminSoftDeleteCreatorAsset":return Pe(r,n.input);case"adminRestoreCreatorAsset":return _e(r,n.input);case"adminRejectCreatorAsset":return Oe(r,n.input);case"creatorRevenueByPlatform":return pe(e);case"creatorGoalCompass":return Z(r);case"updateCreatorGoalCompass":return He(r,n.input);case"runCreatorEmotionPreview":return Ve(e);case"creatorScheduleWeek":return Fe(r,n.weekOf);case"upsertCreatorScheduleSlot":return Ge(r,n.input);case"deleteCreatorScheduleSlot":return je(r,n.id,n.weekOf);case"creatorPrBoards":return $e(r);case"creatorPrItemsByBoard":return Be(r,n.boardId);case"createCreatorPrBoard":return De(r,n.input);case"addContentIdeaToBoard":return Ke(r,n.input);case"getDirectorShootPlan":return Ae(r,n.id);case"saveDirectorShootPlan":return me(r,n.input);case"creatorSocialPulses":return qe(r,{limit:n.limit,nextToken:n.nextToken});case"generateSocialPulse":return ve(r,n.input);case"creatorAiSuggest":return We(e);default:throw new Error(`Unknown field ${t}`)}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
