{
  "version": 3,
  "sources": ["../../lambda/closet/expire-closet-approvals.ts"],
  "sourcesContent": ["import { SFNClient, SendTaskSuccessCommand } from \"@aws-sdk/client-sfn\";\r\nimport { DynamoDBClient } from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  ScanCommand,\r\n  UpdateCommand,\r\n  PutCommand,\r\n} from \"@aws-sdk/lib-dynamodb\";\r\nimport { EventBridgeClient, PutEventsCommand } from \"@aws-sdk/client-eventbridge\";\r\nimport { SNSClient, PublishCommand } from \"@aws-sdk/client-sns\";\r\n\r\nconst sfn = new SFNClient({});\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}), {\r\n  marshallOptions: { removeUndefinedValues: true },\r\n});\r\nconst eb = new EventBridgeClient({});\r\nconst sns = new SNSClient({});\r\n\r\nconst APP_TABLE = process.env.TABLE_NAME!;\r\nconst AUDIT_TABLE = process.env.AUDIT_TABLE_NAME!;\r\nconst PK_NAME = process.env.PK_NAME || \"pk\";\r\nconst SK_NAME = process.env.SK_NAME || \"sk\";\r\nconst NOTIFY_TOPIC_ARN = process.env.NOTIFY_TOPIC_ARN;\r\n\r\nconst MAX_PER_RUN = Number(process.env.MAX_PER_RUN || \"25\");\r\n\r\nfunction nowIso() {\r\n  return new Date().toISOString();\r\n}\r\n\r\nfunction isConditionalCheckFailed(err: any) {\r\n  return err?.name === \"ConditionalCheckFailedException\";\r\n}\r\n\r\nfunction isTaskTokenInvalidOrClosed(err: any) {\r\n  const name = err?.name || \"\";\r\n  const msg = String(err?.message || \"\");\r\n  // AWS SFN common cases:\r\n  // - TaskTimedOut (token expired by StepFn)\r\n  // - InvalidToken / InvalidTokenException\r\n  // - TaskDoesNotExist / TaskDoesNotExistException\r\n  // - ExecutionDoesNotExist / ExecutionDoesNotExistException\r\n  return (\r\n    name.includes(\"TaskTimedOut\") ||\r\n    name.includes(\"InvalidToken\") ||\r\n    name.includes(\"TaskDoesNotExist\") ||\r\n    name.includes(\"ExecutionDoesNotExist\") ||\r\n    msg.toLowerCase().includes(\"invalid token\") ||\r\n    msg.toLowerCase().includes(\"task does not exist\") ||\r\n    msg.toLowerCase().includes(\"timed out\")\r\n  );\r\n}\r\n\r\nasync function emit(detailType: string, detail: any) {\r\n  try {\r\n    await eb.send(\r\n      new PutEventsCommand({\r\n        Entries: [\r\n          {\r\n            Source: \"stylingadventures.closet\",\r\n            DetailType: detailType,\r\n            Detail: JSON.stringify(detail),\r\n          },\r\n        ],\r\n      }),\r\n    );\r\n  } catch (e) {\r\n    console.warn(\"[expire] EventBridge put failed:\", e);\r\n  }\r\n}\r\n\r\nasync function notify(message: string, detail: any) {\r\n  if (!NOTIFY_TOPIC_ARN) return;\r\n  try {\r\n    await sns.send(\r\n      new PublishCommand({\r\n        TopicArn: NOTIFY_TOPIC_ARN,\r\n        Subject: \"Closet approval expired\",\r\n        Message: `${message}\\n\\n${JSON.stringify(detail, null, 2)}`,\r\n      }),\r\n    );\r\n  } catch (e) {\r\n    console.warn(\"[expire] SNS publish failed:\", e);\r\n  }\r\n}\r\n\r\nasync function audit(action: string, approvalId: string, detail: any) {\r\n  const ts = new Date();\r\n  try {\r\n    await ddb.send(\r\n      new PutCommand({\r\n        TableName: AUDIT_TABLE,\r\n        Item: {\r\n          pk: `APPROVAL#${approvalId}`,\r\n          sk: `TS#${ts.toISOString()}`,\r\n          action,\r\n          approvalId,\r\n          at: ts.toISOString(),\r\n          detail,\r\n        },\r\n      }),\r\n    );\r\n  } catch (e) {\r\n    console.warn(\"[expire] audit write failed:\", e);\r\n  }\r\n}\r\n\r\nexport const handler = async () => {\r\n  const now = Math.floor(Date.now() / 1000);\r\n  const startedAt = nowIso();\r\n\r\n  console.log(\"[expire] start\", { now, MAX_PER_RUN });\r\n\r\n  // NOTE: Scan is simplest. If this grows, add a GSI later (status + expiresAt).\r\n  const scan = await ddb.send(\r\n    new ScanCommand({\r\n      TableName: APP_TABLE,\r\n      FilterExpression:\r\n        \"#s = :pending AND attribute_exists(taskToken) AND attribute_exists(taskTokenExpiresAt) AND taskTokenExpiresAt <= :now\",\r\n      ExpressionAttributeNames: { \"#s\": \"status\" },\r\n      ExpressionAttributeValues: {\r\n        \":pending\": \"PENDING\",\r\n        \":now\": now,\r\n      },\r\n      Limit: MAX_PER_RUN,\r\n    }),\r\n  );\r\n\r\n  const items = scan.Items ?? [];\r\n  console.log(\"[expire] candidates\", { count: items.length });\r\n\r\n  let expired = 0;\r\n  let skipped = 0;\r\n  let errors = 0;\r\n\r\n  for (const it of items) {\r\n    const pk = it[PK_NAME];\r\n    const sk = it[SK_NAME];\r\n    const approvalId = String(it.id || pk?.replace(\"ITEM#\", \"\") || \"\");\r\n    const taskToken = it.taskToken as string | undefined;\r\n\r\n    if (!pk || !sk || !approvalId || !taskToken) {\r\n      skipped++;\r\n      continue;\r\n    }\r\n\r\n    const decidedAt = nowIso();\r\n    const reason = \"Approval token expired\";\r\n\r\n    // 1) First try to resume StepFn\r\n    try {\r\n      await sfn.send(\r\n        new SendTaskSuccessCommand({\r\n          taskToken,\r\n          output: JSON.stringify({ decision: \"REJECT\", reason }),\r\n        }),\r\n      );\r\n    } catch (err: any) {\r\n      // If token is already closed/invalid, do NOT kill the run; still mark the record.\r\n      if (!isTaskTokenInvalidOrClosed(err)) {\r\n        console.error(\"[expire] SendTaskSuccess failed\", { approvalId, err });\r\n        errors++;\r\n        await audit(\"AUTO_EXPIRE_SFN_ERROR\", approvalId, {\r\n          pk,\r\n          sk,\r\n          decidedAt,\r\n          reason,\r\n          error: String(err?.message || err),\r\n        });\r\n        // continue trying to update the item anyway\r\n      } else {\r\n        console.log(\"[expire] token already closed/invalid; continuing\", { approvalId });\r\n        await audit(\"AUTO_EXPIRE_TOKEN_CLOSED\", approvalId, {\r\n          pk,\r\n          sk,\r\n          decidedAt,\r\n          reason,\r\n          note: \"Task token already closed/invalid\",\r\n        });\r\n      }\r\n    }\r\n\r\n    // 2) Race-safe conditional update: only if still pending\r\n    try {\r\n      await ddb.send(\r\n        new UpdateCommand({\r\n          TableName: APP_TABLE,\r\n          Key: { [PK_NAME]: pk, [SK_NAME]: sk },\r\n          ConditionExpression: \"#s = :pending\",\r\n          UpdateExpression: `\r\n            SET #s = :rejected,\r\n                decidedAt = :t,\r\n                updatedAt = :t\r\n            REMOVE taskToken, taskTokenExpiresAt\r\n          `,\r\n          ExpressionAttributeNames: { \"#s\": \"status\" },\r\n          ExpressionAttributeValues: {\r\n            \":pending\": \"PENDING\",\r\n            \":rejected\": \"REJECTED\",\r\n            \":t\": decidedAt,\r\n          },\r\n        }),\r\n      );\r\n    } catch (err: any) {\r\n      if (isConditionalCheckFailed(err)) {\r\n        console.log(\"[expire] already decided\", { approvalId });\r\n        skipped++;\r\n        continue;\r\n      }\r\n      console.error(\"[expire] update failed\", { approvalId, err });\r\n      errors++;\r\n      await audit(\"AUTO_EXPIRE_UPDATE_ERROR\", approvalId, {\r\n        pk,\r\n        sk,\r\n        decidedAt,\r\n        reason,\r\n        error: String(err?.message || err),\r\n      });\r\n      continue;\r\n    }\r\n\r\n    // 3) Emit + notify + audit success\r\n    await audit(\"AUTO_EXPIRE_REJECT\", approvalId, { pk, sk, decidedAt, reason });\r\n\r\n    await emit(\"ClosetItemAutoExpired\", {\r\n      approvalId,\r\n      pk,\r\n      sk,\r\n      decidedAt,\r\n      reason,\r\n    });\r\n\r\n    await notify(`Auto-rejected expired approval: ${approvalId}`, {\r\n      approvalId,\r\n      pk,\r\n      sk,\r\n      decidedAt,\r\n      reason,\r\n    });\r\n\r\n    expired++;\r\n  }\r\n\r\n  const result = {\r\n    ok: true,\r\n    startedAt,\r\n    expired,\r\n    skipped,\r\n    errors,\r\n    scanned: items.length,\r\n  };\r\n  console.log(\"[expire] done\", result);\r\n  return result;\r\n};\r\n"],
  "mappings": "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",
  "names": ["expire_closet_approvals_exports", "__export", "handler", "__toCommonJS", "import_client_sfn", "import_client_dynamodb", "import_lib_dynamodb", "import_client_eventbridge", "import_client_sns", "sfn", "ddb", "eb", "sns", "APP_TABLE", "AUDIT_TABLE", "PK_NAME", "SK_NAME", "NOTIFY_TOPIC_ARN", "MAX_PER_RUN", "nowIso", "isConditionalCheckFailed", "err", "isTaskTokenInvalidOrClosed", "name", "msg", "emit", "detailType", "detail", "e", "notify", "message", "audit", "action", "approvalId", "ts", "now", "startedAt", "items", "expired", "skipped", "errors", "it", "pk", "sk", "taskToken", "decidedAt", "reason", "result"]
}
