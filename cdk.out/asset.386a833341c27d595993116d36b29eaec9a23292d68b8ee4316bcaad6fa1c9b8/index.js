"use strict";var c=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var f=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var y=(o,t)=>{for(var r in t)c(o,r,{get:t[r],enumerable:!0})},b=(o,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of f(t))!E.call(o,e)&&e!==r&&c(o,e,{get:()=>t[e],enumerable:!(n=A(t,e))||n.enumerable});return o};var I=o=>b(c({},"__esModule",{value:!0}),o);var O={};y(O,{handler:()=>N});module.exports=I(O);var w=require("@aws-sdk/client-dynamodb"),s=require("@aws-sdk/lib-dynamodb"),{TABLE_NAME:i="",ADMIN_GROUP_NAME:k="admin"}=process.env;if(!i)throw new Error("Missing env TABLE_NAME");var h=k.toLowerCase(),u=s.DynamoDBDocumentClient.from(new w.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}});function L(o){if(!o)return[];let t=o.claims||{},r=t["cognito:groups"]||t["custom:groups"]||o.groups||[];return Array.isArray(r)?r.map(n=>String(n)):typeof r=="string"?r.split(",").map(n=>n.trim()).filter(Boolean):[]}function C(o){return L(o).map(r=>r.toLowerCase()).includes(h)}var N=async o=>{let t=o.identity,r=o.info?.fieldName;if(r==="createPoll"){if(!t?.sub)throw new Error("Unauthorized");if(!C(t))throw new Error("Forbidden");let{question:n,options:e}=o.arguments.input;if(!n?.trim())throw new Error("question required");if(!e||!Array.isArray(e)||e.length<2)throw new Error("at least two options required");let l=String(Date.now()),m=new Date().toISOString(),p=new Array(e.length).fill(0);return await u.send(new s.PutCommand({TableName:i,Item:{pk:`POLL#${l}`,sk:"META",gsi2pk:"POLL",gsi2sk:`CREATED#${l}`,question:n,options:e,totals:p,createdBy:t.username||t.sub,createdAt:m},ConditionExpression:"attribute_not_exists(pk)"})),{pollId:l,question:n,options:e,totals:p,createdBy:t.username||t.sub,createdAt:m}}if(r==="votePoll"){if(!t?.sub)throw new Error("Unauthorized");let{pollId:n,optionIndex:e}=o.arguments;if(!n)throw new Error("pollId required");if(typeof e!="number"||e<0)throw new Error("optionIndex required");await u.send(new s.PutCommand({TableName:i,Item:{pk:`POLL#${n}`,sk:`VOTE#${e}#${t.sub}`,gsi2pk:`POLL#${n}`,gsi2sk:`VOTE#${e}#${t.sub}`,userId:t.sub,at:new Date().toISOString()},ConditionExpression:"attribute_not_exists(pk)"})).catch(a=>{if(!String(a).includes("ConditionalCheckFailed"))throw a});let m=(await u.send(new s.GetCommand({TableName:i,Key:{pk:`POLL#${n}`,sk:"META"}}))).Item?.options??[],p=[];for(let a=0;a<m.length;a++){let g=await u.send(new s.QueryCommand({TableName:i,IndexName:"gsi2",KeyConditionExpression:"#pk = :p AND begins_with(#sk, :pref)",ExpressionAttributeNames:{"#pk":"gsi2pk","#sk":"gsi2sk"},ExpressionAttributeValues:{":p":`POLL#${n}`,":pref":`VOTE#${a}#`},Select:"COUNT"}));p.push(g.Count??0)}let d=await u.send(new s.UpdateCommand({TableName:i,Key:{pk:`POLL#${n}`,sk:"META"},UpdateExpression:"SET totals = :t",ExpressionAttributeValues:{":t":p},ReturnValues:"ALL_NEW"}));return{pollId:n,question:d.Attributes?.question,options:d.Attributes?.options,totals:d.Attributes?.totals,createdBy:d.Attributes?.createdBy,createdAt:d.Attributes?.createdAt}}if(r==="getPoll"){let{pollId:n}=o.arguments;if(!n)throw new Error("pollId required");let e=await u.send(new s.GetCommand({TableName:i,Key:{pk:`POLL#${n}`,sk:"META"}}));return e.Item?{pollId:n,question:e.Item.question,options:e.Item.options??[],totals:e.Item.totals??[],createdBy:e.Item.createdBy,createdAt:e.Item.createdAt}:null}throw new Error("Unknown field")};0&&(module.exports={handler});
