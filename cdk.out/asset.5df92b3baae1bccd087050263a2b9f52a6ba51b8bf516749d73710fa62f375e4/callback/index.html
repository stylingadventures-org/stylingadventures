<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Canonicalize host to non-www -->
  <script>
    if (location.hostname === 'www.stylingadventures.com') {
      location.replace(location.href.replace('://www.', '://'));
    }
  </script>
  <title>Signing you in…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .card { max-width: 720px; padding: 1rem 1.25rem; border: 1px solid #e5e7eb; border-radius: 12px; }
    .muted { color: #6b7280; }
    .err { color: #b00020; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Styling Adventures</h1>
  <div id="box" class="card">
    <p class="muted">Completing sign-in…</p>
  </div>

  <script>
  (async () => {
    const cfg = await fetch('/config.v2.json?ts=' + Date.now(), { cache: 'no-store' }).then(r => r.json());
    const hosted = cfg.domain || cfg.hostedUiDomain;
    const domain = `https://${hosted}.auth.${cfg.region}.amazoncognito.com`;

    // The redirect URI must EXACTLY match what Cognito has
    const ORIGIN = location.origin;
    const redirectUri = (cfg.redirectUri || `${ORIGIN}/callback/index.html`).trim();

    const $box = document.getElementById('box');
    const qs = new URLSearchParams(location.search);
    const code = qs.get('code');
    const returnedState = qs.get('state');

    const expectedState = sessionStorage.getItem('oauth_state');
    const verifier = sessionStorage.getItem('pkce_verifier');

    function showError(e) {
      $box.innerHTML = `
        <h2>Sign-in error</h2>
        <p class="err">${(e && e.message) ? e.message : e}</p>
        <p><a href="${cfg.webOrigin || '/'}">Return to the app</a></p>`;
    }

    try {
      if (!code) throw new Error('Missing authorization code in callback URL.');
      if (!verifier) throw new Error('Missing pkce_verifier in sessionStorage (start login from the app).');
      if (expectedState && returnedState && expectedState !== returnedState) {
        throw new Error('State mismatch. Please retry login.');
      }

      const tokenUrl = `${domain}/oauth2/token`;
      const body = new URLSearchParams({
        grant_type: 'authorization_code',
        client_id: cfg.clientId,
        redirect_uri: redirectUri,
        code,
        code_verifier: verifier
      });

      const res = await fetch(tokenUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      if (!res.ok) {
        const t = await res.text().catch(()=> '');
        throw new Error(`Token exchange failed: ${res.status} ${t}`);
      }
      const tokens = await res.json(); // { id_token, access_token, refresh_token, expires_in, ... }

      // Store where index.html expects them
      sessionStorage.setItem('id_token', tokens.id_token || '');
      sessionStorage.setItem('access_token', tokens.access_token || '');
      if (tokens.refresh_token) sessionStorage.setItem('refresh_token', tokens.refresh_token);

      // Also keep the full bundle for the rotation helper
      sessionStorage.setItem('tokens', JSON.stringify(tokens));

      // Cleanup PKCE noise
      sessionStorage.removeItem('pkce_verifier');
      sessionStorage.removeItem('oauth_state');

      // Optional: schedule rotation immediately
      try {
        const { scheduleRotation } = await import('/auth/refresh.js');
        scheduleRotation(tokens, { domain, clientId: cfg.clientId });
      } catch { /* non-blocking */ }

      // Go home (or cfg.webOrigin if set)
      const home = (cfg.webOrigin || ORIGIN).replace(/\/+$/, '/');
      // Strip ?code=… from the URL before leaving
      history.replaceState({}, '', `${ORIGIN}/callback/index.html`);
      location.replace(home);
    } catch (e) {
      console.error(e);
      showError(e);
    }
  })();
  </script>
</body>
</html>

