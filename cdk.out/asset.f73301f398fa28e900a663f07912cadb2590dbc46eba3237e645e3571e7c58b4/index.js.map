{
  "version": 3,
  "sources": ["../../lambda/prime/poll-manager.ts"],
  "sourcesContent": ["// lambda/prime/poll-manager.ts\r\n\r\n/**\r\n * Prime Studios - Poll Manager\r\n *\r\n * Purpose:\r\n *  - Manage in-episode fan voting that can feed into story branches.\r\n *  - Designed for internal Prime Studios workflows (Step Functions, dashboards),\r\n *    not direct fan access.\r\n *\r\n * Current behavior (mock / test-friendly):\r\n *  - CREATE_POLL: validates and echoes a poll definition with a generated id.\r\n *  - VOTE: validates a vote and returns a mocked tally.\r\n *  - GET_RESULTS: returns a mocked result payload.\r\n *\r\n * Future work:\r\n *  - Persist polls + votes in DynamoDB using TABLE_NAME, PK_NAME, SK_NAME.\r\n *  - Support real aggregation, sharding, and per-episode / per-branch results.\r\n */\r\n\r\nexport type PollManagerAction = \"CREATE_POLL\" | \"VOTE\" | \"GET_RESULTS\";\r\n\r\nexport interface PollOption {\r\n  id: string; // e.g. \"opt-a\"\r\n  label: string; // e.g. \"Team Confidence\"\r\n}\r\n\r\nexport interface CreatePollInput {\r\n  episodeId: string;\r\n  sceneId?: string;\r\n  branchKey?: string; // optional branch identifier\r\n  title: string;\r\n  question: string;\r\n  options: PollOption[];\r\n  allowMultiple?: boolean;\r\n  closesAt?: string; // ISO timestamp\r\n}\r\n\r\nexport interface VoteInput {\r\n  pollId: string;\r\n  userId: string;\r\n  // Either single option or multiple, depending on allowMultiple\r\n  optionIds: string[];\r\n}\r\n\r\nexport interface GetResultsInput {\r\n  pollId: string;\r\n}\r\n\r\nexport interface PollManagerEvent {\r\n  action: PollManagerAction;\r\n  createPoll?: CreatePollInput;\r\n  vote?: VoteInput;\r\n  results?: GetResultsInput;\r\n}\r\n\r\nexport interface PollDefinition {\r\n  pollId: string;\r\n  episodeId: string;\r\n  sceneId?: string;\r\n  branchKey?: string;\r\n  title: string;\r\n  question: string;\r\n  options: PollOption[];\r\n  allowMultiple: boolean;\r\n  closesAt?: string;\r\n  createdAt: string;\r\n}\r\n\r\nexport interface PollVoteReceipt {\r\n  pollId: string;\r\n  userId: string;\r\n  optionIds: string[];\r\n  recordedAt: string;\r\n}\r\n\r\nexport interface PollResults {\r\n  pollId: string;\r\n  totalVotes: number;\r\n  byOption: Array<{\r\n    optionId: string;\r\n    label: string;\r\n    votes: number;\r\n    percentage: number;\r\n  }>;\r\n}\r\n\r\nexport type PollManagerResult =\r\n  | { kind: \"created\"; poll: PollDefinition }\r\n  | { kind: \"voted\"; receipt: PollVoteReceipt; resultsPreview: PollResults }\r\n  | { kind: \"results\"; results: PollResults };\r\n\r\nfunction randomId(prefix: string): string {\r\n  return `${prefix}-${Math.random().toString(36).slice(2, 10)}`;\r\n}\r\n\r\nfunction nowIso(): string {\r\n  return new Date().toISOString();\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// CREATE_POLL\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleCreatePoll(\r\n  input: CreatePollInput,\r\n): Promise<PollManagerResult> {\r\n  if (!input.episodeId) {\r\n    throw new Error(\"PollManager CREATE_POLL: missing episodeId\");\r\n  }\r\n  if (!input.title) {\r\n    throw new Error(\"PollManager CREATE_POLL: missing title\");\r\n  }\r\n  if (!input.question) {\r\n    throw new Error(\"PollManager CREATE_POLL: missing question\");\r\n  }\r\n  if (!input.options || input.options.length < 2) {\r\n    throw new Error(\"PollManager CREATE_POLL: need at least 2 options\");\r\n  }\r\n\r\n  const pollId = randomId(\"poll\");\r\n  const createdAt = nowIso();\r\n\r\n  const poll: PollDefinition = {\r\n    pollId,\r\n    episodeId: input.episodeId,\r\n    sceneId: input.sceneId,\r\n    branchKey: input.branchKey,\r\n    title: input.title,\r\n    question: input.question,\r\n    options: input.options.map((opt, idx) => ({\r\n      id: opt.id || `opt-${idx + 1}`,\r\n      label: opt.label,\r\n    })),\r\n    allowMultiple: !!input.allowMultiple,\r\n    closesAt: input.closesAt,\r\n    createdAt,\r\n  };\r\n\r\n  console.log(\"PollManager CREATE_POLL:\", JSON.stringify(poll, null, 2));\r\n\r\n  // \uD83D\uDD1C Future:\r\n  // - If TABLE_NAME is set, we could persist the poll definition:\r\n  //   - pk = `POLL#${pollId}`, sk = `META`\r\n  //   - store episode/scene/branch for Studio lookup.\r\n\r\n  return { kind: \"created\", poll };\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// VOTE\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleVote(input: VoteInput): Promise<PollManagerResult> {\r\n  if (!input.pollId) {\r\n    throw new Error(\"PollManager VOTE: missing pollId\");\r\n  }\r\n  if (!input.userId) {\r\n    throw new Error(\"PollManager VOTE: missing userId\");\r\n  }\r\n  if (!input.optionIds || input.optionIds.length === 0) {\r\n    throw new Error(\"PollManager VOTE: no optionIds provided\");\r\n  }\r\n\r\n  const recordedAt = nowIso();\r\n\r\n  const receipt: PollVoteReceipt = {\r\n    pollId: input.pollId,\r\n    userId: input.userId,\r\n    optionIds: input.optionIds,\r\n    recordedAt,\r\n  };\r\n\r\n  console.log(\"PollManager VOTE:\", JSON.stringify(receipt, null, 2));\r\n\r\n  // \uD83D\uDD1C Future:\r\n  // - Persist per-user votes keyed by `POLL#pollId` + `USER#userId`.\r\n\r\n  // For now, return a mocked aggregate so Studio UI can render something.\r\n  const mockedResults: PollResults = {\r\n    pollId: input.pollId,\r\n    totalVotes: 42, // \uD83C\uDF7F arbitrary fun number\r\n    byOption: input.optionIds.map((optId, idx) => ({\r\n      optionId: optId,\r\n      label: `Option ${idx + 1}`,\r\n      votes: 10 + idx * 2,\r\n      percentage: 100 / input.optionIds.length,\r\n    })),\r\n  };\r\n\r\n  return { kind: \"voted\", receipt, resultsPreview: mockedResults };\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// GET_RESULTS\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleGetResults(\r\n  input: GetResultsInput,\r\n): Promise<PollManagerResult> {\r\n  if (!input.pollId) {\r\n    throw new Error(\"PollManager GET_RESULTS: missing pollId\");\r\n  }\r\n\r\n  // This is currently *mocked* \u2013 in the future, we'd aggregate votes\r\n  // from DynamoDB or a streaming pipeline.\r\n\r\n  const results: PollResults = {\r\n    pollId: input.pollId,\r\n    totalVotes: 100,\r\n    byOption: [\r\n      { optionId: \"opt-1\", label: \"Option 1\", votes: 60, percentage: 60 },\r\n      { optionId: \"opt-2\", label: \"Option 2\", votes: 25, percentage: 25 },\r\n      { optionId: \"opt-3\", label: \"Option 3\", votes: 15, percentage: 15 },\r\n    ],\r\n  };\r\n\r\n  console.log(\"PollManager GET_RESULTS (mock):\", JSON.stringify(results, null, 2));\r\n\r\n  return { kind: \"results\", results };\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// LAMBDA HANDLER\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nexport const handler = async (\r\n  event: PollManagerEvent,\r\n): Promise<PollManagerResult> => {\r\n  console.log(\"PollManager incoming event:\", JSON.stringify(event, null, 2));\r\n\r\n  if (!event || !event.action) {\r\n    throw new Error(\"PollManager: missing action\");\r\n  }\r\n\r\n  switch (event.action) {\r\n    case \"CREATE_POLL\":\r\n      if (!event.createPoll) {\r\n        throw new Error(\r\n          \"PollManager CREATE_POLL: missing 'createPoll' payload\",\r\n        );\r\n      }\r\n      return handleCreatePoll(event.createPoll);\r\n\r\n    case \"VOTE\":\r\n      if (!event.vote) {\r\n        throw new Error(\"PollManager VOTE: missing 'vote' payload\");\r\n      }\r\n      return handleVote(event.vote);\r\n\r\n    case \"GET_RESULTS\":\r\n      if (!event.results) {\r\n        throw new Error(\r\n          \"PollManager GET_RESULTS: missing 'results' payload\",\r\n        );\r\n      }\r\n      return handleGetResults(event.results);\r\n\r\n    default:\r\n      // Type guard catch-all\r\n      throw new Error(`PollManager: unsupported action ${(event as any).action}`);\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["poll_manager_exports", "__export", "handler", "__toCommonJS", "randomId", "prefix", "nowIso", "handleCreatePoll", "input", "pollId", "createdAt", "poll", "opt", "idx", "handleVote", "recordedAt", "receipt", "mockedResults", "optId", "handleGetResults", "results", "event"]
}
