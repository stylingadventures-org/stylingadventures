"use strict";var S=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var $=Object.prototype.hasOwnProperty;var _=(e,n)=>{for(var r in n)S(e,r,{get:n[r],enumerable:!0})},j=(e,n,r,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let a of R(n))!$.call(e,a)&&a!==r&&S(e,a,{get:()=>n[a],enumerable:!(t=F(n,a))||t.enumerable});return e};var B=e=>j(S({},"__esModule",{value:!0}),e);var G={};_(G,{adminApproveItem:()=>M,adminCreateClosetItem:()=>L,adminListClosetItems:()=>v,adminListPending:()=>k,adminRejectItem:()=>h,adminSetClosetAudience:()=>D,adminUpdateClosetItem:()=>P,closetFeed:()=>I,handler:()=>q,toggleFavoriteClosetItem:()=>O,topClosetLooks:()=>K});module.exports=B(G);var u=require("@aws-sdk/client-dynamodb"),A=require("@aws-sdk/client-sfn"),m=new u.DynamoDBClient({}),x=new A.SFNClient({}),{TABLE_NAME:l=""}=process.env;if(!l)throw new Error("Missing env: TABLE_NAME");var f=()=>new Date().toISOString(),s=e=>({S:e});function y(e){let n=e.identity?.claims||{},r=e.identity?.sub||n.sub,t=n["cognito:groups"],a=Array.isArray(t)?t:String(t||"").split(",").map(c=>c.trim()).filter(Boolean),o=a.includes("ADMIN")||a.includes("COLLAB");if(!r)throw new Error("Unauthorized");return{sub:r,isAdmin:o}}function g(e,n){let r=e.favoriteCount?.N,t=typeof r=="string"?Number(r):0;return{id:e.id.S,userId:e.ownerSub.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",rawMediaKey:e.rawMediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??"",season:e.season?.S??null,vibes:e.vibes?.S??null,audience:e.audience?.S??null,category:e.category?.S??null,subcategory:e.subcategory?.S??null,favoriteCount:t,viewerHasFaved:!1,...n}}function H(){return globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`}function N(e){return e?Buffer.from(JSON.stringify(e),"utf8").toString("base64"):null}function J(e){if(e)try{return JSON.parse(Buffer.from(String(e),"base64").toString("utf8"))}catch{return}}var k=async e=>{let{isAdmin:n}=y(e);if(!n)throw new Error("Forbidden");return((await m.send(new u.QueryCommand({TableName:l,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":s("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(t=>g({...t,status:t.status}))},v=async e=>{let{isAdmin:n}=y(e);if(!n)throw new Error("Forbidden");let{status:r,limit:t=50,nextToken:a}=e.arguments||{},o=J(a);if(r){let d=await m.send(new u.QueryCommand({TableName:l,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":s(`STATUS#${r}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory",ExpressionAttributeNames:{"#s":"status"},Limit:t,ExclusiveStartKey:o}));return{items:(d.Items||[]).map(p=>g({...p,status:p.status})),nextToken:N(d.LastEvaluatedKey)}}let c=await m.send(new u.ScanCommand({TableName:l,FilterExpression:"begins_with(pk, :p)",ExpressionAttributeValues:{":p":s("ITEM#")},ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory",ExpressionAttributeNames:{"#s":"status"},Limit:t,ExclusiveStartKey:o})),i=(c.Items||[]).map(d=>g({...d,status:d.status}));return i.sort((d,E)=>new Date(E.createdAt||0).getTime()-new Date(d.createdAt||0).getTime()),{items:i,nextToken:N(c.LastEvaluatedKey)}},I=async e=>{let{sub:n}=y(e),{sort:r="NEWEST"}=e.arguments||{},[t,a]=await Promise.all([m.send(new u.QueryCommand({TableName:l,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":s("STATUS#PUBLISHED")},ScanIndexForward:r==="NEWEST",ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, audience, favoriteCount, category, subcategory",ExpressionAttributeNames:{"#s":"status"}})),m.send(new u.QueryCommand({TableName:l,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:{":pk":s(`FAV#${n}`),":sk":s("CLOSET#")}}))]),o=new Set((a.Items||[]).map(i=>{let d=i.sk?.S??"";return d.startsWith("CLOSET#")?d.substring(7):i.closetId?.S??""})),c=(t.Items||[]).map(i=>g({...i,status:i.status},{viewerHasFaved:o.has(i.id.S)}));return r==="MOST_LOVED"&&c.sort((i,d)=>{let E=i.favoriteCount??0,p=d.favoriteCount??0;return p!==E?p-E:new Date(d.createdAt||0).getTime()-new Date(i.createdAt||0).getTime()}),c},K=async e=>I({...e,arguments:{sort:"NEWEST"}}),L=async e=>{let{sub:n,isAdmin:r}=y(e);if(!r)throw new Error("Forbidden");let t=e.arguments?.input||{};if(!t.title?.trim())throw new Error("title is required");if(!t.rawMediaKey)throw new Error("rawMediaKey is required");let a=H(),o=f();return await m.send(new u.PutItemCommand({TableName:l,Item:{pk:s(`ITEM#${a}`),sk:s("META"),id:s(a),ownerSub:s(n),gsi2pk:s("STATUS#PENDING"),gsi2sk:s(o),status:s("PENDING"),createdAt:s(o),updatedAt:s(o),title:s(t.title.trim()),rawMediaKey:s(t.rawMediaKey),favoriteCount:{N:"0"},...t.season?{season:s(t.season)}:{},...t.vibes?{vibes:s(t.vibes)}:{},...t.category?{category:s(t.category)}:{},...t.subcategory?{subcategory:s(t.subcategory)}:{}}})),{id:a,userId:n,ownerSub:n,status:"PENDING",createdAt:o,updatedAt:o,title:t.title.trim(),mediaKey:"",rawMediaKey:t.rawMediaKey,reason:"",season:t.season??null,vibes:t.vibes??null,audience:null,category:t.category??null,subcategory:t.subcategory??null,favoriteCount:0,viewerHasFaved:!1}},M=async e=>{let{isAdmin:n}=y(e);if(!n)throw new Error("Forbidden");let r=e.arguments?.id;if(!r)throw new Error("id required");let t=f(),o=(await m.send(new u.UpdateItemCommand({TableName:l,Key:{pk:s(`ITEM#${r}`),sk:s("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":s("APPROVED"),":u":s(t),":g2pk":s("STATUS#APPROVED"),":g2sk":s(t)},ReturnValues:"ALL_OLD"}))).Attributes,c=o.approvalToken?.S;if(c)try{await x.send(new A.SendTaskSuccessCommand({taskToken:c,output:JSON.stringify({approved:!0})}))}catch{}return g({...o,status:s("APPROVED")})},h=async e=>{let{isAdmin:n}=y(e);if(!n)throw new Error("Forbidden");let r=e.arguments?.id,t=e.arguments?.reason||"";if(!r)throw new Error("id required");let a=f(),c=(await m.send(new u.UpdateItemCommand({TableName:l,Key:{pk:s(`ITEM#${r}`),sk:s("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":s("REJECTED"),":u":s(a),":g2pk":s("STATUS#REJECTED"),":g2sk":s(a),":r":s(t)},ReturnValues:"ALL_OLD"}))).Attributes,i=c.approvalToken?.S;if(i)try{await x.send(new A.SendTaskFailureCommand({taskToken:i,error:"Rejected",cause:t||"Rejected by admin"}))}catch{}return g({...c,status:s("REJECTED"),reason:s(t)})},P=async e=>{let{isAdmin:n}=y(e);if(!n)throw new Error("Forbidden");let r=e.arguments?.closetItemId,t=e.arguments?.input||{};if(!r)throw new Error("closetItemId required");let a=f(),o=["#updatedAt = :u"],c={"#updatedAt":"updatedAt"},i={":u":s(a)};if(t.title!==void 0&&(o.push("#title = :title"),c["#title"]="title",i[":title"]=t.title===null?{NULL:!0}:s(t.title)),t.category!==void 0&&(o.push("#category = :category"),c["#category"]="category",i[":category"]=t.category===null?{NULL:!0}:s(t.category)),t.subcategory!==void 0&&(o.push("#subcategory = :subcategory"),c["#subcategory"]="subcategory",i[":subcategory"]=t.subcategory===null?{NULL:!0}:s(t.subcategory)),t.audience!==void 0&&(o.push("audience = :audience"),i[":audience"]=t.audience===null?{NULL:!0}:s(t.audience)),o.length===1)throw new Error("No fields provided to update");let d=await m.send(new u.UpdateItemCommand({TableName:l,Key:{pk:s(`ITEM#${r}`),sk:s("META")},UpdateExpression:`SET ${o.join(", ")}`,ExpressionAttributeNames:c,ExpressionAttributeValues:i,ReturnValues:"ALL_NEW"}));if(!d.Attributes)throw new Error("Closet item not found");return g(d.Attributes)},D=async()=>"NOT_IMPLEMENTED",O=async e=>{let{sub:n}=y(e),r=e.arguments?.id,t=e.arguments?.favoriteOn,a=e.arguments?.on,o=typeof t=="boolean"?t:a;if(!r)throw new Error("id required");let i=(await m.send(new u.GetItemCommand({TableName:l,Key:{pk:s(`ITEM#${r}`),sk:s("META")}}))).Item;if(!i)throw new Error("Closet item not found");let d={pk:s(`FAV#${n}`),sk:s(`CLOSET#${r}`)},p=!!(await m.send(new u.GetItemCommand({TableName:l,Key:d}))).Item,w=typeof o=="boolean"?o:!p,C=f(),b=0;w&&!p?(b=1,await m.send(new u.PutItemCommand({TableName:l,Item:{...d,userSub:s(n),closetId:s(r),createdAt:s(C)}}))):!w&&p&&(b=-1,await m.send(new u.DeleteItemCommand({TableName:l,Key:d}))),b!==0&&await m.send(new u.UpdateItemCommand({TableName:l,Key:{pk:s(`ITEM#${r}`),sk:s("META")},UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) + :delta, updatedAt = :u",ExpressionAttributeValues:{":zero":{N:"0"},":delta":{N:String(b)},":u":s(C)}}));let T=i.favoriteCount?.N,U=typeof T=="string"?Number(T):0,V=Math.max(0,U+b);return g(i,{favoriteCount:V,viewerHasFaved:w})},q=async e=>{let n=e.info.fieldName;if(n==="adminListPending")return k(e);if(n==="adminListClosetItems")return v(e);if(n==="adminCreateClosetItem")return L(e);if(n==="adminApproveItem")return M(e);if(n==="adminRejectItem")return h(e);if(n==="adminSetClosetAudience")return D();if(n==="adminUpdateClosetItem")return P(e);if(n==="closetFeed")return I(e);if(n==="topClosetLooks")return K(e);if(n==="toggleFavoriteClosetItem")return O(e);throw new Error(`No resolver implemented for field ${n}`)};0&&(module.exports={adminApproveItem,adminCreateClosetItem,adminListClosetItems,adminListPending,adminRejectItem,adminSetClosetAudience,adminUpdateClosetItem,closetFeed,handler,toggleFavoriteClosetItem,topClosetLooks});
//# sourceMappingURL=index.js.map
