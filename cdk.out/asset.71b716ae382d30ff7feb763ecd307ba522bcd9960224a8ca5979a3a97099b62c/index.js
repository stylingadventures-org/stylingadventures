"use strict";var E=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var P=(e,t)=>{for(var i in t)E(e,i,{get:t[i],enumerable:!0})},D=(e,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of N(t))!M.call(e,r)&&r!==i&&E(e,r,{get:()=>t[r],enumerable:!(s=k(t,r))||s.enumerable});return e};var x=e=>D(E({},"__esModule",{value:!0}),e);var h={};P(h,{adminApproveItem:()=>b,adminCreateClosetItem:()=>T,adminListPending:()=>w,adminRejectItem:()=>C,adminSetClosetAudience:()=>f,closetFeed:()=>S,handler:()=>v,topClosetLooks:()=>I});module.exports=x(h);var a=require("@aws-sdk/client-dynamodb"),u=require("@aws-sdk/client-sfn"),m=new a.DynamoDBClient({}),g=new u.SFNClient({}),{TABLE_NAME:p=""}=process.env;if(!p)throw new Error("Missing env: TABLE_NAME");var A=()=>new Date().toISOString(),n=e=>({S:e});function c(e){let t=e.identity?.claims||{},i=e.identity?.sub||t.sub,s=t["cognito:groups"],r=Array.isArray(s)?s:String(s||"").split(",").map(d=>d.trim()).filter(Boolean),o=r.includes("ADMIN")||r.includes("COLLAB");if(!i)throw new Error("Unauthorized");return{sub:i,isAdmin:o}}function l(e){return{id:e.id.S,userId:e.ownerSub.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",rawMediaKey:e.rawMediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??"",season:e.season?.S??null,vibes:e.vibes?.S??null}}function K(){return globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`}var w=async e=>{let{isAdmin:t}=c(e);if(!t)throw new Error("Forbidden");return((await m.send(new a.QueryCommand({TableName:p,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(s=>l({...s,status:s.status}))},S=async e=>{c(e);let{sort:t="NEWEST"}=e.arguments||{},s=((await m.send(new a.QueryCommand({TableName:p,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n("STATUS#PUBLISHED")},ScanIndexForward:t==="NEWEST",ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(r=>l({...r,status:r.status}));return s},I=async e=>S({...e,arguments:{sort:"NEWEST"}}),T=async e=>{let{sub:t,isAdmin:i}=c(e);if(!i)throw new Error("Forbidden");let s=e.arguments?.input||{};if(!s.title?.trim())throw new Error("title is required");if(!s.rawMediaKey)throw new Error("rawMediaKey is required");let r=K(),o=A();return await m.send(new a.PutItemCommand({TableName:p,Item:{pk:n(`ITEM#${r}`),sk:n("META"),id:n(r),ownerSub:n(t),gsi2pk:n("STATUS#PENDING"),gsi2sk:n(o),status:n("PENDING"),createdAt:n(o),updatedAt:n(o),title:n(s.title.trim()),rawMediaKey:n(s.rawMediaKey),...s.season?{season:n(s.season)}:{},...s.vibes?{vibes:n(s.vibes)}:{}}})),{id:r,userId:t,ownerSub:t,status:"PENDING",createdAt:o,updatedAt:o,title:s.title.trim(),mediaKey:"",rawMediaKey:s.rawMediaKey,reason:"",season:s.season??null,vibes:s.vibes??null}},b=async e=>{let{isAdmin:t}=c(e);if(!t)throw new Error("Forbidden");let i=e.arguments?.id;if(!i)throw new Error("id required");let s=A(),o=(await m.send(new a.UpdateItemCommand({TableName:p,Key:{pk:n(`ITEM#${i}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("APPROVED"),":u":n(s),":g2pk":n("STATUS#APPROVED"),":g2sk":n(s)},ReturnValues:"ALL_OLD"}))).Attributes,d=o.approvalToken?.S;if(d)try{await g.send(new u.SendTaskSuccessCommand({taskToken:d,output:JSON.stringify({approved:!0})}))}catch{}return l({...o,status:n("APPROVED")})},C=async e=>{let{isAdmin:t}=c(e);if(!t)throw new Error("Forbidden");let i=e.arguments?.id,s=e.arguments?.reason||"";if(!i)throw new Error("id required");let r=A(),d=(await m.send(new a.UpdateItemCommand({TableName:p,Key:{pk:n(`ITEM#${i}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("REJECTED"),":u":n(r),":g2pk":n("STATUS#REJECTED"),":g2sk":n(r),":r":n(s)},ReturnValues:"ALL_OLD"}))).Attributes,y=d.approvalToken?.S;if(y)try{await g.send(new u.SendTaskFailureCommand({taskToken:y,error:"Rejected",cause:s||"Rejected by admin"}))}catch{}return l({...d,status:n("REJECTED"),reason:n(s)})},f=async()=>"NOT_IMPLEMENTED",v=async e=>{let t=e.info.fieldName;if(t==="adminListPending")return w(e);if(t==="adminCreateClosetItem")return T(e);if(t==="adminApproveItem")return b(e);if(t==="adminRejectItem")return C(e);if(t==="adminSetClosetAudience")return f();if(t==="closetFeed")return S(e);if(t==="topClosetLooks")return I(e);throw new Error(`No resolver implemented for field ${t}`)};0&&(module.exports={adminApproveItem,adminCreateClosetItem,adminListPending,adminRejectItem,adminSetClosetAudience,closetFeed,handler,topClosetLooks});
//# sourceMappingURL=index.js.map
