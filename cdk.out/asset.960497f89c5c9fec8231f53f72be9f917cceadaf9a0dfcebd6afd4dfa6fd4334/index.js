"use strict";var I=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var $=Object.prototype.hasOwnProperty;var _=(e,n)=>{for(var r in n)I(e,r,{get:n[r],enumerable:!0})},j=(e,n,r,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let i of R(n))!$.call(e,i)&&i!==r&&I(e,i,{get:()=>n[i],enumerable:!(t=F(n,i))||t.enumerable});return e};var B=e=>j(I({},"__esModule",{value:!0}),e);var G={};_(G,{adminApproveItem:()=>L,adminCreateClosetItem:()=>K,adminListClosetItems:()=>v,adminListPending:()=>k,adminRejectItem:()=>M,adminSetClosetAudience:()=>D,adminUpdateClosetItem:()=>P,closetFeed:()=>S,handler:()=>J,toggleFavoriteClosetItem:()=>O,topClosetLooks:()=>h});module.exports=B(G);var d=require("@aws-sdk/client-dynamodb"),A=require("@aws-sdk/client-sfn"),m=new d.DynamoDBClient({}),x=new A.SFNClient({}),{TABLE_NAME:l=""}=process.env;if(!l)throw new Error("Missing env: TABLE_NAME");var b=()=>new Date().toISOString(),s=e=>({S:e});function y(e){let n=e.identity?.claims||{},r=e.identity?.sub||n.sub,t=n["cognito:groups"],i=Array.isArray(t)?t:String(t||"").split(",").map(a=>a.trim()).filter(Boolean),o=i.includes("ADMIN")||i.includes("COLLAB");if(!r)throw new Error("Unauthorized");return{sub:r,isAdmin:o}}function g(e,n){let r=e.favoriteCount?.N,t=typeof r=="string"?Number(r):0;return{id:e.id.S,userId:e.ownerSub.S,ownerSub:e.ownerSub.S,status:e.status.S,createdAt:e.createdAt.S,updatedAt:e.updatedAt.S,mediaKey:e.mediaKey?.S??"",rawMediaKey:e.rawMediaKey?.S??"",title:e.title?.S??"",reason:e.reason?.S??"",season:e.season?.S??null,vibes:e.vibes?.S??null,audience:e.audience?.S??null,category:e.category?.S??null,subcategory:e.subcategory?.S??null,favoriteCount:t,viewerHasFaved:!1,...n}}function q(){return globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,10)}`}function N(e){return e?Buffer.from(JSON.stringify(e),"utf8").toString("base64"):null}function H(e){if(e)try{return JSON.parse(Buffer.from(String(e),"base64").toString("utf8"))}catch{return}}var k=async e=>{let{isAdmin:n}=y(e);if(!n)throw new Error("Forbidden");return((await m.send(new d.QueryCommand({TableName:l,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":s("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(t=>g({...t,status:t.status}))},v=async e=>{let{isAdmin:n}=y(e);if(!n)throw new Error("Forbidden");let{status:r,limit:t=50,nextToken:i}=e.arguments||{},o=H(i);if(r){let c=await m.send(new d.QueryCommand({TableName:l,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":s(`STATUS#${r}`)},ScanIndexForward:!1,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory",ExpressionAttributeNames:{"#s":"status"},Limit:t,ExclusiveStartKey:o}));return{items:(c.Items||[]).map(p=>g({...p,status:p.status})),nextToken:N(c.LastEvaluatedKey)}}let a=await m.send(new d.ScanCommand({TableName:l,FilterExpression:"begins_with(pk, :p)",ExpressionAttributeValues:{":p":s("ITEM#")},ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, reason, season, vibes, audience, favoriteCount, category, subcategory",ExpressionAttributeNames:{"#s":"status"},Limit:t,ExclusiveStartKey:o})),u=(a.Items||[]).map(c=>g({...c,status:c.status}));return u.sort((c,E)=>new Date(E.createdAt||0).getTime()-new Date(c.createdAt||0).getTime()),{items:u,nextToken:N(a.LastEvaluatedKey)}},S=async e=>{let{sub:n}=y(e),{sort:r="NEWEST"}=e.arguments||{},[t,i]=await Promise.all([m.send(new d.QueryCommand({TableName:l,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":s("STATUS#PUBLISHED")},ScanIndexForward:r==="NEWEST",ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, rawMediaKey, title, audience, favoriteCount, category, subcategory, season, vibes",ExpressionAttributeNames:{"#s":"status"}})),m.send(new d.QueryCommand({TableName:l,KeyConditionExpression:"pk = :pk AND begins_with(sk, :sk)",ExpressionAttributeValues:{":pk":s(`FAV#${n}`),":sk":s("CLOSET#")}}))]),o=new Set((i.Items||[]).map(u=>{let c=u.sk?.S??"";return c.startsWith("CLOSET#")?c.substring(7):u.closetId?.S??""})),a=(t.Items||[]).map(u=>g({...u,status:u.status},{viewerHasFaved:o.has(u.id.S)}));return r==="MOST_LOVED"&&a.sort((u,c)=>{let E=u.favoriteCount??0,p=c.favoriteCount??0;return p!==E?p-E:new Date(c.createdAt||0).getTime()-new Date(u.createdAt||0).getTime()}),a},h=async e=>S({...e,arguments:{sort:"NEWEST"}}),K=async e=>{let{sub:n,isAdmin:r}=y(e);if(!r)throw new Error("Forbidden");let t=e.arguments?.input||{};if(!t.title?.trim())throw new Error("title is required");let i=t.rawMediaKey||t.mediaKey;if(!i)throw new Error("rawMediaKey is required");let o=q(),a=b();return await m.send(new d.PutItemCommand({TableName:l,Item:{pk:s(`ITEM#${o}`),sk:s("META"),id:s(o),ownerSub:s(n),gsi2pk:s("STATUS#PENDING"),gsi2sk:s(a),status:s("PENDING"),createdAt:s(a),updatedAt:s(a),title:s(t.title.trim()),rawMediaKey:s(i),favoriteCount:{N:"0"},...t.season?{season:s(t.season)}:{},...t.vibes?{vibes:s(t.vibes)}:{},...t.category?{category:s(t.category)}:{},...t.subcategory?{subcategory:s(t.subcategory)}:{},...t.audience?{audience:s(t.audience)}:{},...t.description?{description:s(t.description)}:{},...t.story?{story:s(t.story)}:{}}})),{id:o,userId:n,ownerSub:n,status:"PENDING",createdAt:a,updatedAt:a,title:t.title.trim(),mediaKey:"",rawMediaKey:i,reason:"",season:t.season??null,vibes:t.vibes??null,audience:t.audience??null,category:t.category??null,subcategory:t.subcategory??null,favoriteCount:0,viewerHasFaved:!1}},L=async e=>{let{isAdmin:n}=y(e);if(!n)throw new Error("Forbidden");let r=e.arguments?.closetItemId;if(!r)throw new Error("closetItemId required");let t=b(),o=(await m.send(new d.UpdateItemCommand({TableName:l,Key:{pk:s(`ITEM#${r}`),sk:s("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":s("APPROVED"),":u":s(t),":g2pk":s("STATUS#APPROVED"),":g2sk":s(t)},ReturnValues:"ALL_OLD"}))).Attributes,a=o.approvalToken?.S;if(a)try{await x.send(new A.SendTaskSuccessCommand({taskToken:a,output:JSON.stringify({approved:!0})}))}catch{}return g({...o,status:s("APPROVED")})},M=async e=>{let{isAdmin:n}=y(e);if(!n)throw new Error("Forbidden");let r=e.arguments?.closetItemId,t=e.arguments?.reason||"";if(!r)throw new Error("closetItemId required");let i=b(),a=(await m.send(new d.UpdateItemCommand({TableName:l,Key:{pk:s(`ITEM#${r}`),sk:s("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":s("REJECTED"),":u":s(i),":g2pk":s("STATUS#REJECTED"),":g2sk":s(i),":r":s(t)},ReturnValues:"ALL_OLD"}))).Attributes,u=a.approvalToken?.S;if(u)try{await x.send(new A.SendTaskFailureCommand({taskToken:u,error:"Rejected",cause:t||"Rejected by admin"}))}catch{}return g({...a,status:s("REJECTED"),reason:s(t)})},P=async e=>{let{isAdmin:n}=y(e);if(!n)throw new Error("Forbidden");let r=e.arguments?.closetItemId,t=e.arguments?.input||{};if(!r)throw new Error("closetItemId required");let i=b(),o=["#updatedAt = :u"],a={"#updatedAt":"updatedAt"},u={":u":s(i)};if(t.title!==void 0&&(o.push("#title = :title"),a["#title"]="title",u[":title"]=t.title===null?{NULL:!0}:s(t.title)),t.category!==void 0&&(o.push("#category = :category"),a["#category"]="category",u[":category"]=t.category===null?{NULL:!0}:s(t.category)),t.subcategory!==void 0&&(o.push("#subcategory = :subcategory"),a["#subcategory"]="subcategory",u[":subcategory"]=t.subcategory===null?{NULL:!0}:s(t.subcategory)),t.audience!==void 0&&(o.push("audience = :audience"),u[":audience"]=t.audience===null?{NULL:!0}:s(t.audience)),o.length===1)throw new Error("No fields provided to update");let c=await m.send(new d.UpdateItemCommand({TableName:l,Key:{pk:s(`ITEM#${r}`),sk:s("META")},UpdateExpression:`SET ${o.join(", ")}`,ExpressionAttributeNames:a,ExpressionAttributeValues:u,ReturnValues:"ALL_NEW"}));if(!c.Attributes)throw new Error("Closet item not found");return g(c.Attributes)},D=async e=>{let{isAdmin:n}=y(e);if(!n)throw new Error("Forbidden");let r=e.arguments?.closetItemId,t=e.arguments?.audience;if(!r)throw new Error("closetItemId required");if(!t)throw new Error("audience required");let i=b(),o=await m.send(new d.UpdateItemCommand({TableName:l,Key:{pk:s(`ITEM#${r}`),sk:s("META")},UpdateExpression:"SET audience = :aud, updatedAt = :u",ExpressionAttributeValues:{":aud":s(t),":u":s(i)},ReturnValues:"ALL_NEW"}));if(!o.Attributes)throw new Error("Closet item not found");return g(o.Attributes)},O=async e=>{let{sub:n}=y(e),r=e.arguments?.id,t=e.arguments?.favoriteOn,i=e.arguments?.on,o=typeof t=="boolean"?t:i;if(!r)throw new Error("id required");let u=(await m.send(new d.GetItemCommand({TableName:l,Key:{pk:s(`ITEM#${r}`),sk:s("META")}}))).Item;if(!u)throw new Error("Closet item not found");let c={pk:s(`FAV#${n}`),sk:s(`CLOSET#${r}`)},p=!!(await m.send(new d.GetItemCommand({TableName:l,Key:c}))).Item,w=typeof o=="boolean"?o:!p,C=b(),f=0;w&&!p?(f=1,await m.send(new d.PutItemCommand({TableName:l,Item:{...c,userSub:s(n),closetId:s(r),createdAt:s(C)}}))):!w&&p&&(f=-1,await m.send(new d.DeleteItemCommand({TableName:l,Key:c}))),f!==0&&await m.send(new d.UpdateItemCommand({TableName:l,Key:{pk:s(`ITEM#${r}`),sk:s("META")},UpdateExpression:"SET favoriteCount = if_not_exists(favoriteCount, :zero) + :delta, updatedAt = :u",ExpressionAttributeValues:{":zero":{N:"0"},":delta":{N:String(f)},":u":s(C)}}));let T=u.favoriteCount?.N,V=typeof T=="string"?Number(T):0,U=Math.max(0,V+f);return g(u,{favoriteCount:U,viewerHasFaved:w})},J=async e=>{let n=e.info.fieldName;if(n==="adminListPending")return k(e);if(n==="adminListClosetItems")return v(e);if(n==="adminCreateClosetItem")return K(e);if(n==="adminApproveItem")return L(e);if(n==="adminRejectItem")return M(e);if(n==="adminSetClosetAudience")return D(e);if(n==="adminUpdateClosetItem")return P(e);if(n==="closetFeed")return S(e);if(n==="topClosetLooks")return h(e);if(n==="toggleFavoriteClosetItem")return O(e);throw new Error(`No resolver implemented for field ${n}`)};0&&(module.exports={adminApproveItem,adminCreateClosetItem,adminListClosetItems,adminListPending,adminRejectItem,adminSetClosetAudience,adminUpdateClosetItem,closetFeed,handler,toggleFavoriteClosetItem,topClosetLooks});
//# sourceMappingURL=index.js.map
