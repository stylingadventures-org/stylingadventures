"use strict";var c=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var v=Object.prototype.hasOwnProperty;var N=(s,t)=>{for(var e in t)c(s,e,{get:t[e],enumerable:!0})},T=(s,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of x(t))!v.call(s,i)&&i!==e&&c(s,i,{get:()=>t[i],enumerable:!(n=w(t,i))||n.enumerable});return s};var S=s=>T(c({},"__esModule",{value:!0}),s);var U={};N(U,{handler:()=>L});module.exports=S(U);var A=require("@aws-sdk/client-dynamodb"),a=require("@aws-sdk/lib-dynamodb");var o=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!o)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var d=a.DynamoDBDocumentClient.from(new A.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),E=s=>`USER#${s}`,m="PROFILE";function f(s){let t=1,e=100,n=s|0;for(;n>=e;)n-=e,t++,e+=50;return t}async function g(s){let t=E(s),{Item:e}=await d.send(new a.GetCommand({TableName:o,Key:{pk:t,sk:m}}));if(!e){let b=new Date().toISOString();await d.send(new a.UpdateCommand({TableName:o,Key:{pk:t,sk:m},UpdateExpression:"SET #uid=:uid, #xp=:xp, #coins=:coins, #badges=:badges, #ts=:ts",ExpressionAttributeNames:{"#uid":"userId","#xp":"xp","#coins":"coins","#badges":"badges","#ts":"lastEventAt"},ExpressionAttributeValues:{":uid":s,":xp":0,":coins":0,":badges":[],":ts":b}}));let y=0;return{userId:s,level:f(y),xp:y,coins:0,badges:[],lastEventAt:b,streakCount:null,lastLoginAt:null,displayName:null,avatarUrl:null,bio:null}}e.userId||await d.send(new a.UpdateCommand({TableName:o,Key:{pk:t,sk:m},UpdateExpression:"SET #uid = if_not_exists(#uid, :uid)",ExpressionAttributeNames:{"#uid":"userId"},ExpressionAttributeValues:{":uid":s}}));let n=null,i=e.lastEventAt;typeof i=="number"?(n=new Date(i).toISOString(),await d.send(new a.UpdateCommand({TableName:o,Key:{pk:t,sk:m},UpdateExpression:"SET #ts = :ts",ExpressionAttributeNames:{"#ts":"lastEventAt"},ExpressionAttributeValues:{":ts":n}}))):typeof i=="string"?n=i:n=null;let p=null,r=e.lastLoginAt;typeof r=="number"?(p=new Date(r).toISOString(),await d.send(new a.UpdateCommand({TableName:o,Key:{pk:t,sk:m},UpdateExpression:"SET #ll = :ll",ExpressionAttributeNames:{"#ll":"lastLoginAt"},ExpressionAttributeValues:{":ll":p}}))):typeof r=="string"?p=r:p=null;let l=e.xp??0,u=e.coins??0;return{userId:e.userId??s,level:f(l),xp:l,coins:u,badges:Array.isArray(e.badges)?e.badges:[],displayName:e.displayName??null,avatarUrl:e.avatarUrl??null,bio:e.bio??null,lastEventAt:n,streakCount:typeof e.streakCount=="number"?e.streakCount:null,lastLoginAt:p}}async function I(s,t){let e=E(s),n=(t??"").trim().slice(0,40),i=new Date().toISOString();return await d.send(new a.UpdateCommand({TableName:o,Key:{pk:e,sk:m},UpdateExpression:"SET #dn=:dn, #ts=:ts ADD #xp :zero, #coins :zero",ExpressionAttributeNames:{"#dn":"displayName","#ts":"lastEventAt","#xp":"xp","#coins":"coins"},ExpressionAttributeValues:{":dn":n,":ts":i,":zero":0}})),g(s)}var L=async s=>{let t=s.identity?.sub;if(!t)throw new Error("Unauthorized: missing sub");switch(s.info.fieldName){case"getMyProfile":return g(t);case"setDisplayName":return I(t,s.arguments.displayName);case"updateProfile":{let{displayName:e,avatarUrl:n,bio:i}=s.arguments.input||{},p=E(t),r={},l={},u=[];return typeof e=="string"&&(r["#dn"]="displayName",l[":dn"]=e.trim().slice(0,40),u.push("#dn = :dn")),typeof n=="string"&&(r["#av"]="avatarUrl",l[":av"]=n,u.push("#av = :av")),typeof i=="string"&&(r["#bio"]="bio",l[":bio"]=i.trim().slice(0,280),u.push("#bio = :bio")),r["#ts"]="lastEventAt",l[":ts"]=new Date().toISOString(),u.push("#ts = :ts"),u.length&&await d.send(new a.UpdateCommand({TableName:o,Key:{pk:p,sk:m},UpdateExpression:`SET ${u.join(", ")}`,ExpressionAttributeNames:r,ExpressionAttributeValues:l})),g(t)}default:throw new Error(`Unknown field ${s.info.fieldName}`)}};0&&(module.exports={handler});
