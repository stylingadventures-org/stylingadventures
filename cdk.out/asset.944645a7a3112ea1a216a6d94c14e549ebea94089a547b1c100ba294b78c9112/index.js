"use strict";var p=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var f=(t,e)=>{for(var n in e)p(t,n,{get:e[n],enumerable:!0})},I=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of S(e))!w.call(t,s)&&s!==n&&p(t,s,{get:()=>e[s],enumerable:!(r=E(e,s))||r.enumerable});return t};var b=t=>I(p({},"__esModule",{value:!0}),t);var P={};f(P,{handler:()=>y});module.exports=b(P);var i=require("@aws-sdk/client-dynamodb"),c=require("@aws-sdk/util-dynamodb"),d=new i.DynamoDBClient({}),o=process.env.TABLE_NAME||process.env.APP_TABLE||void 0;if(!o)throw new Error("ClosetAdminFn: TABLE_NAME (or APP_TABLE) environment variable is required");function u(t){let e=(0,c.unmarshall)(t);return{id:String(e.id),userId:String(e.userId??e.ownerSub??""),ownerSub:String(e.ownerSub??e.userId??""),status:e.status??"PENDING",createdAt:String(e.createdAt),updatedAt:String(e.updatedAt??e.createdAt),mediaKey:e.mediaKey??null,title:e.title??null,reason:e.reason??null,audience:e.audience??"PUBLIC"}}async function m(t){let e=await d.send(new i.ScanCommand({TableName:o,FilterExpression:"begins_with(#pk, :itemPrefix) AND #sk = :meta AND #id = :id",ExpressionAttributeNames:{"#pk":"pk","#sk":"sk","#id":"id"},ExpressionAttributeValues:{":itemPrefix":{S:"ITEM#"},":meta":{S:"META"},":id":{S:t}},Limit:1}));return!e.Items||e.Items.length===0?null:e.Items[0]}function l(t){if(t.pk?.S&&t.sk?.S)return{pk:t.pk.S,sk:t.sk.S};throw new Error("ClosetAdminFn: Could not infer pk/sk for closet item")}async function k(){let e=((await d.send(new i.ScanCommand({TableName:o,FilterExpression:"begins_with(#pk, :itemPrefix) AND #sk = :meta AND (#status = :pending OR #status = :approved OR #status = :published)",ExpressionAttributeNames:{"#pk":"pk","#sk":"sk","#status":"status"},ExpressionAttributeValues:{":itemPrefix":{S:"ITEM#"},":meta":{S:"META"},":pending":{S:"PENDING"},":approved":{S:"APPROVED"},":published":{S:"PUBLISHED"}}}))).Items||[]).map(u);return e.sort((n,r)=>n.createdAt<r.createdAt?1:-1),e}async function C(t){let e=await m(t.id);if(!e)throw new Error(`Closet item not found for id=${t.id}`);let{pk:n,sk:r}=l(e),s=new Date().toISOString(),a=await d.send(new i.UpdateItemCommand({TableName:o,Key:{pk:{S:n},sk:{S:r}},UpdateExpression:"SET #status = :approved, #updatedAt = :now REMOVE #reason",ExpressionAttributeNames:{"#status":"status","#updatedAt":"updatedAt","#reason":"reason"},ExpressionAttributeValues:{":approved":{S:"APPROVED"},":now":{S:s}},ReturnValues:"ALL_NEW"}));if(!a.Attributes)throw new Error("adminApproveItem: update returned no attributes");return u(a.Attributes)}async function g(t){let e=await m(t.id);if(!e)throw new Error(`Closet item not found for id=${t.id}`);let{pk:n,sk:r}=l(e),s=new Date().toISOString(),a=!!t.reason&&t.reason.trim().length>0,A=await d.send(new i.UpdateItemCommand({TableName:o,Key:{pk:{S:n},sk:{S:r}},UpdateExpression:a?"SET #status = :rejected, #updatedAt = :now, #reason = :reason":"SET #status = :rejected, #updatedAt = :now REMOVE #reason",ExpressionAttributeNames:{"#status":"status","#updatedAt":"updatedAt","#reason":"reason"},ExpressionAttributeValues:{":rejected":{S:"REJECTED"},":now":{S:s},...a?{":reason":{S:t.reason}}:{}},ReturnValues:"ALL_NEW"}));if(!A.Attributes)throw new Error("adminRejectItem: update returned no attributes");return u(A.Attributes)}async function N(t){let e=await m(t.id);if(!e)throw new Error(`Closet item not found for id=${t.id}`);let{pk:n,sk:r}=l(e),s=new Date().toISOString(),a=await d.send(new i.UpdateItemCommand({TableName:o,Key:{pk:{S:n},sk:{S:r}},UpdateExpression:"SET #audience = :aud, #updatedAt = :now",ExpressionAttributeNames:{"#audience":"audience","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":aud":{S:t.audience},":now":{S:s}},ReturnValues:"ALL_NEW"}));if(!a.Attributes)throw new Error("adminSetClosetAudience: update returned no attributes");return u(a.Attributes)}var y=async t=>{let{fieldName:e,parentTypeName:n}=t.info;if(n==="Query"&&e==="adminListPending")return k();if(n==="Mutation"){if(e==="adminApproveItem")return C(t.arguments);if(e==="adminRejectItem")return g(t.arguments);if(e==="adminSetClosetAudience")return N(t.arguments)}throw new Error(`Unknown field ${n}.${e} in ClosetAdminFn`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
