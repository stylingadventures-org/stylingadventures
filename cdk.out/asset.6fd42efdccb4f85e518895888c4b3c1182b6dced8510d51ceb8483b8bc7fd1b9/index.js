"use strict";var I=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var b=Object.prototype.hasOwnProperty;var C=(e,t)=>{for(var n in t)I(e,n,{get:t[n],enumerable:!0})},x=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of D(t))!b.call(e,r)&&r!==n&&I(e,r,{get:()=>t[r],enumerable:!(s=$(t,r))||s.enumerable});return e};var T=e=>x(I({},"__esModule",{value:!0}),e);var H={};C(H,{handler:()=>v});module.exports=T(H);var S=require("@aws-sdk/client-appsync"),w=e=>new Promise(t=>setTimeout(t,e));function E(){return new Date().toISOString()}function u(...e){console.log(`[schema-ready] ${E()}`,...e)}function P(...e){console.warn(`[schema-ready] ${E()}`,...e)}function N(...e){console.error(`[schema-ready] ${E()}`,...e)}function R(e,t){if(typeof e=="string"&&e.trim().length>0)return e.trim();throw new Error(`Missing required "${t}" (got ${JSON.stringify(e)})`)}function y(e,t){let n=Number(e);return Number.isFinite(n)&&n>0?n:t}function L(e){let t=e.match(/type\s+Mutation\s*\{[\s\S]*?\}/m);return t?t[0]:null}function F(e,t){return new RegExp(`\\b${M(t)}\\b`).test(e)}function _(e,t){let n=L(e);return n?new RegExp(`\\b${M(t)}\\b`).test(n):!1}function M(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async function k(e,t){let n=await e.send(new S.GetSchemaCreationStatusCommand({apiId:t}));return{status:n.status??"UNKNOWN",details:n.details??""}}async function O(e,t){let s=(await e.send(new S.GetIntrospectionSchemaCommand({apiId:t,format:"SDL"}))).schema;return s?(typeof s=="string"?Buffer.from(s,"base64"):Buffer.from(s)).toString("utf8"):""}async function q(e,t,n,s){for(let r=1;r<=n;r++){let{status:c,details:l}=await k(e,t);if(u(`schema status attempt ${r}/${n}: ${c} (${l})`),c==="SUCCESS")return{status:c,details:l};if(c==="FAILED")throw new Error(`Schema status FAILED: ${l||"no details"}`);await w(s)}throw new Error("Timed out waiting for schema to reach SUCCESS")}async function U(e,t,n,s,r){let c=0,l=!1;for(let p=1;p<=s;p++){let o="";try{o=await O(e,t)}catch(i){P(`introspection attempt ${p}/${s} error:`,i?.message??i),await w(r);continue}c=o.length;let m=F(o,n),d=_(o,n);if(l=d,u(`introspection attempt ${p}/${s}: sdlLen=${o.length} fieldAnywhere=${m} fieldInMutation=${d}`),p===1){u("SDL prefix (first 2000 chars):",JSON.stringify(o.slice(0,2e3)));let i=o.match(/extend type Query \{[\s\S]*?\}/);i?u("Query block found:",JSON.stringify(i[0])):u("No 'extend type Query' block found")}if(m){let i=o.search(new RegExp(`\\b${M(n)}\\b`));if(i>=0){let h=Math.max(0,i-80),a=Math.min(o.length,i+120);u("field context snippet:",JSON.stringify(o.slice(h,a)))}return{ok:!0,fieldAnywhere:!0,fieldInMutation:d,sdlLen:o.length}}let g=Math.floor(Math.random()*Math.min(500,r));await w(r+g)}return{ok:!1,fieldAnywhere:!1,fieldInMutation:l,sdlLen:c}}async function v(e){let t=e?.ResourceProperties??{},n=process.env.APPSYNC_API_ID??process.env.API_ID??t.apiId??t.ApiId,s=process.env.EXPECTED_FIELD??t.expectedField??t.ExpectedField,r=process.env.AWS_REGION??process.env.REGION??t.region??t.Region,c=y(process.env.SCHEMA_STATUS_MAX_ATTEMPTS??t.schemaStatusMaxAttempts,30),l=y(process.env.SCHEMA_STATUS_DELAY_MS??t.schemaStatusDelayMs,2e3),p=y(process.env.INTROSPECTION_MAX_ATTEMPTS??t.introspectionMaxAttempts,40),o=y(process.env.INTROSPECTION_DELAY_MS??t.introspectionDelayMs,2500),m=e.PhysicalResourceId??`AppSyncSchemaReady:${String(n??"unknown")}`;if(e.RequestType==="Delete")return u("Delete request -> skipping checks"),{PhysicalResourceId:m,Data:{skipped:!0}};let d=R(n,"apiId"),g=R(r,"region"),i=String(s??"").trim();u("starting",{requestType:e.RequestType,apiId:d,expectedField:i||"(none)",region:g,maxSchemaAttempts:c,schemaDelayMs:l,maxIntrospectionAttempts:p,introspectionDelayMs:o});let h=new S.AppSyncClient({region:g}),a=await q(h,d,c,l);if(i){let f=await U(h,d,i,p,o);if(!f.ok){let A=`Schema SUCCESS but expectedField "${i}" not found via introspection after retries. details=${a.details||"no details"} (sdlLen=${f.sdlLen}, fieldInMutation=${f.fieldInMutation})`;throw N(A),new Error(A)}return u("READY",{status:a.status,details:a.details,expectedField:i,fieldInMutation:f.fieldInMutation,sdlLen:f.sdlLen}),{PhysicalResourceId:m,Data:{ok:!0,apiId:d,expectedField:i,schemaStatus:a.status,schemaDetails:a.details,fieldInMutation:f.fieldInMutation,sdlLen:f.sdlLen}}}return u("READY (no expectedField check)",{status:a.status,details:a.details}),{PhysicalResourceId:m,Data:{ok:!0,apiId:d,schemaStatus:a.status,schemaDetails:a.details,expectedField:""}}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
