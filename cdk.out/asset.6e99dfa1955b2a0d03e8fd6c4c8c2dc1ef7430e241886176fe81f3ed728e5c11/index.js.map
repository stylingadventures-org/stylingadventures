{
  "version": 3,
  "sources": ["../../lambda/thumb-head/index.ts"],
  "sourcesContent": ["// lambda/thumb-head/index.js\r\n// lambda/thumb-head/index.ts\r\nimport type { APIGatewayProxyEventV2 } from \"aws-lambda\";\r\nimport { S3Client, HeadObjectCommand } from \"@aws-sdk/client-s3\";\r\n\r\nconst s3 = new S3Client({ region: process.env.AWS_REGION || \"us-east-1\" });\r\nconst BUCKET = process.env.BUCKET as string | undefined;\r\n\r\nconst ALLOWED_ORIGINS: string[] = String(process.env.ALLOWED_ORIGINS || \"\")\r\n  .split(\",\")\r\n  .map(s => s.trim())\r\n  .filter(Boolean);\r\n\r\nfunction pickAllowedOrigin(event: APIGatewayProxyEventV2): string | undefined {\r\n  const o = event.headers?.origin || event.headers?.Origin || \"\";\r\n  return ALLOWED_ORIGINS.includes(o ?? \"\") ? o : undefined;\r\n}\r\n\r\nfunction baseHeaders(origin?: string): Record<string, string> {\r\n  const h: Record<string, string> = {\r\n    \"Content-Type\": \"application/json\",\r\n    \"Access-Control-Allow-Headers\":\r\n      \"authorization,Authorization,Content-Type,X-Amz-Date,X-Api-Key,X-Amz-Security-Token\",\r\n    \"Access-Control-Allow-Methods\": \"GET,HEAD,POST,DELETE,OPTIONS\",\r\n    \"Access-Control-Allow-Credentials\": \"true\",\r\n    \"Cache-Control\": \"private, max-age=2\",\r\n    Vary: \"Origin\",\r\n  };\r\n  if (origin) h[\"Access-Control-Allow-Origin\"] = origin; // use bracket syntax for hyphenated key\r\n  return h;\r\n}\r\n\r\nfunction toThumbKey(srcKey: string): string {\r\n  const decoded = decodeURIComponent(srcKey);\r\n  if (decoded.startsWith(\"thumbs/\")) return decoded;\r\n  return `thumbs/${decoded.replace(/\\.[^.]+$/, \".jpg\")}`;\r\n}\r\n\r\nexport const handler = async (event: APIGatewayProxyEventV2) => {\r\n  const origin = pickAllowedOrigin(event);\r\n  const method =\r\n    event.requestContext?.http?.method || (event as any).httpMethod;\r\n\r\n  if (method === \"OPTIONS\") {\r\n    if ((event.headers?.origin || event.headers?.Origin) && !origin) {\r\n      return { statusCode: 403, headers: baseHeaders(undefined), body: \"\" };\r\n    }\r\n    return { statusCode: 204, headers: baseHeaders(origin), body: \"\" };\r\n  }\r\n\r\n  try {\r\n    if (!BUCKET) throw new Error(\"BUCKET env var is not set\");\r\n    const raw = event.queryStringParameters?.key;\r\n    if (!raw) {\r\n      return {\r\n        statusCode: 400,\r\n        headers: baseHeaders(origin),\r\n        body: JSON.stringify({ message: \"Missing key\" }),\r\n      };\r\n    }\r\n\r\n    const thumbKey = toThumbKey(raw);\r\n    await s3.send(new HeadObjectCommand({ Bucket: BUCKET, Key: thumbKey }));\r\n\r\n    if (method === \"HEAD\") {\r\n      return { statusCode: 204, headers: baseHeaders(origin), body: \"\" };\r\n    }\r\n    return {\r\n      statusCode: 200,\r\n      headers: baseHeaders(origin),\r\n      body: JSON.stringify({ ready: true }),\r\n    };\r\n  } catch {\r\n    if (method === \"HEAD\") {\r\n      return { statusCode: 404, headers: baseHeaders(origin), body: \"\" };\r\n    }\r\n    return {\r\n      statusCode: 200,\r\n      headers: baseHeaders(origin),\r\n      body: JSON.stringify({ ready: false }),\r\n    };\r\n  }\r\n};\r\n\r\n\r\n\r\n\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAGA,IAAAI,EAA4C,8BAEtCC,EAAK,IAAI,WAAS,CAAE,OAAQ,QAAQ,IAAI,YAAc,WAAY,CAAC,EACnEC,EAAS,QAAQ,IAAI,OAErBC,EAA4B,OAAO,QAAQ,IAAI,iBAAmB,EAAE,EACvE,MAAM,GAAG,EACT,IAAIC,GAAKA,EAAE,KAAK,CAAC,EACjB,OAAO,OAAO,EAEjB,SAASC,EAAkBC,EAAmD,CAC5E,IAAMC,EAAID,EAAM,SAAS,QAAUA,EAAM,SAAS,QAAU,GAC5D,OAAOH,EAAgB,SAASI,GAAK,EAAE,EAAIA,EAAI,MACjD,CAEA,SAASC,EAAYC,EAAyC,CAC5D,IAAMC,EAA4B,CAChC,eAAgB,mBAChB,+BACE,qFACF,+BAAgC,+BAChC,mCAAoC,OACpC,gBAAiB,qBACjB,KAAM,QACR,EACA,OAAID,IAAQC,EAAE,6BAA6B,EAAID,GACxCC,CACT,CAEA,SAASC,EAAWC,EAAwB,CAC1C,IAAMC,EAAU,mBAAmBD,CAAM,EACzC,OAAIC,EAAQ,WAAW,SAAS,EAAUA,EACnC,UAAUA,EAAQ,QAAQ,WAAY,MAAM,CAAC,EACtD,CAEO,IAAMf,EAAU,MAAOQ,GAAkC,CAC9D,IAAMG,EAASJ,EAAkBC,CAAK,EAChCQ,EACJR,EAAM,gBAAgB,MAAM,QAAWA,EAAc,WAEvD,GAAIQ,IAAW,UACb,OAAKR,EAAM,SAAS,QAAUA,EAAM,SAAS,SAAW,CAACG,EAChD,CAAE,WAAY,IAAK,QAASD,EAAY,MAAS,EAAG,KAAM,EAAG,EAE/D,CAAE,WAAY,IAAK,QAASA,EAAYC,CAAM,EAAG,KAAM,EAAG,EAGnE,GAAI,CACF,GAAI,CAACP,EAAQ,MAAM,IAAI,MAAM,2BAA2B,EACxD,IAAMa,EAAMT,EAAM,uBAAuB,IACzC,GAAI,CAACS,EACH,MAAO,CACL,WAAY,IACZ,QAASP,EAAYC,CAAM,EAC3B,KAAM,KAAK,UAAU,CAAE,QAAS,aAAc,CAAC,CACjD,EAGF,IAAMO,EAAWL,EAAWI,CAAG,EAG/B,OAFA,MAAMd,EAAG,KAAK,IAAI,oBAAkB,CAAE,OAAQC,EAAQ,IAAKc,CAAS,CAAC,CAAC,EAElEF,IAAW,OACN,CAAE,WAAY,IAAK,QAASN,EAAYC,CAAM,EAAG,KAAM,EAAG,EAE5D,CACL,WAAY,IACZ,QAASD,EAAYC,CAAM,EAC3B,KAAM,KAAK,UAAU,CAAE,MAAO,EAAK,CAAC,CACtC,CACF,MAAQ,CACN,OAAIK,IAAW,OACN,CAAE,WAAY,IAAK,QAASN,EAAYC,CAAM,EAAG,KAAM,EAAG,EAE5D,CACL,WAAY,IACZ,QAASD,EAAYC,CAAM,EAC3B,KAAM,KAAK,UAAU,CAAE,MAAO,EAAM,CAAC,CACvC,CACF,CACF",
  "names": ["thumb_head_exports", "__export", "handler", "__toCommonJS", "import_client_s3", "s3", "BUCKET", "ALLOWED_ORIGINS", "s", "pickAllowedOrigin", "event", "o", "baseHeaders", "origin", "h", "toThumbKey", "srcKey", "decoded", "method", "raw", "thumbKey"]
}
