{
  "version": 3,
  "sources": ["../../lambda/commerce/index.ts"],
  "sourcesContent": ["import {\r\n  DynamoDBClient,\r\n  PutItemCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport { marshall } from \"@aws-sdk/util-dynamodb\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\nconst APP_TABLE_NAME = process.env.APP_TABLE_NAME!;\r\nconst ORDERS_TABLE_NAME = process.env.ORDERS_TABLE_NAME!;\r\n\r\ntype UserTier = \"FREE\" | \"BESTIE\" | \"CREATOR\" | \"COLLAB\" | \"ADMIN\" | \"PRIME\";\r\n\r\nfunction getUserTier(identity: any): UserTier {\r\n  const claims = identity?.claims || {};\r\n  const tierClaim =\r\n    (claims[\"custom:tier\"] as string | undefined) ||\r\n    (claims[\"tier\"] as string | undefined);\r\n\r\n  const rawGroups = claims[\"cognito:groups\"];\r\n  const groups = Array.isArray(rawGroups)\r\n    ? rawGroups\r\n    : String(rawGroups || \"\")\r\n        .split(\",\")\r\n        .map((g) => g.trim())\r\n        .filter(Boolean);\r\n\r\n  if (groups.includes(\"ADMIN\")) return \"ADMIN\";\r\n  if (groups.includes(\"COLLAB\")) return \"COLLAB\";\r\n  if (groups.includes(\"PRIME\")) return \"PRIME\";\r\n  if (groups.includes(\"CREATOR\")) return \"CREATOR\";\r\n  if (groups.includes(\"BESTIE\")) return \"BESTIE\";\r\n\r\n  if (\r\n    tierClaim &&\r\n    [\"FREE\", \"BESTIE\", \"CREATOR\", \"COLLAB\", \"ADMIN\", \"PRIME\"].includes(\r\n      tierClaim,\r\n    )\r\n  ) {\r\n    return tierClaim as UserTier;\r\n  }\r\n\r\n  return \"FREE\";\r\n}\r\n\r\nfunction requireCreator(identity: any): UserTier {\r\n  const tier = getUserTier(identity);\r\n  if (![\"CREATOR\", \"COLLAB\", \"ADMIN\", \"PRIME\"].includes(tier)) {\r\n    throw new Error(\"Creator tier required\");\r\n  }\r\n  return tier;\r\n}\r\n\r\nfunction requireSub(identity: any): string {\r\n  if (!identity?.sub) throw new Error(\"Not authenticated\");\r\n  return String(identity.sub);\r\n}\r\n\r\nexport const handler = async (event: any) => {\r\n  console.log(\"CommerceFn event\", JSON.stringify(event));\r\n\r\n  const fieldName = event.info?.fieldName as string | undefined;\r\n  const identity = event.identity;\r\n\r\n  // Only creators and above can see monetisation dashboards\r\n  const tier = requireCreator(identity);\r\n  const sub = requireSub(identity);\r\n\r\n  switch (fieldName) {\r\n    case \"creatorRevenueSummary\": {\r\n      // Stub: later read from ORDERS_TABLE_NAME\r\n      return {\r\n        creatorId: sub,\r\n        tier,\r\n        last30dRevenue: 0,\r\n        totalRevenue: 0,\r\n        affiliateClicks: 0,\r\n      };\r\n    }\r\n\r\n    case \"recordAffiliateClick\": {\r\n      const { itemId, source } = event.arguments || {};\r\n      const now = new Date().toISOString();\r\n      await ddb.send(\r\n        new PutItemCommand({\r\n          TableName: ORDERS_TABLE_NAME,\r\n          Item: marshall(\r\n            {\r\n              pk: `CREATOR#${sub}`,\r\n              sk: `CLICK#${now}`,\r\n              type: \"AFFILIATE_CLICK\",\r\n              itemId,\r\n              source: source || \"unknown\",\r\n              createdAt: now,\r\n            },\r\n            { removeUndefinedValues: true },\r\n          ),\r\n        }),\r\n      );\r\n      return { ok: true };\r\n    }\r\n\r\n    default:\r\n      throw new Error(`Unsupported field in CommerceFn: ${fieldName}`);\r\n  }\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GAAA,IAAAI,EAGO,oCACPC,EAAyB,kCAEnBC,EAAM,IAAI,iBAAe,CAAC,CAAC,EAC3BC,EAAiB,QAAQ,IAAI,eAC7BC,EAAoB,QAAQ,IAAI,kBAItC,SAASC,EAAYC,EAAyB,CAC5C,IAAMC,EAASD,GAAU,QAAU,CAAC,EAC9BE,EACHD,EAAO,aAAa,GACpBA,EAAO,KAEJE,EAAYF,EAAO,gBAAgB,EACnCG,EAAS,MAAM,QAAQD,CAAS,EAClCA,EACA,OAAOA,GAAa,EAAE,EACnB,MAAM,GAAG,EACT,IAAKE,GAAMA,EAAE,KAAK,CAAC,EACnB,OAAO,OAAO,EAErB,OAAID,EAAO,SAAS,OAAO,EAAU,QACjCA,EAAO,SAAS,QAAQ,EAAU,SAClCA,EAAO,SAAS,OAAO,EAAU,QACjCA,EAAO,SAAS,SAAS,EAAU,UACnCA,EAAO,SAAS,QAAQ,EAAU,SAGpCF,GACA,CAAC,OAAQ,SAAU,UAAW,SAAU,QAAS,OAAO,EAAE,SACxDA,CACF,EAEOA,EAGF,MACT,CAEA,SAASI,EAAeN,EAAyB,CAC/C,IAAMO,EAAOR,EAAYC,CAAQ,EACjC,GAAI,CAAC,CAAC,UAAW,SAAU,QAAS,OAAO,EAAE,SAASO,CAAI,EACxD,MAAM,IAAI,MAAM,uBAAuB,EAEzC,OAAOA,CACT,CAEA,SAASC,EAAWR,EAAuB,CACzC,GAAI,CAACA,GAAU,IAAK,MAAM,IAAI,MAAM,mBAAmB,EACvD,OAAO,OAAOA,EAAS,GAAG,CAC5B,CAEO,IAAMR,EAAU,MAAOiB,GAAe,CAC3C,QAAQ,IAAI,mBAAoB,KAAK,UAAUA,CAAK,CAAC,EAErD,IAAMC,EAAYD,EAAM,MAAM,UACxBT,EAAWS,EAAM,SAGjBF,EAAOD,EAAeN,CAAQ,EAC9BW,EAAMH,EAAWR,CAAQ,EAE/B,OAAQU,EAAW,CACjB,IAAK,wBAEH,MAAO,CACL,UAAWC,EACX,KAAAJ,EACA,eAAgB,EAChB,aAAc,EACd,gBAAiB,CACnB,EAGF,IAAK,uBAAwB,CAC3B,GAAM,CAAE,OAAAK,EAAQ,OAAAC,CAAO,EAAIJ,EAAM,WAAa,CAAC,EACzCK,EAAM,IAAI,KAAK,EAAE,YAAY,EACnC,aAAMlB,EAAI,KACR,IAAI,iBAAe,CACjB,UAAWE,EACX,QAAM,YACJ,CACE,GAAI,WAAWa,CAAG,GAClB,GAAI,SAASG,CAAG,GAChB,KAAM,kBACN,OAAAF,EACA,OAAQC,GAAU,UAClB,UAAWC,CACb,EACA,CAAE,sBAAuB,EAAK,CAChC,CACF,CAAC,CACH,EACO,CAAE,GAAI,EAAK,CACpB,CAEA,QACE,MAAM,IAAI,MAAM,oCAAoCJ,CAAS,EAAE,CACnE,CACF",
  "names": ["index_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_util_dynamodb", "ddb", "APP_TABLE_NAME", "ORDERS_TABLE_NAME", "getUserTier", "identity", "claims", "tierClaim", "rawGroups", "groups", "g", "requireCreator", "tier", "requireSub", "event", "fieldName", "sub", "itemId", "source", "now"]
}
