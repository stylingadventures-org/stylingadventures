{
  "version": 3,
  "sources": ["../../lambda/game/polls.ts"],
  "sourcesContent": ["// lambda/game/polls.ts\r\nimport {\r\n  DynamoDBClient\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport {\r\n  DynamoDBDocumentClient,\r\n  PutCommand,\r\n  GetCommand,\r\n  UpdateCommand,\r\n  QueryCommand\r\n} from \"@aws-sdk/lib-dynamodb\";\r\nimport { AppSyncIdentityCognito } from \"aws-lambda\";\r\n\r\nconst TABLE = process.env.TABLE_NAME!;\r\nconst ddb = DynamoDBDocumentClient.from(new DynamoDBClient({}), {\r\n  marshallOptions: { removeUndefinedValues: true },\r\n});\r\n\r\nexport const handler = async (event: any) => {\r\n  const id = event.identity as AppSyncIdentityCognito | undefined;\r\n  const fn = event.info?.fieldName as string;\r\n\r\n  if (fn === \"createPoll\") {\r\n    if (!id?.sub) throw new Error(\"Unauthorized\");\r\n    const { question, options } = event.arguments.input as { question: string; options: string[] };\r\n    const pollId = String(Date.now());\r\n    const createdAt = new Date().toISOString();\r\n\r\n    // Store options/totals as native arrays; add a simple listing index on gsi2\r\n    await ddb.send(new PutCommand({\r\n      TableName: TABLE,\r\n      Item: {\r\n        pk: `POLL#${pollId}`,\r\n        sk: \"META\",\r\n        gsi2pk: \"POLL\",\r\n        gsi2sk: `CREATED#${pollId}`,\r\n        question,\r\n        options,\r\n        totals: new Array(options.length).fill(0),\r\n        createdBy: id.username || id.sub,\r\n        createdAt,\r\n      },\r\n      ConditionExpression: \"attribute_not_exists(pk)\",\r\n    }));\r\n\r\n    return { pollId, question, options, totals: new Array(options.length).fill(0), createdBy: id.username || id.sub, createdAt };\r\n  }\r\n\r\n  if (fn === \"votePoll\") {\r\n    if (!id?.sub) throw new Error(\"Unauthorized\");\r\n    const { pollId, optionIndex } = event.arguments as { pollId: string; optionIndex: number };\r\n\r\n    // Idempotent vote per user+option\r\n    await ddb.send(new PutCommand({\r\n      TableName: TABLE,\r\n      Item: {\r\n        pk: `POLL#${pollId}`,\r\n        sk: `VOTE#${optionIndex}#${id.sub}`,\r\n        gsi2pk: `POLL#${pollId}`,\r\n        gsi2sk: `VOTE#${optionIndex}#${id.sub}`,\r\n        userId: id.sub,\r\n        at: new Date().toISOString(),\r\n      },\r\n      ConditionExpression: \"attribute_not_exists(pk)\",\r\n    })).catch((err) => {\r\n      if (!String(err).includes(\"ConditionalCheckFailed\")) throw err;\r\n    });\r\n\r\n    // Read META (options length)\r\n    const meta = await ddb.send(new GetCommand({\r\n      TableName: TABLE,\r\n      Key: { pk: `POLL#${pollId}`, sk: \"META\" },\r\n    }));\r\n    const opts: string[] = (meta.Item?.options ?? []) as string[];\r\n\r\n    // Tally each option by querying the votes prefix on gsi2 (lowercase!)\r\n    const totals: number[] = [];\r\n    for (let i = 0; i < opts.length; i++) {\r\n      const q = await ddb.send(new QueryCommand({\r\n        TableName: TABLE,\r\n        IndexName: \"gsi2\", // \u2705 correct lowercase\r\n        KeyConditionExpression: \"#pk = :p AND begins_with(#sk, :pref)\",\r\n        ExpressionAttributeNames: { \"#pk\": \"gsi2pk\", \"#sk\": \"gsi2sk\" },\r\n        ExpressionAttributeValues: { \":p\": `POLL#${pollId}`, \":pref\": `VOTE#${i}#` },\r\n        Select: \"COUNT\",\r\n      }));\r\n      totals.push(q.Count ?? 0);\r\n    }\r\n\r\n    // Persist updated totals on META\r\n    const upd = await ddb.send(new UpdateCommand({\r\n      TableName: TABLE,\r\n      Key: { pk: `POLL#${pollId}`, sk: \"META\" },\r\n      UpdateExpression: \"SET totals = :t\",\r\n      ExpressionAttributeValues: { \":t\": totals },\r\n      ReturnValues: \"ALL_NEW\",\r\n    }));\r\n\r\n    return {\r\n      pollId,\r\n      question: upd.Attributes?.question,\r\n      options: upd.Attributes?.options,\r\n      totals: upd.Attributes?.totals,\r\n      createdBy: upd.Attributes?.createdBy,\r\n      createdAt: upd.Attributes?.createdAt,\r\n    };\r\n  }\r\n\r\n  if (fn === \"getPoll\") {\r\n    const { pollId } = event.arguments as { pollId: string };\r\n    const r = await ddb.send(new GetCommand({\r\n      TableName: TABLE,\r\n      Key: { pk: `POLL#${pollId}`, sk: \"META\" },\r\n    }));\r\n    if (!r.Item) return null;\r\n    return {\r\n      pollId,\r\n      question: r.Item.question,\r\n      options: r.Item.options ?? [],\r\n      totals: r.Item.totals ?? [],\r\n      createdBy: r.Item.createdBy,\r\n      createdAt: r.Item.createdAt,\r\n    };\r\n  }\r\n\r\n  throw new Error(\"Unknown field\");\r\n};\r\n"],
  "mappings": "yaAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,IAAA,eAAAC,EAAAH,GACA,IAAAI,EAEO,oCACPC,EAMO,iCAGDC,EAAQ,QAAQ,IAAI,WACpBC,EAAM,yBAAuB,KAAK,IAAI,iBAAe,CAAC,CAAC,EAAG,CAC9D,gBAAiB,CAAE,sBAAuB,EAAK,CACjD,CAAC,EAEYL,EAAU,MAAOM,GAAe,CAC3C,IAAMC,EAAKD,EAAM,SACXE,EAAKF,EAAM,MAAM,UAEvB,GAAIE,IAAO,aAAc,CACvB,GAAI,CAACD,GAAI,IAAK,MAAM,IAAI,MAAM,cAAc,EAC5C,GAAM,CAAE,SAAAE,EAAU,QAAAC,CAAQ,EAAIJ,EAAM,UAAU,MACxCK,EAAS,OAAO,KAAK,IAAI,CAAC,EAC1BC,EAAY,IAAI,KAAK,EAAE,YAAY,EAGzC,aAAMP,EAAI,KAAK,IAAI,aAAW,CAC5B,UAAWD,EACX,KAAM,CACJ,GAAI,QAAQO,CAAM,GAClB,GAAI,OACJ,OAAQ,OACR,OAAQ,WAAWA,CAAM,GACzB,SAAAF,EACA,QAAAC,EACA,OAAQ,IAAI,MAAMA,EAAQ,MAAM,EAAE,KAAK,CAAC,EACxC,UAAWH,EAAG,UAAYA,EAAG,IAC7B,UAAAK,CACF,EACA,oBAAqB,0BACvB,CAAC,CAAC,EAEK,CAAE,OAAAD,EAAQ,SAAAF,EAAU,QAAAC,EAAS,OAAQ,IAAI,MAAMA,EAAQ,MAAM,EAAE,KAAK,CAAC,EAAG,UAAWH,EAAG,UAAYA,EAAG,IAAK,UAAAK,CAAU,CAC7H,CAEA,GAAIJ,IAAO,WAAY,CACrB,GAAI,CAACD,GAAI,IAAK,MAAM,IAAI,MAAM,cAAc,EAC5C,GAAM,CAAE,OAAAI,EAAQ,YAAAE,CAAY,EAAIP,EAAM,UAGtC,MAAMD,EAAI,KAAK,IAAI,aAAW,CAC5B,UAAWD,EACX,KAAM,CACJ,GAAI,QAAQO,CAAM,GAClB,GAAI,QAAQE,CAAW,IAAIN,EAAG,GAAG,GACjC,OAAQ,QAAQI,CAAM,GACtB,OAAQ,QAAQE,CAAW,IAAIN,EAAG,GAAG,GACrC,OAAQA,EAAG,IACX,GAAI,IAAI,KAAK,EAAE,YAAY,CAC7B,EACA,oBAAqB,0BACvB,CAAC,CAAC,EAAE,MAAOO,GAAQ,CACjB,GAAI,CAAC,OAAOA,CAAG,EAAE,SAAS,wBAAwB,EAAG,MAAMA,CAC7D,CAAC,EAOD,IAAMC,GAJO,MAAMV,EAAI,KAAK,IAAI,aAAW,CACzC,UAAWD,EACX,IAAK,CAAE,GAAI,QAAQO,CAAM,GAAI,GAAI,MAAO,CAC1C,CAAC,CAAC,GAC2B,MAAM,SAAW,CAAC,EAGzCK,EAAmB,CAAC,EAC1B,QAASC,EAAI,EAAGA,EAAIF,EAAK,OAAQE,IAAK,CACpC,IAAMC,EAAI,MAAMb,EAAI,KAAK,IAAI,eAAa,CACxC,UAAWD,EACX,UAAW,OACX,uBAAwB,uCACxB,yBAA0B,CAAE,MAAO,SAAU,MAAO,QAAS,EAC7D,0BAA2B,CAAE,KAAM,QAAQO,CAAM,GAAI,QAAS,QAAQM,CAAC,GAAI,EAC3E,OAAQ,OACV,CAAC,CAAC,EACFD,EAAO,KAAKE,EAAE,OAAS,CAAC,CAC1B,CAGA,IAAMC,EAAM,MAAMd,EAAI,KAAK,IAAI,gBAAc,CAC3C,UAAWD,EACX,IAAK,CAAE,GAAI,QAAQO,CAAM,GAAI,GAAI,MAAO,EACxC,iBAAkB,kBAClB,0BAA2B,CAAE,KAAMK,CAAO,EAC1C,aAAc,SAChB,CAAC,CAAC,EAEF,MAAO,CACL,OAAAL,EACA,SAAUQ,EAAI,YAAY,SAC1B,QAASA,EAAI,YAAY,QACzB,OAAQA,EAAI,YAAY,OACxB,UAAWA,EAAI,YAAY,UAC3B,UAAWA,EAAI,YAAY,SAC7B,CACF,CAEA,GAAIX,IAAO,UAAW,CACpB,GAAM,CAAE,OAAAG,CAAO,EAAIL,EAAM,UACnBc,EAAI,MAAMf,EAAI,KAAK,IAAI,aAAW,CACtC,UAAWD,EACX,IAAK,CAAE,GAAI,QAAQO,CAAM,GAAI,GAAI,MAAO,CAC1C,CAAC,CAAC,EACF,OAAKS,EAAE,KACA,CACL,OAAAT,EACA,SAAUS,EAAE,KAAK,SACjB,QAASA,EAAE,KAAK,SAAW,CAAC,EAC5B,OAAQA,EAAE,KAAK,QAAU,CAAC,EAC1B,UAAWA,EAAE,KAAK,UAClB,UAAWA,EAAE,KAAK,SACpB,EARoB,IAStB,CAEA,MAAM,IAAI,MAAM,eAAe,CACjC",
  "names": ["polls_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_lib_dynamodb", "TABLE", "ddb", "event", "id", "fn", "question", "options", "pollId", "createdAt", "optionIndex", "err", "opts", "totals", "i", "q", "upd", "r"]
}
