"use strict";var m=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var k=Object.prototype.hasOwnProperty;var E=(s,e)=>{for(var i in e)m(s,i,{get:e[i],enumerable:!0})},f=(s,e,i,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of A(e))!k.call(s,t)&&t!==i&&m(s,t,{get:()=>e[t],enumerable:!(n=w(e,t))||n.enumerable});return s};var y=s=>f(m({},"__esModule",{value:!0}),s);var L={};E(L,{handler:()=>I});module.exports=y(L);var g=require("@aws-sdk/client-dynamodb"),o=require("@aws-sdk/lib-dynamodb"),a=process.env.TABLE_NAME,l=o.DynamoDBDocumentClient.from(new g.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}}),I=async s=>{let e=s.identity,i=s.info?.fieldName;if(i==="createPoll"){if(!e?.sub)throw new Error("Unauthorized");let{question:n,options:t}=s.arguments.input,p=String(Date.now()),u=new Date().toISOString();return await l.send(new o.PutCommand({TableName:a,Item:{pk:`POLL#${p}`,sk:"META",gsi2pk:"POLL",gsi2sk:`CREATED#${p}`,question:n,options:t,totals:new Array(t.length).fill(0),createdBy:e.username||e.sub,createdAt:u},ConditionExpression:"attribute_not_exists(pk)"})),{pollId:p,question:n,options:t,totals:new Array(t.length).fill(0),createdBy:e.username||e.sub,createdAt:u}}if(i==="votePoll"){if(!e?.sub)throw new Error("Unauthorized");let{pollId:n,optionIndex:t}=s.arguments;await l.send(new o.PutCommand({TableName:a,Item:{pk:`POLL#${n}`,sk:`VOTE#${t}#${e.sub}`,gsi2pk:`POLL#${n}`,gsi2sk:`VOTE#${t}#${e.sub}`,userId:e.sub,at:new Date().toISOString()},ConditionExpression:"attribute_not_exists(pk)"})).catch(r=>{if(!String(r).includes("ConditionalCheckFailed"))throw r});let u=(await l.send(new o.GetCommand({TableName:a,Key:{pk:`POLL#${n}`,sk:"META"}}))).Item?.options??[],c=[];for(let r=0;r<u.length;r++){let b=await l.send(new o.QueryCommand({TableName:a,IndexName:"gsi2",KeyConditionExpression:"#pk = :p AND begins_with(#sk, :pref)",ExpressionAttributeNames:{"#pk":"gsi2pk","#sk":"gsi2sk"},ExpressionAttributeValues:{":p":`POLL#${n}`,":pref":`VOTE#${r}#`},Select:"COUNT"}));c.push(b.Count??0)}let d=await l.send(new o.UpdateCommand({TableName:a,Key:{pk:`POLL#${n}`,sk:"META"},UpdateExpression:"SET totals = :t",ExpressionAttributeValues:{":t":c},ReturnValues:"ALL_NEW"}));return{pollId:n,question:d.Attributes?.question,options:d.Attributes?.options,totals:d.Attributes?.totals,createdBy:d.Attributes?.createdBy,createdAt:d.Attributes?.createdAt}}if(i==="getPoll"){let{pollId:n}=s.arguments,t=await l.send(new o.GetCommand({TableName:a,Key:{pk:`POLL#${n}`,sk:"META"}}));return t.Item?{pollId:n,question:t.Item.question,options:t.Item.options??[],totals:t.Item.totals??[],createdBy:t.Item.createdBy,createdAt:t.Item.createdAt}:null}throw new Error("Unknown field")};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
