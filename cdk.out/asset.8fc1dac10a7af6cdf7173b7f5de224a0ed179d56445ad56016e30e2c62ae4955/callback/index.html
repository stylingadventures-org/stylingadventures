<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Signed in â€¢ Styling Adventures</title>
  <link rel="stylesheet" href="/styles.css" />
  <script src="/app.js" defer></script>
  <script>
  (async () => {
    const params = new URLSearchParams(location.search);
    const code = params.get('code');
    // Load config
    const cfg = await (await fetch('/config.json', { cache: 'no-store' })).json();
    const verifier = sessionStorage.getItem('pkce_verifier');
    const body = new URLSearchParams({
      grant_type: 'authorization_code',
      client_id: cfg.clientId,
      code,
      redirect_uri: cfg.redirectUri,
      code_verifier: verifier
    });
    try {
      const res = await fetch(`https://${cfg.domain}.auth.${cfg.region}.amazoncognito.com/oauth2/token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
      if (!res.ok) throw new Error('Token exchange failed');
      const t = await res.json();
      sessionStorage.setItem('id_token', t.id_token || '');
      sessionStorage.setItem('access_token', t.access_token || '');
      if (t.refresh_token) sessionStorage.setItem('refresh_token', t.refresh_token);
      // show code for CLI convenience
      document.getElementById('code').textContent = code;
      document.getElementById('ok').style.display = 'block';
      // bounce to app in a moment
      setTimeout(() => location.href = '/', 1200);
    } catch (e) {
      document.getElementById('err').textContent = String(e);
    }
  })();
  </script>
</head>
<body class="p-8">
  <div class="card">
    <h1 class="card-title">Signed in successfully ðŸŽ‰</h1>
    <p>You can close this tab/window. Returning to the appâ€¦</p>
    <div id="ok" style="display:none" class="mt-2 text-sm">
      Detected code: <code id="code"></code>
    </div>
    <p id="err" class="text-red-500 text-sm mt-2"></p>
  </div>
</body>
</html>
