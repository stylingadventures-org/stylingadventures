"use strict";var A=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var x=(t,e)=>{for(var r in e)A(t,r,{get:e[r],enumerable:!0})},P=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of C(e))!N.call(t,o)&&o!==r&&A(t,o,{get:()=>e[o],enumerable:!(s=b(e,o))||s.enumerable});return t};var D=t=>P(A({},"__esModule",{value:!0}),t);var L={};x(L,{adminApproveItem:()=>I,adminListPending:()=>T,adminRejectItem:()=>k,adminSetClosetAudience:()=>f,closetFeed:()=>S,handler:()=>R,topClosetLooks:()=>w});module.exports=D(L);var i=require("@aws-sdk/client-dynamodb"),u=require("@aws-sdk/client-sfn"),c=new i.DynamoDBClient({}),g=new u.SFNClient({}),{TABLE_NAME:p="",APPROVAL_SM_ARN:V=""}=process.env;if(!p)throw new Error("Missing env: TABLE_NAME");var y=()=>new Date().toISOString(),n=t=>({S:t});function m(t){let e=t.identity?.claims||{},r=t.identity?.sub||e.sub,s=e["cognito:groups"],o=Array.isArray(s)?s:String(s||"").split(",").map(a=>a.trim()).filter(Boolean),d=o.includes("ADMIN")||o.includes("COLLAB");if(!r)throw new Error("Unauthorized");return{sub:r,isAdmin:d}}function E(t){return{id:t.id.S,userId:t.ownerSub.S,ownerSub:t.ownerSub.S,status:t.status.S,createdAt:t.createdAt.S,updatedAt:t.updatedAt.S,mediaKey:t.mediaKey?.S??"",title:t.title?.S??"",reason:t.reason?.S??""}}var T=async t=>{let{isAdmin:e}=m(t);if(!e)throw new Error("Forbidden");return((await c.send(new i.QueryCommand({TableName:p,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n("STATUS#PENDING")},ScanIndexForward:!0,ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, title, reason",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(s=>E({...s,status:s.status}))},S=async t=>{m(t);let{sort:e="NEWEST"}=t.arguments||{},s=((await c.send(new i.QueryCommand({TableName:p,IndexName:"gsi2",KeyConditionExpression:"gsi2pk = :p",ExpressionAttributeValues:{":p":n("STATUS#PUBLISHED")},ScanIndexForward:e==="NEWEST",ProjectionExpression:"id, ownerSub, #s, createdAt, updatedAt, mediaKey, title",ExpressionAttributeNames:{"#s":"status"}}))).Items||[]).map(o=>E({...o,status:o.status}));return s},w=async t=>S({...t,arguments:{sort:"NEWEST"}}),I=async t=>{let{isAdmin:e}=m(t);if(!e)throw new Error("Forbidden");let r=t.arguments?.id;if(!r)throw new Error("id required");let s=y(),d=(await c.send(new i.UpdateItemCommand({TableName:p,Key:{pk:n(`ITEM#${r}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk REMOVE reason, approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("APPROVED"),":u":n(s),":g2pk":n("STATUS#APPROVED"),":g2sk":n(s)},ReturnValues:"ALL_OLD"}))).Attributes,a=d.approvalToken?.S;if(a)try{await g.send(new u.SendTaskSuccessCommand({taskToken:a,output:JSON.stringify({approved:!0})}))}catch{}return E({...d,status:n("APPROVED")})},k=async t=>{let{isAdmin:e}=m(t);if(!e)throw new Error("Forbidden");let r=t.arguments?.id,s=t.arguments?.reason||"";if(!r)throw new Error("id required");let o=y(),a=(await c.send(new i.UpdateItemCommand({TableName:p,Key:{pk:n(`ITEM#${r}`),sk:n("META")},UpdateExpression:"SET #s = :s, updatedAt = :u, gsi2pk = :g2pk, gsi2sk = :g2sk, reason = :r REMOVE approvalToken",ExpressionAttributeNames:{"#s":"status"},ExpressionAttributeValues:{":s":n("REJECTED"),":u":n(o),":g2pk":n("STATUS#REJECTED"),":g2sk":n(o),":r":n(s)},ReturnValues:"ALL_OLD"}))).Attributes,l=a.approvalToken?.S;if(l)try{await g.send(new u.SendTaskFailureCommand({taskToken:l,error:"Rejected",cause:s||"Rejected by admin"}))}catch{}return E({...a,status:n("REJECTED"),reason:n(s)})},f=async t=>"NOT_IMPLEMENTED",R=async t=>{let e=t.info.fieldName;if(e==="adminListPending")return T(t);if(e==="adminApproveItem")return I(t);if(e==="adminRejectItem")return k(t);if(e==="adminSetClosetAudience")return f(t);if(e==="closetFeed")return S(t);if(e==="topClosetLooks")return w(t);throw new Error(`No resolver for field ${e}`)};0&&(module.exports={adminApproveItem,adminListPending,adminRejectItem,adminSetClosetAudience,closetFeed,handler,topClosetLooks});
//# sourceMappingURL=index.js.map
