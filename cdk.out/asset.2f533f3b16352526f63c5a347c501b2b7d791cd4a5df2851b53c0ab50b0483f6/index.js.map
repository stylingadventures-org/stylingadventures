{
  "version": 3,
  "sources": ["../../lambda/presign/index.ts"],
  "sourcesContent": ["import { APIGatewayProxyResult } from 'aws-lambda';\r\nimport {\r\n  S3Client,\r\n  PutObjectCommand,\r\n  DeleteObjectCommand,\r\n} from '@aws-sdk/client-s3';\r\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\r\n\r\n// Path-style so host stays s3.us-east-1.amazonaws.com and avoids per-bucket DNS lookups.\r\nconst s3 = new S3Client({\r\n  region: process.env.AWS_REGION || 'us-east-1',\r\n  forcePathStyle: true,\r\n});\r\n\r\n// --- keep your imports & S3 client ---\r\n\r\nconst BUCKET = process.env.BUCKET!;\r\nconst THUMBS_CDN = process.env.THUMBS_CDN;\r\n\r\n// NEW: comma-separated allow-list. Examples:\r\n// \"https://d1682i07dc1r3k.cloudfront.net,https://stylingadventures.com\"\r\nconst ALLOWED_ORIGINS = String(process.env.ALLOWED_ORIGINS || '')\r\n  .split(',')\r\n  .map(s => s.trim())\r\n  .filter(Boolean);\r\n\r\n// Back-compat fallback if you still set one origin\r\nconst WEB_ORIGIN = process.env.WEB_ORIGIN || process.env.ORIGIN || '';\r\n\r\ntype AnyEvent = any;\r\n\r\nfunction pickAllowedOrigin(event: AnyEvent): string | undefined {\r\n  const reqOrigin =\r\n    event.headers?.origin || event.headers?.Origin || event.headers?.['x-origin'] || '';\r\n\r\n  if (ALLOWED_ORIGINS.length > 0) {\r\n    return ALLOWED_ORIGINS.includes(reqOrigin) ? reqOrigin : undefined;\r\n  }\r\n  return WEB_ORIGIN || undefined;\r\n}\r\n\r\nfunction baseCorsHeaders(origin?: string) {\r\n  const h: Record<string,string> = {\r\n    'Content-Type': 'application/json',\r\n    'Access-Control-Allow-Headers':\r\n      'Authorization,Content-Type,X-Amz-Date,X-Api-Key,X-Amz-Security-Token',\r\n    'Access-Control-Allow-Methods': 'GET,POST,DELETE,OPTIONS',\r\n    'Access-Control-Allow-Credentials': 'true',\r\n    Vary: 'Origin',\r\n  };\r\n  if (origin) h['Access-Control-Allow-Origin'] = origin;\r\n  return h;\r\n}\r\n\r\nfunction ok(event: AnyEvent, body: unknown, extra: Record<string,string> = {}): APIGatewayProxyResult {\r\n  const origin = pickAllowedOrigin(event);\r\n  return { statusCode: 200, headers: { ...baseCorsHeaders(origin), ...extra }, body: JSON.stringify(body) };\r\n}\r\nfunction bad(event: AnyEvent, status: number, msg: string): APIGatewayProxyResult {\r\n  const origin = pickAllowedOrigin(event);\r\n  const hasReqOrigin = !!(event.headers?.origin || event.headers?.Origin);\r\n  if (hasReqOrigin && !origin) {\r\n    // CORS request from a non-allowed origin\r\n    return { statusCode: 403, headers: baseCorsHeaders(undefined), body: JSON.stringify({ message: 'CORS: origin not allowed' }) };\r\n  }\r\n  return { statusCode: status, headers: baseCorsHeaders(origin), body: JSON.stringify({ message: msg }) };\r\n}\r\n\r\nfunction getMethod(e: AnyEvent): string {\r\n  return e.httpMethod ?? e.requestContext?.http?.method ?? 'GET';\r\n}\r\nfunction getPath(e: AnyEvent): string {\r\n  return e.resource ?? e.rawPath ?? e.path ?? '/';\r\n}\r\nfunction getClaims(e: AnyEvent): Record<string, any> {\r\n  return e.requestContext?.authorizer?.claims ?? e.requestContext?.authorizer?.jwt?.claims ?? {};\r\n}\r\nfunction parseBody(e: AnyEvent): any {\r\n  if (!e.body) return undefined;\r\n  const raw = e.isBase64Encoded ? Buffer.from(e.body, 'base64').toString() : e.body;\r\n  try { return JSON.parse(raw); } catch { return undefined; }\r\n}\r\n\r\nexport const handler = async (event: AnyEvent): Promise<APIGatewayProxyResult> => {\r\n  try {\r\n    const method = getMethod(event);\r\n    const path = getPath(event);\r\n    const claims = getClaims(event);\r\n    const userSub = claims?.sub as string | undefined;\r\n\r\n    // CORS preflight\r\n    if (method === 'OPTIONS') {\r\n      const origin = pickAllowedOrigin(event);\r\n      if (!origin && (event.headers?.origin || event.headers?.Origin)) {\r\n        return { statusCode: 403, headers: baseCorsHeaders(undefined), body: '' };\r\n      }\r\n      return { statusCode: 204, headers: baseCorsHeaders(origin), body: '' };\r\n    }\r\n\r\n    // --- POST /presign ---\r\n    if (method === 'POST' && /\\/presign$/.test(path)) {\r\n      const body = parseBody(event);\r\n      if (!body) return bad(event, 400, 'Missing body');\r\n\r\n      let { key, contentType } = body as { key?: string; contentType?: string };\r\n      if (!key || typeof key !== 'string') return bad(event, 400, 'Invalid \"key\"');\r\n      if (!contentType || typeof contentType !== 'string') return bad(event, 400, 'Invalid \"contentType\"');\r\n      if (key.includes('..')) return bad(event, 400, 'Illegal key');\r\n\r\n      // Keep uploads in the caller\u2019s folder unless client already specified full path\r\n      if (userSub && !key.startsWith('users/')) key = `users/${userSub}/${key}`;\r\n\r\n      const cmd = new PutObjectCommand({ Bucket: BUCKET, Key: key, ContentType: contentType });\r\n      const url = await getSignedUrl(s3, cmd, { expiresIn: 900 });\r\n\r\n      return ok(event, { url, key, thumbsCdn: THUMBS_CDN });\r\n    }\r\n\r\n    // --- DELETE /delete ---\r\n    if (method === 'DELETE' && /\\/delete$/.test(path)) {\r\n      const body = parseBody(event);\r\n\r\n      // Accept key from JSON body OR from query string (?key=...)\r\n      const keyFromQuery = event?.queryStringParameters?.key\r\n        ? decodeURIComponent(event.queryStringParameters.key)\r\n        : undefined;\r\n      const key = (body?.key as string | undefined) ?? keyFromQuery;\r\n\r\n      if (!key || typeof key !== 'string') return bad(event, 400, 'Invalid \"key\"');\r\n      if (userSub && !key.startsWith(`users/${userSub}/`)) return bad(event, 403, 'Forbidden');\r\n\r\n      await s3.send(new DeleteObjectCommand({ Bucket: BUCKET, Key: key }));\r\n      return ok(event, { deleted: key });\r\n    }\r\n\r\n    return bad(event, 404, 'Not Found');\r\n  } catch (e: any) {\r\n    console.error('handler error', e);\r\n    return bad(event, 500, e?.message ?? 'Server error');\r\n  }\r\n};"],
  "mappings": "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",
  "names": ["presign_exports", "__export", "handler", "__toCommonJS", "import_client_s3", "import_s3_request_presigner", "s3", "BUCKET", "THUMBS_CDN", "ALLOWED_ORIGINS", "s", "WEB_ORIGIN", "pickAllowedOrigin", "event", "reqOrigin", "baseCorsHeaders", "origin", "h", "ok", "body", "extra", "bad", "status", "msg", "getMethod", "getPath", "getClaims", "parseBody", "raw", "method", "path", "userSub", "key", "contentType", "cmd", "url", "keyFromQuery", "e"]
}
