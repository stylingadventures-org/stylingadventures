"use strict";var y=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var b=(e,r)=>{for(var n in r)y(e,n,{get:r[n],enumerable:!0})},w=(e,r,n,i)=>{if(r&&typeof r=="object"||typeof r=="function")for(let t of S(r))!I.call(e,t)&&t!==n&&y(e,t,{get:()=>r[t],enumerable:!(i=E(r,t))||i.enumerable});return e};var P=e=>w(y({},"__esModule",{value:!0}),e);var x={};b(x,{handler:()=>G});module.exports=P(x);var u=require("@aws-sdk/client-s3"),O=require("@aws-sdk/s3-request-presigner"),l=new u.S3Client({region:process.env.AWS_REGION||"us-east-1",forcePathStyle:!0}),f=process.env.BUCKET,T=process.env.THUMBS_CDN,h=String(process.env.ALLOWED_ORIGINS||"").split(",").map(e=>e.trim()).filter(Boolean),R=process.env.WEB_ORIGIN||process.env.ORIGIN||"";function g(e){let r=e.headers?.origin||e.headers?.Origin||e.headers?.["x-origin"]||"";return h.length>0?h.includes(r)?r:void 0:R||void 0}function c(e){let r={"Content-Type":"application/json","Access-Control-Allow-Headers":"Authorization,Content-Type,X-Amz-Date,X-Api-Key,X-Amz-Security-Token","Access-Control-Allow-Methods":"GET,POST,DELETE,OPTIONS","Access-Control-Allow-Credentials":"true",Vary:"Origin"};return e&&(r["Access-Control-Allow-Origin"]=e),r}function p(e,r,n={}){let i=g(e);return{statusCode:200,headers:{...c(i),...n},body:JSON.stringify(r)}}function a(e,r,n){let i=g(e);return!!(e.headers?.origin||e.headers?.Origin)&&!i?{statusCode:403,headers:c(void 0),body:JSON.stringify({message:"CORS: origin not allowed"})}:{statusCode:r,headers:c(i),body:JSON.stringify({message:n})}}function k(e){return e.httpMethod??e.requestContext?.http?.method??"GET"}function N(e){return e.resource??e.rawPath??e.path??"/"}function B(e){return e.requestContext?.authorizer?.claims??e.requestContext?.authorizer?.jwt?.claims??{}}function m(e){if(!e.body)return;let r=e.isBase64Encoded?Buffer.from(e.body,"base64").toString():e.body;try{return JSON.parse(r)}catch{return}}var G=async e=>{try{let r=k(e),n=N(e),t=B(e)?.sub;if(r==="OPTIONS"){let d=g(e);return!d&&(e.headers?.origin||e.headers?.Origin)?{statusCode:403,headers:c(void 0),body:""}:{statusCode:204,headers:c(d),body:""}}if(r==="POST"&&/\/presign$/.test(n)){let d=m(e);if(!d)return a(e,400,"Missing body");let{key:s,contentType:o}=d;if(!s||typeof s!="string")return a(e,400,'Invalid "key"');if(!o||typeof o!="string")return a(e,400,'Invalid "contentType"');if(s.includes(".."))return a(e,400,"Illegal key");t&&!s.startsWith("users/")&&(s=`users/${t}/${s}`);let A=new u.PutObjectCommand({Bucket:f,Key:s,ContentType:o}),C=await(0,O.getSignedUrl)(l,A,{expiresIn:900});return p(e,{url:C,key:s,thumbsCdn:T})}if(r==="DELETE"&&/\/delete$/.test(n)){let d=m(e),s=e?.queryStringParameters?.key?decodeURIComponent(e.queryStringParameters.key):void 0,o=d?.key??s;return!o||typeof o!="string"?a(e,400,'Invalid "key"'):t&&!o.startsWith(`users/${t}/`)?a(e,403,"Forbidden"):(await l.send(new u.DeleteObjectCommand({Bucket:f,Key:o})),p(e,{deleted:o}))}return a(e,404,"Not Found")}catch(r){return console.error("handler error",r),a(e,500,r?.message??"Server error")}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
