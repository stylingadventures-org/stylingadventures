{
  "version": 3,
  "sources": ["../../lambda/commerce/shopping-resolver.ts"],
  "sourcesContent": ["/**\r\n * lambda/commerce/shopping-resolver.ts\r\n * \r\n * Handles Shopping queries and mutations:\r\n * - Find exact item matches (brand/name search)\r\n * - Get shoppable items from scenes/videos\r\n * - Shopping cart management (add, remove items)\r\n * - Affiliate tracking and commission calculation\r\n * - Admin: Create shoppable items, add affiliate links\r\n */\r\n\r\nimport {\r\n  DynamoDBClient,\r\n  PutItemCommand,\r\n  QueryCommand,\r\n  UpdateItemCommand,\r\n  GetItemCommand,\r\n  DeleteItemCommand,\r\n} from \"@aws-sdk/client-dynamodb\";\r\nimport { marshall, unmarshall } from \"@aws-sdk/util-dynamodb\";\r\nimport { randomUUID } from \"crypto\";\r\nimport { AppSyncIdentityCognito } from \"aws-lambda\";\r\n\r\nconst ddb = new DynamoDBClient({});\r\nconst TABLE_NAME = process.env.TABLE_NAME!;\r\n\r\ntype SAIdentity = (AppSyncIdentityCognito & { groups?: string[] | null }) | null | undefined;\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// Auth helpers\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nfunction assertAuth(identity: SAIdentity): asserts identity {\r\n  if (!identity?.sub) throw new Error(\"Not authenticated\");\r\n}\r\n\r\nfunction isAdmin(identity: SAIdentity): boolean {\r\n  const claims = (identity as any)?.claims || {};\r\n  const raw = claims[\"cognito:groups\"];\r\n  const groups = Array.isArray(raw)\r\n    ? raw\r\n    : String(raw || \"\").split(\",\").map((g) => g.trim()).filter(Boolean);\r\n  return groups.includes(\"ADMIN\") || groups.includes(\"PRIME\");\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// Types\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\ninterface ShoppableItem {\r\n  id: string;\r\n  brand: string;\r\n  name: string;\r\n  category: string;\r\n  sku: string;\r\n  imageUrl: string;\r\n  price: number;\r\n  affiliateLinks: AffiliateLink[];\r\n  likeCount: number;\r\n}\r\n\r\ninterface AffiliateLink {\r\n  id: string;\r\n  retailer: string;\r\n  url: string;\r\n  commissionRate: number;\r\n  isActive: boolean;\r\n}\r\n\r\ninterface ExactMatchResult {\r\n  item: ShoppableItem;\r\n  confidence: number;\r\n  matchType: string;\r\n  source: string;\r\n}\r\n\r\ninterface ShoppingCart {\r\n  id: string;\r\n  userId: string;\r\n  items: ShoppableItem[];\r\n  total: number;\r\n  affiliateCredit: number;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// Helpers\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nfunction nowIso() {\r\n  return new Date().toISOString();\r\n}\r\n\r\nfunction pkForUser(userId: string) {\r\n  return `USER#${userId}`;\r\n}\r\n\r\nfunction skForCart(userId: string) {\r\n  return `SHOPPING#CART`;\r\n}\r\n\r\nfunction pkForShoppableItem() {\r\n  return \"SHOPPING#ITEM\";\r\n}\r\n\r\nfunction skForShoppableItem(itemId: string) {\r\n  return `ITEM#${itemId}`;\r\n}\r\n\r\nconst ddbMarshal = (value: any) =>\r\n  marshall(value, { removeUndefinedValues: true });\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// Queries\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleFindExactItem(args: {\r\n  brandName: string;\r\n  itemName: string;\r\n  category?: string;\r\n}): Promise<ExactMatchResult[]> {\r\n  // Scan all shoppable items and fuzzy match\r\n  const res = await ddb.send(\r\n    new QueryCommand({\r\n      TableName: TABLE_NAME,\r\n      KeyConditionExpression: \"pk = :pk\",\r\n      ExpressionAttributeValues: ddbMarshal({\r\n        \":pk\": pkForShoppableItem(),\r\n      }),\r\n    }),\r\n  );\r\n\r\n  const items = (res.Items ?? []).map((raw) => unmarshall(raw) as ShoppableItem);\r\n\r\n  const matches = items.filter((item) => {\r\n    const brandMatch = item.brand.toLowerCase().includes(args.brandName.toLowerCase());\r\n    const nameMatch = item.name.toLowerCase().includes(args.itemName.toLowerCase());\r\n    const categoryMatch = !args.category || item.category === args.category;\r\n\r\n    return brandMatch && nameMatch && categoryMatch;\r\n  });\r\n\r\n  return matches.map((item) => ({\r\n    item,\r\n    confidence: 0.85,\r\n    matchType: \"EXACT\",\r\n    source: \"SHOPPING_DB\",\r\n  }));\r\n}\r\n\r\nasync function handleSceneShoppableItems(args: {\r\n  sceneId: string;\r\n}): Promise<ShoppableItem[]> {\r\n  // In production, would link scenes to shoppable items\r\n  // For now returning empty array as placeholder\r\n  return [];\r\n}\r\n\r\nasync function handleVideoShoppableItems(args: {\r\n  videoId: string;\r\n}): Promise<ShoppableItem[]> {\r\n  // In production, would link music videos to shoppable items\r\n  // For now returning empty array as placeholder\r\n  return [];\r\n}\r\n\r\nasync function handleMyShoppingCart(identity: SAIdentity): Promise<ShoppingCart | null> {\r\n  assertAuth(identity);\r\n  const userId = identity!.sub as string;\r\n\r\n  const res = await ddb.send(\r\n    new GetItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: ddbMarshal({\r\n        pk: pkForUser(userId),\r\n        sk: skForCart(userId),\r\n      }),\r\n    }),\r\n  );\r\n\r\n  if (!res.Item) {\r\n    // Return empty cart\r\n    return {\r\n      id: randomUUID(),\r\n      userId,\r\n      items: [],\r\n      total: 0,\r\n      affiliateCredit: 0,\r\n    };\r\n  }\r\n\r\n  return unmarshall(res.Item) as ShoppingCart;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// Mutations\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleAddToCart(\r\n  args: { itemId: string },\r\n  identity: SAIdentity,\r\n): Promise<ShoppingCart> {\r\n  assertAuth(identity);\r\n  const userId = identity!.sub as string;\r\n  const now = nowIso();\r\n\r\n  // Get item\r\n  const itemRes = await ddb.send(\r\n    new GetItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: ddbMarshal({\r\n        pk: pkForShoppableItem(),\r\n        sk: skForShoppableItem(args.itemId),\r\n      }),\r\n    }),\r\n  );\r\n\r\n  if (!itemRes.Item) throw new Error(\"Item not found\");\r\n  const item = unmarshall(itemRes.Item) as ShoppableItem;\r\n\r\n  // Get or create cart\r\n  let cart: ShoppingCart = {\r\n    id: randomUUID(),\r\n    userId,\r\n    items: [],\r\n    total: 0,\r\n    affiliateCredit: 0,\r\n  };\r\n\r\n  const cartRes = await ddb.send(\r\n    new GetItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Key: ddbMarshal({\r\n        pk: pkForUser(userId),\r\n        sk: skForCart(userId),\r\n      }),\r\n    }),\r\n  );\r\n\r\n  if (cartRes.Item) {\r\n    cart = unmarshall(cartRes.Item) as ShoppingCart;\r\n  }\r\n\r\n  // Add item to cart if not already there\r\n  if (!cart.items.find((i) => i.id === item.id)) {\r\n    cart.items.push(item);\r\n    cart.total += item.price;\r\n\r\n    // Calculate affiliate credit (assume 5% avg commission)\r\n    const commission = item.affiliateLinks[0]?.commissionRate ?? 0.05;\r\n    cart.affiliateCredit += item.price * commission;\r\n  }\r\n\r\n  await ddb.send(\r\n    new PutItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Item: ddbMarshal({\r\n        pk: pkForUser(userId),\r\n        sk: skForCart(userId),\r\n        entityType: \"SHOPPING_CART\",\r\n        updatedAt: now,\r\n        ...cart,\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return cart;\r\n}\r\n\r\nasync function handleRemoveFromCart(\r\n  args: { itemId: string },\r\n  identity: SAIdentity,\r\n): Promise<ShoppingCart> {\r\n  assertAuth(identity);\r\n  const userId = identity!.sub as string;\r\n  const now = nowIso();\r\n\r\n  const cart = await handleMyShoppingCart(identity);\r\n  if (!cart) throw new Error(\"Cart not found\");\r\n\r\n  const item = cart.items.find((i) => i.id === args.itemId);\r\n  if (!item) throw new Error(\"Item not in cart\");\r\n\r\n  cart.items = cart.items.filter((i) => i.id !== args.itemId);\r\n  cart.total -= item.price;\r\n\r\n  const commission = item.affiliateLinks[0]?.commissionRate ?? 0.05;\r\n  cart.affiliateCredit -= item.price * commission;\r\n\r\n  await ddb.send(\r\n    new PutItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Item: ddbMarshal({\r\n        pk: pkForUser(userId),\r\n        sk: skForCart(userId),\r\n        entityType: \"SHOPPING_CART\",\r\n        updatedAt: now,\r\n        ...cart,\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return cart;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// Admin Mutations\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nasync function handleAdminCreateShoppableItem(\r\n  args: {\r\n    brand: string;\r\n    name: string;\r\n    category: string;\r\n    sku: string;\r\n    imageUrl: string;\r\n    price: number;\r\n  },\r\n  identity: SAIdentity,\r\n): Promise<ShoppableItem> {\r\n  if (!isAdmin(identity)) throw new Error(\"ADMIN required\");\r\n\r\n  const itemId = randomUUID();\r\n  const item: ShoppableItem = {\r\n    id: itemId,\r\n    brand: args.brand,\r\n    name: args.name,\r\n    category: args.category,\r\n    sku: args.sku,\r\n    imageUrl: args.imageUrl,\r\n    price: args.price,\r\n    affiliateLinks: [],\r\n    likeCount: 0,\r\n  };\r\n\r\n  await ddb.send(\r\n    new PutItemCommand({\r\n      TableName: TABLE_NAME,\r\n      Item: ddbMarshal({\r\n        pk: pkForShoppableItem(),\r\n        sk: skForShoppableItem(itemId),\r\n        entityType: \"SHOPPABLE_ITEM\",\r\n        gsi1pk: `SHOPPING#CATEGORY#${args.category}`,\r\n        gsi1sk: args.brand,\r\n        ...item,\r\n      }),\r\n    }),\r\n  );\r\n\r\n  return item;\r\n}\r\n\r\nasync function handleAdminAddAffiliateLink(\r\n  args: {\r\n    itemId: string;\r\n    retailer: string;\r\n    url: string;\r\n    commissionRate: number;\r\n  },\r\n  identity: SAIdentity,\r\n): Promise<AffiliateLink> {\r\n  if (!isAdmin(identity)) throw new Error(\"ADMIN required\");\r\n\r\n  const link: AffiliateLink = {\r\n    id: randomUUID(),\r\n    retailer: args.retailer,\r\n    url: args.url,\r\n    commissionRate: args.commissionRate,\r\n    isActive: true,\r\n  };\r\n\r\n  // In production, would update the item with new link\r\n  return link;\r\n}\r\n\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n// AppSync Lambda resolver entrypoint\r\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\r\n\r\nexport const handler = async (event: any) => {\r\n  console.log(\"ShoppingResolverFn event\", JSON.stringify(event));\r\n\r\n  const fieldName = event.info?.fieldName as string | undefined;\r\n\r\n  try {\r\n    switch (fieldName) {\r\n      case \"findExactItem\":\r\n        return await handleFindExactItem(event.arguments);\r\n\r\n      case \"sceneShoppableItems\":\r\n        return await handleSceneShoppableItems(event.arguments);\r\n\r\n      case \"videoShoppableItems\":\r\n        return await handleVideoShoppableItems(event.arguments);\r\n\r\n      case \"myShoppingCart\":\r\n        return await handleMyShoppingCart(event.identity);\r\n\r\n      case \"addToCart\":\r\n        return await handleAddToCart(event.arguments, event.identity);\r\n\r\n      case \"removeFromCart\":\r\n        return await handleRemoveFromCart(event.arguments, event.identity);\r\n\r\n      case \"adminCreateShoppableItem\":\r\n        return await handleAdminCreateShoppableItem(event.arguments, event.identity);\r\n\r\n      case \"adminAddAffiliateLink\":\r\n        return await handleAdminAddAffiliateLink(event.arguments, event.identity);\r\n\r\n      default:\r\n        throw new Error(`Unknown field: ${fieldName}`);\r\n    }\r\n  } catch (err: any) {\r\n    console.error(\"ShoppingResolverFn error\", err);\r\n    throw err;\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": ["shopping_resolver_exports", "__export", "handler", "__toCommonJS", "import_client_dynamodb", "import_util_dynamodb", "import_crypto", "ddb", "TABLE_NAME", "assertAuth", "identity", "isAdmin", "raw", "groups", "g", "nowIso", "pkForUser", "userId", "skForCart", "pkForShoppableItem", "skForShoppableItem", "itemId", "ddbMarshal", "value", "handleFindExactItem", "args", "item", "brandMatch", "nameMatch", "categoryMatch", "handleSceneShoppableItems", "handleVideoShoppableItems", "handleMyShoppingCart", "res", "handleAddToCart", "now", "itemRes", "cart", "cartRes", "i", "commission", "handleRemoveFromCart", "handleAdminCreateShoppableItem", "handleAdminAddAffiliateLink", "event", "fieldName", "err"]
}
