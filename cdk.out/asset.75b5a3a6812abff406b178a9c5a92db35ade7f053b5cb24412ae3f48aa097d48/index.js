"use strict";var $=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var z=Object.prototype.hasOwnProperty;var G=(e,t)=>{for(var r in t)$(e,r,{get:t[r],enumerable:!0})},W=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of H(t))!z.call(e,s)&&s!==r&&$(e,s,{get:()=>t[s],enumerable:!(n=v(t,s))||n.enumerable});return e};var Q=e=>W($({},"__esModule",{value:!0}),e);var Ae={};G(Ae,{handler:()=>ee});module.exports=Q(Ae);var F=require("@aws-sdk/client-dynamodb"),i=require("@aws-sdk/lib-dynamodb");var w=[];for(let e=0;e<256;++e)w.push((e+256).toString(16).slice(1));function L(e,t=0){return(w[e[t+0]]+w[e[t+1]]+w[e[t+2]]+w[e[t+3]]+"-"+w[e[t+4]]+w[e[t+5]]+"-"+w[e[t+6]]+w[e[t+7]]+"-"+w[e[t+8]]+w[e[t+9]]+"-"+w[e[t+10]]+w[e[t+11]]+w[e[t+12]]+w[e[t+13]]+w[e[t+14]]+w[e[t+15]]).toLowerCase()}var P=require("crypto"),h=new Uint8Array(256),T=h.length;function K(){return T>h.length-16&&((0,P.randomFillSync)(h),T=0),h.slice(T,T+=16)}var V=require("crypto"),_={randomUUID:V.randomUUID};function X(e,t,r){if(_.randomUUID&&!t&&!e)return _.randomUUID();e=e||{};let n=e.random??e.rng?.()??K();if(n.length<16)throw new Error("Random bytes length must be >= 16");if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,t){if(r=r||0,r<0||r+16>t.length)throw new RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let s=0;s<16;++s)t[r+s]=n[s];return t}return L(n)}var x=X;var k=require("@aws-sdk/client-s3"),j=require("@aws-sdk/s3-request-presigner"),l=i.DynamoDBDocumentClient.from(new F.DynamoDBClient({})),Z=new k.S3Client({}),c=process.env.TABLE_NAME,J=process.env.CREATOR_MEDIA_BUCKET,d=process.env.PK_NAME||"pk",u=process.env.SK_NAME||"sk",Y=process.env.STATUS_GSI||"gsi1";function m(){return new Date().toISOString()}var ee=async e=>{let t=e.info?.fieldName,r=e.identity?.sub||e.identity?.claims?.sub||"anonymous";switch(t){case"creatorCabinets":return te(r);case"creatorCabinet":return S(r,e.arguments?.id);case"createCreatorCabinet":return re(r,e.arguments?.input);case"updateCreatorCabinet":return ne(r,e.arguments?.input);case"deleteCreatorCabinet":return se(r,e.arguments?.id);case"creatorFolders":return oe(r,e.arguments?.cabinetId);case"createCreatorFolder":return ae(r,e.arguments?.input);case"renameCreatorFolder":return ie(r,e.arguments?.input);case"deleteCreatorFolder":return de(r,e.arguments?.id,e.arguments?.cabinetId);case"creatorCabinetAssets":return ue(r,e.arguments);case"createCreatorAssetUpload":return le(r,e.arguments?.input);case"updateCreatorAsset":return ce(r,e.arguments?.input);case"deleteCreatorAsset":return pe(r,e.arguments?.id,e.arguments?.cabinetId);case"moveCreatorAsset":return we(r,e.arguments?.input);case"creatorAiSuggest":return fe(e);default:throw new Error(`Unknown field ${t}`)}};function N(e){return e?{id:e.id,ownerSub:e.ownerSub,name:e.name,description:e.description??null,defaultCategory:e.defaultCategory??null,tags:e.tags??[],createdAt:e.createdAt,updatedAt:e.updatedAt,assetCount:e.assetCount??0}:null}function B(e){return e?{id:e.id,cabinetId:e.cabinetId,name:e.name,specialKind:e.specialKind??null,createdAt:e.createdAt,updatedAt:e.updatedAt}:null}function U(e){return e?{id:e.id,cabinetId:e.cabinetId,folderId:e.folderId??null,ownerSub:e.ownerSub,kind:e.kind??"OTHER",category:e.category??null,title:e.title??null,notes:e.notes??null,tags:e.tags??[],s3Key:e.s3Key,contentType:e.contentType??null,createdAt:e.createdAt,updatedAt:e.updatedAt}:null}async function te(e){return((await l.send(new i.QueryCommand({TableName:c,IndexName:Y,KeyConditionExpression:"#gpk = :gpk AND begins_with(#gsk, :prefix)",ExpressionAttributeNames:{"#gpk":"gsi1pk","#gsk":"gsi1sk"},ExpressionAttributeValues:{":gpk":`CREATOR#${e}`,":prefix":"CAB#"}}))).Items??[]).map(N)}async function S(e,t){if(!t)throw new Error("id is required");let r=await l.send(new i.GetCommand({TableName:c,Key:{[d]:`CAB#${t}`,[u]:"META"}}));return!r.Item||r.Item.ownerSub!==e?null:N(r.Item)}async function re(e,t){if(!t?.name)throw new Error("name is required");let r=x(),n=m(),s={[d]:`CAB#${r}`,[u]:"META",type:"CABINET",id:r,ownerSub:e,name:t.name,description:t.description??null,defaultCategory:t.defaultCategory??null,tags:t.tags??[],assetCount:0,createdAt:n,updatedAt:n,gsi1pk:`CREATOR#${e}`,gsi1sk:`CAB#${n}#${r}`};return await l.send(new i.PutCommand({TableName:c,Item:s,ConditionExpression:"attribute_not_exists(#pk)",ExpressionAttributeNames:{"#pk":d}})),N(s)}async function ne(e,t){let r=t?.id;if(!r)throw new Error("id is required");if(!t)throw new Error("input is required");let n=m(),s={"#updatedAt":"updatedAt","#ownerSub":"ownerSub"},o={":updatedAt":n,":ownerSub":e},a=["#updatedAt = :updatedAt"];Object.prototype.hasOwnProperty.call(t,"name")&&(s["#name"]="name",o[":name"]=t.name,a.push("#name = :name")),Object.prototype.hasOwnProperty.call(t,"description")&&(s["#description"]="description",o[":description"]=t.description??null,a.push("#description = :description")),Object.prototype.hasOwnProperty.call(t,"defaultCategory")&&(s["#defaultCategory"]="defaultCategory",o[":defaultCategory"]=t.defaultCategory??null,a.push("#defaultCategory = :defaultCategory")),Object.prototype.hasOwnProperty.call(t,"tags")&&(s["#tags"]="tags",o[":tags"]=t.tags??[],a.push("#tags = :tags"));let p=await l.send(new i.UpdateCommand({TableName:c,Key:{[d]:`CAB#${r}`,[u]:"META"},UpdateExpression:"SET "+a.join(", "),ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:s,ExpressionAttributeValues:o,ReturnValues:"ALL_NEW"}));return N(p.Attributes)}async function se(e,t){if(!t)throw new Error("id is required");let r=`CAB#${t}`,s=(await l.send(new i.QueryCommand({TableName:c,KeyConditionExpression:"#pk = :pk",ExpressionAttributeNames:{"#pk":d},ExpressionAttributeValues:{":pk":r}}))).Items??[],o=s.find(a=>a.type==="CABINET");return!o||o.ownerSub!==e?!1:(await Promise.all(s.map(a=>l.send(new i.DeleteCommand({TableName:c,Key:{[d]:a[d],[u]:a[u]}})))),!0)}async function oe(e,t){if(!t)throw new Error("cabinetId is required");return await S(e,t)?((await l.send(new i.QueryCommand({TableName:c,KeyConditionExpression:"#pk = :pk AND begins_with(#sk, :prefix)",ExpressionAttributeNames:{"#pk":d,"#sk":u},ExpressionAttributeValues:{":pk":`CAB#${t}`,":prefix":"FOLDER#"}}))).Items??[]).map(B):[]}async function ae(e,t){let{cabinetId:r,name:n}=t||{};if(!r)throw new Error("cabinetId is required");if(!n)throw new Error("name is required");if(!await S(e,r))throw new Error("Cabinet not found");let o=x(),a=m(),p={[d]:`CAB#${r}`,[u]:`FOLDER#${o}`,type:"FOLDER",id:o,cabinetId:r,ownerSub:e,name:n,specialKind:null,createdAt:a,updatedAt:a};return await l.send(new i.PutCommand({TableName:c,Item:p,ConditionExpression:"attribute_not_exists(#pk) AND attribute_not_exists(#sk)",ExpressionAttributeNames:{"#pk":d,"#sk":u}})),B(p)}async function ie(e,t){let{id:r,cabinetId:n,name:s}=t||{};if(!r)throw new Error("id is required");if(!n)throw new Error("cabinetId is required");if(!s)throw new Error("name is required");let o=m(),a=await l.send(new i.UpdateCommand({TableName:c,Key:{[d]:`CAB#${n}`,[u]:`FOLDER#${r}`},UpdateExpression:"SET #name = :name, #updatedAt = :updatedAt",ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:{"#name":"name","#updatedAt":"updatedAt","#ownerSub":"ownerSub"},ExpressionAttributeValues:{":name":s,":updatedAt":o,":ownerSub":e},ReturnValues:"ALL_NEW"}));return B(a.Attributes)}async function de(e,t,r){if(!t)throw new Error("id is required");if(!r)throw new Error("cabinetId is required");await l.send(new i.DeleteCommand({TableName:c,Key:{[d]:`CAB#${r}`,[u]:`FOLDER#${t}`},ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:{"#ownerSub":"ownerSub"},ExpressionAttributeValues:{":ownerSub":e}}));let s=(await l.send(new i.QueryCommand({TableName:c,KeyConditionExpression:"#pk = :pk AND begins_with(#sk, :prefix)",FilterExpression:"#folderId = :folderId",ExpressionAttributeNames:{"#pk":d,"#sk":u,"#folderId":"folderId"},ExpressionAttributeValues:{":pk":`CAB#${r}`,":prefix":"ASSET#",":folderId":t}}))).Items??[];return await Promise.all(s.map(o=>l.send(new i.UpdateCommand({TableName:c,Key:{[d]:o[d],[u]:o[u]},UpdateExpression:"SET #folderId = :null",ExpressionAttributeNames:{"#folderId":"folderId"},ExpressionAttributeValues:{":null":null}})))),!0}async function ue(e,t){let{cabinetId:r,folderId:n,category:s,tag:o,search:a,limit:p=50,nextToken:g}=t||{};if(!r)throw new Error("cabinetId is required");if(!await S(e,r))return{items:[],nextToken:null};let b={TableName:c,KeyConditionExpression:"#pk = :pk AND begins_with(#sk, :prefix)",ExpressionAttributeNames:{"#pk":d,"#sk":u},ExpressionAttributeValues:{":pk":`CAB#${r}`,":prefix":"ASSET#"},Limit:p};g&&(b.ExclusiveStartKey={[d]:`CAB#${r}`,[u]:g});let y=await l.send(new i.QueryCommand(b)),A=(y.Items??[]).filter(f=>f.type==="ASSET");if(n!=null&&(A=A.filter(f=>f.folderId===n)),s&&(A=A.filter(f=>f.category===s)),o&&(A=A.filter(f=>Array.isArray(f.tags)&&f.tags.includes(o))),a){let f=String(a).toLowerCase();A=A.filter(I=>{let O=(I.title??"").toLowerCase(),E=(I.notes??"").toLowerCase();return O.includes(f)||E.includes(f)})}let q=y.LastEvaluatedKey?y.LastEvaluatedKey[u]:null;return{items:A.map(U),nextToken:q}}async function le(e,t){let{cabinetId:r,folderId:n,category:s,title:o,notes:a,tags:p=[],fileName:g,filename:R,contentType:b,kind:y}=t||{},A=g??R;if(!r)throw new Error("cabinetId is required");if(!A)throw new Error("fileName is required");if(!b)throw new Error("contentType is required");if(!await S(e,r))throw new Error("Cabinet not found");let f=x(),I=n||"unsorted",O=String(A).replace(/[^a-zA-Z0-9._-]/g,"_"),E=["creator-media",e,r,I,`${f}-${O}`].join("/"),C=m(),D=y??"OTHER";await l.send(new i.PutCommand({TableName:c,Item:{[d]:`CAB#${r}`,[u]:`ASSET#${f}`,type:"ASSET",id:f,cabinetId:r,folderId:n??null,ownerSub:e,kind:D,category:s??null,title:o??null,notes:a??null,tags:p,s3Key:E,contentType:b,createdAt:C,updatedAt:C}})),await l.send(new i.UpdateCommand({TableName:c,Key:{[d]:`CAB#${r}`,[u]:"META"},UpdateExpression:"SET #assetCount = if_not_exists(#assetCount, :zero) + :one, #updatedAt = :updatedAt",ExpressionAttributeNames:{"#assetCount":"assetCount","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":zero":0,":one":1,":updatedAt":C}}));let M=new k.PutObjectCommand({Bucket:J,Key:E,ContentType:b});return{uploadUrl:await(0,j.getSignedUrl)(Z,M,{expiresIn:900}),asset:{id:f,cabinetId:r,folderId:n,ownerSub:e,kind:D,category:s,title:o,notes:a,tags:p,s3Key:E,contentType:b,createdAt:C,updatedAt:C}}}async function ce(e,t){let{id:r,cabinetId:n}=t||{};if(!r)throw new Error("id is required");if(!n)throw new Error("cabinetId is required");let s=m(),o={"#updatedAt":"updatedAt","#ownerSub":"ownerSub"},a={":updatedAt":s,":ownerSub":e},p=["#updatedAt = :updatedAt"];Object.prototype.hasOwnProperty.call(t,"folderId")&&(o["#folderId"]="folderId",a[":folderId"]=t.folderId??null,p.push("#folderId = :folderId")),Object.prototype.hasOwnProperty.call(t,"category")&&(o["#category"]="category",a[":category"]=t.category??null,p.push("#category = :category")),Object.prototype.hasOwnProperty.call(t,"title")&&(o["#title"]="title",a[":title"]=t.title??null,p.push("#title = :title")),Object.prototype.hasOwnProperty.call(t,"notes")&&(o["#notes"]="notes",a[":notes"]=t.notes??null,p.push("#notes = :notes")),Object.prototype.hasOwnProperty.call(t,"tags")&&(o["#tags"]="tags",a[":tags"]=t.tags??[],p.push("#tags = :tags")),Object.prototype.hasOwnProperty.call(t,"kind")&&(o["#kind"]="kind",a[":kind"]=t.kind??"OTHER",p.push("#kind = :kind")),Object.prototype.hasOwnProperty.call(t,"contentType")&&(o["#contentType"]="contentType",a[":contentType"]=t.contentType??null,p.push("#contentType = :contentType"));let g=await l.send(new i.UpdateCommand({TableName:c,Key:{[d]:`CAB#${n}`,[u]:`ASSET#${r}`},UpdateExpression:"SET "+p.join(", "),ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:o,ExpressionAttributeValues:a,ReturnValues:"ALL_NEW"}));return U(g.Attributes)}async function pe(e,t,r){if(!t)throw new Error("id is required");if(!r)throw new Error("cabinetId is required");let n=m();return await l.send(new i.DeleteCommand({TableName:c,Key:{[d]:`CAB#${r}`,[u]:`ASSET#${t}`},ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:{"#ownerSub":"ownerSub"},ExpressionAttributeValues:{":ownerSub":e}})),await l.send(new i.UpdateCommand({TableName:c,Key:{[d]:`CAB#${r}`,[u]:"META"},UpdateExpression:"SET #assetCount = if_not_exists(#assetCount, :zero) - :one, #updatedAt = :updatedAt",ExpressionAttributeNames:{"#assetCount":"assetCount","#updatedAt":"updatedAt"},ExpressionAttributeValues:{":zero":0,":one":1,":updatedAt":n}})),!0}async function we(e,t){let{id:r,cabinetId:n,destinationFolderId:s}=t||{};if(!r)throw new Error("id is required");if(!n)throw new Error("cabinetId is required");let o=m(),a=await l.send(new i.UpdateCommand({TableName:c,Key:{[d]:`CAB#${n}`,[u]:`ASSET#${r}`},UpdateExpression:"SET #folderId = :folderId, #updatedAt = :updatedAt",ConditionExpression:"#ownerSub = :ownerSub",ExpressionAttributeNames:{"#folderId":"folderId","#updatedAt":"updatedAt","#ownerSub":"ownerSub"},ExpressionAttributeValues:{":folderId":s??null,":updatedAt":o,":ownerSub":e},ReturnValues:"ALL_NEW"}));return U(a.Attributes)}async function fe(e){let t=e.arguments?.text??"",r=e.arguments?.kind??"OTHER",n=t||"your content",s=[];return r==="CAPTION"?s.push(`Behind the scenes of ${n} \u2728`,`Styling ${n} so you don't have to \u{1F485}`):r==="HASHTAGS"?s.push("#stylingadventures #creatorlife #behindthescenes","#outfitinspo #contentcreator #filmingday"):s.push(`Planning ideas for ${n}`),{suggestions:s}}0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
