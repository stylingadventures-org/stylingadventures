"use strict";var I=Object.defineProperty;var P=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var T=(e,n)=>{for(var t in n)I(e,t,{get:n[t],enumerable:!0})},O=(e,n,t,c)=>{if(n&&typeof n=="object"||typeof n=="function")for(let o of _(n))!L.call(e,o)&&o!==t&&I(e,o,{get:()=>n[o],enumerable:!(c=P(n,o))||c.enumerable});return e};var U=e=>O(I({},"__esModule",{value:!0}),e);var B={};T(B,{handler:()=>K});module.exports=U(B);var S=require("@aws-sdk/client-dynamodb"),i=require("@aws-sdk/lib-dynamodb");var a=process.env.TABLE_NAME??process.env.APP_TABLE??process.env.TABLE??"";if(!a)throw new Error("Missing DynamoDB table env. Provide TABLE_NAME (or APP_TABLE / TABLE).");var p=i.DynamoDBDocumentClient.from(new S.DynamoDBClient({}),{marshallOptions:{removeUndefinedValues:!0}});function N(e){return`EPISODE#${e}`}var h="META";function E(e){return`USER#${e}`}var D="PROFILE";function b(e){return`EP_UNLOCK#${e}`}function k(e){return e?{id:e.id||e.episodeId||(e.pk||"").replace("EPISODE#",""),title:e.title||"",season:e.season??null,episodeNumber:e.episodeNumber??null,showId:e.showId??null,shortDescription:e.shortDescription??"",fullDescription:e.fullDescription??"",status:e.status||"DRAFT",publicAt:e.publicAt||new Date().toISOString(),durationSeconds:e.durationSeconds??null,unlockCoinCost:e.unlockCoinCost??null,chatEnabled:e.chatEnabled??!0,thumbnails:Array.isArray(e.thumbnails)?e.thumbnails:[],outfitsLinkedCount:e.outfitsLinkedCount??0}:null}async function y(e){let n=await p.send(new i.GetCommand({TableName:a,Key:{pk:N(e),sk:h}}));if(!n.Item)throw new Error("Episode not found");return n.Item}async function C(e){let t=(await p.send(new i.GetCommand({TableName:a,Key:{pk:E(e),sk:D}}))).Item||{};return{userId:t.userId||e,coins:Number(t.coins??0),xp:Number(t.xp??0),level:Number(t.level??1),lastEventAt:t.lastEventAt??null}}function x(e,n){let t=e.status||"DRAFT",c=e.publicAt||new Date().toISOString(),o=new Date(c),u=t==="PUBLISHED"&&o.getTime()<=n.getTime();return{episodeId:e.id||e.episodeId||(e.pk||"").replace("EPISODE#",""),status:t,publicAt:c,isPublic:u}}var K=async e=>{let{fieldName:n}=e.info,t=e.identity,c=new Date;if(n==="isEpisodeEarlyAccess"){let{episodeId:o}=e.arguments||{};if(!o)throw new Error("episodeId is required");let u=await y(String(o));return x(u,c)}if(n==="unlockEpisode"){if(!t?.sub)throw new Error("Unauthorized");let o=t.sub,{episodeId:u}=e.arguments||{};if(!u)throw new Error("episodeId is required");let d=String(u),m=await y(d),s=k(m);if(!s)throw new Error(`Episode not found for id=${u}`);let r=Number(s.unlockCoinCost??0),l=c.toISOString(),w=await p.send(new i.GetCommand({TableName:a,Key:{pk:E(o),sk:b(d)}}));if(w.Item){let f=await C(o);return{success:!0,unlockedAt:w.Item.unlockedAt||l,costCoins:Number(w.Item.costCoins??0),episode:s,remainingCoins:f.coins}}let A;if(r>0){let f=await p.send(new i.UpdateCommand({TableName:a,Key:{pk:E(o),sk:D},UpdateExpression:"SET coins = if_not_exists(coins, :z) - :c, lastEventAt = :now",ConditionExpression:"if_not_exists(coins, :z) >= :c",ExpressionAttributeValues:{":z":0,":c":r,":now":l},ReturnValues:"ALL_NEW"})).catch(g=>{throw String(g).includes("ConditionalCheckFailed")?new Error("Not enough coins to unlock this episode."):g});A=Number(f.Attributes?.coins??0)}else A=(await C(o)).coins;return await p.send(new i.PutCommand({TableName:a,Item:{pk:E(o),sk:b(d),type:"EPISODE_UNLOCK",episodeId:d,costCoins:r,unlockedAt:l,source:"COIN_UNLOCK"},ConditionExpression:"attribute_not_exists(pk)"})),{success:!0,unlockedAt:l,costCoins:r,episode:s,remainingCoins:A}}if(n==="myUnlockedEpisodes"){if(!t?.sub)throw new Error("Unauthorized");let o=t.sub,d=(await p.send(new i.QueryCommand({TableName:a,KeyConditionExpression:"pk = :p AND begins_with(sk, :pref)",ExpressionAttributeValues:{":p":E(o),":pref":"EP_UNLOCK#"}}))).Items||[];if(!d.length)return[];let m=new Map;return await Promise.all(d.map(async s=>{let r=String(s.episodeId||String(s.sk).replace("EP_UNLOCK#",""));if(!m.has(r))try{let l=await p.send(new i.GetCommand({TableName:a,Key:{pk:N(r),sk:h}}));l.Item&&m.set(r,k(l.Item))}catch{}})),d.map(s=>{let r=String(s.episodeId||String(s.sk).replace("EP_UNLOCK#",""));return{episodeId:r,unlockedAt:s.unlockedAt||new Date().toISOString(),costCoins:Number(s.costCoins??0),source:s.source||null,episode:m.get(r)||null}})}throw new Error(`Unknown field ${n}`)};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
