schema {
  query: Query
  mutation: Mutation
}

# ─────────────────────────────────────────
# Root query type
# ─────────────────────────────────────────
type Query {
  # Simple healthcheck
  hello: String

  # Current user basic info
  me: Me!

  # Closet queries (fan / bestie)
  myCloset(limit: Int, nextToken: String): ClosetConnection!
  myWishlist(limit: Int, nextToken: String): ClosetConnection!
  bestieClosetItems(limit: Int, nextToken: String): ClosetConnection!

  # Comments & likes
  closetItemComments(
    itemId: ID!
    limit: Int
    nextToken: String
  ): CommentConnection!

  adminClosetItemLikes(
    itemId: ID!
    limit: Int
    nextToken: String
  ): LikeConnection!

  adminClosetItemComments(
    itemId: ID!
    limit: Int
    nextToken: String
  ): CommentConnection!

  # Admin / feed views
  adminListPending(limit: Int, nextToken: String): ClosetConnection!
  adminListClosetItems(
    status: ClosetStatus
    limit: Int
    nextToken: String
  ): ClosetConnection!
  closetFeed(
    sort: ClosetFeedSort
    limit: Int
    nextToken: String
  ): ClosetConnection!
    @aws_cognito_user_pools

  # Episodes / early access
  isEpisodeEarlyAccess(episodeId: ID!): EpisodeAccess!

  # Fan episode unlocks
  myUnlockedEpisodes: [EpisodeUnlock!]!

  # Game / leaderboard
  topXP(limit: Int = 50, season: String): [LeaderboardEntry!]!
  topCoins(limit: Int = 50, season: String): [LeaderboardEntry!]!

  # Polls
  getPoll(pollId: ID!): Poll

  # Game profile
  getMyProfile: GameProfile!

  # Bestie status
  meBestieStatus: BestieStatus!

  # Creator / livestream & monetisation
  getCreatorLivestreamInfo: CreatorLivestreamInfo!
  creatorRevenueSummary: CreatorRevenueSummary!
  creatorAiSuggest(
    text: String!
    kind: CreatorAiKind!
  ): CreatorAiSuggestionResult!

  # Game economy config / rules (admin)
  getGameEconomyConfig: GameEconomyConfig!

  # Episodes admin (admin-only)
  adminListEpisodes(
    status: EpisodeStatus
    showId: String
    season: Int
    limit: Int = 20
    nextToken: String
  ): EpisodeAdminConnection!

  # Admin Settings
  getAdminSettings: AdminSettings!
}

# ─────────────────────────────────────────
# Root mutation type
# ─────────────────────────────────────────
type Mutation {
  # Roles
  setUserRole(userId: ID!, role: String!): RoleResult!

  # Closet (fan/bestie core)
  createClosetItem(input: CreateClosetItemInput!): ClosetItem!
  requestClosetApproval(itemId: ID!): ClosetItem!
  updateClosetMediaKey(itemId: ID!, mediaKey: String!): ClosetItem!
  updateClosetItemStory(input: UpdateClosetItemStoryInput!): ClosetItem!

  likeClosetItem(itemId: ID!): ClosetItem!
  commentOnClosetItem(input: CommentOnClosetItemInput!): Comment!
  pinHighlight(itemId: ID!): GameProfile!
  toggleWishlistItem(itemId: ID!): ClosetItem!

  # Bestie closet aliases (used by BestieCloset UI)
  bestieCreateClosetItem(input: BestieCreateClosetItemInput!): ClosetItem!
  bestieUpdateClosetItem(id: ID!, input: BestieUpdateClosetItemInput!): ClosetItem!
  bestieDeleteClosetItem(id: ID!): Boolean!

  # Closet admin – argument names match React GQL
  adminCreateClosetItem(input: AdminCreateClosetItemInput!): ClosetItem!
  adminApproveItem(closetItemId: ID!): ClosetItem!
  adminRejectItem(closetItemId: ID!, reason: String): ClosetItem!
  adminPublishClosetItem(closetItemId: ID!): ClosetItem
    @aws_cognito_user_pools
    @aws_auth(cognito_groups: ["Admin"])
  adminSetClosetAudience(
    closetItemId: ID!
    audience: ClosetAudience!
  ): ClosetItem!
    @aws_cognito_user_pools
    @aws_auth(cognito_groups: ["Admin"])
  adminUpdateClosetItem(
    input: AdminUpdateClosetItemInput!
  ): ClosetItem!

  # Bestie membership / billing
  startBestieCheckout: BestieCheckoutSession!
  claimBestieTrial: BestieStatus!
  adminSetBestie(userId: ID!): BestieStatus!
  adminRevokeBestie(userId: ID!): BestieStatus!
  adminSetBestieByEmail(email: String!): BestieStatus!
  adminRevokeBestieByEmail(email: String!): BestieStatus!

  # Game engine
  logGameEvent(input: LogGameEventInput!): GameEventResult!

  # Spend coins to unlock an episode early
  unlockEpisode(episodeId: ID!): UnlockEpisodeResult!

  # NOTE: aligned with lambda/game/gameplay.ts (expects input: { userId, coins, xp? })
  awardCoins(input: AwardCoinsInput!): GameProfile!

  # Polls (aligned with lambda/game/polls.ts)
  createPoll(input: CreatePollInput!): Poll!
  votePoll(pollId: ID!, optionIndex: Int!): Poll!

  # Game profile updates
  grantBadge(userId: ID!, badge: String!): GameProfile!

  # NOTE: aligned with lambda/game/profile.ts (event.arguments.displayName)
  setDisplayName(displayName: String!): GameProfile!

  updateProfile(input: UpdateProfileInput!): GameProfile!

  # Bestie workflow: background changes / stories / feed
  requestClosetBackgroundChange(input: BgChangeRequestInput!): BgChangeRequestResult!
  createStory(input: CreateStoryInput!): Story!
  publishStory(storyId: ID!): Story!
  addClosetItemToCommunityFeed(itemId: ID!): ClosetItem!
  removeClosetItemFromCommunityFeed(itemId: ID!): ClosetItem!
  shareClosetItemToPinterest(itemId: ID!): ShareResult!

  # Creator livestream + commerce
  pinLivestreamHighlight(highlightId: ID, title: String): PinResult!
  recordAffiliateClick(itemId: ID!, source: String): AffiliateClickResult!

  # Game economy config / rules (admin)
  updateGameEconomyConfig(input: UpdateGameEconomyConfigInput!): GameEconomyConfig!

  # Episodes admin (admin-only)
  adminCreateEpisode(input: AdminCreateEpisodeInput!): Episode!
  adminUpdateEpisode(episodeId: ID!, input: AdminUpdateEpisodeInput!): Episode!

  # Admin Settings
  updateAdminSettings(input: AdminSettingsInput!): AdminSettings!
}

# ─────────────────────────────────────────
# Admin Settings Types
# ─────────────────────────────────────────

type AdminSettings {
  animationsEnabled: Boolean!
  soundsEnabled: Boolean!
  autoBadgeGrant: Boolean!
  badgeRules: [BadgeRule!]!
}

type BadgeRule {
  id: ID!
  label: String!
  trigger: String! # stored as string; client evals it
}

input AdminSettingsInput {
  animationsEnabled: Boolean
  soundsEnabled: Boolean
  autoBadgeGrant: Boolean
  badgeRules: [BadgeRuleInput!]
}

input BadgeRuleInput {
  id: ID!
  label: String!
  trigger: String!
}

# ─────────────────────────────────────────
# Game economy configuration / rules
# ─────────────────────────────────────────

"""
Single game rule describing how coins are earned or spent,
plus optional JSON metadata to tune behavior.
"""
type GameRule {
  id: ID!
  category: String!       # e.g. WATCH_TIME, CHAT, TRIVIA, STREAK, SOCIAL, EVENT, REDEMPTION
  label: String!          # e.g. "Watch 10 minutes"
  description: String
  coins: Int!             # positive = reward, negative = cost
  per: String             # e.g. PER_10_MIN, PER_DAY, PER_EVENT
  maxPerDay: Int
  meta: AWSJSON
}

"""
Top-level economy config used by admin + fan-facing rules + overview.
"""
type GameEconomyConfig {
  id: ID!
  version: Int!
  updatedAt: AWSDateTime
  updatedBy: String

  # Global economy knobs
  coinToUsdRatio: Float
  dailyCoinCap: Int
  weeklyCoinCap: Int
  monthlyBonusEventsLimit: Int

  # Rule list
  rules: [GameRule!]!

  # Optional freeform notes for admins
  notes: String
}

input GameRuleInput {
  id: ID
  category: String!
  label: String!
  description: String
  coins: Int!
  per: String
  maxPerDay: Int
  meta: AWSJSON
}

input UpdateGameEconomyConfigInput {
  coinToUsdRatio: Float
  dailyCoinCap: Int
  weeklyCoinCap: Int
  monthlyBonusEventsLimit: Int
  rules: [GameRuleInput!]!
  notes: String
}

# ─────────────────────────────────────────
# Core / Auth
# ─────────────────────────────────────────

type Me {
  id: ID!
  email: String!
  role: String!
  tier: String!
}

type RoleResult {
  userId: ID!
  role: String!
}

# ─────────────────────────────────────────
# Closet enums
# ─────────────────────────────────────────

# Which fans are allowed to see the look (admin-facing)
enum ClosetAudience {
  PUBLIC
  BESTIES
  EXCLUSIVE
}

# Overall visibility flags used across the app (legacy / fan-facing)
enum ClosetVisibility {
  PRIVATE
  BESTIE
  PUBLIC
}

# Moderation / lifecycle status for a closet item
enum ClosetStatus {
  PENDING
  APPROVED
  PUBLISHED
  REJECTED
}

# Sorting for the fan Closet feed
enum ClosetFeedSort {
  NEWEST
  MOST_LOVED
  LALAS_PICK
  MY_FAVES
}

# ─────────────────────────────────────────
# Closet core types
# ─────────────────────────────────────────

type ClosetItem {
  id: ID!
  ownerId: ID
  # admin-set owner (creator / lala / bestie)
  ownerSub: ID
  # legacy ID used in some queries
  title: String
  mediaKey: String
  rawMediaKey: String
  category: String
  subcategory: String
  colorTags: [String!]
  season: String
  # short vibe / mood label from admin (e.g. "Date night", "Cozy Sunday")
  vibes: String
  notes: String
  visibility: ClosetVisibility!
  affiliateUrl: String
  # Link this closet item to one or more episodes
  # (episodes where the outfit appears / is featured)
  episodeIds: [ID!]
  # Game / moderation metadata
  status: ClosetStatus!
  # now required in practice
  audience: ClosetAudience
  pinned: Boolean
  # Lala's pick
  favoriteCount: Int
  # how many coins the item is worth
  coinValue: Int
  backgroundStatus: String
  # when this item is scheduled to go live (if applicable)
  scheduledAt: AWSDateTime
  createdAt: AWSDateTime
  updatedAt: AWSDateTime
}

type ClosetConnection {
  items: [ClosetItem!]!
  nextToken: String
}

# ─────────────────────────────────────────
# Closet inputs – fan / bestie
# ─────────────────────────────────────────

input CreateClosetItemInput {
  title: String
  mediaKey: String
  rawMediaKey: String
  category: String
  subcategory: String
  colorTags: [String!]
  season: String
  vibes: String
  notes: String
  visibility: ClosetVisibility
  affiliateUrl: String
  episodeIds: [ID!]
}

input UpdateClosetItemStoryInput {
  itemId: ID!
  storyId: ID
  storyPosition: Int
}

input CommentOnClosetItemInput {
  itemId: ID!
  text: String!
}

input BestieCreateClosetItemInput {
  title: String
  mediaKey: String
  rawMediaKey: String
  category: String
  subcategory: String
  colorTags: [String!]
  season: String
  vibes: String
  notes: String
  visibility: ClosetVisibility
  affiliateUrl: String
  episodeIds: [ID!]
}

input BestieUpdateClosetItemInput {
  title: String
  mediaKey: String
  rawMediaKey: String
  category: String
  subcategory: String
  colorTags: [String!]
  season: String
  vibes: String
  notes: String
  visibility: ClosetVisibility
  affiliateUrl: String
  episodeIds: [ID!]
}

# ─────────────────────────────────────────
# Closet inputs – admin
# ─────────────────────────────────────────

input AdminCreateClosetItemInput {
  ownerId: ID
  title: String
  mediaKey: String
  rawMediaKey: String
  category: String
  subcategory: String
  colorTags: [String!]
  season: String
  # new: matches "Vibes" field in admin upload form
  vibes: String
  notes: String
  visibility: ClosetVisibility
  affiliateUrl: String
  # Link to episodes this look appears in
  episodeIds: [ID!]
  # admin metadata
  status: ClosetStatus
  audience: ClosetAudience
  pinned: Boolean
  coinValue: Int
  backgroundStatus: String
}

input AdminUpdateClosetItemInput {
  id: ID!
  ownerId: ID
  title: String
  mediaKey: String
  rawMediaKey: String
  category: String
  subcategory: String
  colorTags: [String!]
  season: String
  vibes: String
  notes: String
  visibility: ClosetVisibility
  affiliateUrl: String
  # Link to episodes this look appears in
  episodeIds: [ID!]
  # admin metadata
  status: ClosetStatus
  audience: ClosetAudience
  pinned: Boolean
  coinValue: Int
  backgroundStatus: String
  scheduledAt: AWSDateTime
}

type Comment {
  id: ID!
  itemId: ID!
  userId: ID!
  text: String!
  createdAt: AWSDateTime!
}

type CommentConnection {
  items: [Comment!]!
  nextToken: String
}

type Like {
  itemId: ID!
  userId: ID!
  createdAt: AWSDateTime!
}

type LikeConnection {
  items: [Like!]!
  nextToken: String
}

# ─────────────────────────────────────────
# Episodes / Bestie access
# ─────────────────────────────────────────

enum EpisodeStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
}

type ThumbnailImage {
  key: String!
  primary: Boolean!
}

type Episode {
  id: ID!
  title: String!
  season: Int
  episodeNumber: Int
  showId: String
  shortDescription: String
  fullDescription: String
  status: EpisodeStatus!
  publicAt: String!
  durationSeconds: Int
  unlockCoinCost: Int
  chatEnabled: Boolean!
  thumbnails: [ThumbnailImage!]!
  outfitsLinkedCount: Int
}

type EpisodeAdminConnection {
  items: [Episode!]!
  nextToken: String
}

type EpisodeAccess {
  episodeId: ID!
  isEarly: Boolean!
  reason: String
}

type EpisodeUnlock {
  episodeId: ID!
  unlockedAt: String!
  costCoins: Int!
  source: String
  episode: Episode
}

type UnlockEpisodeResult {
  success: Boolean!
  unlockedAt: String!
  costCoins: Int!
  episode: Episode!
  remainingCoins: Int!
}

type BestieStatus {
  userId: ID!
  isBestie: Boolean!
  tier: String
  renewsAt: AWSDateTime
  trialActive: Boolean
  trialEndsAt: AWSDateTime
}

type BestieCheckoutSession {
  checkoutUrl: String!
}

input AdminCreateEpisodeInput {
  id: ID
  title: String!
  season: Int
  episodeNumber: Int
  showId: String
  shortDescription: String
  fullDescription: String
  status: EpisodeStatus!          # DRAFT | SCHEDULED | PUBLISHED
  publicAt: String!               # ISO string
  durationSeconds: Int
  unlockCoinCost: Int
  chatEnabled: Boolean = true
  thumbnails: [ThumbnailImageInput!]
}

input AdminUpdateEpisodeInput {
  title: String
  season: Int
  episodeNumber: Int
  showId: String
  shortDescription: String
  fullDescription: String
  status: EpisodeStatus
  publicAt: String
  durationSeconds: Int
  unlockCoinCost: Int
  chatEnabled: Boolean
  thumbnails: [ThumbnailImageInput!]
}

input ThumbnailImageInput {
  key: String!
  primary: Boolean!
}

# Background change requests
input BgChangeRequestInput {
  itemId: ID!
  newBackgroundKey: String!
  notes: String
}

type BgChangeRequestResult {
  ok: Boolean!
  requestId: ID
}

# Stories
type Story {
  id: ID!
  ownerId: ID!
  title: String
  status: String
  createdAt: AWSDateTime
  publishedAt: AWSDateTime
}

input CreateStoryInput {
  title: String!
  closetItemIds: [ID!]
}

type ShareResult {
  ok: Boolean!
  url: String
}

# ─────────────────────────────────────────
# Fans / Game types
# ─────────────────────────────────────────

"""Per-fan game profile / XP / coins."""
type GameProfile {
  userId: ID!
  displayName: String
  level: Int!
  xp: Int!
  coins: Int!
  badges: [String!]!
  avatarUrl: String
  bio: String

  # Timestamp of last gameplay-related event
  lastEventAt: AWSDateTime

  # Daily login streak
  streakCount: Int
  lastLoginAt: AWSDateTime

  # Fan’s pinned closet items
  pinnedClosetItems: [ClosetItem!]!
}

"""Result of logging a game event."""
type GameEventResult {
  success: Boolean!

  # current XP / coins after the event
  xp: Int
  coins: Int

  # delta from this event
  newXP: Int
  newCoins: Int

  lastEventAt: AWSDateTime
}

"""Leaderboard entry for topXP / topCoins."""
type LeaderboardEntry {
  userId: ID!
  displayName: String
  xp: Int
  coins: Int
  rank: Int!
}

input LogGameEventInput {
  type: String!
  metadata: AWSJSON
}

input AwardCoinsInput {
  userId: ID!
  coins: Int!
  xp: Int
}

input UpdateProfileInput {
  displayName: String
  avatarUrl: String
  bio: String
}

# ─────────────────────────────────────────
# Polls
# ─────────────────────────────────────────

type Poll {
  pollId: ID!
  question: String!
  options: [String!]!
  totals: [Int!]!
  createdBy: String
  createdAt: AWSDateTime
}

input CreatePollInput {
  question: String!
  options: [String!]!
}

# ─────────────────────────────────────────
# Creator / Livestream / Commerce / AI
# ─────────────────────────────────────────

type CreatorLivestreamInfo {
  channelArn: String
  playbackUrl: String
  isLive: Boolean!
}

type CreatorRevenueSummary {
  periodStart: AWSDateTime
  periodEnd: AWSDateTime
  currency: String!
  totalRevenue: Float!
  totalOrders: Int!
}

enum CreatorAiKind {
  STYLE_POST
  EPISODE_CAPTION
  EMAIL_SUBJECT
  GENERIC
}

type CreatorAiSuggestionResult {
  text: String!
}

type PinResult {
  ok: Boolean!
}

type AffiliateClickResult {
  ok: Boolean!
}
