<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Signing you in…</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="sa-body" style="padding:24px">
  <h1 class="sa-h1">Signing you in…</h1>
  <p class="sa-muted" id="msg">Exchanging code…</p>
  <p style="margin-top:12px"><a class="sa-link" href="/fan/">← Back to Fan Dashboard</a></p>

  <script>
    (async function(){
      function b64url(buf){
        return btoa(String.fromCharCode.apply(null, new Uint8Array(buf)))
          .replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
      }
      function qs(){ return new URLSearchParams(location.search); }
      function getCfg(){ return fetch("/config.v2.json?ts="+Date.now(), { method:"GET" }).then(r=>r.json()); }

      try{
        const cfg = await getCfg();
        const hosted = cfg.domain || cfg.hostedUiDomain;
        const domain = `https://${hosted}.auth.${cfg.region}.amazoncognito.com`;

        const code = qs().get("code");
        const state = qs().get("state") || "";
        const m = state.match(/^rt:([^|]+)\|/);
        const dest = (m && m[1]) || "/fan/";

        if (!code) {
          document.getElementById("msg").textContent = "No code found. Redirecting…";
          setTimeout(()=>location.replace(dest), 300);
          return;
        }

        const verifier = sessionStorage.getItem("pkce_verifier") || "";

        const body = new URLSearchParams();
        body.set("grant_type", "authorization_code");
        body.set("client_id",  cfg.clientId);
        body.set("redirect_uri", String(cfg.redirectUri||"").trim());
        body.set("code_verifier", verifier);
        body.set("code", code);

        const res = await fetch(`${domain}/oauth2/token`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: body.toString()
        });

        const tok = await res.json();
        if (!res.ok) {
          console.error("Token exchange failed", tok);
          document.getElementById("msg").textContent = "Sign-in failed. Please try again.";
          return;
        }

        if (tok.id_token)      sessionStorage.setItem("id_token", tok.id_token);
        if (tok.access_token)  sessionStorage.setItem("access_token", tok.access_token);
        if (tok.refresh_token) sessionStorage.setItem("refresh_token", tok.refresh_token);

        // clean PKCE scratch
        sessionStorage.removeItem("pkce_verifier");
        sessionStorage.setItem("tokens", JSON.stringify({
          id_token: tok.id_token, access_token: tok.access_token,
          refresh_token: tok.refresh_token, expires_in: tok.expires_in
        }));

        // Go where we intended (usually /fan/)
        location.replace(dest);
      }catch(e){
        console.error(e);
        document.getElementById("msg").textContent = "Problem completing sign-in. See console.";
      }
    })();
  </script>
</body>
</html>
