<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Signing you in… | Styling Adventures</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        background: #f9fafb;
        color: #111827;
      }
      .box {
        padding: 24px 28px;
        border-radius: 16px;
        background: #ffffff;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.13);
        max-width: 420px;
        text-align: center;
      }
      .subtitle {
        margin-top: 8px;
        font-size: 14px;
        color: #6b7280;
      }
      .error {
        margin-top: 10px;
        font-size: 13px;
        color: #b91c1c;
        word-break: break-word;
      }
    </style>
  </head>
  <body>
    <div class="box">
      <div style="font-weight: 600; font-size: 18px">Signing you in…</div>
      <div class="subtitle">
        Just a moment while we finish connecting your account.
      </div>
      <div id="error" class="error" style="display: none"></div>
    </div>

    <script>
      (function () {
        function parseFragment() {
          const raw = window.location.hash || "";
          const qs = raw.startsWith("#") ? raw.slice(1) : raw;
          const p = new URLSearchParams(qs);
          return {
            idToken: p.get("id_token") || "",
            accessToken: p.get("access_token") || "",
            error:
              p.get("error_description") ||
              p.get("error") ||
              "",
          };
        }

        function parseJwt(t) {
          try {
            return JSON.parse(
              atob(String(t).split(".")[1].replace(/-/g, "+").replace(/_/g, "/"))
            );
          } catch (e) {
            return {};
          }
        }

        function storeTokens(idToken, accessToken) {
          if (idToken) {
            sessionStorage.setItem("id_token", idToken);
            localStorage.setItem("sa_id_token", idToken);
            localStorage.setItem("sa:idToken", idToken);
          }
          if (accessToken) {
            sessionStorage.setItem("access_token", accessToken);
            localStorage.setItem("sa:accessToken", accessToken);
          }

          // Optional: store expiry (used by some versions of the app)
          try {
            const exp = (parseJwt(idToken).exp | 0) * 1000;
            if (exp) {
              localStorage.setItem("sa:expiresAt", String(exp));
            }
          } catch (e) {
            console.warn("could not parse exp from id token", e);
          }
        }

        function showError(msg) {
          const el = document.getElementById("error");
          el.textContent = msg;
          el.style.display = "block";
        }

        (async function main() {
          const { idToken, accessToken, error } = parseFragment();

          if (error) {
            showError(error);
            return;
          }

          if (!idToken) {
            showError("No id_token found in callback URL.");
            return;
          }

          try {
            storeTokens(idToken, accessToken);
          } catch (e) {
            console.error(e);
            showError(e.message || String(e));
            return;
          }

          let dest = "/";
          try {
            dest =
              sessionStorage.getItem("sa:returnTo") ||
              window.location.origin + "/";
            sessionStorage.removeItem("sa:returnTo");
          } catch (e) {
            console.warn("could not read sa:returnTo", e);
          }

          // Replace so back button doesn’t revisit the fragment URL
          window.location.replace(dest);
        })();
      })();
    </script>
  </body>
</html>
